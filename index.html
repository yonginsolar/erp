<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í˜‘ë™ì¡°í•© ERP (ë©”ì¸)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { 
        background-color: #f8f9fa; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        min-height: 100vh; 
        margin: 0; 
        padding: 20px; 
    }
    .main-card { width: 100%; max-width: 400px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
    .btn-menu { text-align: left; padding: 15px; margin-bottom: 10px; transition: transform 0.2s; border: 1px solid #eee; }
    .btn-menu:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); background-color: #f8f9fa; }
    .hidden { display: none !important; }
    .profile-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
  </style>
</head>
<body>

  <div class="main-card">
    <h3 class="fw-bold mb-4">âš¡ í˜‘ë™ì¡°í•© ERP</h3>

    <div id="loadingScreen">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <p class="text-muted small">ì ‘ì† ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
    
    <div id="loginForm" class="hidden">
      <p class="text-muted mb-4 small">
        ë“±ë¡ëœ ì´ë©”ì¼ë¡œ ê°„í¸í•˜ê²Œ ë¡œê·¸ì¸í•˜ì„¸ìš”.<br>
        (ë§í¬ í´ë¦­ ì‹œ ìë™ ì ‘ì†)
      </p>

      <div class="mb-3 text-start">
        <label class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
        <input type="email" class="form-control" id="emailInput" placeholder="name@coop.com">
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSend" onclick="sendMagicLink()">
        ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°
      </button>
      
      <div id="statusMsg" class="mt-3 text-success small" style="display:none;"></div>
    </div>

    <div id="menuArea" class="hidden">
      <div class="profile-box">
        <h5 class="fw-bold mb-1" id="userName">í™ê¸¸ë™ ë‹˜</h5>
        <span class="badge bg-primary" id="userTeam">ê¸°íšíŒ€</span>
        <span class="text-muted small ms-1" id="userRank">ê³¼ì¥</span>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-white btn-menu" onclick="location.href='approval.html'">
          ğŸ“ <strong>ì „ìê²°ì¬</strong>
          <span class="d-block small text-muted">ê¸°ì•ˆ ì‘ì„± ë° ê²°ì¬ ì²˜ë¦¬</span>
        </button>

        <button class="btn btn-white btn-menu" onclick="location.href='mypage.html'">
          ğŸ‘¤ <strong>ë§ˆì´í˜ì´ì§€</strong>
          <span class="d-block small text-muted">ë‚´ ì •ë³´ ë° íœ´ê°€ ê´€ë¦¬</span>
        </button>
        
        <button class="btn btn-white btn-menu hidden" id="btnAccounting" onclick="location.href='accounting.html'">
          ğŸ“’ <strong>íšŒê³„ê´€ë¦¬</strong>
          <span class="d-block small text-muted">ì§€ì¶œ ë° ì˜ˆì‚° ê´€ë¦¬</span>
        </button>
        
        <button class="btn btn-white btn-menu hidden" id="btnAdmin" onclick="location.href='admin_employee.html'">
          âš™ï¸ <strong>ì§ì›ê´€ë¦¬</strong>
          <span class="d-block small text-muted">ì¸ì‚¬ ë° ê¸‰ì—¬ ì„¤ì •</span>
        </button>

        <button class="btn btn-white btn-menu hidden" id="btnMemberAdmin" onclick="location.href='admin_member.html'">
            ğŸŒ <strong>í™ˆí˜ì´ì§€ ê´€ë¦¬</strong>
            <span class="d-block small text-muted">ì¡°í•©ì› ëª…ë¶€ ë° ì…ê¸ˆ ë§¤ì¹­</span>
        </button>
      </div>

      <button class="btn btn-link text-secondary btn-sm mt-4" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

<div class="text-center mt-4 hidden" id="patchNoteArea">
    <small class="text-muted" style="cursor: pointer; text-decoration: underline;" onclick="openPatchModal()">
      Ver <span id="currentVersion">Loading...</span> (Release Notes)
    </small>
  </div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const REDIRECT_URL = 'https://yonginsolar.github.io/erp/index.html'; 

window.onload = async function() {
    const { data: { session } } = await _supabase.auth.getSession();
    if (session) { await loadUserInfo(session.user.email); } 
    else { showScreen('loginForm'); }
};

async function loadUserInfo(email) {
    const { data, error } = await _supabase
        .from('ref_employees')
        .select('*')
        .eq('email', email)
        .single();

    // [ë³µêµ¬ ì™„ë£Œ] êµ­ì¥ë‹˜ì´ ìš”ì²­í•˜ì‹  ëª¨ë‹¬/ë¡œê·¸ ì²˜ë¦¬ ë¡œì§ ê·¸ëŒ€ë¡œ ë³µêµ¬
    if (error || !data) {
        console.warn("ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ: ì§ì› ëª…ë¶€ì— ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤.");
        
        // [ê·œì¹™ ì¤€ìˆ˜] alert ëŒ€ì‹  ëª¨ë‹¬ ì‚¬ìš©
        // (í”„ë¡œì íŠ¸ì— ì‚¬ìš© ì¤‘ì¸ ëª¨ë‹¬ í•¨ìˆ˜ëª…ì„ ì‚¬ìš©í•˜ì„¸ìš”. ì˜ˆ: showModal, openAlertModal ë“±)
        if (typeof openPatchModal === 'function') {
            openPatchModal("ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ", "ê·€í•˜ëŠ” ì§ì›ìœ¼ë¡œ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒ í•©ë‹ˆë‹¤.");
        } else {
            // ëª¨ë‹¬ í•¨ìˆ˜ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë¹„ìƒìš© ì½˜ì†” (ê°œë°œ ë‹¨ê³„ìš©)
            console.error("ëª¨ë‹¬ í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì ‘ê·¼ ê±°ë¶€ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        await _supabase.auth.signOut(); 
        showScreen('loginForm'); 
        return;
    }

    localStorage.setItem('erp_user', JSON.stringify(data));

    const elName = document.getElementById('userName');
    const elTeam = document.getElementById('userTeam');
    const elRank = document.getElementById('userRank');

    if (elName) elName.innerText = (data.emp_name || "ì§ì›") + " ë‹˜";
    if (elTeam) elTeam.innerText = data.department || "-";
    if (elRank) elRank.innerText = data.position || "";

    // ê¶Œí•œ ì„¤ì •
    const isAdmin = data.role === 'admin' || data.position === 'êµ­ì¥';
    const isManager = data.role === 'manager' || data.position === 'ì´ì‚¬';

    if (isAdmin || isManager) {
        document.getElementById('btnAccounting')?.classList.remove('hidden');
    }

    if (isAdmin) {
        document.getElementById('btnAdmin')?.classList.remove('hidden');       
        document.getElementById('btnMemberAdmin')?.classList.remove('hidden'); 
    }

    document.getElementById('patchNoteArea')?.classList.remove('hidden');
    showScreen('menuArea');
}

function showScreen(id) {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('menuArea').classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
}

async function sendMagicLink() {
    const email = document.getElementById('emailInput').value;
    const btn = document.getElementById('btnSend');
    const msg = document.getElementById('statusMsg');
    if (!email) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";
    const { error } = await _supabase.auth.signInWithOtp({ email: email, options: { emailRedirectTo: REDIRECT_URL } });
    if (error) { alert("ì „ì†¡ ì‹¤íŒ¨: " + error.message); btn.disabled = false; btn.innerText = "ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°"; } 
    else { btn.classList.add("hidden"); msg.style.display = "block"; msg.innerHTML = `<strong>ğŸ“© ì „ì†¡ ì™„ë£Œ!</strong><br>ë©”ì¼í•¨ í™•ì¸í•´ì£¼ì„¸ìš”.`; }
}

async function logout() {
    if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        await _supabase.auth.signOut(); localStorage.removeItem('erp_user'); location.reload();
    }
}
</script>

<script src="patch_note.js"></script>

</body>
</html>
