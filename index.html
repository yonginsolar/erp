<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í˜‘ë™ì¡°í•© ERP (ë©”ì¸)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { 
        background-color: #f8f9fa; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        min-height: 100vh; 
        margin: 0; 
        padding: 20px; 
    }
    .main-card { width: 100%; max-width: 400px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
    .btn-menu { text-align: left; padding: 15px; margin-bottom: 10px; transition: transform 0.2s; border: 1px solid #eee; }
    .btn-menu:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); background-color: #f8f9fa; }
    .hidden { display: none !important; }
    .profile-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
  </style>
</head>
<body>

  <div class="main-card">
    <h3 class="fw-bold mb-4">âš¡ í˜‘ë™ì¡°í•© ERP</h3>

    <div id="loadingScreen">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <p class="text-muted small">ì ‘ì† ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
    
    <div id="loginForm" class="hidden">
      <p class="text-muted mb-4 small">
        ë“±ë¡ëœ ì´ë©”ì¼ë¡œ ê°„í¸í•˜ê²Œ ë¡œê·¸ì¸í•˜ì„¸ìš”.<br>
        (ë§í¬ í´ë¦­ ì‹œ ìë™ ì ‘ì†)
      </p>

      <div class="mb-3 text-start">
        <label class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
        <input type="email" class="form-control" id="emailInput" placeholder="name@coop.com">
      </div>

      <button class="btn btn-primary w-100 py-2" id="btnSend" onclick="sendMagicLink()">
        ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°
      </button>
      
      <div id="statusMsg" class="mt-3 text-success small" style="display:none;"></div>
    </div>

    <div id="menuArea" class="hidden">
      <div class="profile-box">
        <h5 class="fw-bold mb-1" id="userName">í™ê¸¸ë™ ë‹˜</h5>
        <span class="badge bg-primary" id="userTeam">ê¸°íšíŒ€</span>
        <span class="text-muted small ms-1" id="userRank">ê³¼ì¥</span>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-white btn-menu" onclick="location.href='approval.html'">
          ğŸ“ <strong>ì „ìê²°ì¬</strong>
          <span class="d-block small text-muted">ê¸°ì•ˆ ì‘ì„± ë° ê²°ì¬ ì²˜ë¦¬</span>
        </button>

        <button class="btn btn-white btn-menu" onclick="location.href='mypage.html'">
          ğŸ‘¤ <strong>ë§ˆì´í˜ì´ì§€</strong>
          <span class="d-block small text-muted">ë‚´ ì •ë³´ ë° íœ´ê°€ ê´€ë¦¬</span>
        </button>
        
        <button class="btn btn-white btn-menu hidden" id="btnAccounting" onclick="location.href='accounting.html'">
          ğŸ“’ <strong>íšŒê³„ê´€ë¦¬</strong>
          <span class="d-block small text-muted">ì§€ì¶œ ë° ì˜ˆì‚° ê´€ë¦¬</span>
        </button>
        
        <button class="btn btn-white btn-menu hidden" id="btnAdmin" onclick="location.href='admin_employee.html'">
          âš™ï¸ <strong>ì§ì›ê´€ë¦¬</strong>
          <span class="d-block small text-muted">ì¸ì‚¬ ë° ê¸‰ì—¬ ì„¤ì •</span>
        </button>
      </div>

      <button class="btn btn-link text-secondary btn-sm mt-4" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <div class="text-center mt-4">
    <small class="text-muted" style="cursor: pointer; text-decoration: underline;" onclick="openPatchModal()">
      Ver <span id="currentVersion">Loading...</span> (Release Notes)
    </small>
  </div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const REDIRECT_URL = 'https://minho-kim.github.io/yonginsolar_erp/index.html'; 

// ë¡œê·¸ì¸ ê´€ë ¨ ë¡œì§ (íŒ¨ì¹˜ë…¸íŠ¸ ì œì™¸í•œ ë‚˜ë¨¸ì§€)
window.onload = async function() {
    const { data: { session } } = await _supabase.auth.getSession();
    if (session) { await loadUserInfo(session.user.email); } 
    else { showScreen('loginForm'); }
    
    // [ì¤‘ìš”] patch_note.jsê°€ ë¡œë“œëœ í›„ ì‹¤í–‰ë˜ë„ë¡ ë‘  (patch_note.js ë‚´ë¶€ì˜ DOMContentLoadedê°€ ì²˜ë¦¬í•¨)
};

async function loadUserInfo(email) {
    const { data, error } = await _supabase.from('ref_employees').select('*').eq('email', email).single();
    if (error || !data) {
        alert("ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); _supabase.auth.signOut(); showScreen('loginForm'); return;
    }
    localStorage.setItem('erp_user', JSON.stringify(data));
    document.getElementById('userName').innerText = data.emp_name + " ë‹˜";
    document.getElementById('userTeam').innerText = data.department || "-";
    document.getElementById('userRank').innerText = data.position || "";

    if (data.role === 'admin' || data.role === 'manager' || data.position === 'êµ­ì¥' || data.position === 'ì´ì‚¬') {
        document.getElementById('btnAccounting').classList.remove('hidden');
    }
    if (data.role === 'admin' || data.position === 'êµ­ì¥') {
        document.getElementById('btnAdmin').classList.remove('hidden');
    }
    showScreen('menuArea');
}

function showScreen(id) {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('menuArea').classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
}

async function sendMagicLink() {
    const email = document.getElementById('emailInput').value;
    const btn = document.getElementById('btnSend');
    const msg = document.getElementById('statusMsg');
    if (!email) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";
    const { error } = await _supabase.auth.signInWithOtp({ email: email, options: { emailRedirectTo: REDIRECT_URL } });
    if (error) { alert("ì „ì†¡ ì‹¤íŒ¨: " + error.message); btn.disabled = false; btn.innerText = "ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°"; } 
    else { btn.classList.add("hidden"); msg.style.display = "block"; msg.innerHTML = `<strong>ğŸ“© ì „ì†¡ ì™„ë£Œ!</strong><br>ë©”ì¼í•¨ í™•ì¸í•´ì£¼ì„¸ìš”.`; }
}

async function logout() {
    if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        await _supabase.auth.signOut(); localStorage.removeItem('erp_user'); location.reload();
    }
}
</script>

<script src="patch_note.js"></script>

</body>
</html>
