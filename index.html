<!DOCTYPE html>
<html>
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <title>í˜‘ë™ì¡°í•© ERP (ë©”ì¸)</title>
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â Â 
Â  <style>
Â  Â  body {Â 
Â  Â  Â  Â  background-color: #f8f9fa;Â 
Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  min-height: 100vh;Â 
Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  padding: 20px;Â 
Â  Â  }
Â  Â  .main-card { width: 100%; max-width: 400px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
Â  Â  .btn-menu { text-align: left; padding: 15px; margin-bottom: 10px; transition: transform 0.2s; border: 1px solid #eee; }
Â  Â  .btn-menu:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); background-color: #f8f9fa; }
Â  Â  .hidden { display: none !important; }
Â  Â  .profile-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
Â  </style>
</head>
<body>

Â  <div class="main-card">
Â  Â  <h3 class="fw-bold mb-4">âš¡ í˜‘ë™ì¡°í•© ERP</h3>

Â  Â  <div id="loadingScreen">
Â  Â  Â  <div class="spinner-border text-primary mb-3" role="status"></div>
Â  Â  Â  <p class="text-muted small">ì ‘ì† ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</p>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="loginForm" class="hidden">
Â  Â  Â  <p class="text-muted mb-4 small">
Â  Â  Â  Â  ë“±ë¡ëœ ì´ë©”ì¼ë¡œ ê°„í¸í•˜ê²Œ ë¡œê·¸ì¸í•˜ì„¸ìš”.<br>
Â  Â  Â  Â  (ë§í¬ í´ë¦­ ì‹œ ìë™ ì ‘ì†)
Â  Â  Â  </p>

Â  Â  Â  <div class="mb-3 text-start">
Â  Â  Â  Â  <label class="form-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
Â  Â  Â  Â  <input type="email" class="form-control" id="emailInput" placeholder="name@coop.com">
Â  Â  Â  </div>

Â  Â  Â  <button class="btn btn-primary w-100 py-2" id="btnSend" onclick="sendMagicLink()">
Â  Â  Â  Â  ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°
Â  Â  Â  </button>
Â  Â  Â Â 
Â  Â  Â  <div id="statusMsg" class="mt-3 text-success small" style="display:none;"></div>
Â  Â  </div>

Â  Â  <div id="menuArea" class="hidden">
Â  Â  Â  <div class="profile-box">
Â  Â  Â  Â  <h5 class="fw-bold mb-1" id="userName">í™ê¸¸ë™ ë‹˜</h5>
Â  Â  Â  Â  <span class="badge bg-primary" id="userTeam">ê¸°íšíŒ€</span>
Â  Â  Â  Â  <span class="text-muted small ms-1" id="userRank">ê³¼ì¥</span>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="d-grid gap-2">
Â  Â  Â  Â  <button class="btn btn-white btn-menu" onclick="location.href='approval.html'">
Â  Â  Â  Â  Â  ğŸ“ <strong>ì „ìê²°ì¬</strong>
Â  Â  Â  Â  Â  <span class="d-block small text-muted">ê¸°ì•ˆ ì‘ì„± ë° ê²°ì¬ ì²˜ë¦¬</span>
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button class="btn btn-white btn-menu" onclick="location.href='mypage.html'">
Â  Â  Â  Â  Â  ğŸ‘¤ <strong>ë§ˆì´í˜ì´ì§€</strong>
Â  Â  Â  Â  Â  <span class="d-block small text-muted">ë‚´ ì •ë³´ ë° íœ´ê°€ ê´€ë¦¬</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button class="btn btn-white btn-menu hidden" id="btnAccounting" onclick="location.href='accounting.html'">
Â  Â  Â  Â  Â  ğŸ“’ <strong>íšŒê³„ê´€ë¦¬</strong>
Â  Â  Â  Â  Â  <span class="d-block small text-muted">ì§€ì¶œ ë° ì˜ˆì‚° ê´€ë¦¬</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button class="btn btn-white btn-menu hidden" id="btnAdmin" onclick="location.href='admin_employee.html'">
Â  Â  Â  Â  Â  âš™ï¸ <strong>ì§ì›ê´€ë¦¬</strong>
Â  Â  Â  Â  Â  <span class="d-block small text-muted">ì¸ì‚¬ ë° ê¸‰ì—¬ ì„¤ì •</span>
Â  Â  Â  Â  </button>

        <button class="btn btn-white btn-menu hidden" id="btnMemberAdmin" onclick="location.href='admin_member.html'">
Â  Â  Â  Â  Â  ğŸŒ <strong>í™ˆí˜ì´ì§€ ê´€ë¦¬</strong>
Â  Â  Â  Â  Â  <span class="d-block small text-muted">ì¡°í•©ì› ëª…ë¶€ ë° ì…ê¸ˆ ë§¤ì¹­</span>
Â  Â  Â  Â  </button>

Â  Â  Â  </div>

Â  Â  Â  <button class="btn btn-link text-secondary btn-sm mt-4" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
Â  Â  </div>
Â  </div>

<div class="text-center mt-4 hidden" id="patchNoteArea">
Â  Â  <small class="text-muted" style="cursor: pointer; text-decoration: underline;" onclick="openPatchModal()">
Â  Â  Â  Ver <span id="currentVersion">Loading...</span> (Release Notes)
Â  Â  </small>
Â  </div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';Â 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const REDIRECT_URL = 'https://yonginsolar.github.io/erp/index.html';Â 

// ë¡œê·¸ì¸ ê´€ë ¨ ë¡œì§ (íŒ¨ì¹˜ë…¸íŠ¸ ì œì™¸í•œ ë‚˜ë¨¸ì§€)
window.onload = async function() {
Â  Â  const { data: { session } } = await _supabase.auth.getSession();
Â  Â  if (session) { await loadUserInfo(session.user.email); }Â 
Â  Â  else { showScreen('loginForm'); }
Â  Â Â 
Â  Â  // [ì¤‘ìš”] patch_note.jsê°€ ë¡œë“œëœ í›„ ì‹¤í–‰ë˜ë„ë¡ ë‘  (patch_note.js ë‚´ë¶€ì˜ DOMContentLoadedê°€ ì²˜ë¦¬í•¨)
};

async function loadUserInfo(email) {
Â  Â  // 1. ì§ì› ëª…ë¶€ ì¡°íšŒ (RLSê°€ ê±¸ë ¤ ìˆì–´ì„œ ì§ì›ì´ ì•„ë‹ˆë©´ ë°ì´í„°ê°€ ì•ˆ ë³´ì„)
Â  Â  const { data, error } = await _supabase
Â  Â  Â  Â  .from('ref_employees')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('email', email)
Â  Â  Â  Â  .single();

Â  Â  // 2. [ë³´ì•ˆ ì²´í¬] ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚˜ë©´ ì§ì›ì´ ì•„ë‹˜ -> ì¦‰ì‹œ ì¶”ë°©
Â  Â  if (error || !data) {
Â  Â  Â  Â  console.warn("ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ: ì§ì› ëª…ë¶€ì— ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // [ê·œì¹™ ì¤€ìˆ˜] alert ëŒ€ì‹  ëª¨ë‹¬ ì‚¬ìš©
Â  Â  Â  Â  // (í”„ë¡œì íŠ¸ì— ì‚¬ìš© ì¤‘ì¸ ëª¨ë‹¬ í•¨ìˆ˜ëª…ì„ ì‚¬ìš©í•˜ì„¸ìš”. ì˜ˆ: showModal, openAlertModal ë“±)
Â  Â  Â  Â  if (typeof openPatchModal === 'function') {
Â  Â  Â  Â  Â  Â  openPatchModal("ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ", "ê·€í•˜ëŠ” ì§ì›ìœ¼ë¡œ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒ í•©ë‹ˆë‹¤.");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // ëª¨ë‹¬ í•¨ìˆ˜ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë¹„ìƒìš© ì½˜ì†” (ê°œë°œ ë‹¨ê³„ìš©)
Â  Â  Â  Â  Â  Â  console.error("ëª¨ë‹¬ í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì ‘ê·¼ ê±°ë¶€ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  Â  Â  }

Â  Â  Â  Â  await _supabase.auth.signOut(); // ì„¸ì…˜ ì¢…ë£Œ
Â  Â  Â  Â  showScreen('loginForm'); // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ê°•ì œ ì´ë™
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 3. ì§ì› ì •ë³´ ë¡œì»¬ ì €ì¥ (ì„¸ì…˜ ìœ ì§€ìš©)
Â  Â  localStorage.setItem('erp_user', JSON.stringify(data));

Â  Â  // 4. UI ì—…ë°ì´íŠ¸ (Null ë³‘í•© ì—°ì‚°ì ?? ì‚¬ìš©ìœ¼ë¡œ ì•ˆì „ì„± ê°•í™”)
Â  Â  const elName = document.getElementById('userName');
Â  Â  const elTeam = document.getElementById('userTeam');
Â  Â  const elRank = document.getElementById('userRank');

Â  Â  if (elName) elName.innerText = (data.emp_name || "ì§ì›") + " ë‹˜";
Â  Â  if (elTeam) elTeam.innerText = data.department || "-";
Â  Â  if (elRank) elRank.innerText = data.position || "";

Â  Â  // 5. ê¶Œí•œë³„ ë²„íŠ¼ ë…¸ì¶œ (ì§ê´€ì ìœ¼ë¡œ ì •ë¦¬)
Â  Â  const isAdmin = data.role === 'admin' || data.position === 'êµ­ì¥';
Â  Â  const isManager = data.role === 'manager' || data.position === 'ì´ì‚¬';

Â  Â  // íšŒê³„ ë²„íŠ¼: ê´€ë¦¬ì, ë§¤ë‹ˆì €, êµ­ì¥, ì´ì‚¬
Â  Â  if (isAdmin || isManager) {
Â  Â  Â  Â  document.getElementById('btnAccounting')?.classList.remove('hidden');
Â  Â  }

Â  Â  // ê´€ë¦¬ì ë²„íŠ¼: ì–´ë“œë¯¼, êµ­ì¥
Â  Â  if (isAdmin) {
Â  Â  Â  Â  document.getElementById('btnAdmin')?.classList.remove('hidden');
        document.getElementById('btnMemberAdmin')?.classList.remove('hidden'); // [ì¶”ê°€ë¨] ê´€ë¦¬ìë©´ í™ˆí˜ì´ì§€ ê´€ë¦¬ ë²„íŠ¼ ë…¸ì¶œ
Â  Â  }

Â  Â  // 6. ê³µí†µ UI ë…¸ì¶œ
Â  Â  document.getElementById('patchNoteArea')?.classList.remove('hidden');
Â  Â  showScreen('menuArea');
}

function showScreen(id) {
Â  Â  document.getElementById('loadingScreen').classList.add('hidden');
Â  Â  document.getElementById('loginForm').classList.add('hidden');
Â  Â  document.getElementById('menuArea').classList.add('hidden');
Â  Â  document.getElementById(id).classList.remove('hidden');
}

async function sendMagicLink() {
Â  Â  const email = document.getElementById('emailInput').value;
Â  Â  const btn = document.getElementById('btnSend');
Â  Â  const msg = document.getElementById('statusMsg');
Â  Â  if (!email) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
Â  Â  btn.disabled = true; btn.innerText = "ì „ì†¡ ì¤‘...";
Â  Â  const { error } = await _supabase.auth.signInWithOtp({ email: email, options: { emailRedirectTo: REDIRECT_URL } });
Â  Â  if (error) { alert("ì „ì†¡ ì‹¤íŒ¨: " + error.message); btn.disabled = false; btn.innerText = "ğŸ“§ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°"; }Â 
Â  Â  else { btn.classList.add("hidden"); msg.style.display = "block"; msg.innerHTML = `<strong>ğŸ“© ì „ì†¡ ì™„ë£Œ!</strong><br>ë©”ì¼í•¨ í™•ì¸í•´ì£¼ì„¸ìš”.`; }
}

async function logout() {
Â  Â  if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
Â  Â  Â  Â  await _supabase.auth.signOut(); localStorage.removeItem('erp_user'); location.reload();
Â  Â  }
}
</script>

<script src="patch_note.js"></script>

</body>
</html>
