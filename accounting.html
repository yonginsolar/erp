<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>íšŒê³„ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; }
    .main-container { max-width: 650px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px; }
    
    .stat-card { flex: 1; padding: 15px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .bg-rev { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-exp { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-ast { background: linear-gradient(135deg, #3498db, #2980b9); }
    
    .sub-card { flex: 1; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #eee; background-color: #fff; }
    .text-vat { color: #d63384; font-weight: bold; } 
    .text-cash { color: #0d6efd; font-weight: bold; }
    
    .btn-report { width: 100%; font-weight: bold; border-radius: 10px; }
    .readonly-input { background-color: #f8f9fa; cursor: pointer; }
    
    /* ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
    #reportContent { font-family: "Malgun Gothic", serif; font-size: 12px; }
    .rpt-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; text-decoration: underline; }
    .rpt-header-tbl { width: 100%; border: 2px solid #000; margin-bottom: 20px; }
    .rpt-header-tbl th { background: #f1f3f5; padding: 5px; border: 1px solid #000; text-align: center; width: 15%; }
    .rpt-header-tbl td { padding: 5px; border: 1px solid #000; }
    
    .rpt-tbl { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #000; }
    .rpt-tbl th, .rpt-tbl td { border: 1px solid #000; padding: 6px 8px; }
    .rpt-tbl th { background: #f8f9fa; text-align: center; font-weight: bold; }
    .rpt-amt { text-align: right; font-family: 'Consolas', monospace; }
    .rpt-indent { padding-left: 20px !important; }
    
    /* ì¸ì‡„ ì„¤ì • */
    @media print {
        .page-break { page-break-before: always; }
        .no-print { display: none !important; }
        body { background: white; padding: 0; }
        .main-container { box-shadow: none; border: none; max-width: 100%; padding: 0; }
    }
    
    .search-list-item:hover { background-color: #e9ecef; cursor: pointer; }
    .acc-item-name { font-size: 1.1rem; font-weight: bold; color: #333; }
    .acc-item-std { font-size: 0.85rem; color: #888; }
    
    .hidden { display: none !important; }
    .ime-kr { ime-mode: active; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <h4 class="fw-bold m-0">ğŸ“’ íšŒê³„ ê´€ë¦¬</h4>
    <div>
      <button class="btn btn-outline-secondary btn-sm me-1" onclick="openInfoModal()">â„¹ï¸ ì •ë³´</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2 no-print">
    <div class="stat-card bg-rev"><div>ë§¤ì¶œ</div><div class="fw-bold" id="valRev">0</div></div>
    <div class="stat-card bg-exp"><div>ë¹„ìš©</div><div class="fw-bold" id="valExp">0</div></div>
    <div class="stat-card bg-ast"><div>ìì‚°</div><div class="fw-bold" id="valAst">0</div></div>
  </div>
  <div class="d-flex gap-2 mb-4 no-print">
    <div class="sub-card">
        <div>ğŸ’° í†µì¥ ì”ê³  (ë³´í†µì˜ˆê¸ˆ)</div>
        <div class="text-cash fs-5" id="valCash">0</div>
    </div>
    <div class="sub-card">
        <div>ğŸ§¾ ë¶€ê°€ì„¸ ë‚©ë¶€ì˜ˆìƒ</div>
        <div class="text-vat fs-5" id="valVat">0</div>
    </div>
  </div>

  <div class="input-group mb-4 no-print shadow-sm">
      <select class="form-select" id="reportYearSelect" style="max-width: 120px; font-weight:bold;">
          </select>
      <button class="btn btn-outline-dark btn-report flex-fill" type="button" onclick="printReport()">
          ğŸ–¨ï¸ ê²°ì‚° ë³´ê³ ì„œ ìƒì„±
      </button>
  </div>

  <ul class="nav nav-tabs mb-4 no-print" id="accTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabForm">ğŸ“ ì „í‘œì…ë ¥</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSync">ğŸ”„ ìë™ì—°ë™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistory" onclick="loadHistory()">ğŸ•’ ìµœê·¼ì „í‘œ</button></li>
  </ul>

  <div class="tab-content no-print">
    
    <div class="tab-pane fade show active" id="tabForm">
      <form id="erpForm" onsubmit="handleFormSubmit(event)">
        
        <div class="row mb-3">
          <div class="col-6">
            <label class="small text-muted">ë‚ ì§œ</label>
            <input type="date" class="form-control" id="dateField" required>
          </div>
          <div class="col-6">
            <label class="small text-muted">í”„ë¡œì íŠ¸</label>
            <select class="form-select" id="projectSelect" required></select>
          </div>
        </div>

        <div class="mb-3 p-3 border rounded bg-light">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="small text-muted fw-bold">1. ê±°ë˜ êµ¬ë¶„</label>
            <span class="badge bg-secondary" id="modeBadge">ì¼ë°˜</span>
          </div>
          <div class="d-flex gap-2 mb-2">
             <input type="radio" class="btn-check" name="settleMode" id="smNorm" value="" checked onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-secondary flex-fill" for="smNorm">ì¼ë°˜ê±°ë˜</label>
             <input type="radio" class="btn-check" name="settleMode" id="smPre" value="pre_expense" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-primary flex-fill" for="smPre">ì„¤ë¦½ì „/ê°œì¸</label>
             <input type="radio" class="btn-check" name="settleMode" id="smReim" value="reimburse" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-danger flex-fill" for="smReim">ì •ì‚°ì§€ê¸‰</label>
          </div>
          <div id="payerInputDiv" class="hidden">
            <div class="input-group input-group-sm">
              <span class="input-group-text fw-bold" id="payerLabel">ì´ë¦„</span>
              <input type="text" class="form-control ime-kr" id="payerName" placeholder="ì§€ì¶œì ë˜ëŠ” ë°›ëŠ” ë¶„">
            </div>
          </div>

          <hr class="my-2" style="border-top: 1px dashed #ccc;">

          <label class="small text-muted fw-bold mb-2">2. ê³„ì • ìœ í˜•</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="inputType" id="t1" value="ë§¤ì¶œ" onchange="resetAccountInput()"><label class="btn btn-outline-success" for="t1">ë§¤ì¶œ</label>
            <input type="radio" class="btn-check" name="inputType" id="t2" value="ë¹„ìš©" checked onchange="resetAccountInput()"><label class="btn btn-outline-danger" for="t2">ë¹„ìš©</label>
            <input type="radio" class="btn-check" name="inputType" id="t3" value="ìì‚°" onchange="resetAccountInput()"><label class="btn btn-outline-primary" for="t3">ìì‚°</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="small text-muted">ê³„ì •ê³¼ëª©</label>
          <div class="input-group">
            <input type="text" class="form-control readonly-input ime-kr" id="displayAccount" placeholder="ì„ íƒí•˜ì„¸ìš” (ìœ í˜•ì— ë§ëŠ” í•­ëª©ë§Œ í‘œì‹œë¨)" readonly onclick="openSelModal()">
            <button class="btn btn-secondary" type="button" onclick="openSelModal()">ğŸ”</button>
            <button class="btn btn-outline-secondary" type="button" onclick="openAddModal()">â•</button>
          </div>
          
          <input type="hidden" id="hiddenItem">
          <input type="hidden" id="hiddenStandard">
          <input type="hidden" id="hiddenCode"> <input type="hidden" id="isTaxFree">  <input type="hidden" id="specialMode"> </div>

        <div id="dynamicArea" class="mb-3"></div>

        <div class="mb-3"><label class="small text-muted">ì ìš”</label><input type="text" class="form-control ime-kr" id="inputDesc" required></div>
        <div class="mb-2"><label class="small text-muted">ê¸ˆì•¡ (í•©ê³„)</label><input type="number" class="form-control form-control-lg" id="inputAmount" placeholder="0" required min="0"></div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
           <div class="d-flex align-items-center" id="cardOptionDiv">
               <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="payMethod" onchange="toggleCard()"><label class="form-check-label small" for="payMethod">ğŸ’³ ì¹´ë“œê²°ì œ</label></div>
               <select class="form-select form-select-sm hidden ms-2" id="cardSelect" style="width: 120px;"><option value="">ì¹´ë“œì„ íƒ</option></select>
           </div>
           <div class="ms-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="vatCheck" checked><label class="form-check-label small" for="vatCheck">ë¶€ê°€ì„¸í¬í•¨</label></div></div>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm mt-4" id="submitBtn">ì €ì¥í•˜ê¸°</button>
      </form>
    </div>

    <div class="tab-pane fade" id="tabSync">
      <div class="d-grid gap-3">
          <div class="card p-3 border-start border-5 border-info bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ’¼ ê¸‰ì—¬ ëŒ€ì¥ ì—°ë™</h6><small class="text-muted">HR_Salary â†’ íšŒê³„ ì „í‘œ</small></div>
               <div class="d-flex align-items-center gap-2">
                   <input type="month" id="salaryMonth" class="form-control form-control-sm" style="width: 130px;">
                   <button class="btn btn-info btn-sm text-white" onclick="confirmSync('salary')">ì‹¤í–‰</button>
               </div>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-warning bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ“ ì „ìê²°ì¬ ì—°ë™</h6><small class="text-muted">ì™„ë£Œëœ ì§€ì¶œê²°ì˜ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</small></div>
               <button class="btn btn-warning btn-sm text-white" onclick="confirmSync('approval')">ì‹¤í–‰</button>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-success bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ’° ì¶œìê¸ˆ ì—°ë™</h6><small class="text-muted">ì‹ ê·œ ì…ê¸ˆ ë‚´ì—­ ì „í‘œ ì²˜ë¦¬</small></div>
               <button class="btn btn-success btn-sm text-white" onclick="confirmSync('capital')">ì‹¤í–‰</button>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-primary bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ’¸ ë°°ë‹¹ê¸ˆ ì—°ë™</h6><small class="text-muted">ë°°ë‹¹ê¸ˆ ì§€ê¸‰ ë‚´ì—­ ì²˜ë¦¬</small></div>
               <button class="btn btn-primary btn-sm text-white" onclick="confirmSync('dividend')">ì‹¤í–‰</button>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-secondary bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ“‰ ê°ê°€ìƒê° ì‹¤í–‰</h6><small class="text-muted">ê³ ì •ìì‚° ëŒ€ì¥ ê¸°ì¤€ (ì—° 1íšŒ)</small></div>
               <button class="btn btn-secondary btn-sm text-white" onclick="confirmSync('depreciation')">ì‹¤í–‰</button>
             </div>
          </div>
<div class="card p-3 border-start border-5 border-danger bg-light">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h6 class="fw-bold mb-1">ğŸ“… ì—°ë§ê²°ì‚° (ì†ìµë§ˆê°)</h6>
            <small class="text-muted">ìˆ˜ìµ/ë¹„ìš© ë§ˆê° ë° ìë³¸ ëŒ€ì²´</small>
        </div>
        <div>
            <button class="btn btn-outline-secondary btn-sm me-1" onclick="confirmSync('undo_closing')">ì·¨ì†Œ</button>
            <button class="btn btn-danger btn-sm text-white" onclick="confirmSync('closing')">ì‹¤í–‰</button>
        </div>
    </div>
</div>
      </div>
    </div>

    <div class="tab-pane fade" id="tabHistory">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold m-0">ìµœê·¼ ì „í‘œ 10ê±´</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="loadHistory()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="historyList" class="list-group"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold" id="alertTitle">ì•Œë¦¼</h6></div><div class="modal-body text-center py-4" id="alertBody">ë‚´ìš©</div><div class="modal-footer border-0 pt-0 justify-content-center"><button type="button" class="btn btn-primary btn-sm w-50" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold" id="confirmTitle">í™•ì¸</h6></div><div class="modal-body text-center py-4" id="confirmBody">ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div><div class="modal-footer border-0 pt-0 justify-content-center gap-2"><button type="button" class="btn btn-secondary btn-sm w-40" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="button" class="btn btn-danger btn-sm w-40" id="btnConfirmYes">í™•ì¸</button></div></div></div></div>

<div class="modal fade" id="selectModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header p-3 bg-light"><h6 class="m-0 fw-bold">ê³„ì •ê³¼ëª© ê²€ìƒ‰</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="p-2 border-bottom bg-white sticky-top"><input type="text" class="form-control" id="accountSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." onkeyup="filterAccounts()"></div><div id="accountList" style="height: 350px; overflow-y: auto;"></div></div></div></div></div>

<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">í•­ëª© ì¶”ê°€</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <label class="small text-muted mb-1">êµ¬ë¶„</label><select class="form-select mb-3" id="addTypeSelect" disabled><option value="ë§¤ì¶œ">ë§¤ì¶œ</option><option value="ë¹„ìš©">ë¹„ìš©</option><option value="ìì‚°">ìì‚°</option></select>
    <label class="small text-muted mb-1">ì¤‘ë¶„ë¥˜</label><select class="form-select mb-2" id="addCategorySelect"></select><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="chkManualCat" onchange="toggleManualCat()"><label class="form-check-label small" for="chkManualCat">ì§ì ‘ ì…ë ¥</label></div><input type="text" class="form-control mb-3 hidden" id="manualCatInput" placeholder="ìƒˆ ì¤‘ë¶„ë¥˜ëª… ì…ë ¥">
    <label class="small text-muted mb-1">ì‚¬ìš©ì²˜</label><select class="form-select mb-3" id="addUsageSelect"><option value="ì „ì²´">ì „ì²´</option><option value="ë³¸ì‚¬">ë³¸ì‚¬</option><option value="1í˜¸ê¸°">1í˜¸ê¸°</option><option value="2í˜¸ê¸°">2í˜¸ê¸°</option></select>
    <label class="small text-muted mb-1">ìƒˆ í•­ëª©ëª…</label><input type="text" class="form-control mb-3" id="addNewItemName" placeholder="ì˜ˆ: ì•¼ê·¼ì‹ëŒ€">
<div class="mb-3">
    <label class="form-label d-block fw-bold">í•­ëª© ì†ì„± (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
    <div class="border p-3 rounded bg-light">
        <div class="form-check form-check-inline">
            <input class="form-check-input check-attr" type="checkbox" id="attrTaxFree" value="tax_free">
            <label class="form-check-label" for="attrTaxFree">ë©´ì„¸(ë¶€ê°€ì„¸ ì—†ìŒ)</label>
        </div>
        <hr class="my-2">
        <div class="form-check form-check-inline">
            <input class="form-check-input check-attr" type="checkbox" id="attrLabor33" value="labor_3.3" onchange="toggleLabor(this)">
            <label class="form-check-label" for="attrLabor33">ì¸ê±´ë¹„(3.3%)</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input check-attr" type="checkbox" id="attrLabor88" value="labor_8.8" onchange="toggleLabor(this)">
            <label class="form-check-label" for="attrLabor88">ì¸ê±´ë¹„(8.8%)</label>
        </div>
        <hr class="my-2">
        <div class="form-check form-check-inline">
            <input class="form-check-input check-attr" type="checkbox" id="attrInterest" value="interest">
            <label class="form-check-label" for="attrInterest">ì´ì(ìˆ˜ìµ/ë¹„ìš©)</label>
        </div>
    </div>
</div>

<script>
// ì¸ê±´ë¹„ 3.3%ì™€ 8.8%ê°€ ë™ì‹œì— ì„ íƒë˜ì§€ ì•Šë„ë¡ ì œì–´í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function toggleLabor(target) {
    if (target.id === 'attrLabor33' && target.checked) document.getElementById('attrLabor88').checked = false;
    if (target.id === 'attrLabor88' && target.checked) document.getElementById('attrLabor33').checked = false;
}
</script>
</div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="confAdd()">ì¶”ê°€í•˜ê¸°</button></div></div></div></div>

<div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-white" id="reportContent"></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button><button class="btn btn-primary" onclick="realPrint()">ğŸ–¨ï¸ ì¸ì‡„</button></div></div></div></div>

<div class="modal fade" id="infoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ¢ íšŒì‚¬ ì •ë³´</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="infoForm">
          <div class="mb-2">
            <label class="small text-muted">ì¡°í•©ëª…</label>
            <input type="text" class="form-control bg-light" id="orgName" readonly>
          </div>
          <div class="mb-2">
            <label class="small text-muted">ëŒ€í‘œìëª…</label>
            <input type="text" class="form-control bg-light" id="ceoName" readonly>
          </div>
          <div class="mb-2">
            <label class="small text-muted">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
            <input type="text" class="form-control bg-light" id="bizNum" readonly>
          </div>
          
          <div class="mb-3">
            <label class="small text-muted">ì„¤ë¦½ì¼</label>
            <input type="date" class="form-control bg-light" id="estDate" readonly>
          </div>
          <div class="mb-3">
            <label class="small text-muted">í˜„ì¬ ì¶œìê¸ˆ ì´ì•¡</label>
            <input type="text" class="form-control bg-light" id="totalCap" readonly>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let mData=[], cardData=[]; 
let selectModal, reportModal, addModal, infoModal, alertModal, confirmModal;
let myInfo = null, confirmCallback = null;

// 1. ì´ˆê¸°í™”
window.onload = async function() {
    selectModal = new bootstrap.Modal(document.getElementById('selectModal'));
    reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    addModal = new bootstrap.Modal(document.getElementById('addModal'));
    infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    document.getElementById("btnConfirmYes").onclick = function() { if(confirmCallback) confirmCallback(); confirmModal.hide(); };

    const stored = localStorage.getItem('erp_user');
    if(stored) myInfo = JSON.parse(stored);

    document.getElementById('dateField').valueAsDate = new Date();
    document.getElementById('salaryMonth').value = new Date().toISOString().slice(0, 7);

    // ë³´ê³ ì„œ ì—°ë„ ì˜µì…˜ ìƒì„±
    const yearSel = document.getElementById("reportYearSelect");
    const currentYear = new Date().getFullYear();
    for (let y = currentYear; y >= currentYear - 2; y--) {
        const opt = document.createElement("option");
        opt.value = y; opt.text = y + "ë…„"; yearSel.add(opt);
    }

    // ë°ì´í„° ë¡œë“œ (ìˆœì„œ ì¤‘ìš”: í”„ë¡œì íŠ¸ -> ë§ˆìŠ¤í„° -> ì¹´ë“œ -> ëŒ€ì‹œë³´ë“œ)
    await loadProjects(); 
    await Promise.all([ loadMasterData(), loadCards(), refreshDashboard() ]);
};

// Helper
function showAlert(t,m) { document.getElementById("alertTitle").innerText=t; document.getElementById("alertBody").innerHTML=m; alertModal.show(); }
function showConfirm(t,m,cb) { document.getElementById("confirmTitle").innerText=t; document.getElementById("confirmBody").innerHTML=m; confirmCallback=cb; confirmModal.show(); }
function validNum(el) { if(el.value < 0) el.value = Math.abs(el.value); }

// 2. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤

// [ì‹ ê·œ] í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ (DB ì—°ë™)
async function loadProjects() {
    const { data, error } = await _supabase.from('ref_projects').select('*').order('id');
    const sel = document.getElementById("projectSelect");
    sel.innerHTML = "";
    
    if (data && data.length > 0) {
        data.forEach(p => sel.add(new Option(p.project_name, p.project_name)));
    } else {
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
        sel.add(new Option("ë³¸ì‚¬", "ë³¸ì‚¬"));
        sel.add(new Option("1í˜¸ê¸°", "1í˜¸ê¸°"));
        sel.add(new Option("2í˜¸ê¸°", "2í˜¸ê¸°"));
    }
}

// [ìˆ˜ì •] ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë“œ (SpecialType, Tax_Free, Usage í™•ì¸)
async function loadMasterData() {
    const { data } = await _supabase.from('ac_master').select('*').order('Type').order('Standard').order('Item');
    if(data) mData = data; 
}

async function loadCards() {
    const { data } = await _supabase.from('ref_cards').select('*');
    if(data) {
        cardData = data;
        const sel = document.getElementById("cardSelect");
        sel.innerHTML = "<option value=''>ì¹´ë“œì„ íƒ</option>";
        cardData.forEach(c => sel.add(new Option(c.card_alias, c.card_alias))); 
    }
}

// 3. ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
// [ìˆ˜ì •] ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ (í•˜ì´ë¸Œë¦¬ë“œ ì§‘ê³„ ë¡œì§ ì ìš©)
// [ìˆ˜ì •] ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ (ìì‚° ë»¥íŠ€ê¸° ì˜¤ë¥˜ ìˆ˜ì • ë° í•˜ì´ë¸Œë¦¬ë“œ ì§‘ê³„)
// [ìˆ˜ì •] ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ (ë¶€ê°€ì„¸ ë¶„ê¸°ë³„ ì§‘ê³„ ë¡œì§ ì ìš©)
async function refreshDashboard() {
    const { data } = await _supabase.from('ac_journal').select('*');
    if (!data) return;

    const now = new Date();
    const currentYear = now.getFullYear().toString();
    const currentMonth = now.getMonth() + 1; // 1~12ì›”
    
    // í˜„ì¬ ë¶„ê¸° ê³„ì‚° (1: 1~3ì›”, 2: 4~6ì›”, 3: 7~9ì›”, 4: 10~12ì›”)
    const currentQuarter = Math.ceil(currentMonth / 3);
    const startMonthOfQuarter = (currentQuarter - 1) * 3 + 1; // ë¶„ê¸° ì‹œì‘ì›” (1, 4, 7, 10)

    let rev = 0;         // ë§¤ì¶œ (ê¸ˆë…„ë„ ì „ì²´)
    let exp = 0;         // ë¹„ìš© (ê¸ˆë…„ë„ ì „ì²´)
    let ast = 0;         // ì´ìì‚° (ì „ì²´ ëˆ„ì )
    let vatIn = 0;       // ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ (í˜„ì¬ ë¶„ê¸°ë§Œ)
    let vatOut = 0;      // ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ (í˜„ì¬ ë¶„ê¸°ë§Œ)
    let bankBalance = 0; // ë³´í†µì˜ˆê¸ˆ (ì „ì²´ ëˆ„ì )

    data.forEach(r => {
        const db = Number(r.Debit || 0);
        const cr = Number(r.Credit || 0);
        if (!r.Date) return;

        const rYear = r.Date.substring(0, 4);
        const rMonth = Number(r.Date.substring(5, 7));

        // 1. ìì‚° í˜„í™© ë° í†µì¥ ì”ì•¡ (ì „ì²´ ëˆ„ì )
        if (r.Type === 'ìì‚°') {
            ast += (db - cr);
            if (r.Account === 'ë³´í†µì˜ˆê¸ˆ' || r.Account === 'í˜„ê¸ˆ') {
                bankBalance += (db - cr);
            }
        }

        // 2. ë§¤ì¶œ/ë¹„ìš© (ê¸ˆë…„ë„ ì „ì²´ í•©ê³„)
        if (rYear === currentYear) {
            if (r.Type === 'ë§¤ì¶œ') rev += cr;
            else if (r.Type === 'ë¹„ìš©') exp += db;

            // 3. ë¶€ê°€ì„¸ (í˜„ì¬ ë¶„ê¸° ë°ì´í„°ë§Œ ì§‘ê³„)
            // ì „í‘œ ì›”(rMonth)ì´ í˜„ì¬ ë¶„ê¸° ì‹œì‘ì›”ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ìœ¼ë©´ í•´ë‹¹ ë¶„ê¸° ë°ì´í„°ì„
            if (rMonth >= startMonthOfQuarter && rMonth <= (startMonthOfQuarter + 2)) {
                if (r.Account === 'ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ') vatIn += (cr - db);
                if (r.Account === 'ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ') vatOut += (db - cr);
            }
        }
    });

    // UI ë°˜ì˜
    document.getElementById("valRev").innerText = rev.toLocaleString(); // ì˜¬í•´ ì´ ë§¤ì¶œ
    document.getElementById("valExp").innerText = exp.toLocaleString(); // ì˜¬í•´ ì´ ë¹„ìš©
    document.getElementById("valAst").innerText = ast.toLocaleString(); // í˜„ì¬ ì´ ìì‚°
    document.getElementById("valCash").innerText = bankBalance.toLocaleString(); // í˜„ì¬ í†µì¥ ì”ê³ 
    document.getElementById("valVat").innerText = (vatIn - vatOut).toLocaleString(); // â˜…í˜„ì¬ ë¶„ê¸° ì˜ˆìƒ ë¶€ê°€ì„¸
}

// 4. ëª¨ë‹¬ ë° UI ì œì–´ ë¡œì§

function resetAccountInput() {
    document.getElementById("displayAccount").value = "";
    document.getElementById("hiddenItem").value = "";
    document.getElementById("hiddenCode").value = "";
    document.getElementById("isTaxFree").value = "";
    document.getElementById("specialMode").value = "";
    document.getElementById("dynamicArea").innerHTML = "";
    document.getElementById("cardOptionDiv").style.display = "none";
}

function openSelModal() { 
    filterAccounts(); 
    selectModal.show(); 
    setTimeout(() => document.getElementById("accountSearchInput").focus(), 300); 
}

// [ìˆ˜ì •] ê³„ì •ê³¼ëª© ê²€ìƒ‰ í•„í„° (Usage ì—°ë™)
// [ìˆ˜ì •] í”„ë¡œì íŠ¸(Usage) í•„í„°ë§ì´ ì¶”ê°€ëœ ê³„ì •ê³¼ëª© ê²€ìƒ‰ í•¨ìˆ˜
function filterAccounts() {
    const k = document.getElementById("accountSearchInput").value.trim();
    const type = document.querySelector('input[name="inputType"]:checked').value;
    
    // [ì¶”ê°€] í˜„ì¬ ì„ íƒëœ í”„ë¡œì íŠ¸ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (ë³¸ì‚¬ vs ë°œì „ì†Œ êµ¬ë¶„ìš©)
    const currentProject = document.getElementById("projectSelect").value; 
    const list = document.getElementById("accountList");
    
    list.innerHTML = "";
    
    const filtered = mData.filter(m => {
        const mType = m.Type || m.type;
        const mItem = m.Item || m.item;
        const mStandard = m.Standard || m.standard;
        const mUsage = m.Usage || m.usage || "ì „ì²´"; // Usage ê°’ì´ ì—†ìœ¼ë©´ 'ì „ì²´'ë¡œ ê°„ì£¼

        // 1. ê³„ì • ìœ í˜•(ë§¤ì¶œ/ë¹„ìš©/ìì‚°) ë° í‚¤ì›Œë“œ ë§¤ì¹­
        const typeMatch = (mType === type);
        const keywordMatch = (mItem.includes(k) || mStandard.includes(k));

        // 2. [í•µì‹¬] í”„ë¡œì íŠ¸ë³„ Usage í•„í„°ë§ ë…¼ë¦¬
        let usageMatch = false;
        if (currentProject === "ë³¸ì‚¬") {
            // ë³¸ì‚¬ ì„ íƒ ì‹œ: Usageê°€ 'ì „ì²´' ë˜ëŠ” 'ë³¸ì‚¬'ì¸ ê²ƒë§Œ
            usageMatch = (mUsage === "ì „ì²´" || mUsage === "ë³¸ì‚¬");
        } else {
            // ë³¸ì‚¬ê°€ ì•„ë‹Œ(ë°œì „ì†Œ ë“±) ì„ íƒ ì‹œ: Usageê°€ 'ì „ì²´' ë˜ëŠ” 'ë°œì „ì†Œ'ì¸ ê²ƒë§Œ
            usageMatch = (mUsage === "ì „ì²´" || mUsage === "ë°œì „ì†Œ");
        }

        return typeMatch && keywordMatch && usageMatch;
    });
    
    if(filtered.length === 0) { 
        list.innerHTML = "<div class='p-3 text-center text-muted'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; 
        return; 
    }

    // í™”ë©´ì— ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
    filtered.forEach(acc => {
        const d = document.createElement("div");
        d.className = "list-group-item list-group-item-action p-2 ps-3 border-0 border-bottom search-list-item";
        
        const isTaxFree = acc.tax_free; 
        const specialType = acc.special_code
        
        const badge = (isTaxFree === true || isTaxFree === 'TRUE' || isTaxFree === 'ë©´ì„¸') ? '<span class="badge bg-secondary ms-2" style="font-size:0.7em;">ë©´ì„¸</span>' : '';
        const spBadge = (specialType) ? `<span class="badge bg-info text-dark ms-1" style="font-size:0.7em;">${specialType}</span>` : '';

        d.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div><span class="acc-item-name">${acc.Item}</span><span class="acc-item-std ms-1">(${acc.Standard})</span></div><div>${spBadge}${badge}</div></div>`;
        
        d.onclick = () => {
            document.getElementById("displayAccount").value = acc.Item;
            document.getElementById("hiddenItem").value = acc.Item;
            document.getElementById("hiddenStandard").value = acc.Standard;
            document.getElementById("hiddenCode").value = acc.Code || acc.code || ""; 
            document.getElementById("isTaxFree").value = isTaxFree; 
            document.getElementById("specialMode").value = specialType || ""; 
            
            // íŠ¹ìˆ˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
            updateDynamicUI(acc.Item, acc.Type, specialType, isTaxFree);
            selectModal.hide();
        };
        list.appendChild(d);
    });
}

// [ìˆ˜ì •] ê³„ì •ê³¼ëª© ì„ íƒ í›„ UI ë³€ê²½ (íŠ¹ìˆ˜ ë¡œì§ ë°˜ì˜)
function updateDynamicUI(accName, accType, specialCode, isTaxFree) {
    const area = document.getElementById("dynamicArea");
    const vatCheck = document.getElementById("vatCheck");
    const cardDiv = document.getElementById("cardOptionDiv");
    
    area.innerHTML = ""; 
    
    // 1. ë©´ì„¸ ì²˜ë¦¬ (Tax_Free ì¹¼ëŸ¼ ì²´í¬)
    if (isTaxFree === true || isTaxFree === 'TRUE' || isTaxFree === 'ë©´ì„¸') { 
        vatCheck.checked = false; 
        vatCheck.disabled = true; 
    } else { 
        vatCheck.disabled = false; 
        vatCheck.checked = true; 
    }
    
    // ì´ˆê¸°í™”
    document.getElementById("payMethod").checked = false;
    document.getElementById("cardSelect").classList.add("hidden");
    cardDiv.style.display = (accType === "ë¹„ìš©") ? "flex" : "none";

    // 2. SpecialType ê°’ì— ë”°ë¥¸ UI ìƒì„±
    if (specialCode === "interest_inc") { // ì´ììˆ˜ìµ
        area.innerHTML = `<div class="special-box alert alert-primary p-2 mb-2"><small class="fw-bold">â„¹ï¸ ì´ììˆ˜ìµ (ì›ì²œì§•ìˆ˜ ìë™ë¶„ê°œ)</small><br>ì„¸ì „ ì´ìì´ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”. (15.4% ìë™ ì°¨ê°)</div>`;
        vatCheck.checked = false; vatCheck.disabled = true; cardDiv.style.display = "none";
    } 
    else if (specialCode === "salary" || specialCode === "retirement_pension") { // ê¸‰ì—¬, í‡´ì§ì—°ê¸ˆ
        area.innerHTML = `<div class="special-box alert alert-success p-2 mb-2"><small class="fw-bold">â„¹ï¸ ì¸ê±´ë¹„ ì²˜ë¦¬</small><br>4ëŒ€ë³´í—˜/ì„¸ê¸ˆ ë“±ì€ ê¸‰ì—¬ì—°ë™ ê¸°ëŠ¥ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>`;
        vatCheck.checked = false; vatCheck.disabled = true; cardDiv.style.display = "none";
    } 
   if (specialCode === "insurance") { // 4ëŒ€ë³´í—˜ ë‚©ë¶€ (ë¶€ì±„ ìƒí™˜ ë° ì°¨ì•¡ ì •ì‚°)
        // ê¸°ë³¸ê°’: ì§€ë‚œë‹¬ (ë³´í†µ 10ì¼ì— ë‚©ë¶€í•˜ë¯€ë¡œ ì§€ë‚œë‹¬ ê·€ì†ë¶„)
        const now = new Date();
        now.setMonth(now.getMonth() - 1);
        const lastMonthYM = now.toISOString().slice(0, 7);

        area.innerHTML = `
            <div class="special-box alert alert-primary p-2 mb-2">
                <small class="fw-bold">â„¹ï¸ 4ëŒ€ë³´í—˜ í†µí•© ë‚©ë¶€</small>
                <div class="x-small text-muted mb-2">ì§€ë‚œë‹¬ ê¸‰ì—¬ì—°ë™ìœ¼ë¡œ ì¡íŒ ë¶€ì±„ë¥¼ ìƒí™˜í•©ë‹ˆë‹¤.</div>
                
                <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">ê·€ì†ì›”</span>
                    <input type="month" class="form-control" id="payTargetMonth" value="${lastMonthYM}">
                    <button class="btn btn-dark" type="button" onclick="fetchLiabilitySum()">ì¥ë¶€ ì¡°íšŒ</button>
                </div>

                <div class="d-flex justify-content-between align-items-center border-bottom pb-1 mb-1">
                    <span class="small">ì¥ë¶€ìƒ ë‚©ë¶€ì•¡</span>
                    <span id="txtBookVal" class="fw-bold fs-6 text-primary">0ì›</span>
                </div>
                <div id="txtDetailVal" class="x-small text-end text-muted mb-2">-</div>

                <input type="hidden" id="hiddenBookVal" value="0">
                <input type="hidden" id="hiddenYesu" value="0">
                <input type="hidden" id="hiddenMigigeub" value="0">

                <div class="form-text x-small text-danger fw-bold">* ì•„ë˜ 'ê¸ˆì•¡' ë€ì— ì‹¤ì œ í†µì¥ ì¶œê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.<br>* ì°¨ì•¡ì€ ì¡ì´ìµ/ì¡ì†ì‹¤ë¡œ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>
            </div>`;
        
        // ë¶€ê°€ì„¸ ì²´í¬ í•´ì œ ë° ë¹„í™œì„±, ì¹´ë“œì…ë ¥ ìˆ¨ê¹€
        vatCheck.checked = false; vatCheck.disabled = true; cardDiv.style.display = "none";
    }
    else if (specialCode === "loan_pay") { // ëŒ€ì¶œìƒí™˜
        area.innerHTML = `<div class="special-box alert alert-warning p-2 mb-2"><small class="fw-bold">â„¹ï¸ ëŒ€ì¶œ ì›ë¦¬ê¸ˆ ìƒí™˜</small><div class="input-group input-group-sm mt-1"><span class="input-group-text">ì´ì í¬í•¨ë¶„</span><input type="number" class="form-control" id="loanInterest" placeholder="ì´ ì¤‘ ì´ìëŠ” ì–¼ë§ˆ?" min="0" oninput="validNum(this)"></div></div>`;
        vatCheck.checked = false; vatCheck.disabled = true; cardDiv.style.display = "none";
    } 
    else if (specialCode === "labor") { // ì¸ì ìš©ì—­
        area.innerHTML = `<div class="special-box alert alert-danger p-2 mb-2"><small class="fw-bold">â„¹ï¸ ì‚¬ì—…ì†Œë“ì„¸ (ì›ì²œì§•ìˆ˜)</small><div class="btn-group btn-group-sm w-100 mt-1"><input type="radio" class="btn-check" name="laborTaxRate" id="tax33" value="0.033" checked><label class="btn btn-outline-secondary" for="tax33">3.3% (ì¼ë°˜)</label><input type="radio" class="btn-check" name="laborTaxRate" id="tax88" value="0.088"><label class="btn btn-outline-secondary" for="tax88">8.8% (ê°•ì‚¬ë£Œ ë“±)</label></div></div>`;
        vatCheck.checked = false; vatCheck.disabled = true; cardDiv.style.display = "none";
    }
}

// ê±°ë˜ êµ¬ë¶„ ë³€ê²½ ì‹œ UI ì œì–´
function toggleSettleMode() {
    const mode = document.querySelector('input[name="settleMode"]:checked').value;
    const inputDiv = document.getElementById("payerInputDiv");
    const payerLabel = document.getElementById("payerLabel");
    const badge = document.getElementById("modeBadge");
    
    inputDiv.classList.add("hidden");
    
    if (mode === "pre_expense") {
        inputDiv.classList.remove("hidden");
        payerLabel.innerText = "ì§€ì¶œì";
        badge.className = "badge bg-primary"; badge.innerText = "ë¯¸ì§€ê¸‰ê¸ˆ";
    } else if (mode === "reimburse") {
        inputDiv.classList.remove("hidden");
        payerLabel.innerText = "ë°›ëŠ”ë¶„";
        badge.className = "badge bg-danger"; badge.innerText = "ìƒí™˜";
    } else {
        badge.className = "badge bg-secondary"; badge.innerText = "ì¼ë°˜";
    }
}

function toggleCard() { 
    const chk = document.getElementById("payMethod").checked;
    const sel = document.getElementById("cardSelect");
    if(chk) { sel.classList.remove("hidden"); sel.required = true; }
    else { sel.classList.add("hidden"); sel.value=""; sel.required = false; }
}

// 5. ì „í‘œ ì €ì¥ ë¡œì§ (ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì • ë° ê¸°ì¡´ ë¡œì§ 100% ë³´ì¡´)
async function handleFormSubmit(e) {
    e.preventDefault();
    const item = document.getElementById("hiddenItem").value;
    if(!item) return showAlert("ì˜¤ë¥˜", "ê³„ì •ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    
    const fDate = document.getElementById("dateField").value;
    const project = document.getElementById("projectSelect").value;
    const type = document.querySelector('input[name="inputType"]:checked').value;
    const settleMode = document.querySelector('input[name="settleMode"]:checked').value;
    const desc = document.getElementById("inputDesc").value;
    const totalAmt = Number(document.getElementById("inputAmount").value);
    const useVAT = document.getElementById("vatCheck").checked;
    
    // íŠ¹ìˆ˜ ì½”ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const specialCode = document.getElementById("specialMode").value;
    
    const isCard = (settleMode === "") && document.getElementById("payMethod").checked;
    const cardName = isCard ? document.getElementById("cardSelect").value : "";
    const payerName = document.getElementById("payerName").value || "ì§€ì¶œì";

    let finalDesc = desc;
    if(isCard) finalDesc = `[${cardName}] ${desc}`;
    if(settleMode === 'pre_expense') finalDesc = `[ì„¤ë¦½ì „] ${desc} (${payerName})`;
    if(settleMode === 'reimburse') finalDesc = `[ì •ì‚°] ${desc} (${payerName})`;

    // ë¶€ê°€ì„¸ ê³„ì‚°
    let netAmount = totalAmt, vatAmount = 0;
    if (useVAT && type !== 'ìì‚°' && settleMode !== 'reimburse' && !document.getElementById("vatCheck").disabled) {
        netAmount = Math.round(totalAmt / 1.1);
        vatAmount = totalAmt - netAmount;
    }

    let entries = [];
    const writer = myInfo ? myInfo.emp_name : "WebUser";

    // --- [1] íŠ¹ìˆ˜ ë¶„ê°œ ë¡œì§ ---
    
    // [ìˆ˜ì •ë¨] ì—¬ê¸°ê°€ 'else if'ê°€ ì•„ë‹ˆë¼ 'if'ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.
    if (specialCode === 'insurance') { // 4ëŒ€ë³´í—˜ ë‚©ë¶€ (ë¶€ì±„ ìƒí™˜ ë° ì°¨ì•¡ ì •ì‚°)
        const bookYesu = Number(document.getElementById("hiddenYesu").value);
        const bookMigigeub = Number(document.getElementById("hiddenMigigeub").value);
        const bookTotal = bookYesu + bookMigigeub;
        
        // ì¡°íšŒ ì—†ì´ ì €ì¥ ëˆ„ë¥´ëŠ” ê²ƒ ë°©ì§€
        if (bookTotal === 0 && totalAmt > 0) {
            return showAlert("ì˜¤ë¥˜", "ë¨¼ì € [ì¥ë¶€ ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶€ì±„ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
        }
        
        // ì°¨ì•¡ ê³„ì‚° (ì‹¤ì œë‚©ë¶€ - ì¥ë¶€ìƒë¶€ì±„)
        const diff = totalAmt - bookTotal; 

        // 1. (ì°¨ë³€) ì˜ˆìˆ˜ê¸ˆ ìƒí™˜ (ì§ì›ë¶€ë‹´ë¶„ ë¶€ì±„ ê°ì†Œ)
        if (bookYesu > 0) {
            entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ì˜ˆìˆ˜ê¸ˆ', Description: `${finalDesc} (ì§ì›ë¶„ ìƒí™˜)`, Debit: bookYesu, Credit: 0, Project: project, Operator: writer });
        }

        // 2. (ì°¨ë³€) ë¯¸ì§€ê¸‰ë¹„ìš© ìƒí™˜ (íšŒì‚¬ë¶€ë‹´ë¶„ ë¶€ì±„ ê°ì†Œ)
        if (bookMigigeub > 0) {
            entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ë¹„ìš©', Description: `${finalDesc} (íšŒì‚¬ë¶„ ìƒí™˜)`, Debit: bookMigigeub, Credit: 0, Project: project, Operator: writer });
        }
        
        // 3. ì°¨ì•¡ ì²˜ë¦¬ (ì¡ì†ì‹¤/ì¡ì´ìµ)
        if (diff > 0) { 
            // ì‹¤ì œ ëˆì´ ë” ë‚˜ê° -> ë¹„ìš©(ì¡ì†ì‹¤) ë°œìƒ
            entries.push({ Date: fDate, Type: 'ë¹„ìš©', Account: 'ì¡ì†ì‹¤', Description: `[4ëŒ€ë³´í—˜] ë‚©ë¶€ì°¨ì•¡(ì ˆì‚¬)`, Debit: diff, Credit: 0, Project: project, Operator: writer });
        } else if (diff < 0) {
            // ì‹¤ì œ ëˆì´ ëœ ë‚˜ê° -> ìˆ˜ìµ(ì¡ì´ìµ) ë°œìƒ
            entries.push({ Date: fDate, Type: 'ë§¤ì¶œ', Account: 'ì¡ì´ìµ', Description: `[4ëŒ€ë³´í—˜] ë‚©ë¶€ì°¨ì•¡(ì ˆì‚¬)`, Debit: 0, Credit: Math.abs(diff), Project: project, Operator: writer });
        }

        // 4. (ëŒ€ë³€) ë³´í†µì˜ˆê¸ˆ (ì‹¤ì œ ëˆ ë‚˜ê°)
        entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
    }
    else if (specialCode === 'loan_pay') { // ëŒ€ì¶œìƒí™˜
        const interest = Number(document.getElementById("loanInterest")?.value || 0);
        const principal = totalAmt - interest;
        entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
        if(interest > 0) entries.push({ Date: fDate, Type: 'ë¹„ìš©', Account: 'ì´ìë¹„ìš©', Description: `[${item}] ì´ì`, Debit: interest, Credit: 0, Project: project, Operator: writer });
        if(principal > 0) entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: item, Description: `[${item}] ì›ê¸ˆìƒí™˜`, Debit: principal, Credit: 0, Project: project, Operator: writer });
    }
    else if (specialCode === 'labor') { // ì¸ì ìš©ì—­
        const taxRate = Number(document.querySelector('input[name="laborTaxRate"]:checked').value);
        const taxAmt = Math.floor(totalAmt * taxRate / 10) * 10;
        const realPay = totalAmt - taxAmt;
        entries.push({ Date: fDate, Type: 'ë¹„ìš©', Account: item, Description: finalDesc, Debit: totalAmt, Credit: 0, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ì˜ˆìˆ˜ê¸ˆ', Description: `[${item}] ì›ì²œì§•ìˆ˜(${taxRate*100}%)`, Debit: 0, Credit: taxAmt, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: 0, Credit: realPay, Project: project, Operator: writer });
    }
    else if (specialCode === 'interest_inc') { // ì´ììˆ˜ìµ
        const taxAmt = Math.floor(totalAmt * 0.154 / 10) * 10;
        const realIn = totalAmt - taxAmt;
        entries.push({ Date: fDate, Type: 'ë§¤ì¶œ', Account: item, Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ì„ ë‚©ì„¸ê¸ˆ', Description: `[${item}] ì›ì²œì§•ìˆ˜`, Debit: taxAmt, Credit: 0, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: realIn, Credit: 0, Project: project, Operator: writer });
    }
    
    // --- [2] ì¼ë°˜ ë¶„ê°œ ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
    
    else if (settleMode === 'pre_expense') {
        entries.push({ Date: fDate, Type: type, Account: item, Description: finalDesc, Debit: netAmount, Credit: 0, Project: project, Operator: writer });
        if(vatAmount > 0) entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ', Description: `[${item}] ë¶€ê°€ì„¸`, Debit: vatAmount, Credit: 0, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ê¸ˆ', Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
    } 
    else if (settleMode === 'reimburse') {
        entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ê¸ˆ', Description: finalDesc, Debit: totalAmt, Credit: 0, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
    } 
    else {
        // ì¼ë°˜ ë§¤ì¶œ/ë¹„ìš©/ìì‚° ì²˜ë¦¬
        if (type === 'ë§¤ì¶œ') {
            entries.push({ Date: fDate, Type: 'ë§¤ì¶œ', Account: item, Description: finalDesc, Debit: 0, Credit: netAmount, Project: project, Operator: writer });
            if(vatAmount > 0) entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ', Description: `[${item}] ë¶€ê°€ì„¸`, Debit: 0, Credit: vatAmount, Project: project, Operator: writer });
            entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: totalAmt, Credit: 0, Project: project, Operator: writer });
        } else if (type === 'ë¹„ìš©') {
            const creditAcc = isCard ? 'ë¯¸ì§€ê¸‰ê¸ˆ' : 'ë³´í†µì˜ˆê¸ˆ';
            const creditType = isCard ? 'ë¶€ì±„' : 'ìì‚°';
            entries.push({ Date: fDate, Type: 'ë¹„ìš©', Account: item, Description: finalDesc, Debit: netAmount, Credit: 0, Project: project, Operator: writer });
            if(vatAmount > 0) entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ', Description: `[${item}] ë¶€ê°€ì„¸`, Debit: vatAmount, Credit: 0, Project: project, Operator: writer });
            entries.push({ Date: fDate, Type: creditType, Account: creditAcc, Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
        } else { // ìì‚° ë“± ê¸°íƒ€
            const isDebit = (type === "ìì‚°" || type === "ìë³¸ë°˜í™˜" || type === "ë¶€ì±„ê°ì†Œ");
            const db = isDebit ? totalAmt : 0;
            const cr = isDebit ? 0 : totalAmt;
            let saveType = type === "ìë³¸ë°˜í™˜" ? "ìë³¸" : type;
            entries.push({ Date: fDate, Type: saveType, Account: item, Description: finalDesc, Debit: db, Credit: cr, Project: project, Operator: writer });
            entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: cr, Credit: db, Project: project, Operator: writer });
        }
    }

    const { error } = await _supabase.from('ac_journal').insert(entries);
    if(error) showAlert("ì˜¤ë¥˜", "ì €ì¥ ì‹¤íŒ¨: " + error.message);
    else {
        showAlert("ì™„ë£Œ", "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById("erpForm").reset();
        document.getElementById("smNorm").checked = true;
        document.getElementById("dynamicArea").innerHTML = "";
        document.getElementById("specialMode").value = "";
        toggleSettleMode();
        refreshDashboard();
    }
}

// 6. ìë™ ì—°ë™ ê¸°ëŠ¥ (6ì¢… ì™„ë²½ êµ¬í˜„)
function confirmSync(type) {
    const today = new Date().toISOString().slice(0,10);
    const writer = myInfo ? myInfo.emp_name : "System";

// (1) ê¸‰ì—¬ ì—°ë™ (ìˆ˜ì •ë³¸: ë§ì¼ì ê¸°ì¤€ + íšŒì‚¬ë¶€ë‹´ë¶„ ë¶€ì±„ ê³„ìƒ)
    else if(type === 'salary') {
        const ym = document.getElementById("salaryMonth").value; // ì˜ˆ: "2025-10"
        if(!ym) return showAlert("ì•Œë¦¼", "ë…„-ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");
        
        // [ì¤‘ìš”] í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ êµ¬í•˜ê¸° (ë§ì¼ì ê¸°ì¤€ ë°œìƒì£¼ì˜)
        const [year, month] = ym.split('-').map(Number);
        const lastDay = new Date(year, month, 0).getDate(); // 0ì€ ì´ì „ë‹¬ì˜ ë§ˆì§€ë§‰ë‚ ì´ë¯€ë¡œ monthë¥¼ ê·¸ëŒ€ë¡œ ì“°ë©´ ë¨ (JS monthëŠ” 0ë¶€í„° ì‹œì‘í•˜ì§€ë§Œ Dateìƒì„±ìì—ì„œëŠ” 1ë¶€í„° ì‹œì‘í•˜ëŠ” íš¨ê³¼)
        // ìœ„ ì„¤ëª…ì´ í—·ê°ˆë¦´ ìˆ˜ ìˆì–´ ì§ê´€ì  ì½”ë“œ ì‚¬ìš©: new Date(2025, 10, 0) -> 10ì›” 31ì¼
        const lastDateObj = new Date(year, month, 0); 
        const fDate = lastDateObj.toISOString().slice(0, 10); // "2025-10-31"

        showConfirm("ê¸‰ì—¬ ì—°ë™", `${ym}ì›” ê¸‰ì—¬ ë° 4ëŒ€ë³´í—˜(íšŒì‚¬ë¶„)ì„ ì „í‘œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì „í‘œì¼ì: <span class="fw-bold text-primary">${fDate}</span>`, async () => {
            
            // 1. ì¤‘ë³µ ë°©ì§€ (DB ìƒíƒœ ì²´í¬)
            const { data: alreadyProcessed } = await _supabase.from('hr_salary').select('id').eq('year_month', ym).eq('is_accounted', true).limit(1);
            if (alreadyProcessed && alreadyProcessed.length > 0) return showAlert("ì¤‘ë³µ", `ì´ë¯¸ ${ym}ì›” ê¸‰ì—¬ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);

            // 2. [í•µì‹¬] íšŒì‚¬ ë¶€ë‹´ë¶„ ìë™ ê³„ì‚° (DB í•¨ìˆ˜ í˜¸ì¶œ)
            // ë°©ê¸ˆ ë§Œë“  SQL í•¨ìˆ˜ë¥¼ ì—¬ê¸°ì„œ ì‹¤í–‰í•´ì„œ ë¹ˆì¹¸ì„ ì±„ì›ë‹ˆë‹¤.
            const { error: calcError } = await _supabase.rpc('calc_company_share', { target_ym: ym });
            if(calcError) return showAlert("ì˜¤ë¥˜", "íšŒì‚¬ë¶€ë‹´ë¶„ ê³„ì‚° ì‹¤íŒ¨: " + calcError.message);

            // 3. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê³„ì‚°ëœ ê²°ê³¼ ì¡°íšŒ)
            const { data: salaries, error: fetchError } = await _supabase.from('hr_salary').select('*').eq('year_month', ym);
            if(fetchError || !salaries.length) return showAlert("ì˜¤ë¥˜", "ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            // 4. í•©ê³„ ì§‘ê³„
            let totalPay = 0;   // ì§€ê¸‰ì´ì•¡ (ê¸‰ì—¬)
            let totalDed = 0;   // ì§ì›ê³µì œì´ì•¡ (ì˜ˆìˆ˜ê¸ˆ)
            let totalNet = 0;   // ì‹¤ì§€ê¸‰ì•¡ (ë³´í†µì˜ˆê¸ˆ/ë¯¸ì§€ê¸‰ê¸ˆ) -> ë¯¸ì§€ê¸‰ê¸ˆìœ¼ë¡œ ì¡ëŠ”ê²Œ ë§ìŒ(ë§ì¼ ê¸°ì¤€ì´ë¼ ì´ì²´ ì•ˆí–ˆìœ¼ë‹ˆ)
            let totalCo = 0;    // íšŒì‚¬ë¶€ë‹´ì´ì•¡ (ì„¸ê¸ˆê³¼ê³µê³¼)
            
            let salaryIds = [];

            salaries.forEach(s => {
                totalPay += Number(s.pay_total || 0);
                totalDed += Number(s.ded_total || 0);
                totalNet += Number(s.net_pay || 0);
                totalCo  += Number(s.co_total || 0); // ê³„ì‚°ëœ íšŒì‚¬ë¶€ë‹´ê¸ˆ í•©ê³„
                salaryIds.push(s.id);
            });

            // 5. ì „í‘œ ë°ì´í„° ì¤€ë¹„
            let entries = [];
            const desc = `[ê¸‰ì—¬] ${ym}ì›”ë¶„`;

            // === [A] ì§ì› ê¸‰ì—¬ ì²˜ë¦¬ ===
            // (ì°¨) ê¸‰ì—¬ (ë¹„ìš©)
            entries.push({
                Date: fDate, Type: 'ë¹„ìš©', Account: 'ê¸‰ì—¬', 
                Description: `${desc} ì •ê¸°ê¸‰ì—¬ (${salaries.length}ëª…)`, 
                Debit: totalPay, Credit: 0, 
                Project: 'ë³¸ì‚¬', Operator: writer
            });

            // (ëŒ€) ì˜ˆìˆ˜ê¸ˆ (ì§ì›ë¶€ë‹´ë¶„)
            if(totalDed > 0) {
                entries.push({
                    Date: fDate, Type: 'ë¶€ì±„', Account: 'ì˜ˆìˆ˜ê¸ˆ', 
                    Description: `${desc} ì§ì›ê³µì œë¶„`, 
                    Debit: 0, Credit: totalDed, 
                    Project: 'ë³¸ì‚¬', Operator: writer
                });
            }

            // (ëŒ€) ë¯¸ì§€ê¸‰ê¸ˆ (ì‹¤ì§€ê¸‰ì•¡) 
            // * ì¤‘ìš”: ë§ì¼ìì— ë¹„ìš©ì„ ì¡ëŠ” ê²ƒì´ë¯€ë¡œ ëˆì€ ì•„ì§ ì•ˆë‚˜ê°”ìŠµë‹ˆë‹¤. 
            // ë”°ë¼ì„œ 'ë³´í†µì˜ˆê¸ˆ'ì´ ì•„ë‹ˆë¼ 'ë¯¸ì§€ê¸‰ê¸ˆ'ìœ¼ë¡œ ì¡ê³ , 10ì¼ì— ì´ì²´í•  ë•Œ (ì°¨)ë¯¸ì§€ê¸‰ê¸ˆ / (ëŒ€)ë³´í†µì˜ˆê¸ˆ ì²˜ë¦¬í•˜ëŠ”ê²Œ ì •ì„ì…ë‹ˆë‹¤.
            // ë§Œì•½ í¸ì˜ìƒ ì¦‰ì‹œ ì´ì²´ë¡œ ì²˜ë¦¬í•œë‹¤ë©´ 'ë³´í†µì˜ˆê¸ˆ'ìœ¼ë¡œ ìœ ì§€í•˜ì„¸ìš”. ì—¬ê¸°ì„  'ë¯¸ì§€ê¸‰ê¸ˆ'ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
            if(totalNet > 0) {
                entries.push({
                    Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ê¸ˆ', 
                    Description: `${desc} ì‹¤ì§€ê¸‰ì•¡ (10ì¼ ì§€ê¸‰ì˜ˆì •)`, 
                    Debit: 0, Credit: totalNet, 
                    Project: 'ë³¸ì‚¬', Operator: writer
                });
            }

            // === [B] íšŒì‚¬ ë¶€ë‹´ë¶„ ì²˜ë¦¬ (ì‹ ê·œ ê¸°ëŠ¥) ===
            if(totalCo > 0) {
                // (ì°¨) ì„¸ê¸ˆê³¼ê³µê³¼ (ë¹„ìš© ë°œìƒ)
                entries.push({
                    Date: fDate, Type: 'ë¹„ìš©', Account: 'ì„¸ê¸ˆê³¼ê³µê³¼', 
                    Description: `${desc} 4ëŒ€ë³´í—˜ íšŒì‚¬ë¶€ë‹´ë¶„`, 
                    Debit: totalCo, Credit: 0, 
                    Project: 'ë³¸ì‚¬', Operator: writer
                });

                // (ëŒ€) ë¯¸ì§€ê¸‰ë¹„ìš© (ë¶€ì±„ ì¦ê°€ - ë‚˜ì¤‘ì— ë‚¼ ëˆ)
                entries.push({
                    Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ë¹„ìš©', 
                    Description: `${desc} 4ëŒ€ë³´í—˜ íšŒì‚¬ë¶€ë‹´ë¶„`, 
                    Debit: 0, Credit: totalCo, 
                    Project: 'ë³¸ì‚¬', Operator: writer
                });
            }

            // 6. ì €ì¥ ì‹¤í–‰
            const { error: insertError } = await _supabase.from('ac_journal').insert(entries);
            if(insertError) return showAlert("ì˜¤ë¥˜", "ì „í‘œ ì €ì¥ ì‹¤íŒ¨: " + insertError.message);

            // 7. ìƒíƒœ ì—…ë°ì´íŠ¸
            await _supabase.from('hr_salary').update({ is_accounted: true }).in('id', salaryIds);

            showAlert("ì„±ê³µ", "ê¸‰ì—¬ ë° íšŒì‚¬ë¶€ë‹´ë¶„ ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); 
            refreshDashboard();
        });
    }
      
    // (2) ì „ìê²°ì¬ ì—°ë™
    else if (type === 'approval') {
        showConfirm("ì „ìê²°ì¬ ì—°ë™", "ì™„ë£Œëœ ì§€ì¶œê²°ì˜ì„œë¥¼ ì „í‘œë¡œ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
            const { data: approvals } = await _supabase.from('ac_approval').select('*').eq('status', 'ì™„ë£Œ').ilike('doc_type', '%ì§€ì¶œ%');
            if(!approvals || !approvals.length) return showAlert("ì•Œë¦¼", "ë¶ˆëŸ¬ì˜¬ ê²°ì¬ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            const appIds = approvals.map(a => String(a.id));
            const { data: existing } = await _supabase.from('ac_journal').select('RelatedID').in('RelatedID', appIds);
            const existingSet = new Set(existing ? existing.map(e => e.RelatedID) : []);
            const targetDocs = approvals.filter(a => !existingSet.has(String(a.id)));
            
            if(targetDocs.length === 0) return showAlert("ì•Œë¦¼", "ì´ë¯¸ ëª¨ë‘ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤.");

            let entries = [];
            targetDocs.forEach(doc => {
                const amt = Number(doc.amount);
                entries.push({Date: today, Type: 'ë¹„ìš©', Account: 'ë¯¸ë¶„ë¥˜ë¹„ìš©', Description: `[ì „ìê²°ì¬] ${doc.title}`, Debit: amt, Credit: 0, RelatedID: String(doc.id), Project: 'ë³¸ì‚¬', Operator: doc.drafter_name});
                entries.push({Date: today, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ê¸ˆ', Description: `[ì „ìê²°ì¬] ${doc.title}`, Debit: 0, Credit: amt, RelatedID: String(doc.id), Project: 'ë³¸ì‚¬', Operator: doc.drafter_name});
            });

            const { error } = await _supabase.from('ac_journal').insert(entries);
            if(!error) { showAlert("ì™„ë£Œ", `${targetDocs.length}ê±´ ì—°ë™ ì„±ê³µ`); refreshDashboard(); loadHistory(); }
        });
    }
// (3) ì¶œìê¸ˆ ì—°ë™
    else if (type === 'capital') {
        showConfirm("ì¶œìê¸ˆ ì—°ë™", "ì‹ ê·œ ì…ê¸ˆëœ ì¶œìê¸ˆì„ ì „í‘œë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>(ìƒíƒœê°€ 'ì™„ë£Œ'ì¸ í•­ëª©ë§Œ ì²˜ë¦¬)", async () => {
            // 1. ëŒ€ìƒ ì¡°íšŒ
            const { data: members, error: fetchError } = await _supabase.from('ref_members').select('*').eq('status', 'ì™„ë£Œ');
            
            if(fetchError) return showAlert("ì˜¤ë¥˜", "ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + fetchError.message);
            if(!members || members.length === 0) return showAlert("ì•Œë¦¼", "ì‹ ê·œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            let entries = [];
            let processedIds = [];
            
            // 2. ì „í‘œ ë°ì´í„° ìƒì„±
            members.forEach(m => {
                const amt = Number(m.amount);
                if(amt > 0) {
                    const desc = `[ì¶œì] ${m.depositor || m.member_id}`;
                    
                    // ì°¨ë³€ (ìì‚° ì¦ê°€)
                    entries.push({
                        Date: m.deposit_date || today, 
                        Type: 'ìì‚°', 
                        Account: 'ë³´í†µì˜ˆê¸ˆ', 
                        Description: desc, 
                        Debit: amt, 
                        Credit: 0, 
                        // RelatedID ì œê±°í•¨ (ë¶ˆí•„ìš”)
                        Project: 'ë³¸ì‚¬', 
                        Operator: writer
                    });
                    
                    // ëŒ€ë³€ (ìë³¸ ì¦ê°€)
                    entries.push({
                        Date: m.deposit_date || today, 
                        Type: 'ìë³¸', 
                        Account: 'ì¶œìê¸ˆ', 
                        Description: desc, 
                        Debit: 0, 
                        Credit: amt, 
                        // RelatedID ì œê±°í•¨ (ë¶ˆí•„ìš”)
                        Project: 'ë³¸ì‚¬', 
                        Operator: writer
                    });
                    
                    processedIds.push(m.id);
                }
            });

            if(entries.length > 0) {
                // 3. ì „í‘œ ì €ì¥ ì‹¤í–‰ (ì—ëŸ¬ ê²€ì¦ ì¶”ê°€)
                const { error: insertError } = await _supabase.from('ac_journal').insert(entries);
                
                // ì €ì¥ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
                if (insertError) {
                    console.error("ì „í‘œ ì €ì¥ ì‹¤íŒ¨:", insertError);
                    return showAlert("ì˜¤ë¥˜", "ì „í‘œ ì €ì¥ ì‹¤íŒ¨: " + insertError.message);
                }

                // 4. ì €ì¥ ì„±ê³µ ì‹œì—ë§Œ ìƒíƒœ ì—…ë°ì´íŠ¸ ('ì™„ë£Œ' -> 'ì „í‘œì™„ë£Œ'ë¡œ ë³€ê²½í•˜ì—¬ ì¤‘ë³µ ë°©ì§€)
                const { error: updateError } = await _supabase.from('ref_members').update({ status: 'ì „í‘œì™„ë£Œ' }).in('id', processedIds);
                
                if (updateError) {
                    return showAlert("ë¶€ë¶„ ì˜¤ë¥˜", "ì „í‘œëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒˆë¡œê³ ì¹¨ í›„ í™•ì¸ í•„ìš”)");
                }

                showAlert("ì„±ê³µ", `${processedIds.length}ê±´ ì—°ë™ ì™„ë£Œ`); 
                refreshDashboard();
            } else {
                showAlert("ì•Œë¦¼", "ì²˜ë¦¬í•  ìœ íš¨í•œ ê¸ˆì•¡ì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    }
      
    // (4) ë°°ë‹¹ê¸ˆ ì—°ë™
// (4) ë°°ë‹¹ê¸ˆ ì—°ë™
    else if (type === 'dividend') {
        showConfirm("ë°°ë‹¹ê¸ˆ ì—°ë™", "ë¯¸ì²˜ë¦¬ëœ ë°°ë‹¹ê¸ˆ ì§€ê¸‰ ë‚´ì—­ì„ ì „í‘œë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
            // 1. ë¯¸ì²˜ë¦¬ ë‚´ì—­ ì¡°íšŒ (is_accountedê°€ nullì´ê±°ë‚˜ falseì¸ ê²ƒ)
            const { data: divs, error } = await _supabase
                .from('ref_dividends')
                .select('*')
                .or('is_accounted.is.null,is_accounted.eq.false');

            if (error) return showAlert("ì˜¤ë¥˜", "ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
            if (!divs || divs.length === 0) return showAlert("ì•Œë¦¼", "ì²˜ë¦¬í•  ì‹ ê·œ ë°°ë‹¹ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");

            let entries = [];
            let processedIds = [];

            divs.forEach(d => {
                const amt = Number(d.amount);
                // ê¸ˆì•¡ì´ 0ë³´ë‹¤ í° ê²½ìš°ì—ë§Œ ì²˜ë¦¬
                if (amt > 0) {
                    const desc = `[ë°°ë‹¹] ${d.member_id} ì§€ê¸‰`; // ì ìš”
                    const pDate = d.payment_date || today;   // ì§€ê¸‰ì¼

                    // ë¶„ê°œ 1: (ì°¨ë³€) ì´ì›”ì´ìµì‰ì—¬ê¸ˆ - ìë³¸ ê°ì†Œ
                    entries.push({
                        Date: pDate,
                        Type: 'ìë³¸', 
                        Account: 'ì´ì›”ì´ìµì‰ì—¬ê¸ˆ', // ac_masterì— ì´ ê³„ì •ê³¼ëª©ì´ ìˆì–´ì•¼ í•¨
                        Description: desc,
                        Debit: amt,  // ìë³¸ì€ ëŒ€ë³€ì´ ì¦ê°€ì´ë¯€ë¡œ, ì°¨ë³€ì— ë„£ìœ¼ë©´ ê°ì†Œ íš¨ê³¼
                        Credit: 0,
                        RelatedID: `DIV-${d.id}`,
                        Project: d.project || 'ë³¸ì‚¬',
                        Operator: writer
                    });

                    // ë¶„ê°œ 2: (ëŒ€ë³€) ë³´í†µì˜ˆê¸ˆ - ìì‚° ê°ì†Œ
                    entries.push({
                        Date: pDate,
                        Type: 'ìì‚°',
                        Account: 'ë³´í†µì˜ˆê¸ˆ',
                        Description: desc,
                        Debit: 0,
                        Credit: amt,
                        RelatedID: `DIV-${d.id}`,
                        Project: d.project || 'ë³¸ì‚¬',
                        Operator: writer
                    });

                    processedIds.push(d.id);
                }
            });

            if (entries.length > 0) {
                // 2. ì „í‘œ ì¼ê´„ ì €ì¥
                const { error: insertError } = await _supabase.from('ac_journal').insert(entries);
                
                if (insertError) {
                    showAlert("ì˜¤ë¥˜", "ì „í‘œ ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + insertError.message);
                } else {
                    // 3. ë°°ë‹¹ê¸ˆ í…Œì´ë¸”ì— 'ì²˜ë¦¬ì™„ë£Œ' í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
                    await _supabase.from('ref_dividends').update({ is_accounted: true }).in('id', processedIds);
                    
                    showAlert("ì„±ê³µ", `${processedIds.length}ê±´ì˜ ë°°ë‹¹ê¸ˆ ë‚´ì—­ì„ ì „í‘œë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.`);
                    refreshDashboard();
                }
            }
        });
    }
    // (5) ê°ê°€ìƒê°
// (5) ê°ê°€ìƒê° ì‹¤í–‰
    else if (type === 'depreciation') {
        const thisYear = new Date().getFullYear();
        
        showConfirm("ê°ê°€ìƒê°", `${thisYear}ë…„ë„ ê°ê°€ìƒê°ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span class="text-danger small">* 1ë…„ì— í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ì„¸ìš”.</span>`, async () => {
            // 1. ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì²´í¬
            const descCheck = `[ê²°ì‚°] ${thisYear}ë…„ ê°ê°€ìƒê°`;
            const { data: dup } = await _supabase
                .from('ac_journal')
                .select('id')
                .ilike('Description', `${descCheck}%`)
                .limit(1);

            if (dup && dup.length > 0) return showAlert("ì¤‘ë³µ", `ì´ë¯¸ ${thisYear}ë…„ë„ ê°ê°€ìƒê°ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            // 2. ê³ ì •ìì‚° ëŒ€ì¥ ë¶ˆëŸ¬ì˜¤ê¸°
            const { data: assets, error } = await _supabase.from('ref_assets').select('*');
            if (error) return showAlert("ì˜¤ë¥˜", "ìì‚° ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
            if (!assets || assets.length === 0) return showAlert("ì•Œë¦¼", "ë“±ë¡ëœ ê³ ì •ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.");

            let entries = [];
            const dateStr = `${thisYear}-12-31`; // ê²°ì‚°ì¼

            assets.forEach(a => {
                const cost = Number(a.acquisition_cost); // ì·¨ë“ì›ê°€
                const life = Number(a.useful_life);      // ë‚´ìš©ì—°ìˆ˜ (ë…„)
                const buyDate = new Date(a.acquisition_date);
                const buyYear = buyDate.getFullYear();

                // ìœ íš¨ì„± ì²´í¬: ê¸ˆì•¡ê³¼ ìˆ˜ëª…ì´ ìˆê³ , ì·¨ë“ì¼ì´ ì˜¬í•´ ì´ì „ì´ê±°ë‚˜ ê°™ê³ , ìƒê° ê¸°ê°„ì´ ì•„ì§ ë‚¨ì•˜ì„ ë•Œ
                // (ì·¨ë“ë…„ë„ + ë‚´ìš©ì—°ìˆ˜)ê°€ í˜„ì¬ë…„ë„ë³´ë‹¤ ì»¤ì•¼ ì”ì¡´ ë‚´ìš©ì—°ìˆ˜ê°€ ìˆëŠ” ê²ƒì„
                if (cost > 0 && life > 0 && buyYear <= thisYear && (buyYear + life) > thisYear) {
                    
                    // 1ë…„ì¹˜ ê¸°ë³¸ ìƒê°ì•¡ (ì •ì•¡ë²•)
                    let yearDep = Math.floor(cost / life);

                    // â˜… ì˜¬í•´ ì·¨ë“í•œ ìì‚°ì´ë©´ ì›”í•  ê³„ì‚°
                    if (buyYear === thisYear) {
                        // getMonth()ëŠ” 0(1ì›”)~11(12ì›”)ì„ ë°˜í™˜í•¨
                        // ì˜ˆ: 1ì›” ì·¨ë“(0) -> 12ê°œì›” ì‚¬ìš© / 12ì›” ì·¨ë“(11) -> 1ê°œì›” ì‚¬ìš©
                        const monthsUsed = 12 - buyDate.getMonth();
                        yearDep = Math.floor(yearDep * (monthsUsed / 12));
                    }
                    
                    // 10ì› ë‹¨ìœ„ ì ˆì‚¬ (ì„ íƒì‚¬í•­, í•„ìš” ì—†ìœ¼ë©´ ì œê±° ê°€ëŠ¥)
                    yearDep = Math.floor(yearDep / 10) * 10;

                    if (yearDep > 0) {
                        const desc = `${descCheck} (${a.asset_name})`;
                        
                        // ë¶„ê°œ ìƒì„±
                        // (ì°¨) ê°ê°€ìƒê°ë¹„ XXX
                        entries.push({
                            Date: dateStr, 
                            Type: 'ë¹„ìš©', 
                            Account: 'ê°ê°€ìƒê°ë¹„', 
                            Description: desc, 
                            Debit: yearDep, 
                            Credit: 0, 
                            RelatedID: `DEP-${a.asset_code}`, 
                            Project: a.project || 'ë³¸ì‚¬', 
                            Operator: writer
                        });
                        
                        // (ëŒ€) ê°ê°€ìƒê°ëˆ„ê³„ì•¡ XXX
                        entries.push({
                            Date: dateStr, 
                            Type: 'ìì‚°', 
                            Account: 'ê°ê°€ìƒê°ëˆ„ê³„ì•¡', 
                            Description: desc, 
                            Debit: 0, 
                            Credit: yearDep, 
                            RelatedID: `DEP-${a.asset_code}`, 
                            Project: a.project || 'ë³¸ì‚¬', 
                            Operator: writer
                        });
                    }
                }
            });

            if (entries.length > 0) {
                const { error: insertError } = await _supabase.from('ac_journal').insert(entries);
                if (insertError) {
                    showAlert("ì˜¤ë¥˜", "ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + insertError.message);
                } else {
                    showAlert("ì„±ê³µ", `${entries.length / 2}ê±´ì˜ ìì‚°ì— ëŒ€í•´ ê°ê°€ìƒê° ì²˜ë¦¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.`);
                    refreshDashboard();
                }
            } else {
                showAlert("ì•Œë¦¼", "ì˜¬í•´ ìƒê° ëŒ€ìƒ ìì‚°ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ë‚´ìš©ì—°ìˆ˜ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
    // (6) ì—°ë§ê²°ì‚°
// (6) ì—°ë§ê²°ì‚° (ì†ìµë§ˆê°)
    else if (type === 'closing') {
        const thisYear = new Date().getFullYear();
        
        showConfirm("ì—°ë§ê²°ì‚°", `${thisYear}ë…„ë„ ì†ìµì„ ë§ˆê°í•˜ê³  ìˆœì´ìµì„ ìë³¸ìœ¼ë¡œ ëŒ€ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span class="text-danger small fw-bold">* ì£¼ì˜: ëª¨ë“  ì „í‘œ ì…ë ¥ì´ ëë‚œ í›„ 1íšŒë§Œ ì‹¤í–‰í•˜ì„¸ìš”.</span>`, async () => {
            const closingTag = `[ê²°ì‚°] ${thisYear}ë…„ ì†ìµë§ˆê°`;
            const startDate = `${thisYear}-01-01`;
            const endDate = `${thisYear}-12-31`;
            const relatedKey = `CLOSE-${thisYear}`; // ì¤‘ë³µ ë°©ì§€ìš© í‚¤

            // 1. ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            const { data: dup } = await _supabase.from('ac_journal')
                .select('id')
                .eq('RelatedID', relatedKey)
                .limit(1);

            if (dup && dup.length > 0) return showAlert("ì¤‘ë³µ", `ì´ë¯¸ ${thisYear}ë…„ë„ ê²°ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);

            // 2. ì˜¬í•´ì˜ ë§¤ì¶œ/ë¹„ìš© ë‚´ì—­ ì „ì²´ ì¡°íšŒ
            const { data: journals, error } = await _supabase.from('ac_journal')
                .select('Type, Account, Debit, Credit')
                .gte('Date', startDate)
                .lte('Date', endDate)
                .in('Type', ['ë§¤ì¶œ', 'ë¹„ìš©']); // ìì‚°, ë¶€ì±„, ìë³¸ì€ ë§ˆê° ëŒ€ìƒ ì•„ë‹˜

            if (error) return showAlert("ì˜¤ë¥˜", "ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
            if (!journals || journals.length === 0) return showAlert("ì•Œë¦¼", "ë§ˆê°í•  ë§¤ì¶œ/ë¹„ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");

            // 3. ê³„ì •ë³„ ì”ì•¡ ì§‘ê³„
            let balances = {};
            journals.forEach(j => {
                const acc = j.Account;
                // ì´ˆê¸°í™”
                if (!balances[acc]) balances[acc] = { type: j.Type, amount: 0 };
                
                // ì°¨ë³€(Debit) - ëŒ€ë³€(Credit)ìœ¼ë¡œ ì”ì•¡ ê³„ì‚°
                // ë¹„ìš©ì€ ì–‘ìˆ˜(+), ë§¤ì¶œì€ ìŒìˆ˜(-)ë¡œ ì§‘ê³„ë¨
                const db = Number(j.Debit || 0);
                const cr = Number(j.Credit || 0);
                balances[acc].amount += (db - cr);
            });

            // 4. ë§ˆê° ë¶„ê°œ ìƒì„±
            let entries = [];
            const dateStr = `${thisYear}-12-31`;
            let netIncomeCheck = 0; // ë‹¹ê¸°ìˆœì´ìµ ê²€ì¦ìš©

            for (const [acc, info] of Object.entries(balances)) {
                const netAmt = info.amount; 
                if (netAmt === 0) continue; // ì”ì•¡ 0ì´ë©´ íŒ¨ìŠ¤

                // [ë¹„ìš© ë§ˆê°]: ì°¨ë³€ ì”ì•¡(ì–‘ìˆ˜)ì„ ëŒ€ë³€ìœ¼ë¡œ ë³´ë‚´ 0ìœ¼ë¡œ ë§Œë“¦
                if (info.type === 'ë¹„ìš©') {
                    // (ì°¨ë³€) ì´ì›”ì´ìµì‰ì—¬ê¸ˆ / (ëŒ€ë³€) í•´ë‹¹ ë¹„ìš©
                    entries.push({
                        Date: dateStr, Type: 'ìë³¸', Account: 'ì´ì›”ì´ìµì‰ì—¬ê¸ˆ',
                        Description: `${closingTag} (${acc})`,
                        Debit: netAmt, Credit: 0, // ìë³¸ ê°ì†Œ (ë¹„ìš©ë§Œí¼ ì´ìµ ì°¨ê°)
                        RelatedID: relatedKey, Project: 'ë³¸ì‚¬', Operator: writer
                    });
                    entries.push({
                        Date: dateStr, Type: 'ë¹„ìš©', Account: acc,
                        Description: `${closingTag}`,
                        Debit: 0, Credit: netAmt, // ë¹„ìš© ëŒ€ë³€ ê¸°ì… -> ì”ì•¡ 0ì›ë¨
                        RelatedID: relatedKey, Project: 'ë³¸ì‚¬', Operator: writer
                    });
                    netIncomeCheck -= netAmt;
                }
                // [ë§¤ì¶œ ë§ˆê°]: ëŒ€ë³€ ì”ì•¡(ìŒìˆ˜)ì„ ì°¨ë³€ìœ¼ë¡œ ë³´ë‚´ 0ìœ¼ë¡œ ë§Œë“¦
                else if (info.type === 'ë§¤ì¶œ') {
                    const absAmt = Math.abs(netAmt); // ìŒìˆ˜ë¥¼ ì–‘ìˆ˜ë¡œ ë³€í™˜
                    // (ì°¨ë³€) í•´ë‹¹ ë§¤ì¶œ / (ëŒ€ë³€) ì´ì›”ì´ìµì‰ì—¬ê¸ˆ
                    entries.push({
                        Date: dateStr, Type: 'ë§¤ì¶œ', Account: acc,
                        Description: `${closingTag}`,
                        Debit: absAmt, Credit: 0, // ë§¤ì¶œ ì°¨ë³€ ê¸°ì… -> ì”ì•¡ 0ì›ë¨
                        RelatedID: relatedKey, Project: 'ë³¸ì‚¬', Operator: writer
                    });
                    entries.push({
                        Date: dateStr, Type: 'ìë³¸', Account: 'ì´ì›”ì´ìµì‰ì—¬ê¸ˆ',
                        Description: `${closingTag} (${acc})`,
                        Debit: 0, Credit: absAmt, // ìë³¸ ì¦ê°€ (ë§¤ì¶œë§Œí¼ ì´ìµ ì¦ê°€)
                        RelatedID: relatedKey, Project: 'ë³¸ì‚¬', Operator: writer
                    });
                    netIncomeCheck += absAmt;
                }
            }

            if (entries.length > 0) {
                const { error: insertError } = await _supabase.from('ac_journal').insert(entries);
                if (insertError) {
                    showAlert("ì˜¤ë¥˜", "ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + insertError.message);
                } else {
                    const incomeStr = netIncomeCheck >= 0 ? 
                        `ë‹¹ê¸°ìˆœì´ìµ ${netIncomeCheck.toLocaleString()}ì›` : 
                        `ë‹¹ê¸°ìˆœì†ì‹¤ ${Math.abs(netIncomeCheck).toLocaleString()}ì›`;
                    
                    showAlert("ì„±ê³µ", `${thisYear}ë…„ë„ ë§ˆê°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>${incomeStr}ì´ ìë³¸ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    refreshDashboard();
                }
            } else {
                showAlert("ì•Œë¦¼", "ì²˜ë¦¬í•  ì”ì•¡ì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    }
// (7) ì—°ë§ê²°ì‚° ì·¨ì†Œ (ë˜ëŒë¦¬ê¸°)
    else if (type === 'undo_closing') {
        const thisYear = new Date().getFullYear();
        const relatedKey = `CLOSE-${thisYear}`;

        showConfirm("ê²°ì‚° ì·¨ì†Œ", `<span class="text-danger fw-bold">âš ï¸ ${thisYear}ë…„ë„ ê²°ì‚° ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span><br>ë§ˆê° ë¶„ê°œê°€ ëª¨ë‘ ì‚­ì œë˜ê³  ì†ìµì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`, async () => {
            
            // 1. í•´ë‹¹ ì—°ë„ì˜ ê²°ì‚° ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            const { count } = await _supabase
                .from('ac_journal')
                .select('*', { count: 'exact', head: true })
                .eq('RelatedID', relatedKey);

            if (!count || count === 0) return showAlert("ì•Œë¦¼", `${thisYear}ë…„ë„ ê²°ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.`);

            // 2. ì‚­ì œ ì‹¤í–‰
            const { error } = await _supabase
                .from('ac_journal')
                .delete()
                .eq('RelatedID', relatedKey);

            if (error) {
                showAlert("ì˜¤ë¥˜", "ì·¨ì†Œ ì‹¤íŒ¨: " + error.message);
            } else {
                showAlert("ì™„ë£Œ", `${thisYear}ë…„ë„ ê²°ì‚°ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>ìˆ˜ì • í›„ ë‹¤ì‹œ ê²°ì‚°ì„ ì§„í–‰í•˜ì„¸ìš”.`);
                refreshDashboard();
            }
        });
    }
}

function loadHistory() {
    const el = document.getElementById("historyList");
    el.innerHTML = "ë¡œë”© ì¤‘...";
    _supabase.from('ac_journal').select('*').order('Date', {ascending:false}).limit(10).then(({data}) => {
        el.innerHTML = "";
        if(data) data.forEach(item => {
            const amt = Number(item.Debit||0) + Number(item.Credit||0);
            el.innerHTML += `<div class="list-group-item d-flex justify-content-between"><div><span class="badge bg-secondary me-1">${item.Type}</span><b>${item.Account}</b> <small>${item.Description}</small></div><div class="fw-bold">${amt.toLocaleString()} <span class="text-danger cursor-pointer" onclick="deleteTx('${item.id}')">Ã—</span></div></div>`;
        });
    });
}

async function deleteTx(id) {
    showConfirm("ì‚­ì œ í™•ì¸", "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async function() {
        await _supabase.from('ac_journal').delete().eq('id', id);
        loadHistory(); refreshDashboard();
    });
}

function openAddModal() {
    document.getElementById("addTypeSelect").value = document.querySelector('input[name="inputType"]:checked').value;
    const type = document.getElementById("addTypeSelect").value;
    const catSel = document.getElementById("addCategorySelect");
    catSel.innerHTML = "";
    const cats = [...new Set(mData.filter(m => m.Type === type).map(m => m.Standard))].sort();
    cats.forEach(c => catSel.add(new Option(c, c)));
    addModal.show();
}

function toggleManualCat() {
    const chk = document.getElementById("chkManualCat").checked;
    document.getElementById("addCategorySelect").classList.toggle("hidden", chk);
    document.getElementById("manualCatInput").classList.toggle("hidden", !chk);
}

// [ìˆ˜ì •] ë‹¤ì¤‘ ì†ì„± ì²˜ë¦¬ê°€ í¬í•¨ëœ í•­ëª© ì¶”ê°€ í•¨ìˆ˜
async function confAdd() {
    const type = document.getElementById("addTypeSelect").value;
    const name = document.getElementById("addNewItemName").value;
    
    // ì¤‘ë¶„ë¥˜ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    let cat = document.getElementById("addCategorySelect").value;
    if(document.getElementById("chkManualCat").checked) cat = document.getElementById("manualCatInput").value;
    
    const usage = document.getElementById("addUsageSelect").value;

    if(!name || !cat) return showAlert("ì•Œë¦¼", "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

    // [ë³€ê²½ í•µì‹¬] ë‹¤ì¤‘ ì†ì„± ê°’ ìˆ˜ì§‘
    // 1. ì²´í¬ëœ ëª¨ë“  í•­ëª©ì˜ valueë¥¼ ë°°ì—´ë¡œ ê°€ì ¸ì˜´
    const checkedEls = document.querySelectorAll('.check-attr:checked');
    const attrValues = Array.from(checkedEls).map(el => el.value);

    // 2. DB ì €ì¥ ë°ì´í„° ë§¤í•‘
    // (1) SpecialType: ì„ íƒëœ ê°’ë“¤ì„ ì‰¼í‘œ(,)ë¡œ ì—°ê²° (ì˜ˆ: "tax_free,labor_3.3")
    const specialTypeVal = attrValues.join(',');
    
    // (2) Tax_Free: 'tax_free' ê°’ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ TRUE, ì•„ë‹ˆë©´ FALSE
    const isTaxFree = attrValues.includes('tax_free') ? "TRUE" : "FALSE";

    // DB Insert
    // SpecialType ì¹¼ëŸ¼ ì¶”ê°€ë¨
    const { error } = await _supabase.from('ac_master').insert({
        Type: type, 
        Standard: cat, 
        Item: name, 
        Usage: usage, 
        tax_free: isTaxFree,         
        special_code: specialTypeVal 
    });

    if (error) {
        showAlert("ì˜¤ë¥˜", "ì €ì¥ ì‹¤íŒ¨: " + error.message);
    } else {
        showAlert("ì„±ê³µ", "ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        addModal.hide(); 
        loadMasterData();
    }
}

// ì •ë³´ ëª¨ë‹¬
async function openInfoModal() {
    const { data } = await _supabase.from('ref_company_info').select('*');
    const map = {}; if(data) data.forEach(i=>map[i.key]=i.value);
    document.getElementById("orgName").value = map['orgName']||"";
    document.getElementById("ceoName").value = map['ceoName']||""; 
    document.getElementById("bizNum").value = map['bizNum']||"";   
    document.getElementById("estDate").value = map['estDate']||"";
    const { data: cap } = await _supabase.from('ac_journal').select('*').eq('Account','ì¶œìê¸ˆ');
    let totalCap=0; if(cap) cap.forEach(c=>totalCap+=c.Credit);
    document.getElementById("totalCap").value = totalCap.toLocaleString();
    infoModal.show();
}

async function printReport() {
    const selYear = Number(document.getElementById("reportYearSelect").value);
    const currYear = new Date().getFullYear();
    const todayStr = new Date().toISOString().slice(0, 10);
    const startDate = `${selYear}-01-01`;
    const endDate = (selYear === currYear) ? todayStr : `${selYear}-12-31`;
    let rangeText = (selYear === currYear) ? `${startDate} ~ ${endDate} (ê°€ê²°ì‚°)` : `${startDate} ~ ${endDate} (í™•ì •)`;

    const { data } = await _supabase.from('ac_journal').select('*').gte('Date', startDate).lte('Date', endDate);
    const { data: infoData } = await _supabase.from('ref_company_info').select('*');
    const info = {}; if(infoData) infoData.forEach(i=>info[i.key]=i.value);
    const { count } = await _supabase.from('ref_members').select('*', { count: 'exact', head: true });
    const memberCount = count || 0;

    let asset={}, liab={}, equity={}, rev={}, exp={};
    let tAsset=0, tLiab=0, tEquity=0, tRev=0, tExp=0;
    let capital = 0; 

    data.forEach(r => {
        const debit = Number(r.Debit||0), credit = Number(r.Credit||0);
        const valDr = debit - credit;
        const valCr = credit - debit;
        if(r.Type==='ìì‚°') { asset[r.Account]=(asset[r.Account]||0)+valDr; tAsset+=valDr; }
        else if(r.Type==='ë¶€ì±„') { liab[r.Account]=(liab[r.Account]||0)+valCr; tLiab+=valCr; }
        else if(r.Type==='ìë³¸') { equity[r.Account]=(equity[r.Account]||0)+valCr; tEquity+=valCr; if(r.Account==='ì¶œìê¸ˆ') capital+=valCr; }
        else if(r.Type==='ë§¤ì¶œ') { rev[r.Account]=(rev[r.Account]||0)+valCr; tRev+=valCr; }
        else if(r.Type==='ë¹„ìš©') { exp[r.Account]=(exp[r.Account]||0)+valDr; tExp+=valDr; }
    });

    const netIncome = tRev - tExp;
    const totalLiabEquity = tLiab + tEquity + netIncome;

    const headerHtml = `<div class="rpt-title">ì¬ë¬´ì œí‘œ</div><table class="rpt-header-tbl"><tr><th>íšŒì‚¬ëª…</th><td>${info.orgName||''}</td><th>ì‚¬ì—…ìë²ˆí˜¸</th><td>${info.bizNum||''}</td></tr><tr><th>íšŒê³„ê¸°ê°„</th><td>${rangeText}</td><th>ëŒ€í‘œì</th><td>${info.ceoName||''}</td></tr><tr><th>ì¶œìê¸ˆ</th><td>${capital.toLocaleString()}ì›</td><th>ì¡°í•©ì›ìˆ˜</th><td>${memberCount}ëª…</td></tr></table>`;
    
    const bsHtml = `<div class="rpt-sec">1. ëŒ€ì°¨ëŒ€ì¡°í‘œ (Balance Sheet)</div><div style="text-align:right; font-size:11px;">(ë‹¨ìœ„: ì›)</div><table class="rpt-tbl"><colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup><tr><th colspan="2">ì ì‚°</th><th colspan="2">ë¶€ì±„ ë° ìë³¸</th></tr><tr style="vertical-align:top;"><td colspan="2"><div style="font-weight:bold; margin-bottom:5px;">[ìœ ë™ìì‚°]</div>${Object.keys(asset).map(k=>`<div class="d-flex justify-content-between"><span>${k}</span><span>${asset[k].toLocaleString()}</span></div>`).join('')}<div class="d-flex justify-content-between border-top mt-2 pt-2 fw-bold bg-light"><span>ìì‚°ì´ê³„</span><span>${tAsset.toLocaleString()}</span></div></td><td colspan="2"><div style="font-weight:bold; margin-bottom:5px;">[ë¶€ì±„]</div>${Object.keys(liab).map(k=>`<div class="d-flex justify-content-between"><span>${k}</span><span>${liab[k].toLocaleString()}</span></div>`).join('')}<div class="fw-bold mt-3 mb-1 text-end border-top">ë¶€ì±„ì´ê³„: ${tLiab.toLocaleString()}</div><div style="font-weight:bold; margin-top:10px; margin-bottom:5px;">[ìë³¸]</div>${Object.keys(equity).map(k=>`<div class="d-flex justify-content-between"><span>${k}</span><span>${equity[k].toLocaleString()}</span></div>`).join('')}<div class="d-flex justify-content-between text-primary"><span>(ë‹¹ê¸°ìˆœì´ìµ)</span><span>${netIncome.toLocaleString()}</span></div><div class="d-flex justify-content-between border-top mt-2 pt-2 fw-bold bg-light"><span>ë¶€ì±„/ìë³¸ ì´ê³„</span><span>${totalLiabEquity.toLocaleString()}</span></div></td></tr></table>`;

    const plHtml = `<div class="page-break"></div><div class="rpt-sec mt-4">2. ì†ìµê³„ì‚°ì„œ (Income Statement)</div><div style="text-align:right; font-size:11px;">(ë‹¨ìœ„: ì›)</div><table class="rpt-tbl"><tr><th>ê³„ì •ê³¼ëª©</th><th>ì½”ë“œ</th><th>ê¸ˆì•¡</th></tr><tr class="bg-light"><td class="fw-bold">I. ë§¤ì¶œì•¡</td><td></td><td class="rpt-amt fw-bold">${tRev.toLocaleString()}</td></tr>${Object.keys(rev).map(k=>`<tr><td class="rpt-indent">${k}</td><td class="text-center text-muted text-small">-</td><td class="rpt-amt">${rev[k].toLocaleString()}</td></tr>`).join('')}<tr class="bg-light"><td class="fw-bold">II. ë§¤ì¶œì´ì´ìµ</td><td></td><td class="rpt-amt fw-bold">${tRev.toLocaleString()}</td></tr><tr class="bg-light"><td class="fw-bold">III. íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„</td><td></td><td class="rpt-amt fw-bold">${tExp.toLocaleString()}</td></tr>${Object.keys(exp).map(k=>`<tr><td class="rpt-indent">${k}</td><td class="text-center text-muted text-small">-</td><td class="rpt-amt">${exp[k].toLocaleString()}</td></tr>`).join('')}<tr class="bg-light" style="border-top:2px solid #000;"><td class="fw-bold">IV. ì˜ì—…ì´ìµ(ì†ì‹¤)</td><td></td><td class="rpt-amt fw-bold">${netIncome.toLocaleString()}</td></tr><tr style="background:#fff3cd; border-top:2px solid #000;"><td class="fw-bold text-center">V. ë‹¹ê¸°ìˆœì´ìµ</td><td></td><td class="rpt-amt fw-bold text-danger" style="font-size:1.2em;">${netIncome.toLocaleString()}</td></tr></table>`;

    document.getElementById("reportContent").innerHTML = headerHtml + bsHtml + plHtml;
    reportModal.show();
}

function realPrint() {
    const w = window.open();
    w.document.write(`<html><head><title>ê²°ì‚°ë³´ê³ ì„œ</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><style>body{padding:40px; font-family:'Malgun Gothic', serif;} .rpt-title{text-align:center; font-size:28px; font-weight:bold; margin-bottom:30px; text-decoration:underline;} .rpt-header-tbl{width:100%; border:2px solid #000; border-collapse:collapse; margin-bottom:30px;} .rpt-header-tbl th{background:#eee; padding:8px; border:1px solid #000; text-align:center; width:15%; font-weight:bold;} .rpt-header-tbl td{padding:8px; border:1px solid #000;} .rpt-sec{font-size:18px; font-weight:bold; margin:20px 0 10px 0; border-bottom:2px solid #555; padding-bottom:5px;} .rpt-tbl{width:100%; border-collapse:collapse; margin-bottom:20px; border:2px solid #000;} .rpt-tbl th, .rpt-tbl td{border:1px solid #000; padding:8px; font-size:14px;} .rpt-tbl th{background:#f8f9fa; text-align:center;} .rpt-amt{text-align:right; font-family:'Consolas', monospace;} .rpt-indent{padding-left:20px !important;} @media print{ .page-break{page-break-before:always;} .bg-light{background-color:#f8f9fa !important; -webkit-print-color-adjust:exact;} }</style></head><body>${document.getElementById("reportContent").innerHTML}</body></html>`);
    w.document.close();
    setTimeout(() => { w.focus(); w.print(); w.close(); }, 500);
}
  // [ì‹ ê·œ] ê¸‰ì—¬ëŒ€ì¥ì—ì„œ 4ëŒ€ë³´í—˜ ê³µì œì•¡(ì§ì›ë¶€ë‹´ë¶„) í•©ê³„ ê°€ì ¸ì˜¤ê¸°
async function fetchInsuranceShare() {
    const ym = document.getElementById("insMonth").value;
    if(!ym) return showAlert("ì•Œë¦¼", "ê·€ì†ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");

    // hr_salary í…Œì´ë¸”ì—ì„œ 4ëŒ€ë³´í—˜ ê´€ë ¨ ê³µì œ í•­ëª©ë§Œ ì¡°íšŒ (ì†Œë“ì„¸, ì§€ë°©ì„¸ ì œì™¸)
    const { data, error } = await _supabase.from('hr_salary')
        .select('ded_pension, ded_health, ded_care, ded_employ')
        .eq('year_month', ym);

    if (error) return showAlert("ì˜¤ë¥˜", "ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
    if (!data || data.length === 0) return showAlert("ì•Œë¦¼", `${ym}ì›” ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);

    let totalShare = 0;
    data.forEach(row => {
        // null ê°’ ë°©ì§€ë¥¼ ìœ„í•´ Number()ì™€ || 0 ì²˜ë¦¬
        totalShare += Number(row.ded_pension || 0); // êµ­ë¯¼ì—°ê¸ˆ
        totalShare += Number(row.ded_health || 0);  // ê±´ê°•ë³´í—˜
        totalShare += Number(row.ded_care || 0);    // ìš”ì–‘ë³´í—˜
        totalShare += Number(row.ded_employ || 0);  // ê³ ìš©ë³´í—˜
    });

    // ì…ë ¥ì°½ì— ê°’ ì ìš©
    const inputEl = document.getElementById("workerShare");
    inputEl.value = totalShare;
    
    // ì•Œë¦¼ ë©”ì‹œì§€ (ì„ íƒ ì‚¬í•­)
    showAlert("ì™„ë£Œ", `${ym}ì›” ê¸‰ì—¬ëŒ€ì¥ì—ì„œ ì§ì›ë¶€ë‹´ë¶„ í•©ê³„ ${totalShare.toLocaleString()}ì›ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.<br>ì‹¤ì œ ê³ ì§€ì„œ ê¸ˆì•¡ê³¼ ë‹¤ë¥´ë‹¤ë©´ ìˆ˜ì •í•´ì£¼ì„¸ìš”.`);
}

  // [ì‹ ê·œ] 4ëŒ€ë³´í—˜ ë‚©ë¶€ ì‹œ ì¥ë¶€ìƒ ë¶€ì±„(ì§ì›ë¶„+íšŒì‚¬ë¶„) ì¡°íšŒ í•¨ìˆ˜
async function fetchLiabilitySum() {
    const ym = document.getElementById("payTargetMonth").value;
    if(!ym) return showAlert("ì•Œë¦¼", "ê·€ì†ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");

    // hr_salaryì—ì„œ í•´ë‹¹ ì›”ì˜ [ì§ì›ê³µì œì´ì•¡]ê³¼ [íšŒì‚¬ë¶€ë‹´ì´ì•¡] ì¡°íšŒ
    const { data, error } = await _supabase.from('hr_salary')
        .select('ded_total, co_total')
        .eq('year_month', ym);
    
    if(error) return showAlert("ì˜¤ë¥˜", "ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
    if(!data || data.length === 0) return showAlert("ì•Œë¦¼", `${ym}ì›” ê¸‰ì—¬ëŒ€ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸‰ì—¬ ì—°ë™ì„ ë¨¼ì € ì§„í–‰í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`);

    let totalYesu = 0;      // ì˜ˆìˆ˜ê¸ˆ (ì§ì›ë¶€ë‹´ë¶„)
    let totalMigigeub = 0;  // ë¯¸ì§€ê¸‰ë¹„ìš© (íšŒì‚¬ë¶€ë‹´ë¶„)

    data.forEach(row => {
        totalYesu += Number(row.ded_total || 0);
        totalMigigeub += Number(row.co_total || 0);
    });

    const totalBook = totalYesu + totalMigigeub;

    if (totalBook === 0) return showAlert("ì•Œë¦¼", "ì¡°íšŒëœ ë¯¸ë‚© ë‚´ì—­ì´ 0ì›ì…ë‹ˆë‹¤.");

    // í™”ë©´ í‘œì‹œ
    document.getElementById("txtBookVal").innerText = totalBook.toLocaleString() + "ì›";
    document.getElementById("txtDetailVal").innerText = `(ì˜ˆìˆ˜ê¸ˆ: ${totalYesu.toLocaleString()} + ë¯¸ì§€ê¸‰ë¹„ìš©: ${totalMigigeub.toLocaleString()})`;
    
    // ìˆ¨ê²¨ì§„ í•„ë“œì— ê°’ ì €ì¥ (ì €ì¥ ì‹œ ì‚¬ìš©)
    document.getElementById("hiddenBookVal").value = totalBook;
    document.getElementById("hiddenYesu").value = totalYesu;
    document.getElementById("hiddenMigigeub").value = totalMigigeub;

    // í¸ì˜ìƒ ì…ë ¥ì°½ì— ì¥ë¶€ê¸ˆì•¡ì„ ë„£ì–´ì¤Œ (ì‚¬ìš©ìê°€ ê³ ì§€ì„œ ê¸ˆì•¡ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥)
    document.getElementById("inputAmount").value = totalBook;

    showAlert("ì¡°íšŒ ì„±ê³µ", "ì¥ë¶€ìƒ ê¸ˆì•¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.<br>ì‹¤ì œ ê³ ì§€ì„œ ê¸ˆì•¡ê³¼ ë‹¤ë¥´ë‹¤ë©´ 'ê¸ˆì•¡' ë€ì„ ìˆ˜ì •í•˜ì„¸ìš”.");
}
</script>
</body>
</html>
