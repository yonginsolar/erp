<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>íšŒê³„ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; }
    .main-container { max-width: 650px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 25px; }
    
    .stat-card { flex: 1; padding: 15px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .bg-rev { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .bg-exp { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .bg-ast { background: linear-gradient(135deg, #3498db, #2980b9); }
    
    .sub-card { flex: 1; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #eee; background-color: #fff; }
    .text-vat { color: #d63384; font-weight: bold; } 
    .text-cash { color: #0d6efd; font-weight: bold; }
    
    .btn-report { width: 100%; font-weight: bold; border-radius: 10px; }
    .readonly-input { background-color: #f8f9fa; cursor: pointer; }
    
    /* ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
    #reportContent { font-family: "Malgun Gothic", serif; font-size: 12px; }
    .rpt-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; text-decoration: underline; }
    .rpt-header-tbl { width: 100%; border: 2px solid #000; margin-bottom: 20px; }
    .rpt-header-tbl th { background: #f1f3f5; padding: 5px; border: 1px solid #000; text-align: center; width: 15%; }
    .rpt-header-tbl td { padding: 5px; border: 1px solid #000; }
    
    .rpt-tbl { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #000; }
    .rpt-tbl th, .rpt-tbl td { border: 1px solid #000; padding: 6px 8px; }
    .rpt-tbl th { background: #f8f9fa; text-align: center; font-weight: bold; }
    .rpt-amt { text-align: right; font-family: 'Consolas', monospace; }
    .rpt-indent { padding-left: 20px !important; }
    
    /* ì¸ì‡„ ì„¤ì • */
    @media print {
        .page-break { page-break-before: always; }
        .no-print { display: none !important; }
        body { background: white; padding: 0; }
        .main-container { box-shadow: none; border: none; max-width: 100%; padding: 0; }
    }
    
    .search-list-item:hover { background-color: #e9ecef; cursor: pointer; }
    .acc-item-name { font-size: 1.1rem; font-weight: bold; color: #333; }
    .acc-item-std { font-size: 0.85rem; color: #888; }
    
    .hidden { display: none !important; }
    .ime-kr { ime-mode: active; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <h4 class="fw-bold m-0">ğŸ“’ íšŒê³„ ê´€ë¦¬</h4>
    <div>
      <button class="btn btn-outline-secondary btn-sm me-1" onclick="openInfoModal()">âš™ï¸ ì„¤ì •</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2 no-print">
    <div class="stat-card bg-rev"><div>ë§¤ì¶œ</div><div class="fw-bold" id="valRev">0</div></div>
    <div class="stat-card bg-exp"><div>ë¹„ìš©</div><div class="fw-bold" id="valExp">0</div></div>
    <div class="stat-card bg-ast"><div>ìì‚°</div><div class="fw-bold" id="valAst">0</div></div>
  </div>
  <div class="d-flex gap-2 mb-4 no-print">
    <div class="sub-card">
        <div>ğŸ’° í†µì¥ ì”ê³  (ë³´í†µì˜ˆê¸ˆ)</div>
        <div class="text-cash fs-5" id="valCash">0</div>
    </div>
    <div class="sub-card">
        <div>ğŸ§¾ ë¶€ê°€ì„¸ ë‚©ë¶€ì˜ˆìƒ</div>
        <div class="text-vat fs-5" id="valVat">0</div>
    </div>
  </div>

  <div class="input-group mb-4 no-print shadow-sm">
      <select class="form-select" id="reportYearSelect" style="max-width: 120px; font-weight:bold;">
          </select>
      <button class="btn btn-outline-dark btn-report flex-fill" type="button" onclick="printReport()">
          ğŸ–¨ï¸ ê²°ì‚° ë³´ê³ ì„œ ìƒì„±
      </button>
  </div>

  <ul class="nav nav-tabs mb-4 no-print" id="accTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabForm">ğŸ“ ì „í‘œì…ë ¥</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSync">ğŸ”„ ìë™ì—°ë™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistory" onclick="loadHistory()">ğŸ•’ ìµœê·¼ì „í‘œ</button></li>
  </ul>

  <div class="tab-content no-print">
    <div class="tab-pane fade show active" id="tabForm">
      <form id="erpForm" onsubmit="handleFormSubmit(event)">
        <div class="row mb-3">
          <div class="col-6"><label class="small text-muted">ë‚ ì§œ</label><input type="date" class="form-control" id="dateField" required></div>
          <div class="col-6">
            <label class="small text-muted">í”„ë¡œì íŠ¸</label>
            <select class="form-select" id="projectSelect">
              <option value="ë³¸ì‚¬">ë³¸ì‚¬</option><option value="1í˜¸ê¸°">1í˜¸ê¸°</option><option value="2í˜¸ê¸°">2í˜¸ê¸°</option>
            </select>
          </div>
        </div>

        <div class="mb-3 p-2 border rounded bg-light">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="small text-muted fw-bold">ê±°ë˜ êµ¬ë¶„</label>
            <span class="badge bg-secondary" id="modeBadge">ì¼ë°˜</span>
          </div>
          <div class="d-flex gap-2">
             <input type="radio" class="btn-check" name="settleMode" id="smNorm" value="" checked onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-secondary flex-fill" for="smNorm">ì¼ë°˜ê±°ë˜</label>
             <input type="radio" class="btn-check" name="settleMode" id="smPre" value="pre_expense" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-primary flex-fill" for="smPre">ì„¤ë¦½ì „/ê°œì¸</label>
             <input type="radio" class="btn-check" name="settleMode" id="smReim" value="reimburse" onchange="toggleSettleMode()">
             <label class="btn btn-sm btn-outline-danger flex-fill" for="smReim">ì •ì‚°ì§€ê¸‰</label>
          </div>
          <div id="payerInputDiv" class="mt-2 hidden">
            <div class="input-group input-group-sm">
              <span class="input-group-text fw-bold" id="payerLabel">ì´ë¦„</span>
              <input type="text" class="form-control ime-kr" id="payerName" placeholder="ì§€ì¶œì ë˜ëŠ” ë°›ëŠ” ë¶„">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="small text-muted">ê³„ì • ìœ í˜•</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="inputType" id="t1" value="ë§¤ì¶œ" onchange="resetAccountInput()"><label class="btn btn-outline-success" for="t1">ë§¤ì¶œ</label>
            <input type="radio" class="btn-check" name="inputType" id="t2" value="ë¹„ìš©" checked onchange="resetAccountInput()"><label class="btn btn-outline-danger" for="t2">ë¹„ìš©</label>
            <input type="radio" class="btn-check" name="inputType" id="t3" value="ìì‚°" onchange="resetAccountInput()"><label class="btn btn-outline-primary" for="t3">ìì‚°</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="small text-muted">ê³„ì •ê³¼ëª©</label>
          <div class="input-group">
            <input type="text" class="form-control readonly-input ime-kr" id="displayAccount" placeholder="ì„ íƒí•˜ì„¸ìš” (ìœ í˜•ì— ë§ëŠ” í•­ëª©ë§Œ í‘œì‹œë¨)" readonly onclick="openSelModal()">
            <button class="btn btn-secondary" type="button" onclick="openSelModal()">ğŸ”</button>
            <button class="btn btn-outline-secondary" type="button" onclick="openAddModal()">â•</button>
          </div>
          <input type="hidden" id="hiddenItem"><input type="hidden" id="hiddenStandard">
          <input type="hidden" id="isTaxFree"> 
        </div>

        <div class="mb-3"><label class="small text-muted">ì ìš”</label><input type="text" class="form-control ime-kr" id="inputDesc" required></div>
        <div class="mb-2"><label class="small text-muted">ê¸ˆì•¡ (í•©ê³„)</label><input type="number" class="form-control form-control-lg" id="inputAmount" placeholder="0" required min="0"></div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
           <div class="d-flex align-items-center" id="cardOptionDiv">
               <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="payMethod" onchange="toggleCard()"><label class="form-check-label small" for="payMethod">ğŸ’³ ì¹´ë“œê²°ì œ</label></div>
               <select class="form-select form-select-sm hidden ms-2" id="cardSelect" style="width: 120px;"><option value="">ì¹´ë“œì„ íƒ</option></select>
           </div>
           <div class="ms-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="vatCheck" checked><label class="form-check-label small" for="vatCheck">ë¶€ê°€ì„¸í¬í•¨</label></div></div>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm mt-4" id="submitBtn">ì €ì¥í•˜ê¸°</button>
      </form>
    </div>

    <div class="tab-pane fade" id="tabSync">
      <div class="d-grid gap-3">
          <div class="card p-3 border-start border-5 border-info bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ’¼ ê¸‰ì—¬ ëŒ€ì¥ ì—°ë™</h6><small class="text-muted">HR_Salary â†’ íšŒê³„ ì „í‘œ</small></div>
               <div class="d-flex align-items-center gap-2">
                   <input type="month" id="salaryMonth" class="form-control form-control-sm" style="width: 130px;">
                   <button class="btn btn-info btn-sm text-white" onclick="confirmSync('salary')">ì‹¤í–‰</button>
               </div>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-warning bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ“ ì „ìê²°ì¬ ì—°ë™</h6><small class="text-muted">ì™„ë£Œëœ ì§€ì¶œê²°ì˜ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</small></div>
               <button class="btn btn-warning btn-sm text-white" onclick="confirmSync('approval')">ì‹¤í–‰</button>
             </div>
          </div>
          <div class="card p-3 border-start border-5 border-danger bg-light">
             <div class="d-flex justify-content-between align-items-center">
               <div><h6 class="fw-bold mb-1">ğŸ“… ì—°ë§ê²°ì‚°</h6><small class="text-muted">ì†ìµê³„ì • ë§ˆê° (ì¤€ë¹„ì¤‘)</small></div>
               <button class="btn btn-danger btn-sm" onclick="showAlert('ì•Œë¦¼', 'ì¤€ë¹„ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.')">ì‹¤í–‰</button>
             </div>
          </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tabHistory">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="fw-bold m-0">ìµœê·¼ ì „í‘œ 10ê±´</h6>
          <button class="btn btn-sm btn-outline-primary" onclick="loadHistory()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="historyList" class="list-group"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold" id="alertTitle">ì•Œë¦¼</h6></div><div class="modal-body text-center py-4" id="alertBody">ë‚´ìš©</div><div class="modal-footer border-0 pt-0 justify-content-center"><button type="button" class="btn btn-primary btn-sm w-50" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold" id="confirmTitle">í™•ì¸</h6></div><div class="modal-body text-center py-4" id="confirmBody">ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div><div class="modal-footer border-0 pt-0 justify-content-center gap-2"><button type="button" class="btn btn-secondary btn-sm w-40" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="button" class="btn btn-danger btn-sm w-40" id="btnConfirmYes">í™•ì¸</button></div></div></div></div>

<div class="modal fade" id="selectModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header p-3 bg-light"><h6 class="m-0 fw-bold">ê³„ì •ê³¼ëª© ê²€ìƒ‰</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="p-2 border-bottom bg-white sticky-top"><input type="text" class="form-control" id="accountSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." onkeyup="filterAccounts()"></div><div id="accountList" style="height: 350px; overflow-y: auto;"></div></div></div></div></div>

<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">í•­ëª© ì¶”ê°€</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <label class="small text-muted mb-1">êµ¬ë¶„</label><select class="form-select mb-3" id="addTypeSelect" disabled><option value="ë§¤ì¶œ">ë§¤ì¶œ</option><option value="ë¹„ìš©">ë¹„ìš©</option><option value="ìì‚°">ìì‚°</option></select>
    <label class="small text-muted mb-1">ì¤‘ë¶„ë¥˜</label><select class="form-select mb-2" id="addCategorySelect"></select><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="chkManualCat" onchange="toggleManualCat()"><label class="form-check-label small" for="chkManualCat">ì§ì ‘ ì…ë ¥</label></div><input type="text" class="form-control mb-3 hidden" id="manualCatInput" placeholder="ìƒˆ ì¤‘ë¶„ë¥˜ëª… ì…ë ¥">
    <label class="small text-muted mb-1">ì‚¬ìš©ì²˜</label><select class="form-select mb-3" id="addUsageSelect"><option value="ì „ì²´">ì „ì²´</option><option value="ë³¸ì‚¬">ë³¸ì‚¬</option><option value="1í˜¸ê¸°">1í˜¸ê¸°</option><option value="2í˜¸ê¸°">2í˜¸ê¸°</option></select>
    <label class="small text-muted mb-1">ìƒˆ í•­ëª©ëª…</label><input type="text" class="form-control mb-3" id="addNewItemName" placeholder="ì˜ˆ: ì•¼ê·¼ì‹ëŒ€">
    <div class="form-check p-2 border rounded bg-light"><input class="form-check-input ms-0 me-2" type="checkbox" id="addTaxFreeCheck"><label class="form-check-label fw-bold" for="addTaxFreeCheck">ë©´ì„¸ í•­ëª©</label></div>
</div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="confAdd()">ì¶”ê°€í•˜ê¸°</button></div></div></div></div>

<div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ë³´ê³ ì„œ ë¯¸ë¦¬ë³´ê¸°</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-white" id="reportContent"></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button><button class="btn btn-primary" onclick="realPrint()">ğŸ–¨ï¸ ì¸ì‡„</button></div></div></div></div>

<div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">âš™ï¸ ì„¤ì •</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <form id="infoForm">
        <div class="mb-2"><label class="small text-muted">ì¡°í•©ëª…</label><input type="text" class="form-control" id="orgName"></div>
        <div class="mb-2"><label class="small text-muted">ëŒ€í‘œìëª…</label><input type="text" class="form-control" id="ceoName" placeholder="í™ê¸¸ë™"></div>
        <div class="mb-2"><label class="small text-muted">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><input type="text" class="form-control" id="bizNum" placeholder="000-00-00000"></div>
        
        <div class="mb-3"><label class="small text-muted">ì„¤ë¦½ì¼</label><input type="date" class="form-control" id="estDate"></div>
        <div class="mb-3"><label class="small text-muted">í˜„ì¬ ì¶œìê¸ˆ ì´ì•¡ (ìë™ê³„ì‚°)</label><input type="text" class="form-control bg-light" id="totalCap" readonly value="0"></div>
    </form>
</div><div class="modal-footer"><button class="btn btn-primary" onclick="saveInfo()">ì €ì¥</button></div></div></div></div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let mData=[], cardData=[]; 
let selectModal, reportModal, addModal, infoModal, alertModal, confirmModal;
let myInfo = null, confirmCallback = null;

window.onload = async function() {
    selectModal = new bootstrap.Modal(document.getElementById('selectModal'));
    reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    addModal = new bootstrap.Modal(document.getElementById('addModal'));
    infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    document.getElementById("btnConfirmYes").onclick = function() { if(confirmCallback) confirmCallback(); confirmModal.hide(); };

    const stored = localStorage.getItem('erp_user');
    if(stored) myInfo = JSON.parse(stored);

    document.getElementById('dateField').valueAsDate = new Date();
    document.getElementById('salaryMonth').value = new Date().toISOString().slice(0, 7);

    // [Ver.12] ë³´ê³ ì„œ ì—°ë„ ì˜µì…˜ ì±„ìš°ê¸° (í˜„ì¬ ì—°ë„ ~ 2ë…„ ì „ê¹Œì§€)
    const yearSel = document.getElementById("reportYearSelect");
    const currentYear = new Date().getFullYear();
    for (let y = currentYear; y >= currentYear - 2; y--) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.text = y + "ë…„";
        yearSel.add(opt);
    }

    await Promise.all([ loadMasterData(), loadCards(), refreshDashboard() ]);
};

// Helper
function showAlert(t,m) { document.getElementById("alertTitle").innerText=t; document.getElementById("alertBody").innerHTML=m; alertModal.show(); }
function showConfirm(t,m,cb) { document.getElementById("confirmTitle").innerText=t; document.getElementById("confirmBody").innerHTML=m; confirmCallback=cb; confirmModal.show(); }

// 1. ë°ì´í„° ë¡œë“œ
async function loadMasterData() {
    const { data } = await _supabase.from('ac_master').select('*').order('Type').order('Standard').order('Item');
    if(data) mData = data;
}
async function loadCards() {
    const { data } = await _supabase.from('ref_cards').select('*');
    if(data) {
        cardData = data;
        const sel = document.getElementById("cardSelect");
        sel.innerHTML = "<option value=''>ì¹´ë“œì„ íƒ</option>";
        cardData.forEach(c => sel.add(new Option(c.card_alias, c.card_alias))); 
    }
}

// 2. ëŒ€ì‹œë³´ë“œ
async function refreshDashboard() {
    const { data } = await _supabase.from('ac_journal').select('*');
    let rev=0, exp=0, ast=0, vatIn=0, vatOut=0, bankBalance=0;
    if(data) {
        data.forEach(r => {
            const db = Number(r.Debit||0), cr = Number(r.Credit||0);
            if(r.Type==='ë§¤ì¶œ') rev+=cr; if(r.Type==='ë¹„ìš©') exp+=db; if(r.Type==='ìì‚°') ast+=(db-cr);
            if(r.Account==='ë³´í†µì˜ˆê¸ˆ'||r.Account==='í˜„ê¸ˆ') bankBalance+=(db-cr);
            if(r.Account==='ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ') vatIn+=(cr-db); if(r.Account==='ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ') vatOut+=(db-cr);
        });
    }
    document.getElementById("valRev").innerText = rev.toLocaleString();
    document.getElementById("valExp").innerText = exp.toLocaleString();
    document.getElementById("valAst").innerText = ast.toLocaleString();
    document.getElementById("valCash").innerText = bankBalance.toLocaleString();
    document.getElementById("valVat").innerText = (vatIn - vatOut).toLocaleString();
}

// 3. ì „í‘œ ì €ì¥
async function handleFormSubmit(e) {
    e.preventDefault();
    const item = document.getElementById("hiddenItem").value;
    if(!item) return showAlert("ì˜¤ë¥˜", "ê³„ì •ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
    
    // UI Values
    const fDate = document.getElementById("dateField").value;
    const project = document.getElementById("projectSelect").value;
    const type = document.querySelector('input[name="inputType"]:checked').value;
    const settleMode = document.querySelector('input[name="settleMode"]:checked').value;
    const desc = document.getElementById("inputDesc").value;
    const totalAmt = Number(document.getElementById("inputAmount").value);
    const isTaxFree = (document.getElementById("isTaxFree").value === "true");
    const useVAT = document.getElementById("vatCheck").checked;
    
    const isCard = (settleMode === "") && document.getElementById("payMethod").checked;
    const cardName = isCard ? document.getElementById("cardSelect").value : "";
    const payerName = document.getElementById("payerName").value || "ì§€ì¶œì";

    let netAmount = totalAmt, vatAmount = 0;
    if (useVAT && !isTaxFree && type !== 'ìì‚°' && settleMode !== 'reimburse') {
        netAmount = Math.round(totalAmt / 1.1);
        vatAmount = totalAmt - netAmount;
    }

    let finalDesc = desc;
    if(isCard) finalDesc = `[${cardName}] ${desc}`;
    if(settleMode === 'pre_expense') finalDesc = `[ì„¤ë¦½ì „] ${desc} (${payerName})`;
    if(settleMode === 'reimburse') finalDesc = `[ì •ì‚°] ${desc} (${payerName})`;

    let entries = [];
    const writer = myInfo ? myInfo.emp_name : "WebUser";

    // ë¶„ê°œ
    if (settleMode === 'pre_expense') {
        entries.push({ Date: fDate, Type: type, Account: item, Description: finalDesc, Debit: netAmount, Credit: 0, Project: project, Operator: writer });
        if(vatAmount > 0) entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ', Description: `[${item}] ë¶€ê°€ì„¸`, Debit: vatAmount, Credit: 0, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ê¸ˆ', Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
    } else if (settleMode === 'reimburse') {
        entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¯¸ì§€ê¸‰ê¸ˆ', Description: finalDesc, Debit: totalAmt, Credit: 0, Project: project, Operator: writer });
        entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
    } else {
        if (type === 'ë§¤ì¶œ') {
            entries.push({ Date: fDate, Type: 'ë§¤ì¶œ', Account: item, Description: finalDesc, Debit: 0, Credit: netAmount, Project: project, Operator: writer });
            if(vatAmount > 0) entries.push({ Date: fDate, Type: 'ë¶€ì±„', Account: 'ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ', Description: `[${item}] ë¶€ê°€ì„¸`, Debit: 0, Credit: vatAmount, Project: project, Operator: writer });
            entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: totalAmt, Credit: 0, Project: project, Operator: writer });
        } else if (type === 'ë¹„ìš©') {
            const creditAcc = isCard ? 'ë¯¸ì§€ê¸‰ê¸ˆ' : 'ë³´í†µì˜ˆê¸ˆ';
            const creditType = isCard ? 'ë¶€ì±„' : 'ìì‚°';
            entries.push({ Date: fDate, Type: 'ë¹„ìš©', Account: item, Description: finalDesc, Debit: netAmount, Credit: 0, Project: project, Operator: writer });
            if(vatAmount > 0) entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ', Description: `[${item}] ë¶€ê°€ì„¸`, Debit: vatAmount, Credit: 0, Project: project, Operator: writer });
            entries.push({ Date: fDate, Type: creditType, Account: creditAcc, Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
        } else { // ìì‚°
            entries.push({ Date: fDate, Type: type, Account: item, Description: finalDesc, Debit: totalAmt, Credit: 0, Project: project, Operator: writer });
            entries.push({ Date: fDate, Type: 'ìì‚°', Account: 'ë³´í†µì˜ˆê¸ˆ', Description: finalDesc, Debit: 0, Credit: totalAmt, Project: project, Operator: writer });
        }
    }

    const { error } = await _supabase.from('ac_journal').insert(entries);
    if(error) showAlert("ì˜¤ë¥˜", "ì €ì¥ ì‹¤íŒ¨: " + error.message);
    else {
        showAlert("ì™„ë£Œ", "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById("erpForm").reset();
        document.getElementById("smNorm").checked = true;
        toggleSettleMode();
        refreshDashboard();
    }
}

// 4. ëª¨ë‹¬: ê³„ì •ê³¼ëª© ê²€ìƒ‰
function resetAccountInput() {
    document.getElementById("displayAccount").value = "";
    document.getElementById("hiddenItem").value = "";
    document.getElementById("isTaxFree").value = "false";
}
function openSelModal() { filterAccounts(); selectModal.show(); setTimeout(() => document.getElementById("accountSearchInput").focus(), 300); }
function filterAccounts() {
    const k = document.getElementById("accountSearchInput").value.trim();
    const type = document.querySelector('input[name="inputType"]:checked').value;
    const list = document.getElementById("accountList");
    list.innerHTML = "";
    const filtered = mData.filter(m => m.Type === type && (m.Item.includes(k) || m.Standard.includes(k)));
    
    if(filtered.length === 0) { list.innerHTML = "<div class='p-3 text-center text-muted'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }

    filtered.forEach(acc => {
        const d = document.createElement("div");
        d.className = "list-group-item list-group-item-action p-2 ps-3 border-0 border-bottom search-list-item";
        d.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div><span class="acc-item-name">${acc.Item}</span><span class="acc-item-std ms-1">(${acc.Standard})</span></div>${(acc.Tax_Free=='TRUE'||acc.Tax_Free===true)?'<span class="badge bg-secondary" style="font-size:0.7em;">ë©´ì„¸</span>':''}</div>`;
        d.onclick = () => {
            document.getElementById("displayAccount").value = acc.Item;
            document.getElementById("hiddenItem").value = acc.Item;
            document.getElementById("hiddenStandard").value = acc.Standard;
            const isTF = (acc.Tax_Free=='TRUE'||acc.Tax_Free===true);
            document.getElementById("isTaxFree").value = isTF;
            const vat = document.getElementById("vatCheck");
            if(isTF) { vat.checked=false; vat.disabled=true; } else { vat.disabled=false; vat.checked=true; }
            selectModal.hide();
        };
        list.appendChild(d);
    });
}

// 5. ëª¨ë‹¬: í•­ëª© ì¶”ê°€
function openAddModal() {
    document.getElementById("addTypeSelect").value = document.querySelector('input[name="inputType"]:checked').value;
    updateAddCategorySelect();
    addModal.show();
}
function updateAddCategorySelect() {
    const type = document.getElementById("addTypeSelect").value;
    const catSel = document.getElementById("addCategorySelect");
    catSel.innerHTML = "";
    const cats = [...new Set(mData.filter(m => m.Type === type).map(m => m.Standard))].sort();
    cats.forEach(c => catSel.add(new Option(c, c)));
}
function toggleManualCat() {
    const chk = document.getElementById("chkManualCat").checked;
    document.getElementById("addCategorySelect").classList.toggle("hidden", chk);
    document.getElementById("manualCatInput").classList.toggle("hidden", !chk);
}
async function confAdd() {
    const type = document.getElementById("addTypeSelect").value;
    const name = document.getElementById("addNewItemName").value;
    let cat = document.getElementById("addCategorySelect").value;
    if(document.getElementById("chkManualCat").checked) cat = document.getElementById("manualCatInput").value;
    const usage = document.getElementById("addUsageSelect").value;
    const isTaxFree = document.getElementById("addTaxFreeCheck").checked ? "TRUE" : "FALSE";

    if(!name || !cat) return showAlert("ì•Œë¦¼", "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
    await _supabase.from('ac_master').insert({Type:type, Standard:cat, Item:name, Usage:usage, Tax_Free:isTaxFree});
    showAlert("ì„±ê³µ", "ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); addModal.hide(); loadMasterData();
}

// 6. ê²°ì‚° ë³´ê³ ì„œ (Ver.12: ê¸°ê°„ ì„ íƒ ë° ëŒ€í‘œì í‘œì‹œ)
async function printReport() {
    // 1) ì„ íƒëœ ì—°ë„ ê°€ì ¸ì˜¤ê¸°
    const selYear = Number(document.getElementById("reportYearSelect").value);
    const currYear = new Date().getFullYear();
    const todayStr = new Date().toISOString().slice(0, 10);
    
    // 2) ë‚ ì§œ ë²”ìœ„ ì„¤ì •
    const startDate = `${selYear}-01-01`;
    let endDate = (selYear === currYear) ? todayStr : `${selYear}-12-31`;
    let rangeText = (selYear === currYear) ? `${startDate} ~ ${endDate} (ê°€ê²°ì‚°)` : `${startDate} ~ ${endDate} (í™•ì •)`;

    // 3) ë°ì´í„° í•„í„°ë§ ì¡°íšŒ
    const { data } = await _supabase.from('ac_journal').select('*')
        .gte('Date', startDate)
        .lte('Date', endDate);
    
    // íšŒì‚¬ ì •ë³´ (ëŒ€í‘œì, ì‚¬ì—…ìë²ˆí˜¸ í¬í•¨)
    const { data: infoData } = await _supabase.from('ref_company_info').select('*');
    const info = {}; if(infoData) infoData.forEach(i=>info[i.key]=i.value);
    
    const { count } = await _supabase.from('ref_members').select('*', { count: 'exact', head: true });
    const memberCount = count || 0;

    let asset={}, liab={}, equity={}, rev={}, exp={};
    let tAsset=0, tLiab=0, tEquity=0, tRev=0, tExp=0;
    let capital = 0; // ê¸°ê°„ ë‚´ ìë³¸ ë³€ë™ì´ ì•„ë‹ˆë¼, ì „ì²´ ëˆ„ì  ìë³¸ê¸ˆì„ ë³´ì—¬ì£¼ëŠ” ê²Œ ë§ì§€ë§Œ, ì—¬ê¸°ì„  ì¼ë‹¨ ê¸°ê°„ í•„í„°ë§ëœ ê°’ + ê¸°ì´ˆ ì”ì•¡ ê°œë…ì´ í•„ìš”í•¨. 
    // *ì£¼ì˜: ì¬ë¬´ìƒíƒœí‘œ(BS)ëŠ” 'íŠ¹ì • ì‹œì 'ì˜ ì”ì•¡ì´ë¯€ë¡œ ì›ë˜ëŠ” ì „ì²´ ê¸°ê°„ ë°ì´í„°ë¥¼ ë‹¤ ê°€ì ¸ì™€ì„œ ì§‘ê³„í•´ì•¼ ë§ìŠµë‹ˆë‹¤.
    // í•˜ì§€ë§Œ êµ­ì¥ë‹˜ ìš”ì²­í•˜ì‹  'ê¸°ê°„ë³„' ì¡°íšŒëŠ” ì£¼ë¡œ ì†ìµê³„ì‚°ì„œ(PL)ì— í•´ë‹¹í•©ë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ BSë„ í•´ë‹¹ ê¸°ê°„ ëˆ„ì ë¶„ë§Œ ë³´ì—¬ì£¼ë˜, ì‹¤ì œë¡œëŠ” 'ì „ì²´ ê¸°ê°„'ìœ¼ë¡œ ì¡°íšŒí•´ì„œ BSë¥¼ ì±„ìš°ëŠ” ê²Œ íšŒê³„ì ìœ¼ë¡œ ë§ìŠµë‹ˆë‹¤.
    // (ì¼ë‹¨ ìš”ì²­í•˜ì‹ ëŒ€ë¡œ ì„ íƒëœ ê¸°ê°„ ë°ì´í„°ë§Œ ê°€ì§€ê³  ì§‘ê³„í•©ë‹ˆë‹¤.)

    data.forEach(r => {
        const debit = Number(r.Debit||0), credit = Number(r.Credit||0);
        const valDr = debit - credit;
        const valCr = credit - debit;

        if(r.Type==='ìì‚°') { asset[r.Account]=(asset[r.Account]||0)+valDr; tAsset+=valDr; }
        else if(r.Type==='ë¶€ì±„') { liab[r.Account]=(liab[r.Account]||0)+valCr; tLiab+=valCr; }
        else if(r.Type==='ìë³¸') { equity[r.Account]=(equity[r.Account]||0)+valCr; tEquity+=valCr; if(r.Account==='ì¶œìê¸ˆ') capital+=valCr; }
        else if(r.Type==='ë§¤ì¶œ') { rev[r.Account]=(rev[r.Account]||0)+valCr; tRev+=valCr; }
        else if(r.Type==='ë¹„ìš©') { exp[r.Account]=(exp[r.Account]||0)+valDr; tExp+=valDr; }
    });

    const netIncome = tRev - tExp;
    const totalLiabEquity = tLiab + tEquity + netIncome;

    const headerHtml = `
        <div class="rpt-title">ì¬ë¬´ì œí‘œ</div>
        <table class="rpt-header-tbl">
            <tr><th>íšŒì‚¬ëª…</th><td>${info.orgName||''}</td><th>ì‚¬ì—…ìë²ˆí˜¸</th><td>${info.bizNum||''}</td></tr>
            <tr><th>íšŒê³„ê¸°ê°„</th><td>${rangeText}</td><th>ëŒ€í‘œì</th><td>${info.ceoName||''}</td></tr>
            <tr><th>ì¶œìê¸ˆ</th><td>${capital.toLocaleString()}ì›</td><th>ì¡°í•©ì›ìˆ˜</th><td>${memberCount}ëª…</td></tr>
        </table>
    `;

    // BS (ëŒ€ì°¨ëŒ€ì¡°í‘œ)
    const bsHtml = `
        <div class="rpt-sec">1. ëŒ€ì°¨ëŒ€ì¡°í‘œ (Balance Sheet)</div>
        <div style="text-align:right; font-size:11px;">(ë‹¨ìœ„: ì›)</div>
        <table class="rpt-tbl">
            <colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup>
            <tr><th colspan="2">ì ì‚°</th><th colspan="2">ë¶€ì±„ ë° ìë³¸</th></tr>
            <tr style="vertical-align:top;">
                <td colspan="2">
                    <div style="font-weight:bold; margin-bottom:5px;">[ìœ ë™ìì‚°]</div>
                    ${Object.keys(asset).map(k=>`<div class="d-flex justify-content-between"><span>${k}</span><span>${asset[k].toLocaleString()}</span></div>`).join('')}
                    <div class="d-flex justify-content-between border-top mt-2 pt-2 fw-bold bg-light"><span>ìì‚°ì´ê³„</span><span>${tAsset.toLocaleString()}</span></div>
                </td>
                <td colspan="2">
                    <div style="font-weight:bold; margin-bottom:5px;">[ë¶€ì±„]</div>
                    ${Object.keys(liab).map(k=>`<div class="d-flex justify-content-between"><span>${k}</span><span>${liab[k].toLocaleString()}</span></div>`).join('')}
                    <div class="fw-bold mt-3 mb-1 text-end border-top">ë¶€ì±„ì´ê³„: ${tLiab.toLocaleString()}</div>
                    
                    <div style="font-weight:bold; margin-top:10px; margin-bottom:5px;">[ìë³¸]</div>
                    ${Object.keys(equity).map(k=>`<div class="d-flex justify-content-between"><span>${k}</span><span>${equity[k].toLocaleString()}</span></div>`).join('')}
                    <div class="d-flex justify-content-between text-primary"><span>(ë‹¹ê¸°ìˆœì´ìµ)</span><span>${netIncome.toLocaleString()}</span></div>
                    <div class="d-flex justify-content-between border-top mt-2 pt-2 fw-bold bg-light"><span>ë¶€ì±„/ìë³¸ ì´ê³„</span><span>${totalLiabEquity.toLocaleString()}</span></div>
                </td>
            </tr>
        </table>
    `;

    // PL (ì†ìµê³„ì‚°ì„œ)
    const plHtml = `
        <div class="page-break"></div>
        <div class="rpt-sec mt-4">2. ì†ìµê³„ì‚°ì„œ (Income Statement)</div>
        <div style="text-align:right; font-size:11px;">(ë‹¨ìœ„: ì›)</div>
        <table class="rpt-tbl">
            <tr><th>ê³„ì •ê³¼ëª©</th><th>ì½”ë“œ</th><th>ê¸ˆì•¡</th></tr>
            <tr class="bg-light"><td class="fw-bold">I. ë§¤ì¶œì•¡</td><td></td><td class="rpt-amt fw-bold">${tRev.toLocaleString()}</td></tr>
            ${Object.keys(rev).map(k=>`<tr><td class="rpt-indent">${k}</td><td class="text-center text-muted text-small">-</td><td class="rpt-amt">${rev[k].toLocaleString()}</td></tr>`).join('')}
            <tr class="bg-light"><td class="fw-bold">II. ë§¤ì¶œì´ì´ìµ</td><td></td><td class="rpt-amt fw-bold">${tRev.toLocaleString()}</td></tr>
            <tr class="bg-light"><td class="fw-bold">III. íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„</td><td></td><td class="rpt-amt fw-bold">${tExp.toLocaleString()}</td></tr>
            ${Object.keys(exp).map(k=>`<tr><td class="rpt-indent">${k}</td><td class="text-center text-muted text-small">-</td><td class="rpt-amt">${exp[k].toLocaleString()}</td></tr>`).join('')}
            <tr class="bg-light" style="border-top:2px solid #000;"><td class="fw-bold">IV. ì˜ì—…ì´ìµ(ì†ì‹¤)</td><td></td><td class="rpt-amt fw-bold">${netIncome.toLocaleString()}</td></tr>
            <tr style="background:#fff3cd; border-top:2px solid #000;"><td class="fw-bold text-center">V. ë‹¹ê¸°ìˆœì´ìµ</td><td></td><td class="rpt-amt fw-bold text-danger" style="font-size:1.2em;">${netIncome.toLocaleString()}</td></tr>
        </table>
    `;

    document.getElementById("reportContent").innerHTML = headerHtml + bsHtml + plHtml;
    reportModal.show();
}
function realPrint() {
    const w = window.open();
    w.document.write(`<html><head><title>ê²°ì‚°ë³´ê³ ì„œ</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><style>body{padding:40px; font-family:'Malgun Gothic', serif;} .rpt-title{text-align:center; font-size:28px; font-weight:bold; margin-bottom:30px; text-decoration:underline;} .rpt-header-tbl{width:100%; border:2px solid #000; border-collapse:collapse; margin-bottom:30px;} .rpt-header-tbl th{background:#eee; padding:8px; border:1px solid #000; text-align:center; width:15%; font-weight:bold;} .rpt-header-tbl td{padding:8px; border:1px solid #000;} .rpt-sec{font-size:18px; font-weight:bold; margin:20px 0 10px 0; border-bottom:2px solid #555; padding-bottom:5px;} .rpt-tbl{width:100%; border-collapse:collapse; margin-bottom:20px; border:2px solid #000;} .rpt-tbl th, .rpt-tbl td{border:1px solid #000; padding:8px; font-size:14px;} .rpt-tbl th{background:#f8f9fa; text-align:center;} .rpt-amt{text-align:right; font-family:'Consolas', monospace;} .rpt-indent{padding-left:20px !important;} @media print{ .page-break{page-break-before:always;} .bg-light{background-color:#f8f9fa !important; -webkit-print-color-adjust:exact;} }</style></head><body>${document.getElementById("reportContent").innerHTML}</body></html>`);
    w.document.close();
    setTimeout(() => { w.focus(); w.print(); w.close(); }, 500);
}

// ê¸°íƒ€ ê¸°ëŠ¥ë“¤
async function loadHistory() {
    const el = document.getElementById("historyList");
    el.innerHTML = "ë¡œë”© ì¤‘...";
    const { data } = await _supabase.from('ac_journal').select('*').order('Date', {ascending:false}).limit(10);
    el.innerHTML = "";
    if(data) data.forEach(item => {
        const amt = Number(item.Debit||0) + Number(item.Credit||0);
        el.innerHTML += `<div class="list-group-item d-flex justify-content-between"><div><span class="badge bg-secondary me-1">${item.Type}</span><b>${item.Account}</b> <small>${item.Description}</small></div><div class="fw-bold">${amt.toLocaleString()} <span class="text-danger cursor-pointer" onclick="deleteTx('${item.id}')">Ã—</span></div></div>`;
    });
}
async function deleteTx(id) {
    showConfirm("ì‚­ì œ í™•ì¸", "ì •ë§ ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async function() {
        await _supabase.from('ac_journal').delete().eq('id', id);
        loadHistory(); refreshDashboard();
    });
}
function toggleCard() { document.getElementById("cardSelect").classList.toggle("hidden", !document.getElementById("payMethod").checked); }
function toggleSettleMode() {
    const mode = document.querySelector('input[name="settleMode"]:checked').value;
    document.getElementById("payerInputDiv").classList.toggle("hidden", !mode);
}
// [Ver.12] ì„¤ì • ëª¨ë‹¬: ëŒ€í‘œì/ì‚¬ì—…ìë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
async function openInfoModal() {
    const { data } = await _supabase.from('ref_company_info').select('*');
    const map = {}; if(data) data.forEach(i=>map[i.key]=i.value);
    
    document.getElementById("orgName").value = map['orgName']||"";
    document.getElementById("ceoName").value = map['ceoName']||""; // ì‹ ê·œ
    document.getElementById("bizNum").value = map['bizNum']||"";   // ì‹ ê·œ
    document.getElementById("estDate").value = map['estDate']||"";
    
    // ì¶œìê¸ˆ ì´ì•¡ ê³„ì‚°
    const { data: cap } = await _supabase.from('ac_journal').select('*').eq('Account','ì¶œìê¸ˆ');
    let totalCap=0; if(cap) cap.forEach(c=>totalCap+=c.Credit);
    document.getElementById("totalCap").value = totalCap.toLocaleString();
    
    infoModal.show();
}
// [Ver.12] ì„¤ì • ì €ì¥: ëŒ€í‘œì/ì‚¬ì—…ìë²ˆí˜¸ ì €ì¥
async function saveInfo() {
    const updates = [
        { key: 'orgName', value: document.getElementById("orgName").value },
        { key: 'ceoName', value: document.getElementById("ceoName").value }, // ì‹ ê·œ
        { key: 'bizNum', value: document.getElementById("bizNum").value },   // ì‹ ê·œ
        { key: 'estDate', value: document.getElementById("estDate").value }
    ];
    await _supabase.from('ref_company_info').upsert(updates);
    showAlert("ì„±ê³µ", "ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); infoModal.hide();
}

// ì—°ë™ ê¸°ëŠ¥ (Confirm ëª¨ë‹¬ ì ìš©)
function confirmSync(type) {
    if(type === 'salary') {
        const ym = document.getElementById("salaryMonth").value;
        if(!ym) return showAlert("ì•Œë¦¼", "ë…„-ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");
        showConfirm("ê¸‰ì—¬ ì—°ë™", `${ym}ì›” ê¸‰ì—¬ ë‚´ì—­ì„ íšŒê³„ ì „í‘œë¡œ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => {
            const { data: salaries } = await _supabase.from('hr_salary').select('*').eq('year_month', ym);
            if(!salaries || !salaries.length) return showAlert("ì˜¤ë¥˜", "í•´ë‹¹ ì›”ì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            let total=0; salaries.forEach(s=>total+=Number(s.pay_total));
            await _supabase.from('ac_journal').insert([{Date:`${ym}-25`, Type:'ë¹„ìš©', Account:'ê¸‰ì—¬', Description:`${ym}ì›” ê¸‰ì—¬ (${salaries.length}ëª…)`, Debit:total, Credit:0, Project:'ë³¸ì‚¬', Operator:'System'}, {Date:`${ym}-25`, Type:'ìì‚°', Account:'ë³´í†µì˜ˆê¸ˆ', Description:`${ym}ì›” ê¸‰ì—¬ ì´ì²´`, Debit:0, Credit:total, Project:'ë³¸ì‚¬', Operator:'System'}]);
            showAlert("ì„±ê³µ", "ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); refreshDashboard();
        });
    } else if (type === 'approval') {
        showConfirm("ì „ìê²°ì¬ ì—°ë™", "ì™„ë£Œëœ ì§€ì¶œê²°ì˜ì„œë¥¼ ì „í‘œë¡œ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
            const { data: approvals } = await _supabase.from('ac_approval').select('*').eq('status', 'ì™„ë£Œ').like('doc_type', '%ì§€ì¶œ%');
            if(!approvals || !approvals.length) return showAlert("ì•Œë¦¼", "ë¶ˆëŸ¬ì˜¬ ê²°ì¬ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.");
            let count = 0; const today = new Date().toISOString().slice(0,10);
            for (const doc of approvals) {
                const { error } = await _supabase.from('ac_journal').insert([{Date:today, Type:'ë¹„ìš©', Account:'ë¯¸ë¶„ë¥˜ë¹„ìš©', Description:`[ì „ìê²°ì¬] ${doc.title}`, Debit:doc.amount, Credit:0, Project:'ë³¸ì‚¬', Operator:doc.drafter_name}, {Date:today, Type:'ë¶€ì±„', Account:'ë¯¸ì§€ê¸‰ê¸ˆ', Description:`[ì „ìê²°ì¬] ${doc.title}`, Debit:0, Credit:doc.amount, Project:'ë³¸ì‚¬', Operator:doc.drafter_name}]);
                if(!error) count++;
            }
            showAlert("ì™„ë£Œ", `${count}ê±´ì˜ ê²°ì¬ ë‚´ì—­ì´ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`); refreshDashboard(); loadHistory();
        });
    }
}
</script>
</body>
</html>
