<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì „ìê²°ì¬ (Full Ver)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; }
    .main-container { max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 30px; }
    .hidden { display: none !important; }
    
    /* ê²°ì¬ì„  ìŠ¤íƒ€ì¼ */
    .line-step { display: inline-block; background: #e3f2fd; color: #0d47a1; padding: 5px 12px; border-radius: 20px; margin-right: 5px; margin-bottom: 5px; font-size: 0.9rem; border: 1px solid #bbdefb; }
    .line-arrow { margin-right: 5px; color: #999; font-weight: bold; }
    .ref-step { display: inline-block; background: #f1f3f5; color: #495057; padding: 5px 10px; border-radius: 5px; margin-right: 5px; margin-bottom: 5px; font-size: 0.85rem; border: 1px solid #dee2e6; }
    
    /* ë¦¬ìŠ¤íŠ¸ ë° ì…ë ¥ì°½ */
    .user-select-item { cursor: pointer; }
    .user-select-item:hover { background-color: #f8f9fa; }
    .user-select-item.active { background-color: #e8f0fe; border-color: #4285f4; }
    .large-textarea { min-height: 300px; resize: vertical; }
    
    /* íŒŒì¼ ëª©ë¡ */
    .file-item { font-size: 0.9rem; background: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; border: 1px solid #eee; }
    .file-size { font-size: 0.8rem; color: #888; float: right; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">âš¡ ì „ìê²°ì¬ ì‹œìŠ¤í…œ</h4> 
    <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
  </div>

  <ul class="nav nav-pills nav-fill mb-4">
    <li class="nav-item"><button class="nav-link active" id="tab1" onclick="switchTab('draft')">âœï¸ ê¸°ì•ˆ ì‘ì„±</button></li>
    <li class="nav-item"><button class="nav-link" id="tab2" onclick="switchTab('todo')">ğŸ“¬ ê²°ì¬ ëŒ€ê¸°í•¨</button></li>
    <li class="nav-item"><button class="nav-link" id="tab3" onclick="switchTab('history')">ğŸ—‚ï¸ ë¬¸ì„œ ë³´ê´€í•¨</button></li>
  </ul>

  <div id="view-draft">
    <form id="draftForm" onsubmit="handleDraftSubmit(event)">
      
      <div class="row mb-3">
        <div class="col-12 mb-3">
          <label class="small text-muted fw-bold">ê²°ì¬ êµ¬ë¶„</label>
          <select class="form-select" id="appTypeDisplay" onchange="handleCategoryChange(this)">
            <option value="ì§€ì¶œê²°ì˜">ğŸ’° ì§€ì¶œê²°ì˜ì„œ</option>
            <option value="ì¼ë°˜í’ˆì˜">ğŸ“„ ì¼ë°˜í’ˆì˜ì„œ</option>
            <option value="íœ´ê°€">ğŸ–ï¸ íœ´ê°€(ê·¼íƒœ)</option>
          </select>
        </div>

        <div class="col-12" id="divAmount">
          <label class="small text-muted">ê¸ˆì•¡ (ì›)</label>
          <input type="number" class="form-control" id="appAmount" placeholder="0">
        </div>

        <div class="col-12 hidden" id="divLeaveSection">
          <div class="p-3 bg-light border rounded">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-bold">ğŸ“… íœ´ê°€ ê¸°ê°„ ì„ íƒ</span>
              <span class="badge bg-primary">ì”ì—¬ ì—°ì°¨: <span id="remainDaysBadge">0</span>ì¼</span>
            </div>
            <div class="input-group mb-2">
              <input type="date" class="form-control" id="leaveStart" onchange="calcLeaveDays()">
              <span class="input-group-text">~</span>
              <input type="date" class="form-control" id="leaveEnd" onchange="calcLeaveDays()">
            </div>
            <div class="text-end small text-muted">
              ì‹ ì²­ ì¼ìˆ˜: <span id="leaveDaysBadge" class="fw-bold text-dark">0ì¼</span>
              <input type="hidden" id="leaveDaysCalc" value="0">
            </div>
            <div class="text-danger small mt-1 hidden" id="leaveOverMsg">â›” ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!</div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted fw-bold">ê²°ì¬ì„  (í•„ìˆ˜)</label>
        <div class="card p-3 border-0 bg-light mb-2">
          <div id="linePreview" class="mb-2 text-muted small">ê²°ì¬ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openUserModal('approver')">â• ê²°ì¬ì ì„ íƒ</button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="resetLine('approver')">â†º ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted">ì°¸ì¡°ì (ì„ íƒ)</label>
        <div class="card p-3 border-0 bg-light">
          <div id="refPreview" class="mb-2 text-muted small">ì°¸ì¡°ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openUserModal('referrer')">â• ì°¸ì¡°ì ì„ íƒ</button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="resetLine('referrer')">â†º ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted">ë‚´ìš©</label>
        <textarea class="form-control large-textarea" id="appDesc" placeholder="ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
      </div>

      <div class="mb-4">
        <label class="small text-muted">ì¦ë¹™ ì²¨ë¶€</label>
        <input type="file" class="form-control" id="attachFile" multiple onchange="updateFileList()">
        <div id="fileListArea" class="mt-2"></div>
      </div>

      <button type="submit" class="btn btn-primary w-100 py-3 fw-bold btn-lg" id="btnSubmit">ìƒì‹ í•˜ê¸°</button>
    </form>
  </div>

  <div id="view-todo" class="hidden">
    <div id="todoList" class="list-group"></div>
  </div>

  <div id="view-history" class="hidden">
    <div class="input-group mb-3">
        <input type="text" class="form-control" id="searchKeyword" placeholder="ì œëª©, ê¸°ì•ˆì ê²€ìƒ‰" onkeyup="filterHistory()">
        <button class="btn btn-outline-secondary">ğŸ”</button>
    </div>
    <div id="historyList" class="list-group"></div>
  </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h6 class="modal-title fw-bold" id="modalTitle">ì§ì› ì„ íƒ</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group list-group-flush" id="userSelectList"></div>
            </div>
            <div class="modal-footer justify-content-between">
                <span class="small text-muted ms-2"><span id="selCount">0</span>ëª… ì„ íƒë¨</span>
                <button type="button" class="btn btn-primary" onclick="confirmSelection()">ì„ íƒ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// [ì„¤ì •] ìˆ˜í¼ë² ì´ìŠ¤ ì—°ê²° ì •ë³´
// ============================================================
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';

// [ìˆ˜ì • í¬ì¸íŠ¸] ë³€ìˆ˜ëª… ì¶©ëŒ ë°©ì§€: supabase -> _supabase
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ì „ì—­ ë³€ìˆ˜
let myInfo = null;
let allUsers = [];
let modalInstance = null;
let modalType = ''; // 'approver' or 'referrer'

// ì„ íƒëœ ì‚¬ëŒë“¤ ì €ì¥ì†Œ
let tempSelection = [];
let finalApprovers = [];
let finalRefs = [];

// ë¬¸ì„œ ì „ì²´ ëª©ë¡ ìºì‹œ (ê²€ìƒ‰ìš©)
let historyCache = [];

// 1. ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ì²´í¬
window.onload = async function() {
    modalInstance = new bootstrap.Modal(document.getElementById('userModal'));
    
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const stored = localStorage.getItem('erp_user');
    if (!stored) { 
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); 
        location.href = 'index.html'; 
        return; 
    }
    myInfo = JSON.parse(stored);

    // ì‚¬ìš©ì ëª©ë¡ ë¯¸ë¦¬ ë¡œë“œ (_supabase ì‚¬ìš©)
    const { data: users } = await _supabase.from('ref_employees').select('*').eq('is_active', true).order('rank_level', {ascending:false});
    allUsers = users || [];

    // ë‚´ íœ´ê°€ ì •ë³´ ë¡œë“œ
    loadMyLeave();
};

async function loadMyLeave() {
    const { data } = await _supabase.from('hr_leave').select('remaining_days').eq('emp_id', myInfo.emp_id).single();
    if(data) document.getElementById("remainDaysBadge").innerText = data.remaining_days;
}

// íƒ­ ì „í™˜ (ì´ì œ ì—ëŸ¬ ì—†ì´ ì‘ë™í•  ê²ë‹ˆë‹¤!)
function switchTab(tab) {
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));

    if (tab === 'draft') {
        document.getElementById('tab1').classList.add('active');
        document.getElementById('view-draft').classList.remove('hidden');
    } else if (tab === 'todo') {
        document.getElementById('tab2').classList.add('active');
        document.getElementById('view-todo').classList.remove('hidden');
        loadTodoList();
    } else {
        document.getElementById('tab3').classList.add('active');
        document.getElementById('view-history').classList.remove('hidden');
        loadHistoryList();
    }
}

// =========================================
// [ê¸°ëŠ¥ 1] íœ´ê°€ ë° ì¹´í…Œê³ ë¦¬ ë¡œì§
// =========================================
function handleCategoryChange(sel) {
    const type = sel.value;
    const desc = document.getElementById("appDesc");
    
    if (type === 'íœ´ê°€') {
        document.getElementById("divAmount").classList.add("hidden");
        document.getElementById("divLeaveSection").classList.remove("hidden");
        desc.value = "ìœ„ì™€ ê°™ì´ íœ´ê°€ë¥¼ ì‹ ì²­í•˜ì˜¤ë‹ˆ ì¬ê°€í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.";
    } else {
        document.getElementById("divAmount").classList.remove("hidden");
        document.getElementById("divLeaveSection").classList.add("hidden");
        if(desc.value.includes("íœ´ê°€ë¥¼ ì‹ ì²­")) desc.value = "";
    }
}

function calcLeaveDays() {
    const s = document.getElementById("leaveStart").value;
    const e = document.getElementById("leaveEnd").value;
    if (s && e) {
        const d1 = new Date(s);
        const d2 = new Date(e);
        if (d2 >= d1) {
            // ì£¼ë§ í¬í•¨ ë‹¨ìˆœ ê³„ì‚° (í•„ìš”ì‹œ ì£¼ë§ ì œì™¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥)
            const days = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById("leaveDaysBadge").innerText = days + "ì¼";
            document.getElementById("leaveDaysCalc").value = days;
            
            const remain = Number(document.getElementById("remainDaysBadge").innerText);
            if(days > remain) document.getElementById("leaveOverMsg").classList.remove("hidden");
            else document.getElementById("leaveOverMsg").classList.add("hidden");
        }
    }
}

// =========================================
// [ê¸°ëŠ¥ 2] ê²°ì¬ì„ /ì°¸ì¡°ì ëª¨ë‹¬ ë¡œì§
// =========================================
function openUserModal(type) {
    modalType = type;
    document.getElementById("modalTitle").innerText = (type === 'approver') ? "ê²°ì¬ì ì„ íƒ" : "ì°¸ì¡°ì ì„ íƒ";
    
    // ê¸°ì¡´ ì„ íƒëœ ì‚¬ëŒ ë¶ˆëŸ¬ì˜¤ê¸°
    tempSelection = (type === 'approver') ? [...finalApprovers] : [...finalRefs];
    renderUserList();
    modalInstance.show();
}

function renderUserList() {
    const listEl = document.getElementById("userSelectList");
    listEl.innerHTML = "";
    
    // ë‚˜ ìì‹  ì œì™¸
    const targets = allUsers.filter(u => u.emp_id !== myInfo.emp_id);
    
    targets.forEach(u => {
        const isSelected = tempSelection.some(s => s.emp_id === u.emp_id);
        const a = document.createElement("a");
        a.className = `list-group-item list-group-item-action user-select-item d-flex justify-content-between ${isSelected ? 'active' : ''}`;
        a.innerHTML = `<div><span class="badge bg-secondary me-2">${u.position}</span>${u.emp_name}</div>${isSelected ? 'âœ…' : ''}`;
        a.onclick = () => toggleSelect(u);
        listEl.appendChild(a);
    });
    document.getElementById("selCount").innerText = tempSelection.length;
}

function toggleSelect(user) {
    const idx = tempSelection.findIndex(s => s.emp_id === user.emp_id);
    if (idx > -1) tempSelection.splice(idx, 1);
    else tempSelection.push(user);
    renderUserList(); // ë¦¬ë Œë”ë§
}

function confirmSelection() {
    if (modalType === 'approver') {
        finalApprovers = [...tempSelection];
        renderLinePreview();
    } else {
        finalRefs = [...tempSelection];
        renderRefPreview();
    }
    modalInstance.hide();
}

function renderLinePreview() {
    const el = document.getElementById("linePreview");
    if(finalApprovers.length === 0) { el.innerText = "ê²°ì¬ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."; return; }
    
    el.innerHTML = finalApprovers.map((u, i) => 
        `<span class="line-step">${u.emp_name} ${u.position}</span>` + (i < finalApprovers.length-1 ? '<span class="line-arrow">â¡</span>' : '')
    ).join("");
}

function renderRefPreview() {
    const el = document.getElementById("refPreview");
    if(finalRefs.length === 0) { el.innerText = "ì°¸ì¡°ìê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
    el.innerHTML = finalRefs.map(u => `<span class="ref-step">ğŸ“¢ ${u.emp_name}</span>`).join("");
}

function resetLine(type) {
    if(type==='approver') { finalApprovers=[]; renderLinePreview(); }
    else { finalRefs=[]; renderRefPreview(); }
}

// =========================================
// [ê¸°ëŠ¥ 3] íŒŒì¼ ì—…ë¡œë“œ ë° ìƒì‹  (í•µì‹¬)
// =========================================
function updateFileList() {
    const files = document.getElementById("attachFile").files;
    const area = document.getElementById("fileListArea");
    let html = "";
    for(let i=0; i<files.length; i++) {
        html += `<div class="file-item">ğŸ“ ${files[i].name} <span class="file-size">${(files[i].size/1024).toFixed(1)} KB</span></div>`;
    }
    area.innerHTML = html;
}

async function handleDraftSubmit(e) {
    e.preventDefault();
    if (finalApprovers.length === 0) return alert("ê²°ì¬ì„ (ìƒê¸‰ì)ì„ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.");
    
    // íœ´ê°€ ì²´í¬
    const appType = document.getElementById("appTypeDisplay").value;
    let finalAmt = document.getElementById("appAmount").value || 0;
    
    if (appType === 'íœ´ê°€') {
        const days = Number(document.getElementById("leaveDaysCalc").value);
        if(days <= 0) return alert("íœ´ê°€ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
        const remain = Number(document.getElementById("remainDaysBadge").innerText);
        if(days > remain) return alert("ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        finalAmt = days; // ê¸ˆì•¡ ëŒ€ì‹  ì¼ìˆ˜ ì €ì¥
    }

    const btn = document.getElementById("btnSubmit");
    btn.disabled = true; btn.innerText = "íŒŒì¼ ì—…ë¡œë“œ ì¤‘...";

    // 1. íŒŒì¼ ì—…ë¡œë“œ (Supabase Storage -> _supabase ì‚¬ìš©)
    const fileInput = document.getElementById("attachFile");
    const uploadedUrls = [];
    
    for (let i = 0; i < fileInput.files.length; i++) {
        const file = fileInput.files[i];
        const fileName = `${Date.now()}_${file.name}`;
        
        const { data, error } = await _supabase.storage
            .from('attachments')
            .upload(fileName, file);
            
        if (error) {
            alert("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
            btn.disabled = false; btn.innerText = "ìƒì‹ í•˜ê¸°";
            return;
        }
        
        const { data: { publicUrl } } = _supabase.storage
            .from('attachments')
            .getPublicUrl(fileName);
            
        uploadedUrls.push(publicUrl);
    }

    btn.innerText = "ë¬¸ì„œ ì €ì¥ ì¤‘...";

    // 2. ê²°ì¬ì„  ë°ì´í„° êµ¬ì„±
    const approvalLineData = finalApprovers.map(u => ({
        emp_id: u.emp_id,
        name: u.emp_name,
        position: u.position,
        status: 'ëŒ€ê¸°',
        comment: '',
        processed_at: null
    }));
    
    const refData = finalRefs.map(u => ({ emp_id: u.emp_id, name: u.emp_name }));

    // 3. DB Insert (_supabase ì‚¬ìš©)
    const { error: insertError } = await _supabase.from('ref_approval').insert({
        doc_type: appType,
        title: `${appType} ì‹ ì²­ - ${myInfo.emp_name}`,
        content: document.getElementById("appDesc").value,
        amount: finalAmt,
        drafter_id: myInfo.emp_id,
        drafter_name: myInfo.emp_name,
        approval_line: approvalLineData,
        ref_line: refData, 
        file_links: uploadedUrls, 
        current_approver: finalApprovers[0].emp_id,
        status: 'ì§„í–‰ì¤‘',
        created_at: new Date()
    });

    if (insertError) {
        alert("ìƒì‹  ì˜¤ë¥˜: " + insertError.message);
        btn.disabled = false; btn.innerText = "ìƒì‹ í•˜ê¸°";
    } else {
        alert("ì„±ê³µì ìœ¼ë¡œ ìƒì‹ ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.reload();
    }
}

// =========================================
// [ê¸°ëŠ¥ 4] ê²°ì¬ ëŒ€ê¸°í•¨ & ì²˜ë¦¬
// =========================================
async function loadTodoList() {
    const el = document.getElementById("todoList");
    el.innerHTML = '<div class="text-center p-3">ë¡œë”© ì¤‘...</div>';
    
    const { data, error } = await _supabase
        .from('ref_approval')
        .select('*')
        .eq('status', 'ì§„í–‰ì¤‘')
        .eq('current_approver', myInfo.emp_id)
        .order('created_at', {ascending: false});
        
    if(error) return el.innerHTML = "ì—ëŸ¬ ë°œìƒ";
    
    renderDocs(el, data, true);
}

// =========================================
// [ê¸°ëŠ¥ 5] ë¬¸ì„œ ë³´ê´€í•¨
// =========================================
async function loadHistoryList() {
    const el = document.getElementById("historyList");
    el.innerHTML = '<div class="text-center p-3">ë¡œë”© ì¤‘...</div>';
    
    const { data } = await _supabase
        .from('ref_approval')
        .select('*')
        .eq('drafter_id', myInfo.emp_id)
        .order('created_at', {ascending: false});
        
    historyCache = data || [];
    renderDocs(el, historyCache, false);
}

function filterHistory() {
    const key = document.getElementById("searchKeyword").value.toLowerCase();
    const filtered = historyCache.filter(d => 
        d.title.toLowerCase().includes(key) || d.content.toLowerCase().includes(key)
    );
    renderDocs(document.getElementById("historyList"), filtered, false);
}

// ê³µí†µ ë Œë”ë§ í•¨ìˆ˜
function renderDocs(target, list, isTodo) {
    target.innerHTML = "";
    if(!list || list.length === 0) { target.innerHTML = '<div class="text-center p-3 text-muted">ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    
    list.forEach(doc => {
        // ê²°ì¬ì„  ì§„í–‰ìƒí™© ì‹œê°í™”
        const lineHtml = doc.approval_line.map(s => {
            let icon = s.status==='ìŠ¹ì¸' ? 'âœ…' : (s.status==='ë°˜ë ¤' ? 'â›”' : 'â¬œ');
            let style = s.status==='ìŠ¹ì¸' ? 'text-success' : (s.status==='ë°˜ë ¤' ? 'text-danger' : 'text-muted');
            return `<span class="small me-2 ${style}">${icon} ${s.name}</span>`;
        }).join("");

        // íŒŒì¼ ë§í¬
        let fileHtml = "";
        if (doc.file_links && doc.file_links.length > 0) {
            fileHtml = `<div class="mt-2 pt-2 border-top">` + 
                doc.file_links.map((url, i) => `<a href="${url}" target="_blank" class="text-decoration-none me-2">ğŸ“ ì²¨ë¶€íŒŒì¼ ${i+1}</a>`).join("") +
                `</div>`;
        }

        // ë²„íŠ¼ (ê²°ì¬í•¨ì¼ ë•Œë§Œ)
        let btnHtml = "";
        if (isTodo) {
            btnHtml = `
            <div class="mt-3 text-end">
                <button class="btn btn-sm btn-success me-1" onclick="procDoc(${doc.id}, 'ìŠ¹ì¸')">ìŠ¹ì¸</button>
                <button class="btn btn-sm btn-danger" onclick="procDoc(${doc.id}, 'ë°˜ë ¤')">ë°˜ë ¤</button>
            </div>`;
        } else {
            let badge = doc.status==='ì™„ë£Œ'?'bg-success':(doc.status==='ë°˜ë ¤'?'bg-danger':'bg-warning');
            btnHtml = `<div class="mt-2 text-end"><span class="badge ${badge}">${doc.status}</span></div>`;
        }
        
        const div = document.createElement("div");
        div.className = "list-group-item shadow-sm mb-3 border-0 p-3";
        div.innerHTML = `
            <div class="d-flex justify-content-between mb-2">
                <span class="badge bg-primary">${doc.doc_type}</span>
                <small class="text-muted">${new Date(doc.created_at).toLocaleDateString()}</small>
            </div>
            <h6 class="fw-bold mb-1">${doc.title}</h6>
            <div class="small text-muted mb-2">ê¸°ì•ˆì: ${doc.drafter_name}</div>
            <div class="bg-light p-2 rounded mb-2" style="white-space: pre-wrap; font-size: 0.9rem;">${doc.content}</div>
            <div class="small mb-1">${lineHtml}</div>
            ${fileHtml}
            ${btnHtml}
        `;
        target.appendChild(div);
    });
}

// ê²°ì¬ ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤
async function procDoc(docId, action) {
    const reason = prompt(`${action} ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):`);
    if (reason === null) return;

    // 1. ìµœì‹  ë°ì´í„° ë¡œë“œ
    const { data: doc } = await _supabase.from('ref_approval').select('*').eq('id', docId).single();
    let line = doc.approval_line;
    let nextUser = null;
    let newStatus = 'ì§„í–‰ì¤‘';

    // 2. ë‚´ ì°¨ë¡€ ì°¾ê¸°
    const idx = line.findIndex(p => p.emp_id === myInfo.emp_id);
    if (idx === -1) return alert("ê²°ì¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");

    // 3. ìƒíƒœ ì—…ë°ì´íŠ¸
    line[idx].status = action;
    line[idx].comment = reason;
    line[idx].processed_at = new Date().toISOString();

    if (action === 'ë°˜ë ¤') {
        newStatus = 'ë°˜ë ¤';
        nextUser = null;
    } else {
        if (idx + 1 < line.length) {
            nextUser = line[idx+1].emp_id;
        } else {
            newStatus = 'ì™„ë£Œ'; 
        }
    }

    // 4. ì €ì¥
    const { error } = await _supabase.from('ref_approval').update({
        approval_line: line,
        current_approver: nextUser,
        status: newStatus
    }).eq('id', docId);

    if (error) alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + error.message);
    else {
        alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadTodoList();
    }
}
</script>
</body>
</html>
