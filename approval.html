<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì „ìê²°ì¬ (Final)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; }
    .main-container { max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 30px; }
    .hidden { display: none !important; }
    
    /* ê²°ì¬ì„  ìŠ¤íƒ€ì¼ */
    .line-step { display: inline-block; background: #e3f2fd; color: #0d47a1; padding: 5px 12px; border-radius: 20px; margin-right: 5px; margin-bottom: 5px; font-size: 0.9rem; border: 1px solid #bbdefb; }
    .line-arrow { margin-right: 5px; color: #999; font-weight: bold; }
    .ref-step { display: inline-block; background: #f1f3f5; color: #495057; padding: 5px 10px; border-radius: 5px; margin-right: 5px; margin-bottom: 5px; font-size: 0.85rem; border: 1px solid #dee2e6; }
    
    .user-select-item { cursor: pointer; transition: 0.2s; }
    .user-select-item:hover { background-color: #f8f9fa; }
    .user-select-item.active { background-color: #e8f0fe; border-color: #4285f4; }
    .large-textarea { min-height: 500px; resize: vertical; line-height: 1.6; } /* ìš”ì²­í•˜ì‹  ëŒ€ë¡œ 20ì¤„ ì´ìƒ í™•ë³´ */
    
    .file-item { font-size: 0.9rem; background: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; border: 1px solid #eee; }
    .file-size { font-size: 0.8rem; color: #888; float: right; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">âš¡ ì „ìê²°ì¬ ì‹œìŠ¤í…œ</h4> 
    <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
  </div>

  <ul class="nav nav-pills nav-fill mb-4">
    <li class="nav-item"><button class="nav-link active" id="tab1" onclick="switchTab('draft')">âœï¸ ê¸°ì•ˆ ì‘ì„±</button></li>
    <li class="nav-item"><button class="nav-link" id="tab2" onclick="switchTab('todo')">ğŸ“¬ ê²°ì¬ ëŒ€ê¸°í•¨</button></li>
    <li class="nav-item"><button class="nav-link" id="tab3" onclick="switchTab('history')">ğŸ—‚ï¸ ë¬¸ì„œ ë³´ê´€í•¨</button></li>
  </ul>

  <div id="view-draft">
    <form id="draftForm" onsubmit="handleDraftSubmit(event)">
      
      <div class="row mb-3">
        <div class="col-12 mb-3">
          <label class="small text-muted fw-bold">ê²°ì¬ êµ¬ë¶„</label>
          <select class="form-select" id="appCategory" onchange="handleCategoryChange()">
            <optgroup label="ì¸ì‚¬/ê·¼íƒœ">
                <option value="íœ´ê°€">ğŸ–ï¸ íœ´ê°€ ì‹ ì²­</option>
                <option value="ë¶€ì–‘ê°€ì¡±">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ì–‘ê°€ì¡± ë“±ì¬/í•´ì œ ì‹ ì²­</option>
            </optgroup>
            <optgroup label="íšŒê³„/ì§€ì¶œ">
                <option value="ì§€ì¶œê²°ì˜">ğŸ’° ì§€ì¶œê²°ì˜ì„œ</option>
                <option value="ì¼ë°˜í’ˆì˜">ğŸ“„ ì¼ë°˜í’ˆì˜ì„œ</option>
            </optgroup>
          </select>
        </div>

        <div class="col-12 hidden mb-3" id="divLeaveType">
            <label class="small text-muted fw-bold">íœ´ê°€ ì¢…ë¥˜</label>
            <select class="form-select" id="leaveTypeSelect">
                <option value="ì—°ì°¨">ğŸŸ¢ ì—°ì°¨ (ì”ì—¬ ì—°ì°¨ ì°¨ê°)</option>
                <option value="ë°˜ì°¨">ğŸŒ— ë°˜ì°¨ (0.5ì¼ ì°¨ê°)</option>
                <option value="ê²½ì¡°ì‚¬">ğŸ’ ê²½ì¡°ì‚¬ (ì°¨ê° ì•ˆ í•¨)</option>
                <option value="ë³‘ê°€">ğŸ¥ ë³‘ê°€ (ì°¨ê° ì•ˆ í•¨)</option>
                <option value="ìƒë¦¬íœ´ê°€">ğŸŒ¸ ìƒë¦¬íœ´ê°€ (ë³´ê±´, ì°¨ê° ì•ˆ í•¨)</option>
                <option value="ì˜ˆë¹„êµ°">ğŸª– ì˜ˆë¹„êµ°/ë¯¼ë°©ìœ„ (ê³µê°€, ì°¨ê° ì•ˆ í•¨)</option>
                <option value="ë¬´ê¸‰íœ´ê°€">âš ï¸ ë¬´ê¸‰íœ´ê°€ (ê¸‰ì—¬ ì°¨ê° ëŒ€ìƒ)</option>
            </select>
        </div>

        <div class="col-12 hidden mb-3" id="divDependentOption">
            <label class="small text-muted fw-bold">ì‹ ì²­ êµ¬ë¶„</label>
            <div class="d-flex gap-2">
                <input type="radio" class="btn-check" name="depOption" id="depAdd" value="add" checked onchange="updateDepTemplate()">
                <label class="btn btn-outline-primary flex-fill" for="depAdd">â• ë“±ì¬ ì‹ ì²­</label>
                
                <input type="radio" class="btn-check" name="depOption" id="depRemove" value="remove" onchange="updateDepTemplate()">
                <label class="btn btn-outline-danger flex-fill" for="depRemove">â– í•´ì œ ì‹ ì²­</label>
            </div>
        </div>

        <div class="col-12" id="divAmount">
          <label class="small text-muted" id="amountLabel">ê¸ˆì•¡ (ì›)</label>
          <input type="number" class="form-control" id="appAmount" placeholder="0">
        </div>

        <div class="col-12 hidden" id="divLeaveSection">
          <div class="p-3 bg-light border rounded">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-bold">ğŸ“… ê¸°ê°„ ì„ íƒ</span>
              <span class="badge bg-primary">ì”ì—¬ ì—°ì°¨: <span id="remainDaysBadge">ì¡°íšŒì¤‘...</span>ì¼</span>
            </div>
            <div class="input-group mb-2">
              <input type="date" class="form-control" id="leaveStart" onchange="calcLeaveDays()">
              <span class="input-group-text">~</span>
              <input type="date" class="form-control" id="leaveEnd" onchange="calcLeaveDays()">
            </div>
            <div class="text-end small text-muted">
              ì‹ ì²­ ì¼ìˆ˜: <span id="leaveDaysBadge" class="fw-bold text-dark">0ì¼</span>
              <input type="hidden" id="leaveDaysCalc" value="0">
            </div>
            <div class="text-danger small mt-1 hidden" id="leaveOverMsg">â›” ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!</div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted fw-bold">ê²°ì¬ì„  (í•„ìˆ˜)</label>
        <div class="card p-3 border-0 bg-light mb-2">
          <div id="linePreview" class="mb-2 text-muted small">ê²°ì¬ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openUserModal('approver')">â• ê²°ì¬ì ì„ íƒ</button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="resetLine('approver')">â†º ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted">ì°¸ì¡°ì (ì„ íƒ)</label>
        <div class="card p-3 border-0 bg-light">
          <div id="refPreview" class="mb-2 text-muted small">ì°¸ì¡°ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openUserModal('referrer')">â• ì°¸ì¡°ì ì„ íƒ</button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="resetLine('referrer')">â†º ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted">ë‚´ìš©</label>
        <textarea class="form-control large-textarea" id="appDesc" placeholder="ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”." required rows="20"></textarea>
      </div>

      <div class="mb-4">
        <label class="small text-muted">ì¦ë¹™ ì²¨ë¶€ <span id="fileHelp" class="text-danger small hidden">(ê°€ì¡±ê´€ê³„ì¦ëª…ì„œ í•„ìˆ˜)</span></label>
        <input type="file" class="form-control" id="attachFile" multiple onchange="updateFileList()">
        <div id="fileListArea" class="mt-2"></div>
      </div>

      <button type="submit" class="btn btn-primary w-100 py-3 fw-bold btn-lg" id="btnSubmit">ìƒì‹ í•˜ê¸°</button>
    </form>
  </div>

  <div id="view-todo" class="hidden"><div id="todoList" class="list-group"></div></div>
  <div id="view-history" class="hidden">
    <div class="input-group mb-3"><input type="text" class="form-control" id="searchKeyword" placeholder="ê²€ìƒ‰" onkeyup="filterHistory()"><button class="btn btn-outline-secondary">ğŸ”</button></div>
    <div id="historyList" class="list-group"></div>
  </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-light"><h6 class="modal-title fw-bold" id="modalTitle">ì§ì› ì„ íƒ</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="list-group list-group-flush" id="userSelectList"></div></div><div class="modal-footer justify-content-between"><span class="small text-muted ms-2"><span id="selCount">0</span>ëª… ì„ íƒë¨</span><button type="button" class="btn btn-primary" onclick="confirmSelection()">ì„ íƒ ì™„ë£Œ</button></div></div></div></div>
<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body text-center py-4" id="alertBody"></div><div class="modal-footer justify-content-center p-1 border-0"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let myInfo = null;
let allUsers = [];
let modalInstance, alertModalInstance;
let modalType = ''; 
let tempSelection = [], finalApprovers = [], finalRefs = [], historyCache = [];

window.onload = async function() {
    modalInstance = new bootstrap.Modal(document.getElementById('userModal'));
    alertModalInstance = new bootstrap.Modal(document.getElementById('alertModal'));
    
    const stored = localStorage.getItem('erp_user');
    if (!stored) { location.href = 'index.html'; return; }
    myInfo = JSON.parse(stored);

    // [ë¡œì§] ì§ì› ëª©ë¡ ë¡œë“œ (1ê¸‰ ì´ì‚¬ì¥ -> 9ê¸‰ ì‚¬ì›)
    const { data } = await _supabase.from('ref_employees').select('*').order('auth_level', {ascending: true});
    if(data) allUsers = data;

    // [ë¡œì§] ì—°ì°¨ ê³„ì‚° (ì¤‘ì•™í™”ëœ DB í•¨ìˆ˜ í˜¸ì¶œ)
    const { data: remain } = await _supabase.rpc('calculate_leave_days', { p_emp_id: myInfo.emp_id });
    document.getElementById("remainDaysBadge").innerText = (remain !== null) ? remain : "0";

    handleCategoryChange(); // UI ì´ˆê¸°í™”
};

function showAlert(msg) { document.getElementById("alertBody").innerHTML = msg; alertModalInstance.show(); }

function switchTab(tab) {
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    if(tab==='draft') { document.getElementById('view-draft').classList.remove('hidden'); document.getElementById('tab1').classList.add('active'); }
    else if(tab==='todo') { document.getElementById('view-todo').classList.remove('hidden'); document.getElementById('tab2').classList.add('active'); loadTodoList(); }
    else { document.getElementById('view-history').classList.remove('hidden'); document.getElementById('tab3').classList.add('active'); loadHistoryList(); }
}

// [ê¸°ëŠ¥] ì¹´í…Œê³ ë¦¬ ë³€ê²½ í•¸ë“¤ëŸ¬
function handleCategoryChange() {
    const type = document.getElementById("appCategory").value;
    const desc = document.getElementById("appDesc");
    const amtLabel = document.getElementById("amountLabel");
    const amountInput = document.getElementById("appAmount");
    const fileHelp = document.getElementById("fileHelp");
    const divLeave = document.getElementById("divLeaveSection");
    const divLeaveType = document.getElementById("divLeaveType");
    const divDep = document.getElementById("divDependentOption");
    const divAmt = document.getElementById("divAmount");

    // ì´ˆê¸°í™”
    divLeave.classList.add("hidden");
    divLeaveType.classList.add("hidden");
    divDep.classList.add("hidden");
    divAmt.classList.remove("hidden");
    fileHelp.classList.add("hidden");
    amtLabel.innerText = "ê¸ˆì•¡ (ì›)";
    amountInput.placeholder = "0";

    if (type === 'íœ´ê°€') {
        divLeave.classList.remove("hidden");
        divLeaveType.classList.remove("hidden");
        divAmt.classList.add("hidden");
        desc.value = "ìœ„ì™€ ê°™ì´ íœ´ê°€ë¥¼ ì‹ ì²­í•˜ì˜¤ë‹ˆ ì¬ê°€í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.";
    } 
    else if (type === 'ë¶€ì–‘ê°€ì¡±') {
        divDep.classList.remove("hidden");
        amtLabel.innerText = "ë³€ë™ ì¸ì› (ëª…)";
        amountInput.placeholder = "ì˜ˆ: 1";
        amountInput.value = "1";
        fileHelp.classList.remove("hidden");
        updateDepTemplate();
    } 
    else {
        // ì¼ë°˜, ì§€ì¶œê²°ì˜
        if(desc.value.includes("íœ´ê°€ë¥¼ ì‹ ì²­") || desc.value.includes("ë¶€ì–‘ê°€ì¡±")) desc.value = "";
    }
}

// [ê¸°ëŠ¥] ë¶€ì–‘ê°€ì¡± í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
function updateDepTemplate() {
    const mode = document.querySelector('input[name="depOption"]:checked').value;
    const desc = document.getElementById("appDesc");
    const actionText = mode === 'add' ? "ë“±ì¬" : "í•´ì œ";
    desc.value = `[ë¶€ì–‘ê°€ì¡± ${actionText} ì‹ ì²­]\n\n1. ëŒ€ìƒì ì„±ëª… : \n2. ê´€ê³„ : \n3. ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸(ì•ìë¦¬) : \n4. ë³€ë™ ì‚¬ìœ  : \n\n--------------------------------\nìœ„ì™€ ê°™ì´ ê°€ì¡±ìˆ˜ë‹¹ ì§€ê¸‰ ë° ê³µì œ ëŒ€ìƒì ë³€ê²½ì„ ì‹ ì²­í•©ë‹ˆë‹¤.`;
}

// [ë¡œì§] ì£¼ë§ ì œì™¸ íœ´ê°€ì¼ìˆ˜ ê³„ì‚°
function calcLeaveDays() {
    const s = document.getElementById("leaveStart").value;
    const e = document.getElementById("leaveEnd").value;
    if (!s || !e) return;

    let count = 0;
    let cur = new Date(s);
    const end = new Date(e);
    while (cur <= end) {
        const day = cur.getDay();
        if (day !== 0 && day !== 6) count++;
        cur.setDate(cur.getDate() + 1);
    }
    
    // ë°˜ì°¨ë©´ 0.5ì¼
    const lType = document.getElementById("leaveTypeSelect").value;
    if(lType === 'ë°˜ì°¨') count = 0.5;

    document.getElementById("leaveDaysBadge").innerText = count + "ì¼";
    document.getElementById("leaveDaysCalc").value = count;
    
    // ì”ì—¬ ì—°ì°¨ ë¹„êµ (ì—°ì°¨, ë°˜ì°¨ì¼ ë•Œë§Œ)
    if(lType === 'ì—°ì°¨' || lType === 'ë°˜ì°¨') {
        const remain = Number(document.getElementById("remainDaysBadge").innerText);
        const msg = document.getElementById("leaveOverMsg");
        if(count > remain) msg.classList.remove("hidden"); else msg.classList.add("hidden");
    }
}

// [ê¸°ëŠ¥] ì§ì› ì„ íƒ ëª¨ë‹¬ (í•„í„° ì ìš©)
function openUserModal(type) {
    modalType = type;
    document.getElementById("modalTitle").innerText = (type === 'approver') ? "ê²°ì¬ì ì„ íƒ" : "ì°¸ì¡°ì ì„ íƒ";
    tempSelection = (type === 'approver') ? [...finalApprovers] : [...finalRefs];
    renderUserList();
    modalInstance.show();
}

function renderUserList() {
    const listEl = document.getElementById("userSelectList");
    listEl.innerHTML = "";
    
    // ë‚˜ë³´ë‹¤ ì§ê¸‰ ë‚®ì€ ì‚¬ëŒ(ìˆ«ìê°€ í° ì‚¬ëŒ)ì€ ì œì™¸í•˜ê³ , ë‚˜ ìì‹ ë„ ì œì™¸
    // auth_level: 1(ë†’ìŒ) ~ 9(ë‚®ìŒ). 
    // ê²°ì¬ì ì„ íƒ ì‹œ: ë‚˜(ì˜ˆ:5ê¸‰)ëŠ” 1~4ê¸‰ë§Œ ì„ íƒ ê°€ëŠ¥. ì¦‰ u.auth_level < myInfo.auth_level
    const myLevel = myInfo.auth_level || 99;

    let targets = allUsers.filter(u => u.emp_id !== myInfo.emp_id);
    
    if (modalType === 'approver') {
        // [í•„í„°] ë‚˜ë³´ë‹¤ ë†’ì€ ì‚¬ëŒë§Œ ë³´ì´ê¸° (ìˆ«ìê°€ ì‘ì€ ì‚¬ëŒ)
        targets = targets.filter(u => u.auth_level < myLevel);
    } else {
        // [í•„í„°] ì°¸ì¡°ìëŠ” ì´ë¯¸ ê²°ì¬ì„ ì— ìˆëŠ” ì‚¬ëŒ ì œì™¸
        targets = targets.filter(u => !finalApprovers.some(a => a.emp_id === u.emp_id));
    }

    if(targets.length === 0) { listEl.innerHTML = '<div class="p-3 text-center text-muted">ì„ íƒ ê°€ëŠ¥í•œ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

    targets.forEach(u => {
        const isSelected = tempSelection.some(s => s.emp_id === u.emp_id);
        const a = document.createElement("a");
        a.className = `list-group-item list-group-item-action user-select-item d-flex justify-content-between ${isSelected ? 'active' : ''}`;
        a.innerHTML = `<div><span class="badge bg-secondary me-2">${u.position}</span>${u.emp_name} <small class="text-muted">(${u.department||'-'})</small></div>${isSelected?'âœ…':''}`;
        a.onclick = () => toggleSelect(u);
        listEl.appendChild(a);
    });
    document.getElementById("selCount").innerText = tempSelection.length;
}

function toggleSelect(user) {
    const idx = tempSelection.findIndex(s => s.emp_id === user.emp_id);
    if (idx > -1) tempSelection.splice(idx, 1); else tempSelection.push(user);
    renderUserList();
}

function confirmSelection() {
    if (modalType === 'approver') {
        finalApprovers = [...tempSelection];
    } else {
        finalRefs = [...tempSelection];
    }
    modalType==='approver' ? renderLinePreview() : renderRefPreview();
    modalInstance.hide();
}

function renderLinePreview() {
    const el = document.getElementById("linePreview");
    if(finalApprovers.length === 0) { el.innerText = "ê²°ì¬ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."; return; }
    // í™”ë©´ í‘œì‹œìš© ì •ë ¬ì€ í•˜ì§€ ì•Šê³  ì„ íƒ ìˆœì„œ ë³´ì—¬ì£¼ê±°ë‚˜, ì•„ë‹ˆë©´ ì—¬ê¸°ì„œë„ ì •ë ¬í•´ì„œ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŒ.
    // ì—¬ê¸°ì„œëŠ” ìƒì‹  ì‹œ ìë™ ì •ë ¬í•˜ë¯€ë¡œ, í™”ë©´ì—ì„  ì§ê´€ì ìœ¼ë¡œ ë³´ì—¬ì¤Œ.
    el.innerHTML = finalApprovers.map((u, i) => `<span class="line-step">${u.emp_name} ${u.position}</span>` + (i < finalApprovers.length-1 ? '<span class="line-arrow">â¡</span>' : '')).join("");
}

function renderRefPreview() {
    const el = document.getElementById("refPreview");
    if(finalRefs.length === 0) { el.innerText = "ì°¸ì¡°ìê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
    el.innerHTML = finalRefs.map(u => `<span class="ref-step">ğŸ“¢ ${u.emp_name}</span>`).join("");
}
function resetLine(type) { if(type==='approver') { finalApprovers=[]; renderLinePreview(); } else { finalRefs=[]; renderRefPreview(); } }

// [í•µì‹¬] ìƒì‹  (ìë™ ì •ë ¬ + íŒŒì¼ ì²¨ë¶€ + DB ì €ì¥)
async function handleDraftSubmit(e) {
    e.preventDefault();
    if (finalApprovers.length === 0) return showAlert("ê²°ì¬ì„ ì„ ì§€ì •í•´ì£¼ì„¸ìš”.");

    const mainType = document.getElementById("appCategory").value;
    let subType = mainType; 
    let finalAmt = document.getElementById("appAmount").value || 0;
    let title = "";

    // 1. ë¬¸ì„œ íƒ€ì… ë° ê°’ ì •ë¦¬
    if (mainType === 'íœ´ê°€') {
        const lType = document.getElementById("leaveTypeSelect").value; // ì—°ì°¨, ë°˜ì°¨, ë¬´ê¸‰ ë“±
        subType = `íœ´ê°€(${lType})`; // ì˜ˆ: "íœ´ê°€(ë¬´ê¸‰íœ´ê°€)", "íœ´ê°€(ì—°ì°¨)"
        
        const days = Number(document.getElementById("leaveDaysCalc").value);
        if(days <= 0) return showAlert("ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
        
        // ì—°ì°¨/ë°˜ì°¨ë§Œ ì”ì—¬ëŸ‰ ì²´í¬
        if (lType === 'ì—°ì°¨' || lType === 'ë°˜ì°¨') {
            const remain = Number(document.getElementById("remainDaysBadge").innerText);
            if(days > remain) return showAlert("ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        }
        finalAmt = days;
        title = `${lType} ì‹ ì²­ - ${myInfo.emp_name}`;
    } 
    else if (mainType === 'ë¶€ì–‘ê°€ì¡±') {
        const mode = document.querySelector('input[name="depOption"]:checked').value; // add or remove
        const modeTxt = mode === 'add' ? 'ë“±ì¬' : 'í•´ì œ';
        subType = `ë¶€ì–‘ê°€ì¡±(${mode})`; // "ë¶€ì–‘ê°€ì¡±(add)"
        
        if(document.getElementById("attachFile").files.length === 0) return showAlert("ì¦ë¹™ì„œë¥˜ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        
        // í•´ì œë©´ ë§ˆì´ë„ˆìŠ¤ ì²˜ë¦¬
        if (mode === 'remove') finalAmt = -Math.abs(finalAmt);
        title = `ë¶€ì–‘ê°€ì¡± ${modeTxt} ì‹ ì²­ - ${myInfo.emp_name}`;
    }
    else {
        title = `${mainType} - ${myInfo.emp_name}`;
    }

    // 2. [ìë™ ì •ë ¬] ê²°ì¬ì„ : ì§ê¸‰ ì—­ìˆœ (í•˜ê¸‰ì -> ìƒê¸‰ì)
    // auth_level ìˆ«ìê°€ í° ì‚¬ëŒ(ë‚®ì€ ì§ê¸‰) -> ì‘ì€ ì‚¬ëŒ(ë†’ì€ ì§ê¸‰)
    // ì˜ˆ: ê³¼ì¥(5) -> ì´ì‚¬(2) -> ì´ì‚¬ì¥(1)
    finalApprovers.sort((a, b) => b.auth_level - a.auth_level);

    const btn = document.getElementById("btnSubmit");
    btn.disabled = true; btn.innerText = "ì²˜ë¦¬ ì¤‘...";

    // 3. íŒŒì¼ ì—…ë¡œë“œ
    const fileInput = document.getElementById("attachFile");
    const uploadedUrls = [];
    for (let i = 0; i < fileInput.files.length; i++) {
        const file = fileInput.files[i];
        const safeName = `${crypto.randomUUID()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
        const { data, error } = await _supabase.storage.from('attachments').upload(safeName, file);
        if (error) { showAlert("íŒŒì¼ ì˜¤ë¥˜: "+error.message); btn.disabled=false; return; }
        const { data: { publicUrl } } = _supabase.storage.from('attachments').getPublicUrl(safeName);
        uploadedUrls.push(publicUrl);
    }

    // 4. DB ì €ì¥
    const approvalLineData = finalApprovers.map(u => ({ emp_id: u.emp_id, name: u.emp_name, position: u.position, status: 'ëŒ€ê¸°', comment: '', processed_at: null }));
    const refData = finalRefs.map(u => ({ emp_id: u.emp_id, name: u.emp_name }));

    const { error } = await _supabase.from('ref_approval').insert({
        doc_type: subType, // "íœ´ê°€(ë¬´ê¸‰íœ´ê°€)", "ë¶€ì–‘ê°€ì¡±(add)" ë“± ìƒì„¸ íƒ€ì… ì €ì¥
        title: title,
        content: document.getElementById("appDesc").value,
        amount: Number(finalAmt),
        drafter_id: myInfo.emp_id,
        drafter_name: myInfo.emp_name,
        approval_line: approvalLineData,
        ref_line: refData, 
        file_links: uploadedUrls, 
        current_approver: finalApprovers[0].emp_id, // ì •ë ¬ëœ ì²« ë²ˆì§¸ ì‚¬ëŒ
        status: 'ì§„í–‰ì¤‘',
        created_at: new Date()
    });

    if (error) { showAlert("ìƒì‹  ì‹¤íŒ¨: " + error.message); btn.disabled = false; }
    else { showAlert("ìƒì‹ ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
}

// [í•µì‹¬] ê²°ì¬ ì²˜ë¦¬ (ë¶€ì–‘ê°€ì¡± ë°˜ì˜)
async function procDoc(docId, action) {
    const reason = prompt(`${action} ì‚¬ìœ  (ì„ íƒ):`);
    if (reason === null) return;

    const { data: doc } = await _supabase.from('ref_approval').select('*').eq('id', docId).single();
    let line = doc.approval_line;
    let nextUser = null;
    let newStatus = 'ì§„í–‰ì¤‘';

    const idx = line.findIndex(p => p.emp_id === myInfo.emp_id);
    if (idx === -1) return showAlert("ê¶Œí•œ ì—†ìŒ");
    if (idx > 0 && line[idx-1].status !== 'ìŠ¹ì¸') return showAlert("ì´ì „ ê²°ì¬ìê°€ ì²˜ë¦¬ ì•ˆ í•¨");

    line[idx].status = action;
    line[idx].comment = reason;
    line[idx].processed_at = new Date().toISOString();

    if (action === 'ë°˜ë ¤') {
        newStatus = 'ë°˜ë ¤';
        nextUser = null;
    } else {
        if (idx + 1 < line.length) nextUser = line[idx+1].emp_id;
        else newStatus = 'ì™„ë£Œ'; 
    }

    // [ë¶€ì–‘ê°€ì¡± ìë™ ë°˜ì˜]
    if (doc.doc_type.startsWith('ë¶€ì–‘ê°€ì¡±') && newStatus === 'ì™„ë£Œ') {
        const changeVal = Number(doc.amount); // ì´ë¯¸ +1 ë˜ëŠ” -1ë¡œ ì €ì¥ë˜ì–´ ìˆìŒ
        const drafterId = doc.drafter_id;
        const { data: empData } = await _supabase.from('ref_employees').select('dependents').eq('emp_id', drafterId).single();
        if(empData) {
            const current = empData.dependents || 0;
            // 0ëª… ë¯¸ë§Œìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šê²Œ ë°©ì–´
            const newVal = Math.max(0, current + changeVal);
            await _supabase.from('ref_employees').update({ dependents: newVal }).eq('emp_id', drafterId);
        }
    }

    await _supabase.from('ref_approval').update({ approval_line: line, current_approver: nextUser, status: newStatus }).eq('id', docId);
    showAlert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); loadTodoList();
}

async function loadTodoList() {
    const el = document.getElementById("todoList");
    el.innerHTML = 'loading...';
    const { data } = await _supabase.from('ref_approval').select('*').eq('status', 'ì§„í–‰ì¤‘').eq('current_approver', myInfo.emp_id).order('created_at', {ascending: false});
    renderDocs(el, data, true);
}
async function loadHistoryList() {
    const el = document.getElementById("historyList");
    el.innerHTML = 'loading...';
    const { data } = await _supabase.from('ref_approval').select('*').eq('drafter_id', myInfo.emp_id).order('created_at', {ascending: false});
    historyCache = data || [];
    renderDocs(el, historyCache, false);
}
function filterHistory() {
    const key = document.getElementById("searchKeyword").value.toLowerCase();
    const filtered = historyCache.filter(d => d.title.toLowerCase().includes(key));
    renderDocs(document.getElementById("historyList"), filtered, false);
}
function renderDocs(target, list, isTodo) {
    target.innerHTML = "";
    if(!list || list.length===0) { target.innerHTML = '<div class="p-3 text-center text-muted">ì—†ìŒ</div>'; return; }
    list.forEach(doc => {
        const lineHtml = doc.approval_line.map(s => `<span class="small me-2 ${s.status==='ìŠ¹ì¸'?'text-success':(s.status==='ë°˜ë ¤'?'text-danger':'text-muted')}">${s.status==='ìŠ¹ì¸'?'âœ…':(s.status==='ë°˜ë ¤'?'â›”':'â¬œ')} ${s.name}</span>`).join("");
        let btn = isTodo ? `<div class="mt-2 text-end"><button class="btn btn-sm btn-success me-1" onclick="procDoc(${doc.id},'ìŠ¹ì¸')">ìŠ¹ì¸</button><button class="btn btn-sm btn-danger" onclick="procDoc(${doc.id},'ë°˜ë ¤')">ë°˜ë ¤</button></div>` : `<div class="mt-2 text-end"><span class="badge ${doc.status==='ì™„ë£Œ'?'bg-success':(doc.status==='ë°˜ë ¤'?'bg-danger':'bg-warning')}">${doc.status}</span></div>`;
        target.innerHTML += `<div class="list-group-item shadow-sm mb-3 border-0 p-3"><div class="d-flex justify-content-between mb-2"><span class="badge bg-primary">${doc.doc_type}</span><small class="text-muted">${doc.created_at.slice(0,10)}</small></div><h6 class="fw-bold">${doc.title}</h6><div class="small mb-2">${lineHtml}</div>${btn}</div>`;
    });
}
function updateFileList() { document.getElementById("fileListArea").innerHTML = Array.from(document.getElementById("attachFile").files).map(f => `<div class="file-item">ğŸ“ ${f.name}</div>`).join(""); }
</script>
</body>
</html>
