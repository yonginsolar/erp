<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì „ìê²°ì¬ (Final)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; }
    .main-container { max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 30px; }
    .hidden { display: none !important; }
    
    /* ê²°ì¬ì„  ìŠ¤íƒ€ì¼ */
    .line-step { display: inline-block; background: #e3f2fd; color: #0d47a1; padding: 5px 12px; border-radius: 20px; margin-right: 5px; margin-bottom: 5px; font-size: 0.9rem; border: 1px solid #bbdefb; }
    .line-arrow { margin-right: 5px; color: #999; font-weight: bold; }
    .ref-step { display: inline-block; background: #f1f3f5; color: #495057; padding: 5px 10px; border-radius: 5px; margin-right: 5px; margin-bottom: 5px; font-size: 0.85rem; border: 1px solid #dee2e6; }
    
    /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .user-select-item { cursor: pointer; transition: 0.2s; }
    .user-select-item:hover { background-color: #f8f9fa; }
    .user-select-item.active { background-color: #e8f0fe; border-color: #4285f4; }
    .large-textarea { min-height: 300px; resize: vertical; line-height: 1.6; }
    
    /* íŒŒì¼ ëª©ë¡ */
    .file-item { font-size: 0.9rem; background: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; border: 1px solid #eee; }
    .file-size { font-size: 0.8rem; color: #888; float: right; }
  </style>
</head>
<body>

<div class="main-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0">âš¡ ì „ìê²°ì¬ ì‹œìŠ¤í…œ</h4> 
    <button class="btn btn-outline-secondary btn-sm" onclick="location.href='index.html'">ğŸ  ë©”ë‰´ë¡œ</button>
  </div>

  <ul class="nav nav-pills nav-fill mb-4">
    <li class="nav-item"><button class="nav-link active" id="tab1" onclick="switchTab('draft')">âœï¸ ê¸°ì•ˆ ì‘ì„±</button></li>
    <li class="nav-item"><button class="nav-link" id="tab2" onclick="switchTab('todo')">ğŸ“¬ ê²°ì¬ ëŒ€ê¸°í•¨</button></li>
    <li class="nav-item"><button class="nav-link" id="tab3" onclick="switchTab('history')">ğŸ—‚ï¸ ë¬¸ì„œ ë³´ê´€í•¨</button></li>
  </ul>

  <div id="view-draft">
    <form id="draftForm" onsubmit="handleDraftSubmit(event)">
      
      <div class="row mb-3">
        <div class="col-12 mb-3">
          <label class="small text-muted fw-bold">ê²°ì¬ êµ¬ë¶„</label>
          <select class="form-select" id="appTypeDisplay" onchange="handleCategoryChange(this)">
            <option value="ì§€ì¶œê²°ì˜">ğŸ’° ì§€ì¶œê²°ì˜ì„œ</option>
            <option value="ì¼ë°˜í’ˆì˜">ğŸ“„ ì¼ë°˜í’ˆì˜ì„œ</option>
            <option value="íœ´ê°€">ğŸ–ï¸ íœ´ê°€(ê·¼íƒœ)</option>
            <option value="ë¶€ì–‘ê°€ì¡±">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ì–‘ê°€ì¡± ë“±ì¬ ì‹ ì²­</option>
          </select>
        </div>

        <div class="col-12" id="divAmount">
          <label class="small text-muted" id="amountLabel">ê¸ˆì•¡ (ì›)</label>
          <input type="number" class="form-control" id="appAmount" placeholder="0">
        </div>

        <div class="col-12 hidden" id="divLeaveSection">
          <div class="p-3 bg-light border rounded">
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-bold">ğŸ“… íœ´ê°€ ê¸°ê°„ ì„ íƒ</span>
              <span class="badge bg-primary">ì”ì—¬ ì—°ì°¨: <span id="remainDaysBadge">ê³„ì‚°ì¤‘...</span>ì¼</span>
            </div>
            <div class="input-group mb-2">
              <input type="date" class="form-control" id="leaveStart" onchange="calcLeaveDays()">
              <span class="input-group-text">~</span>
              <input type="date" class="form-control" id="leaveEnd" onchange="calcLeaveDays()">
            </div>
            <div class="text-end small text-muted">
              ì‹ ì²­ ì¼ìˆ˜: <span id="leaveDaysBadge" class="fw-bold text-dark">0ì¼</span>
              <input type="hidden" id="leaveDaysCalc" value="0">
            </div>
            <div class="text-danger small mt-1 hidden" id="leaveOverMsg">â›” ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!</div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted fw-bold">ê²°ì¬ì„  (í•„ìˆ˜)</label>
        <div class="card p-3 border-0 bg-light mb-2">
          <div id="linePreview" class="mb-2 text-muted small">ê²°ì¬ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openUserModal('approver')">â• ê²°ì¬ì ì„ íƒ</button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="resetLine('approver')">â†º ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted">ì°¸ì¡°ì (ì„ íƒ)</label>
        <div class="card p-3 border-0 bg-light">
          <div id="refPreview" class="mb-2 text-muted small">ì°¸ì¡°ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openUserModal('referrer')">â• ì°¸ì¡°ì ì„ íƒ</button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick="resetLine('referrer')">â†º ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="small text-muted">ë‚´ìš©</label>
        <textarea class="form-control large-textarea" id="appDesc" placeholder="ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”." required></textarea>
      </div>

      <div class="mb-4">
        <label class="small text-muted">ì¦ë¹™ ì²¨ë¶€ <span id="fileHelp" class="text-danger small hidden">(ê°€ì¡±ê´€ê³„ì¦ëª…ì„œ í•„ìˆ˜)</span></label>
        <input type="file" class="form-control" id="attachFile" multiple onchange="updateFileList()">
        <div id="fileListArea" class="mt-2"></div>
      </div>

      <button type="submit" class="btn btn-primary w-100 py-3 fw-bold btn-lg" id="btnSubmit">ìƒì‹ í•˜ê¸°</button>
    </form>
  </div>

  <div id="view-todo" class="hidden">
    <div id="todoList" class="list-group"></div>
  </div>

  <div id="view-history" class="hidden">
    <div class="input-group mb-3">
        <input type="text" class="form-control" id="searchKeyword" placeholder="ì œëª©, ê¸°ì•ˆì ê²€ìƒ‰" onkeyup="filterHistory()">
        <button class="btn btn-outline-secondary">ğŸ”</button>
    </div>
    <div id="historyList" class="list-group"></div>
  </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h6 class="modal-title fw-bold" id="modalTitle">ì§ì› ì„ íƒ</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group list-group-flush" id="userSelectList">
                    <div class="text-center p-4 text-muted">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <span class="small text-muted ms-2"><span id="selCount">0</span>ëª… ì„ íƒë¨</span>
                <button type="button" class="btn btn-primary" onclick="confirmSelection()">ì„ íƒ ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body text-center py-4" id="alertBody"></div><div class="modal-footer justify-content-center p-1 border-0"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let myInfo = null;
let allUsers = [];
let modalInstance, alertModalInstance;
let modalType = ''; 
let tempSelection = [];
let finalApprovers = [];
let finalRefs = [];
let historyCache = [];

window.onload = async function() {
    modalInstance = new bootstrap.Modal(document.getElementById('userModal'));
    alertModalInstance = new bootstrap.Modal(document.getElementById('alertModal'));
    
    const stored = localStorage.getItem('erp_user');
    if (!stored) { location.href = 'index.html'; return; }
    myInfo = JSON.parse(stored);

    // [ìˆ˜ì •] 1ì´ ë†’ì€ ì§ê¸‰ì´ë¯€ë¡œ 'ì˜¤ë¦„ì°¨ìˆœ(ascending: true)'ìœ¼ë¡œ ì •ë ¬í•´ì•¼ 1->9 ìˆœì„œë¡œ ë‚˜ì˜´
    const { data, error } = await _supabase
        .from('ref_employees')
        .select('emp_id, emp_name, position, department, auth_level')
        .order('auth_level', {ascending: true}); // 1(ì´ì‚¬ì¥) -> 9(ì‚¬ì›)

    if(data) allUsers = data;
    else console.error("Load Error:", error);

    calculateLeave(); // ì—°ì°¨ ê³„ì‚° ì‹¤í–‰
};

function showAlert(msg) { document.getElementById("alertBody").innerHTML = msg; alertModalInstance.show(); }

function switchTab(tab) {
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));

    if (tab === 'draft') {
        document.getElementById('tab1').classList.add('active');
        document.getElementById('view-draft').classList.remove('hidden');
    } else if (tab === 'todo') {
        document.getElementById('tab2').classList.add('active');
        document.getElementById('view-todo').classList.remove('hidden');
        loadTodoList();
    } else {
        document.getElementById('tab3').classList.add('active');
        document.getElementById('view-history').classList.remove('hidden');
        loadHistoryList();
    }
}

// [í•µì‹¬] ë§ˆì´í˜ì´ì§€ ë¡œì§ ì´ì‹: íšŒê³„ì—°ë„ ê¸°ì¤€ ì‹¤ì‹œê°„ ì—°ì°¨ ê³„ì‚°
async function calculateLeave() {
    const { data: emp } = await _supabase.from('ref_employees').select('hire_date').eq('emp_id', myInfo.emp_id).single();
    if(!emp || !emp.hire_date) {
        document.getElementById("remainDaysBadge").innerText = "0"; return;
    }

    const joinDate = new Date(emp.hire_date);
    const now = new Date();
    
    // 1. ì…ì‚¬ 1ë…„ ë¯¸ë§Œ ì›” ë‹¨ìœ„ ë°œìƒë¶„ (ìµœëŒ€ 11ê°œ)
    const diffMonths = (now.getFullYear() - joinDate.getFullYear()) * 12 + (now.getMonth() - joinDate.getMonth());
    const isDayPassed = now.getDate() >= joinDate.getDate();
    const totalFullMonths = isDayPassed ? diffMonths : diffMonths - 1;
    const firstYearLeave = Math.min(11, Math.max(0, totalFullMonths));
    
    // 2. íšŒê³„ì—°ë„(1ì›” 1ì¼) ê¸°ì¤€ ë°œìƒë¶„ (15ê°œ)
    let fiscalLeave = 0;
    if (now.getFullYear() > joinDate.getFullYear()) {
        fiscalLeave = 15;
    }
    
    let generated = firstYearLeave + fiscalLeave;

    // 3. ì¡°ì • ë‚´ì—­ (hr_leave_adj)
    let adjusted = 0;
    const { data: adjs } = await _supabase.from('hr_leave_adj').select('adj_type, days').eq('emp_id', myInfo.emp_id);
    if(adjs) {
        adjs.forEach(a => {
            if(a.adj_type === 'ì§€ê¸‰' || a.adj_type === 'í¬ìƒ') adjusted += Number(a.days);
            else adjusted -= Number(a.days);
        });
    }

    // 4. ì‚¬ìš© ë‚´ì—­ (ref_approval)
    let used = 0;
    const { data: apps } = await _supabase.from('ref_approval').select('amount').eq('drafter_id', myInfo.emp_id).eq('doc_type', 'íœ´ê°€').eq('status', 'ì™„ë£Œ');
    if(apps) apps.forEach(a => used += Number(a.amount));

    document.getElementById("remainDaysBadge").innerText = generated + adjusted - used;
}

// [ê¸°ëŠ¥] ë¶€ì–‘ê°€ì¡± ë“±ì¬ ë° í…œí”Œë¦¿
function handleCategoryChange(sel) {
    const type = sel.value;
    const desc = document.getElementById("appDesc");
    const amtLabel = document.getElementById("amountLabel");
    const amountInput = document.getElementById("appAmount");
    const fileHelp = document.getElementById("fileHelp");
    
    document.getElementById("divAmount").classList.remove("hidden");
    document.getElementById("divLeaveSection").classList.add("hidden");
    amtLabel.innerText = "ê¸ˆì•¡ (ì›)";
    amountInput.placeholder = "0";
    fileHelp.classList.add("hidden");

    if (type === 'íœ´ê°€') {
        document.getElementById("divAmount").classList.add("hidden");
        document.getElementById("divLeaveSection").classList.remove("hidden");
        desc.value = "ìœ„ì™€ ê°™ì´ íœ´ê°€ë¥¼ ì‹ ì²­í•˜ì˜¤ë‹ˆ ì¬ê°€í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.";
    } 
    else if (type === 'ë¶€ì–‘ê°€ì¡±') {
        amtLabel.innerText = "ì¶”ê°€ ì¸ì› (ëª…)";
        amountInput.placeholder = "ì˜ˆ: 1";
        amountInput.value = "1";
        fileHelp.classList.remove("hidden");
        desc.value = `[ë¶€ì–‘ê°€ì¡± ë“±ì¬ ì‹ ì²­]\n\n1. ëŒ€ìƒì ì„±ëª… : \n2. ê´€ê³„ : \n3. ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸(ì•ìë¦¬) : \n4. ë³€ë™ ì‚¬ìœ  : (ì˜ˆ: ìë…€ ì¶œìƒ, í˜¼ì¸ ë“±)\n\n--------------------------------\nìœ„ì™€ ê°™ì´ ê°€ì¡±ìˆ˜ë‹¹ ì§€ê¸‰ ë° ê³µì œ ëŒ€ìƒìë¡œ ì‹ ì²­í•©ë‹ˆë‹¤.`;
    } 
    else {
        if(desc.value.includes("íœ´ê°€ë¥¼ ì‹ ì²­") || desc.value.includes("ë¶€ì–‘ê°€ì¡±")) desc.value = "";
    }
}

// ì£¼ë§ ì œì™¸ íœ´ê°€ì¼ìˆ˜ ê³„ì‚°
function calcLeaveDays() {
    const s = document.getElementById("leaveStart").value;
    const e = document.getElementById("leaveEnd").value;
    if (!s || !e) return;

    let count = 0;
    let cur = new Date(s);
    const end = new Date(e);

    while (cur <= end) {
        const day = cur.getDay();
        if (day !== 0 && day !== 6) count++;
        cur.setDate(cur.getDate() + 1);
    }

    document.getElementById("leaveDaysBadge").innerText = count + "ì¼";
    document.getElementById("leaveDaysCalc").value = count;
    
    const remain = Number(document.getElementById("remainDaysBadge").innerText);
    const msg = document.getElementById("leaveOverMsg");
    if(count > remain) msg.classList.remove("hidden"); else msg.classList.add("hidden");
}

// ì§ì› ì„ íƒ ëª¨ë‹¬
function openUserModal(type) {
    modalType = type;
    document.getElementById("modalTitle").innerText = (type === 'approver') ? "ê²°ì¬ì ì„ íƒ" : "ì°¸ì¡°ì ì„ íƒ";
    tempSelection = (type === 'approver') ? [...finalApprovers] : [...finalRefs];
    renderUserList();
    modalInstance.show();
}

function renderUserList() {
    const listEl = document.getElementById("userSelectList");
    listEl.innerHTML = "";
    const targets = allUsers.filter(u => u.emp_id !== myInfo.emp_id);
    
    if(targets.length === 0) { listEl.innerHTML = '<div class="p-3 text-center">ì§ì› ë°ì´í„° ì—†ìŒ</div>'; return; }

    targets.forEach(u => {
        const isSelected = tempSelection.some(s => s.emp_id === u.emp_id);
        const a = document.createElement("a");
        a.className = `list-group-item list-group-item-action user-select-item d-flex justify-content-between align-items-center ${isSelected ? 'active' : ''}`;
        // [í™•ì¸] auth_levelì´ ë‚®ì€ ìˆ«ì(1)ê°€ ìœ„ë¡œ ì˜´
        a.innerHTML = `<div><span class="badge bg-secondary me-2">${u.position}</span> <span class="fw-bold">${u.emp_name}</span></div>${isSelected ? 'âœ…' : ''}`;
        a.onclick = () => toggleSelect(u);
        listEl.appendChild(a);
    });
    document.getElementById("selCount").innerText = tempSelection.length;
}

function toggleSelect(user) {
    const idx = tempSelection.findIndex(s => s.emp_id === user.emp_id);
    if (idx > -1) tempSelection.splice(idx, 1);
    else tempSelection.push(user);
    renderUserList();
}

function confirmSelection() {
    if (modalType === 'approver') finalApprovers = [...tempSelection];
    else finalRefs = [...tempSelection];
    modalType==='approver' ? renderLinePreview() : renderRefPreview();
    modalInstance.hide();
}

function renderLinePreview() {
    const el = document.getElementById("linePreview");
    if(finalApprovers.length === 0) { el.innerText = "ê²°ì¬ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."; return; }
    el.innerHTML = finalApprovers.map((u, i) => `<span class="line-step">${u.emp_name} ${u.position}</span>` + (i < finalApprovers.length-1 ? '<span class="line-arrow">â¡</span>' : '')).join("");
}

function renderRefPreview() {
    const el = document.getElementById("refPreview");
    if(finalRefs.length === 0) { el.innerText = "ì°¸ì¡°ìê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
    el.innerHTML = finalRefs.map(u => `<span class="ref-step">ğŸ“¢ ${u.emp_name}</span>`).join("");
}

function resetLine(type) {
    if(type==='approver') { finalApprovers=[]; renderLinePreview(); }
    else { finalRefs=[]; renderRefPreview(); }
}

// ìƒì‹  (Submit)
async function handleDraftSubmit(e) {
    e.preventDefault();
    if (finalApprovers.length === 0) return showAlert("ê²°ì¬ì„ ì„ ì§€ì •í•´ì£¼ì„¸ìš”.");
    
    const appType = document.getElementById("appTypeDisplay").value;
    let finalAmt = document.getElementById("appAmount").value || 0;
    
    if (appType === 'íœ´ê°€') {
        const days = Number(document.getElementById("leaveDaysCalc").value);
        if(days <= 0) return showAlert("íœ´ê°€ ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
        const remain = Number(document.getElementById("remainDaysBadge").innerText);
        if(days > remain) return showAlert("ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        finalAmt = days; 
    }
    if (appType === 'ë¶€ì–‘ê°€ì¡±') {
        if(document.getElementById("attachFile").files.length === 0) return showAlert("ì¦ë¹™ì„œë¥˜(ê°€ì¡±ê´€ê³„ì¦ëª…ì„œ) í•„ìˆ˜ì…ë‹ˆë‹¤.");
    }

    const btn = document.getElementById("btnSubmit");
    btn.disabled = true; btn.innerText = "ì²˜ë¦¬ ì¤‘...";

    // íŒŒì¼ ì—…ë¡œë“œ
    const fileInput = document.getElementById("attachFile");
    const uploadedUrls = [];
    for (let i = 0; i < fileInput.files.length; i++) {
        const file = fileInput.files[i];
        const safeName = `${crypto.randomUUID()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
        const { data, error } = await _supabase.storage.from('attachments').upload(safeName, file);
        if (error) { showAlert("ì—…ë¡œë“œ ì‹¤íŒ¨: "+error.message); btn.disabled=false; return; }
        const { data: { publicUrl } } = _supabase.storage.from('attachments').getPublicUrl(safeName);
        uploadedUrls.push(publicUrl);
    }

    const approvalLineData = finalApprovers.map(u => ({ emp_id: u.emp_id, name: u.emp_name, position: u.position, status: 'ëŒ€ê¸°', comment: '', processed_at: null }));
    const refData = finalRefs.map(u => ({ emp_id: u.emp_id, name: u.emp_name }));

    const { error: insertError } = await _supabase.from('ref_approval').insert({
        doc_type: appType,
        title: (appType==='ë¶€ì–‘ê°€ì¡±') ? `[ë¶€ì–‘ê°€ì¡±] ${myInfo.emp_name} ë“±ì¬ ì‹ ì²­` : `${appType} ì‹ ì²­ - ${myInfo.emp_name}`,
        content: document.getElementById("appDesc").value,
        amount: Number(finalAmt),
        drafter_id: myInfo.emp_id,
        drafter_name: myInfo.emp_name,
        approval_line: approvalLineData,
        ref_line: refData, 
        file_links: uploadedUrls, 
        current_approver: finalApprovers[0].emp_id,
        status: 'ì§„í–‰ì¤‘',
        created_at: new Date()
    });

    if (insertError) { showAlert("ì˜¤ë¥˜: " + insertError.message); btn.disabled = false; btn.innerText = "ìƒì‹ í•˜ê¸°"; }
    else { showAlert("ìƒì‹ ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
}

// ê²°ì¬ ì²˜ë¦¬ (ë¶€ì–‘ê°€ì¡± ìë™ë°˜ì˜ í¬í•¨)
async function procDoc(docId, action) {
    const reason = prompt(`${action} ì‚¬ìœ  (ì„ íƒ):`);
    if (reason === null) return;

    const { data: doc } = await _supabase.from('ref_approval').select('*').eq('id', docId).single();
    let line = doc.approval_line;
    let nextUser = null;
    let newStatus = 'ì§„í–‰ì¤‘';

    const idx = line.findIndex(p => p.emp_id === myInfo.emp_id);
    if (idx === -1) return showAlert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    if (idx > 0 && line[idx-1].status !== 'ìŠ¹ì¸') return showAlert("ì´ì „ ê²°ì¬ìê°€ ì•„ì§ ì²˜ë¦¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

    line[idx].status = action;
    line[idx].comment = reason;
    line[idx].processed_at = new Date().toISOString();

    if (action === 'ë°˜ë ¤') {
        newStatus = 'ë°˜ë ¤';
        nextUser = null;
    } else {
        if (idx + 1 < line.length) nextUser = line[idx+1].emp_id;
        else newStatus = 'ì™„ë£Œ'; 
    }

    // [í•µì‹¬] ë¶€ì–‘ê°€ì¡± ë“±ì¬ ìë™ ë°˜ì˜ (ìµœì¢… ìŠ¹ì¸ ì‹œ)
    if (doc.doc_type === 'ë¶€ì–‘ê°€ì¡±' && newStatus === 'ì™„ë£Œ') {
        const addCount = Number(doc.amount);
        const drafterId = doc.drafter_id;
        const { data: empData } = await _supabase.from('ref_employees').select('dependents').eq('emp_id', drafterId).single();
        if(empData) {
            const currentDep = empData.dependents || 0;
            await _supabase.from('ref_employees').update({ dependents: currentDep + addCount }).eq('emp_id', drafterId);
        }
    }

    const { error } = await _supabase.from('ref_approval').update({ approval_line: line, current_approver: nextUser, status: newStatus }).eq('id', docId);
    if (error) showAlert("ì‹¤íŒ¨: " + error.message);
    else { showAlert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); loadTodoList(); }
}

// ì¡°íšŒ í•¨ìˆ˜ë“¤
async function loadTodoList() {
    const el = document.getElementById("todoList");
    el.innerHTML = '<div class="text-center p-3">ë¡œë”© ì¤‘...</div>';
    const { data, error } = await _supabase.from('ref_approval').select('*').eq('status', 'ì§„í–‰ì¤‘').eq('current_approver', myInfo.emp_id).order('created_at', {ascending: false});
    if(error) return el.innerHTML = "ì˜¤ë¥˜";
    renderDocs(el, data, true);
}

async function loadHistoryList() {
    const el = document.getElementById("historyList");
    el.innerHTML = '<div class="text-center p-3">ë¡œë”© ì¤‘...</div>';
    const { data } = await _supabase.from('ref_approval').select('*').eq('drafter_id', myInfo.emp_id).order('created_at', {ascending: false});
    historyCache = data || [];
    renderDocs(el, historyCache, false);
}

function filterHistory() {
    const key = document.getElementById("searchKeyword").value.toLowerCase();
    const filtered = historyCache.filter(d => d.title.toLowerCase().includes(key) || d.content.toLowerCase().includes(key));
    renderDocs(document.getElementById("historyList"), filtered, false);
}

function renderDocs(target, list, isTodo) {
    target.innerHTML = "";
    if(!list || list.length === 0) { target.innerHTML = '<div class="text-center p-3 text-muted">ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    list.forEach(doc => {
        const lineHtml = doc.approval_line.map(s => {
            let icon = s.status==='ìŠ¹ì¸'?'âœ…':(s.status==='ë°˜ë ¤'?'â›”':'â¬œ');
            let style = s.status==='ìŠ¹ì¸'?'text-success':(s.status==='ë°˜ë ¤'?'text-danger':'text-muted');
            return `<span class="small me-2 ${style}">${icon} ${s.name} ${s.position}</span>`;
        }).join("");

        let fileHtml = "";
        if (doc.file_links && doc.file_links.length > 0) {
            fileHtml = `<div class="mt-2 pt-2 border-top">` + doc.file_links.map((url, i) => `<a href="${url}" target="_blank" class="text-decoration-none me-2">ğŸ“ ì²¨ë¶€íŒŒì¼ ${i+1}</a>`).join("") + `</div>`;
        }

        let btnHtml = "";
        if (isTodo) {
            btnHtml = `<div class="mt-3 text-end"><button class="btn btn-sm btn-success me-1" onclick="procDoc(${doc.id}, 'ìŠ¹ì¸')">ìŠ¹ì¸</button><button class="btn btn-sm btn-danger" onclick="procDoc(${doc.id}, 'ë°˜ë ¤')">ë°˜ë ¤</button></div>`;
        } else {
            let badge = doc.status==='ì™„ë£Œ'?'bg-success':(doc.status==='ë°˜ë ¤'?'bg-danger':'bg-warning');
            btnHtml = `<div class="mt-2 text-end"><span class="badge ${badge}">${doc.status}</span></div>`;
        }
        
        const div = document.createElement("div");
        div.className = "list-group-item shadow-sm mb-3 border-0 p-3";
        div.innerHTML = `<div class="d-flex justify-content-between mb-2"><span class="badge bg-primary">${doc.doc_type}</span><small class="text-muted">${new Date(doc.created_at).toLocaleDateString()}</small></div><h6 class="fw-bold mb-1">${doc.title}</h6><div class="small text-muted mb-2">ê¸°ì•ˆì: ${doc.drafter_name}</div><div class="bg-light p-2 rounded mb-2" style="white-space: pre-wrap; font-size: 0.9rem;">${doc.content}</div><div class="small mb-1">${lineHtml}</div>${fileHtml}${btnHtml}`;
        target.appendChild(div);
    });
}

function updateFileList() {
    const files = document.getElementById("attachFile").files;
    const area = document.getElementById("fileListArea");
    let html = "";
    for(let i=0; i<files.length; i++) html += `<div class="file-item">ğŸ“ ${files[i].name} <span class="file-size">${(files[i].size/1024).toFixed(1)} KB</span></div>`;
    area.innerHTML = html;
}
</script>
</body>
</html>
