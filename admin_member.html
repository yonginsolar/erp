<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜€ï¸ í˜‘ë™ì¡°í•© í†µí•© ê´€ë¦¬ì</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-menu { padding: 20px 10px; overflow-y: auto; flex-grow: 1; }
        .nav-link { color: rgba(255,255,255,0.75); padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; font-weight: 600; }
        .nav-link i { margin-right: 12px; font-size: 1.1rem; }
        .menu-category { font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 20px 15px 10px; font-weight: 700; letter-spacing: 1px; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .main-content { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 30px; background: #f8f9fa; }
        .content-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); text-align: center; }

        .hidden { display: none !important; }
        .table th { font-size: 13px; background-color: #f1f3f5; font-weight: 600; }
        .table td { font-size: 14px; vertical-align: middle; }
        
        /* íƒ­ ë‚´ìš© ìˆ¨ê¹€ ì²˜ë¦¬ */
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>

<body>

    <div id="login-gate">
        <div class="login-box">
            <h3 class="fw-bold mb-4">ğŸ” ê´€ë¦¬ì ì ‘ì†</h3>
            <p class="text-muted small mb-3">ê´€ë¦¬ì ê¶Œí•œ(admin)ì´ ìˆëŠ” ê³„ì •ë§Œ ì ‘ì† ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            <div class="mb-3 text-start">
                <label class="form-label small fw-bold">ì´ë©”ì¼ ì£¼ì†Œ</label>
                <input type="email" id="adminEmail" class="form-control" placeholder="name@coop.com">
            </div>
            <button class="btn btn-primary w-100 py-2 fw-bold" id="btnLogin" onclick="sendLoginLink()">ğŸš€ ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°</button>
            <div id="loginMsg" class="mt-3 text-success small" style="display:none;"></div>
        </div>
    </div>

    <div class="d-flex hidden" id="main-system">
        <div class="sidebar">
            <div class="sidebar-header">
                <h5 class="fw-bold m-0">â˜€ï¸ í˜‘ë™ì¡°í•© ERP</h5>
                <small class="text-white-50" id="adminProfile">ì ‘ì†ì¤‘...</small>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-category">íšŒì› ë° ìê¸ˆ</div>
                <a class="nav-link active" onclick="switchTab('members')"><i class="bi bi-people-fill"></i> ì¡°í•©ì› ê´€ë¦¬</a>
                <a class="nav-link" onclick="switchTab('deposit')"><i class="bi bi-cash-coin"></i> ì…ê¸ˆ ë§¤ì¹­</a>

                <div class="menu-category">ìš´ì˜ ê´€ë¦¬</div>
                <a class="nav-link" onclick="switchTab('meetings')"><i class="bi bi-calendar-event"></i> íšŒì˜ ë° ì˜ì‚¬ë¡</a>
                <a class="nav-link" onclick="switchTab('notices')"><i class="bi bi-megaphone"></i> ê³µì§€ì‚¬í•­ ê´€ë¦¬</a>

                <div class="menu-category">í™ˆí˜ì´ì§€ ê´€ë¦¬</div>
                <a class="nav-link" onclick="switchTab('site')"><i class="bi bi-window-sidebar"></i> ì‚¬ì´íŠ¸ ì»¨í…ì¸ </a>

                <div class="mt-4 pt-4 border-top border-secondary">
                    <a class="nav-link text-warning" onclick="location.href='index.html'"><i class="bi bi-box-arrow-up-right"></i> í™ˆí˜ì´ì§€ ë°”ë¡œê°€ê¸°</a>
                    <a class="nav-link text-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="tab-members" class="tab-pane active">
                <div class="content-header">
                    <h3>ğŸ‘¥ ì¡°í•©ì› í†µí•© ê´€ë¦¬</h3>
                    <button class="btn btn-success btn-sm" onclick="openExcelModal()"><i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="text" id="search-keyword" class="form-control form-control-sm" placeholder="ì´ë¦„, ë²ˆí˜¸ ê²€ìƒ‰" onkeyup="if(event.key=='Enter') fetchMembers()"></div>
                            <div class="col-md-2"><button class="btn btn-primary btn-sm w-100" onclick="fetchMembers()">ê²€ìƒ‰</button></div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th>No</th><th>ìœ í˜•</th><th>ì´ë¦„/ë²ˆí˜¸</th><th>ìƒë…„ì›”ì¼/ì‚¬ì—…ì</th><th>ì—°ë½ì²˜</th><th>ë‚©ì…ì´ì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="memberListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-deposit" class="tab-pane">
                <div class="content-header"><h3>ğŸ’° ì…ê¸ˆ ë‚´ì—­ ë§¤ì¹­</h3></div>
                <div class="alert alert-info small"><i class="bi bi-info-circle"></i> ì€í–‰ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì•½ì •ê¸ˆì•¡ê³¼ ë¹„êµí•˜ì—¬ ë§¤ì¹­í•©ë‹ˆë‹¤.</div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <h6 class="fw-bold mb-3">1. íŒŒì¼ ì„ íƒ</h6>
                            <input type="file" id="depositFile" class="form-control mb-3">
                            <button class="btn btn-primary w-100" onclick="alert('ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼ ë¡œì§ (ìƒëµ)')">ë§¤ì¹­ ì‹œì‘</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-meetings" class="tab-pane">
                <div class="content-header">
                    <h3>ğŸ“… íšŒì˜ ë° ì˜ì‚¬ë¡</h3>
                    <button class="btn btn-primary btn-sm" onclick="alert('ëª¨ë‹¬ ì¶”ê°€ í•„ìš”')"><i class="bi bi-plus-lg"></i> ì‹ ê·œ íšŒì˜ ë“±ë¡</button>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ì œëª©</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="meetingListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-notices" class="tab-pane">
                <div class="content-header">
                    <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
                    <button class="btn btn-primary btn-sm" onclick="alert('ëª¨ë‹¬ ì¶”ê°€ í•„ìš”')"><i class="bi bi-pencil"></i> ê³µì§€ ì‘ì„±</button>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th>ë‚ ì§œ</th><th>ë¶„ë¥˜</th><th>ì œëª©</th><th>íŒì—…ì—¬ë¶€</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="noticeListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-site" class="tab-pane">
                <div class="content-header"><h3>ğŸ–¥ï¸ í™ˆí˜ì´ì§€ ì»¨í…ì¸  ê´€ë¦¬</h3></div>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#sub-plants" onclick="setTimeout(fetchPlants,100)">ë°œì „ì†Œ í˜„í™©</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sub-history" onclick="setTimeout(fetchHistory,100)">ì—°í˜ (History)</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sub-partners" onclick="setTimeout(fetchPartners,100)">í˜‘ë ¥ ë‹¨ì²´</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sub-faq" onclick="setTimeout(fetchFaqs,100)">FAQ</a></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="sub-plants">
                        <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="alert('ëª¨ë‹¬ ì¶”ê°€ í•„ìš”')">+ ë°œì „ì†Œ ì¶”ê°€</button></div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ìˆœì„œ</th><th>ë°œì „ì†Œëª…</th><th>ìš©ëŸ‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="plantListBody"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="sub-history">
                        <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="alert('ëª¨ë‹¬ ì¶”ê°€ í•„ìš”')">+ ì—°í˜ ì¶”ê°€</button></div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ë‚ ì§œ</th><th>ì œëª©</th><th>ë‚´ìš©</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="historyListBody"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="sub-partners">
                        <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="alert('ëª¨ë‹¬ ì¶”ê°€ í•„ìš”')">+ ë‹¨ì²´ ì¶”ê°€</button></div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ìˆœì„œ</th><th>ë‹¨ì²´ëª…</th><th>ë§í¬</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="partnerListBody"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="sub-faq">
                        <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-primary" onclick="alert('ëª¨ë‹¬ ì¶”ê°€ í•„ìš”')">+ FAQ ì¶”ê°€</button></div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ìˆœì„œ</th><th>ì§ˆë¬¸</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="faqListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:none; justify-content:center; align-items:center; z-index:9999;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div class="modal fade" id="excelModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜µì…˜</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="form-check mb-2"><input class="form-check-input" type="radio" name="excelOption" value="public" checked><label class="form-check-label">ì¼ë°˜ìš© (ê¸°ë³¸ ì •ë³´)</label></div>
                    <div class="form-check"><input class="form-check-input" type="radio" name="excelOption" value="secret"><label class="form-check-label text-danger">ë³´ì•ˆìš© (ì£¼ë¯¼ë²ˆí˜¸ í¬í•¨)</label></div>
                    <div class="mt-2"><input type="password" id="decryptKey" class="form-control form-control-sm" placeholder="ì•”í˜¸í™” í‚¤ ì…ë ¥ (ë³´ì•ˆìš© ì„ íƒ ì‹œ)"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-success" onclick="downloadExcel()">ë‹¤ìš´ë¡œë“œ</button></div>
            </div>
        </div>
    </div>

    <script>
        // â˜… Supabase Anon Key (ê³µê°œí‚¤ ì‚¬ìš©)
        const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // [ì´ˆê¸°í™”]
        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) checkAdmin(session.user);
            else document.getElementById('login-gate').classList.remove('hidden');
        };

        // [ê¶Œí•œ ì²´í¬] ë¬´í•œ ë£¨í”„ ë°©ì§€ ë¡œì§ ì ìš©
        async function checkAdmin(user) {
            showLoading(true);
            const { data: role, error } = await _supabase.rpc('get_my_role'); // SQLë¡œ ê³ ì¹œ ê°•ë ¥í•œ í•¨ìˆ˜ ì‚¬ìš©
            showLoading(false);

            if (role === 'admin') {
                document.getElementById('login-gate').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                document.getElementById('adminProfile').innerText = user.email;
                fetchMembers(); // ê¸°ë³¸ íƒ­ ë¡œë“œ
            } else {
                alert(`â›” ì ‘ê·¼ ê±°ë¶€: ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n(í˜„ì¬ ê³„ì •: ${user.email})`);
                await _supabase.auth.signOut();
                location.href = 'index.html';
            }
        }

        // [ë¡œê·¸ì¸]
        async function sendLoginLink() {
            const email = document.getElementById('adminEmail').value;
            if(!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
            const btn = document.getElementById('btnLogin');
            btn.disabled = true; btn.innerText = "ì „ì†¡ì¤‘...";
            
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
            
            if(error) { alert(error.message); btn.disabled = false; btn.innerText = "ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°"; }
            else { 
                document.getElementById('loginMsg').innerText = "ì´ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”! (ìŠ¤íŒ¸í•¨ë„ í™•ì¸)"; 
                document.getElementById('loginMsg').style.display='block';
                btn.classList.add('hidden');
            }
        }

        // [ê¸°ëŠ¥ 1] ì¡°í•©ì› ëª©ë¡ ì¡°íšŒ
// [ìˆ˜ì •ëœ ê¸°ëŠ¥ 1] ì¡°í•©ì› ëª©ë¡ ì¡°íšŒ (RPC ë°©ì‹ ì ìš©)
        async function fetchMembers() {
            showLoading(true);
            const keyword = document.getElementById('search-keyword').value.trim();
            
            // â˜… í•µì‹¬ ë³€ê²½: í…Œì´ë¸” ì§ì ‘ ì¡°íšŒ(from) ëŒ€ì‹  í•¨ìˆ˜ í˜¸ì¶œ(rpc) ì‚¬ìš©
            // ì´ë ‡ê²Œ í•˜ë©´ í…Œì´ë¸”ì— ê±¸ë¦° RLS(ë³´ì•ˆì •ì±…)ë¥¼ ì•„ì˜ˆ íƒ€ì§€ ì•ŠìŠµë‹ˆë‹¤.
            const { data: members, error: err1 } = await _supabase.rpc('get_members_secure');
            
            if(err1) { 
                showLoading(false); 
                console.error(err1); 
                return alert('íšŒì› ë¡œë“œ ì‹¤íŒ¨: ' + err1.message); 
            }

            // ë‚©ì…ê¸ˆ ì •ë³´ë„ í•¨ìˆ˜ë¡œ í˜¸ì¶œ
            const { data: payments, error: err2 } = await _supabase.rpc('get_payments_secure');
            
            showLoading(false);
            
            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '';
            
            if(!members || members.length === 0) { 
                tbody.innerHTML='<tr><td colspan="8" class="text-center py-4">ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
                return; 
            }
            
            // ê²€ìƒ‰ì–´ í•„í„°ë§ (DBì—ì„œ ì•ˆ í•˜ê³  ê°€ì ¸ì™€ì„œ JSë¡œ ì²˜ë¦¬ - ì†ë„ ì°¨ì´ ì—†ìŒ)
            const filteredMembers = keyword ? members.filter(m => 
                (m.name && m.name.includes(keyword)) || 
                (m.phone && m.phone.includes(keyword))
            ) : members;

            if(filteredMembers.length === 0) {
                 tbody.innerHTML='<tr><td colspan="8" class="text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                 return;
            }

            filteredMembers.forEach((m, idx) => {
                const pay = payments ? (payments.find(p => p.member_uuid === m.id)?.total_amount || 0) : 0;
                
                // ì£¼ë¯¼ë²ˆí˜¸ ë””ìŠ¤í”Œë ˆì´ ì²˜ë¦¬
                let rrnShow = m.rrn_display || '-';
                if(m.member_type !== 'ë‹¨ì²´' && rrnShow.length > 6) {
                    // ì˜ˆ: 840914-1****** -> 1984.09.14
                    const yCode = rrnShow.charAt(7);
                    const yPrefix = (yCode === '1' || yCode === '2') ? '19' : '20';
                    rrnShow = `${yPrefix}${rrnShow.substring(0,2)}.${rrnShow.substring(2,4)}.${rrnShow.substring(4,6)}`;
                } else if(m.member_type === 'ë‹¨ì²´') {
                    rrnShow = `<span class="badge bg-light text-secondary border">ì‚¬ì—…ì</span> ${rrnShow}`;
                }

                tbody.innerHTML += `<tr>
                    <td>${filteredMembers.length - idx}</td>
                    <td><span class="badge bg-light text-dark border">${m.member_type}</span></td>
                    <td>
                        <div class="fw-bold">${m.name}</div>
                        <div class="small text-muted" style="font-size:0.8em;">${m.member_id||'-'}</div>
                    </td>
                    <td>${rrnShow}</td>
                    <td>${m.phone}</td>
                    <td class="fw-bold text-primary">${pay.toLocaleString()}ì›</td>
                    <td><span class="badge ${m.status==='ì •ìƒ'?'bg-success':'bg-secondary'}">${m.status}</span></td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="alert('ìˆ˜ì • ëª¨ë‹¬ ì¤€ë¹„ì¤‘')">ê´€ë¦¬</button></td>
                </tr>`;
            });
        }

        // [ê¸°ëŠ¥ 3] íšŒì˜ë¡ ì¡°íšŒ
        async function fetchMeetings() {
            const { data } = await _supabase.from('coop_meetings').select('*').order('meeting_date', {ascending:false});
            const tbody = document.getElementById('meetingListBody');
            tbody.innerHTML = '';
            if(data) data.forEach(m => {
                tbody.innerHTML += `<tr><td>${m.meeting_date}</td><td>${m.category}</td><td>${m.title}</td><td>${m.status}</td><td><button class="btn btn-sm btn-light">ìˆ˜ì •</button></td></tr>`;
            });
            if(!data || data.length===0) tbody.innerHTML='<tr><td colspan="5" class="text-center py-3">ë“±ë¡ëœ íšŒì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        // [ê¸°ëŠ¥ 4] ê³µì§€ì‚¬í•­ ì¡°íšŒ
        async function fetchNotices() {
            const { data } = await _supabase.from('coop_notices').select('*').order('created_at', {ascending:false});
            const tbody = document.getElementById('noticeListBody');
            tbody.innerHTML = '';
            if(data) data.forEach(n => {
                tbody.innerHTML += `<tr><td>${n.created_at.split('T')[0]}</td><td>${n.category}</td><td>${n.title}</td><td>${n.is_popup?'Y':'-'}</td><td>${n.status}</td><td><button class="btn btn-sm btn-light">ìˆ˜ì •</button></td></tr>`;
            });
            if(!data || data.length===0) tbody.innerHTML='<tr><td colspan="6" class="text-center py-3">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }

        // [ê¸°ëŠ¥ 5] ë°œì „ì†Œ/ì—°í˜/íŒŒíŠ¸ë„ˆ/FAQ
        async function fetchPlants() {
            const { data } = await _supabase.from('site_power_plants').select('*').order('display_order');
            renderTable('plantListBody', data, (p) => `<td>${p.display_order}</td><td>${p.name}</td><td>${p.capacity}kW</td><td>${p.status}</td>`);
        }
        async function fetchHistory() {
            const { data } = await _supabase.from('site_documents').select('*').eq('category','history').order('event_date', {ascending:false});
            renderTable('historyListBody', data, (h) => `<td>${h.event_date}</td><td>${h.title}</td><td>${h.content||''}</td>`);
        }
        async function fetchPartners() {
            const { data } = await _supabase.from('site_partners').select('*').order('display_order');
            renderTable('partnerListBody', data, (p) => `<td>${p.display_order}</td><td>${p.name}</td><td>${p.link_url||'-'}</td>`);
        }
        async function fetchFaqs() {
            const { data } = await _supabase.from('site_faqs').select('*').order('display_order');
            renderTable('faqListBody', data, (f) => `<td>${f.display_order}</td><td>${f.question}</td>`);
        }

        // í…Œì´ë¸” ë Œë”ë§ í—¬í¼
        function renderTable(bodyId, data, rowFn) {
            const tbody = document.getElementById(bodyId);
            tbody.innerHTML = '';
            if(!data || data.length===0) { tbody.innerHTML='<tr><td colspan="5" class="text-center py-3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
            data.forEach(item => {
                tbody.innerHTML += `<tr>${rowFn(item)}<td><button class="btn btn-sm btn-light" onclick="alert('ìˆ˜ì • ëª¨ë‹¬ ì¤€ë¹„ì¤‘')">ìˆ˜ì •</button></td></tr>`;
            });
        }

        // íƒ­ ì „í™˜
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+tabId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            // ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„±í™” (ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í˜„ì¬ í´ë¦­ëœ ìš”ì†Œë§Œ active)
            const clicked = event.target.closest('.nav-link');
            if(clicked) clicked.classList.add('active');
            
            if(tabId === 'meetings') fetchMeetings();
            if(tabId === 'notices') fetchNotices();
            if(tabId === 'site') { 
                // ì„œë¸Œíƒ­ ì´ˆê¸°í™” (ë°œì „ì†Œ íƒ­ í´ë¦­ íš¨ê³¼)
                const firstSubTab = document.querySelector('a[href="#sub-plants"]');
                if(firstSubTab) firstSubTab.click(); 
            }
        }

        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        function logout() { _supabase.auth.signOut().then(() => location.href='index.html'); }
        
        // ì—‘ì…€ ê´€ë ¨ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        function openExcelModal() { new bootstrap.Modal(document.getElementById('excelModal')).show(); }
        function downloadExcel() { alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì´ì „ ë²„ì „ ì½”ë“œì˜ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.'); }

    </script>
</body>
</html>
