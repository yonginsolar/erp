<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>☀️ 협동조합 통합 관리자</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://yonginsolar.github.io/home/badges.js"></script>
<script src="https://yonginsolar.github.io/home/cert_generator.js"></script>
    

<style>
body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; overflow: hidden; }

/* 사이드바 스타일 */
.sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
.sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-menu { padding: 20px 10px; overflow-y: auto; flex-grow: 1; }
.nav-link { color: rgba(255,255,255,0.75); padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
.nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; font-weight: 600; }
.nav-link i { margin-right: 12px; font-size: 1.1rem; }
.menu-category { font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 20px 15px 10px; font-weight: 700; letter-spacing: 1px; }

/* 메인 컨텐츠 영역 */
.main-content { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 30px; background: #f8f9fa; }
.content-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }

/* 로그인 화면 & 유틸 */
#login-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
.login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); text-align: center; }
.hidden { display: none !important; }
.table th { font-size: 13px; background-color: #f1f3f5; font-weight: 600; }
.table td { font-size: 14px; vertical-align: middle; }
.tab-pane { display: none; }
.tab-pane.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* 탭 글씨 색상 강제 수정 */
.nav-tabs .nav-link { color: #495057 !important; font-weight: 600; }
.nav-tabs .nav-link.active { color: #0d6efd !important; border-bottom: 2px solid #0d6efd; }
/* 기본 정보 탭 버튼 제어 */
#btn-save-mode { display: none; } /* 처음엔 숨김 */
#rrn-edit-area { display: none; } /* 처음엔 숨김 */
</style>
</head>

<body>

<div id="login-gate">
<div class="login-box">
<h3 class="fw-bold mb-4">🔐 관리자 접속</h3>
<div class="mb-3 text-start">
<label class="form-label small fw-bold">이메일 주소</label>
<input type="email" id="adminEmail" class="form-control" placeholder="name@coop.com">
</div>
<button class="btn btn-primary w-100 py-2 fw-bold" id="btnLogin" onclick="sendLoginLink()">로그인 링크 받기</button>
<div id="loginMsg" class="mt-3 text-success small" style="display:none;"></div>
</div>
</div>

<div class="d-flex hidden" id="main-system">
<div class="sidebar">
<div class="sidebar-header">
<h5 class="fw-bold m-0">☀️ 협동조합 ERP <span class="badge bg-warning text-dark" style="font-size:0.6em; vertical-align:middle;">v1.1.0</span></h5>
<small class="text-white-50" id="adminProfile">접속중...</small>
</div>

<div class="sidebar-menu">
<a class="nav-link active" onclick="switchTab('dashboard')" id="nav-dashboard" style="cursor:pointer;">
<i class="bi bi-grid-fill"></i> 대시보드
</a>

<div class="menu-category mt-3">회원 및 자금</div>

<a class="nav-link" onclick="switchTab('members')" id="nav-members" style="cursor:pointer;">
<i class="bi bi-people-fill"></i> 조합원 명부
</a>
<a class="nav-link" onclick="switchTab('deposit')" id="nav-deposit" style="cursor:pointer;">
<i class="bi bi-cash-coin"></i> 입금 매칭
</a>

<div class="menu-category">운영 관리</div>
<a class="nav-link" onclick="switchTab('notices')" id="nav-notices" style="cursor:pointer;">
<i class="bi bi-megaphone"></i> 공지사항 관리
</a>


<div class="menu-category">홈페이지 관리</div>
<a class="nav-link" onclick="switchTab('site')" id="nav-site" style="cursor:pointer;">
<i class="bi bi-window-sidebar"></i> 사이트 컨텐츠
</a>

<div class="mt-4 pt-4 border-top border-secondary">
<a class="nav-link text-warning" onclick="location.href='index.html'" style="cursor:pointer;">
<i class="bi bi-box-arrow-up-right"></i> 메뉴로 바로가기
</a>
<a class="nav-link text-danger" onclick="logout()" style="cursor:pointer;">
<i class="bi bi-box-arrow-right"></i> 로그아웃
</a>
</div>
</div>
</div>

<div class="main-content">

<div class="tab-pane fade show active" id="tab-dashboard">
    <h3 class="fw-bold mb-4" style="font-family:'GmarketSans';">운영 대시보드</h3>

    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card bg-primary bg-opacity-10 border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h6 class="text-primary fw-bold mb-2">총 조합원</h6>
                    <h2 class="display-6 fw-bold mb-0" id="dashboard-total-count">0명</h2>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card bg-warning bg-opacity-10 border-0 shadow-sm h-100" style="cursor:pointer;" onclick="goToPendingMembers()">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-warning text-dark fw-bold mb-0">승인 대기 (클릭)</h6>
                        <i class="bi bi-arrow-right-circle text-warning text-dark"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-0" id="dashboard-pending-count">0명</h2>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card bg-success bg-opacity-10 border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h6 class="text-success fw-bold mb-2">누적 출자금</h6>
                    <h2 class="fs-2 fw-bold mb-0 text-success" id="dash-capital">-</h2>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card bg-info bg-opacity-10 border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h6 class="text-info fw-bold mb-2">오늘의 상담</h6>
                    <h2 class="fs-2 fw-bold mb-0 text-info" id="dash-consult">-</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm p-4 mb-3">
        <h5 class="fw-bold mb-3">바로가기</h5>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-dark" onclick="openNoticeModal()">📢 공지사항 쓰기</button>
            <button class="btn btn-outline-success" onclick="document.getElementById('nav-members').click()">👥 조합원 검색</button>
            <button class="btn btn-outline-primary" onclick="alert('준비중입니다.')">📊 엑셀 업로드</button>
        </div>
    </div>
</div>

<div class="tab-pane fade" id="tab-members">
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
<h3 class="fw-bold m-0" style="font-family:'GmarketSans';">조합원 명부</h3>
<button class="btn btn-primary" onclick="alert('신규 등록은 신청서를 통해 진행됩니다.')">+ 신규 등록 안내</button>
</div>

<div class="card p-3 mb-3 border-0 bg-light">
    <div class="row g-2 align-items-center">
        <div class="col-md-2">
            <select id="filter-status" class="form-select form-select-sm" onchange="fetchMembers()">
                <option value="all" selected>상태: 전체</option>
                <option value="정상">정상 (정조합원)</option>  <option value="승인대기">승인 대기</option>      <option value="탈퇴">탈퇴/제명</option>          </select>
        </div>

        <div class="col-md-2">
            <select id="filter-type" class="form-select form-select-sm" onchange="fetchMembers()">
                <option value="all">유형: 전체</option>
                <option value="개인">개인</option>  <option value="단체">단체</option>  </select>
        </div>

        <div class="col-md-2">
            <select id="sort-order" class="form-select form-select-sm" onchange="fetchMembers()">
                <option value="name">이름순</option>
                <option value="join_date">가입일순 (최신)</option>
                <option value="capital">출자금순 (고액)</option>
            </select>
        </div>

        <div class="col-md-4">
            <div class="input-group input-group-sm">
                <input type="text" id="search-keyword" class="form-control" placeholder="이름 / 전화번호 / 조합원번호" onkeyup="if(event.key=='Enter') fetchMembers()">
                <button class="btn btn-secondary" onclick="fetchMembers()">검색</button>
            </div>
        </div>

        <div class="col-md-2 text-end">
            <button class="btn btn-sm btn-outline-success" onclick="openExcelModal()">📥 엑셀</button>
        </div>
    </div>
</div>

<div class="table-responsive bg-white border rounded">
<table class="table table-hover align-middle mb-0 text-center">
<thead class="table-light">
<tr>
<th>번호</th>
<th>유형</th>
<th>이름 (조합원번호)</th>
<th>연락처</th>
<th>가입일/상태</th>
<th>출자금</th>
<th>관리</th>
</tr>
</thead>
<tbody id="memberListBody"></tbody>
</table>
</div>
</div>

<div id="tab-deposit" class="tab-pane">
<div class="content-header"><h3>💰 입금 내역 매칭</h3></div>
<div class="row">
<div class="col-md-4">
<div class="card p-3 h-100 border-0 shadow-sm">
<h6 class="fw-bold mb-3">1. 은행 엑셀 업로드</h6>
<input type="file" id="depositFile" class="form-control mb-3" onchange="readExcel(this)">
<div class="small text-muted">엑셀 파일에 '입금자명' 또는 '성명', '입금액' 칼럼이 있어야 자동으로 인식합니다.</div>
</div>
</div>
<div class="col-md-8">
<div class="card p-3 h-100 border-0 shadow-sm">
<h6 class="fw-bold mb-3">2. 매칭 결과</h6>
<div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
<table class="table table-sm">
<thead style="position:sticky; top:0; background:white;"><tr><th>입금자명</th><th>입금액</th><th>매칭된 조합원</th></tr></thead>
<tbody id="depositResultBody"><tr><td colspan="3" class="text-center text-muted py-5">파일을 업로드하세요.</td></tr></tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div id="tab-notices" class="tab-pane">
<div class="content-header">
<h3>📢 공지사항 관리</h3>
<button class="btn btn-primary btn-sm" onclick="openNoticeModal()"><i class="bi bi-pencil"></i> 공지 작성</button>
</div>
<div class="card border-0 shadow-sm">
<div class="table-responsive">
<table class="table table-hover mb-0">
<thead><tr><th>날짜</th><th>분류</th><th>제목</th><th>팝업</th><th>상태</th><th>관리</th></tr></thead>
<tbody id="noticeListBody"></tbody>
</table>
</div>
</div>
</div>

<div class="tab-pane fade" id="tab-site">
<div class="content-header"><h3>🖥️ 홈페이지 컨텐츠 관리</h3></div>

<ul class="nav nav-tabs mb-4">

<li class="nav-item">
<a class="nav-link active" data-bs-toggle="tab" href="#sub-sections" onclick="setTimeout(fetchSections,100)">
섹션 설정 (ON/OFF)
</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-about" onclick="fetchAboutSettings()">조합 소개 (About)</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-plants" onclick="setTimeout(fetchPlants,100)">
발전소 현황
</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-docs" onclick="setTimeout(fetchDocs,100)">
문서 관리 (정관/규약)
</a>
</li>

<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-history" onclick="setTimeout(fetchHistory,100)">
연혁 (History)
</a>
</li>

<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-partners" onclick="setTimeout(fetchPartners,100)">
🤝 협력 단체
</a>
</li> 
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-faqs" onclick="setTimeout(fetchFaqs,100)">
❓ FAQ 관리
</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-badges" onclick="setTimeout(fetchBadges,100)">
🏅 뱃지 관리
</a>
</li>

</ul>

<div class="tab-content">

<div class="tab-pane fade show active" id="sub-sections">
<div class="alert alert-info small">
<i class="bi bi-info-circle-fill"></i> 홈페이지의 메뉴와 본문 섹션을 끄고 켤 수 있습니다. (체크 해제 시 즉시 반영)
</div>
<table class="table table-bordered bg-white text-center">
<thead class="table-light"><tr><th>순서</th><th>섹션 이름(ID)</th><th>상태</th><th>관리</th></tr></thead>
<tbody id="sectionListBody">
</tbody>
</table>
</div>


<div class="tab-pane fade" id="sub-about">
<div class="card p-0 border-0 shadow-sm">
<div class="card-header bg-white border-bottom-0 pt-3 ps-3">
<ul class="nav nav-tabs card-header-tabs" id="aboutTab" role="tablist">
<li class="nav-item">
<button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#about-edit-tab" type="button">✏️ 편집 모드</button>
</li>
<li class="nav-item">
<button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#about-preview-tab" type="button" onclick="updateTotalPreview()">👀 전체 미리보기</button>
</li>
</ul>
</div>
<div class="card-body">
<div class="tab-content">
<div class="tab-pane fade show active" id="about-edit-tab">
<div class="alert alert-light small mb-3 border"><i class="bi bi-info-circle"></i> HTML 태그 사용 가능</div>
<div class="mb-3"><label class="form-label fw-bold">1. 메인 제목</label><input type="text" id="admin-about-title" class="form-control"></div>
<div class="mb-3"><label class="form-label fw-bold">2. 부제목</label><input type="text" id="admin-about-subtitle" class="form-control"></div>
<div class="row">
<div class="col-md-6 mb-3"><label class="form-label fw-bold">3. 체크리스트</label><textarea id="admin-about-list" class="form-control" rows="6"></textarea></div>
<div class="col-md-6 mb-3"><label class="form-label fw-bold">4. 본문 내용</label><textarea id="admin-about-content" class="form-control" rows="6"></textarea></div>
</div>
<div class="mb-3"><label class="form-label fw-bold">5. 사진 URL</label><input type="text" id="admin-about-img" class="form-control"></div>
<div class="text-end mt-3"><button class="btn btn-primary px-4" onclick="saveAboutSettings()">저장하기</button></div>
</div>
<div class="tab-pane fade" id="about-preview-tab">
<div class="border rounded p-4 bg-light">
<div class="row align-items-center bg-white p-3 shadow-sm rounded">
<div class="col-lg-6">
<h3 id="prev-title" class="fw-bold mb-2"></h3>
<p id="prev-subtitle" class="fst-italic text-muted mb-3"></p>
<ul id="prev-list" class="list-unstyled mb-3"></ul>
<p id="prev-content"></p>
</div>
<div class="col-lg-6 text-center">
<img id="prev-img" src="" class="img-fluid rounded" style="max-height:300px;">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="tab-pane fade" id="sub-plants">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openPlantModal()">+ 발전소 추가</button>
</div>
<table class="table table-bordered bg-white">
<thead><tr><th>순서</th><th>발전소명</th><th>용량(kW)</th><th>상태</th><th>모니터링</th><th>관리</th></tr></thead>
<tbody id="plantListBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-history">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openHistoryModal()">+ 연혁 추가</button>
</div>
<table class="table table-bordered bg-white">
<thead><tr><th>날짜</th><th>제목</th><th>내용</th><th>관리</th></tr></thead>
<tbody id="historyListBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-partners">
<div class="card border-warning mb-4 shadow-sm">
<div class="card-header bg-warning bg-opacity-10 fw-bold text-warning-emphasis">
⏳ 승인 대기 중인 신청
</div>
<div class="card-body p-0">
<table class="table table-hover mb-0">
<tbody id="partnerPendingBody"></tbody>
</table>
</div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="fw-bold m-0">✅ 등록된 파트너</h5>
<button class="btn btn-sm btn-outline-primary" onclick="openPartnerModal()">+ 파트너 수동 등록</button>
</div>
<table class="table table-bordered bg-white align-middle">
<thead class="table-light text-center">
<tr>
<th style="width:60px;">순서</th>
<th style="width:80px;">로고</th>
<th>단체 정보</th>
<th>뱃지</th>
<th style="width:120px;">관리</th>
</tr>
</thead>
<tbody id="partnerActiveBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-badges">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openBadgeModal()">+ 새 뱃지 만들기</button>
</div>
<div class="alert alert-light border small">
<i class="bi bi-info-circle"></i> 이곳에서 만든 뱃지는 '협력 단체'나 '조합원'에게 부여할 수 있습니다.
</div>
<table class="table table-bordered bg-white text-center align-middle">
<thead class="table-light">
<tr>
<th width="60">순서</th>
<th width="60">아이콘</th>
<th>이름 / 설명</th>
<th width="100">코드</th>
<th width="100">색상</th>
<th width="120">관리</th>
</tr>
</thead>
<tbody id="badgeListBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-faqs">
<div class="d-flex justify-content-between align-items-center mb-3">
<div class="d-flex gap-2">
<input type="text" id="search-faq" class="form-control form-control-sm" placeholder="질문 검색..." onkeyup="if(event.key=='Enter') fetchFaqs()">
<button class="btn btn-sm btn-outline-secondary" onclick="fetchFaqs()">검색</button>
</div>
<button class="btn btn-sm btn-outline-primary" onclick="openFaqModal()">+ 질문 추가</button>
</div>

<table class="table table-bordered bg-white align-middle">
<thead class="table-light text-center">
<tr>
<th style="width:60px;">순서</th>
<th style="width:100px;">분류</th>
<th>질문 및 답변 요약</th>
<th style="width:80px;">상태</th>
<th style="width:120px;">관리</th>
</tr>
</thead>
<tbody id="faqListBody"></tbody>
</table>
</div>                    

<div class="tab-pane fade" id="sub-docs">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openDocModal()">+ 새 문서 등록</button>
</div>

<table class="table table-bordered bg-white text-center">
<thead class="table-light">
<tr>
<th>날짜/버전</th>
<th>제목</th>
<th>개정 요약</th>
<th>파일</th>
<th>관리</th>
</tr>
</thead>
<tbody id="docListBody"></tbody>
</table>
</div>








</div>
</div>
</div>

<div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:none; justify-content:center; align-items:center; z-index:9999;">
<div class="spinner-border text-primary" role="status"></div>
</div>

<div class="modal fade" id="excelModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title fw-bold">엑셀 다운로드 옵션</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<div class="form-check mb-2">
<input class="form-check-input" type="radio" name="excelOption" value="public" checked onchange="togglePwd(false)">
<label class="form-check-label">일반용 (기본 정보)</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="excelOption" value="secret" onchange="togglePwd(true)">
<label class="form-check-label text-danger">보안용 (주민번호/계좌 포함)</label>
</div>
<div class="mt-3" id="pwdArea" style="display:none;">
<input type="password" id="decryptKey" class="form-control form-control-sm" placeholder="암호화 비밀번호 입력">
</div>
</div>
<div class="modal-footer"><button class="btn btn-success" onclick="downloadExcel()">다운로드</button></div>
</div>
</div>
</div>

<div class="modal fade" id="memberEditModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">회원 정보 수정</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="edit-id">
<div class="mb-3"><label class="form-label small">이름</label><input type="text" id="edit-name" class="form-control"></div>
<div class="mb-3"><label class="form-label small">연락처</label><input type="text" id="edit-phone" class="form-control"></div>
<div class="mb-3"><label class="form-label small">상태</label><select id="edit-status" class="form-select"><option value="정상">정상</option><option value="탈퇴">탈퇴</option><option value="제명">제명</option></select></div>
<div class="mb-3"><label class="form-label small">비고</label><textarea id="edit-note" class="form-control" rows="3"></textarea></div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="saveMember()">저장</button></div>
</div>
</div>
</div>

<div class="modal fade" id="noticeModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">공지사항 작성</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="notice-id">
<div class="mb-3"><label class="form-label small">제목</label><input type="text" id="notice-title" class="form-control"></div>
<div class="mb-3"><label class="form-label small">내용</label><textarea id="notice-content" class="form-control" rows="5"></textarea></div>
<div class="row mb-3">
<div class="col"><label class="form-label small">분류</label><select id="notice-category" class="form-select"><option>공지</option><option>소식</option><option>보도자료</option></select></div>
<div class="col"><label class="form-label small">상태</label><select id="notice-status" class="form-select"><option value="published">게시</option><option value="draft">임시저장</option></select></div>
</div>
<div class="form-check">
<input class="form-check-input" type="checkbox" id="notice-popup">
<label class="form-check-label small">메인 팝업으로 띄우기</label>
</div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="saveNotice()">저장</button></div>
</div>
</div>
</div>

<div class="modal fade" id="plantModal" tabindex="-1">
<div class="modal-dialog modal-lg"> <div class="modal-content">
<div class="modal-header"><h5 class="modal-title fw-bold">발전소 정보 관리</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="plant-id">

<div class="row">
<div class="col-md-6 border-end">
<h6 class="text-primary fw-bold mb-3">📌 기본 정보</h6>
<div class="mb-2"><label class="form-label small">발전소명</label><input type="text" id="plant-name" class="form-control"></div>
<div class="row">
<div class="col-6 mb-2"><label class="form-label small">설비용량 (kW)</label><input type="number" id="plant-capacity" class="form-control" placeholder="0"></div>
<div class="col-6 mb-2"><label class="form-label small">순서</label><input type="number" id="plant-order" class="form-control"></div>
</div>
<div class="mb-2"><label class="form-label small">위치 (주소)</label><input type="text" id="plant-location" class="form-control" placeholder="예: 용인시 처인구..."></div>
<div class="row">
<div class="col-6 mb-2"><label class="form-label small">면적</label><input type="text" id="plant-area" class="form-control" placeholder="예: 150m²"></div>
<div class="col-6 mb-2"><label class="form-label small">준공일(예정)</label><input type="date" id="plant-date" class="form-control"></div>
</div>
<div class="mb-3"><label class="form-label small">상태</label>
<select id="plant-status" class="form-select" onchange="toggleProgressSlider()">
<option value="운영중">운영중 (Portfolio)</option>
<option value="공사중">공사중 (Progress)</option>
<option value="준비중">준비중 (Progress)</option>
</select>
</div>
</div>

<div class="col-md-6">
<div id="plant-progress-area" style="display:none;">
<h6 class="text-primary fw-bold mb-3">🚧 진행 상황</h6>
<div class="p-3 bg-light rounded mb-3">
<label class="d-flex justify-content-between small fw-bold">
<span>진행률</span> <span class="text-primary" id="plant-progress-label">0%</span>
</label>
<input type="range" id="plant-progress" class="form-range" min="0" max="100" step="1" oninput="updateProgressLabel(this.value)">
<div class="d-flex justify-content-between text-muted mt-1" style="font-size:0.7em;">
<span onclick="setProg(0)" style="cursor:pointer">설립</span>
<span onclick="setProg(25)" style="cursor:pointer">부지</span>
<span onclick="setProg(50)" style="cursor:pointer">인허가</span>
<span onclick="setProg(75)" style="cursor:pointer">착공</span>
<span onclick="setProg(100)" style="cursor:pointer">완공</span>
</div>
</div>
</div>

<h6 class="text-primary fw-bold mb-3">📷 현장 사진</h6>
<div class="mb-2 d-flex gap-2">
<input type="file" id="plant-file" class="form-control form-control-sm" accept="image/*" onchange="previewImage(this)">
<button type="button" class="btn btn-sm btn-outline-danger" onclick="clearPlantImage()" title="사진 삭제"><i class="bi bi-trash"></i></button>
</div>

<input type="hidden" id="plant-img-original">
<input type="hidden" id="plant-img-url">

<div class="text-center bg-light border rounded d-flex align-items-center justify-content-center" style="height: 150px; overflow:hidden; position:relative;">
<img id="plant-img-preview" src="" style="max-width:100%; max-height:100%; display:none;">
<span id="plant-img-placeholder" class="text-muted small">사진 없음</span>
</div>

<div class="mt-3">
<label class="form-label small">모니터링 URL</label>
<input type="text" id="plant-url" class="form-control form-control-sm" placeholder="http://...">
</div>
</div>
</div>
</div>
<div class="modal-footer"><button class="btn btn-primary px-4" onclick="savePlant()">저장하기</button></div>
</div>
</div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">연혁 등록</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="hist-id">
<div class="mb-3"><label class="form-label small">날짜</label><input type="date" id="hist-date" class="form-control"></div>
<div class="mb-3"><label class="form-label small">제목</label><input type="text" id="hist-title" class="form-control"></div>
<div class="mb-3"><label class="form-label small">내용 (선택)</label><textarea id="hist-content" class="form-control" rows="3"></textarea></div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="saveHistory()">저장</button></div>
</div>
</div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold text-danger">⚠️ 삭제 확인</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p class="mb-0">정말로 삭제하시겠습니까? <br><small class="text-muted">이 작업은 되돌릴 수 없습니다.</small></p>
<input type="hidden" id="delete-target-id"> </div>
<div class="modal-footer">
<button type="button" class="btn btn-light" data-bs-dismiss="modal">취소</button>
<button type="button" class="btn btn-danger" id="btn-real-delete">삭제하기</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="commonAlertModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content text-center p-3">
<div class="modal-body">
<div class="mb-2">
<i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
</div>
<h6 class="fw-bold mb-0" id="commonAlertText">처리되었습니다.</h6>
</div>
<div class="modal-footer justify-content-center border-0 p-0 pb-2">
<button type="button" class="btn btn-sm btn-dark px-4" data-bs-dismiss="modal">확인</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="docModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content border-0 shadow">
<div class="modal-header bg-white">
<h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-text text-primary me-2"></i>규정/문서 등록</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body p-4">
<input type="hidden" id="doc-id">

<div class="row g-3 mb-3">
<div class="col-md-7">
<label class="form-label small fw-bold text-muted">문서 제목</label>
<input type="text" id="doc-title" class="form-control" placeholder="예: 정관">
</div>
<div class="col-md-5">
<label class="form-label small fw-bold text-muted">버전명</label>
<input type="text" id="doc-version" class="form-control" placeholder="예: 2026.01 개정">
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold text-muted">시행일</label>
<input type="date" id="doc-date" class="form-control">
</div>

<div class="mb-3">
<label class="form-label small fw-bold text-muted">전문 내용 (한글/워드 붙여넣기)</label>
<textarea id="doc-content" class="form-control" rows="8" placeholder="제1장 총칙&#13;&#10;제1조(목적)... 내용을 여기에 붙여넣으세요."></textarea>
<div class="form-text text-end x-small">자동으로 조항을 인식하여 카드 형태로 변환합니다.</div>
</div>


<div class="form-check p-3 bg-light rounded border">
<div class="ps-3"> <input class="form-check-input" type="checkbox" id="doc-current">
<label class="form-check-label fw-bold text-primary" for="doc-current">
이 문서를 '현재 적용 버전'으로 설정
</label>
</div>
</div>
</div>
<div class="modal-footer border-0 pt-0">
<button class="btn btn-light" data-bs-dismiss="modal">취소</button>
<button class="btn btn-primary px-4" onclick="saveDoc()">저장하기</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="partnerModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold">🤝 협력 단체 관리</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="pt-id">

<div class="row g-3">
<div class="col-md-7">
<div class="row g-2 mb-2">
<div class="col-md-8">
<label class="form-label small fw-bold">단체명 <span class="text-danger">*</span></label>
<input type="text" id="pt-name" class="form-control">
</div>
<div class="col-md-4">
<label class="form-label small fw-bold">조합원 번호</label>
<input type="text" id="pt-member-id" class="form-control" placeholder="선택">
</div>
</div>

<div class="mb-2">
<label class="form-label small fw-bold">한 줄 소개</label>
<input type="text" id="pt-desc" class="form-control" placeholder="예: 용인 지역 에너지 전환을 위한 시민 모임">
</div>

<div class="mb-2">
<label class="form-label small fw-bold">홈페이지 링크</label>
<input type="text" id="pt-link" class="form-control" placeholder="https://...">
</div>

<div class="row g-2 mb-2">
<div class="col-6">
<label class="form-label small fw-bold">상태</label>
<select id="pt-status" class="form-select">
<option value="active">✅ 승인 (노출)</option>
<option value="pending">⏳ 대기 (숨김)</option>
</select>
</div>
<div class="col-6">
<label class="form-label small fw-bold">순서</label>
<input type="number" id="pt-order" class="form-control">
</div>
</div>

<div class="mb-2">
<label class="form-label small fw-bold text-primary">🏅 뱃지 부여</label>
<div class="card p-2 bg-light border-0" style="max-height:120px; overflow-y:auto;">
<div id="badge-checkboxes" class="d-flex flex-wrap gap-2">
</div>
</div>
</div>
</div>

<div class="col-md-5 border-start">
<label class="form-label small fw-bold">로고 이미지</label>
<input type="file" id="pt-file" class="form-control form-control-sm mb-2" accept="image/*" onchange="previewPartnerImage(this)">

<input type="hidden" id="pt-img-original">
<input type="hidden" id="pt-img-url">

<div class="border rounded d-flex align-items-center justify-content-center bg-light" style="height: 150px; position:relative;">
<img id="pt-img-preview" src="" style="max-width:100%; max-height:100%; display:none;">
<span id="pt-img-placeholder" class="text-muted small">로고 없음</span>
<button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" onclick="clearPartnerImage()" style="font-size:0.7rem;">삭제</button>
</div>
<div class="small text-muted mt-2 text-center">* 배경 투명한 PNG 권장</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary px-4" onclick="savePartner()">저장하기</button>
</div>
</div>
</div>
</div>


<div class="modal fade" id="badgeModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold">🏅 뱃지 디자인/설정</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="bg-id">

<div class="row g-2 mb-3">
<div class="col-md-3">
<label class="form-label small fw-bold">아이콘</label>
<input type="text" id="bg-icon" class="form-control text-center" placeholder="🌱" style="font-size:1.5rem;">
<div class="form-text x-small">이모지 권장</div>
</div>
<div class="col-md-9">
<label class="form-label small fw-bold">뱃지 이름</label>
<input type="text" id="bg-name" class="form-control" placeholder="예: 모범 조합원">
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold">설명 (획득 조건 등)</label>
<input type="text" id="bg-desc" class="form-control" placeholder="예: 조합 행사 10회 이상 참여">
</div>

<div class="row g-2 mb-3">
<div class="col-md-6">
<label class="form-label small fw-bold">고유 코드 (영어)</label>
<input type="text" id="bg-code" class="form-control" placeholder="example_code">
</div>
<div class="col-md-3">
<label class="form-label small fw-bold">색상</label>
<select id="bg-color" class="form-select">
<option value="primary" class="text-primary">파랑</option>
<option value="success" class="text-success">초록</option>
<option value="warning" class="text-warning">노랑</option>
<option value="danger" class="text-danger">빨강</option>
<option value="info" class="text-info">하늘</option>
<option value="dark" class="text-dark">검정</option>
</select>
</div>
<div class="col-md-3">
<label class="form-label small fw-bold">순서</label>
<input type="number" id="bg-order" class="form-control">
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary w-100" onclick="saveBadge()">뱃지 저장</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="faqModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold">❓ 자주 묻는 질문 관리</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="faq-id">

<div class="row mb-3">
<div class="col-md-3">
<label class="form-label small fw-bold">카테고리</label>
<select id="faq-category" class="form-select">
<option value="가입/탈퇴">가입/탈퇴</option>
<option value="출자/배당">출자/배당</option>
<option value="발전소">발전소</option>
<option value="활동">활동</option>
<option value="기타">기타</option>
</select>
</div>
<div class="col-md-3">
<label class="form-label small fw-bold">순서</label>
<input type="number" id="faq-order" class="form-control" value="0">
</div>
<div class="col-md-6 d-flex align-items-end">
<div class="form-check form-switch mb-2 ms-2">
<input class="form-check-input" type="checkbox" id="faq-visible" checked>
<label class="form-check-label small fw-bold" for="faq-visible">홈페이지에 공개</label>
</div>
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold">질문 (Q)</label>
<input type="text" id="faq-question" class="form-control" placeholder="예: 조합원 가입은 어떻게 하나요?">
</div>

<div class="mb-3">
<label class="form-label small fw-bold">답변 (A)</label>
<textarea id="faq-answer" class="form-control" rows="6" placeholder="답변 내용을 입력하세요."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary px-4" onclick="saveFaq()">저장하기</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="memberDetailModal" tabindex="-1" data-bs-backdrop="static">
<div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content">
<div class="modal-header bg-light">
<div>
<h5 class="modal-title fw-bold" id="md-title">조합원 상세 정보</h5>
<span class="badge bg-secondary" id="md-type-badge">-</span>
<span class="small text-muted ms-2" id="md-id-text">-</span>
</div>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body p-0">
<ul class="nav nav-tabs nav-justified" id="memberDetailTab" role="tablist">
<li class="nav-item">
<button class="nav-link active py-3" data-bs-toggle="tab" data-bs-target="#md-tab-basic" type="button">
📝 기본 정보
</button>
</li>
<li class="nav-item">
<button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#md-tab-funds" type="button">
💰 출자/배당/자금
</button>
</li>
<li class="nav-item">
<button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#md-tab-family" type="button">
👨‍👩‍👧‍👦 가족/단체 연결
</button>
</li>
<li class="nav-item">
<button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#md-tab-consult" type="button">
📞 상담 이력
</button>
</li>
</ul>

<div class="tab-content p-4">
<div class="tab-pane fade show active" id="md-tab-basic">
<input type="hidden" id="md-uid">

<div class="row g-3 mb-3">
<div class="col-md-3">
<label class="form-label small fw-bold text-muted">이름</label>
<input type="text" id="md-name" class="form-control fw-bold">
</div>
<div class="col-md-3">
<label class="form-label small fw-bold text-muted">연락처</label>
<input type="text" id="md-phone" class="form-control" maxlength="13" oninput="autoHyphen(this)">
</div>
<div class="col-md-3">
<label class="form-label small fw-bold text-muted">상태</label>
<select id="md-status" class="form-select">
<option value="승인대기">승인 대기</option>
<option value="정상">정상 (정조합원)</option>
<option value="탈퇴">탈퇴</option>
<option value="제명">제명</option>
</select>
</div>
<div class="col-md-3">
<label class="form-label small fw-bold text-muted">유형</label>
<select id="md-type" class="form-select">
<option value="개인">개인</option>
<option value="단체">단체</option>
</select>
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold text-muted">생년월일/성별 (주민/사업자번호)</label>
<div id="rrn-view-area" class="p-2 bg-light rounded border text-secondary fw-bold">
<span id="md-rrn-view">-</span>
</div>
<div id="rrn-edit-area" style="display:none;">
<input type="text" id="md-rrn" class="form-control" placeholder="변경하려면 숫자만 입력하세요" maxlength="14" oninput="autoHyphen(this)">
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold text-muted">주소</label>
<div class="input-group mb-1">
<input type="text" id="md-addr" class="form-control" readonly>
<button class="btn btn-outline-secondary" type="button" id="btn-addr-search" onclick="searchAddress()" style="display:none;">🔍 검색</button>
</div>
<input type="text" id="md-addr-detail" class="form-control" placeholder="상세 주소 (수정 시 입력)" style="display:none;">
</div>

<div class="row g-3 mb-3">
<div class="col-md-12">
<label class="form-label small fw-bold text-muted">관리자 메모</label>
<textarea id="md-memo" class="form-control" rows="2"></textarea>
</div>

<div class="col-12"><hr class="my-2"></div>

<div class="col-md-12">
<h6 class="fw-bold small text-primary mb-2">🏦 환급/배당 계좌 정보</h6>
<div class="row g-2 align-items-center bg-light p-3 rounded border">
<div class="col-md-3">
<label class="small text-muted">은행명</label>
<input type="text" id="md-bank-name" class="form-control form-control-sm">
</div>
<div class="col-md-3">
<label class="small text-muted">예금주</label>
<input type="text" id="md-bank-owner" class="form-control form-control-sm">
</div>
<div class="col-md-4">
<label class="small text-muted">계좌번호</label>
<div class="input-group input-group-sm">
<input type="text" id="md-bank-account" class="form-control" placeholder="숫자만 입력">
</div>
</div>
<div class="col-md-2 text-end pt-3">
<small class="text-muted fw-bold" id="md-sns-status" style="font-size:0.75rem;">SNS 미연동</small>
</div>
</div>
</div>
</div>

<div class="d-flex justify-content-between mt-4">
<button class="btn btn-outline-dark btn-sm" onclick="alert('준비중')">🖨️ 증명서</button>
<button id="btn-edit-mode" class="btn btn-primary px-4" onclick="toggleEditMode(true)">✏️ 정보 수정</button>
<div id="btn-save-group" style="display:none;">
<button class="btn btn-secondary me-2" onclick="toggleEditMode(false)">취소</button>
<button class="btn btn-success px-4 fw-bold" onclick="saveMemberBasic()">💾 저장 완료</button>
</div>
</div>
</div>


<div class="tab-pane fade" id="md-tab-funds">
<div class="d-flex justify-content-between align-items-center mb-2">
<h6 class="fw-bold m-0 text-success">💰 출자금 내역</h6>
<button class="btn btn-sm btn-outline-success" onclick="alert('Phase 3에서 구현: 출자금 수동 추가')">+ 입금 추가</button>
</div>
<div class="table-responsive mb-4 border rounded" style="max-height: 200px;">
<table class="table table-sm table-hover mb-0 text-center small">
<thead class="table-light sticky-top"><tr><th>날짜</th><th>금액</th><th>비고</th><th>관리</th></tr></thead>
<tbody id="md-capital-list"></tbody>
</table>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
<h6 class="fw-bold m-0 text-primary">🎁 기부금 내역</h6>
<button class="btn btn-sm btn-outline-primary" onclick="alert('Phase 3: 기부금 추가')">+ 기부 추가</button>
</div>
<div class="table-responsive mb-4 border rounded" style="max-height: 200px;">
<table class="table table-sm table-hover mb-0 text-center small">
<thead class="table-light sticky-top"><tr><th>날짜</th><th>금액</th><th>유형</th><th>비고</th><th>관리</th></tr></thead>
<tbody id="md-donation-list"></tbody>
</table>
</div>

<div class="row">
<div class="col-md-6">
<h6 class="fw-bold text-warning">🪙 포인트/적립금</h6>
<div class="border rounded p-3 text-center bg-light">
<h4 class="fw-bold mb-0" id="md-point-total">0 P</h4>
<button class="btn btn-sm btn-link text-decoration-none" onclick="alert('Phase 3: 포인트 내역 상세')">내역 보기</button>
</div>
</div>
<div class="col-md-6">
<h6 class="fw-bold text-info">💵 미지급 배당금</h6>
<div class="border rounded p-3 text-center bg-light">
<h4 class="fw-bold mb-0" id="md-dividend-total">0 원</h4>
<button class="btn btn-sm btn-link text-decoration-none" onclick="alert('Phase 3: 배당금 지급 처리')">지급 처리</button>
</div>
</div>
</div>
</div>

<div class="tab-pane fade" id="md-tab-family">
<div class="alert alert-light border small">
<i class="bi bi-info-circle"></i> 이 조합원이 관리하는 <strong>가족(자녀)</strong>이나 <strong>단체</strong> 목록입니다.
</div>
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-dark" onclick="alert('Phase 3: 자녀 계정 생성')">+ 자녀 계정 추가</button>
</div>
<table class="table table-bordered text-center align-middle">
<thead class="table-light"><tr><th>관계</th><th>이름</th><th>생년월일</th><th>상태</th><th>관리</th></tr></thead>
<tbody id="md-family-list">
<tr><td colspan="5" class="text-muted small py-3">연결된 가족/단체가 없습니다.</td></tr>
</tbody>
</table>
</div>

<div class="tab-pane fade" id="md-tab-consult">
<div class="input-group mb-3">
<input type="text" id="md-consult-input" class="form-control" placeholder="상담/통화 내용을 입력하세요 (예: 계좌번호 변경 요청)">
<button class="btn btn-dark" onclick="addConsultLog()">등록</button>
</div>
<div class="list-group list-group-flush border rounded overflow-auto" style="max-height: 400px;" id="md-consult-list">
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="modal fade" id="fundEditorModal" tabindex="-1" data-bs-backdrop="static">
<div class="modal-dialog modal-sm modal-dialog-centered">
<div class="modal-content shadow-lg">
<div class="modal-header bg-light py-2">
<h6 class="modal-title fw-bold" id="fund-modal-title">내역 입력</h6>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="fund-edit-id">   <input type="hidden" id="fund-edit-type"> <div class="mb-2">
<label class="form-label small fw-bold text-muted">날짜</label>
<input type="date" id="fund-date" class="form-control form-control-sm">
</div>

<div class="mb-2">
<label class="form-label small fw-bold text-muted">금액</label>
<input type="number" id="fund-amount" class="form-control form-control-sm" placeholder="숫자만 입력">
</div>

<div class="mb-2" id="fund-method-group" style="display:none;">
<label class="form-label small fw-bold text-muted">입금 방식</label>
<select id="fund-method" class="form-select form-select-sm">
<option value="transfer">계좌이체</option>
<option value="cash">현금</option>
<option value="card">카드</option>
<option value="etc">기타</option>
</select>
</div>

<div class="mb-2" id="fund-depositor-group">
<label class="form-label small fw-bold text-muted">입금자명</label>
<input type="text" id="fund-depositor" class="form-control form-control-sm">
</div>

<div class="mb-3">
<label class="form-label small fw-bold text-muted">비고 (메모)</label>
<input type="text" id="fund-note" class="form-control form-control-sm">
</div>

<button class="btn btn-primary w-100 btn-sm" onclick="saveFundData()">저장하기</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="customAlertModal" tabindex="-1" style="z-index: 9999;">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content text-center p-3 border-0 shadow">
<div class="modal-body">
<div class="mb-2" id="alertIcon"></div>
<h6 class="fw-bold mb-0" id="alertText"></h6>
</div>
<div class="modal-footer justify-content-center border-0 p-0 pb-2">
<button type="button" class="btn btn-sm btn-dark px-4" data-bs-dismiss="modal">확인</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="customConfirmModal" tabindex="-1" style="z-index: 9999;">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content border-0 shadow">
<div class="modal-header border-0 pb-0">
<h6 class="modal-title fw-bold">확인</h6>
</div>
<div class="modal-body py-4 text-center">
<p class="mb-0" id="confirmText">진행하시겠습니까?</p>
</div>
<div class="modal-footer border-0 justify-content-center pt-0">
<button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">취소</button>
<button type="button" class="btn btn-sm btn-primary" id="btnConfirmYes">확인</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="groupSearchModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h6 class="modal-title fw-bold">🏢 관리할 단체 찾기</h6>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="input-group mb-3">
<input type="text" id="group-search-input" class="form-control" placeholder="단체명 입력" onkeyup="if(event.key=='Enter') searchGroups()">
<button class="btn btn-outline-secondary" onclick="searchGroups()">검색</button>
</div>
<div class="list-group" id="group-search-result" style="max-height: 300px; overflow-y: auto;">
</div>
</div>
</div>
</div>
</div>


<div class="modal fade" id="relationSelectModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content">
<div class="modal-header bg-light">
<h6 class="modal-title fw-bold">➕ 가족/단체 추가</h6>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p class="small text-muted mb-3">어떤 관계를 추가하시겠습니까?</p>

<div class="form-check mb-3">
<input class="form-check-input" type="radio" name="relationType" id="rel-child" value="child" checked>
<label class="form-check-label fw-bold" for="rel-child">
👶 자녀 계정 생성
</label>
<div class="text-muted x-small ms-2">
- 부모 계정에 종속됨<br>
- 별도 로그인 불가
</div>
</div>

<div class="form-check">
<input class="form-check-input" type="radio" name="relationType" id="rel-org" value="org">
<label class="form-check-label fw-bold" for="rel-org">
🏢 단체 계정 연결
</label>
<div class="text-muted x-small ms-2">
- 내가 관리할 단체를 연결<br>
- 기존 가입된 단체 검색 필요
</div>
</div>
</div>
<div class="modal-footer p-2">
<button type="button" class="btn btn-primary w-100" onclick="confirmRelationType()">다음 단계로 이동</button>
</div>
</div>
</div>
</div>

    <div class="modal fade" id="childRegisterModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10">
                <h6 class="modal-title fw-bold">👶 자녀 조합원 등록</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning small py-2 mb-3">
                    <i class="bi bi-exclamation-circle-fill me-1"></i>
                    부모 계정에 종속된 가족 회원을 생성합니다. (별도 로그인 불가)
                </div>
                
                <form id="form-child-add">
                    <div class="mb-2">
                        <label class="form-label x-small text-muted mb-0">부모(관리자)</label>
                        <input type="text" id="child-parent-name" class="form-control form-control-sm bg-light" readonly>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-bold">자녀 이름 <span class="text-danger">*</span></label>
                        <input type="text" id="child-name" class="form-control" placeholder="이름 입력">
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-bold">주민등록번호 <span class="text-danger">*</span></label>
                        <input type="text" id="child-rrn" class="form-control" placeholder="숫자만 입력 (13자리)" maxlength="14" oninput="autoHyphen(this)">
                        <div class="form-text x-small">출자금 배당 및 세무 처리를 위해 필수입니다.</div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-bold">연락처 (부모 번호)</label>
                        <input type="text" id="child-phone" class="form-control" maxlength="13" oninput="autoHyphen(this)">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">주소 (부모 주소)</label>
                        <input type="text" id="child-address" class="form-control" placeholder="주소 입력">
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light p-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary btn-sm px-4 fw-bold" onclick="saveChildMember()">자녀 등록 완료</button>
            </div>
        </div>
    </div>
</div>

    





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ★ Supabase 설정 (Anon Key 사용 - RPC 보안으로 안전함)
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k'; 
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 전역 변수
let g_members = [];
// 전역 변수
let g_plants = []; // [추가] 발전소 목록 기억용

let g_badges = []; // DB에서 불러온 뱃지 목록을 기억해둠
let g_fund_page = 0; // [추가] 무한 스크롤 페이지 번호
const PAGE_SIZE = 20; // [추가] 한 번에 불러올 개수



// ★ [공통] 파일 업로드 함수 (한글 깨짐 방지 & 난수 이름 생성)
async function uploadFileToStorage(file, folderName) {
if (!file) return null;

// 1. 파일명 난수화 (예: '로고.png' -> 'partners/173901_x9z1a.png')
const fileExt = file.name.split('.').pop();
const randomName = Math.random().toString(36).substring(2, 10);
const safeFileName = `${folderName}/${Date.now()}_${randomName}.${fileExt}`;

// 2. 스토리지 업로드
const { error: uploadError } = await _supabase.storage.from('assets').upload(safeFileName, file);
if (uploadError) throw uploadError; // 에러 발생 시 호출한 곳으로 던짐

// 3. 공개 URL 반환
const { data } = _supabase.storage.from('assets').getPublicUrl(safeFileName);
return data.publicUrl;
}

// ★ [공통] 기존 파일 삭제 함수
async function deleteOldFile(fullUrl) {
if (!fullUrl) return;
try {
const path = fullUrl.split('/assets/')[1]; 
if (path) await _supabase.storage.from('assets').remove([path]);
} catch (e) { console.error("파일 삭제 오류:", e); }
}


// [권한 체크] RPC 함수로 보안 검증 (무한 루프 방지됨)
// [수정] 관리자 권한 체크 함수 (에러 방지 적용)
// [수정] 관리자 권한 체크 (방어 로직 강화 버전)
async function checkAdmin(user) {
// 1. [방어 코드] 인자로 user가 안 넘어왔다면, 스스로 다시 조회한다.
if (!user) {
const { data: { user: currentUser } } = await _supabase.auth.getUser();
user = currentUser;
}

// 2. 그래도 user가 없으면 로그인 안 된 상태 -> 튕겨냄
if (!user) {
// alert("로그인 정보가 없습니다."); // 필요 시 주석 해제
location.href = 'index.html'; 
return;
}

// 3. 기존 로직 유지 (RPC 권한 체크)
showLoading(true);
const { data: role, error } = await _supabase.rpc('get_my_role');
showLoading(false);

if (error) {
console.error("권한 조회 중 에러:", error);
alert("권한 정보를 확인할 수 없습니다.");
return;
}

// 4. 권한 분기 처리
if (role === 'admin') {
// (1) 로그인 게이트 숨김 (Null 체크 추가로 안전성 확보)
const loginGate = document.getElementById('login-gate');
if (loginGate) loginGate.classList.add('hidden');

// (2) 메인 시스템 노출
const mainSystem = document.getElementById('main-system');
if (mainSystem) mainSystem.classList.remove('hidden');

// (3) 프로필 이메일 표시 (여기서 에러 났었음 -> 이제 안전함)
const profileEl = document.getElementById('adminProfile');
if (profileEl && user.email) {
profileEl.innerText = user.email;
}

// (4) 데이터 로드 시작
// 초기 탭이 명부라면 로드 안 함(검색 유도), 대시보드라면 로드
// (fetchMembers()를 무조건 호출하던 기존 로직을 존중하되, 
//  아까 변경한 탭 로직과 충돌나지 않게 탭 상태를 보고 결정하거나 일단 호출)
//  fetchMembers(); 

} else {
// 권한 없음 처리
alert(`⛔ 접근 거부: 관리자 권한이 없습니다. (계정: ${user.email})`);
await _supabase.auth.signOut();
location.href = 'index.html';
}
}

// [로그인] 매직링크 전송
async function sendLoginLink() {
const email = document.getElementById('adminEmail').value;
if(!email) return alert('이메일을 입력하세요.');
const btn = document.getElementById('btnLogin');
btn.innerText = "전송중..."; btn.disabled = true;

const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });

if(error) { 
alert(error.message); btn.innerText = "다시 시도"; btn.disabled = false;
} else { 
document.getElementById('loginMsg').innerText = "이메일함에서 로그인 링크를 클릭하세요!";
document.getElementById('loginMsg').style.display = 'block';
btn.classList.add('hidden');
}
}

// ================================================================
// [기능 1] 조합원 관리 (RPC 사용)
// ================================================================


// 회원 수정 모달 열기
function openMemberEdit(id) {
const m = g_members.find(x => x.id === id);
if(!m) return;
document.getElementById('edit-id').value = m.id;
document.getElementById('edit-name').value = m.name;
document.getElementById('edit-phone').value = m.phone;
document.getElementById('edit-status').value = m.status;
document.getElementById('edit-note').value = m.note || '';
new bootstrap.Modal(document.getElementById('memberEditModal')).show();
}

// 회원 정보 저장 (RPC 호출)
async function saveMember() {
const updates = {
p_id: document.getElementById('edit-id').value,
p_name: document.getElementById('edit-name').value,
p_phone: document.getElementById('edit-phone').value,
p_status: document.getElementById('edit-status').value,
p_note: document.getElementById('edit-note').value
};

showLoading(true);
const { error } = await _supabase.rpc('update_member_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
alert('저장되었습니다.');
bootstrap.Modal.getInstance(document.getElementById('memberEditModal')).hide();
fetchMembers();
}
}

// 엑셀 다운로드 (보안/일반)
function togglePwd(show) { document.getElementById('pwdArea').style.display = show ? 'block' : 'none'; }
function openExcelModal() { new bootstrap.Modal(document.getElementById('excelModal')).show(); }

async function downloadExcel() {
const type = document.querySelector('input[name="excelOption"]:checked').value;
let dataToExport = [];

if(type === 'secret') {
const pwd = document.getElementById('decryptKey').value;
if(!pwd) return alert('비밀번호를 입력하세요.');
// 보안 데이터는 RPC로 가져와야 함 (여기서는 구현 생략 가능하면 생략하겠지만, 완전판 요청이므로 로직만 둡니다)
// 실제로는 get_decrypted_member 같은 함수가 필요합니다. 
// 일단은 현재 메모리에 있는 g_members로 진행하되 주민번호는 마스킹된 상태로 나갑니다.
alert('주의: 현재 보안용 복호화 RPC가 연결되지 않아 기본 정보만 다운로드됩니다.');
dataToExport = g_members;
} else {
dataToExport = g_members;
}

const excelData = dataToExport.map(m => ({
"조합원번호": m.member_id,
"이름": m.name,
"연락처": m.phone,
"상태": m.status,
"주민/사업자(마스킹)": m.rrn_display
}));

const ws = XLSX.utils.json_to_sheet(excelData);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "조합원명부");
XLSX.writeFile(wb, "조합원명부.xlsx");
bootstrap.Modal.getInstance(document.getElementById('excelModal')).hide();
}


// ================================================================
// [기능 2] 입금 매칭 (자바스크립트 엑셀 처리)
// ================================================================
function readExcel(input) {
const file = input.files[0];
if(!file) return;

const reader = new FileReader();
reader.onload = function(e) {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {type: 'array'});
const sheet = workbook.Sheets[workbook.SheetNames[0]];
const json = XLSX.utils.sheet_to_json(sheet);

const tbody = document.getElementById('depositResultBody');
tbody.innerHTML = '';

if(json.length === 0) { tbody.innerHTML='<tr><td colspan="3">데이터가 없습니다.</td></tr>'; return; }

json.forEach(row => {
// 엑셀 칼럼명 유연하게 찾기
const name = row['입금자'] || row['성명'] || row['보낸분'] || row['내용'];
const amt = row['입금액'] || row['금액'] || row['거래금액'];

if(name && amt) {
// 이름으로 매칭 시도
const match = g_members.find(m => m.name === name.trim());
let matchHtml = `<span class="text-danger">매칭 실패 (정보 없음)</span>`;

if(match) {
matchHtml = `<span class="text-success fw-bold">${match.name} (${match.member_id})</span>`;
}

tbody.innerHTML += `<tr>
                           <td>${name}</td>
                           <td>${Number(amt).toLocaleString()}원</td>
                           <td>${matchHtml}</td>
                       </tr>`;
}
});
};
reader.readAsArrayBuffer(file);
}


// ================================================================
// [기능 3] 공지사항 관리
// ================================================================
async function fetchNotices() {
// 읽기는 public 정책이 있어서 바로 select 가능
const { data } = await _supabase.from('coop_notices').select('*').order('created_at', {ascending:false});
const tbody = document.getElementById('noticeListBody');
tbody.innerHTML = '';

if(!data || data.length===0) { tbody.innerHTML='<tr><td colspan="6" class="text-center py-3">글이 없습니다.</td></tr>'; return; }

data.forEach(n => {
tbody.innerHTML += `<tr>
                   <td>${n.created_at.split('T')[0]}</td>
                   <td>${n.category}</td>
                   <td>${n.title}</td>
                   <td>${n.is_popup?'Y':'-'}</td>
                   <td>${n.status}</td>
                   <td><button class="btn btn-sm btn-light" onclick="openNoticeModal('${n.id}')">수정</button></td>
               </tr>`;
});
}

let g_current_notice_id = null;
// 공지 모달 열기 (내용 불러오기 추가)
async function openNoticeModal(id) {
g_current_notice_id = id || null;
document.getElementById('notice-id').value = id || '';

if(id) {
const { data } = await _supabase.from('coop_notices').select('*').eq('id', id).single();
if(data) {
document.getElementById('notice-title').value = data.title;
document.getElementById('notice-content').value = data.content || ''; // 내용 불러오기
document.getElementById('notice-category').value = data.category;
document.getElementById('notice-status').value = data.status;
document.getElementById('notice-popup').checked = data.is_popup;
}
} else {
document.getElementById('notice-title').value = '';
document.getElementById('notice-content').value = ''; // 초기화
document.getElementById('notice-popup').checked = false;
}
new bootstrap.Modal(document.getElementById('noticeModal')).show();
}

// 공지 저장 (내용 포함해서 전송)
async function saveNotice() {
const updates = {
p_id: document.getElementById('notice-id').value || null,
p_title: document.getElementById('notice-title').value,
p_content: document.getElementById('notice-content').value, // 내용 추가
p_category: document.getElementById('notice-category').value,
p_status: document.getElementById('notice-status').value,
p_is_popup: document.getElementById('notice-popup').checked
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_notice_secure', updates);
showLoading(false);

if(error) alert('저장 에러: ' + error.message);
else {
alert('저장되었습니다.');
bootstrap.Modal.getInstance(document.getElementById('noticeModal')).hide();
fetchNotices();
}
}


// ================================================================
// [기능 4] 홈페이지 컨텐츠 (발전소, 연혁)
// ================================================================

// --- 발전소 ---
// [수정] 발전소 목록 불러오기 (삭제 버튼 추가 + 전역변수 저장)
async function fetchPlants() {
const { data } = await _supabase.from('site_power_plants').select('*').order('display_order');
const tbody = document.getElementById('plantListBody');
tbody.innerHTML = '';

if(!data) {
g_plants = []; // 데이터 없으면 빈 배열
return;
}

g_plants = data; // ★ 핵심: 목록을 전역 변수에 저장 (나중에 순서 계산할 때 씀)

data.forEach(p => {
tbody.innerHTML += `<tr>
                   <td>${p.display_order}</td>
                   <td>${p.name}</td>
                   <td>${p.capacity}kW</td>
                   <td>${p.status}</td>
                   <td><a href="${p.monitor_url||'#'}" target="_blank" class="text-truncate" style="max-width:100px; display:inline-block;">${p.monitor_url||'-'}</a></td>
                   <td>
                       <button class="btn btn-sm btn-light" onclick="openPlantModal('${p.id}')">수정</button>
                       <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeletePlant('${p.id}')">삭제</button>
                   </td>
               </tr>`;
});
}
// [수정] 발전소 모달 열기 (순서 자동 계산)
// [수정 2] 발전소 모달 열기 (순서 자동 계산 + 빈칸 0 처리)

// [수정] 발전소 저장 (빈칸 -> 0 자동 변환 안전장치 추가)


// --- 연혁 ---
// 연혁 목록 불러오기 (삭제 버튼 추가됨)
async function fetchHistory() {
const { data } = await _supabase.from('site_documents').select('*').eq('category','history').order('event_date', {ascending:false});
const tbody = document.getElementById('historyListBody');
tbody.innerHTML = '';
if(!data) return;
data.forEach(h => {
tbody.innerHTML += `<tr>
                   <td>${h.event_date}</td>
                   <td>${h.title}</td>
                   <td>${h.content || ''}</td>
                   <td>
                       <button class="btn btn-sm btn-light" onclick="openHistoryModal('${h.id}')">수정</button>
                       <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteHistory('${h.id}')">삭제</button>
                   </td>
               </tr>`;
});
}
// [수정] 연혁 모달 열기 (HTML 태그를 -> 편집하기 편한 텍스트로 변환)
async function openHistoryModal(id) {
document.getElementById('hist-id').value = id || '';

if(id) {
const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
if(data) {
document.getElementById('hist-date').value = data.event_date;
document.getElementById('hist-title').value = data.title;

// ★ [핵심] DB의 HTML 태그를 사람이 보기 편한 텍스트로 복원
let rawText = data.content || '';
rawText = rawText.replaceAll('<br>', '\n');      // 줄바꿈 복원
rawText = rawText.replaceAll('<ul>', '');        // 리스트 태그 제거
rawText = rawText.replaceAll('</ul>', '');
rawText = rawText.replaceAll('<ul class="my-1">', '');
rawText = rawText.replace(/<li>/g, '- ');        // <li>를 '- '로 변환
rawText = rawText.replace(/<\/li>/g, '\n');      // </li>를 줄바꿈으로
rawText = rawText.replace(/\n\s*\n/g, '\n');     // 중복 줄바꿈 제거

document.getElementById('hist-content').value = rawText.trim();
}
} else {
// 신규 등록 시 초기화
document.getElementById('hist-title').value = '';
document.getElementById('hist-content').value = '';
// 날짜는 오늘 날짜로 기본 세팅해주면 편함
document.getElementById('hist-date').value = new Date().toISOString().substring(0, 10);
}
new bootstrap.Modal(document.getElementById('historyModal')).show();
}


// [수정] 연혁 저장 (있는 그대로 저장하기)
async function saveHistory() {
const updates = {
p_id: document.getElementById('hist-id').value || null,
p_date: document.getElementById('hist-date').value,
p_title: document.getElementById('hist-title').value,
p_content: document.getElementById('hist-content').value // 입력한 그대로 DB에 저장
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_history_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message); 
else { 
bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide(); 
fetchHistory(); 
}
}


// 유틸리티
function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
function logout() { _supabase.auth.signOut().then(() => location.href='index.html'); }
// [수정] 탭 전환 함수 (대시보드 로직 추가)

// ================================================================
// [기능 5] 섹션(메뉴) 관리 (ON/OFF)
// ================================================================

// 1. 섹션 목록 불러오기
async function fetchSections() {
// DB에서 순서대로 가져옴
const { data, error } = await _supabase
.from('site_sections')
.select('*')
.order('display_order');

if (error) {
console.error("섹션 로딩 에러:", error);
return;
}

const tbody = document.getElementById('sectionListBody');
tbody.innerHTML = '';

if (!data || data.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">섹션 정보가 없습니다.</td></tr>';
return;
}

data.forEach(sec => {
// 스위치가 켜져야 하는지 꺼져야 하는지 확인
const checkedAttr = sec.is_visible ? 'checked' : '';

// 상태 배지 (초록색/회색)
const statusBadge = sec.is_visible 
? '<span class="badge bg-success">공개중</span>' 
: '<span class="badge bg-secondary">숨김</span>';

// 테이블 행 추가
tbody.innerHTML += `
                   <tr>
                       <td class="align-middle text-center">${sec.display_order}</td>
                       <td class="align-middle text-start ps-4">
                           <span class="fw-bold text-dark">${sec.name}</span> <br>
                           <small class="text-muted" style="font-size:0.85em;">ID: ${sec.id}</small>
                       </td>
                       <td class="align-middle text-center">${statusBadge}</td>
                       <td class="align-middle text-center">
                           <div class="form-check form-switch d-inline-block">
                               <input class="form-check-input" type="checkbox" role="switch" 
                                   style="width: 45px; height: 24px; cursor: pointer;"
                                   ${checkedAttr} 
                                   onchange="toggleSection('${sec.id}', this.checked)">
                           </div>
                       </td>
                   </tr>
               `;
});
}

// 2. 스위치 변경 시 DB 즉시 저장
// 2. 스위치 변경 (수정됨: RPC 사용으로 권한 문제 해결)
async function toggleSection(id, isVisible) {
const { error } = await _supabase.rpc('update_section_visible', { 
p_id: id, 
p_visible: isVisible 
});

if(error) {
alert('변경 실패: ' + error.message);
fetchSections(); 
} else {
fetchSections();
}
}
// 연혁 삭제 함수

// [수정 1] 삭제 요청 (모달 띄우기)
// 연혁 삭제 요청
function askDeleteHistory(id) {
deleteType = 'history';
document.getElementById('delete-target-id').value = id;
// 버튼에 이벤트 연결
document.getElementById('btn-real-delete').onclick = confirmDelete;
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}

// [수정 2] 실제 삭제 실행 (모달에서 '삭제하기' 클릭 시)
async function confirmDeleteHistory() {
// 1. 저장해둔 ID 꺼내기
const id = document.getElementById('delete-target-id').value;
if (!id) return;

// 2. 모달 닫기
const modalEl = document.getElementById('deleteConfirmModal');
const modalInstance = bootstrap.Modal.getInstance(modalEl);
modalInstance.hide();

showLoading(true);
const { error } = await _supabase.rpc('delete_document_secure', { p_id: id });
showLoading(false);

if (error) {
// 에러도 모달로 띄워주면 좋지만, 일단 간단한 경고는 유지하거나 토스트로 대체 가능
// 요청하신대로 alert 대신 커스텀 알림을 원하시면 별도 모달이 필요합니다.
// 일단은 에러 상황은 드물기 때문에 콘솔에 찍고 넘어갑니다.
console.error('삭제 실패:', error.message);
} else {
fetchHistory(); // 목록 갱신
}
}
// ================================================================
// [기능 6] About(소개) 관리
// ================================================================
async function fetchAboutSettings() {
const { data, error } = await _supabase.from('site_about').select('*').single();
if(error && error.code !== 'PGRST116') { // 데이터 없음 에러는 무시
console.error(error); return;
}
if(data) {
document.getElementById('admin-about-title').value = data.title || '';
document.getElementById('admin-about-subtitle').value = data.subtitle || '';
document.getElementById('admin-about-content').value = data.content || '';
document.getElementById('admin-about-list').value = data.list_items || '';
document.getElementById('admin-about-img').value = data.image_url || '';
}
}




// [보조 함수] 전체 미리보기 업데이트 (탭 누를 때 실행됨)
// [수정] 전체 미리보기 (입력 안 한 건 안 보이게 처리)
// [수정] 전체 미리보기 (점 제거 반영)
function updateTotalPreview() {
const title = document.getElementById('admin-about-title').value;
const subtitle = document.getElementById('admin-about-subtitle').value;
const content = document.getElementById('admin-about-content').value;
const listText = document.getElementById('admin-about-list').value;
const imgUrl = document.getElementById('admin-about-img').value;

document.getElementById('prev-title').innerHTML = title;
document.getElementById('prev-subtitle').innerHTML = subtitle;
document.getElementById('prev-content').innerHTML = content;

const listEl = document.getElementById('prev-list');
// ★ 핵심: 미리보기 박스에도 'list-unstyled' 적용 (점 제거)
listEl.className = "list-unstyled mb-3"; 

if (!listText.trim()) {
listEl.innerHTML = '';
listEl.style.display = 'none';
} else {
listEl.style.display = 'block';
if (listText.includes('<li')) {
listEl.innerHTML = listText;
} else {
let html = '';
listText.split('\n').forEach(item => {
// 아이콘 없이 깔끔하게
if(item.trim()) html += `<li class="mb-1">${item.trim()}</li>`;
});
listEl.innerHTML = html;
}
}

const imgEl = document.getElementById('prev-img');
if(imgUrl) { imgEl.src = imgUrl; imgEl.style.display = 'block'; } 
else { imgEl.style.display = 'none'; }
}

// [수정] 소개글 저장하기 (모달 적용)
async function saveAboutSettings() {
const updates = {
p_title: document.getElementById('admin-about-title').value,
p_subtitle: document.getElementById('admin-about-subtitle').value,
p_content: document.getElementById('admin-about-content').value,
p_list_items: document.getElementById('admin-about-list').value,
p_image_url: document.getElementById('admin-about-img').value
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_about_secure', updates);
showLoading(false);

if(error) {
// 에러도 모달로 띄우면 좋겠죠? (내용 바꿔서 재활용)
document.getElementById('commonAlertText').innerText = '저장 실패: ' + error.message;
new bootstrap.Modal(document.getElementById('commonAlertModal')).show();
} else {
// 성공 모달 띄우기
document.getElementById('commonAlertText').innerText = '성공적으로 저장되었습니다!';
new bootstrap.Modal(document.getElementById('commonAlertModal')).show();

fetchAboutSettings(); // 저장 후 다시 불러오기
}
}
// [보조 함수] 상태에 따라 슬라이더 숨기기/보이기
function toggleProgressSlider() {
const status = document.getElementById('plant-status').value;
const area = document.getElementById('plant-progress-area');

if (status === '운영중') {
area.style.display = 'none'; // 운영중이면 100%니까 숨김
} else {
area.style.display = 'block'; // 공사/준비중이면 보임
}
}

// [수정] 발전소 모달 열기 (진행률 불러오기 추가)


// [수정] 발전소 저장 (진행률 포함 전송)

// [추가] 발전소 삭제 요청
function askDeletePlant(id) {
deleteType = 'plant';
document.getElementById('delete-target-id').value = id;
// 버튼에 이벤트 연결
document.getElementById('btn-real-delete').onclick = confirmDelete;
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}


// [수정] 통합 삭제 실행 함수 (중복 선언 해결 & 뱃지 삭제 추가)
// [수정] 통합 삭제 실행 함수 (중복 선언 해결 & 뱃지 삭제 추가)

// [신규] 슬라이더 움직일 때 단계 이름 표시
function updateProgressLabel(val) {
const v = Number(val);
let step = '';
if (v < 20) step = '조합설립 단계';
else if (v < 40) step = '부지선정 단계';
else if (v < 60) step = '인허가 단계';
else if (v < 80) step = '착공/공사 단계';
else step = '완공/운영 단계';

document.getElementById('plant-progress-label').innerText = `${v}% (${step})`;
}

// [신규] 글씨 클릭하면 슬라이더 이동
function setProg(val) {
document.getElementById('plant-progress').value = val;
updateProgressLabel(val);
}



// [신규] 스토리지에서 실제 파일 삭제하는 함수


// [신규] 사진 삭제 버튼 클릭 시 (화면에서만 먼저 지움)
function clearPlantImage() {
document.getElementById('plant-file').value = ''; // 파일 선택 취소
document.getElementById('plant-img-url').value = ''; // 저장될 URL 비움

// 프리뷰 감추기
document.getElementById('plant-img-preview').style.display = 'none';
document.getElementById('plant-img-preview').src = '';
document.getElementById('plant-img-placeholder').style.display = 'block';
}

// [기존 수정] 이미지 미리보기
function previewImage(input) {
const file = input.files[0];
const preview = document.getElementById('plant-img-preview');
const placeholder = document.getElementById('plant-img-placeholder');

if(file) {
const reader = new FileReader();
reader.onload = function(e) {
preview.src = e.target.result;
preview.style.display = 'block';
placeholder.style.display = 'none';
}
reader.readAsDataURL(file);
}
}

// [기존 수정] 발전소 모달 열기 (기존 이미지 URL 기억하기)
async function openPlantModal(id) {
document.getElementById('plant-id').value = id || '';
document.getElementById('plant-file').value = ''; 

if(id) {
// 수정 모드
const { data } = await _supabase.from('site_power_plants').select('*').eq('id', id).single();
if(data) {
document.getElementById('plant-name').value = data.name;
document.getElementById('plant-capacity').value = data.capacity;
document.getElementById('plant-order').value = data.display_order;
document.getElementById('plant-location').value = data.location || '';
document.getElementById('plant-area').value = data.area || '';
document.getElementById('plant-date').value = data.completion_date || '';
document.getElementById('plant-status').value = data.status;
document.getElementById('plant-url').value = data.monitor_url || '';

const rate = data.progress_rate || 0;
document.getElementById('plant-progress').value = rate;
updateProgressLabel(rate);

// ★ 이미지 처리 (원본 기억 + 현재 상태 설정)
const imgUrl = data.image_url || '';
document.getElementById('plant-img-original').value = imgUrl; // [중요] 원본 기억 (나중에 삭제할 때 씀)
document.getElementById('plant-img-url').value = imgUrl;      // 현재 상태

const preview = document.getElementById('plant-img-preview');
const placeholder = document.getElementById('plant-img-placeholder');
if(imgUrl) {
preview.src = imgUrl;
preview.style.display = 'block';
placeholder.style.display = 'none';
} else {
preview.style.display = 'none';
placeholder.style.display = 'block';
}
}
} else {
// 신규 모드
const maxOrder = g_plants.length > 0 ? Math.max(...g_plants.map(p => p.display_order)) : 0;
['plant-name','plant-capacity','plant-url','plant-location','plant-area','plant-date','plant-img-url','plant-img-original'].forEach(id => document.getElementById(id).value = '');

document.getElementById('plant-order').value = maxOrder + 1; 
document.getElementById('plant-status').value = '준비중';
document.getElementById('plant-progress').value = 0;
updateProgressLabel(0);

document.getElementById('plant-img-preview').style.display = 'none';
document.getElementById('plant-img-placeholder').style.display = 'block';
}
toggleProgressSlider();
new bootstrap.Modal(document.getElementById('plantModal')).show();
}

// [기존 수정] 발전소 저장 (자동 삭제 로직 포함)
async function savePlant() {
const name = document.getElementById('plant-name').value;
if (!name) { alert("발전소명을 입력해주세요."); return; }

showLoading(true);

const fileInput = document.getElementById('plant-file');
const originalUrl = document.getElementById('plant-img-original').value; // 원래 있던 사진
let finalImgUrl = document.getElementById('plant-img-url').value;      // 최종 저장될 사진 주소

// 1. 새 파일이 업로드된 경우
if (fileInput.files.length > 0) {
const file = fileInput.files[0];
const fileName = `plants/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;

// (1) 새 파일 업로드
const { data: uploadData, error: uploadError } = await _supabase.storage.from('assets').upload(fileName, file);
if (uploadError) {
showLoading(false);
alert('사진 업로드 실패: ' + uploadError.message);
return;
}
const { data: publicUrlData } = _supabase.storage.from('assets').getPublicUrl(fileName);
finalImgUrl = publicUrlData.publicUrl;

// (2) ★ 중요: 옛날 사진이 있었다면 삭제! (쓰레기 파일 정리)
if (originalUrl) {
await deleteOldFile(originalUrl);
}
} 
// 2. 파일은 안 올렸는데, [삭제 버튼]을 눌러서 URL이 비어버린 경우
else if (originalUrl && !finalImgUrl) {
// ★ 중요: 원래 사진을 삭제함
await deleteOldFile(originalUrl);
}

// 3. DB 저장 (나머지는 기존과 동일)
const capVal = document.getElementById('plant-capacity').value;
const orderVal = document.getElementById('plant-order').value;

const capacity = (capVal === '' || isNaN(capVal)) ? 0 : Number(capVal);
const order = (orderVal === '' || isNaN(orderVal)) ? 0 : Number(orderVal);
const status = document.getElementById('plant-status').value;
const progress = (status === '운영중') ? 100 : Number(document.getElementById('plant-progress').value);

const updates = {
p_id: document.getElementById('plant-id').value || null,
p_name: name,
p_capacity: capacity,
p_status: status,
p_display_order: order,
p_progress: progress,
p_location: document.getElementById('plant-location').value,
p_area: document.getElementById('plant-area').value,
p_completion_date: document.getElementById('plant-date').value || null,
p_image_url: finalImgUrl
};

const { error } = await _supabase.rpc('upsert_plant_secure', updates);
showLoading(false);

if(error) {
if(document.getElementById('commonAlertModal')) {
document.getElementById('commonAlertText').innerText = '저장 실패: ' + error.message;
new bootstrap.Modal(document.getElementById('commonAlertModal')).show();
} else alert('저장 실패: ' + error.message);
} else { 
bootstrap.Modal.getInstance(document.getElementById('plantModal')).hide(); 
fetchPlants(); 
}
}
// ================================================================
// [기능 8] 문서 관리 (정관/규약)
// ================================================================

// 1. 문서 목록 불러오기
async function fetchDocs() {
// category가 'doc'인 것만 가져옴
const { data } = await _supabase.from('site_documents').select('*').eq('category', 'doc').order('event_date', {ascending:false});
const tbody = document.getElementById('docListBody');
tbody.innerHTML = '';

if(!data || data.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-muted">등록된 문서가 없습니다.</td></tr>';
return;
}

data.forEach(d => {
const fileBtn = d.file_url 
? `<a href="${d.file_url}" target="_blank" class="btn btn-xs btn-outline-success"><i class="bi bi-file-pdf"></i> 보기</a>` 
: '<span class="text-muted text-xs">없음</span>';

tbody.innerHTML += `<tr>
                   <td><div class="fw-bold">${d.version || '-'}</div><small class="text-muted">${d.event_date}</small></td>
                   <td>${d.title}</td>
                   <td class="text-start small text-truncate" style="max-width:200px;">${d.content || '-'}</td>
                   <td>${fileBtn}</td>
                   <td>
                       <button class="btn btn-sm btn-light" onclick="openDocModal('${d.id}')">수정</button>
                       <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteDoc('${d.id}')">삭제</button>
                   </td>
               </tr>`;
});
}

// 2. 모달 열기
// [수정] 문서 모달 열기


// [수정] 문서 저장 (is_current 포함)

// [수정] 문서 모달 열기 (파일 관련 제거)
async function openDocModal(id) {
document.getElementById('doc-id').value = id || '';

if(id) {
const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
if(data) {
document.getElementById('doc-title').value = data.title;
document.getElementById('doc-version').value = data.version || '';
document.getElementById('doc-date').value = data.event_date;
document.getElementById('doc-content').value = data.content || '';
document.getElementById('doc-current').checked = data.is_current;
}
} else {
// 신규
document.getElementById('doc-title').value = '정관';
document.getElementById('doc-version').value = '';
document.getElementById('doc-date').value = new Date().toISOString().substring(0, 10);
document.getElementById('doc-content').value = '';
document.getElementById('doc-current').checked = true;
}
new bootstrap.Modal(document.getElementById('docModal')).show();
}

// [수정] 문서 저장 (파일 로직 삭제)
async function saveDoc() {
const title = document.getElementById('doc-title').value;
if(!title) return alert("제목을 입력하세요.");

showLoading(true);

// 파일 업로드 로직 삭제됨 (순수 텍스트만 저장)

const updates = {
p_id: document.getElementById('doc-id').value || null,
p_category: 'doc', 
p_title: title,
p_date: document.getElementById('doc-date').value,
p_content: document.getElementById('doc-content').value,
p_version: document.getElementById('doc-version').value,
p_file_url: null, // 파일 없음
p_is_current: document.getElementById('doc-current').checked
};

const { error } = await _supabase.rpc('upsert_document_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('docModal')).hide();
fetchDocs();
}
}

// 삭제 (기존 삭제 함수 재활용)
function askDeleteDoc(id) {
deleteType = 'history'; // 문서는 기술적으로 history와 같은 테이블(site_documents)을 씀
document.getElementById('delete-target-id').value = id;
document.getElementById('btn-real-delete').onclick = confirmDelete; 
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}
// [수정] 파트너 목록 불러오기 (badges.js 활용)
async function fetchPartners() {
    const { data: list, error } = await _supabase.from('site_partners').select('*').order('display_order');
    if(error) { console.error(error); return; }

    // 1. 뱃지 데이터 로드 (Badges 모듈 사용)
    if (!g_badges || g_badges.length === 0) {
        g_badges = await Badges.getAll(_supabase);
    }

    const pendingBody = document.getElementById('partnerPendingBody');
    const activeBody = document.getElementById('partnerActiveBody');
    pendingBody.innerHTML = ''; activeBody.innerHTML = '';

    // 상태별 분리
    const pendingList = list.filter(p => p.status === 'pending');
    const activeList = list.filter(p => p.status !== 'pending');

    // (A) 대기 목록
    if(pendingList.length === 0) pendingBody.innerHTML = '<tr><td class="text-center text-muted py-3 small">승인 대기 중인 신청이 없습니다.</td></tr>';
    else {
        pendingList.forEach(p => {
            pendingBody.innerHTML += `
                <tr class="bg-warning bg-opacity-10">
                    <td class="align-middle fw-bold ps-3">${p.name}</td>
                    <td class="align-middle small text-muted">${p.description || '-'}</td>
                    <td class="align-middle text-end pe-3">
                        <button class="btn btn-sm btn-primary" onclick="openPartnerModal('${p.id}')">승인</button>
                    </td>
                </tr>`;
        });
    }

    // (B) 등록 목록
    if(activeList.length === 0) activeBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">등록된 파트너가 없습니다.</td></tr>';
    else {
        activeList.forEach(p => {
            let badgesHtml = '';
            // ★ [핵심 변경] badges.js의 renderPill 사용
            if(p.badges && p.badges.length > 0) {
                p.badges.forEach(bCode => {
                    const b = g_badges.find(item => item.code === bCode);
                    badgesHtml += Badges.renderPill(b); 
                });
            }
            const logo = p.logo_url ? `<img src="${p.logo_url}" style="max-height:40px;">` : '-';

            activeBody.innerHTML += `
                <tr>
                    <td class="text-center">${p.display_order}</td>
                    <td class="text-center">${logo}</td>
                    <td><div class="fw-bold">${p.name}</div><div class="small text-muted text-truncate" style="max-width:200px;">${p.description||'-'}</div></td>
                    <td>${badgesHtml}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-light" onclick="openPartnerModal('${p.id}')">수정</button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeletePartner('${p.id}')">삭제</button>
                    </td>
                </tr>`;
        });
    }
}
// [수정] 파트너 모달 열기 (badges.js 활용)
async function openPartnerModal(id) {
    document.getElementById('pt-id').value = id || '';

    // 1. 뱃지 데이터 준비 (캐시 활용)
    if (!g_badges || g_badges.length === 0) {
        g_badges = await Badges.getAll(_supabase);
    }

    // 2. 수정 모드
    if(id) { 
        const { data } = await _supabase.from('site_partners').select('*').eq('id', id).single();
        if(data) {
            document.getElementById('pt-name').value = data.name;
            document.getElementById('pt-member-id').value = data.member_id || '';
            document.getElementById('pt-desc').value = data.description || '';
            document.getElementById('pt-link').value = data.link_url || '';
            document.getElementById('pt-status').value = data.status || 'active';
            document.getElementById('pt-order').value = data.display_order;

            // ★ [핵심 변경] 체크박스 자동 렌더링 (보유한 뱃지 코드 배열 전달)
            Badges.renderCheckboxes('badge-checkboxes', g_badges, data.badges || []);
            
            handleImagePreview('pt', data.logo_url);
        }
    } 
    // 3. 신규 모드
    else { 
        document.getElementById('pt-name').value = '';
        document.getElementById('pt-member-id').value = '';
        document.getElementById('pt-desc').value = '';
        document.getElementById('pt-link').value = '';
        document.getElementById('pt-status').value = 'active';
        document.getElementById('pt-order').value = 99;

        // ★ [핵심 변경] 체크박스 자동 렌더링 (선택 없음)
        Badges.renderCheckboxes('badge-checkboxes', g_badges, []);
        
        handleImagePreview('pt', null);
    }

    document.getElementById('pt-file').value = '';
    new bootstrap.Modal(document.getElementById('partnerModal')).show();
}
// 4. 파트너 저장
// [3] 저장 함수 (ID 처리 + 공통 파일 함수 사용)
async function savePartner() {
const name = document.getElementById('pt-name').value;
if(!name) return alert('단체명을 입력하세요.');

// ★ [핵심] 빈 문자열 ID를 NULL로 변환 (BigInt/UUID 에러 방지)
let idVal = document.getElementById('pt-id').value;
if (!idVal || idVal.trim() === '') idVal = null;

showLoading(true);

// 1. 파일 업로드 (공통 함수 사용으로 코드 대폭 단축)
const fileInput = document.getElementById('pt-file');
const originalUrl = document.getElementById('pt-img-original').value;
let finalImgUrl = document.getElementById('pt-img-url').value;

try {
if (fileInput.files.length > 0) {
// ★ 한글명 걱정 끝! 공통 함수 호출
finalImgUrl = await uploadFileToStorage(fileInput.files[0], 'partners');
if(originalUrl) await deleteOldFile(originalUrl); // 기존 파일 삭제
} else if (originalUrl && !finalImgUrl) {
await deleteOldFile(originalUrl); // 삭제 버튼 누른 경우
}
} catch (e) {
showLoading(false);
return alert('이미지 업로드 오류: ' + e.message);
}

// 2. 뱃지 데이터 수집
const selectedBadges = [];
document.querySelectorAll('#badge-checkboxes input:checked').forEach(cb => selectedBadges.push(cb.value));

// 3. DB 저장 (RPC 호출)
const updates = {
p_id: idVal, // NULL 또는 UUID
p_name: name,
p_link_url: document.getElementById('pt-link').value,
p_logo_url: finalImgUrl,
p_display_order: Number(document.getElementById('pt-order').value),
p_description: document.getElementById('pt-desc').value,
p_member_id: document.getElementById('pt-member-id').value,
p_status: document.getElementById('pt-status').value,
p_badges: selectedBadges
};

const { error } = await _supabase.rpc('upsert_partner_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('partnerModal')).hide();
fetchPartners();
}
}

// 5. 파트너 삭제
function askDeletePartner(id) {
deleteType = 'partner'; // confirmDelete 함수에서 처리하도록 분기 추가 필요
document.getElementById('delete-target-id').value = id;
document.getElementById('btn-real-delete').onclick = confirmDelete; 
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}
// [보조] 이미지 프리뷰 공통 처리 함수 (코드 중복 줄이기)
function handleImagePreview(prefix, url) {
document.getElementById(`${prefix}-img-original`).value = url || '';
document.getElementById(`${prefix}-img-url`).value = url || '';
const preview = document.getElementById(`${prefix}-img-preview`);
const placeholder = document.getElementById(`${prefix}-img-placeholder`);

if(url) {
preview.src = url; preview.style.display = 'block'; placeholder.style.display = 'none';
} else {
preview.src = ''; preview.style.display = 'none'; placeholder.style.display = 'block';
}
}
// [보조] 파일 선택 시 프리뷰 (HTML onchange에 연결됨)
function previewPartnerImage(input) {
if(input.files && input.files[0]) {
const reader = new FileReader();
reader.onload = function(e) {
document.getElementById('pt-img-preview').src = e.target.result;
document.getElementById('pt-img-preview').style.display = 'block';
document.getElementById('pt-img-placeholder').style.display = 'none';
};
reader.readAsDataURL(input.files[0]);
}
}

// [보조] 이미지 삭제 버튼
function clearPartnerImage() {
document.getElementById('pt-file').value = '';
document.getElementById('pt-img-url').value = '';
document.getElementById('pt-img-preview').style.display = 'none';
document.getElementById('pt-img-placeholder').style.display = 'block';
}
// 1. 뱃지 목록 불러오기
// [수정] 뱃지 목록 조회 (badges.js 활용)
async function fetchBadges() {
    // ★ [핵심 변경] DB 직접 조회 대신 모듈 사용 (캐싱 적용됨)
    g_badges = await Badges.getAll(_supabase);

    const tbody = document.getElementById('badgeListBody');
    if(!tbody) return; 
    
    tbody.innerHTML = '';
    g_badges.forEach(b => {
        // 색상 표시용 뱃지 (Pill 아님, 관리용)
        const colorBadge = `<span class="badge bg-${b.color} text-white">${b.color}</span>`;

        tbody.innerHTML += `
            <tr>
                <td>${b.display_order}</td>
                <td class="fs-4">${b.icon || ''}</td>
                <td class="text-start">
                    <div class="fw-bold">${b.name}</div>
                    <div class="small text-muted">${b.description || '-'}</div>
                </td>
                <td class="small font-monospace">${b.code}</td>
                <td>${colorBadge}</td>
                <td>
                    <button class="btn btn-sm btn-light" onclick="openBadgeModal('${b.id}')">수정</button>
                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteBadge('${b.id}')">삭제</button>
                </td>
            </tr>
        `;
    });
}

// 2. 뱃지 모달 열기
async function openBadgeModal(id) {
document.getElementById('bg-id').value = id || '';
if(id) {
const b = g_badges.find(x => x.id == id); // 전역변수에서 찾음 (DB호출 절약)
if(b) {
document.getElementById('bg-code').value = b.code;
document.getElementById('bg-icon').value = b.icon;
document.getElementById('bg-name').value = b.name;
document.getElementById('bg-desc').value = b.description;
document.getElementById('bg-color').value = b.color;
document.getElementById('bg-order').value = b.display_order;
}
} else {
document.getElementById('bg-code').value = '';
document.getElementById('bg-icon').value = '🏅';
document.getElementById('bg-name').value = '';
document.getElementById('bg-desc').value = '';
document.getElementById('bg-color').value = 'primary';
document.getElementById('bg-order').value = g_badges.length + 1;
}
new bootstrap.Modal(document.getElementById('badgeModal')).show();
}

// 3. 뱃지 저장
async function saveBadge() {
const updates = {
p_id: document.getElementById('bg-id').value || null,
p_code: document.getElementById('bg-code').value,
p_icon: document.getElementById('bg-icon').value,
p_name: document.getElementById('bg-name').value,
p_desc: document.getElementById('bg-desc').value,
p_color: document.getElementById('bg-color').value,
p_order: Number(document.getElementById('bg-order').value)
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_badge_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('badgeModal')).hide();
fetchBadges(); // 목록 갱신
}
}

// 4. 뱃지 삭제
function askDeleteBadge(id) {
deleteType = 'badge'; 
document.getElementById('delete-target-id').value = id;
document.getElementById('btn-real-delete').onclick = confirmDelete; 
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}
// ================================================================
// [기능 10] FAQ 관리
// ================================================================

// 1. FAQ 목록 불러오기
async function fetchFaqs() {
const keyword = document.getElementById('search-faq').value;

// DB 조회 (순서대로)
let query = _supabase.from('site_faqs').select('*').order('display_order', { ascending: true });

// 검색어가 있으면 필터링
if (keyword) {
query = query.ilike('question', `%${keyword}%`);
}

const { data: list, error } = await query;
if (error) { console.error(error); return; }

const tbody = document.getElementById('faqListBody');
if (!tbody) return; // 탭이 없으면 패스
tbody.innerHTML = '';

if (!list || list.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">등록된 질문이 없습니다.</td></tr>';
return;
}

list.forEach(f => {
const badge = f.is_visible 
? '<span class="badge bg-success">공개</span>' 
: '<span class="badge bg-secondary">숨김</span>';

const answerPreview = f.answer && f.answer.length > 50 
? f.answer.substring(0, 50) + '...' 
: f.answer;

tbody.innerHTML += `
           <tr>
               <td class="text-center">${f.display_order}</td>
               <td class="text-center"><span class="badge bg-light text-dark border">${f.category}</span></td>
               <td>
                   <div class="fw-bold text-primary mb-1">Q. ${f.question}</div>
                   <div class="small text-muted text-truncate" style="max-width:400px;">A. ${answerPreview}</div>
               </td>
               <td class="text-center">${badge}</td>
               <td class="text-center">
                   <button class="btn btn-sm btn-light" onclick="openFaqModal('${f.id}')">수정</button>
                   <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteFaq('${f.id}')">삭제</button>
               </td>
           </tr>
       `;
});
}

// 2. 모달 열기 (등록/수정)
async function openFaqModal(id) {
document.getElementById('faq-id').value = id || '';

if (id) {
// 수정 모드
const { data } = await _supabase.from('site_faqs').select('*').eq('id', id).single();
if (data) {
document.getElementById('faq-category').value = data.category || '기타';
document.getElementById('faq-order').value = data.display_order;
document.getElementById('faq-visible').checked = data.is_visible;
document.getElementById('faq-question').value = data.question;
document.getElementById('faq-answer').value = data.answer;
}
} else {
// 신규 모드
document.getElementById('faq-category').value = '가입/탈퇴';
document.getElementById('faq-order').value = 0; // 맨 앞
document.getElementById('faq-visible').checked = true;
document.getElementById('faq-question').value = '';
document.getElementById('faq-answer').value = '';
}

new bootstrap.Modal(document.getElementById('faqModal')).show();
}

// 3. 저장 함수
async function saveFaq() {
const question = document.getElementById('faq-question').value;
const answer = document.getElementById('faq-answer').value;

if (!question || !answer) return alert('질문과 답변을 모두 입력해주세요.');

// ID 처리 (UUID 오류 방지)
let idVal = document.getElementById('faq-id').value;
if (!idVal || idVal.trim() === '') idVal = null;

const updates = {
p_id: idVal,
p_category: document.getElementById('faq-category').value,
p_display_order: Number(document.getElementById('faq-order').value),
p_is_visible: document.getElementById('faq-visible').checked,
p_question: question,
p_answer: answer
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_faq_secure', updates);
showLoading(false);

if (error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('faqModal')).hide();
fetchFaqs();
}
}

// 4. 삭제 요청
function askDeleteFaq(id) {
  deleteType = 'faq';
  document.getElementById('delete-target-id').value = id;
  document.getElementById('btn-real-delete').onclick = confirmDelete;
  new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}


// ================================================================
// [수정] 통합 삭제 함수에 FAQ 추가 (기존 confirmDelete 교체)
// ================================================================
async function confirmDelete() {
  const id = document.getElementById('delete-target-id').value;

  const modalEl = document.getElementById('deleteConfirmModal');
  const inst = bootstrap.Modal.getInstance(modalEl);
  if (inst) inst.hide();

  showLoading(true);

  let rpcName = '';
  if (deleteType === 'history') rpcName = 'delete_document_secure';
  else if (deleteType === 'plant') rpcName = 'delete_plant_secure';
  else if (deleteType === 'partner') rpcName = 'delete_partner_secure';
  else if (deleteType === 'badge') rpcName = 'delete_badge_secure';
  else if (deleteType === 'faq') rpcName = 'delete_faq_secure';

  // ★ 방어: 분기 누락 시 중단
  if (!rpcName) {
    showLoading(false);
    alert('삭제 타입이 정의되지 않았습니다. (deleteType 확인 필요)');
    return;
  }

  const { error } = await _supabase.rpc(rpcName, { p_id: id });
  showLoading(false);

  if (error) {
    alert('삭제 실패: ' + error.message);
    return;
  }

  // 목록 새로고침
  if (deleteType === 'history') fetchHistory();
  else if (deleteType === 'plant') fetchPlants();
  else if (deleteType === 'partner') fetchPartners();
  else if (deleteType === 'badge') fetchBadges();
  else if (deleteType === 'faq') fetchFaqs();
}

// ================================================================
// [기능 0] 대시보드 로드 및 유틸
// ================================================================


// 승인 대기 카드 클릭 시 조합원 탭으로 이동
function goToPendingMembers() {
  // 이 페이지는 Bootstrap Tab이 아니라 switchTab 기반
  switchTab('members');

  // 필터 적용 후 조회
  setTimeout(() => {
    const statusEl = document.getElementById('filter-status');
    if (statusEl) statusEl.value = '승인대기';
    fetchMembers();
  }, 80);
}


// 숫자 애니메이션 효과 함수
function animateNumber(id, target, isMoney = false) {
const el = document.getElementById(id);
if(!el) return;

const start = 0;
const duration = 1000; // 1초 동안 실행
const startTime = performance.now();

function update(currentTime) {
const elapsed = currentTime - startTime;
const progress = Math.min(elapsed / duration, 1);
const value = Math.floor(progress * (target - start) + start);

el.innerText = isMoney 
? value.toLocaleString() + '원' 
: value.toLocaleString() + (id.includes('capital') ? '' : (id.includes('consult')?'건':'명'));

if (progress < 1) requestAnimationFrame(update);
else el.innerText = isMoney 
? target.toLocaleString() + '원' 
: target.toLocaleString() + (id.includes('capital') ? '' : (id.includes('consult')?'건':'명'));
}
requestAnimationFrame(update);
}


// ================================================================
// [기능 1] 조합원 목록 조회 (검색/필터/정렬 완비)
// ================================================================



// 테이블 렌더링 함수
// [수정 1] 탭 전환 함수 (딜레이 없이 즉시 전환)
// [수정] 탭 전환 함수 (모든 탭 ID 매칭 보장)
// 기존 switchTab 함수를 찾아서 이 부분만 바꾸거나 함수 전체를 교체하세요.

// [수정] 탭 전환 함수 (자동 로드 제거 -> 초기화 화면 호출)
function switchTab(tabName) {
// 1. 탭 숨김 처리 (기존 코드 유지)
const panes = document.querySelectorAll('.main-content > .tab-pane'); 
panes.forEach(el => { el.classList.remove('show', 'active'); el.style.display = 'none'; });

// 2. 탭 보임 처리 (기존 코드 유지)
const target = document.getElementById('tab-' + tabName);
if (target) { target.style.display = 'block'; setTimeout(() => target.classList.add('show', 'active'), 10); }

// 3. 네비게이션 활성화 (기존 코드 유지)
document.querySelectorAll('.sidebar-menu .nav-link').forEach(el => el.classList.remove('active'));
const navBtn = document.getElementById('nav-' + tabName);
if(navBtn) navBtn.classList.add('active');

// 4. ★ 데이터 로드 로직 변경 (핵심)
if (tabName === 'dashboard') {
loadDashboard();
} 
else if (tabName === 'members') {
// fetchMembers();  <-- [삭제] 이제 자동으로 안 불러옵니다.
renderEmptyState(); // [신규] "검색 조건을 입력하세요" 화면 띄우기
}
else if (tabName === 'notices') {
fetchNotices();
}
}

// [수정 2] 대시보드 로드 (애니메이션 제거 -> 즉시 표시)
// [수정] 대시보드 통계 로드 (한글 상태값 대응)
// [수정] 대시보드 데이터 로드 (4대 지표 완벽 복구 버전)
async function loadDashboard() {
    console.log("대시보드 데이터 로딩 시작...");

    // 1. 총 조합원 수 (전체 카운트)
    const { count: totalCount, error: err1 } = await _supabase
        .from('coop_members')
        .select('*', { count: 'exact', head: true });

    // 2. 승인 대기 수 (한글 '승인대기' 매칭)
    const { count: pendingCount, error: err2 } = await _supabase
        .from('coop_members')
        .select('*', { count: 'exact', head: true })
        .eq('status', '승인대기'); // DB에 저장된 한글 값 기준

    // 3. [복구] 오늘의 상담 건수 (오늘 0시 이후 데이터)
    const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    const { count: todayConsult, error: err3 } = await _supabase
        .from('consult_logs')
        .select('*', { count: 'exact', head: true })
        .gte('created_at', todayStr);

    // 4. [복구] 누적 출자금 합계 (뷰 활용)
    // (뷰가 없으면 0원으로 처리되도록 에러 핸들링 포함)
    let totalCapital = 0;
    const { data: capitalData, error: err4 } = await _supabase
        .from('view_member_list')
        .select('total_capital');
    
    if (!err4 && capitalData) {
        // 배열을 순회하며 합산
        totalCapital = capitalData.reduce((sum, row) => sum + (row.total_capital || 0), 0);
    }

    // 에러 로그 (디버깅용)
    if (err1 || err2 || err3) console.error("대시보드 일부 데이터 로드 실패:", err1, err2, err3);

    // --- UI 업데이트 (HTML ID 유무 확인 후 안전하게 값 주입) ---

    // (1) 총 조합원
    const totalEl = document.getElementById('dashboard-total-count'); // 메인 숫자
    const dashTotal = document.getElementById('dash-total'); // (구) 카드 ID 호환
    const valTotal = (totalCount || 0) + '명';
    if (totalEl) totalEl.innerText = valTotal;
    if (dashTotal) dashTotal.innerText = valTotal;

    // (2) 승인 대기
    const pendingEl = document.getElementById('dashboard-pending-count');
    const dashPending = document.getElementById('dash-pending');
    const pCount = pendingCount || 0;
    const pText = pCount + '명';
    
    if (pendingEl) {
        pendingEl.innerText = pText;
        // 대기자가 있으면 빨간색, 없으면 검은색(기본)
        pendingEl.className = pCount > 0 ? "display-6 fw-bold mb-0 text-danger" : "display-6 fw-bold mb-0";
    }
    if (dashPending) {
        dashPending.innerText = pText;
        dashPending.className = pCount > 0 ? "fs-2 fw-bold text-danger" : "fs-2 fw-bold text-warning";
    }

    // (3) 누적 출자금
    const capitalEl = document.getElementById('dash-capital');
    if (capitalEl) capitalEl.innerText = totalCapital.toLocaleString() + '원';

    // (4) 오늘의 상담
    const consultEl = document.getElementById('dash-consult');
    if (consultEl) consultEl.innerText = (todayConsult || 0) + '건';
    
    console.log("대시보드 로딩 완료");
}


// [수정] 조합원 검색/목록 로드: DB 뷰(view_my_assets) 활용 최적화
async function fetchMembers() {
    // ✅ DOM 요소 단축 선택자
    const $ = (id) => document.getElementById(id);

    // 1. 검색 조건 수집
    const keyword =
        ($('search-keyword')?.value || $('memberSearchKeyword')?.value || '').trim();
    
    // 필터 값 수집 (없으면 기본값 처리)
    const statusEl = $('filter-status') || $('searchStatus');
    const typeEl = $('filter-type') || $('searchType');
    const sortEl = $('sort-order');

    const status = statusEl ? statusEl.value : 'all';
    const type = typeEl ? typeEl.value : 'all';
    const sort = sortEl ? sortEl.value : 'name'; // 정렬 기준 (기본 이름순)

    try {
        if (typeof showLoading === 'function') showLoading(true);

        // 2. coop_members 기본 조회 (필터링)
        let q = _supabase
            .from('coop_members')
            .select([
                'id',               // UUID (매칭용)
                'member_id',        // 텍스트 ID
                'name',
                'member_type',
                'phone',
                'status',
                'join_date',
                'created_at',
                'address',
                'rrn_display',
                'bank_name',
                'account_holder',
                'account_num_display',
                'admin_memo',
                'kakao_id',
                'naver_id',
                'join_category',
                'manager_id'
            ].join(','));

        // 2-1. 필터 및 정렬 적용
        if (status && status !== 'all') q = q.eq('status', status);
        if (type && type !== 'all') q = q.eq('member_type', type);

        // 통합 키워드 검색 (이름, 전화번호, 조합원번호 OR 검색)
        if (keyword) {
            q = q.or(`member_id.ilike.%${keyword}%,name.ilike.%${keyword}%,phone.ilike.%${keyword}%`);
        }

        // 정렬 조건 적용
        if (sort === 'join_date') q = q.order('join_date', { ascending: false });
        else if (sort === 'capital') { /* 출자금 정렬은 아래 병합 후 처리 필요하지만 일단 기본 정렬 */ }
        else q = q.order('name', { ascending: true }); // 기본: 이름순

        const { data: members, error } = await q;
        if (error) throw error;

        const list = Array.isArray(members) ? members : [];

        // 3. [최적화 핵심] view_my_assets를 통한 출자금 조회
        // 조회된 멤버들의 UUID만 추출
        const memberUids = list.map(m => m.id).filter(Boolean);
        let capitalMap = {};

        if (memberUids.length > 0) {
            // ★ 수정됨: ref_members 전체 조회 -> view_my_assets 요약 조회
            const { data: assets, error: assetErr } = await _supabase
                .from('view_my_assets')
                .select('member_uid, total_capital') // 필요한 컬럼만
                .in('member_uid', memberUids);       // 검색된 조합원들만 조회

            if (!assetErr && assets) {
                // UUID를 키(Key)로 하는 맵 생성 { "uuid-123": 500000, ... }
                assets.forEach(row => {
                    capitalMap[row.member_uid] = Number(row.total_capital || 0);
                });
            } else if (assetErr) {
                console.warn('자산 뷰 조회 실패(출자금 0으로 표시):', assetErr);
            }
        }

        // 4. 데이터 병합 (Members + Capital)
        g_members = list.map(m => ({
            ...m,
            // 맵에서 UUID로 찾아 매칭 (없으면 0원)
            total_capital: capitalMap[m.id] || 0,
            account_number: m.account_num_display || null
        }));

        // (옵션) 만약 정렬 기준이 '출자금순'이라면 JS 레벨에서 재정렬
        if (sort === 'capital') {
            g_members.sort((a, b) => b.total_capital - a.total_capital);
        }

        // 5. 화면 렌더링
        if (!g_members.length) {
             // 검색 결과 없음 or 초기 상태
             if (typeof renderMemberTable === 'function') renderMemberTable([]); 
             // 또는 renderEmptyState(); 사용 가능
             return;
        }

        renderMemberTable(g_members);

    } catch (err) {
        console.error(err);
        // Alert 대신 모달 사용 권장 (기존 myAlert 함수가 있다면)
        if (typeof myAlert === 'function') {
            myAlert('데이터를 불러오지 못했습니다: ' + (err?.message || err), 'error');
        } else {
            alert('데이터 로드 에러: ' + (err?.message || err));
        }
    } finally {
        if (typeof showLoading === 'function') showLoading(false);
    }
}


// [수정] 테이블 렌더링 (member_type 값 그대로 표시)
// [수정] 테이블 렌더링 (한글 상태값 완벽 대응)
// [수정] 테이블 렌더링 (주소 컬럼 제거 & 관리 버튼 추가 & 정렬 수정)
function renderMemberTable(list) {
  const tbody = document.getElementById('memberListBody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (!Array.isArray(list) || list.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-muted py-5">
          검색 결과가 없습니다.
        </td>
      </tr>
    `;
    return;
  }

  // onclick용 문자열 안전 처리 (작은따옴표/백슬래시 깨짐 방지)
  const escForOnclick = (v) => String(v ?? '')
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'");

  list.forEach((m, idx) => {
    const type = m.member_type || m.type || '-';
    const name = m.name || '-';
    const memberId = m.member_id || '';
    const phone = m.phone || '-';

    const joinRaw = m.join_date || m.created_at || '';
    const joinDate = (typeof joinRaw === 'string' && joinRaw.includes('T'))
      ? joinRaw.split('T')[0]
      : (joinRaw || '-');

    const status = m.status || '-';
    const totalCapital = Number(m.total_capital || 0);
    const capitalText = totalCapital.toLocaleString() + '원';

    const statusBadgeClass =
      status === '승인대기' ? 'bg-warning text-dark' :
      status === '정상' ? 'bg-success' :
      (status === '탈퇴' || status === '제명') ? 'bg-secondary' :
      'bg-light text-dark border';

    // 상세 모달 키
    const keyForDetail = m.member_uid || m.uid || m.id || memberId;

    // ✅ 핵심 수정: onclick 인자에 JSON.stringify 쓰지 말고 '...'로 감싸기
    const safeDetailKey = escForOnclick(keyForDetail);
    const safeEditId = escForOnclick(m.id);

    const detailBtn = (typeof openMemberDetail === 'function')
      ? `<button class="btn btn-sm btn-primary" onclick="openMemberDetail('${safeDetailKey}')">상세</button>`
    : `<button class="btn btn-sm btn-primary" onclick="openMemberEdit('${safeEditId}')">수정</button>`;

    const editBtn = `<button class="btn btn-sm btn-light ms-1" onclick="openMemberEdit('${safeEditId}')">수정</button>`;

    tbody.innerHTML += `
      <tr>
        <td>${idx + 1}</td>
        <td>${type}</td>
        <td class="text-start">
          <div class="fw-bold">${name}</div>
          <div class="small text-muted">${memberId ? '(' + memberId + ')' : ''}</div>
        </td>
        <td>${phone}</td>
        <td>
          <div class="small">${joinDate}</div>
          <span class="badge ${statusBadgeClass}">${status}</span>
        </td>
        <td class="fw-bold">${capitalText}</td>
        <td>
          ${detailBtn}
          ${editBtn}
        </td>
      </tr>
    `;
  });
}



// [신규] 조합원 명부 초기 상태 (검색 유도 화면)
function renderEmptyState() {
  const tbody = document.getElementById('memberListBody');
  if (!tbody) return;

  g_members = [];
  tbody.innerHTML = `
    <tr>
      <td colspan="7" class="text-center text-muted py-5">
        🔎 검색 조건을 입력하고 <b>검색</b>을 눌러주세요.
      </td>
    </tr>
  `;
}


// ================================================================
// [기능 2] 조합원 상세 관리 (슈퍼 모달)
// ================================================================

let g_current_member_id = null; // 현재 보고 있는 조합원 UUID


// [수정] 상세 모달 열기 (데이터 매칭 및 단체/개인 로직 분기)
async function openMemberDetail(id) {
  // 1) 들어온 id가 uuid(id/member_uid/uid)일 수도, member_id(텍스트)일 수도 있어서 안전 매칭
  const m = g_members.find(x => (x.id || x.member_uid || x.uid) === id)
        || g_members.find(x => (x.member_id || '') === id);

  if (!m) return myAlert("데이터를 찾을 수 없습니다.", 'error');

  // 2) 현재 조합원 UUID 확정 (가족/단체 연결 등 RPC에서 필요)
  const memberUid = m.id || m.member_uid || m.uid || null;
  if (!memberUid) return myAlert("조합원 UUID를 찾을 수 없습니다.", 'error');

  g_current_member_id = memberUid; // ★ 반드시 UUID로 저장

  // UI 초기화
  document.getElementById('md-uid').value = memberUid;
  document.getElementById('md-title').innerText = `${m.name} 님 상세`;
  document.getElementById('md-id-text').innerText = m.member_id || 'ID없음';

  // 뱃지/유형 표시
  let typeStr = m.member_type || m.type || '개인';
  document.getElementById('md-type-badge').innerText = typeStr;

  // 폼 데이터 바인딩
  document.getElementById('md-name').value = m.name || '';
  document.getElementById('md-phone').value = m.phone || '';

  // 상태
  document.getElementById('md-status').value = m.status || '승인대기';
  document.getElementById('md-type').value = typeStr;

  // 주소
  document.getElementById('md-addr').value = m.address || '';
  document.getElementById('md-addr-detail').value = '';

  // 메모
  document.getElementById('md-memo').value = m.admin_memo || '';

  // 계좌
  document.getElementById('md-bank-name').value = m.bank_name || '';
  document.getElementById('md-bank-owner').value = m.account_holder || '';
  document.getElementById('md-bank-account').value = m.account_number || '';

  // -----------------------------------------------------------
  // ★ [핵심] 주민/사업자 번호 표시 로직 (개인 vs 단체)
  // -----------------------------------------------------------
  const rrn = m.rrn_display || ''; // 마스킹 된 값(개인) / 사업자번호(단체일 수도)
  let displayInfo = '정보 없음';

  // 단체는 아예 표시하지 않음 (값 자체를 보여주지 않기)
  const isGroup = String(typeStr).includes('단체');

  if (isGroup) {
    displayInfo = '-'; // ★ 단체는 숨김
  } else {
    // 개인은 파싱 (840914-1******)
    if (rrn) {
      const cleanRrn = rrn.replace(/[^0-9]/g, ''); // 숫자만
      if (cleanRrn.length >= 7) {
        const yPre = cleanRrn.substr(6, 1); // 성별코드
        const year = (yPre === '1' || yPre === '2') ? '19' : '20';
        const gender = (yPre === '1' || yPre === '3') ? '남성' : '여성';

        // YYMMDD만 사용 (원래 로직 유지)
        displayInfo = `${year}${cleanRrn.substr(0, 2)}년 ${cleanRrn.substr(2, 2)}월 ${cleanRrn.substr(4, 2)}일 (${gender})`;
      } else {
        displayInfo = '정보 없음';
      }
    }
  }

  document.getElementById('md-rrn-view').innerText = displayInfo;
  document.getElementById('md-rrn').value = ''; // 수정용 인풋 초기화

  // SNS 연동 상태
  let snsHtml = '';
  if (m.kakao_id) snsHtml += '<span class="badge bg-warning text-dark me-1"><i class="bi bi-chat-fill"></i> Kakao</span>';
  if (m.naver_id) snsHtml += '<span class="badge bg-success"><i class="bi bi-n-square-fill"></i> Naver</span>';
  document.getElementById('md-sns-status').innerHTML = snsHtml || '<span class="text-muted small">SNS 미연동</span>';

  // 읽기 전용 모드로 시작
  toggleEditMode(false);

  // 하위 데이터 로드
  loadMemberFunds(memberUid, m.member_id, true);  // 자금 내역
  loadConsultLogs(memberUid);                    // 상담 이력 (내부에서 textId 사용)
  loadMemberFamily(memberUid);                   // 가족/단체 목록

  new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
}


// [교체] 수정 모드 토글 (주소찾기 버튼 및 상세주소창 제어 추가)
function toggleEditMode(isEdit) {
const inputs = document.querySelectorAll('#md-tab-basic input, #md-tab-basic select, #md-tab-basic textarea');
const btnSearch = document.getElementById('btn-addr-search'); // 주소검색 버튼
const addrDetail = document.getElementById('md-addr-detail'); // 상세주소 입력창

inputs.forEach(el => {
// 주소 기본창(md-addr)은 수정 모드여도 직접 타이핑 불가 (검색 버튼 이용)
if(el.id === 'md-addr') el.disabled = true; 
else el.disabled = !isEdit;

el.classList.toggle('bg-light', !isEdit);
});

if(isEdit) {
document.getElementById('btn-edit-mode').style.display = 'none';
document.getElementById('btn-save-group').style.display = 'flex';

document.getElementById('rrn-edit-area').style.display = 'block';
document.getElementById('rrn-view-area').style.display = 'none';

// 주소 관련 UI 노출
btnSearch.style.display = 'inline-block';
addrDetail.style.display = 'block';
} else {
document.getElementById('btn-edit-mode').style.display = 'inline-block';
document.getElementById('btn-save-group').style.display = 'none';

document.getElementById('rrn-edit-area').style.display = 'none';
document.getElementById('rrn-view-area').style.display = 'block';

// 주소 관련 UI 숨김
btnSearch.style.display = 'none';
addrDetail.style.display = 'none';
}
}

// [교체] 주소 검색 (검색 결과 -> 기본창, 포커스 -> 상세창)
function searchAddress() {
new daum.Postcode({
oncomplete: function(data) {
const fullAddr = `(${data.zonecode}) ${data.roadAddress || data.jibunAddress}`;
document.getElementById('md-addr').value = fullAddr;
document.getElementById('md-addr-detail').value = ''; // 상세주소 초기화
document.getElementById('md-addr-detail').focus();
}
}).open();
}

// [수정] 저장 후 리스트 강제 갱신 로직 보강
async function saveMemberBasic() {
myConfirm("수정된 정보를 저장하시겠습니까?", async () => {
// 1. 주소 합치기
const basicAddr = document.getElementById('md-addr').value;
const detailAddr = document.getElementById('md-addr-detail').value;
const finalAddr = detailAddr ? `${basicAddr} ${detailAddr}` : basicAddr;

// 2. 계좌번호 안전장치 (* 포함 시 전송 안 함)
let bankAcc = document.getElementById('md-bank-account').value;
if (bankAcc && bankAcc.includes('*')) {
bankAcc = null; 
}

const updates = {
p_id: document.getElementById('md-uid').value,
p_name: document.getElementById('md-name').value,
p_phone: document.getElementById('md-phone').value,
p_address: finalAddr,
p_bank_name: document.getElementById('md-bank-name').value,
p_bank_owner: document.getElementById('md-bank-owner').value,
p_bank_account: bankAcc,
p_status: document.getElementById('md-status').value,
p_member_type: document.getElementById('md-type').value,
p_admin_memo: document.getElementById('md-memo').value,
p_rrn: (document.getElementById('md-rrn').value || '').trim() || null 
};

showLoading(true);
const { error } = await _supabase.rpc('update_member_details_secure', updates);
showLoading(false);

if (error) myAlert('저장 실패: ' + error.message, 'error');
else {
myAlert('저장되었습니다.');

// 1. 수정 모드 종료
toggleEditMode(false); 

// 2. ★ 핵심: 리스트에 변경 사항 즉시 반영 (딜레이 추가로 DB 반영 시간 확보)
setTimeout(() => {
fetchMembers(); // 전체 목록 새로고침
}, 300);
}
});
}


// [수정] 상담 이력 로드 (최신이 위로 오도록 정렬 보강)
async function loadConsultLogs(uuid) { // uuid는 유지(호출부 호환), 내부는 textId 사용
  const listEl = document.getElementById('md-consult-list');
  if (!listEl) return;

  const textId = document.getElementById('md-id-text').innerText;

  if (!textId || textId === '-' || textId === 'ID없음') {
    listEl.innerHTML = '<div class="text-center text-muted py-3 small">조합원 번호가 없어 조회할 수 없습니다.</div>';
    return;
  }

  listEl.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

  const { data, error } = await _supabase.rpc('get_member_consultations', {
    p_member_id: textId
  });

  listEl.innerHTML = '';

  if (error) {
    console.error("상담 로드 에러:", error);
    listEl.innerHTML = '<div class="text-center text-danger py-3 small">불러오기 실패</div>';
    return;
  }

  if (!data || data.length === 0) {
    listEl.innerHTML = '<div class="text-center text-muted py-3 small">상담 이력이 없습니다.</div>';
    return;
  }

  // ★ 핵심: 최근 이력이 위로 오도록(created_at 기준 내림차순)
  const sorted = [...data].sort((a, b) => {
    const at = a.created_at ? new Date(a.created_at).getTime() : 0;
    const bt = b.created_at ? new Date(b.created_at).getTime() : 0;
    return bt - at;
  });

  sorted.forEach(log => {
    let dateStr = '-';
    if (log.created_at) {
      const d = new Date(log.created_at);
      dateStr = `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
    }

    listEl.innerHTML += `
      <div class="list-group-item bg-light border-0 mb-1 rounded">
        <div class="d-flex justify-content-between">
          <small class="fw-bold text-dark">${log.author_email || '관리자'}</small>
          <small class="text-muted" style="font-size:0.8em">${dateStr}</small>
        </div>
        <div class="mt-1 text-secondary" style="font-size:0.9rem; white-space: pre-wrap;">${log.content}</div>
      </div>
    `;
  });
}


// [수정] 상담 등록 (UUID 대신 텍스트 ID 사용)
async function addConsultLog() {
const inputEl = document.getElementById('md-consult-input');
const content = inputEl.value;

if(!content.trim()) return alert('내용을 입력하세요.');

const userEmail = document.getElementById('adminProfile') ? document.getElementById('adminProfile').innerText : 'admin';
const textId = document.getElementById('md-id-text').innerText; // 화면에 있는 텍스트 ID

if(!textId || textId === '-') return alert('조합원 번호가 없는 사용자입니다.');

showLoading(true);

// ★ 핵심 수정: 텍스트 ID만 보냅니다. (UUID는 DB가 알아서 찾음)
const { error } = await _supabase.rpc('add_consultation', {
p_member_id: textId,
p_author_email: userEmail,
p_content: content
});
showLoading(false);

if(error) {
console.error(error);
alert('등록 실패: ' + error.message);
} else {
inputEl.value = ''; 
// 등록 후 목록 갱신할 때도 원래 함수 호출 (내부에서 textId 다시 찾음)
loadConsultLogs(null); 
}
}


// 5. 자금 로드 (출자금, 기부금 등) - Phase 2에서는 '조회' 위주


// [신규] 가족/단체 목록 로드 (내가 관리자인 계정 조회)
async function loadMemberFamily(parentId) {
    const tbody = document.getElementById('md-family-list');
    if (!tbody) return;

    // 1. 로딩 표시
    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>';

    // 2. DB 조회 (manager_id가 현재 보고 있는 조합원인 경우)
    // 뷰에는 manager_id가 없을 수 있으므로 원본 테이블을 조회합니다.
    const { data: familyList, error } = await _supabase
        .from('coop_members')
        .select('id, name, rrn_display, status, member_type, join_category, join_date')
        .eq('manager_id', parentId)
        .order('join_date', { ascending: false });

    if (error) {
        console.error("가족 목록 로드 실패:", error);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger small py-3">데이터 로드 실패</td></tr>';
        return;
    }

    // 3. 데이터 없음 처리
    if (!familyList || familyList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted small py-3">연결된 가족이나 단체가 없습니다.</td></tr>';
        return;
    }

    // 4. 목록 렌더링
    tbody.innerHTML = '';
    
    familyList.forEach(m => {
        // 구분 뱃지 (자녀 vs 단체)
        let typeBadge = '<span class="badge bg-secondary">기타</span>';
        if (m.member_type === '단체') {
            typeBadge = '<span class="badge bg-info">🏢 단체</span>';
        } else if (m.join_category === '가족') {
            typeBadge = '<span class="badge bg-warning text-dark">👶 자녀</span>';
        }

        // 주민번호/사업자번호 표시
        const idNum = m.rrn_display || '-';

        // 상태 뱃지
        let statusClass = 'bg-success';
        if (m.status === '승인대기') statusClass = 'bg-danger';
        else if (m.status === '탈퇴') statusClass = 'bg-secondary';
        
        const statusBadge = `<span class="badge ${statusClass}">${m.status}</span>`;

        tbody.innerHTML += `
            <tr>
                <td>${typeBadge}</td>
                <td class="fw-bold">${m.name}</td>
                <td class="small font-monospace">${idNum}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-xs btn-outline-dark border" onclick="openMemberDetail('${m.id}')">
                        상세보기
                    </button>
                </td>
            </tr>
        `;
    });
}

// ================================================================
// [기능 Phase 3] 자금 관리 (출자/기부 CRUD)
// ================================================================

// 1. [수정] 기존 loadMemberFunds 함수 교체 (버튼 및 기능 연결)



// 2. 에디터 모달 열기 (신규/수정 공용)
function openFundEditor(type, rowDataStr, textId = null) {
const modalEl = document.getElementById('fundEditorModal');
const titleEl = document.getElementById('fund-modal-title');

// 필드 초기화
document.getElementById('fund-edit-type').value = type;
document.getElementById('fund-edit-id').value = ''; 
document.getElementById('fund-date').value = new Date().toISOString().split('T')[0]; // 오늘 날짜 기본
document.getElementById('fund-amount').value = '';
document.getElementById('fund-note').value = '';
document.getElementById('fund-depositor').value = '';

// UI 분기 (출자금 vs 기부금)
if(type === 'capital') {
titleEl.innerText = '💰 출자금 내역 관리';
titleEl.className = 'modal-title fw-bold text-success';
document.getElementById('fund-method-group').style.display = 'none';
document.getElementById('fund-depositor-group').style.display = 'block';
} else {
titleEl.innerText = '🎁 기부금 내역 관리';
titleEl.className = 'modal-title fw-bold text-primary';
document.getElementById('fund-method-group').style.display = 'block';
document.getElementById('fund-depositor-group').style.display = 'none';
}

// 수정 모드일 경우 데이터 채우기
if (rowDataStr) {
const data = JSON.parse(decodeURIComponent(rowDataStr));
document.getElementById('fund-edit-id').value = data.id;
document.getElementById('fund-date').value = data.deposit_date || data.donation_date;
document.getElementById('fund-amount').value = data.amount;
document.getElementById('fund-note').value = data.note || '';

if(type === 'capital') document.getElementById('fund-depositor').value = data.depositor || '';
if(type === 'donation') document.getElementById('fund-method').value = data.payment_method || 'transfer';
} 
// 신규 모드인데 출자금이면, 입금자명에 기본으로 조합원 이름 넣어주기
else if (type === 'capital') {
document.getElementById('fund-depositor').value = document.getElementById('md-name').value;
}

// 이중 모달 처리를 위해 z-index 조정 (부트스트랩 버그 방지)
modalEl.style.zIndex = 2000; 
new bootstrap.Modal(modalEl).show();
}


// 3. 저장 실행
async function saveFundData() {
const type = document.getElementById('fund-edit-type').value;
const idVal = document.getElementById('fund-edit-id').value || null; // 빈 문자열이면 null로
const amount = document.getElementById('fund-amount').value;
const date = document.getElementById('fund-date').value;
const note = document.getElementById('fund-note').value;

// 유효성 검사
if(!amount || !date) return alert('날짜와 금액을 입력해주세요.');

// 현재 열려있는 슈퍼 모달의 조합원 정보 가져오기
const memberUid = document.getElementById('md-uid').value;
const memberTextId = document.getElementById('md-id-text').innerText;

showLoading(true);
let rpcName = type === 'capital' ? 'manage_capital_secure' : 'manage_donation_secure';

let params = {};
if(type === 'capital') {
params = {
p_id: idVal,
p_member_text_id: memberTextId,
p_amount: amount,
p_date: date,
p_note: note,
p_depositor: document.getElementById('fund-depositor').value
};
} else {
params = {
p_id: idVal,
p_member_uid: memberUid,
p_member_text_id: memberTextId,
p_amount: amount,
p_date: date,
p_method: document.getElementById('fund-method').value,
p_note: note
};
}

const { error } = await _supabase.rpc(rpcName, params);
showLoading(false);

if (error) {
alert('저장 실패: ' + error.message);
} else {
// 성공 시 에디터 모달 닫고 리스트 새로고침
bootstrap.Modal.getInstance(document.getElementById('fundEditorModal')).hide();
loadMemberFunds(memberUid, memberTextId);

// 대시보드 통계도 갱신되면 좋으므로 (선택사항)
loadDashboard();
}
}


// 4. 삭제 실행
async function deleteFundData(type, id) {
if(!confirm('정말 이 내역을 삭제하시겠습니까? (복구 불가)')) return;

showLoading(true);
const rpcName = type === 'capital' ? 'delete_capital_secure' : 'delete_donation_secure';
const { error } = await _supabase.rpc(rpcName, { p_id: id });
showLoading(false);

if(error) {
alert('삭제 실패: ' + error.message);
} else {
// 목록 새로고침
const memberUid = document.getElementById('md-uid').value;
const memberTextId = document.getElementById('md-id-text').innerText;
loadMemberFunds(memberUid, memberTextId);
loadDashboard(); // 통계 갱신
}
}
// 1. [유틸] 알럿 -> 모달 대체
function myAlert(msg, type='success') {
const icon = type === 'success' 
? '<i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>' 
: '<i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 2rem;"></i>';
document.getElementById('alertIcon').innerHTML = icon;
document.getElementById('alertText').innerHTML = msg;
new bootstrap.Modal(document.getElementById('customAlertModal')).show();
}

function myConfirm(msg, callback) {
document.getElementById('confirmText').innerHTML = msg;
const btn = document.getElementById('btnConfirmYes');

// 이벤트 리스너 중복 방지를 위한 노드 복제 교체
const newBtn = btn.cloneNode(true);
btn.parentNode.replaceChild(newBtn, btn);

newBtn.onclick = () => {
bootstrap.Modal.getInstance(document.getElementById('customConfirmModal')).hide();
callback();
};
new bootstrap.Modal(document.getElementById('customConfirmModal')).show();
}

// 2. [유틸] 자동 하이픈 (HTML oninput="autoHyphen(this)" 연결 필요)
function autoHyphen(target) {
let val = target.value.replace(/[^0-9]/g, '');
if(target.id === 'md-phone') { // 전화번호
if(val.length < 4) target.value = val;
else if(val.length < 7) target.value = val.substr(0, 3) + '-' + val.substr(3);
else if(val.length < 11) target.value = val.substr(0, 3) + '-' + val.substr(3, 3) + '-' + val.substr(6);
else target.value = val.substr(0, 3) + '-' + val.substr(3, 4) + '-' + val.substr(7);
} else if(target.id === 'md-rrn') { // 주민번호
if(val.length < 7) target.value = val;
else target.value = val.substr(0, 6) + '-' + val.substr(6, 7);
}
}




// [교체] 자금 목록 로드 (무한 스크롤 지원)
async function loadMemberFunds(uuid, textId, reset=false) {
const listEl = document.getElementById('md-capital-list');

if(reset) {
g_fund_page = 0; // 페이지 초기화
listEl.innerHTML = '';
}

if(!textId || textId === 'ID없음') return;

// 페이지네이션 범위 계산
const start = g_fund_page * PAGE_SIZE;
const end = start + PAGE_SIZE - 1;

// 출자금 조회
const { data } = await _supabase.from('ref_members')
.select('*')
.eq('member_id', textId)
.order('deposit_date', {ascending: false})
.range(start, end);

if(data && data.length > 0) {
data.forEach(c => {
const json = encodeURIComponent(JSON.stringify(c));
listEl.innerHTML += `
               <tr>
                   <td>${c.deposit_date}</td>
                   <td class="fw-bold">${Number(c.amount).toLocaleString()}</td>
                   <td class="text-start text-truncate" style="max-width:100px;">${c.note||'-'}</td>
                   <td>
                       <button class="btn btn-xs btn-light border" onclick="openFundEditor('capital','${json}')">수정</button>
                   </td>
               </tr>`;
});
g_fund_page++; // 다음 페이지 준비
} else if(reset) {
listEl.innerHTML = '<tr><td colspan="4" class="text-muted small py-3">내역 없음</td></tr>';
}

// (기부금 로직은 기존 유지 - 페이지네이션 필요 시 동일하게 적용)
}

// [추가] 무한 스크롤 이벤트 핸들러
function handleFundScroll(e) {
const el = e.target;
// 스크롤이 바닥에 거의 닿았을 때 (여유분 10px)
if(el.scrollTop + el.clientHeight >= el.scrollHeight - 10) {
const textId = document.getElementById('md-id-text').innerText;
const uid = document.getElementById('md-uid').value;
loadMemberFunds(uid, textId, false); // false = 추가 로드
}
}
// 1. 단체 검색 모달 열기
function openGroupSearch() {
document.getElementById('group-search-input').value = '';
document.getElementById('group-search-result').innerHTML = '';
new bootstrap.Modal(document.getElementById('groupSearchModal')).show();
}

// 2. 검색 실행
async function searchGroups() {
const keyword = document.getElementById('group-search-input').value;
if(!keyword) return;

const { data } = await _supabase.rpc('search_groups', { keyword });
const list = document.getElementById('group-search-result');
list.innerHTML = '';

if(!data || data.length===0) { list.innerHTML = '<div class="p-3 text-center text-muted">결과 없음</div>'; return; }

data.forEach(g => {
// 관리자 정보 표시
const status = g.rep_name 
? `<span class="badge bg-warning text-dark">현재 관리자: ${g.rep_name}</span>` 
: `<span class="badge bg-success">관리자 없음</span>`;

list.innerHTML += `
           <button class="list-group-item list-group-item-action" onclick="tryConnectGroup('${g.id}', '${g.name}', '${g.rep_name||''}')">
               <div class="d-flex justify-content-between align-items-center">
                   <span class="fw-bold">${g.name}</span>
                   <small>${status}</small>
               </div>
           </button>`;
});
}

// 3. 연결 시도
function tryConnectGroup(groupId, groupName, currentManager) {
const myName = document.getElementById('md-name').value;
let msg = `'${groupName}'의 관리자로 등록하시겠습니까?`;

if(currentManager) {
msg = `⚠️ <b>주의:</b> 현재 '${currentManager}'님이 관리자로 되어 있습니다.<br>관리자를 '${myName}'님으로 변경하시겠습니까?`;
}

myConfirm(msg, async () => {
showLoading(true);
const { error } = await _supabase.rpc('connect_group_manager', { 
group_uuid: groupId, 
manager_uuid: g_current_member_id 
});
showLoading(false);

if(error) myAlert('연결 실패: ' + error.message, 'error');
else {
myAlert('연결되었습니다.');
bootstrap.Modal.getInstance(document.getElementById('groupSearchModal')).hide();
// 필요하다면 가족 리스트 새로고침: loadMemberFamily(g_current_member_id);
}
});
}
// [신규] 관계 선택 모달 열기
function openRelationSelectModal() {
// 상세 모달 위에 띄워야 하므로 z-index 관리 필요할 수 있음 (Bootstrap이 자동 처리하기도 함)
new bootstrap.Modal(document.getElementById('relationSelectModal')).show();
}

// [신규] 선택 후 다음 단계 이동
function confirmRelationType() {
const type = document.querySelector('input[name="relationType"]:checked').value;

// 현재 모달 닫기
const modalEl = document.getElementById('relationSelectModal');
const modalInstance = bootstrap.Modal.getInstance(modalEl);
modalInstance.hide();

if (type === 'child') {
// TODO: 자녀 등록 모달(폼) 띄우기
alert("다음 단계: 자녀(이름, 생년월일, 성별) 입력 폼을 띄웁니다."); 
// openChildForm(); 
} else {
// TODO: 단체 검색 모달 띄우기
alert("다음 단계: 연결할 단체를 검색하는 창을 띄웁니다.");
// openOrgSearchModal();
}
}
// [신규] 자녀 등록 폼 열기
function openChildForm() {
    // 1. 현재 보고 있는 부모 조합원 정보 찾기
    const parentId = document.getElementById('md-uid').value;
    const parent = g_members.find(m => m.id === parentId);

    if(!parent) return myAlert('부모 정보를 찾을 수 없습니다.', 'error');

    // 2. 부모 정보 UI에 바인딩
    document.getElementById('child-parent-name').value = `${parent.name} (${parent.member_id || '-'})`;
    
    // 3. 부모 정보 복사 (연락처, 주소) - 편의성 제공
    document.getElementById('child-phone').value = parent.phone || '';
    document.getElementById('child-address').value = parent.address || '';
    
    // 4. 나머지 초기화
    document.getElementById('child-name').value = '';
    document.getElementById('child-rrn').value = '';

    // 5. 모달 열기
    new bootstrap.Modal(document.getElementById('childRegisterModal')).show();
}

// [신규] 자녀 저장 실행
async function saveChildMember() {
    const parentId = document.getElementById('md-uid').value;
    const name = document.getElementById('child-name').value.trim();
    const rrn = document.getElementById('child-rrn').value.replace(/[^0-9]/g, ''); // 숫자만 추출
    const phone = document.getElementById('child-phone').value;
    const address = document.getElementById('child-address').value;
    
    // 유효성 검사
    if(!name) return myAlert("자녀 이름을 입력해주세요.", 'warning');
    if(rrn.length !== 13) return myAlert("주민번호 13자리를 정확히 입력해주세요.", 'warning');

    myConfirm(`${name} 자녀를 등록하시겠습니까?`, async () => {
        showLoading(true);
        
        const params = {
            p_manager_id: parentId, // 부모 ID 연결
            p_name: name,
            p_rrn: rrn,
            p_phone: phone,
            p_address: address,
            p_memo: '자녀 계정 (부모에 의해 생성됨)'
        };

        const { error } = await _supabase.rpc('create_child_member', params);
        showLoading(false);

        if(error) {
            myAlert("등록 실패: " + error.message, 'error');
        } else {
            myAlert("자녀 계정이 등록되었습니다.");
            // 모달 닫기
            bootstrap.Modal.getInstance(document.getElementById('childRegisterModal')).hide();
            
            // TODO: 가족 목록 리스트를 새로고침해야 함 (다음 단계에서 구현)
            // loadMemberFamily(parentId); 
        }
    });
}

// ================================================================
// [초기화] 통합 윈도우 로드 함수 (중복 선언 금지)
// ================================================================
window.onload = async function() {
    console.log("시스템 초기화 시작...");

    // 1. 세션 확인 및 관리자 권한 체크
    // (user 정보를 checkAdmin에 확실하게 넘겨주기 위함)
    const { data: { session } } = await _supabase.auth.getSession();
    const user = session ? session.user : null;
    
    // checkAdmin 내부에서 권한 확인 및 페이지 리다이렉트 처리
    await checkAdmin(user);

    // 2. 사이드바 메뉴 활성화 (현재 URL 기반)
    const currentPath = window.location.pathname.split('/').pop(); // 예: admin_member.html
    
    // href가 현재 파일명과 일치하는 링크 찾기
    const activeLink = document.querySelector(`.sidebar-menu .nav-link[href="${currentPath}"]`);
    
    if (activeLink) {
        activeLink.classList.add('active');
        // closest 사용 시 null 에러 방지를 위한 안전장치 추가
        const parentItem = activeLink.closest('.nav-item');
        if(parentItem) parentItem.classList.add('active');
    }

    // 3. 초기 탭 로드 (대시보드)
    // 이 함수 안에서 loadDashboard()가 호출됨
    switchTab('dashboard');

    // 4. 자금 내역 테이블 무한 스크롤 이벤트 연결
    // 요소가 존재할 때만 이벤트 리스너 추가 (에러 방지)
    const fundTableContainer = document.querySelector('#md-capital-list')?.closest('.table-responsive');
    if(fundTableContainer) {
        fundTableContainer.addEventListener('scroll', handleFundScroll);
        console.log("무한 스크롤 이벤트 연결됨");
    }
};

</script>
</body>
</html>
