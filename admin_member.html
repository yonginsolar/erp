<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>☀️ 협동조합 통합 관리자</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://yonginsolar.github.io/home/badges.js"></script>
<script src="https://yonginsolar.github.io/home/cert_generator.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    

<style>
body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; overflow: hidden; }

/* 사이드바 스타일 */
.sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
.sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-menu { padding: 20px 10px; overflow-y: auto; flex-grow: 1; }
.nav-link { color: rgba(255,255,255,0.75); padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
.nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; font-weight: 600; }
.nav-link i { margin-right: 12px; font-size: 1.1rem; }
.menu-category { font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 20px 15px 10px; font-weight: 700; letter-spacing: 1px; }

/* 메인 컨텐츠 영역 */
.main-content { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 30px; background: #f8f9fa; }
.content-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }

/* 로그인 화면 & 유틸 */
#login-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
.login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); text-align: center; }
.hidden { display: none !important; }
.table th { font-size: 13px; background-color: #f1f3f5; font-weight: 600; }
.table td { font-size: 14px; vertical-align: middle; }
.tab-pane { display: none; }
.tab-pane.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* 탭 글씨 색상 강제 수정 */
.nav-tabs .nav-link { color: #495057 !important; font-weight: 600; }
.nav-tabs .nav-link.active { color: #0d6efd !important; border-bottom: 2px solid #0d6efd; }
/* 기본 정보 탭 버튼 제어 */
#btn-save-mode { display: none; } /* 처음엔 숨김 */
#rrn-edit-area { display: none; } /* 처음엔 숨김 */
</style>
</head>

<body>

<div id="login-gate">
<div class="login-box">
<h3 class="fw-bold mb-4">🔐 관리자 접속</h3>
<div class="mb-3 text-start">
<label class="form-label small fw-bold">이메일 주소</label>
<input type="email" id="adminEmail" class="form-control" placeholder="name@coop.com">
</div>
<button class="btn btn-primary w-100 py-2 fw-bold" id="btnLogin" onclick="sendLoginLink()">로그인 링크 받기</button>
<div id="loginMsg" class="mt-3 text-success small" style="display:none;"></div>
</div>
</div>

<div class="d-flex hidden" id="main-system">
<div class="sidebar">
<div class="sidebar-header">
<h5 class="fw-bold m-0">☀️ 협동조합 ERP <span class="badge bg-warning text-dark" style="font-size:0.6em; vertical-align:middle;">v1.1.0</span></h5>
<small class="text-white-50" id="adminProfile">접속중...</small>
</div>

<div class="sidebar-menu">
<a class="nav-link active" onclick="switchTab('dashboard')" id="nav-dashboard" style="cursor:pointer;">
<i class="bi bi-grid-fill"></i> 대시보드
</a>

<div class="menu-category mt-3">회원 및 자금</div>

<a class="nav-link" onclick="switchTab('members')" id="nav-members" style="cursor:pointer;">
<i class="bi bi-people-fill"></i> 조합원 명부
</a>
<a class="nav-link" onclick="switchTab('funds-manage')" id="nav-funds-manage" style="cursor:pointer;">
    <i class="bi bi-piggy-bank-fill"></i> 자금 및 이용고 배당 관리
</a>
    <a class="nav-link" onclick="switchTab('applications')" id="nav-applications" style="cursor:pointer;">
    <i class="bi bi-inbox-fill"></i> 업무 신청 관리 
    <span id="sidebar-app-badge" class="badge bg-danger ms-auto hidden">0</span>
</a>
<a class="nav-link" onclick="switchTab('deposit')" id="nav-deposit" style="cursor:pointer;">
<i class="bi bi-cash-coin"></i> 입금 매칭
</a>

<div class="menu-category">운영 관리</div>
<a class="nav-link" onclick="switchTab('notices')" id="nav-notices" style="cursor:pointer;">
<i class="bi bi-megaphone"></i> 공지사항 관리
</a>


<div class="menu-category">홈페이지 관리</div>
<a class="nav-link" onclick="switchTab('site')" id="nav-site" style="cursor:pointer;">
<i class="bi bi-window-sidebar"></i> 사이트 컨텐츠
</a>

<div class="mt-4 pt-4 border-top border-secondary">
<a class="nav-link text-warning" onclick="location.href='index.html'" style="cursor:pointer;">
<i class="bi bi-box-arrow-up-right"></i> 메뉴로 바로가기
</a>
<a class="nav-link text-danger" onclick="logout()" style="cursor:pointer;">
<i class="bi bi-box-arrow-right"></i> 로그아웃
</a>
</div>
</div>
</div>

<div class="main-content">

    <div class="tab-pane fade show active" id="tab-dashboard">
    <h3 class="fw-bold mb-4" style="font-family:'GmarketSans';">운영 대시보드</h3>

    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card bg-primary bg-opacity-10 border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h6 class="text-primary fw-bold mb-2">총 조합원</h6>
                    <h2 class="display-6 fw-bold mb-0" id="dashboard-total-count">0명</h2>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card bg-warning bg-opacity-10 border-0 shadow-sm h-100" style="cursor:pointer;" onclick="goToPendingMembers()">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-warning text-dark fw-bold mb-0">승인 대기 (클릭)</h6>
                        <i class="bi bi-arrow-right-circle text-warning text-dark"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-0" id="dashboard-pending-count">0명</h2>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card bg-success bg-opacity-10 border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h6 class="text-success fw-bold mb-2">누적 출자금</h6>
                    <h2 class="fs-2 fw-bold mb-0 text-success" id="dash-capital">-</h2>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card bg-danger bg-opacity-10 border-0 shadow-sm h-100" style="cursor:pointer;" onclick="switchTab('applications')">
                <div class="card-body p-4">
                    <h6 class="text-danger fw-bold mb-2">처리 대기 신청</h6>
                    <h2 class="display-6 fw-bold mb-0 text-danger" id="dash-app-pending">0건</h2>
                    <div class="small text-muted mt-2">출자/감자/탈퇴 요청</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card bg-info bg-opacity-10 border-0 shadow-sm h-100" style="cursor: pointer;" onclick="switchTab('site'); setTimeout(() => document.querySelector('a[href=\'#sub-partners\']').click(), 200);">
                <div class="card-body p-4">
                    <h6 class="text-info fw-bold mb-2">파트너 신청(수정) 대기</h6>
                    <h2 class="fs-2 fw-bold mb-0 text-info" id="dash-partner-pending">-</h2>
                </div>
            </div>
        </div>
     </div>    
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-0 pt-3 ps-3">
                    📊 월별 출자금 및 감자 현황
                </div>
                <div class="card-body">
                    <canvas id="chart-capital"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-0 pt-3 ps-3">
                    👥 조합원 구성 (지역)
                </div>
                <div class="card-body">
                    <canvas id="chart-location" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-0 pt-3 ps-3">
                    🎂 연령대 분포
                </div>
                <div class="card-body">
                    <canvas id="chart-age"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-0 pt-3 ps-3">
                    👋 주요 탈퇴 사유 (Top 5)
                </div>
                <div class="card-body">
                    <canvas id="chart-exit"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm p-4 mb-3">
        <h5 class="fw-bold mb-3">바로가기</h5>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-dark" onclick="openNoticeModal()">📢 공지사항 쓰기</button>
            <button class="btn btn-outline-success" onclick="document.getElementById('nav-members').click()">👥 조합원 검색</button>
            <button class="btn btn-outline-secondary" onclick="openAdminLogModal()">🛡️ 관리자 로그</button>
        </div>
    </div>

</div> <div class="tab-pane fade" id="tab-applications">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold m-0" style="font-family:'GmarketSans';">📥 업무 신청 현황</h3>
            <button class="btn btn-dark shadow-sm" onclick="openProxyModal()">
                <i class="bi bi-telephone-plus-fill me-2"></i>전화/대리 접수
            </button>
        </div>

        <ul class="nav nav-tabs mb-3" id="app-sub-tabs">
            <li class="nav-item">
                <button class="nav-link active fw-bold" onclick="filterAppList('pending')">처리 대기중</button>
            </li>
            <li class="nav-item">
                <button class="nav-link text-secondary" onclick="filterAppList('all')">전체 이력</button>
            </li>
        </ul>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="table-light">
                        <tr>
                            <th>신청일</th>
                            <th>구분</th>
                            <th>신청자 (번호)</th>
                            <th class="text-end">금액</th>
                            <th>사유/비고</th>
                            <th>상태</th>
                            <th>관리 (확인)</th>
                        </tr>
                    </thead>
                    <tbody id="appListBody">
                        <tr><td colspan="7" class="py-5 text-muted">로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

 

<div class="modal fade" id="proxyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title fw-bold">📞 전화/대리 접수 등록</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light border small mb-3">
                    <i class="bi bi-info-circle-fill"></i> 관리자가 대신 신청서를 작성합니다.<br>
                    작성 후 목록에서 <b>[승인/확인]</b> 처리를 해야 최종 반영됩니다.
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold">신청자 검색</label>
                    <div class="input-group">
                        <input type="text" id="proxy-keyword" class="form-control" placeholder="이름 또는 번호" onkeyup="if(event.key=='Enter') searchProxyMember()">
                        <button class="btn btn-secondary" onclick="searchProxyMember()">검색</button>
                    </div>
                    <input type="text" id="proxy-member-name" class="form-control mt-2 bg-light text-primary fw-bold" readonly placeholder="검색해주세요.">
                    <input type="hidden" id="proxy-member-uid"> <input type="hidden" id="proxy-member-id">  </div>

                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label small fw-bold">신청 유형</label>
                        <select id="proxy-type" class="form-select">
                            <option value="extra">추가 출자</option>
                            <option value="reduction">감자 (반환)</option>
                            <option value="withdraw">탈퇴 신청</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold">금액</label>
                        <input type="number" id="proxy-amount" class="form-control" placeholder="0">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">비고 (필수)</label>
                    <input type="text" id="proxy-reason" class="form-control" placeholder="예: 전화 요청 (010-1234-5678)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success w-100 fw-bold" onclick="submitProxyData()">접수 등록</button>
            </div>
        </div>
    </div>
</div>
        
    </div>

    
<div class="tab-pane fade" id="tab-members">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h3 class="fw-bold m-0" style="font-family:'GmarketSans';">조합원 명부</h3>
        </div>

    <div class="card p-3 mb-3 border-0 bg-light">
        <div class="row g-2 align-items-center">
            <div class="col-md-2">
                <select id="filter-status" class="form-select form-select-sm" onchange="fetchMembers()">
                    <option value="all" selected>상태: 전체</option>
                    <option value="정상">정상 (정조합원)</option>
                    <option value="승인대기">승인 대기</option>
                    <option value="탈퇴">탈퇴/제명</option>
                </select>
            </div>

            <div class="col-md-2">
                <select id="filter-type" class="form-select form-select-sm" onchange="fetchMembers()">
                    <option value="all">유형: 전체</option>
                    <option value="개인">개인</option>
                    <option value="단체">단체</option>
                </select>
            </div>

            <div class="col-md-2">
                <select id="sort-order" class="form-select form-select-sm" onchange="fetchMembers()">
                    <option value="name">이름순</option>
                    <option value="join_date">가입일순 (최신)</option>
                    <option value="capital">출자금순 (고액)</option>
                </select>
            </div>

            <div class="col-md-4">
                <div class="input-group input-group-sm">
                    <input type="text" id="search-keyword" class="form-control" placeholder="이름 / 전화번호 / 조합원번호" onkeyup="if(event.key=='Enter') fetchMembers()">
                    <button class="btn btn-secondary" onclick="fetchMembers()">검색</button>
                </div>
            </div>

            <div class="col-md-2 text-end">
                <button class="btn btn-sm btn-outline-success" onclick="openExcelModal()">📥 엑셀</button>
            </div>
        </div>
    </div>

    <div class="table-responsive bg-white border rounded">
        <table class="table table-hover align-middle mb-0 text-center">
            <thead class="table-light">
                <tr>
                    <th>번호</th>
                    <th>유형</th>
                    <th>이름 (조합원번호)</th>
                    <th>연락처</th>
                    <th>가입일/상태</th>
                    <th>출자금</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody id="memberListBody"></tbody>
        </table>
    </div>
</div>

<div class="tab-pane fade" id="tab-funds-manage">
    <div class="content-header">
        <h3 class="fw-bold m-0" style="font-family:'GmarketSans';">💰 운영자금(자산수증) 및 이용고배당</h3>
    </div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#sub-tab-donations" type="button" onclick="fetchGlobalDonations()">
                🎁 자산수증이익 (운영기금)
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sub-tab-dividends" type="button" onclick="fetchGlobalDividends()">
                📈 이용고배당 관리
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="sub-tab-donations">
            <div class="card border-0 shadow-sm p-3 mb-3 bg-light">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <label class="small fw-bold text-muted">조회 시작일</label>
                        <input type="date" id="don-date-start" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold text-muted">조회 종료일</label>
                        <input type="date" id="don-date-end" class="form-control form-control-sm">
                    </div>
<div class="col-md-2 d-flex align-items-end mt-auto"> 
    <button class="btn btn-sm btn-dark w-100" onclick="fetchGlobalDonations()">
        <i class="bi bi-search"></i> 조회
    </button>
</div>
                    <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
                        <div class="text-end">
                            <small class="text-muted d-block">기간 내 총 모금액</small>
                            <span class="fs-4 fw-bold text-primary" id="don-total-sum">0</span>
                            <span class="small fw-bold text-primary">원</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive bg-white border rounded" style="max-height: 550px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0 text-center small">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>날짜</th>
                            <th>이름 (조합원번호)</th>
                            <th class="text-end">금액</th>
                            <th>유형</th>
                            <th>비고(메모)</th>
                        </tr>
                    </thead>
                    <tbody id="donationGlobalBody">
                        <tr><td colspan="5" class="py-5 text-muted">조회 기간을 선택하고 검색해주세요.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="sub-tab-dividends">
            <div class="alert alert-info border-0 bg-info bg-opacity-10 small mb-3">
                <i class="bi bi-info-circle-fill me-1"></i>
                <strong>이용고배당이란?</strong> 조합원의 사업 이용 실적(전기 사용량 등)에 따라 배분되는 배당금입니다. (구 포인트)
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="input-group" style="width: 350px;">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" id="div-search-keyword" class="form-control form-control-sm border-start-0" placeholder="이름 또는 ID 검색" onkeyup="if(event.key=='Enter') fetchGlobalDividends()">
                    <button class="btn btn-sm btn-dark" onclick="fetchGlobalDividends()">검색</button>
                </div>
                <button class="btn btn-sm btn-primary fw-bold px-3" onclick="openDividendModal()">
                    + 이용고배당 수동 지급/차감
                </button>
            </div>

            <div class="table-responsive bg-white border rounded" style="max-height: 500px; overflow-y: auto;">
<table class="table table-hover align-middle mb-0 text-center small">
    <thead class="table-light sticky-top">
        <tr>
            <th>발생 일시</th>
            <th>조합원 (ID)</th>
            <th>구분 (Type)</th>
            <th class="text-end">변동액</th>
            <th>사유</th>
        </tr>
    </thead>
    <tbody id="dividendGlobalBody">
        <tr><td colspan="5" class="py-5 text-muted">로딩 중...</td></tr>
    </tbody>
</table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dividendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h6 class="modal-title fw-bold">📉 이용고배당 지급/차감</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-0">
                <ul class="nav nav-tabs nav-justified" id="dividendTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active rounded-0" data-bs-toggle="tab" data-bs-target="#tab-div-single" type="button">👤 개별 지급</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link rounded-0" data-bs-toggle="tab" data-bs-target="#tab-div-batch" type="button">📊 엑셀 일괄 지급</button>
                    </li>
                </ul>

                <div class="tab-content p-3">
                    <div class="tab-pane fade show active" id="tab-div-single">
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">대상 조합원</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="dv-member-id" class="form-control" placeholder="ID 입력 또는 검색" readonly>
                                <input type="text" id="dv-member-name" class="form-control bg-white" placeholder="이름" readonly>
                                <button class="btn btn-secondary" type="button" onclick="openMemberSearch('dividend')">🔍 찾기</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">변동 금액</label>
                            <input type="number" id="dv-amount" class="form-control form-control-sm" placeholder="지급: 1000, 차감: -1000">
                            <div class="form-text x-small text-end">단위: 원</div>
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">사유</label>
                            <input type="text" id="dv-reason" class="form-control form-control-sm" placeholder="예: 2025년 이용실적 배당">
                        </div>
                        <button class="btn btn-primary w-100 btn-sm" onclick="submitDividendGrant()">적용하기</button>
                    </div>

                    <div class="tab-pane fade" id="tab-div-batch">
                        <div class="alert alert-light border small mb-3">
                            <i class="bi bi-info-circle-fill"></i> 다수의 조합원에게 배당금을 한 번에 지급합니다.
                            <div class="mt-2 text-end">
                                <button class="btn btn-xs btn-outline-success border" onclick="downloadDividendTemplate()">
                                    <i class="bi bi-file-earmark-excel"></i> 양식 다운로드
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">엑셀 파일 선택</label>
                            <input type="file" id="div-excel-file" class="form-control form-control-sm" accept=".xlsx, .xls" onchange="readDividendExcel(this)">
                        </div>

                        <div id="div-excel-preview" style="display:none;">
                            <h6 class="small fw-bold text-primary">미리보기 (상위 5건)</h6>
                            <table class="table table-bordered table-sm x-small text-center">
                                <thead class="table-light"><tr><th>ID</th><th>이름</th><th>금액</th><th>사유</th></tr></thead>
                                <tbody id="div-excel-tbody"></tbody>
                            </table>
                            <div class="text-end small text-muted mb-2" id="div-excel-count"></div>
                            
                            <button class="btn btn-success w-100 btn-sm fw-bold" onclick="submitDividendBatch()">
                                <i class="bi bi-check-lg"></i> 일괄 적용하기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="memberSearchModal" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold">🔍 조합원 찾기</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group input-group-sm mb-3">
                    <input type="text" id="ms-keyword" class="form-control" placeholder="이름 입력" onkeyup="if(event.key=='Enter') searchMemberForModal()">
                    <button class="btn btn-dark" onclick="searchMemberForModal()">검색</button>
                </div>
                <div class="list-group list-group-flush border rounded" id="ms-result-list" style="max-height: 250px; overflow-y: auto;">
                    <div class="text-center py-4 text-muted x-small">이름을 입력하세요.</div>
                </div>
            </div>
        </div>
    </div>
</div>   

<div id="tab-deposit" class="tab-pane">
<div class="content-header"><h3>💰 입금 내역 매칭</h3></div>
<div class="row">
<div class="col-md-4">
<div class="card p-3 h-100 border-0 shadow-sm">
<h6 class="fw-bold mb-3">1. 은행 엑셀 업로드</h6>
<input type="file" id="depositFile" class="form-control mb-3" onchange="readExcel(this)">
<div class="small text-muted">엑셀 파일에 '입금자명' 또는 '성명', '입금액' 칼럼이 있어야 자동으로 인식합니다.</div>
</div>
</div>
<div class="col-md-8">
<div class="card p-3 h-100 border-0 shadow-sm">
<h6 class="fw-bold mb-3">2. 매칭 결과</h6>
<div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
<table class="table table-sm">
<thead style="position:sticky; top:0; background:white;"><tr><th>입금자명</th><th>입금액</th><th>매칭된 조합원</th></tr></thead>
<tbody id="depositResultBody"><tr><td colspan="3" class="text-center text-muted py-5">파일을 업로드하세요.</td></tr></tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div id="tab-notices" class="tab-pane">
<div class="content-header">
<h3>📢 공지사항 관리</h3>
<button class="btn btn-primary btn-sm" onclick="openNoticeModal()"><i class="bi bi-pencil"></i> 공지 작성</button>
</div>
<div class="card border-0 shadow-sm">
<div class="table-responsive">
<table class="table table-hover mb-0">
<thead><tr><th>날짜</th><th>분류</th><th>제목</th><th>팝업</th><th>상태</th><th>관리</th></tr></thead>
<tbody id="noticeListBody"></tbody>
</table>
</div>
</div>
</div>

<div class="tab-pane fade" id="tab-site">
<div class="content-header"><h3>🖥️ 홈페이지 컨텐츠 관리</h3></div>

<ul class="nav nav-tabs mb-4">

<li class="nav-item">
<a class="nav-link active" data-bs-toggle="tab" href="#sub-sections" onclick="setTimeout(fetchSections,100)">
섹션 설정 (ON/OFF)
</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-about" onclick="fetchAboutSettings()">조합 소개 (About)</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-plants" onclick="setTimeout(fetchPlants,100)">
발전소 현황
</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-docs" onclick="setTimeout(fetchDocs,100)">
문서 관리 (정관/규약)
</a>
</li>

<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-history" onclick="setTimeout(fetchHistory,100)">
연혁 (History)
</a>
</li>

<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-partners" onclick="setTimeout(fetchPartners,100)">
🤝 협력 단체
</a>
</li> 
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-faqs" onclick="setTimeout(fetchFaqs,100)">
❓ FAQ 관리
</a>
</li>
<li class="nav-item">
<a class="nav-link" data-bs-toggle="tab" href="#sub-badges" onclick="setTimeout(fetchBadges,100)">
🏅 뱃지 관리
</a>
</li>

</ul>

<div class="tab-content">

<div class="tab-pane fade show active" id="sub-sections">
<div class="alert alert-info small">
<i class="bi bi-info-circle-fill"></i> 홈페이지의 메뉴와 본문 섹션을 끄고 켤 수 있습니다. (체크 해제 시 즉시 반영)
</div>
<table class="table table-bordered bg-white text-center">
<thead class="table-light"><tr><th>순서</th><th>섹션 이름(ID)</th><th>상태</th><th>관리</th></tr></thead>
<tbody id="sectionListBody">
</tbody>
</table>
</div>


<div class="tab-pane fade" id="sub-about">
<div class="card p-0 border-0 shadow-sm">
<div class="card-header bg-white border-bottom-0 pt-3 ps-3">
<ul class="nav nav-tabs card-header-tabs" id="aboutTab" role="tablist">
<li class="nav-item">
<button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#about-edit-tab" type="button">✏️ 편집 모드</button>
</li>
<li class="nav-item">
<button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#about-preview-tab" type="button" onclick="updateTotalPreview()">👀 전체 미리보기</button>
</li>
</ul>
</div>
<div class="card-body">
<div class="tab-content">
<div class="tab-pane fade show active" id="about-edit-tab">
<div class="alert alert-light small mb-3 border"><i class="bi bi-info-circle"></i> HTML 태그 사용 가능</div>
<div class="mb-3"><label class="form-label fw-bold">1. 메인 제목</label><input type="text" id="admin-about-title" class="form-control"></div>
<div class="mb-3"><label class="form-label fw-bold">2. 부제목</label><input type="text" id="admin-about-subtitle" class="form-control"></div>
<div class="row">
<div class="col-md-6 mb-3"><label class="form-label fw-bold">3. 체크리스트</label><textarea id="admin-about-list" class="form-control" rows="6"></textarea></div>
<div class="col-md-6 mb-3"><label class="form-label fw-bold">4. 본문 내용</label><textarea id="admin-about-content" class="form-control" rows="6"></textarea></div>
</div>
<div class="mb-3"><label class="form-label fw-bold">5. 사진 URL</label><input type="text" id="admin-about-img" class="form-control"></div>
<div class="text-end mt-3"><button class="btn btn-primary px-4" onclick="saveAboutSettings()">저장하기</button></div>
</div>
<div class="tab-pane fade" id="about-preview-tab">
<div class="border rounded p-4 bg-light">
<div class="row align-items-center bg-white p-3 shadow-sm rounded">
<div class="col-lg-6">
<h3 id="prev-title" class="fw-bold mb-2"></h3>
<p id="prev-subtitle" class="fst-italic text-muted mb-3"></p>
<ul id="prev-list" class="list-unstyled mb-3"></ul>
<p id="prev-content"></p>
</div>
<div class="col-lg-6 text-center">
<img id="prev-img" src="" class="img-fluid rounded" style="max-height:300px;">
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="tab-pane fade" id="sub-plants">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openPlantModal()">+ 발전소 추가</button>
</div>
<table class="table table-bordered bg-white">
<thead><tr><th>순서</th><th>발전소명</th><th>용량(kW)</th><th>상태</th><th>모니터링</th><th>관리</th></tr></thead>
<tbody id="plantListBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-history">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openSiteHistoryModal()">+ 연혁 추가</button>
</div>
<table class="table table-bordered bg-white">
<thead><tr><th>날짜</th><th>제목</th><th>내용</th><th>관리</th></tr></thead>
<tbody id="historyListBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-partners">
<div class="card border-warning mb-4 shadow-sm">
<div class="card-header bg-warning bg-opacity-10 fw-bold text-warning-emphasis">
⏳ 승인 대기 중인 신청
</div>
<div class="card-body p-0">
<table class="table table-hover mb-0">
<tbody id="partnerPendingBody"></tbody>
</table>
</div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
<h5 class="fw-bold m-0">✅ 등록된 파트너</h5>
<button class="btn btn-sm btn-outline-primary" onclick="openPartnerModal()">+ 파트너 수동 등록</button>
</div>
<table class="table table-bordered bg-white align-middle">
<thead class="table-light text-center">
<tr>
<th style="width:60px;">순서</th>
<th style="width:80px;">로고</th>
<th>단체 정보</th>
<th>뱃지</th>
<th style="width:120px;">관리</th>
</tr>
</thead>
<tbody id="partnerActiveBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-badges">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openBadgeModal()">+ 새 뱃지 만들기</button>
</div>
<div class="alert alert-light border small">
<i class="bi bi-info-circle"></i> 이곳에서 만든 뱃지는 '협력 단체'나 '조합원'에게 부여할 수 있습니다.
</div>
<table class="table table-bordered bg-white text-center align-middle">
<thead class="table-light">
<tr>
<th width="60">순서</th>
<th width="60">아이콘</th>
<th>이름 / 설명</th>
<th width="100">코드</th>
<th width="100">색상</th>
<th width="120">관리</th>
</tr>
</thead>
<tbody id="badgeListBody"></tbody>
</table>
</div>

<div class="tab-pane fade" id="sub-faqs">
<div class="d-flex justify-content-between align-items-center mb-3">
<div class="d-flex gap-2">
<input type="text" id="search-faq" class="form-control form-control-sm" placeholder="질문 검색..." onkeyup="if(event.key=='Enter') fetchFaqs()">
<button class="btn btn-sm btn-outline-secondary" onclick="fetchFaqs()">검색</button>
</div>
<button class="btn btn-sm btn-outline-primary" onclick="openFaqModal()">+ 질문 추가</button>
</div>

<table class="table table-bordered bg-white align-middle">
<thead class="table-light text-center">
<tr>
<th style="width:60px;">순서</th>
<th style="width:100px;">분류</th>
<th>질문 및 답변 요약</th>
<th style="width:80px;">상태</th>
<th style="width:120px;">관리</th>
</tr>
</thead>
<tbody id="faqListBody"></tbody>
</table>
</div>                    

<div class="tab-pane fade" id="sub-docs">
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-primary" onclick="openDocModal()">+ 새 문서 등록</button>
</div>

<table class="table table-bordered bg-white text-center">
<thead class="table-light">
<tr>
<th>날짜/버전</th>
<th>제목</th>
<th>개정 요약</th>
<th>파일</th>
<th>관리</th>
</tr>
</thead>
<tbody id="docListBody"></tbody>
</table>
</div>








</div>
</div>
</div>

<div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:none; justify-content:center; align-items:center; z-index:9999;">
<div class="spinner-border text-primary" role="status"></div>
</div>

<div class="modal fade" id="excelModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title fw-bold">엑셀 다운로드 옵션</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<div class="form-check mb-2">
<input class="form-check-input" type="radio" name="excelOption" value="public" checked onchange="togglePwd(false)">
<label class="form-check-label">일반용 (기본 정보)</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="excelOption" value="secret" onchange="togglePwd(true)">
<label class="form-check-label text-danger">보안용 (주민번호/계좌 포함)</label>
</div>
<div class="mt-3" id="pwdArea" style="display:none;">
<input type="password" id="decryptKey" class="form-control form-control-sm" placeholder="암호화 비밀번호 입력">
</div>
</div>
<div class="modal-footer"><button class="btn btn-success" onclick="downloadExcel()">다운로드</button></div>
</div>
</div>
</div>

<div class="modal fade" id="memberEditModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">회원 정보 수정</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="edit-id">
<div class="mb-3"><label class="form-label small">이름</label><input type="text" id="edit-name" class="form-control"></div>
<div class="mb-3"><label class="form-label small">연락처</label><input type="text" id="edit-phone" class="form-control"></div>
<div class="mb-3"><label class="form-label small">상태</label><select id="edit-status" class="form-select"><option value="정상">정상</option><option value="탈퇴">탈퇴</option><option value="제명">제명</option></select></div>
<div class="mb-3"><label class="form-label small">비고</label><textarea id="edit-note" class="form-control" rows="3"></textarea></div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="saveMember()">저장</button></div>
</div>
</div>
</div>

<div class="modal fade" id="noticeModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">공지사항 작성</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="notice-id">
<div class="mb-3"><label class="form-label small">제목</label><input type="text" id="notice-title" class="form-control"></div>
<div class="mb-3"><label class="form-label small">내용</label><textarea id="notice-content" class="form-control" rows="5"></textarea></div>
<div class="row mb-3">
<div class="col"><label class="form-label small">분류</label><select id="notice-category" class="form-select"><option>공지</option><option>소식</option><option>보도자료</option></select></div>
<div class="col"><label class="form-label small">상태</label><select id="notice-status" class="form-select"><option value="published">게시</option><option value="draft">임시저장</option></select></div>
</div>
<div class="form-check">
<input class="form-check-input" type="checkbox" id="notice-popup">
<label class="form-check-label small">메인 팝업으로 띄우기</label>
</div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="saveNotice()">저장</button></div>
</div>
</div>
</div>

<div class="modal fade" id="plantModal" tabindex="-1">
<div class="modal-dialog modal-lg"> <div class="modal-content">
<div class="modal-header"><h5 class="modal-title fw-bold">발전소 정보 관리</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="plant-id">

<div class="row">
<div class="col-md-6 border-end">
<h6 class="text-primary fw-bold mb-3">📌 기본 정보</h6>
<div class="mb-2"><label class="form-label small">발전소명</label><input type="text" id="plant-name" class="form-control"></div>
<div class="row">
<div class="col-6 mb-2"><label class="form-label small">설비용량 (kW)</label><input type="number" id="plant-capacity" class="form-control" placeholder="0"></div>
<div class="col-6 mb-2"><label class="form-label small">순서</label><input type="number" id="plant-order" class="form-control"></div>
</div>
<div class="mb-2"><label class="form-label small">위치 (주소)</label><input type="text" id="plant-location" class="form-control" placeholder="예: 용인시 처인구..."></div>
<div class="row">
<div class="col-6 mb-2"><label class="form-label small">면적</label><input type="text" id="plant-area" class="form-control" placeholder="예: 150m²"></div>
<div class="col-6 mb-2"><label class="form-label small">준공일(예정)</label><input type="date" id="plant-date" class="form-control"></div>
</div>
<div class="mb-3"><label class="form-label small">상태</label>
<select id="plant-status" class="form-select" onchange="toggleProgressSlider()">
<option value="운영중">운영중 (Portfolio)</option>
<option value="공사중">공사중 (Progress)</option>
<option value="준비중">준비중 (Progress)</option>
</select>
</div>
</div>

<div class="col-md-6">
<div id="plant-progress-area" style="display:none;">
<h6 class="text-primary fw-bold mb-3">🚧 진행 상황</h6>
<div class="p-3 bg-light rounded mb-3">
<label class="d-flex justify-content-between small fw-bold">
<span>진행률</span> <span class="text-primary" id="plant-progress-label">0%</span>
</label>
<input type="range" id="plant-progress" class="form-range" min="0" max="100" step="1" oninput="updateProgressLabel(this.value)">
<div class="d-flex justify-content-between text-muted mt-1" style="font-size:0.7em;">
<span onclick="setProg(0)" style="cursor:pointer">설립</span>
<span onclick="setProg(25)" style="cursor:pointer">부지</span>
<span onclick="setProg(50)" style="cursor:pointer">인허가</span>
<span onclick="setProg(75)" style="cursor:pointer">착공</span>
<span onclick="setProg(100)" style="cursor:pointer">완공</span>
</div>
</div>
</div>

<h6 class="text-primary fw-bold mb-3">📷 현장 사진</h6>
<div class="mb-2 d-flex gap-2">
<input type="file" id="plant-file" class="form-control form-control-sm" accept="image/*" onchange="previewImage(this)">
<button type="button" class="btn btn-sm btn-outline-danger" onclick="clearPlantImage()" title="사진 삭제"><i class="bi bi-trash"></i></button>
</div>

<input type="hidden" id="plant-img-original">
<input type="hidden" id="plant-img-url">

<div class="text-center bg-light border rounded d-flex align-items-center justify-content-center" style="height: 150px; overflow:hidden; position:relative;">
<img id="plant-img-preview" src="" style="max-width:100%; max-height:100%; display:none;">
<span id="plant-img-placeholder" class="text-muted small">사진 없음</span>
</div>

<div class="mt-3">
<label class="form-label small">모니터링 URL</label>
<input type="text" id="plant-url" class="form-control form-control-sm" placeholder="http://...">
</div>
</div>
</div>
</div>
<div class="modal-footer"><button class="btn btn-primary px-4" onclick="savePlant()">저장하기</button></div>
</div>
</div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">연혁 등록</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<input type="hidden" id="hist-id">
<div class="mb-3"><label class="form-label small">날짜</label><input type="date" id="hist-date" class="form-control"></div>
<div class="mb-3"><label class="form-label small">제목</label><input type="text" id="hist-title" class="form-control"></div>
<div class="mb-3"><label class="form-label small">내용 (선택)</label><textarea id="hist-content" class="form-control" rows="3"></textarea></div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="saveSiteHistory()">저장</button></div>
</div>
</div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold text-danger">⚠️ 삭제 확인</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p class="mb-0">정말로 삭제하시겠습니까? <br><small class="text-muted">이 작업은 되돌릴 수 없습니다.</small></p>
<input type="hidden" id="delete-target-id"> </div>
<div class="modal-footer">
<button type="button" class="btn btn-light" data-bs-dismiss="modal">취소</button>
<button type="button" class="btn btn-danger" id="btn-real-delete">삭제하기</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="commonAlertModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content text-center p-3">
<div class="modal-body">
<div class="mb-2">
<i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
</div>
<h6 class="fw-bold mb-0" id="commonAlertText">처리되었습니다.</h6>
</div>
<div class="modal-footer justify-content-center border-0 p-0 pb-2">
<button type="button" class="btn btn-sm btn-dark px-4" data-bs-dismiss="modal">확인</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="docModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content border-0 shadow">
<div class="modal-header bg-white">
<h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-text text-primary me-2"></i>규정/문서 등록</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body p-4">
<input type="hidden" id="doc-id">

<div class="row g-3 mb-3">
<div class="col-md-7">
<label class="form-label small fw-bold text-muted">문서 제목</label>
<input type="text" id="doc-title" class="form-control" placeholder="예: 정관">
</div>
<div class="col-md-5">
<label class="form-label small fw-bold text-muted">버전명</label>
<input type="text" id="doc-version" class="form-control" placeholder="예: 2026.01 개정">
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold text-muted">시행일</label>
<input type="date" id="doc-date" class="form-control">
</div>

<div class="mb-3">
<label class="form-label small fw-bold text-muted">전문 내용 (한글/워드 붙여넣기)</label>
<textarea id="doc-content" class="form-control" rows="8" placeholder="제1장 총칙&#13;&#10;제1조(목적)... 내용을 여기에 붙여넣으세요."></textarea>
<div class="form-text text-end x-small">자동으로 조항을 인식하여 카드 형태로 변환합니다.</div>
</div>


<div class="form-check p-3 bg-light rounded border">
<div class="ps-3"> <input class="form-check-input" type="checkbox" id="doc-current">
<label class="form-check-label fw-bold text-primary" for="doc-current">
이 문서를 '현재 적용 버전'으로 설정
</label>
</div>
</div>
</div>
<div class="modal-footer border-0 pt-0">
<button class="btn btn-light" data-bs-dismiss="modal">취소</button>
<button class="btn btn-primary px-4" onclick="saveDoc()">저장하기</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="partnerModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold">🤝 협력 단체 관리</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="pt-id">

<div class="row g-3">
<div class="col-md-7">
<div class="row g-2 mb-2">
<div class="col-md-8">
<label class="form-label small fw-bold">단체명 <span class="text-danger">*</span></label>
<input type="text" id="pt-name" class="form-control">
</div>
<div class="col-md-4">
<label class="form-label small fw-bold">조합원 번호</label>
<input type="text" id="pt-member-id" class="form-control" placeholder="선택">
</div>
</div>

<div class="mb-2">
<label class="form-label small fw-bold">한 줄 소개</label>
<input type="text" id="pt-desc" class="form-control" placeholder="예: 용인 지역 에너지 전환을 위한 시민 모임">
</div>

<div class="mb-2">
<label class="form-label small fw-bold">홈페이지 링크</label>
<input type="text" id="pt-link" class="form-control" placeholder="https://...">
</div>

<div class="row g-2 mb-2">
<div class="col-6">
<label class="form-label small fw-bold">상태</label>
<select id="pt-status" class="form-select">
<option value="active">✅ 승인 (노출)</option>
<option value="pending">⏳ 대기 (숨김)</option>
</select>
</div>
<div class="col-6">
<label class="form-label small fw-bold">순서</label>
<input type="number" id="pt-order" class="form-control">
</div>
</div>

<div class="mb-2">
<label class="form-label small fw-bold text-primary">🏅 뱃지 부여</label>
<div class="card p-2 bg-light border-0" style="max-height:120px; overflow-y:auto;">
<div id="badge-checkboxes" class="d-flex flex-wrap gap-2">
</div>
</div>
</div>
</div>

<div class="col-md-5 border-start">
<label class="form-label small fw-bold">로고 이미지</label>
<input type="file" id="pt-file" class="form-control form-control-sm mb-2" accept="image/*" onchange="previewPartnerImage(this)">

<input type="hidden" id="pt-img-original">
<input type="hidden" id="pt-img-url">

<div class="border rounded d-flex align-items-center justify-content-center bg-light" style="height: 150px; position:relative;">
<img id="pt-img-preview" src="" style="max-width:100%; max-height:100%; display:none;">
<span id="pt-img-placeholder" class="text-muted small">로고 없음</span>
<button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" onclick="clearPartnerImage()" style="font-size:0.7rem;">삭제</button>
</div>
<div class="small text-muted mt-2 text-center">* 배경 투명한 PNG 권장</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary px-4" onclick="savePartner()">저장하기</button>
</div>
</div>
</div>
</div>


<div class="modal fade" id="badgeModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold">🏅 뱃지 디자인/설정</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="bg-id">

<div class="row g-2 mb-3">
<div class="col-md-3">
<label class="form-label small fw-bold">아이콘</label>
<input type="text" id="bg-icon" class="form-control text-center" placeholder="🌱" style="font-size:1.5rem;">
<div class="form-text x-small">이모지 권장</div>
</div>
<div class="col-md-9">
<label class="form-label small fw-bold">뱃지 이름</label>
<input type="text" id="bg-name" class="form-control" placeholder="예: 모범 조합원">
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold">설명 (획득 조건 등)</label>
<input type="text" id="bg-desc" class="form-control" placeholder="예: 조합 행사 10회 이상 참여">
</div>

<div class="row g-2 mb-3">
<div class="col-md-6">
<label class="form-label small fw-bold">고유 코드 (영어)</label>
<input type="text" id="bg-code" class="form-control" placeholder="example_code">
</div>
<div class="col-md-3">
<label class="form-label small fw-bold">색상</label>
<select id="bg-color" class="form-select">
<option value="primary" class="text-primary">파랑</option>
<option value="success" class="text-success">초록</option>
<option value="warning" class="text-warning">노랑</option>
<option value="danger" class="text-danger">빨강</option>
<option value="info" class="text-info">하늘</option>
<option value="dark" class="text-dark">검정</option>
</select>
</div>
<div class="col-md-3">
<label class="form-label small fw-bold">순서</label>
<input type="number" id="bg-order" class="form-control">
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary w-100" onclick="saveBadge()">뱃지 저장</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="faqModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title fw-bold">❓ 자주 묻는 질문 관리</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="hidden" id="faq-id">

<div class="row mb-3">
<div class="col-md-3">
<label class="form-label small fw-bold">카테고리</label>
<select id="faq-category" class="form-select">
<option value="가입/탈퇴">가입/탈퇴</option>
<option value="출자/배당">출자/배당</option>
<option value="발전소">발전소</option>
<option value="활동">활동</option>
<option value="기타">기타</option>
</select>
</div>
<div class="col-md-3">
<label class="form-label small fw-bold">순서</label>
<input type="number" id="faq-order" class="form-control" value="0">
</div>
<div class="col-md-6 d-flex align-items-end">
<div class="form-check form-switch mb-2 ms-2">
<input class="form-check-input" type="checkbox" id="faq-visible" checked>
<label class="form-check-label small fw-bold" for="faq-visible">홈페이지에 공개</label>
</div>
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-bold">질문 (Q)</label>
<input type="text" id="faq-question" class="form-control" placeholder="예: 조합원 가입은 어떻게 하나요?">
</div>

<div class="mb-3">
<label class="form-label small fw-bold">답변 (A)</label>
<textarea id="faq-answer" class="form-control" rows="6" placeholder="답변 내용을 입력하세요."></textarea>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary px-4" onclick="saveFaq()">저장하기</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="memberDetailModal" tabindex="-1" data-bs-backdrop="static">
<div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content">
<div class="modal-header bg-light">
<div>
<h5 class="modal-title fw-bold" id="md-title">조합원 상세 정보</h5>
<span class="badge bg-secondary" id="md-type-badge">-</span>
<span class="small text-muted ms-2" id="md-id-text">-</span>
</div>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body p-0">
<ul class="nav nav-tabs nav-justified" id="memberDetailTab" role="tablist">
<li class="nav-item">
<button class="nav-link active py-3" data-bs-toggle="tab" data-bs-target="#md-tab-basic" type="button">
📝 기본 정보
</button>
</li>
<li class="nav-item">
<button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#md-tab-funds" type="button">
💰 출자/배당/자금
</button>
</li>
<li class="nav-item">
<button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#md-tab-family" type="button">
👨‍👩‍👧‍👦 가족/단체 연결
</button>
</li>
<li class="nav-item">
<button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#md-tab-consult" type="button">
📞 상담 이력
</button>
</li>
</ul>

<div class="tab-content p-4">
<div class="tab-pane fade show active" id="md-tab-basic">
    <input type="hidden" id="md-uid">

    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">이름</label>
            <input type="text" id="md-name" class="form-control fw-bold">
        </div>
        <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">연락처</label>
            <input type="text" id="md-phone" class="form-control" maxlength="13" oninput="autoHyphen(this)">
        </div>
        <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">상태</label>
            <select id="md-status" class="form-select">
                <option value="승인대기">승인 대기</option>
                <option value="정상">정상 (정조합원)</option>
                <option value="탈퇴">탈퇴</option>
                <option value="제명">제명</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label small fw-bold text-muted">유형</label>
            <select id="md-type" class="form-select">
                <option value="개인">개인</option>
                <option value="단체">단체</option>
            </select>
        </div>

<div class="col-md-12">
            <div id="area-individual">
                <label class="form-label small fw-bold text-muted">생년월일/성별 (주민/사업자번호)</label>
                <div id="rrn-view-area" class="p-2 bg-light rounded border text-secondary fw-bold">
                    <span id="md-rrn-view">-</span>
                </div>
                <div id="rrn-edit-area" style="display:none;">
                    <input type="text" id="md-rrn" class="form-control" placeholder="변경하려면 숫자만 입력하세요" maxlength="14"
                        oninput="autoHyphen(this)">
                </div>
            </div>

            <div id="area-group" style="display:none;">
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">법인등록번호</label>
                        <input type="text" id="md-corp-num" class="form-control" placeholder="000000-0000000" maxlength="14" oninput="autoHyphen(this)" disabled>
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">사업자(고유)번호</label>
                        <input type="text" id="md-biz-num" class="form-control" placeholder="000-00-00000" maxlength="12" oninput="autoHyphen(this)" disabled>
                    </div>
                </div>
                <div class="form-text x-small mt-1 text-end">* 단체 정보는 하이픈(-)을 포함하여 입력해주세요.</div>
            </div>
        </div>

        <div class="col-md-12">
            <label class="form-label small fw-bold text-muted">주소</label>
            <div class="input-group mb-1">
                <input type="text" id="md-addr" class="form-control" readonly>
                <button class="btn btn-outline-secondary" type="button" id="btn-addr-search" onclick="searchAddress()"
                    style="display:none;">🔍 검색</button>
            </div>
            <input type="text" id="md-addr-detail" class="form-control" placeholder="상세 주소 (수정 시 입력)"
                style="display:none;">
        </div>

        <div class="col-md-12">
            <label class="form-label small fw-bold text-muted">🏅 보유 뱃지 (내부 관리용)</label>
            <div class="card p-3 bg-light border-0" style="max-height:150px; overflow-y:auto;">
                <div id="member-badge-checkboxes" class="d-flex flex-wrap gap-2">
                    <span class="text-muted small">로딩중...</span>
                </div>
            </div>
            <div class="form-text x-small text-end">
                * 체크박스를 변경하고 아래 '저장 완료'를 누르면 반영됩니다.
            </div>
        </div>

        <div class="col-md-12">
            <label class="form-label small fw-bold text-muted">관리자 메모</label>
            <textarea id="md-memo" class="form-control" rows="2"></textarea>
        </div>

        <div class="col-12">
            <hr class="my-2">
        </div>

        <div class="col-md-12">
            <h6 class="fw-bold small text-primary mb-2">🏦 환급/배당 계좌 정보</h6>
            <div class="row g-2 align-items-center bg-light p-3 rounded border">
                <div class="col-md-3">
                    <label class="small text-muted">은행명</label>
                    <input type="text" id="md-bank-name" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">예금주</label>
                    <input type="text" id="md-bank-owner" class="form-control form-control-sm">
                </div>
                <div class="col-md-4">
                    <label class="small text-muted">계좌번호</label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="md-bank-account" class="form-control" placeholder="숫자만 입력">
                    </div>
                </div>
                <div class="col-md-2 text-end pt-3">
                    <small class="text-muted fw-bold" id="md-sns-status" style="font-size:0.75rem;">SNS 미연동</small>
                </div>
            </div>
        </div>
    </div> <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-outline-dark btn-sm" onclick="alert('준비중')">🖨️ 증명서</button>
        <button id="btn-edit-mode" class="btn btn-primary px-4" onclick="toggleEditMode(true)">✏️ 정보 수정</button>
        <div id="btn-save-group" style="display:none;">
            <button class="btn btn-secondary me-2" onclick="toggleEditMode(false)">취소</button>
            <button class="btn btn-success px-4 fw-bold" onclick="saveMemberBasic()">💾 저장 완료</button>
        </div>
    </div>

</div> 

</div>


<div class="tab-pane fade" id="md-tab-funds">
<div class="d-flex justify-content-between align-items-center mb-2">
<h6 class="fw-bold m-0 text-success">💰 출자금 내역</h6>
<button class="btn btn-sm btn-outline-success" onclick="openFundEditor('capital', null)">+ 출자금 추가</button>
</div>
<div class="table-responsive mb-4 border rounded" style="max-height: 200px;">
<table class="table table-sm table-hover mb-0 text-center small">
<thead class="table-light sticky-top"><tr><th>날짜</th><th>금액</th><th>비고</th><th>관리</th></tr></thead>
<tbody id="md-capital-list"></tbody>
</table>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
<h6 class="fw-bold m-0 text-primary">🎁 기부금 내역</h6>
<button class="btn btn-sm btn-outline-primary" onclick="openFundEditor('donation', null)">+ 기부금 추가</button>
</div>
<div class="table-responsive mb-4 border rounded" style="max-height: 200px;">
<table class="table table-sm table-hover mb-0 text-center small">
<thead class="table-light sticky-top"><tr><th>날짜</th><th>금액</th><th>유형</th><th>비고</th><th>관리</th></tr></thead>
<tbody id="md-donation-list"></tbody>
</table>
</div>

<div class="row">
<div class="col-md-6">
<h6 class="fw-bold text-warning">🪙 포인트/적립금</h6>
<div class="border rounded p-3 text-center bg-light">
<h4 class="fw-bold mb-0" id="md-point-total">0 P</h4>
<button class="btn btn-sm btn-link text-decoration-none" onclick="alert('Phase 3: 포인트 내역 상세')">내역 보기</button>
</div>
</div>
<div class="col-md-6">
<h6 class="fw-bold text-info">💵 미지급 배당금</h6>
<div class="border rounded p-3 text-center bg-light">
<h4 class="fw-bold mb-0" id="md-dividend-total">0 원</h4>
<button class="btn btn-sm btn-link text-decoration-none" onclick="alert('Phase 3: 배당금 지급 처리')">지급 처리</button>
</div>
</div>
</div>
</div>

<div class="tab-pane fade" id="md-tab-family">
<div class="alert alert-light border small">
<i class="bi bi-info-circle"></i> 이 조합원이 관리하는 <strong>가족(자녀)</strong>이나 <strong>단체</strong> 목록입니다.
</div>
<div class="d-flex justify-content-end mb-2">
<button class="btn btn-sm btn-outline-dark" onclick="alert('Phase 3: 자녀 계정 생성')">+ 자녀 계정 추가</button>
</div>
<table class="table table-bordered text-center align-middle">
<thead class="table-light"><tr><th>관계</th><th>이름</th><th>생년월일</th><th>상태</th><th>관리</th></tr></thead>
<tbody id="md-family-list">
<tr><td colspan="5" class="text-muted small py-3">연결된 가족/단체가 없습니다.</td></tr>
</tbody>
</table>
</div>

<div class="tab-pane fade" id="md-tab-consult">
<div class="input-group mb-3">
<input type="text" id="md-consult-input" class="form-control" placeholder="상담/통화 내용을 입력하세요 (예: 계좌번호 변경 요청)">
<button class="btn btn-dark" onclick="addConsultLog()">등록</button>
</div>
<div class="list-group list-group-flush border rounded overflow-auto" style="max-height: 400px;" id="md-consult-list">
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="modal fade" id="fundEditorModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-light py-2">
        <h6 class="modal-title fw-bold" id="fund-modal-title">내역 입력</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <input type="hidden" id="fund-edit-id">
        <input type="hidden" id="fund-edit-type">

        <div class="mb-2">
          <label class="form-label small fw-bold text-muted">날짜</label>
          <input type="date" id="fund-date" class="form-control form-control-sm">
        </div>

        <div class="mb-2">
          <label class="form-label small fw-bold text-muted">금액</label>
          <input type="number" id="fund-amount" class="form-control form-control-sm" placeholder="숫자만 입력">
        </div>

        <div class="mb-2" id="fund-method-group" style="display:none;">
          <label class="form-label small fw-bold text-muted">입금 방식</label>
          <select id="fund-method" class="form-select form-select-sm">
            <option value="transfer">계좌이체</option>
            <option value="cash">현금</option>
            <option value="card">카드</option>
            <option value="etc">기타</option>
          </select>
        </div>

        <div class="mb-2" id="fund-depositor-group">
          <label class="form-label small fw-bold text-muted">입금자명</label>
          <input type="text" id="fund-depositor" class="form-control form-control-sm">
        </div>

        <div class="mb-3">
          <label class="form-label small fw-bold text-muted">비고 (메모)</label>
          <input type="text" id="fund-note" class="form-control form-control-sm">
        </div>

        <button class="btn btn-primary w-100 btn-sm mb-2" onclick="saveFundData()">저장하기</button>
        
        <button id="btn-fund-delete" class="btn btn-outline-danger w-100 btn-sm" style="display:none;" onclick="deleteFundData()">
            <i class="bi bi-trash"></i> 이 내역 삭제하기
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="customAlertModal" tabindex="-1" style="z-index: 9999;">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content text-center p-3 border-0 shadow">
<div class="modal-body">
<div class="mb-2" id="alertIcon"></div>
<h6 class="fw-bold mb-0" id="alertText"></h6>
</div>
<div class="modal-footer justify-content-center border-0 p-0 pb-2">
<button type="button" class="btn btn-sm btn-dark px-4" data-bs-dismiss="modal">확인</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="customConfirmModal" tabindex="-1" style="z-index: 9999;">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content border-0 shadow">
<div class="modal-header border-0 pb-0">
<h6 class="modal-title fw-bold">확인</h6>
</div>
<div class="modal-body py-4 text-center">
<p class="mb-0" id="confirmText">진행하시겠습니까?</p>
</div>
<div class="modal-footer border-0 justify-content-center pt-0">
<button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">취소</button>
<button type="button" class="btn btn-sm btn-primary" id="btnConfirmYes">확인</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="groupSearchModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h6 class="modal-title fw-bold">🏢 관리할 단체 찾기</h6>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="input-group mb-3">
<input type="text" id="group-search-input" class="form-control" placeholder="단체명 입력" onkeyup="if(event.key=='Enter') searchGroups()">
<button class="btn btn-outline-secondary" onclick="searchGroups()">검색</button>
</div>
<div class="list-group" id="group-search-result" style="max-height: 300px; overflow-y: auto;">
</div>
</div>
</div>
</div>
</div>


<div class="modal fade" id="relationSelectModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered modal-sm">
<div class="modal-content">
<div class="modal-header bg-light">
<h6 class="modal-title fw-bold">➕ 가족/단체 추가</h6>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p class="small text-muted mb-3">어떤 관계를 추가하시겠습니까?</p>

<div class="form-check mb-3">
<input class="form-check-input" type="radio" name="relationType" id="rel-child" value="child" checked>
<label class="form-check-label fw-bold" for="rel-child">
👶 자녀 계정 생성
</label>
<div class="text-muted x-small ms-2">
- 부모 계정에 종속됨<br>
- 별도 로그인 불가
</div>
</div>

<div class="form-check">
<input class="form-check-input" type="radio" name="relationType" id="rel-org" value="org">
<label class="form-check-label fw-bold" for="rel-org">
🏢 단체 계정 연결
</label>
<div class="text-muted x-small ms-2">
- 내가 관리할 단체를 연결<br>
- 기존 가입된 단체 검색 필요
</div>
</div>
</div>
<div class="modal-footer p-2">
<button type="button" class="btn btn-primary w-100" onclick="confirmRelationType()">다음 단계로 이동</button>
</div>
</div>
</div>
</div>

    <div class="modal fade" id="childRegisterModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10">
                <h6 class="modal-title fw-bold">👶 자녀 조합원 등록</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning small py-2 mb-3">
                    <i class="bi bi-exclamation-circle-fill me-1"></i>
                    부모 계정에 종속된 가족 회원을 생성합니다. (별도 로그인 불가)
                </div>
                
                <form id="form-child-add">
                    <div class="mb-2">
                        <label class="form-label x-small text-muted mb-0">부모(관리자)</label>
                        <input type="text" id="child-parent-name" class="form-control form-control-sm bg-light" readonly>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-bold">자녀 이름 <span class="text-danger">*</span></label>
                        <input type="text" id="child-name" class="form-control" placeholder="이름 입력">
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-bold">주민등록번호 <span class="text-danger">*</span></label>
                        <input type="text" id="child-rrn" class="form-control" placeholder="숫자만 입력 (13자리)" maxlength="14" oninput="autoHyphen(this)">
                        <div class="form-text x-small">출자금 배당 및 세무 처리를 위해 필수입니다.</div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-bold">연락처 (부모 번호)</label>
                        <input type="text" id="child-phone" class="form-control" maxlength="13" oninput="autoHyphen(this)">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">주소 (부모 주소)</label>
                        <input type="text" id="child-address" class="form-control" placeholder="주소 입력">
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light p-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary btn-sm px-4 fw-bold" onclick="saveChildMember()">자녀 등록 완료</button>
            </div>
        </div>
    </div>
</div>


    <div class="modal fade" id="adminLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-shield-lock-fill me-2"></i>관리자 활동 로그</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body bg-light">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body py-3">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-2">
                                <select id="log-filter-type" class="form-select form-select-sm" onchange="g_log_page=0; fetchAdminLogs();">
                                    <option value="all">모든 활동</option>
                                    <option value="VIEW">👁️ 조회 (VIEW)</option>
                                    <option value="EDIT">✏️ 수정 (EDIT)</option>
                                    <option value="DOWNLOAD">📥 다운로드 (DOWNLOAD)</option>
                                    <option value="LOGIN">🔑 로그인 (LOGIN)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" id="log-search-keyword" class="form-control form-control-sm" 
                                       placeholder="대상, 내용, 이메일 검색..." onkeyup="if(event.key=='Enter') { g_log_page=0; fetchAdminLogs(); }">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-dark w-100" onclick="g_log_page=0; fetchAdminLogs()">
                                    <i class="bi bi-search"></i> 검색
                                </button>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted" id="log-total-count">총 0건</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="table-responsive" style="min-height: 400px;">
                        <table class="table table-hover align-middle mb-0 text-center small">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 150px;">일시</th>
                                    <th style="width: 150px;">관리자(이메일)</th>
                                    <th style="width: 100px;">유형</th>
                                    <th style="width: 150px;">대상</th>
                                    <th>상세 내용</th>
                                    <th style="width: 120px;">IP / 정보</th>
                                </tr>
                            </thead>
                            <tbody id="logListBody">
                                <tr><td colspan="6" class="py-5 text-muted">데이터를 불러오는 중입니다...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="card-footer bg-white border-top-0 d-flex justify-content-center py-3">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" onclick="changeLogPage(-1)">
                                <i class="bi bi-chevron-left"></i> 이전
                            </button>
                            <button class="btn btn-sm btn-outline-secondary disabled fw-bold" id="log-page-num" style="width: 100px;">
                                Page 1
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="changeLogPage(1)">
                                다음 <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ★ Supabase 설정 (Anon Key 사용 - RPC 보안으로 안전함)
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k'; 
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 전역 변수
let g_members = [];
// 전역 변수
let g_plants = []; // [추가] 발전소 목록 기억용

let g_badges = []; // DB에서 불러온 뱃지 목록을 기억해둠
let g_fund_page = 0; // [추가] 무한 스크롤 페이지 번호
const PAGE_SIZE = 20; // [추가] 한 번에 불러올 개수
    
    // [신규] 보안 엑셀 다운로드용 2차 인증 PIN (관리자가 입력해야 함)
    const SECURE_PIN = "solar2025!"; 

// [신규] 차트 인스턴스 관리용 (중복 생성 방지)
let g_charts = {
    capital: null,
    location: null,
    age: null,
    exit: null
};



// ★ [공통] 파일 업로드 함수 (한글 깨짐 방지 & 난수 이름 생성)
async function uploadFileToStorage(file, folderName) {
if (!file) return null;

// 1. 파일명 난수화 (예: '로고.png' -> 'partners/173901_x9z1a.png')
const fileExt = file.name.split('.').pop();
const randomName = Math.random().toString(36).substring(2, 10);
const safeFileName = `${folderName}/${Date.now()}_${randomName}.${fileExt}`;

// 2. 스토리지 업로드
const { error: uploadError } = await _supabase.storage.from('assets').upload(safeFileName, file);
if (uploadError) throw uploadError; // 에러 발생 시 호출한 곳으로 던짐

// 3. 공개 URL 반환
const { data } = _supabase.storage.from('assets').getPublicUrl(safeFileName);
return data.publicUrl;
}

// ★ [공통] 기존 파일 삭제 함수
async function deleteOldFile(fullUrl) {
if (!fullUrl) return;
try {
const path = fullUrl.split('/assets/')[1]; 
if (path) await _supabase.storage.from('assets').remove([path]);
} catch (e) { console.error("파일 삭제 오류:", e); }
}


// [신규] 관리자 활동 로그 기록
async function logAdminAction(type, target, details) {
    // 1. 현재 접속자 확인
    const userEmail = document.getElementById('adminProfile') 
        ? document.getElementById('adminProfile').innerText 
        : 'unknown';

    // 2. 로그 테이블에 Insert
    // (에러가 나도 사용자 흐름을 막지 않기 위해 await 없이 실행하거나 catch 처리)
    _supabase.from('admin_logs').insert({
        admin_email: userEmail,
        action_type: type, // VIEW, EDIT, DOWNLOAD, LOGIN
        target: target,
        details: details,
        ip_address: 'client-side' // 클라이언트에서 IP 확인은 어려우므로 일단 마킹
    }).then(({ error }) => {
        if(error) console.warn("로그 기록 실패:", error);
    });
}
    

// [권한 체크] RPC 함수로 보안 검증 (무한 루프 방지됨)
// [수정] 관리자 권한 체크 함수 (에러 방지 적용)
// [수정] 관리자 권한 체크 (방어 로직 강화 버전)
async function checkAdmin(user) {
// 1. [방어 코드] 인자로 user가 안 넘어왔다면, 스스로 다시 조회한다.
if (!user) {
const { data: { user: currentUser } } = await _supabase.auth.getUser();
user = currentUser;
}

// 2. 그래도 user가 없으면 로그인 안 된 상태 -> 튕겨냄
if (!user) {
// alert("로그인 정보가 없습니다."); // 필요 시 주석 해제
location.href = 'index.html'; 
return;
}

// 3. 기존 로직 유지 (RPC 권한 체크)
showLoading(true);
const { data: role, error } = await _supabase.rpc('get_my_role');
showLoading(false);

if (error) {
console.error("권한 조회 중 에러:", error);
alert("권한 정보를 확인할 수 없습니다.");
return;
}

// 4. 권한 분기 처리
if (role === 'admin') {
// (1) 로그인 게이트 숨김 (Null 체크 추가로 안전성 확보)
const loginGate = document.getElementById('login-gate');
if (loginGate) loginGate.classList.add('hidden');

// (2) 메인 시스템 노출
const mainSystem = document.getElementById('main-system');
if (mainSystem) mainSystem.classList.remove('hidden');

// (3) 프로필 이메일 표시 (여기서 에러 났었음 -> 이제 안전함)
const profileEl = document.getElementById('adminProfile');
if (profileEl && user.email) {
profileEl.innerText = user.email;
}

// (4) 데이터 로드 시작
// 초기 탭이 명부라면 로드 안 함(검색 유도), 대시보드라면 로드
// (fetchMembers()를 무조건 호출하던 기존 로직을 존중하되, 
//  아까 변경한 탭 로직과 충돌나지 않게 탭 상태를 보고 결정하거나 일단 호출)
//  fetchMembers(); 

} else {
// 권한 없음 처리
alert(`⛔ 접근 거부: 관리자 권한이 없습니다. (계정: ${user.email})`);
await _supabase.auth.signOut();
location.href = 'index.html';
}
}

// [로그인] 매직링크 전송
async function sendLoginLink() {
const email = document.getElementById('adminEmail').value;
if(!email) return alert('이메일을 입력하세요.');
const btn = document.getElementById('btnLogin');
btn.innerText = "전송중..."; btn.disabled = true;

const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });

if(error) { 
alert(error.message); btn.innerText = "다시 시도"; btn.disabled = false;
} else { 
document.getElementById('loginMsg').innerText = "이메일함에서 로그인 링크를 클릭하세요!";
document.getElementById('loginMsg').style.display = 'block';
btn.classList.add('hidden');
}
}

// ================================================================
// [기능 1] 조합원 관리 (RPC 사용)
// ================================================================


// 회원 수정 모달 열기
function openMemberEdit(id) {
const m = g_members.find(x => x.id === id);
if(!m) return;
document.getElementById('edit-id').value = m.id;
document.getElementById('edit-name').value = m.name;
document.getElementById('edit-phone').value = m.phone;
document.getElementById('edit-status').value = m.status;
document.getElementById('edit-note').value = m.note || '';
new bootstrap.Modal(document.getElementById('memberEditModal')).show();
}

// 회원 정보 저장 (RPC 호출)
async function saveMember() {
const updates = {
p_id: document.getElementById('edit-id').value,
p_name: document.getElementById('edit-name').value,
p_phone: document.getElementById('edit-phone').value,
p_status: document.getElementById('edit-status').value,
p_note: document.getElementById('edit-note').value
};

showLoading(true);
const { error } = await _supabase.rpc('update_member_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
alert('저장되었습니다.');
bootstrap.Modal.getInstance(document.getElementById('memberEditModal')).hide();
fetchMembers();
}
}

// 엑셀 다운로드 (보안/일반)
function togglePwd(show) { document.getElementById('pwdArea').style.display = show ? 'block' : 'none'; }
function openExcelModal() { new bootstrap.Modal(document.getElementById('excelModal')).show(); }

// [수정] 엑셀 다운로드 (보안 모드 RPC 연동 및 로그 기록)
async function downloadExcel() {
    const type = document.querySelector('input[name="excelOption"]:checked').value;
    let dataToExport = [];
    let fileName = "조합원명부_일반.xlsx";

    // 1. 보안용 엑셀 다운로드
    if(type === 'secret') {
        const inputPin = document.getElementById('decryptKey').value;
        
        // PIN 번호 검증 (JS 레벨 2차 인증)
        if(inputPin !== SECURE_PIN) {
            return alert('비밀번호가 올바르지 않습니다.');
        }

        showLoading(true);

        // 보안 RPC 호출 (DB 내부에서 복호화 수행)
        const { data, error } = await _supabase.rpc('get_full_members_secure');
        
        showLoading(false);

        if(error) {
            console.error(error);
            return alert('보안 데이터 로드 실패: ' + error.message);
        }

        // 데이터 매핑 (복호화된 칼럼 사용)
        dataToExport = data.map(m => ({
            "조합원번호": m.member_id,
            "이름": m.name,
            "유형": m.member_type,
            "상태": m.status,
            "연락처": m.phone,
            "주소": m.address,
            "가입일": m.join_date,
            "주민/사업자번호(전체)": m.decrypted_rrn,    // 복호화된 값
            "은행명": m.bank_name,
            "예금주": m.account_holder,
            "계좌번호(전체)": m.decrypted_account      // 복호화된 값
        }));
        
        fileName = "조합원명부_보안(개인정보포함).xlsx";
        
        // 로그 기록
        logAdminAction('DOWNLOAD', '조합원명부', '보안용(주민/계좌 포함) 다운로드');

    } else {
        // 2. 일반용 엑셀 다운로드 (기존 g_members 활용)
        // 화면에 있는 데이터 그대로 사용 (마스킹된 상태)
        dataToExport = g_members.map(m => ({
            "조합원번호": m.member_id,
            "이름": m.name,
            "유형": m.member_type,
            "연락처": m.phone,
            "상태": m.status,
            "가입일": m.join_date,
            "출자금": m.total_capital,
            "주소": m.address
        }));
        
        // 로그 기록
        logAdminAction('DOWNLOAD', '조합원명부', '일반용 다운로드');
    }

    // 3. 엑셀 파일 생성 및 다운로드 (SheetJS)
    const ws = XLSX.utils.json_to_sheet(dataToExport);
    
    // 칼럼 너비 자동 조정 (약간의 편의성)
    const wscols = Object.keys(dataToExport[0] || {}).map(k => ({wch: 15}));
    ws['!cols'] = wscols;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "명부");
    XLSX.writeFile(wb, fileName);
    
    // 모달 닫기 및 초기화
    document.getElementById('decryptKey').value = '';
    bootstrap.Modal.getInstance(document.getElementById('excelModal')).hide();
}


// ================================================================
// [기능 2] 입금 매칭 (자바스크립트 엑셀 처리)
// ================================================================
function readExcel(input) {
const file = input.files[0];
if(!file) return;

const reader = new FileReader();
reader.onload = function(e) {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {type: 'array'});
const sheet = workbook.Sheets[workbook.SheetNames[0]];
const json = XLSX.utils.sheet_to_json(sheet);

const tbody = document.getElementById('depositResultBody');
tbody.innerHTML = '';

if(json.length === 0) { tbody.innerHTML='<tr><td colspan="3">데이터가 없습니다.</td></tr>'; return; }

json.forEach(row => {
// 엑셀 칼럼명 유연하게 찾기
const name = row['입금자'] || row['성명'] || row['보낸분'] || row['내용'];
const amt = row['입금액'] || row['금액'] || row['거래금액'];

if(name && amt) {
// 이름으로 매칭 시도
const match = g_members.find(m => m.name === name.trim());
let matchHtml = `<span class="text-danger">매칭 실패 (정보 없음)</span>`;

if(match) {
matchHtml = `<span class="text-success fw-bold">${match.name} (${match.member_id})</span>`;
}

tbody.innerHTML += `<tr>
                           <td>${name}</td>
                           <td>${Number(amt).toLocaleString()}원</td>
                           <td>${matchHtml}</td>
                       </tr>`;
}
});
};
reader.readAsArrayBuffer(file);
}


// ================================================================
// [기능 3] 공지사항 관리
// ================================================================
// [수정] 공지사항 목록 불러오기 (삭제 버튼 추가됨)
async function fetchNotices() {
    // 읽기는 public 정책이 있어서 바로 select 가능
    const { data } = await _supabase.from('coop_notices').select('*').order('created_at', {ascending:false});
    const tbody = document.getElementById('noticeListBody');
    tbody.innerHTML = '';

    if(!data || data.length===0) { 
        tbody.innerHTML='<tr><td colspan="6" class="text-center py-3">글이 없습니다.</td></tr>'; 
        return; 
    }

    data.forEach(n => {
        // 날짜 포맷팅 (YYYY-MM-DD)
        const dateStr = n.created_at ? n.created_at.split('T')[0] : '-';
        
        // 팝업 여부 표시
        const popupBadge = n.is_popup ? '<span class="badge bg-danger">POP</span>' : '-';

        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td>${n.category}</td>
                <td class="text-start fw-bold">${n.title}</td>
                <td>${popupBadge}</td>
                <td>${n.status}</td>
                <td>
                    <button class="btn btn-sm btn-light border" onclick="openNoticeModal('${n.id}')">수정</button>
                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteNotice('${n.id}')">삭제</button>
                </td>
            </tr>`;
    });
}

    // [신규] 공지사항 삭제 요청 함수
function askDeleteNotice(id) {
    if (!id) return;

    myConfirm("정말 이 공지사항을 삭제하시겠습니까?<br><small class='text-danger'>복구할 수 없습니다.</small>", async () => {
        showLoading(true);

        // 방금 만든 RPC 호출
        const { error } = await _supabase.rpc('delete_notice_secure', { p_id: Number(id) });
        
        showLoading(false);

        if (error) {
            console.error("삭제 실패:", error);
            myAlert("삭제 실패: " + error.message, 'error');
        } else {
            myAlert("삭제되었습니다.");
            // 목록 새로고침
            fetchNotices();
        }
    });
}

let g_current_notice_id = null;
// 공지 모달 열기 (내용 불러오기 추가)
async function openNoticeModal(id) {
g_current_notice_id = id || null;
document.getElementById('notice-id').value = id || '';

if(id) {
const { data } = await _supabase.from('coop_notices').select('*').eq('id', id).single();
if(data) {
document.getElementById('notice-title').value = data.title;
document.getElementById('notice-content').value = data.content || ''; // 내용 불러오기
document.getElementById('notice-category').value = data.category;
document.getElementById('notice-status').value = data.status;
document.getElementById('notice-popup').checked = data.is_popup;
}
} else {
document.getElementById('notice-title').value = '';
document.getElementById('notice-content').value = ''; // 초기화
document.getElementById('notice-popup').checked = false;
}
new bootstrap.Modal(document.getElementById('noticeModal')).show();
}

// 공지 저장 (내용 포함해서 전송)
async function saveNotice() {
const updates = {
p_id: document.getElementById('notice-id').value || null,
p_title: document.getElementById('notice-title').value,
p_content: document.getElementById('notice-content').value, // 내용 추가
p_category: document.getElementById('notice-category').value,
p_status: document.getElementById('notice-status').value,
p_is_popup: document.getElementById('notice-popup').checked
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_notice_secure', updates);
showLoading(false);

if(error) alert('저장 에러: ' + error.message);
else {
alert('저장되었습니다.');
bootstrap.Modal.getInstance(document.getElementById('noticeModal')).hide();
fetchNotices();
}
}


// ================================================================
// [기능 4] 홈페이지 컨텐츠 (발전소, 연혁)
// ================================================================

// --- 발전소 ---
// [수정] 발전소 목록 불러오기 (삭제 버튼 추가 + 전역변수 저장)
async function fetchPlants() {
const { data } = await _supabase.from('site_power_plants').select('*').order('display_order');
const tbody = document.getElementById('plantListBody');
tbody.innerHTML = '';

if(!data) {
g_plants = []; // 데이터 없으면 빈 배열
return;
}

g_plants = data; // ★ 핵심: 목록을 전역 변수에 저장 (나중에 순서 계산할 때 씀)

data.forEach(p => {
tbody.innerHTML += `<tr>
                   <td>${p.display_order}</td>
                   <td>${p.name}</td>
                   <td>${p.capacity}kW</td>
                   <td>${p.status}</td>
                   <td><a href="${p.monitor_url||'#'}" target="_blank" class="text-truncate" style="max-width:100px; display:inline-block;">${p.monitor_url||'-'}</a></td>
                   <td>
                       <button class="btn btn-sm btn-light" onclick="openPlantModal('${p.id}')">수정</button>
                       <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeletePlant('${p.id}')">삭제</button>
                   </td>
               </tr>`;
});
}
// [수정] 발전소 모달 열기 (순서 자동 계산)
// [수정 2] 발전소 모달 열기 (순서 자동 계산 + 빈칸 0 처리)

// [수정] 발전소 저장 (빈칸 -> 0 자동 변환 안전장치 추가)


// --- 연혁 ---
// 연혁 목록 불러오기 (삭제 버튼 추가됨)
async function fetchHistory() {
const { data } = await _supabase.from('site_documents').select('*').eq('category','history').order('event_date', {ascending:false});
const tbody = document.getElementById('historyListBody');
tbody.innerHTML = '';
if(!data) return;
data.forEach(h => {
tbody.innerHTML += `<tr>
                   <td>${h.event_date}</td>
                   <td>${h.title}</td>
                   <td>${h.content || ''}</td>
                   <td>
                       <button class="btn btn-sm btn-light" onclick="openSiteHistoryModal('${h.id}')">수정</button>
                       <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteHistory('${h.id}')">삭제</button>
                   </td>
               </tr>`;
});
}
// [수정] 상세 내역 모달 열기 (기부금에서 '구분' 칼럼 제거됨)
function openHistoryModal(type) {
    const titleEl = document.getElementById('historyModalTitle');
    const summaryEl = document.getElementById('historyModalSummary');
    const listEl = document.getElementById('historyModalList');
    
    let title = '';
    let total = 0;
    let html = '<table class="table table-sm table-striped small"><thead>';
    
    // 데이터 소스 선택
    if(type === 'ledger') {
        title = '출자금 납입 내역';
        html += '<tr class="table-success"><th>날짜</th><th class="text-end">금액</th></tr></thead><tbody>';
        const data = globalHistoryData.ledger || [];
        total = data.reduce((a,c)=>a+Number(c.amount),0);
        
        if(data.length === 0) html += '<tr><td colspan="2" class="text-center py-3">내역 없음</td></tr>';
        else {
            data.forEach(item => {
                html += `<tr>
                    <td>${item.deposit_date ? item.deposit_date.substring(0,10) : '-'}</td>
                    <td class="text-end fw-bold">${Number(item.amount).toLocaleString()}원</td>
                </tr>`;
            });
        }
        summaryEl.innerText = `총 납입액: ${Number(total).toLocaleString()}원`;

    } else if(type === 'donation') {
        // [수정됨] 구분 칼럼 제거 -> 날짜, 금액만 표시
        title = '기부금 납부 내역';
        html += '<tr class="table-danger"><th>날짜</th><th class="text-end">금액</th></tr></thead><tbody>';
        const data = globalHistoryData.donations || [];
        total = data.reduce((a,c)=>a+Number(c.amount),0);

        if(data.length === 0) html += '<tr><td colspan="2" class="text-center py-3">내역 없음</td></tr>'; // colspan 3->2로 변경
        else {
            data.forEach(item => {
                html += `<tr>
                    <td>${item.donation_date}</td>
                    <td class="text-end fw-bold">${Number(item.amount).toLocaleString()}원</td>
                </tr>`;
            });
        }
        summaryEl.innerText = `총 기부액: ${Number(total).toLocaleString()}원`;

    } else if(type === 'point') {
        title = '포인트 적립/사용 내역';
        html += '<tr class="table-warning"><th>날짜</th><th>내용</th><th class="text-end">변동</th></tr></thead><tbody>';
        const data = globalHistoryData.points || [];
        total = data.reduce((a,c)=>a+Number(c.change_amount),0);

        if(data.length === 0) html += '<tr><td colspan="3" class="text-center py-3">내역 없음</td></tr>';
        else {
            data.forEach(item => {
                const isPlus = item.change_amount > 0;
                const style = isPlus ? 'text-primary' : 'text-danger';
                const sign = isPlus ? '+' : '';
                html += `<tr>
                    <td>${item.created_at ? item.created_at.substring(0,10) : '-'}</td>
                    <td>${item.reason || item.transaction_type}</td>
                    <td class="text-end fw-bold ${style}">${sign}${Number(item.change_amount).toLocaleString()}</td>
                </tr>`;
            });
        }
        summaryEl.innerText = `현재 잔액: ${Number(total).toLocaleString()} P`;

    } else if(type === 'dividend') {
        title = '배당금 지급 내역';
        html += '<tr class="table-primary"><th>연도</th><th>지급일</th><th class="text-end">금액(세전)</th></tr></thead><tbody>';
        const data = globalHistoryData.dividends || [];
        total = data.reduce((a,c)=>a+Number(c.total_amount),0);

        if(data.length === 0) html += '<tr><td colspan="3" class="text-center py-3">내역 없음</td></tr>';
        else {
            data.forEach(item => {
                html += `<tr>
                    <td>${item.fiscal_year}년</td>
                    <td>${item.paid_at ? item.paid_at.substring(0,10) : '-'}</td>
                    <td class="text-end fw-bold">${Number(item.total_amount).toLocaleString()}원</td>
                </tr>`;
            });
        }
        summaryEl.innerText = `누적 지급액: ${Number(total).toLocaleString()}원`;
    }

    html += '</tbody></table>';
    
    titleEl.innerText = title;
    listEl.innerHTML = html;
    
    // 모달 표시
    setModalDepth(true);
    document.getElementById('historyModalOverlay').style.display = 'flex';
}


// [수정] 사이트 연혁 모달 열기 (이름 변경: openSiteHistoryModal)
async function openSiteHistoryModal(id) {
    document.getElementById('hist-id').value = id || '';

    if (id) {
        const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
        if (data) {
            document.getElementById('hist-date').value = data.event_date;
            document.getElementById('hist-title').value = data.title;

            // ★ [핵심] DB의 HTML 태그를 사람이 보기 편한 텍스트로 복원
            let rawText = data.content || '';
            rawText = rawText.replaceAll('<br>', '\n');      // 줄바꿈 복원
            rawText = rawText.replaceAll('<ul>', '');        // 리스트 태그 제거
            rawText = rawText.replaceAll('</ul>', '');
            rawText = rawText.replaceAll('<ul class="my-1">', '');
            rawText = rawText.replace(/<li>/g, '- ');        // <li>를 '- '로 변환
            rawText = rawText.replace(/<\/li>/g, '\n');      // </li>를 줄바꿈으로
            rawText = rawText.replace(/\n\s*\n/g, '\n');     // 중복 줄바꿈 제거

            document.getElementById('hist-content').value = rawText.trim();
        }
    } else {
        // 신규 등록 시 초기화
        document.getElementById('hist-title').value = '';
        document.getElementById('hist-content').value = '';
        // 날짜는 오늘 날짜로 기본 세팅
        document.getElementById('hist-date').value = new Date().toISOString().substring(0, 10);
    }
    
    // HTML 모달 ID는 기존 그대로 'historyModal' 사용
    new bootstrap.Modal(document.getElementById('historyModal')).show();
}

// [수정] 사이트 연혁 저장 (이름 변경: saveSiteHistory)
async function saveSiteHistory() {
    const updates = {
        p_id: document.getElementById('hist-id').value || null,
        p_date: document.getElementById('hist-date').value,
        p_title: document.getElementById('hist-title').value,
        p_content: document.getElementById('hist-content').value 
    };

    showLoading(true);
    const { error } = await _supabase.rpc('upsert_history_secure', updates);
    showLoading(false);

    if (error) alert('저장 실패: ' + error.message);
    else {
        bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
        fetchHistory(); // 목록 새로고침
    }
}


// 유틸리티
function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
function logout() { _supabase.auth.signOut().then(() => location.href='index.html'); }
// [수정] 탭 전환 함수 (대시보드 로직 추가)

// ================================================================
// [기능 5] 섹션(메뉴) 관리 (ON/OFF)
// ================================================================

// 1. 섹션 목록 불러오기
async function fetchSections() {
// DB에서 순서대로 가져옴
const { data, error } = await _supabase
.from('site_sections')
.select('*')
.order('display_order');

if (error) {
console.error("섹션 로딩 에러:", error);
return;
}

const tbody = document.getElementById('sectionListBody');
tbody.innerHTML = '';

if (!data || data.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">섹션 정보가 없습니다.</td></tr>';
return;
}

data.forEach(sec => {
// 스위치가 켜져야 하는지 꺼져야 하는지 확인
const checkedAttr = sec.is_visible ? 'checked' : '';

// 상태 배지 (초록색/회색)
const statusBadge = sec.is_visible 
? '<span class="badge bg-success">공개중</span>' 
: '<span class="badge bg-secondary">숨김</span>';

// 테이블 행 추가
tbody.innerHTML += `
                   <tr>
                       <td class="align-middle text-center">${sec.display_order}</td>
                       <td class="align-middle text-start ps-4">
                           <span class="fw-bold text-dark">${sec.name}</span> <br>
                           <small class="text-muted" style="font-size:0.85em;">ID: ${sec.id}</small>
                       </td>
                       <td class="align-middle text-center">${statusBadge}</td>
                       <td class="align-middle text-center">
                           <div class="form-check form-switch d-inline-block">
                               <input class="form-check-input" type="checkbox" role="switch" 
                                   style="width: 45px; height: 24px; cursor: pointer;"
                                   ${checkedAttr} 
                                   onchange="toggleSection('${sec.id}', this.checked)">
                           </div>
                       </td>
                   </tr>
               `;
});
}

// 2. 스위치 변경 시 DB 즉시 저장
// 2. 스위치 변경 (수정됨: RPC 사용으로 권한 문제 해결)
async function toggleSection(id, isVisible) {
const { error } = await _supabase.rpc('update_section_visible', { 
p_id: id, 
p_visible: isVisible 
});

if(error) {
alert('변경 실패: ' + error.message);
fetchSections(); 
} else {
fetchSections();
}
}
// 연혁 삭제 함수

// [수정 1] 삭제 요청 (모달 띄우기)
// 연혁 삭제 요청
function askDeleteHistory(id) {
deleteType = 'history';
document.getElementById('delete-target-id').value = id;
// 버튼에 이벤트 연결
document.getElementById('btn-real-delete').onclick = confirmDelete;
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}

// [수정 2] 실제 삭제 실행 (모달에서 '삭제하기' 클릭 시)
async function confirmDeleteHistory() {
// 1. 저장해둔 ID 꺼내기
const id = document.getElementById('delete-target-id').value;
if (!id) return;

// 2. 모달 닫기
const modalEl = document.getElementById('deleteConfirmModal');
const modalInstance = bootstrap.Modal.getInstance(modalEl);
modalInstance.hide();

showLoading(true);
const { error } = await _supabase.rpc('delete_document_secure', { p_id: id });
showLoading(false);

if (error) {
// 에러도 모달로 띄워주면 좋지만, 일단 간단한 경고는 유지하거나 토스트로 대체 가능
// 요청하신대로 alert 대신 커스텀 알림을 원하시면 별도 모달이 필요합니다.
// 일단은 에러 상황은 드물기 때문에 콘솔에 찍고 넘어갑니다.
console.error('삭제 실패:', error.message);
} else {
fetchHistory(); // 목록 갱신
}
}
// ================================================================
// [기능 6] About(소개) 관리
// ================================================================
async function fetchAboutSettings() {
const { data, error } = await _supabase.from('site_about').select('*').single();
if(error && error.code !== 'PGRST116') { // 데이터 없음 에러는 무시
console.error(error); return;
}
if(data) {
document.getElementById('admin-about-title').value = data.title || '';
document.getElementById('admin-about-subtitle').value = data.subtitle || '';
document.getElementById('admin-about-content').value = data.content || '';
document.getElementById('admin-about-list').value = data.list_items || '';
document.getElementById('admin-about-img').value = data.image_url || '';
}
}




// [보조 함수] 전체 미리보기 업데이트 (탭 누를 때 실행됨)
// [수정] 전체 미리보기 (입력 안 한 건 안 보이게 처리)
// [수정] 전체 미리보기 (점 제거 반영)
function updateTotalPreview() {
const title = document.getElementById('admin-about-title').value;
const subtitle = document.getElementById('admin-about-subtitle').value;
const content = document.getElementById('admin-about-content').value;
const listText = document.getElementById('admin-about-list').value;
const imgUrl = document.getElementById('admin-about-img').value;

document.getElementById('prev-title').innerHTML = title;
document.getElementById('prev-subtitle').innerHTML = subtitle;
document.getElementById('prev-content').innerHTML = content;

const listEl = document.getElementById('prev-list');
// ★ 핵심: 미리보기 박스에도 'list-unstyled' 적용 (점 제거)
listEl.className = "list-unstyled mb-3"; 

if (!listText.trim()) {
listEl.innerHTML = '';
listEl.style.display = 'none';
} else {
listEl.style.display = 'block';
if (listText.includes('<li')) {
listEl.innerHTML = listText;
} else {
let html = '';
listText.split('\n').forEach(item => {
// 아이콘 없이 깔끔하게
if(item.trim()) html += `<li class="mb-1">${item.trim()}</li>`;
});
listEl.innerHTML = html;
}
}

const imgEl = document.getElementById('prev-img');
if(imgUrl) { imgEl.src = imgUrl; imgEl.style.display = 'block'; } 
else { imgEl.style.display = 'none'; }
}

// [수정] 소개글 저장하기 (모달 적용)
async function saveAboutSettings() {
const updates = {
p_title: document.getElementById('admin-about-title').value,
p_subtitle: document.getElementById('admin-about-subtitle').value,
p_content: document.getElementById('admin-about-content').value,
p_list_items: document.getElementById('admin-about-list').value,
p_image_url: document.getElementById('admin-about-img').value
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_about_secure', updates);
showLoading(false);

if(error) {
// 에러도 모달로 띄우면 좋겠죠? (내용 바꿔서 재활용)
document.getElementById('commonAlertText').innerText = '저장 실패: ' + error.message;
new bootstrap.Modal(document.getElementById('commonAlertModal')).show();
} else {
// 성공 모달 띄우기
document.getElementById('commonAlertText').innerText = '성공적으로 저장되었습니다!';
new bootstrap.Modal(document.getElementById('commonAlertModal')).show();

fetchAboutSettings(); // 저장 후 다시 불러오기
}
}
// [보조 함수] 상태에 따라 슬라이더 숨기기/보이기
function toggleProgressSlider() {
const status = document.getElementById('plant-status').value;
const area = document.getElementById('plant-progress-area');

if (status === '운영중') {
area.style.display = 'none'; // 운영중이면 100%니까 숨김
} else {
area.style.display = 'block'; // 공사/준비중이면 보임
}
}

// [수정] 발전소 모달 열기 (진행률 불러오기 추가)


// [수정] 발전소 저장 (진행률 포함 전송)

// [추가] 발전소 삭제 요청
function askDeletePlant(id) {
deleteType = 'plant';
document.getElementById('delete-target-id').value = id;
// 버튼에 이벤트 연결
document.getElementById('btn-real-delete').onclick = confirmDelete;
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}


// [수정] 통합 삭제 실행 함수 (중복 선언 해결 & 뱃지 삭제 추가)
// [수정] 통합 삭제 실행 함수 (중복 선언 해결 & 뱃지 삭제 추가)

// [신규] 슬라이더 움직일 때 단계 이름 표시
function updateProgressLabel(val) {
const v = Number(val);
let step = '';
if (v < 20) step = '조합설립 단계';
else if (v < 40) step = '부지선정 단계';
else if (v < 60) step = '인허가 단계';
else if (v < 80) step = '착공/공사 단계';
else step = '완공/운영 단계';

document.getElementById('plant-progress-label').innerText = `${v}% (${step})`;
}

// [신규] 글씨 클릭하면 슬라이더 이동
function setProg(val) {
document.getElementById('plant-progress').value = val;
updateProgressLabel(val);
}



// [신규] 스토리지에서 실제 파일 삭제하는 함수


// [신규] 사진 삭제 버튼 클릭 시 (화면에서만 먼저 지움)
function clearPlantImage() {
document.getElementById('plant-file').value = ''; // 파일 선택 취소
document.getElementById('plant-img-url').value = ''; // 저장될 URL 비움

// 프리뷰 감추기
document.getElementById('plant-img-preview').style.display = 'none';
document.getElementById('plant-img-preview').src = '';
document.getElementById('plant-img-placeholder').style.display = 'block';
}

// [기존 수정] 이미지 미리보기
function previewImage(input) {
const file = input.files[0];
const preview = document.getElementById('plant-img-preview');
const placeholder = document.getElementById('plant-img-placeholder');

if(file) {
const reader = new FileReader();
reader.onload = function(e) {
preview.src = e.target.result;
preview.style.display = 'block';
placeholder.style.display = 'none';
}
reader.readAsDataURL(file);
}
}

// [기존 수정] 발전소 모달 열기 (기존 이미지 URL 기억하기)
async function openPlantModal(id) {
document.getElementById('plant-id').value = id || '';
document.getElementById('plant-file').value = ''; 

if(id) {
// 수정 모드
const { data } = await _supabase.from('site_power_plants').select('*').eq('id', id).single();
if(data) {
document.getElementById('plant-name').value = data.name;
document.getElementById('plant-capacity').value = data.capacity;
document.getElementById('plant-order').value = data.display_order;
document.getElementById('plant-location').value = data.location || '';
document.getElementById('plant-area').value = data.area || '';
document.getElementById('plant-date').value = data.completion_date || '';
document.getElementById('plant-status').value = data.status;
document.getElementById('plant-url').value = data.monitor_url || '';

const rate = data.progress_rate || 0;
document.getElementById('plant-progress').value = rate;
updateProgressLabel(rate);

// ★ 이미지 처리 (원본 기억 + 현재 상태 설정)
const imgUrl = data.image_url || '';
document.getElementById('plant-img-original').value = imgUrl; // [중요] 원본 기억 (나중에 삭제할 때 씀)
document.getElementById('plant-img-url').value = imgUrl;      // 현재 상태

const preview = document.getElementById('plant-img-preview');
const placeholder = document.getElementById('plant-img-placeholder');
if(imgUrl) {
preview.src = imgUrl;
preview.style.display = 'block';
placeholder.style.display = 'none';
} else {
preview.style.display = 'none';
placeholder.style.display = 'block';
}
}
} else {
// 신규 모드
const maxOrder = g_plants.length > 0 ? Math.max(...g_plants.map(p => p.display_order)) : 0;
['plant-name','plant-capacity','plant-url','plant-location','plant-area','plant-date','plant-img-url','plant-img-original'].forEach(id => document.getElementById(id).value = '');

document.getElementById('plant-order').value = maxOrder + 1; 
document.getElementById('plant-status').value = '준비중';
document.getElementById('plant-progress').value = 0;
updateProgressLabel(0);

document.getElementById('plant-img-preview').style.display = 'none';
document.getElementById('plant-img-placeholder').style.display = 'block';
}
toggleProgressSlider();
new bootstrap.Modal(document.getElementById('plantModal')).show();
}

// [기존 수정] 발전소 저장 (자동 삭제 로직 포함)
async function savePlant() {
const name = document.getElementById('plant-name').value;
if (!name) { alert("발전소명을 입력해주세요."); return; }

showLoading(true);

const fileInput = document.getElementById('plant-file');
const originalUrl = document.getElementById('plant-img-original').value; // 원래 있던 사진
let finalImgUrl = document.getElementById('plant-img-url').value;      // 최종 저장될 사진 주소

// 1. 새 파일이 업로드된 경우
if (fileInput.files.length > 0) {
const file = fileInput.files[0];
const fileName = `plants/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;

// (1) 새 파일 업로드
const { data: uploadData, error: uploadError } = await _supabase.storage.from('assets').upload(fileName, file);
if (uploadError) {
showLoading(false);
alert('사진 업로드 실패: ' + uploadError.message);
return;
}
const { data: publicUrlData } = _supabase.storage.from('assets').getPublicUrl(fileName);
finalImgUrl = publicUrlData.publicUrl;

// (2) ★ 중요: 옛날 사진이 있었다면 삭제! (쓰레기 파일 정리)
if (originalUrl) {
await deleteOldFile(originalUrl);
}
} 
// 2. 파일은 안 올렸는데, [삭제 버튼]을 눌러서 URL이 비어버린 경우
else if (originalUrl && !finalImgUrl) {
// ★ 중요: 원래 사진을 삭제함
await deleteOldFile(originalUrl);
}

// 3. DB 저장 (나머지는 기존과 동일)
const capVal = document.getElementById('plant-capacity').value;
const orderVal = document.getElementById('plant-order').value;

const capacity = (capVal === '' || isNaN(capVal)) ? 0 : Number(capVal);
const order = (orderVal === '' || isNaN(orderVal)) ? 0 : Number(orderVal);
const status = document.getElementById('plant-status').value;
const progress = (status === '운영중') ? 100 : Number(document.getElementById('plant-progress').value);

const updates = {
p_id: document.getElementById('plant-id').value || null,
p_name: name,
p_capacity: capacity,
p_status: status,
p_display_order: order,
p_progress: progress,
p_location: document.getElementById('plant-location').value,
p_area: document.getElementById('plant-area').value,
p_completion_date: document.getElementById('plant-date').value || null,
p_image_url: finalImgUrl
};

const { error } = await _supabase.rpc('upsert_plant_secure', updates);
showLoading(false);

if(error) {
if(document.getElementById('commonAlertModal')) {
document.getElementById('commonAlertText').innerText = '저장 실패: ' + error.message;
new bootstrap.Modal(document.getElementById('commonAlertModal')).show();
} else alert('저장 실패: ' + error.message);
} else { 
bootstrap.Modal.getInstance(document.getElementById('plantModal')).hide(); 
fetchPlants(); 
}
}
// ================================================================
// [기능 8] 문서 관리 (정관/규약)
// ================================================================

// 1. 문서 목록 불러오기
async function fetchDocs() {
// category가 'doc'인 것만 가져옴
const { data } = await _supabase.from('site_documents').select('*').eq('category', 'doc').order('event_date', {ascending:false});
const tbody = document.getElementById('docListBody');
tbody.innerHTML = '';

if(!data || data.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-muted">등록된 문서가 없습니다.</td></tr>';
return;
}

data.forEach(d => {
const fileBtn = d.file_url 
? `<a href="${d.file_url}" target="_blank" class="btn btn-xs btn-outline-success"><i class="bi bi-file-pdf"></i> 보기</a>` 
: '<span class="text-muted text-xs">없음</span>';

tbody.innerHTML += `<tr>
                   <td><div class="fw-bold">${d.version || '-'}</div><small class="text-muted">${d.event_date}</small></td>
                   <td>${d.title}</td>
                   <td class="text-start small text-truncate" style="max-width:200px;">${d.content || '-'}</td>
                   <td>${fileBtn}</td>
                   <td>
                       <button class="btn btn-sm btn-light" onclick="openDocModal('${d.id}')">수정</button>
                       <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteDoc('${d.id}')">삭제</button>
                   </td>
               </tr>`;
});
}

// 2. 모달 열기
// [수정] 문서 모달 열기


// [수정] 문서 저장 (is_current 포함)

// [수정] 문서 모달 열기 (파일 관련 제거)
async function openDocModal(id) {
document.getElementById('doc-id').value = id || '';

if(id) {
const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
if(data) {
document.getElementById('doc-title').value = data.title;
document.getElementById('doc-version').value = data.version || '';
document.getElementById('doc-date').value = data.event_date;
document.getElementById('doc-content').value = data.content || '';
document.getElementById('doc-current').checked = data.is_current;
}
} else {
// 신규
document.getElementById('doc-title').value = '정관';
document.getElementById('doc-version').value = '';
document.getElementById('doc-date').value = new Date().toISOString().substring(0, 10);
document.getElementById('doc-content').value = '';
document.getElementById('doc-current').checked = true;
}
new bootstrap.Modal(document.getElementById('docModal')).show();
}

// [수정] 문서 저장 (파일 로직 삭제)
async function saveDoc() {
const title = document.getElementById('doc-title').value;
if(!title) return alert("제목을 입력하세요.");

showLoading(true);

// 파일 업로드 로직 삭제됨 (순수 텍스트만 저장)

const updates = {
p_id: document.getElementById('doc-id').value || null,
p_category: 'doc', 
p_title: title,
p_date: document.getElementById('doc-date').value,
p_content: document.getElementById('doc-content').value,
p_version: document.getElementById('doc-version').value,
p_file_url: null, // 파일 없음
p_is_current: document.getElementById('doc-current').checked
};

const { error } = await _supabase.rpc('upsert_document_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('docModal')).hide();
fetchDocs();
}
}

// 삭제 (기존 삭제 함수 재활용)
function askDeleteDoc(id) {
deleteType = 'history'; // 문서는 기술적으로 history와 같은 테이블(site_documents)을 씀
document.getElementById('delete-target-id').value = id;
document.getElementById('btn-real-delete').onclick = confirmDelete; 
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}
// [수정] 파트너 목록 불러오기 (badges.js 활용)
async function fetchPartners() {
    const { data: list, error } = await _supabase.from('site_partners').select('*').order('display_order');
    if(error) { console.error(error); return; }

    // 1. 뱃지 데이터 로드 (Badges 모듈 사용)
    if (!g_badges || g_badges.length === 0) {
        g_badges = await Badges.getAll(_supabase);
    }

    const pendingBody = document.getElementById('partnerPendingBody');
    const activeBody = document.getElementById('partnerActiveBody');
    pendingBody.innerHTML = ''; activeBody.innerHTML = '';

    // 상태별 분리
    const pendingList = list.filter(p => p.status === 'pending');
    const activeList = list.filter(p => p.status !== 'pending');

    // (A) 대기 목록
    if(pendingList.length === 0) pendingBody.innerHTML = '<tr><td class="text-center text-muted py-3 small">승인 대기 중인 신청이 없습니다.</td></tr>';
    else {
        pendingList.forEach(p => {
            pendingBody.innerHTML += `
                <tr class="bg-warning bg-opacity-10">
                    <td class="align-middle fw-bold ps-3">${p.name}</td>
                    <td class="align-middle small text-muted">${p.description || '-'}</td>
                    <td class="align-middle text-end pe-3">
                        <button class="btn btn-sm btn-primary" onclick="openPartnerModal('${p.id}')">승인</button>
                    </td>
                </tr>`;
        });
    }

    // (B) 등록 목록
    if(activeList.length === 0) activeBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">등록된 파트너가 없습니다.</td></tr>';
    else {
        activeList.forEach(p => {
            let badgesHtml = '';
            // ★ [핵심 변경] badges.js의 renderPill 사용
            if(p.badges && p.badges.length > 0) {
                p.badges.forEach(bCode => {
                    const b = g_badges.find(item => item.code === bCode);
                    badgesHtml += Badges.renderPill(b); 
                });
            }
            const logo = p.logo_url ? `<img src="${p.logo_url}" style="max-height:40px;">` : '-';

            activeBody.innerHTML += `
                <tr>
                    <td class="text-center">${p.display_order}</td>
                    <td class="text-center">${logo}</td>
                    <td><div class="fw-bold">${p.name}</div><div class="small text-muted text-truncate" style="max-width:200px;">${p.description||'-'}</div></td>
                    <td>${badgesHtml}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-light" onclick="openPartnerModal('${p.id}')">수정</button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeletePartner('${p.id}')">삭제</button>
                    </td>
                </tr>`;
        });
    }
}
// [수정] 파트너 모달 열기 (수정 요청 데이터 우선 로드)
async function openPartnerModal(id) {
    document.getElementById('pt-id').value = id || '';

    // 1. 뱃지 데이터 로드
    if (!g_badges || g_badges.length === 0) {
        g_badges = await Badges.getAll(_supabase);
    }

    // 2. 수정 모드
    if(id) { 
        const { data } = await _supabase.from('site_partners').select('*').eq('id', id).single();
        
        if(data) {
            // ★ [핵심 로직] 수정 대기중(pending)이고, 변경 내역(pending_changes)이 있으면 그것을 불러옴
            let displayData = data;
            let isModification = false;

            if (data.status === 'pending' && data.pending_changes) {
                // 원본 데이터 위에 변경 요청 데이터를 덮어씀
                displayData = { ...data, ...data.pending_changes };
                isModification = true;
            }

            // 폼 바인딩 (displayData 사용)
            document.getElementById('pt-name').value = displayData.name;
            document.getElementById('pt-member-id').value = displayData.member_id || '';
            document.getElementById('pt-desc').value = displayData.description || '';
            document.getElementById('pt-link').value = displayData.link_url || '';
            document.getElementById('pt-status').value = displayData.status || 'active';
            document.getElementById('pt-order').value = displayData.display_order || 99;

            // 알림 메시지 (수정 요청인 경우 표시)
            const header = document.querySelector('#partnerModal .modal-header h5');
            if(isModification) {
                header.innerHTML = `🤝 파트너 승인 <span class="badge bg-danger ms-2">수정 요청본</span>`;
                alert("⚠️ 사용자가 수정을 요청한 내용이 입력란에 표시됩니다.\n내용을 확인 후 '저장하기'를 누르면 승인(적용)됩니다.");
            } else {
                header.innerHTML = `🤝 협력 단체 관리`;
            }

            // 뱃지 체크박스
            Badges.renderCheckboxes('badge-checkboxes', g_badges, displayData.badges || []);
            
            // 이미지 프리뷰
            handleImagePreview('pt', displayData.logo_url);
        }
    } 
    // 3. 신규 모드
    else { 
        document.getElementById('pt-name').value = '';
        document.getElementById('pt-member-id').value = '';
        document.getElementById('pt-desc').value = '';
        document.getElementById('pt-link').value = '';
        document.getElementById('pt-status').value = 'active'; // 관리자가 직접 등록하니 active 기본
        document.getElementById('pt-order').value = 99;
        
        document.querySelector('#partnerModal .modal-header h5').innerText = '🤝 협력 단체 등록';
        Badges.renderCheckboxes('badge-checkboxes', g_badges, []);
        handleImagePreview('pt', null);
    }

    document.getElementById('pt-file').value = '';
    new bootstrap.Modal(document.getElementById('partnerModal')).show();
}
// 4. 파트너 저장
// [3] 저장 함수 (ID 처리 + 공통 파일 함수 사용)
async function savePartner() {
const name = document.getElementById('pt-name').value;
if(!name) return alert('단체명을 입력하세요.');

// ★ [핵심] 빈 문자열 ID를 NULL로 변환 (BigInt/UUID 에러 방지)
let idVal = document.getElementById('pt-id').value;
if (!idVal || idVal.trim() === '') idVal = null;

showLoading(true);

// 1. 파일 업로드 (공통 함수 사용으로 코드 대폭 단축)
const fileInput = document.getElementById('pt-file');
const originalUrl = document.getElementById('pt-img-original').value;
let finalImgUrl = document.getElementById('pt-img-url').value;

try {
if (fileInput.files.length > 0) {
// ★ 한글명 걱정 끝! 공통 함수 호출
finalImgUrl = await uploadFileToStorage(fileInput.files[0], 'partners');
if(originalUrl) await deleteOldFile(originalUrl); // 기존 파일 삭제
} else if (originalUrl && !finalImgUrl) {
await deleteOldFile(originalUrl); // 삭제 버튼 누른 경우
}
} catch (e) {
showLoading(false);
return alert('이미지 업로드 오류: ' + e.message);
}

// 2. 뱃지 데이터 수집
const selectedBadges = [];
document.querySelectorAll('#badge-checkboxes input:checked').forEach(cb => selectedBadges.push(cb.value));

// 3. DB 저장 (RPC 호출)
const updates = {
p_id: idVal, // NULL 또는 UUID
p_name: name,
p_link_url: document.getElementById('pt-link').value,
p_logo_url: finalImgUrl,
p_display_order: Number(document.getElementById('pt-order').value),
p_description: document.getElementById('pt-desc').value,
p_member_id: document.getElementById('pt-member-id').value,
p_status: document.getElementById('pt-status').value,
p_badges: selectedBadges
};

const { error } = await _supabase.rpc('upsert_partner_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('partnerModal')).hide();
fetchPartners();
}
}

// 5. 파트너 삭제
function askDeletePartner(id) {
deleteType = 'partner'; // confirmDelete 함수에서 처리하도록 분기 추가 필요
document.getElementById('delete-target-id').value = id;
document.getElementById('btn-real-delete').onclick = confirmDelete; 
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}
// [보조] 이미지 프리뷰 공통 처리 함수 (코드 중복 줄이기)
function handleImagePreview(prefix, url) {
document.getElementById(`${prefix}-img-original`).value = url || '';
document.getElementById(`${prefix}-img-url`).value = url || '';
const preview = document.getElementById(`${prefix}-img-preview`);
const placeholder = document.getElementById(`${prefix}-img-placeholder`);

if(url) {
preview.src = url; preview.style.display = 'block'; placeholder.style.display = 'none';
} else {
preview.src = ''; preview.style.display = 'none'; placeholder.style.display = 'block';
}
}
// [보조] 파일 선택 시 프리뷰 (HTML onchange에 연결됨)
function previewPartnerImage(input) {
if(input.files && input.files[0]) {
const reader = new FileReader();
reader.onload = function(e) {
document.getElementById('pt-img-preview').src = e.target.result;
document.getElementById('pt-img-preview').style.display = 'block';
document.getElementById('pt-img-placeholder').style.display = 'none';
};
reader.readAsDataURL(input.files[0]);
}
}

// [보조] 이미지 삭제 버튼
function clearPartnerImage() {
document.getElementById('pt-file').value = '';
document.getElementById('pt-img-url').value = '';
document.getElementById('pt-img-preview').style.display = 'none';
document.getElementById('pt-img-placeholder').style.display = 'block';
}
// 1. 뱃지 목록 불러오기
// [수정] 뱃지 목록 조회 (badges.js 활용)
async function fetchBadges() {
    // ★ [핵심 변경] DB 직접 조회 대신 모듈 사용 (캐싱 적용됨)
    g_badges = await Badges.getAll(_supabase);

    const tbody = document.getElementById('badgeListBody');
    if(!tbody) return; 
    
    tbody.innerHTML = '';
    g_badges.forEach(b => {
        // 색상 표시용 뱃지 (Pill 아님, 관리용)
        const colorBadge = `<span class="badge bg-${b.color} text-white">${b.color}</span>`;

        tbody.innerHTML += `
            <tr>
                <td>${b.display_order}</td>
                <td class="fs-4">${b.icon || ''}</td>
                <td class="text-start">
                    <div class="fw-bold">${b.name}</div>
                    <div class="small text-muted">${b.description || '-'}</div>
                </td>
                <td class="small font-monospace">${b.code}</td>
                <td>${colorBadge}</td>
                <td>
                    <button class="btn btn-sm btn-light" onclick="openBadgeModal('${b.id}')">수정</button>
                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteBadge('${b.id}')">삭제</button>
                </td>
            </tr>
        `;
    });
}

// 2. 뱃지 모달 열기
async function openBadgeModal(id) {
document.getElementById('bg-id').value = id || '';
if(id) {
const b = g_badges.find(x => x.id == id); // 전역변수에서 찾음 (DB호출 절약)
if(b) {
document.getElementById('bg-code').value = b.code;
document.getElementById('bg-icon').value = b.icon;
document.getElementById('bg-name').value = b.name;
document.getElementById('bg-desc').value = b.description;
document.getElementById('bg-color').value = b.color;
document.getElementById('bg-order').value = b.display_order;
}
} else {
document.getElementById('bg-code').value = '';
document.getElementById('bg-icon').value = '🏅';
document.getElementById('bg-name').value = '';
document.getElementById('bg-desc').value = '';
document.getElementById('bg-color').value = 'primary';
document.getElementById('bg-order').value = g_badges.length + 1;
}
new bootstrap.Modal(document.getElementById('badgeModal')).show();
}

// 3. 뱃지 저장
async function saveBadge() {
const updates = {
p_id: document.getElementById('bg-id').value || null,
p_code: document.getElementById('bg-code').value,
p_icon: document.getElementById('bg-icon').value,
p_name: document.getElementById('bg-name').value,
p_desc: document.getElementById('bg-desc').value,
p_color: document.getElementById('bg-color').value,
p_order: Number(document.getElementById('bg-order').value)
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_badge_secure', updates);
showLoading(false);

if(error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('badgeModal')).hide();
fetchBadges(); // 목록 갱신
}
}

// 4. 뱃지 삭제
function askDeleteBadge(id) {
deleteType = 'badge'; 
document.getElementById('delete-target-id').value = id;
document.getElementById('btn-real-delete').onclick = confirmDelete; 
new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}
// ================================================================
// [기능 10] FAQ 관리
// ================================================================

// 1. FAQ 목록 불러오기
async function fetchFaqs() {
const keyword = document.getElementById('search-faq').value;

// DB 조회 (순서대로)
let query = _supabase.from('site_faqs').select('*').order('display_order', { ascending: true });

// 검색어가 있으면 필터링
if (keyword) {
query = query.ilike('question', `%${keyword}%`);
}

const { data: list, error } = await query;
if (error) { console.error(error); return; }

const tbody = document.getElementById('faqListBody');
if (!tbody) return; // 탭이 없으면 패스
tbody.innerHTML = '';

if (!list || list.length === 0) {
tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">등록된 질문이 없습니다.</td></tr>';
return;
}

list.forEach(f => {
const badge = f.is_visible 
? '<span class="badge bg-success">공개</span>' 
: '<span class="badge bg-secondary">숨김</span>';

const answerPreview = f.answer && f.answer.length > 50 
? f.answer.substring(0, 50) + '...' 
: f.answer;

tbody.innerHTML += `
           <tr>
               <td class="text-center">${f.display_order}</td>
               <td class="text-center"><span class="badge bg-light text-dark border">${f.category}</span></td>
               <td>
                   <div class="fw-bold text-primary mb-1">Q. ${f.question}</div>
                   <div class="small text-muted text-truncate" style="max-width:400px;">A. ${answerPreview}</div>
               </td>
               <td class="text-center">${badge}</td>
               <td class="text-center">
                   <button class="btn btn-sm btn-light" onclick="openFaqModal('${f.id}')">수정</button>
                   <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteFaq('${f.id}')">삭제</button>
               </td>
           </tr>
       `;
});
}

// 2. 모달 열기 (등록/수정)
async function openFaqModal(id) {
document.getElementById('faq-id').value = id || '';

if (id) {
// 수정 모드
const { data } = await _supabase.from('site_faqs').select('*').eq('id', id).single();
if (data) {
document.getElementById('faq-category').value = data.category || '기타';
document.getElementById('faq-order').value = data.display_order;
document.getElementById('faq-visible').checked = data.is_visible;
document.getElementById('faq-question').value = data.question;
document.getElementById('faq-answer').value = data.answer;
}
} else {
// 신규 모드
document.getElementById('faq-category').value = '가입/탈퇴';
document.getElementById('faq-order').value = 0; // 맨 앞
document.getElementById('faq-visible').checked = true;
document.getElementById('faq-question').value = '';
document.getElementById('faq-answer').value = '';
}

new bootstrap.Modal(document.getElementById('faqModal')).show();
}

// 3. 저장 함수
async function saveFaq() {
const question = document.getElementById('faq-question').value;
const answer = document.getElementById('faq-answer').value;

if (!question || !answer) return alert('질문과 답변을 모두 입력해주세요.');

// ID 처리 (UUID 오류 방지)
let idVal = document.getElementById('faq-id').value;
if (!idVal || idVal.trim() === '') idVal = null;

const updates = {
p_id: idVal,
p_category: document.getElementById('faq-category').value,
p_display_order: Number(document.getElementById('faq-order').value),
p_is_visible: document.getElementById('faq-visible').checked,
p_question: question,
p_answer: answer
};

showLoading(true);
const { error } = await _supabase.rpc('upsert_faq_secure', updates);
showLoading(false);

if (error) alert('저장 실패: ' + error.message);
else {
bootstrap.Modal.getInstance(document.getElementById('faqModal')).hide();
fetchFaqs();
}
}

// 4. 삭제 요청
function askDeleteFaq(id) {
  deleteType = 'faq';
  document.getElementById('delete-target-id').value = id;
  document.getElementById('btn-real-delete').onclick = confirmDelete;
  new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}


// ================================================================
// [수정] 통합 삭제 함수에 FAQ 추가 (기존 confirmDelete 교체)
// ================================================================
async function confirmDelete() {
  const id = document.getElementById('delete-target-id').value;

  const modalEl = document.getElementById('deleteConfirmModal');
  const inst = bootstrap.Modal.getInstance(modalEl);
  if (inst) inst.hide();

  showLoading(true);

  let rpcName = '';
  if (deleteType === 'history') rpcName = 'delete_document_secure';
  else if (deleteType === 'plant') rpcName = 'delete_plant_secure';
  else if (deleteType === 'partner') rpcName = 'delete_partner_secure';
  else if (deleteType === 'badge') rpcName = 'delete_badge_secure';
  else if (deleteType === 'faq') rpcName = 'delete_faq_secure';

  // ★ 방어: 분기 누락 시 중단
  if (!rpcName) {
    showLoading(false);
    alert('삭제 타입이 정의되지 않았습니다. (deleteType 확인 필요)');
    return;
  }

  const { error } = await _supabase.rpc(rpcName, { p_id: id });
  showLoading(false);

  if (error) {
    alert('삭제 실패: ' + error.message);
    return;
  }

  // 목록 새로고침
  if (deleteType === 'history') fetchHistory();
  else if (deleteType === 'plant') fetchPlants();
  else if (deleteType === 'partner') fetchPartners();
  else if (deleteType === 'badge') fetchBadges();
  else if (deleteType === 'faq') fetchFaqs();
}

// ================================================================
// [기능 0] 대시보드 로드 및 유틸
// ================================================================


// 승인 대기 카드 클릭 시 조합원 탭으로 이동
function goToPendingMembers() {
  // 이 페이지는 Bootstrap Tab이 아니라 switchTab 기반
  switchTab('members');

  // 필터 적용 후 조회
  setTimeout(() => {
    const statusEl = document.getElementById('filter-status');
    if (statusEl) statusEl.value = '승인대기';
    fetchMembers();
  }, 80);
}


// 숫자 애니메이션 효과 함수
function animateNumber(id, target, isMoney = false) {
const el = document.getElementById(id);
if(!el) return;

const start = 0;
const duration = 1000; // 1초 동안 실행
const startTime = performance.now();

function update(currentTime) {
const elapsed = currentTime - startTime;
const progress = Math.min(elapsed / duration, 1);
const value = Math.floor(progress * (target - start) + start);

el.innerText = isMoney 
? value.toLocaleString() + '원' 
: value.toLocaleString() + (id.includes('capital') ? '' : (id.includes('consult')?'건':'명'));

if (progress < 1) requestAnimationFrame(update);
else el.innerText = isMoney 
? target.toLocaleString() + '원' 
: target.toLocaleString() + (id.includes('capital') ? '' : (id.includes('consult')?'건':'명'));
}
requestAnimationFrame(update);
}


// ================================================================
// [기능 1] 조합원 목록 조회 (검색/필터/정렬 완비)
// ================================================================



// 테이블 렌더링 함수
// [수정 1] 탭 전환 함수 (딜레이 없이 즉시 전환)
// [수정] 탭 전환 함수 (모든 탭 ID 매칭 보장)
// 기존 switchTab 함수를 찾아서 이 부분만 바꾸거나 함수 전체를 교체하세요.

// [수정] 탭 전환 함수 (전체 코드)
function switchTab(tabName) {
    // 1. 모든 탭 숨김 처리
    const panes = document.querySelectorAll('.main-content > .tab-pane');
    panes.forEach(el => {
        el.classList.remove('show', 'active');
        el.style.display = 'none';
    });

    // 2. 선택한 탭 보임 처리
    const target = document.getElementById('tab-' + tabName);
    if (target) {
        target.style.display = 'block';
        setTimeout(() => target.classList.add('show', 'active'), 10);
    }

    // 3. 사이드바 네비게이션 활성화 표시
    document.querySelectorAll('.sidebar-menu .nav-link').forEach(el => el.classList.remove('active'));
    const navBtn = document.getElementById('nav-' + tabName);
    if (navBtn) navBtn.classList.add('active');

    // 4. 탭별 데이터 로드 로직 (분기 처리)
    if (tabName === 'dashboard') {
        loadDashboard();
    } 
    else if (tabName === 'members') {
        // 회원 탭은 자동 조회 대신 '검색 유도 화면' 표시
        if(typeof renderEmptyState === 'function') renderEmptyState();
    } 
    else if (tabName === 'notices') {
        fetchNotices();
    } 
    else if (tabName === 'funds-manage') {
        // 자금 관리 탭: 날짜 기본값 세팅
        const startEl = document.getElementById('don-date-start');
        const endEl = document.getElementById('don-date-end');

        if (startEl && !startEl.value) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            startEl.value = `${yyyy}-01-01`; // 1월 1일
            endEl.value = `${yyyy}-${mm}-${dd}`; // 오늘
            
            fetchGlobalDonations();
        }
    }
    // ★ [신규 추가됨] 업무 신청 관리 탭 연결
    else if (tabName === 'applications') {
        if(typeof fetchApplications === 'function') fetchApplications();
    }
}
    // 'deposit'(입금매칭), 'site'(홈페이지관리) 등은 별도 초기 로드 함수 없이 UI만 전환됨

// [수정] 대시보드 데이터 로드 (통계 차트 연동)
async function loadDashboard() {
    console.log("대시보드 데이터 로딩 시작...");

    // 1. [기존] 총 조합원 수
    const { count: totalCount } = await _supabase
        .from('coop_members').select('*', { count: 'exact', head: true });

    // 2. [기존] 승인 대기 조합원 수
    const { count: pendingCount } = await _supabase
        .from('coop_members').select('*', { count: 'exact', head: true }).eq('status', '승인대기');

    // 3. [변경] 파트너 신청 대기 건수 조회 (consult_logs 대체)
    // site_partners 테이블에서 status가 'pending'인 것만 카운트
    const { count: pendingPartners } = await _supabase
        .from('site_partners')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'pending');

    let totalCapital = 0;
    const { data: capitalResult, error: capError } = await _supabase.rpc('get_total_capital_secure');
    if (!capError) totalCapital = capitalResult || 0;

    // 4. UI 업데이트
    setText('dashboard-total-count', (totalCount || 0) + '명');
    setText('dash-capital', totalCapital.toLocaleString() + '원');
    
    // [변경] 파트너 대기 건수 표시 (ID 변경됨: dash-consult -> dash-partner-pending)
    setText('dash-partner-pending', (pendingPartners || 0) + '건');

    const pendingEl = document.getElementById('dashboard-pending-count');
    if (pendingEl) {
        pendingEl.innerText = (pendingCount || 0) + '명';
        // 대기자가 있으면 빨간색 강조
        pendingEl.className = pendingCount > 0 ? "display-6 fw-bold mb-0 text-danger" : "display-6 fw-bold mb-0";
    }

    // 2. [신규] 통계 차트 데이터 로드
    const { data: stats, error: statError } = await _supabase.rpc('get_dashboard_stats');
    
    if (statError) {
        console.error("통계 로드 실패:", statError);
    } else if (stats) {
        // (1) 월별 출자금 차트 (Line Chart)
        renderChart('capital', 'chart-capital', 'line', {
            labels: (stats.monthly_capital || []).reverse().map(x => x.month), // 날짜 오름차순
            datasets: [{
                label: '월별 출자금 유입',
                data: (stats.monthly_capital || []).reverse().map(x => x.total),
                borderColor: '#198754', // Success Color
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true,
                tension: 0.3
            }]
        }, `📉 총 감자액(반환): ${Number(stats.capital_reduction || 0).toLocaleString()}원`);

        // (2) 지역 분포 차트 (Pie Chart)
        const locLabels = Object.keys(stats.location || {});
        const locData = Object.values(stats.location || {});
        renderChart('location', 'chart-location', 'doughnut', {
            labels: locLabels,
            datasets: [{
                data: locData,
                backgroundColor: ['#0d6efd', '#6610f2', '#fd7e14', '#adb5bd'] // Bootstrap Colors
            }]
        });

        // (3) 연령대 분포 (Bar Chart)
        // 정렬: 10대, 20대... 순서 보장
        const ageObj = stats.age_group || {};
        const ageLabels = Object.keys(ageObj).sort();
        const ageData = ageLabels.map(k => ageObj[k]);
        
        renderChart('age', 'chart-age', 'bar', {
            labels: ageLabels,
            datasets: [{
                label: '조합원 수',
                data: ageData,
                backgroundColor: '#ffc107' // Warning Color
            }]
        });

        // (4) 탈퇴 사유 (Horizontal Bar)
        const reasons = stats.exit_reasons || []; // [{reason: '...', count: 1}, ...]
        renderChart('exit', 'chart-exit', 'bar', {
            labels: reasons.map(r => r.reason || '기타'),
            datasets: [{
                label: '건수',
                data: reasons.map(r => r.count),
                backgroundColor: '#dc3545', // Danger Color
            }],
            indexAxis: 'y' // 가로 막대
        });
    }

    // 로그 기록
    logAdminAction('VIEW', '대시보드', '메인 화면 조회');
}

// [보조] 차트 렌더링 헬퍼 함수
function renderChart(key, canvasId, type, data, titleText = null) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    // 기존 차트가 있으면 삭제 (캔버스 재사용 문제 방지)
    if (g_charts[key]) {
        g_charts[key].destroy();
    }

    const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { 
                display: type !== 'bar' || data.indexAxis === 'y', // 막대그래프는 범례 숨김 (깔끔하게)
                position: 'bottom' 
            }
        }
    };

    // 제목이 있으면 추가 (예: 감자액 표시용)
    if (titleText) {
        options.plugins.title = {
            display: true,
            text: titleText,
            align: 'end',
            color: '#dc3545',
            font: { size: 12 }
        };
    }

    g_charts[key] = new Chart(ctx, {
        type: type,
        data: data,
        options: options
    });
}

// [보조] 텍스트 세팅 헬퍼
function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }


// [수정] 조합원 검색/목록 로드: DB 뷰(view_my_assets) 활용 최적화
async function fetchMembers() {
    // ✅ DOM 요소 단축 선택자
    const $ = (id) => document.getElementById(id);

    // 1. 검색 조건 수집
    const keyword =
        ($('search-keyword')?.value || $('memberSearchKeyword')?.value || '').trim();
    
    // 필터 값 수집 (없으면 기본값 처리)
    const statusEl = $('filter-status') || $('searchStatus');
    const typeEl = $('filter-type') || $('searchType');
    const sortEl = $('sort-order');

    const status = statusEl ? statusEl.value : 'all';
    const type = typeEl ? typeEl.value : 'all';
    const sort = sortEl ? sortEl.value : 'name'; // 정렬 기준 (기본 이름순)

    try {
        if (typeof showLoading === 'function') showLoading(true);

        // 2. coop_members 기본 조회 (필터링)
        let q = _supabase
            .from('coop_members')
            .select([
                'id',               // UUID (매칭용)
                'member_id',        // 텍스트 ID
                'name',
                'member_type',
                'phone',
                'status',
                'join_date',
                'created_at',
                'address',
                'rrn_display',
                'corp_number',      // [추가] 법인등록번호
                'business_number',  // [추가] 사업자등록번호
                'bank_name',
                'account_holder',
                'account_num_display',
                'admin_memo',
                'kakao_id',
                'naver_id',
                'join_category',
                'manager_id'
            ].join(','));

        // 2-1. 필터 및 정렬 적용
        if (status && status !== 'all') q = q.eq('status', status);
        if (type && type !== 'all') q = q.eq('member_type', type);

        // 통합 키워드 검색 (이름, 전화번호, 조합원번호 OR 검색)
        if (keyword) {
            q = q.or(`member_id.ilike.%${keyword}%,name.ilike.%${keyword}%,phone.ilike.%${keyword}%`);
        }

        // 정렬 조건 적용
        if (sort === 'join_date') q = q.order('join_date', { ascending: false });
        else if (sort === 'capital') { /* 출자금 정렬은 아래 병합 후 처리 필요하지만 일단 기본 정렬 */ }
        else q = q.order('name', { ascending: true }); // 기본: 이름순

        const { data: members, error } = await q;
        if (error) throw error;

        const list = Array.isArray(members) ? members : [];

        // 3. [최적화 핵심] view_my_assets를 통한 출자금 조회
        // 조회된 멤버들의 UUID만 추출
        const memberUids = list.map(m => m.id).filter(Boolean);
        let capitalMap = {};

        if (memberUids.length > 0) {
            // ★ 수정됨: ref_members 전체 조회 -> view_my_assets 요약 조회
            const { data: assets, error: assetErr } = await _supabase
                .from('view_my_assets')
                .select('member_uid, total_capital') // 필요한 컬럼만
                .in('member_uid', memberUids);       // 검색된 조합원들만 조회

            if (!assetErr && assets) {
                // UUID를 키(Key)로 하는 맵 생성 { "uuid-123": 500000, ... }
                assets.forEach(row => {
                    capitalMap[row.member_uid] = Number(row.total_capital || 0);
                });
            } else if (assetErr) {
                console.warn('자산 뷰 조회 실패(출자금 0으로 표시):', assetErr);
            }
        }

        // 4. 데이터 병합 (Members + Capital)
        g_members = list.map(m => ({
            ...m,
            // 맵에서 UUID로 찾아 매칭 (없으면 0원)
            total_capital: capitalMap[m.id] || 0,
            account_number: m.account_num_display || null
        }));

        // (옵션) 만약 정렬 기준이 '출자금순'이라면 JS 레벨에서 재정렬
        if (sort === 'capital') {
            g_members.sort((a, b) => b.total_capital - a.total_capital);
        }

        // 5. 화면 렌더링
        if (!g_members.length) {
             // 검색 결과 없음 or 초기 상태
             if (typeof renderMemberTable === 'function') renderMemberTable([]); 
             // 또는 renderEmptyState(); 사용 가능
             return;
        }

        renderMemberTable(g_members);

    } catch (err) {
        console.error(err);
        // Alert 대신 모달 사용 권장 (기존 myAlert 함수가 있다면)
        if (typeof myAlert === 'function') {
            myAlert('데이터를 불러오지 못했습니다: ' + (err?.message || err), 'error');
        } else {
            alert('데이터 로드 에러: ' + (err?.message || err));
        }
    } finally {
        if (typeof showLoading === 'function') showLoading(false);
    }
}


// [수정] 테이블 렌더링 (member_type 값 그대로 표시)
// [수정] 테이블 렌더링 (한글 상태값 완벽 대응)
// [수정] 테이블 렌더링 (주소 컬럼 제거 & 관리 버튼 추가 & 정렬 수정)
// [수정] 테이블 렌더링 (행 클릭 시 상세 이동 + 수정 버튼 제거)
function renderMemberTable(list) {
  const tbody = document.getElementById('memberListBody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (!Array.isArray(list) || list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-5">검색 결과가 없습니다.</td></tr>`;
    return;
  }

  // 문자열 이스케이프 (작은따옴표 깨짐 방지)
  const esc = (v) => String(v ?? '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");

  list.forEach((m, idx) => {
    const type = m.member_type || m.type || '-';
    const name = m.name || '-';
    const memberId = m.member_id || '';
    const phone = m.phone || '-';

    // 날짜 포맷팅
    const joinRaw = m.join_date || m.created_at || '';
    const joinDate = (typeof joinRaw === 'string' && joinRaw.includes('T'))
      ? joinRaw.split('T')[0]
      : (joinRaw || '-');

    const status = m.status || '-';
    const totalCapital = Number(m.total_capital || 0).toLocaleString() + '원';

    // 상태 뱃지 스타일
    const statusBadgeClass =
      status === '승인대기' ? 'bg-warning text-dark' :
      status === '정상' ? 'bg-success' :
      (status === '탈퇴' || status === '제명') ? 'bg-secondary' :
      'bg-light text-dark border';

    // 클릭 시 넘길 키값 (UUID 우선)
    const keyForDetail = m.member_uid || m.uid || m.id || memberId;
    const safeKey = esc(keyForDetail);

    // ★ 핵심 변경: tr에 onclick 적용, style="cursor:pointer" 추가
    tbody.innerHTML += `
      <tr onclick="openMemberDetail('${safeKey}')" style="cursor: pointer;">
        <td>${idx + 1}</td>
        <td>${type}</td>
        <td class="text-start">
          <div class="fw-bold">${name}</div>
          <div class="small text-muted">${memberId ? '(' + memberId + ')' : ''}</div>
        </td>
        <td>${phone}</td>
        <td>
          <div class="small">${joinDate}</div>
          <span class="badge ${statusBadgeClass}">${status}</span>
        </td>
        <td class="fw-bold">${totalCapital}</td>
        <td>
           <button class="btn btn-sm btn-outline-primary">상세</button>
        </td>
      </tr>
    `;
  });
}



// [신규] 조합원 명부 초기 상태 (검색 유도 화면)
function renderEmptyState() {
  const tbody = document.getElementById('memberListBody');
  if (!tbody) return;

  g_members = [];
  tbody.innerHTML = `
    <tr>
      <td colspan="7" class="text-center text-muted py-5">
        🔎 검색 조건을 입력하고 <b>검색</b>을 눌러주세요.
      </td>
    </tr>
  `;
}


// ================================================================
// [기능 2] 조합원 상세 관리 (슈퍼 모달)
// ================================================================

let g_current_member_id = null; // 현재 보고 있는 조합원 UUID


async function openMemberDetail(id) {
    // 1. 데이터 매칭
    const m = g_members.find(x => (x.id || x.member_uid || x.uid) === id)
            || g_members.find(x => (x.member_id || '') === id);

    if (!m) return myAlert("데이터를 찾을 수 없습니다.", 'error');

    const memberUid = m.id || m.member_uid || m.uid || null;
    if (!memberUid) return myAlert("조합원 UUID를 찾을 수 없습니다.", 'error');

    g_current_member_id = memberUid;

    // 2. UI 초기화 & 데이터 바인딩
    document.getElementById('md-uid').value = memberUid;
    document.getElementById('md-title').innerText = `${m.name} 님 상세`;
    document.getElementById('md-id-text').innerText = m.member_id || 'ID없음';
    
    let typeStr = m.member_type || m.type || '개인';
    document.getElementById('md-type-badge').innerText = typeStr;

    // 폼 값 채우기
    document.getElementById('md-name').value = m.name || '';
    document.getElementById('md-phone').value = m.phone || '';
    document.getElementById('md-status').value = m.status || '승인대기';
    document.getElementById('md-type').value = typeStr;
    document.getElementById('md-addr').value = m.address || '';
    document.getElementById('md-addr-detail').value = '';
    document.getElementById('md-memo').value = m.admin_memo || '';
    document.getElementById('md-bank-name').value = m.bank_name || '';
    document.getElementById('md-bank-owner').value = m.account_holder || '';
    document.getElementById('md-bank-account').value = m.account_number || '';

    // 3. [수정] 개인/단체 구분 표시 로직 (A안 적용)
    const areaInd = document.getElementById('area-individual');
    const areaGrp = document.getElementById('area-group');
    
    const isGroup = String(typeStr).includes('단체');

    if (isGroup) {
        // [단체일 때] 
        if(areaInd) areaInd.style.display = 'none';
        if(areaGrp) areaGrp.style.display = 'block';

        // DB 값을 그대로 인풋에 입력 (text, 하이픈 포함)
        document.getElementById('md-corp-num').value = m.corp_number || '';
        document.getElementById('md-biz-num').value = m.business_number || '';
        
        // 개인용 값 초기화
        document.getElementById('md-rrn-view').innerText = '-';
        document.getElementById('md-rrn').value = '';
        
    } else {
        // [개인일 때]
        if(areaInd) areaInd.style.display = 'block';
        if(areaGrp) areaGrp.style.display = 'none';

        // 단체용 값 초기화
        document.getElementById('md-corp-num').value = '';
        document.getElementById('md-biz-num').value = '';

        // 주민번호/사업자번호 표시 로직 (기존 유지)
        const rrn = m.rrn_display || '';
        let displayInfo = '정보 없음';

        if (isGroup) {
             displayInfo = '-'; 
        } else {
            if (rrn) {
                const cleanRrn = rrn.replace(/[^0-9]/g, '');
                if (cleanRrn.length >= 7) {
                    const yPre = cleanRrn.substr(6, 1);
                    const year = (yPre === '1' || yPre === '2') ? '19' : '20';
                    const gender = (yPre === '1' || yPre === '3') ? '남성' : '여성';
                    displayInfo = `${year}${cleanRrn.substr(0, 2)}년 ${cleanRrn.substr(2, 2)}월 ${cleanRrn.substr(4, 2)}일 (${gender})`;
                } else {
                    displayInfo = '정보 없음';
                }
            }
        }
        document.getElementById('md-rrn-view').innerText = displayInfo;
        document.getElementById('md-rrn').value = '';
    }

    // 4. SNS 연동 상태 표시 (기존 로직 유지)
    let snsHtml = '';
    if (m.kakao_id) snsHtml += '<span class="badge bg-warning text-dark me-1"><i class="bi bi-chat-fill"></i> Kakao</span>';
    if (m.naver_id) snsHtml += '<span class="badge bg-success"><i class="bi bi-n-square-fill"></i> Naver</span>';
    document.getElementById('md-sns-status').innerHTML = snsHtml || '<span class="text-muted small">SNS 미연동</span>';

    // ============================================================
    // ★ [추가됨] 뱃지 데이터 로드 (숫자 ID -> 문자 Code 변환)
    // ============================================================
    
    // 1. 전체 뱃지 로드
    if (!g_badges || g_badges.length === 0) {
        g_badges = await Badges.getAll(_supabase);
    }

    // 2. DB에서 이 회원의 badge_id(숫자) 조회
    const { data: myRows, error: badgeError } = await _supabase
        .from('coop_member_badges')
        .select('badge_id')
        .eq('member_uid', memberUid);

    // 3. 변환: 숫자(badge_id)를 가진 g_badges를 찾아 Code 추출
    let myBadgeCodes = [];
    if (myRows && !badgeError) {
        myBadgeCodes = myRows.map(row => {
            // g_badges의 id와 row.badge_id를 비교 (타입 변환 고려 == 사용)
            const match = g_badges.find(b => b.id == row.badge_id);
            return match ? match.code : null;
        }).filter(code => code !== null);
    }

    // 4. 체크박스 그리기
    Badges.renderCheckboxes('member-badge-checkboxes', g_badges, myBadgeCodes);
    // ============================================================

    // 5. 모달 설정 및 하위 데이터 로드 (기존 유지)
    toggleEditMode(false);
    loadMemberFunds(memberUid, m.member_id, true);
    loadConsultLogs(memberUid);
    loadMemberFamily(memberUid);

    new bootstrap.Modal(document.getElementById('memberDetailModal')).show();
}


function toggleEditMode(isEdit) {
    // 1. 일반 입력창 제어 (기존 로직)
    const inputs = document.querySelectorAll('#md-tab-basic input:not([type=checkbox]), #md-tab-basic select, #md-tab-basic textarea');
    inputs.forEach(el => {
        if(el.id === 'md-addr') el.disabled = true; 
        
        // [수정] 단체 번호 인풋들은 별도 로직으로 처리하기 위해 스킵 (아래 4번에서 처리)
        else if(el.id === 'md-corp-num' || el.id === 'md-biz-num') {
            // pass
        }
        else {
            el.disabled = !isEdit;
            el.classList.toggle('bg-light', !isEdit);
        }
    });

    // 2. ★ [추가됨] 뱃지 체크박스 제어
    // 수정 모드일 때만 체크박스 클릭 가능하게 설정
    const badgeChecks = document.querySelectorAll('#member-badge-checkboxes input[type="checkbox"]');
    badgeChecks.forEach(chk => {
        chk.disabled = !isEdit; 
    });

    // 3. 버튼 및 UI 제어 (기존 로직 유지)
    const btnSearch = document.getElementById('btn-addr-search');
    const addrDetail = document.getElementById('md-addr-detail');

    if(isEdit) {
        document.getElementById('btn-edit-mode').style.display = 'none';
        document.getElementById('btn-save-group').style.display = 'flex';
        document.getElementById('rrn-edit-area').style.display = 'block';
        document.getElementById('rrn-view-area').style.display = 'none';
        btnSearch.style.display = 'inline-block';
        addrDetail.style.display = 'block';
    } else {
        document.getElementById('btn-edit-mode').style.display = 'inline-block';
        document.getElementById('btn-save-group').style.display = 'none';
        document.getElementById('rrn-edit-area').style.display = 'none';
        document.getElementById('rrn-view-area').style.display = 'block';
        btnSearch.style.display = 'none';
        addrDetail.style.display = 'none';
    }

    // 4. [수정] 단체용 인풋 박스 제어 (Edit 모드일 때 + 단체 영역이 보일 때만)
    const corpInput = document.getElementById('md-corp-num');
    const bizInput = document.getElementById('md-biz-num');
    
    const isGroupVisible = document.getElementById('area-group').style.display !== 'none';

    if (isGroupVisible) {
        corpInput.disabled = !isEdit;
        bizInput.disabled = !isEdit;
        
        // 배경색 처리
        corpInput.classList.toggle('bg-light', !isEdit);
        bizInput.classList.toggle('bg-light', !isEdit);
    }
}

// [교체] 주소 검색 (검색 결과 -> 기본창, 포커스 -> 상세창)
function searchAddress() {
new daum.Postcode({
oncomplete: function(data) {
const fullAddr = `(${data.zonecode}) ${data.roadAddress || data.jibunAddress}`;
document.getElementById('md-addr').value = fullAddr;
document.getElementById('md-addr-detail').value = ''; // 상세주소 초기화
document.getElementById('md-addr-detail').focus();
}
}).open();
}

async function saveMemberBasic() {
    myConfirm("수정된 정보를 저장하시겠습니까?", async () => {
        // 1. 주소 및 기본값 처리
        const memberUid = document.getElementById('md-uid').value;
        const basicAddr = document.getElementById('md-addr').value;
        const detailAddr = document.getElementById('md-addr-detail').value;
        const finalAddr = detailAddr ? `${basicAddr} ${detailAddr}` : basicAddr;

        let bankAcc = document.getElementById('md-bank-account').value;
        if (bankAcc && bankAcc.includes('*')) bankAcc = null;

        showLoading(true);

        try {
            // [수정] 단체 정보도 함께 수집
            const corpNum = document.getElementById('md-corp-num').value || null;
            const bizNum = document.getElementById('md-biz-num').value || null;

            // 2. 기본 정보 업데이트 (기존 로직 유지 + 단체 파라미터 추가)
            const updates = {
                p_id: memberUid,
                p_name: document.getElementById('md-name').value,
                p_phone: document.getElementById('md-phone').value,
                p_address: finalAddr,
                p_bank_name: document.getElementById('md-bank-name').value,
                p_bank_owner: document.getElementById('md-bank-owner').value,
                p_bank_account: bankAcc,
                p_status: document.getElementById('md-status').value,
                p_member_type: document.getElementById('md-type').value,
                p_admin_memo: document.getElementById('md-memo').value,
                p_rrn: (document.getElementById('md-rrn').value || '').trim() || null,
                
                // [신규] 단체 정보 파라미터
                p_corp_number: corpNum,
                p_business_number: bizNum
            };

            const { error: basicError } = await _supabase.rpc('update_member_details_secure', updates);
            if (basicError) throw basicError;

            // ============================================================
            // ★ [추가됨] 뱃지 저장 (문자 Code -> 숫자 ID 변환)
            // ============================================================
            
            // 1. 체크된 값(Code) 수집
            const selectedCodes = [];
            document.querySelectorAll('#member-badge-checkboxes input:checked').forEach(cb => {
                selectedCodes.push(cb.value); 
            });

            // 2. 변환: Code -> ID(숫자)
            const selectedIds = selectedCodes.map(code => {
                const match = g_badges.find(b => b.code === code);
                return match ? Number(match.id) : null;
            }).filter(id => id !== null);

            // 3. 동기화 RPC 호출
            const { error: badgeError } = await _supabase.rpc('sync_member_badges', {
                p_member_uid: memberUid,
                p_badge_ids: selectedIds
            });

            if (badgeError) throw new Error('뱃지 동기화 실패: ' + badgeError.message);
            // ============================================================

            showLoading(false);
            myAlert('저장되었습니다.');
            toggleEditMode(false);
            
            // 3. 리스트 갱신 (딜레이 확보)
            setTimeout(() => { fetchMembers(); }, 300);

        } catch (err) {
            showLoading(false);
            console.error(err);
            myAlert('오류 발생: ' + err.message, 'error');
        }
    });
}


// [수정] 상담 이력 로드 (최신이 위로 오도록 정렬 보강)
async function loadConsultLogs(uuid) { // uuid는 유지(호출부 호환), 내부는 textId 사용
  const listEl = document.getElementById('md-consult-list');
  if (!listEl) return;

  const textId = document.getElementById('md-id-text').innerText;

  if (!textId || textId === '-' || textId === 'ID없음') {
    listEl.innerHTML = '<div class="text-center text-muted py-3 small">조합원 번호가 없어 조회할 수 없습니다.</div>';
    return;
  }

  listEl.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

  const { data, error } = await _supabase.rpc('get_member_consultations', {
    p_member_id: textId
  });

  listEl.innerHTML = '';

  if (error) {
    console.error("상담 로드 에러:", error);
    listEl.innerHTML = '<div class="text-center text-danger py-3 small">불러오기 실패</div>';
    return;
  }

  if (!data || data.length === 0) {
    listEl.innerHTML = '<div class="text-center text-muted py-3 small">상담 이력이 없습니다.</div>';
    return;
  }

  // ★ 핵심: 최근 이력이 위로 오도록(created_at 기준 내림차순)
  const sorted = [...data].sort((a, b) => {
    const at = a.created_at ? new Date(a.created_at).getTime() : 0;
    const bt = b.created_at ? new Date(b.created_at).getTime() : 0;
    return bt - at;
  });

  sorted.forEach(log => {
    let dateStr = '-';
    if (log.created_at) {
      const d = new Date(log.created_at);
      dateStr = `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
    }

    listEl.innerHTML += `
      <div class="list-group-item bg-light border-0 mb-1 rounded">
        <div class="d-flex justify-content-between">
          <small class="fw-bold text-dark">${log.author_email || '관리자'}</small>
          <small class="text-muted" style="font-size:0.8em">${dateStr}</small>
        </div>
        <div class="mt-1 text-secondary" style="font-size:0.9rem; white-space: pre-wrap;">${log.content}</div>
      </div>
    `;
  });
}


// [수정] 상담 등록 (UUID 대신 텍스트 ID 사용)
async function addConsultLog() {
const inputEl = document.getElementById('md-consult-input');
const content = inputEl.value;

if(!content.trim()) return alert('내용을 입력하세요.');

const userEmail = document.getElementById('adminProfile') ? document.getElementById('adminProfile').innerText : 'admin';
const textId = document.getElementById('md-id-text').innerText; // 화면에 있는 텍스트 ID

if(!textId || textId === '-') return alert('조합원 번호가 없는 사용자입니다.');

showLoading(true);

// ★ 핵심 수정: 텍스트 ID만 보냅니다. (UUID는 DB가 알아서 찾음)
const { error } = await _supabase.rpc('add_consultation', {
p_member_id: textId,
p_author_email: userEmail,
p_content: content
});
showLoading(false);

if(error) {
console.error(error);
alert('등록 실패: ' + error.message);
} else {
inputEl.value = ''; 
// 등록 후 목록 갱신할 때도 원래 함수 호출 (내부에서 textId 다시 찾음)
loadConsultLogs(null); 
}
}


// 5. 자금 로드 (출자금, 기부금 등) - Phase 2에서는 '조회' 위주


// [신규] 가족/단체 목록 로드 (내가 관리자인 계정 조회)
async function loadMemberFamily(parentId) {
    const tbody = document.getElementById('md-family-list');
    if (!tbody) return;

    // 1. 로딩 표시
    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>';

    // 2. DB 조회 (manager_id가 현재 보고 있는 조합원인 경우)
    // 뷰에는 manager_id가 없을 수 있으므로 원본 테이블을 조회합니다.
    const { data: familyList, error } = await _supabase
        .from('coop_members')
        .select('id, name, rrn_display, status, member_type, join_category, join_date')
        .eq('manager_id', parentId)
        .order('join_date', { ascending: false });

    if (error) {
        console.error("가족 목록 로드 실패:", error);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger small py-3">데이터 로드 실패</td></tr>';
        return;
    }

    // 3. 데이터 없음 처리
    if (!familyList || familyList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted small py-3">연결된 가족이나 단체가 없습니다.</td></tr>';
        return;
    }

    // 4. 목록 렌더링
    tbody.innerHTML = '';
    
    familyList.forEach(m => {
        // 구분 뱃지 (자녀 vs 단체)
        let typeBadge = '<span class="badge bg-secondary">기타</span>';
        if (m.member_type === '단체') {
            typeBadge = '<span class="badge bg-info">🏢 단체</span>';
        } else if (m.join_category === '가족') {
            typeBadge = '<span class="badge bg-warning text-dark">👶 자녀</span>';
        }

        // 주민번호/사업자번호 표시
        const idNum = m.rrn_display || '-';

        // 상태 뱃지
        let statusClass = 'bg-success';
        if (m.status === '승인대기') statusClass = 'bg-danger';
        else if (m.status === '탈퇴') statusClass = 'bg-secondary';
        
        const statusBadge = `<span class="badge ${statusClass}">${m.status}</span>`;

        tbody.innerHTML += `
            <tr>
                <td>${typeBadge}</td>
                <td class="fw-bold">${m.name}</td>
                <td class="small font-monospace">${idNum}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-xs btn-outline-dark border" onclick="openMemberDetail('${m.id}')">
                        상세보기
                    </button>
                </td>
            </tr>
        `;
    });
}

// ================================================================
// [기능 Phase 3] 자금 관리 (출자/기부 CRUD)
// ================================================================

// [수정] 에디터 모달 열기 (삭제 버튼 제어 로직 추가)
function openFundEditor(type, rowDataStr) {
    const modalEl = document.getElementById('fundEditorModal');
    const titleEl = document.getElementById('fund-modal-title');
    const delBtn = document.getElementById('btn-fund-delete'); // 삭제 버튼

    // 필드 초기화
    document.getElementById('fund-edit-type').value = type;
    document.getElementById('fund-edit-id').value = ''; 
    document.getElementById('fund-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('fund-amount').value = '';
    document.getElementById('fund-note').value = '';
    document.getElementById('fund-depositor').value = '';

    // UI 분기 (출자금 vs 기부금)
    if (type === 'capital') {
        titleEl.innerText = '💰 출자금 입금 내역';
        titleEl.className = 'modal-title fw-bold text-success';
        document.getElementById('fund-method-group').style.display = 'none';
        document.getElementById('fund-depositor-group').style.display = 'block';
        
        if (!rowDataStr) document.getElementById('fund-depositor').value = document.getElementById('md-name').value;
    } else {
        titleEl.innerText = '🎁 기부금 내역';
        titleEl.className = 'modal-title fw-bold text-primary';
        document.getElementById('fund-method-group').style.display = 'block';
        document.getElementById('fund-depositor-group').style.display = 'none';
        document.getElementById('fund-method').value = 'transfer';
    }

    // ★ [핵심] 수정 모드 vs 신규 모드
    if (rowDataStr) {
        // 수정 모드: 데이터 채우기 & 삭제 버튼 보이기
        try {
            const data = JSON.parse(decodeURIComponent(rowDataStr));
            document.getElementById('fund-edit-id').value = data.id;
            document.getElementById('fund-date').value = data.deposit_date || data.donation_date;
            document.getElementById('fund-amount').value = data.amount;
            document.getElementById('fund-note').value = data.note || '';

            if(type === 'capital') document.getElementById('fund-depositor').value = data.depositor || '';
            else document.getElementById('fund-method').value = data.payment_method || 'transfer';

            // 삭제 버튼 노출
            delBtn.style.display = 'block';
        } catch (e) { console.error(e); }
    } else {
        // 신규 모드: 삭제 버튼 숨김
        delBtn.style.display = 'none';
    }

    modalEl.style.zIndex = 2000;
    new bootstrap.Modal(modalEl).show();
}

// [수정] 자금 목록 로드 (조회 기준 변경: UUID -> Member ID 우선)
async function loadMemberFunds(uuid, textId, reset=false) {
    // 1. 출자금 리스트 처리 (기존 유지)
    const capListEl = document.getElementById('md-capital-list');
    if (capListEl) {
        if (reset) capListEl.innerHTML = '';
        
        if (textId && textId !== 'ID없음') {
            const { data: caps, error: capErr } = await _supabase
                .from('ref_members')
                .select('*')
                .eq('member_id', textId)
                .order('deposit_date', {ascending: false});

            if (capErr) console.error("출자금 로드 실패:", capErr);
            
            capListEl.innerHTML = '';
            if (!caps || caps.length === 0) {
                capListEl.innerHTML = '<tr><td colspan="4" class="text-muted small py-3">내역 없음</td></tr>';
            } else {
                caps.forEach(c => {
                    const json = encodeURIComponent(JSON.stringify(c));
                    capListEl.innerHTML += `
                        <tr>
                            <td>${c.deposit_date}</td>
                            <td class="fw-bold text-success">${Number(c.amount).toLocaleString()}</td>
                            <td class="text-start text-truncate" style="max-width:100px;">${c.note||'-'}</td>
                            <td>
                                <button class="btn btn-xs btn-light border" onclick="openFundEditor('capital','${json}')">수정</button>
                            </td>
                        </tr>`;
                });
            }
        }
    }

    // 2. ★ [핵심 수정] 기부금 리스트 처리
    const donListEl = document.getElementById('md-donation-list');
    if (donListEl) {
        if (reset) donListEl.innerHTML = '';
        
        // 기부금 조회 (coop_donations)
        let query = _supabase.from('coop_donations').select('*').order('donation_date', {ascending: false});
        
        // [변경 전 로직] UUID가 있으면 무조건 UUID로 검색해서 문제 발생
        // if (uuid) query = query.eq('member_uid', uuid);
        // else if (textId) query = query.eq('member_id', textId);

        // [변경 후 로직] member_id(텍스트 ID)가 가장 확실하므로 이것을 최우선으로 검색
        if (textId && textId !== 'ID없음' && textId !== '-') {
            query = query.eq('member_id', textId);
        } 
        // 텍스트 ID가 없는 특수한 경우에만 UUID 사용 (백업 로직)
        else if (uuid) {
            query = query.eq('member_uid', uuid);
        }
        
        const { data: dons, error: donErr } = await query;

        if (donErr) console.error("기부금 로드 실패:", donErr);

        // 렌더링
        donListEl.innerHTML = '';
        if (!dons || dons.length === 0) {
            donListEl.innerHTML = '<tr><td colspan="5" class="text-muted small py-3">내역 없음</td></tr>';
        } else {
            dons.forEach(d => {
                const json = encodeURIComponent(JSON.stringify(d));
                
                // 결제 수단 뱃지
                let methodBadge = '<span class="badge bg-light text-dark border">기타</span>';
                if(d.type === 'transfer') methodBadge = '<span class="badge bg-info bg-opacity-10 text-dark">계좌</span>';
                else if(d.type === 'card') methodBadge = '<span class="badge bg-warning bg-opacity-10 text-dark">카드</span>';
                else if(d.type === 'cash') methodBadge = '<span class="badge bg-success bg-opacity-10 text-dark">현금</span>';

                donListEl.innerHTML += `
                    <tr>
                        <td>${d.donation_date}</td>
                        <td class="fw-bold text-primary">${Number(d.amount).toLocaleString()}</td>
                        <td>${methodBadge}</td>
                        <td class="text-start text-truncate" style="max-width:100px;">${d.note||'-'}</td>
                        <td>
                            <button class="btn btn-xs btn-light border" onclick="openFundEditor('donation','${json}')">수정</button>
                        </td>
                    </tr>`;
            });
        }
    }
}

// [최종] 자금 내역 삭제 함수
async function deleteFundData() {
    // 1. HTML에서 hidden input 값 읽기
    const modal = document.getElementById('fundEditorModal');
    // querySelector로 모달 안의 요소를 정확히 찾습니다
    const typeInput = modal.querySelector('#fund-edit-type'); 
    const idInput = modal.querySelector('#fund-edit-id');

    const type = typeInput ? typeInput.value : '';
    const idVal = idInput ? idInput.value : '';

    // 2. 값 검증 (없으면 모달 경고)
    if (!idVal) return myAlert("삭제할 내역 정보(ID)가 없습니다.", 'error');
    if (!type) return myAlert("데이터 타입(출자/기부)을 확인할 수 없습니다.", 'error');

    // 3. 삭제 확인 모달
    myConfirm("정말 이 내역을 삭제하시겠습니까?<br><small class='text-danger'>잘못 입력된 내역을 지울 때 사용하세요.</small>", async () => {
        showLoading(true);

        // 4. 타입에 따라 RPC 함수 선택
        let rpcName = '';
        if (type === 'capital') {
            rpcName = 'delete_capital_secure';
        } else if (type === 'donation') {
            rpcName = 'delete_donation_secure';
        } else {
            showLoading(false);
            return myAlert(`오류: 알 수 없는 데이터 타입입니다 (${type})`, 'error');
        }

        // 5. RPC 호출 (ID를 숫자로 변환하여 전송)
        const { error } = await _supabase.rpc(rpcName, { p_id: Number(idVal) });
        
        showLoading(false);

        if (error) {
            console.error("RPC Error:", error);
            // 에러 메시지도 모달로 표시
            myAlert(`삭제 실패: ${error.message}`, 'error');
        } else {
            // 성공 모달
            myAlert("삭제되었습니다.");
            
            // 모달 닫기
            bootstrap.Modal.getInstance(document.getElementById('fundEditorModal')).hide();
            
            // 목록 및 통계 갱신
            const memberUid = document.getElementById('md-uid').value;
            const memberTextId = document.getElementById('md-id-text').innerText;
            loadMemberFunds(memberUid, memberTextId, true);
            loadDashboard();
        }
    });
}


// [수정] 저장 실행 (Foreign Key 에러 방지 적용)
async function saveFundData() {
    // 1. 폼 데이터 수집
    const type = document.getElementById('fund-edit-type').value;
    
    // ID가 빈 문자열이면 null로 보내야 DB에서 INSERT로 인식함
    let idVal = document.getElementById('fund-edit-id').value;
    if (!idVal || idVal.trim() === '') idVal = null;
    
    const amount = document.getElementById('fund-amount').value;
    const date = document.getElementById('fund-date').value;
    const note = document.getElementById('fund-note').value;
    
    // 유효성 검사
    if (!amount || amount <= 0) return myAlert('정확한 금액을 입력해주세요.', 'warning');
    if (!date) return myAlert('날짜를 선택해주세요.', 'warning');

    // 현재 상세 모달에 띄워진 조합원 정보 가져오기
    const memberUid = document.getElementById('md-uid').value;           // UUID
    const memberTextId = document.getElementById('md-id-text').innerText; // 텍스트 ID (예: 2024-001)

    showLoading(true);

    let rpcName = '';
    let params = {};

    // 2. 타입별 파라미터 구성 (RPC 명세 준수)
    if (type === 'capital') {
        rpcName = 'manage_capital_secure';
        params = {
            p_id: idVal,
            p_member_text_id: memberTextId,  // 출자금은 text id 기준
            p_amount: Number(amount),
            p_date: date,
            p_note: note,
            p_depositor: document.getElementById('fund-depositor').value
        };
    } else {
        rpcName = 'manage_donation_secure';
        params = {
            p_id: idVal,
            
            // ★ [핵심 수정] FK 에러 방지: 
            // 현재 memberUid가 auth.users에 없는 가짜/과거 값이면 에러가 납니다.
            // 관리자 수동 입력 시에는 안전하게 NULL로 보내고, member_id(Text ID)로 연결합니다.
            p_member_uid: null, 
            
            p_member_text_id: memberTextId,  // text id가 식별자 역할을 함
            p_amount: Number(amount),
            p_date: date,
            p_method: document.getElementById('fund-method').value, // payment_method
            p_note: note
        };
    }

    // 3. RPC 호출
    console.log(`Sending to ${rpcName}:`, params); // 디버깅용
    const { error } = await _supabase.rpc(rpcName, params);
    
    showLoading(false);

    if (error) {
        myAlert('저장 실패: ' + error.message, 'error');
    } else {
        myAlert('성공적으로 저장되었습니다.');
        
        // 에디터 모달 닫기
        bootstrap.Modal.getInstance(document.getElementById('fundEditorModal')).hide();
        
        // 리스트 새로고침 (현재 보고 있는 조합원 자금 내역)
        loadMemberFunds(memberUid, memberTextId, true); // true = 리셋 후 로드

        // 대시보드 통계도 갱신 (금액이 변했으므로)
        loadDashboard();
    }
}


// 1. [유틸] 알럿 -> 모달 대체
function myAlert(msg, type='success') {
const icon = type === 'success' 
? '<i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>' 
: '<i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 2rem;"></i>';
document.getElementById('alertIcon').innerHTML = icon;
document.getElementById('alertText').innerHTML = msg;
new bootstrap.Modal(document.getElementById('customAlertModal')).show();
}

function myConfirm(msg, callback) {
document.getElementById('confirmText').innerHTML = msg;
const btn = document.getElementById('btnConfirmYes');

// 이벤트 리스너 중복 방지를 위한 노드 복제 교체
const newBtn = btn.cloneNode(true);
btn.parentNode.replaceChild(newBtn, btn);

newBtn.onclick = () => {
bootstrap.Modal.getInstance(document.getElementById('customConfirmModal')).hide();
callback();
};
new bootstrap.Modal(document.getElementById('customConfirmModal')).show();
}

// 2. [유틸] 자동 하이픈 (HTML oninput="autoHyphen(this)" 연결 필요)

function autoHyphen(target) {
    // 숫자만 남기고 제거
    let val = target.value.replace(/[^0-9]/g, '');

    if(target.id === 'md-phone') { // 전화번호
        if(val.length < 4) target.value = val;
        else if(val.length < 7) target.value = val.substr(0, 3) + '-' + val.substr(3);
        else if(val.length < 11) target.value = val.substr(0, 3) + '-' + val.substr(3, 3) + '-' + val.substr(6);
        else target.value = val.substr(0, 3) + '-' + val.substr(3, 4) + '-' + val.substr(7);
    
    } else if(target.id === 'md-rrn') { // 주민번호 (6-7)
        if(val.length < 7) target.value = val;
        else target.value = val.substr(0, 6) + '-' + val.substr(6, 7);
    
    } else if(target.id === 'md-corp-num') { // [추가] 법인번호 (6-7)
        // 예: 110111-1234567
        if(val.length < 7) target.value = val;
        else target.value = val.substr(0, 6) + '-' + val.substr(6);
    
    } else if(target.id === 'md-biz-num') { // [추가] 사업자번호 (3-2-5)
        // 예: 123-45-67890
        if(val.length < 4) target.value = val;
        else if(val.length < 6) target.value = val.substr(0, 3) + '-' + val.substr(3);
        else target.value = val.substr(0, 3) + '-' + val.substr(3, 2) + '-' + val.substr(5);
    }
}



// [추가] 무한 스크롤 이벤트 핸들러
function handleFundScroll(e) {
const el = e.target;
// 스크롤이 바닥에 거의 닿았을 때 (여유분 10px)
if(el.scrollTop + el.clientHeight >= el.scrollHeight - 10) {
const textId = document.getElementById('md-id-text').innerText;
const uid = document.getElementById('md-uid').value;
loadMemberFunds(uid, textId, false); // false = 추가 로드
}
}
// 1. 단체 검색 모달 열기
function openGroupSearch() {
document.getElementById('group-search-input').value = '';
document.getElementById('group-search-result').innerHTML = '';
new bootstrap.Modal(document.getElementById('groupSearchModal')).show();
}

// 2. 검색 실행
async function searchGroups() {
const keyword = document.getElementById('group-search-input').value;
if(!keyword) return;

const { data } = await _supabase.rpc('search_groups', { keyword });
const list = document.getElementById('group-search-result');
list.innerHTML = '';

if(!data || data.length===0) { list.innerHTML = '<div class="p-3 text-center text-muted">결과 없음</div>'; return; }

data.forEach(g => {
// 관리자 정보 표시
const status = g.rep_name 
? `<span class="badge bg-warning text-dark">현재 관리자: ${g.rep_name}</span>` 
: `<span class="badge bg-success">관리자 없음</span>`;

list.innerHTML += `
           <button class="list-group-item list-group-item-action" onclick="tryConnectGroup('${g.id}', '${g.name}', '${g.rep_name||''}')">
               <div class="d-flex justify-content-between align-items-center">
                   <span class="fw-bold">${g.name}</span>
                   <small>${status}</small>
               </div>
           </button>`;
});
}

// 3. 연결 시도
function tryConnectGroup(groupId, groupName, currentManager) {
const myName = document.getElementById('md-name').value;
let msg = `'${groupName}'의 관리자로 등록하시겠습니까?`;

if(currentManager) {
msg = `⚠️ <b>주의:</b> 현재 '${currentManager}'님이 관리자로 되어 있습니다.<br>관리자를 '${myName}'님으로 변경하시겠습니까?`;
}

myConfirm(msg, async () => {
showLoading(true);
const { error } = await _supabase.rpc('connect_group_manager', { 
group_uuid: groupId, 
manager_uuid: g_current_member_id 
});
showLoading(false);

if(error) myAlert('연결 실패: ' + error.message, 'error');
else {
myAlert('연결되었습니다.');
bootstrap.Modal.getInstance(document.getElementById('groupSearchModal')).hide();
// 필요하다면 가족 리스트 새로고침: loadMemberFamily(g_current_member_id);
}
});
}
// [신규] 관계 선택 모달 열기
function openRelationSelectModal() {
// 상세 모달 위에 띄워야 하므로 z-index 관리 필요할 수 있음 (Bootstrap이 자동 처리하기도 함)
new bootstrap.Modal(document.getElementById('relationSelectModal')).show();
}

// [신규] 선택 후 다음 단계 이동
function confirmRelationType() {
const type = document.querySelector('input[name="relationType"]:checked').value;

// 현재 모달 닫기
const modalEl = document.getElementById('relationSelectModal');
const modalInstance = bootstrap.Modal.getInstance(modalEl);
modalInstance.hide();

if (type === 'child') {
// TODO: 자녀 등록 모달(폼) 띄우기
alert("다음 단계: 자녀(이름, 생년월일, 성별) 입력 폼을 띄웁니다."); 
// openChildForm(); 
} else {
// TODO: 단체 검색 모달 띄우기
alert("다음 단계: 연결할 단체를 검색하는 창을 띄웁니다.");
// openOrgSearchModal();
}
}
// [신규] 자녀 등록 폼 열기
function openChildForm() {
    // 1. 현재 보고 있는 부모 조합원 정보 찾기
    const parentId = document.getElementById('md-uid').value;
    const parent = g_members.find(m => m.id === parentId);

    if(!parent) return myAlert('부모 정보를 찾을 수 없습니다.', 'error');

    // 2. 부모 정보 UI에 바인딩
    document.getElementById('child-parent-name').value = `${parent.name} (${parent.member_id || '-'})`;
    
    // 3. 부모 정보 복사 (연락처, 주소) - 편의성 제공
    document.getElementById('child-phone').value = parent.phone || '';
    document.getElementById('child-address').value = parent.address || '';
    
    // 4. 나머지 초기화
    document.getElementById('child-name').value = '';
    document.getElementById('child-rrn').value = '';

    // 5. 모달 열기
    new bootstrap.Modal(document.getElementById('childRegisterModal')).show();
}

// [신규] 자녀 저장 실행
async function saveChildMember() {
    const parentId = document.getElementById('md-uid').value;
    const name = document.getElementById('child-name').value.trim();
    const rrn = document.getElementById('child-rrn').value.replace(/[^0-9]/g, ''); // 숫자만 추출
    const phone = document.getElementById('child-phone').value;
    const address = document.getElementById('child-address').value;
    
    // 유효성 검사
    if(!name) return myAlert("자녀 이름을 입력해주세요.", 'warning');
    if(rrn.length !== 13) return myAlert("주민번호 13자리를 정확히 입력해주세요.", 'warning');

    myConfirm(`${name} 자녀를 등록하시겠습니까?`, async () => {
        showLoading(true);
        
        const params = {
            p_manager_id: parentId, // 부모 ID 연결
            p_name: name,
            p_rrn: rrn,
            p_phone: phone,
            p_address: address,
            p_memo: '자녀 계정 (부모에 의해 생성됨)'
        };

        const { error } = await _supabase.rpc('create_child_member', params);
        showLoading(false);

        if(error) {
            myAlert("등록 실패: " + error.message, 'error');
        } else {
            myAlert("자녀 계정이 등록되었습니다.");
            // 모달 닫기
            bootstrap.Modal.getInstance(document.getElementById('childRegisterModal')).hide();
            
            // TODO: 가족 목록 리스트를 새로고침해야 함 (다음 단계에서 구현)
            // loadMemberFamily(parentId); 
        }
    });
}

// ================================================================
// [초기화] 통합 윈도우 로드 함수 (중복 선언 금지)
// ================================================================
window.onload = async function() {
    console.log("시스템 초기화 시작...");

    // 1. 세션 확인 및 관리자 권한 체크
    // (user 정보를 checkAdmin에 확실하게 넘겨주기 위함)
    const { data: { session } } = await _supabase.auth.getSession();
    const user = session ? session.user : null;
    
    // checkAdmin 내부에서 권한 확인 및 페이지 리다이렉트 처리
    await checkAdmin(user);

    // 2. 사이드바 메뉴 활성화 (현재 URL 기반)
    const currentPath = window.location.pathname.split('/').pop(); // 예: admin_member.html
    
    // href가 현재 파일명과 일치하는 링크 찾기
    const activeLink = document.querySelector(`.sidebar-menu .nav-link[href="${currentPath}"]`);
    
    if (activeLink) {
        activeLink.classList.add('active');
        // closest 사용 시 null 에러 방지를 위한 안전장치 추가
        const parentItem = activeLink.closest('.nav-item');
        if(parentItem) parentItem.classList.add('active');
    }

    // 3. 초기 탭 로드 (대시보드)
    // 이 함수 안에서 loadDashboard()가 호출됨
    switchTab('dashboard');

    // 4. 자금 내역 테이블 무한 스크롤 이벤트 연결
    // 요소가 존재할 때만 이벤트 리스너 추가 (에러 방지)
    const fundTableContainer = document.querySelector('#md-capital-list')?.closest('.table-responsive');
    if(fundTableContainer) {
        fundTableContainer.addEventListener('scroll', handleFundScroll);
        console.log("무한 스크롤 이벤트 연결됨");
    }
};

    // ================================================================
// [기능 11] 관리자 로그 뷰어 (신규 추가)
// ================================================================

// 전역 변수: 로그 페이지 관리용
let g_log_page = 0;
const LOG_PAGE_SIZE = 20;

// 1. 로그 뷰어 모달 열기
function openAdminLogModal() {
    // 초기화: 첫 페이지, 필터 초기화, 검색어 초기화
    g_log_page = 0;
    document.getElementById('log-filter-type').value = 'all';
    document.getElementById('log-search-keyword').value = '';
    
    // 데이터 로드
    fetchAdminLogs();
    
    // 모달 표시
    new bootstrap.Modal(document.getElementById('adminLogModal')).show();
}

// 2. 로그 데이터 조회 (Supabase)
async function fetchAdminLogs() {
    const tbody = document.getElementById('logListBody');
    const typeFilter = document.getElementById('log-filter-type').value;
    const keyword = document.getElementById('log-search-keyword').value.trim();
    
    // 로딩 표시
    tbody.innerHTML = '<tr><td colspan="6" class="py-5"><div class="spinner-border text-primary"></div></td></tr>';

    try {
        // 쿼리 작성 (최신순 정렬)
        let query = _supabase
            .from('admin_logs')
            .select('*', { count: 'exact' })
            .order('created_at', { ascending: false });

        // 필터 적용: 유형
        if (typeFilter !== 'all') {
            query = query.eq('action_type', typeFilter);
        }

        // 필터 적용: 검색어 (대상, 내용, 이메일 통합 검색)
        if (keyword) {
            // ilike를 사용하여 대소문자 구분 없이 검색
            // target, details, admin_email 칼럼 중 하나라도 포함되면 검색
            query = query.or(`target.ilike.%${keyword}%,details.ilike.%${keyword}%,admin_email.ilike.%${keyword}%`);
        }

        // 페이징 적용 (range: 0부터 시작)
        const from = g_log_page * LOG_PAGE_SIZE;
        const to = from + LOG_PAGE_SIZE - 1;
        query = query.range(from, to);

        // 실행
        const { data, count, error } = await query;

        if (error) throw error;

        // UI 업데이트
        document.getElementById('log-total-count').innerText = `총 ${count ? count.toLocaleString() : 0}건`;
        document.getElementById('log-page-num').innerText = `Page ${g_log_page + 1}`;

        // 테이블 렌더링
        renderLogTable(data);

    } catch (err) {
        console.error("로그 로드 실패:", err);
        tbody.innerHTML = `<tr><td colspan="6" class="py-5 text-danger">데이터를 불러오지 못했습니다.<br><small>${err.message}</small></td></tr>`;
    }
}

// 3. 로그 테이블 렌더링 (HTML 생성)
function renderLogTable(list) {
    const tbody = document.getElementById('logListBody');
    tbody.innerHTML = '';

    if (!list || list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="py-5 text-muted">기록된 활동 로그가 없습니다.</td></tr>';
        return;
    }

    list.forEach(log => {
        // 날짜 포맷팅 (YYYY-MM-DD HH:MM:SS)
        let dateStr = '-';
        if (log.created_at) {
            const d = new Date(log.created_at);
            dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
                      `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        }

        // 유형별 뱃지 스타일
        let typeBadge = `<span class="badge bg-secondary">${log.action_type}</span>`;
        if (log.action_type === 'DOWNLOAD') typeBadge = `<span class="badge bg-danger">📥 다운로드</span>`;
        else if (log.action_type === 'EDIT') typeBadge = `<span class="badge bg-primary">✏️ 수정</span>`;
        else if (log.action_type === 'VIEW') typeBadge = `<span class="badge bg-light text-dark border">👁️ 조회</span>`;
        else if (log.action_type === 'LOGIN') typeBadge = `<span class="badge bg-success">🔑 로그인</span>`;

        // 이메일 마스킹 (선택 사항이지만 관리자끼리니 일단 다 보여줌)
        const email = log.admin_email || 'unknown';

        tbody.innerHTML += `
            <tr>
                <td class="text-muted small">${dateStr}</td>
                <td class="fw-bold text-dark">${email}</td>
                <td>${typeBadge}</td>
                <td class="text-start">${log.target || '-'}</td>
                <td class="text-start text-truncate" style="max-width: 300px;" title="${log.details}">
                    ${log.details || '-'}
                </td>
                <td class="text-muted small">${log.ip_address || '-'}</td>
            </tr>
        `;
    });
}

// 4. 페이지 변경 함수
function changeLogPage(direction) {
    const next = g_log_page + direction;
    if (next < 0) return; // 0페이지 미만 방지
    
    // 다음 페이지가 있는지 확인하는 로직은 count를 이용해 정교하게 짤 수도 있지만,
    // 간단하게는 '현재 리스트가 꽉 찼으면 다음이 있다'고 가정하거나,
    // fetchAdminLogs 안에서 count를 전역으로 저장해서 비교할 수 있습니다.
    // 여기서는 일단 요청을 보내고 데이터가 없으면 빈 화면이 나오는 기본 방식으로 처리 후,
    // 개선한다면 'count'를 확인하여 버튼을 비활성화하는 로직을 추가할 수 있습니다.
    
    // 단순화: 일단 이동하고 조회
    g_log_page = next;
    fetchAdminLogs();
}
// [수정] 자산수증이익(기부금) 전체 조회 (Member ID 기준 매핑으로 변경)
async function fetchGlobalDonations() {
    const startDate = document.getElementById('don-date-start').value;
    const endDate = document.getElementById('don-date-end').value;
    const tbody = document.getElementById('donationGlobalBody');
    
    tbody.innerHTML = '<tr><td colspan="5" class="py-5"><div class="spinner-border text-primary"></div></td></tr>';

    // 1. 기부금 내역 조회
    const { data: donations, error } = await _supabase
        .from('coop_donations')
        .select('*')
        .gte('donation_date', startDate)
        .lte('donation_date', endDate)
        .order('donation_date', { ascending: false });

    if (error) {
        console.error(error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-danger py-4">데이터 로드 실패: ${error.message}</td></tr>`;
        return;
    }

    if (!donations || donations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted py-5">해당 기간의 자산수증(기부) 내역이 없습니다.</td></tr>';
        document.getElementById('don-total-sum').innerText = '0';
        return;
    }

    // 2. ★ [핵심 수정] UUID가 아닌 member_id(조합원번호)로 회원 정보 조회
    // 기부금 데이터에서 member_id만 추출 (중복 제거)
    const memberIds = [...new Set(donations.map(d => d.member_id).filter(Boolean))];
    let memberMap = {}; // { "2024-001": "홍길동" }

    if (memberIds.length > 0) {
        const { data: members, error: memberError } = await _supabase
            .from('coop_members')
            .select('member_id, name') // 이름과 ID만 필요
            .in('member_id', memberIds);
        
        if (!memberError && members) {
            members.forEach(m => {
                memberMap[m.member_id] = m.name;
            });
        }
    }

    // 3. 데이터 병합 및 렌더링
    let totalSum = 0;
    tbody.innerHTML = '';

    donations.forEach(d => {
        totalSum += Number(d.amount);
        
        // 결제수단 뱃지
        let methodBadge = '<span class="badge bg-light text-dark border">기타</span>';
        if(d.type === 'transfer') methodBadge = '<span class="badge bg-info bg-opacity-10 text-dark">계좌</span>';
        else if(d.type === 'card') methodBadge = '<span class="badge bg-warning bg-opacity-10 text-dark">카드</span>';
        else if(d.type === 'cash') methodBadge = '<span class="badge bg-success bg-opacity-10 text-dark">현금</span>';

        // ★ 수정됨: member_id로 맵에서 이름 찾기
        // 맵에 없으면(탈퇴/삭제 등) 그냥 '미확인' 대신 빈 문자열 처리하거나 원본 표시
        const name = memberMap[d.member_id] || '미확인';

        tbody.innerHTML += `
            <tr>
                <td>${d.donation_date}</td>
                <td class="text-start ps-4">
                    <span class="fw-bold">${name}</span> 
                    <small class="text-muted">(${d.member_id})</small>
                </td>
                <td class="fw-bold text-end pe-4">${Number(d.amount).toLocaleString()}</td>
                <td>${methodBadge}</td>
                <td class="text-start text-muted small">${d.note || '-'}</td>
            </tr>
        `;
    });

    // 총액 업데이트
    document.getElementById('don-total-sum').innerText = totalSum.toLocaleString();
}

// [수정] 이용고배당(포인트) 전체 조회 (Member ID 기준 매핑으로 변경)
async function fetchGlobalDividends() {
    const keyword = document.getElementById('div-search-keyword').value.trim();
    const tbody = document.getElementById('dividendGlobalBody');
    
    tbody.innerHTML = '<tr><td colspan="5" class="py-5"><div class="spinner-border text-info"></div></td></tr>';

    // 1. coop_points 테이블 조회
    const { data: points, error } = await _supabase
        .from('coop_points')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(100);

    if (error) {
        console.error("이용고배당 조회 실패:", error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-danger py-4">조회 실패: ${error.message}</td></tr>`;
        return;
    }

    if (!points || points.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted py-5">이용고배당 내역이 없습니다.</td></tr>';
        return;
    }

    // 2. ★ [핵심 수정] UUID가 아닌 member_id로 이름 조회
    const memberIds = [...new Set(points.map(p => p.member_id).filter(Boolean))];
    let memberMap = {};

    if (memberIds.length > 0) {
        const { data: members, error: mErr } = await _supabase
            .from('coop_members')
            .select('member_id, name')
            .in('member_id', memberIds);
        
        if (!mErr && members) {
            members.forEach(m => memberMap[m.member_id] = m.name);
        }
    }

    // 3. 필터링 및 렌더링
    tbody.innerHTML = '';
    
    const filtered = points.filter(p => {
        if(!keyword) return true;
        // 검색 시 맵에 있는 이름이나, ID 텍스트로 검색
        const name = memberMap[p.member_id] || '';
        const idText = p.member_id || '';
        return name.includes(keyword) || idText.includes(keyword);
    });

    if(filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted py-5">검색 결과가 없습니다.</td></tr>';
        return;
    }

    filtered.forEach(p => {
        const dateStr = p.created_at ? p.created_at.substring(0, 16).replace('T', ' ') : '-';
        const amt = Number(p.change_amount || 0);
        
        // 뱃지 처리
        let typeBadge = `<span class="badge bg-light text-dark border">${p.transaction_type}</span>`;
        let colorClass = 'text-dark';
        let sign = '';

        if (p.transaction_type === 'earn') {
            typeBadge = '<span class="badge bg-primary bg-opacity-10 text-primary">지급(Earn)</span>';
            colorClass = 'text-primary fw-bold';
            sign = '+';
        } else if (p.transaction_type === 'use') {
            typeBadge = '<span class="badge bg-danger bg-opacity-10 text-danger">차감(Use)</span>';
            colorClass = 'text-danger fw-bold';
            if (amt > 0) sign = '-'; 
        } else if (p.transaction_type === 'withdraw') {
            typeBadge = '<span class="badge bg-secondary">출금</span>';
        } else if (p.transaction_type === 'refund') {
            typeBadge = '<span class="badge bg-success">환불</span>';
        }

        // ★ 수정됨: 이름 매핑 (member_id 기준)
        const memberName = memberMap[p.member_id] || '미확인';
        const memberTextId = p.member_id || '-';

        tbody.innerHTML += `
            <tr>
                <td class="small text-secondary">${dateStr}</td>
                <td class="fw-bold text-start ps-4">
                    ${memberName} 
                    <span class="small text-muted ms-1">(${memberTextId})</span>
                </td>
                <td>${typeBadge}</td>
                <td class="text-end pe-4 ${colorClass}">${sign}${Math.abs(amt).toLocaleString()}</td>
                <td class="text-start small text-truncate" style="max-width: 250px;" title="${p.reason || ''}">
                    ${p.reason || '-'}
                </td>
            </tr>
        `;
    });
}

// 기존 openDividendModal 함수 교체
function openDividendModal() {
    // 필드 초기화
    document.getElementById('dv-member-id').value = '';
    document.getElementById('dv-member-name').value = '';
    document.getElementById('dv-amount').value = '';
    document.getElementById('dv-reason').value = '';
    
    // 엑셀 탭 초기화
    document.getElementById('div-excel-file').value = '';
    document.getElementById('div-excel-preview').style.display = 'none';
    
    // 첫 번째 탭 선택
    const firstTab = new bootstrap.Tab(document.querySelector('#dividendTab button[data-bs-target="#tab-div-single"]'));
    firstTab.show();

    new bootstrap.Modal(document.getElementById('dividendModal')).show();
}

// 4. 이용고배당 지급 실행 (RPC)
async function submitDividendGrant() {
    const textId = document.getElementById('dv-member-id').value;
    const amount = document.getElementById('dv-amount').value;
    const reason = document.getElementById('dv-reason').value;

    if(!textId || !amount || !reason) return myAlert("모든 항목을 입력해주세요.", "warning");

    // 용어 통일: 포인트 -> 이용고배당
    myConfirm(`[${textId}] 조합원에게 <br>이용고배당 <b>${amount}</b>원을 적용하시겠습니까?`, async () => {
        showLoading(true);
        
        // ★ 중요: RPC 함수명은 기존에 생성된 것이 있다면 그대로 씁니다.
        // 만약 'grant_point_manual'을 사용 중이라면 그대로 두고 UI만 배당으로 표시합니다.
        const { error } = await _supabase.rpc('grant_point_manual', {
            p_member_text_id: textId,
            p_amount: Number(amount),
            p_reason: reason,
            p_admin_email: document.getElementById('adminProfile').innerText
        });

        showLoading(false);

        if(error) {
            myAlert("처리 실패: " + error.message, "error");
        } else {
            myAlert("이용고배당 적용이 완료되었습니다.");
            bootstrap.Modal.getInstance(document.getElementById('dividendModal')).hide();
            fetchGlobalDividends(); // 목록 새로고침
        }
    });
}    
    let g_excel_data = []; // 업로드한 데이터 임시 저장

// 엑셀 양식 다운로드
function downloadDividendTemplate() {
    const ws_data = [
        ["조합원ID", "금액", "사유"], // 헤더
        ["2024-001", "1000", "2025년 배당금"], // 예시
        ["2024-002", "500", "행사 참여"]
    ];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "배당일괄지급");
    XLSX.writeFile(wb, "이용고배당_일괄지급_양식.xlsx");
}

// 엑셀 파일 읽기
function readDividendExcel(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet); // 첫 줄 헤더 자동 인식

        if(json.length === 0) {
            alert('데이터가 없는 엑셀입니다.');
            return;
        }

        g_excel_data = json; // 전역 변수에 저장
        
        // 미리보기 렌더링 (최대 5개)
        const tbody = document.getElementById('div-excel-tbody');
        tbody.innerHTML = '';
        
        // 헤더 매핑 유연하게 (조합원ID, ID, 아이디 / 금액, point, amount / 사유, reason)
        const previewList = json.slice(0, 5);
        previewList.forEach(row => {
            const id = row['조합원ID'] || row['ID'] || row['아이디'] || '-';
            // 이름은 엑셀에 없을 수도 있음. 여기선 ID가 핵심.
            const amt = row['금액'] || row['amount'] || 0;
            const reason = row['사유'] || row['비고'] || '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${id}</td>
                    <td>-</td> 
                    <td>${Number(amt).toLocaleString()}</td>
                    <td>${reason}</td>
                </tr>
            `;
        });
        
        document.getElementById('div-excel-count').innerText = `총 ${json.length}건 대기 중`;
        document.getElementById('div-excel-preview').style.display = 'block';
    };
    reader.readAsArrayBuffer(file);
}

// 엑셀 데이터 일괄 적용
async function submitDividendBatch() {
    if(g_excel_data.length === 0) return alert("데이터가 없습니다.");

    myConfirm(`총 ${g_excel_data.length}건의 배당을 지급하시겠습니까?<br><small>시간이 조금 걸릴 수 있습니다.</small>`, async () => {
        showLoading(true);
        
        let successCnt = 0;
        let failCnt = 0;
        const adminEmail = document.getElementById('adminProfile').innerText;

        // ★ 한 건씩 순차 처리 (Batch RPC가 없으므로 반복 호출)
        // 100건 이상이면 느릴 수 있지만 가장 안전함.
        for (const row of g_excel_data) {
            const id = row['조합원ID'] || row['ID'] || row['아이디'];
            const amt = row['금액'] || row['amount'];
            const reason = row['사유'] || row['비고'] || '일괄지급';

            if(id && amt) {
                const { error } = await _supabase.rpc('grant_dividend_manual', {
                    p_member_text_id: String(id),
                    p_amount: Number(amt),
                    p_reason: String(reason),
                    p_admin_email: adminEmail
                });
                
                if(error) {
                    console.error(`ID ${id} 실패:`, error);
                    failCnt++;
                } else {
                    successCnt++;
                }
            } else {
                failCnt++;
            }
        }
        
        showLoading(false);
        myAlert(`완료되었습니다.<br>성공: ${successCnt}건, 실패: ${failCnt}건`);
        
        bootstrap.Modal.getInstance(document.getElementById('dividendModal')).hide();
        fetchGlobalDividends();
    });
}
    let g_search_target = ''; // 검색 요청한 출처 (dividend 등)

// 검색 모달 열기
function openMemberSearch(target) {
    g_search_target = target;
    document.getElementById('ms-keyword').value = '';
    document.getElementById('ms-result-list').innerHTML = '<div class="text-center py-4 text-muted x-small">이름을 입력하세요.</div>';
    new bootstrap.Modal(document.getElementById('memberSearchModal')).show();
    setTimeout(() => document.getElementById('ms-keyword').focus(), 500);
}

// 조합원 검색 실행 (메모리상 데이터 g_members 활용)
function searchMemberForModal() {
    const keyword = document.getElementById('ms-keyword').value.trim();
    const listEl = document.getElementById('ms-result-list');
    
    if(!keyword) return;

    // g_members가 비어있다면 한번 로드 시도 (또는 DB 직접 조회)
    // 여기서는 안전하게 RPC 대신 DB 직접 조회 (이름만)
    // 100명 이하라면 g_members 써도 되지만, 안전하게 DB 검색
    
    listEl.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';
    
    _supabase
        .from('coop_members')
        .select('id, name, member_id, phone, status')
        .ilike('name', `%${keyword}%`)
        .limit(10)
        .then(({ data, error }) => {
            if(error || !data || data.length === 0) {
                listEl.innerHTML = '<div class="text-center py-3 text-muted x-small">검색 결과가 없습니다.</div>';
                return;
            }
            
            listEl.innerHTML = '';
            data.forEach(m => {
                const phoneEnd = m.phone ? m.phone.slice(-4) : '????';
                listEl.innerHTML += `
                    <button class="list-group-item list-group-item-action py-2" onclick="selectMemberForModal('${m.member_id}', '${m.name}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold small">${m.name}</span>
                            <span class="badge bg-light text-dark border">${m.status}</span>
                        </div>
                        <div class="d-flex justify-content-between x-small text-muted mt-1">
                            <span>ID: ${m.member_id}</span>
                            <span>☎ ${phoneEnd}</span>
                        </div>
                    </button>
                `;
            });
        });
}

// 조합원 선택 시 처리
function selectMemberForModal(id, name) {
    if(g_search_target === 'dividend') {
        document.getElementById('dv-member-id').value = id;
        document.getElementById('dv-member-name').value = name;
    }
    // 다른 곳에서 쓸 경우 else if 추가

    // 모달 닫기
    bootstrap.Modal.getInstance(document.getElementById('memberSearchModal')).hide();
}

    // ================================================================
// [신규 기능] 업무 신청 관리 (Applications)
// ================================================================

let g_apps = []; // 데이터 저장용
let g_app_filter = 'pending'; // 현재 탭 상태

// 1. 신청 목록 불러오기
// [디버깅용] fetchApplications 함수
async function fetchApplications() {
    console.log("🚀 업무 신청 목록 조회 시작..."); // 1. 함수 실행 확인

    const tbody = document.getElementById('appListBody');
    if (!tbody) {
        console.error("❌ 에러: HTML에 id='appListBody'인 <tbody> 태그가 없습니다.");
        return;
    }

    tbody.innerHTML = '<tr><td colspan="7" class="py-5"><div class="spinner-border spinner-border-sm text-primary"></div> 로딩중...</td></tr>';

    const { data, error } = await _supabase
        .from('coop_applications')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(100);

    // 2. DB 응답 확인
    if (error) {
        console.error("❌ DB 에러 발생:", error);
        tbody.innerHTML = `<tr><td colspan="7" class="text-danger py-4">로딩 실패: ${error.message}</td></tr>`;
        return;
    }

    console.log("✅ 데이터 수신 성공:", data); // 데이터가 몇 개 왔는지 확인

    g_apps = data || [];
    
    // 3. 렌더링 직전 데이터 확인
    console.log("현재 필터 상태:", g_app_filter);
    
    renderAppList();
    updateAppBadges();
}

// 2. 화면 렌더링 (필터 적용)
function renderAppList() {
    const tbody = document.getElementById('appListBody');
    tbody.innerHTML = '';

    // 탭 필터링
    const list = g_apps.filter(item => {
        if (g_app_filter === 'pending') return item.status === 'pending';
        return true; // all
    });

    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-muted py-5">해당하는 신청 내역이 없습니다.</td></tr>';
        return;
    }

    const typeMap = { 'extra': '추가출자', 'reduction': '감자', 'withdraw': '탈퇴', 'connect': '계정연결' };

    list.forEach(app => {
        const dateStr = app.created_at.substring(0, 10);
        const amountStr = app.amount ? Number(app.amount).toLocaleString() + '원' : '-';
        
        // 상태 뱃지
        let statusBadge = `<span class="badge bg-secondary">${app.status}</span>`;
        let actionBtns = '-';

        if (app.status === 'pending') {
            statusBadge = `<span class="badge bg-warning text-dark">대기중</span>`;
            // ★ [승인/확인] 버튼 (클릭 시 DB 기록됨)
            actionBtns = `
                <button class="btn btn-sm btn-primary fw-bold py-0" onclick="processApp(${app.id}, 'approve', '${app.type}', ${app.amount})">
                    <i class="bi bi-check-lg"></i> 승인/확인
                </button>
                <button class="btn btn-sm btn-outline-danger py-0 ms-1" onclick="processApp(${app.id}, 'reject')">
                    반려
                </button>
            `;
        } else if (app.status === 'approved') {
            statusBadge = `<span class="badge bg-success">처리완료</span>`;
        } else if (app.status === 'rejected') {
            statusBadge = `<span class="badge bg-danger">반려됨</span>`;
        }

        tbody.innerHTML += `
            <tr>
                <td>${dateStr}</td>
                <td><span class="badge bg-light text-dark border">${typeMap[app.type] || app.type}</span></td>
                <td class="text-start ps-4">
                    <div class="fw-bold">${app.name}</div>
                    <small class="text-muted">${app.member_id}</small>
                </td>
                <td class="text-end fw-bold pe-3">${amountStr}</td>
                <td class="text-start text-truncate" style="max-width: 200px;">${app.reason || '-'}</td>
                <td>${statusBadge}</td>
                <td>${actionBtns}</td>
            </tr>
        `;
    });
}

// 3. 탭 전환 (대기중 / 전체)
function filterAppList(mode) {
    g_app_filter = mode;
    // 탭 스타일 변경
    const tabs = document.querySelectorAll('#app-sub-tabs .nav-link');
    tabs.forEach(t => t.classList.remove('active', 'fw-bold'));
    if(mode === 'pending') tabs[0].classList.add('active', 'fw-bold');
    else tabs[1].classList.add('active', 'fw-bold');
    
    renderAppList();
}

// 4. 승인/반려 실행 (핵심)
async function processApp(appId, action, type, amount) {
    let msg = "";
    if (action === 'reject') {
        msg = "이 신청을 반려하시겠습니까?";
    } else {
        // 승인 시 안내 메시지
        if (type === 'extra') msg = `[추가 출자] ${Number(amount).toLocaleString()}원 입금을 확인하셨습니까?\n승인 시 출자금 원장에 '입금' 기록됩니다.`;
        else if (type === 'reduction') msg = `[감자] ${Number(amount).toLocaleString()}원을 반환하셨습니까?\n승인 시 출자금 원장에 '차감(-)' 기록됩니다.`;
        else if (type === 'withdraw') msg = `[탈퇴] 반환금 지급을 완료하셨습니까?\n승인 시 출자금 원장에 '전액 차감' 기록됩니다.`;
        else msg = "이 신청을 승인 처리하시겠습니까?";
    }

    if (!confirm(msg)) return;

    showLoading(true);

    const { data, error } = await _supabase.rpc('admin_process_application', {
        p_app_id: appId,
        p_action: action,
        p_admin_id: (await _supabase.auth.getUser()).data.user.id
    });

    showLoading(false);

    if (error) {
        alert("처리 실패: " + error.message);
    } else {
        alert(data.message);
        fetchApplications(); // 목록 새로고침
        loadDashboard();     // 대시보드 갱신
    }
}

// 5. 뱃지 업데이트 (대시보드/사이드바)
function updateAppBadges() {
    const pendingCount = g_apps.filter(a => a.status === 'pending').length;
    
    // 대시보드 카드
    const dashEl = document.getElementById('dash-app-pending');
    if(dashEl) dashEl.innerText = pendingCount + '건';

    // 사이드바 뱃지
    const sideEl = document.getElementById('sidebar-app-badge');
    if(sideEl) {
        sideEl.innerText = pendingCount;
        if(pendingCount > 0) sideEl.classList.remove('hidden');
        else sideEl.classList.add('hidden');
    }
}

// ================================================================
// [신규 기능] 대리 접수 (Proxy)
// ================================================================

function openProxyModal() {
    document.getElementById('proxy-keyword').value = '';
    document.getElementById('proxy-member-name').value = '';
    document.getElementById('proxy-member-uid').value = '';
    document.getElementById('proxy-member-id').value = '';
    document.getElementById('proxy-amount').value = '';
    document.getElementById('proxy-reason').value = '';
    new bootstrap.Modal(document.getElementById('proxyModal')).show();
}

// 멤버 검색
async function searchProxyMember() {
    const key = document.getElementById('proxy-keyword').value.trim();
    if(key.length < 2) return alert("검색어를 2글자 이상 입력하세요.");

    const { data, error } = await _supabase
        .from('coop_members')
        .select('id, name, member_id')
        .or(`name.eq.${key},member_id.eq.${key},phone.eq.${key}`)
        .limit(1);

    if (data && data.length > 0) {
        const m = data[0];
        document.getElementById('proxy-member-name').value = `${m.name} (${m.member_id})`;
        document.getElementById('proxy-member-uid').value = m.id;
        document.getElementById('proxy-member-id').value = m.member_id;
    } else {
        document.getElementById('proxy-member-name').value = "검색 결과 없음";
        document.getElementById('proxy-member-uid').value = "";
    }
}

// 대리 등록 실행
async function submitProxyData() {
    const uid = document.getElementById('proxy-member-uid').value;
    const mid = document.getElementById('proxy-member-id').value; // 텍스트 ID
    const nameStr = document.getElementById('proxy-member-name').value.split(' (')[0]; // 이름만 추출
    const type = document.getElementById('proxy-type').value;
    const amount = document.getElementById('proxy-amount').value;
    const reason = document.getElementById('proxy-reason').value;

    if (!uid) return alert("신청자를 먼저 검색해주세요.");
    if (type !== 'withdraw' && (!amount || amount <= 0)) return alert("금액을 입력해주세요.");
    if (!reason) return alert("비고란에 접수 사유(전화 등)를 입력해주세요.");

    showLoading(true);

    // 직접 Insert (Pending 상태로)
    const { error } = await _supabase.from('coop_applications').insert({
        member_uid: uid,
        member_id: mid,
        name: nameStr,
        type: type,
        amount: Number(amount || 0),
        reason: '[대리접수] ' + reason,
        status: 'pending'
    });

    showLoading(false);

    if (error) {
        alert("등록 실패: " + error.message);
    } else {
        alert("접수되었습니다.\n목록에서 확인 후 승인 처리해주세요.");
        bootstrap.Modal.getInstance(document.getElementById('proxyModal')).hide();
        fetchApplications();
    }
}

</script>
</body>
</html>
