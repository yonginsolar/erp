<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜€ï¸ í˜‘ë™ì¡°í•© í†µí•© ê´€ë¦¬ì (ERP)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; }
        .sidebar .nav-link { color: rgba(255,255,255,0.8); margin-bottom: 5px; cursor: pointer; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 20px; }
        
        /* ë¡œê·¸ì¸ ê²Œì´íŠ¸ ìŠ¤íƒ€ì¼ */
        #login-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .spinner-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:2000; display:none; justify-content:center; align-items:center; }
    </style>
</head>

<body>

<div id="login-gate">
    <div class="login-box">
        <h2 class="fw-bold mb-4">ğŸ” ê´€ë¦¬ì ì ‘ì†</h2>
        <p class="text-muted small mb-3">Service Role Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>(ê¹ƒí—ˆë¸Œ ì†ŒìŠ¤ì½”ë“œì—ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</p>
        <input type="password" id="inputKey" class="form-control mb-3" placeholder="eyJh..." onkeyup="if(event.key=='Enter') initSystem()">
        <button class="btn btn-primary w-100 py-2 fw-bold" onclick="initSystem()">ì‹œìŠ¤í…œ ì ‘ì†</button>
    </div>
</div>

<div class="d-flex" id="main-system" style="display:none !important;">
    <div class="sidebar p-3 d-flex flex-column" style="width: 250px; flex-shrink: 0;">
        <h4 class="mb-4 fw-bold ps-2">â˜€ï¸ ì¡°í•© ERP</h4>
        <ul class="nav flex-column mb-auto">
            <li class="nav-item"><a class="nav-link active" onclick="switchTab('members')"><i class="bi bi-people-fill me-2"></i> ì¡°í•©ì› ëª…ë¶€</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('deposit')"><i class="bi bi-cash-coin me-2"></i> ì…ê¸ˆ ë§¤ì¹­</a></li>
            <li class="nav-item"><a class="nav-link" onclick="alert('ì¤€ë¹„ì¤‘')"><i class="bi bi-graph-up me-2"></i> í†µê³„/ë°°ë‹¹</a></li>
        </ul>
        <div class="mt-auto ps-2 text-white-50 small">
            <button class="btn btn-outline-light btn-sm w-100" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="flex-grow-1 p-4" style="height: 100vh; overflow-y: auto;">
        
        <div id="tab-members">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">ğŸ‘¥ ì¡°í•©ì› í†µí•© ë¦¬ìŠ¤íŠ¸</h3>
                <div>
                    <button class="btn btn-success btn-sm" onclick="downloadExcel()">
                        <i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button class="btn btn-outline-dark btn-sm ms-2" onclick="revealSecrets()">
                        <i class="bi bi-eye"></i> ì£¼ë¯¼ë²ˆí˜¸ ë³´ê¸°
                    </button>
                </div>
            </div>

            <div class="card p-3 mb-3">
                <div class="row g-2">
                    <div class="col-md-2">
                        <select id="filter-status" class="form-select form-select-sm" onchange="fetchMembers()">
                            <option value="all">âš¡ ìƒíƒœ ì „ì²´</option>
                            <option value="ì‹ ì²­">ì‹ ì²­</option>
                            <option value="ì •ìƒ" selected>ì •ìƒ</option>
                            <option value="íƒˆí‡´">íƒˆí‡´</option>
                            <option value="ì œëª…">ì œëª…</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="filter-payment" class="form-select form-select-sm" onchange="fetchMembers()">
                            <option value="all">ğŸ’° ë‚©ë¶€ ì „ì²´</option>
                            <option value="ë¯¸ë‚©">ë¯¸ë‚©</option>
                            <option value="ì™„ë‚©">ì™„ë‚©</option>
                            <option value="ì¼ë¶€ë‚©ë¶€">ì¼ë¶€ë‚©ë¶€</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                         <select id="filter-type" class="form-select form-select-sm" onchange="fetchMembers()">
                            <option value="all">ğŸ‘¤ ìœ í˜• ì „ì²´</option>
                            <option value="ê°œì¸">ê°œì¸</option>
                            <option value="ë‹¨ì²´">ë‹¨ì²´</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="search-keyword" class="form-control" placeholder="ì´ë¦„, ë²ˆí˜¸(ë’·4) ê²€ìƒ‰" onkeyup="if(event.key=='Enter') fetchMembers()">
                            <button class="btn btn-primary" onclick="fetchMembers()">ê²€ìƒ‰</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="memberTable">
                        <thead class="table-light">
                            <tr>
                                <th>No</th>
                                <th>ìœ í˜•</th>
                                <th>ì´ë¦„ (ì¡°í•©ì›ë²ˆí˜¸)</th>
                                <th>ì—°ë½ì²˜</th>
                                <th>ì£¼ë¯¼/ì‚¬ì—…ìë²ˆí˜¸</th>
                                <th>ì•½ì •ê¸ˆì•¡</th>
                                <th>ë‚©ë¶€ìƒíƒœ</th>
                                <th>íšŒì›ìƒíƒœ</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="memberListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-deposit" style="display:none;">
            <h3 class="fw-bold mb-4">ğŸ’° ì…ê¸ˆ ë‚´ì—­ ë§¤ì¹­</h3>
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5 class="fw-bold mb-3">1. ì€í–‰ ì—‘ì…€ ì—…ë¡œë“œ</h5>
                        <input type="file" id="depositFile" class="form-control mb-3" accept=".xlsx, .xls">
                        <button class="btn btn-primary w-100" onclick="processDepositFile()">ë§¤ì¹­ ë¶„ì„ ì‹œì‘</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">2. ë¶„ì„ ê²°ê³¼</h5>
                            <button class="btn btn-success btn-sm" id="btnApplyDeposit" style="display:none;" onclick="applyDeposits()">
                                ì„ íƒ í•­ëª© ìŠ¹ì¸ ë° ì €ì¥
                            </button>
                        </div>
                        <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="30"><input type="checkbox" id="checkAll" onclick="toggleAllChecks(this)"></th>
                                        <th>ì…ê¸ˆìëª…</th>
                                        <th>ê¸ˆì•¡</th>
                                        <th>ë§¤ì¹­ ê²°ê³¼</th>
                                    </tr>
                                </thead>
                                <tbody id="depositMatchBody">
                                    <tr><td colspan="4" class="text-center py-4">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="loading" class="spinner-overlay">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<script>
    const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
    let _supabase = null; // ì´ˆê¸°ì—” ë¹„ì–´ìˆìŒ
    let ADMIN_KEY = null;
    let allMembers = [];

    // [1] ì‹œìŠ¤í…œ ì ‘ì† (í‚¤ ì…ë ¥ í›„ ì‹¤í–‰)
// [ìˆ˜ì •ëœ ì ‘ì† í•¨ìˆ˜] ì—ëŸ¬ ì›ì¸ì„ ìì„¸íˆ ì•Œë ¤ì¤ë‹ˆë‹¤.
// [ìˆ˜ì •ëœ ì ‘ì† í•¨ìˆ˜] ê¸°ì¡´ ì„¸ì…˜(ì¼ë°˜ íšŒì›)ì˜ ë°©í•´ë¥¼ ì™„ë²½ ì°¨ë‹¨í•©ë‹ˆë‹¤.
    async function initSystem() {
        // 1. ê³µë°± ì œê±°
        const key = document.getElementById('inputKey').value.trim();
        
        if(!key) return alert('í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if(key.length < 50) return alert('í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. service_role í‚¤ê°€ ë§ë‚˜ìš”?');

        try {
            // â˜… [í•µì‹¬ ìˆ˜ì •] ì˜µì…˜ ì¶”ê°€!
            // ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì¼ë°˜ íšŒì› ì •ë³´ë¥¼ ì ˆëŒ€ ê°€ì ¸ì˜¤ì§€ ë§ë¼ê³  ëª…ë ¹í•©ë‹ˆë‹¤.
            _supabase = supabase.createClient(SUPABASE_URL, key, {
                auth: {
                    persistSession: false, // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ì§€ ë§ˆ!
                    autoRefreshToken: false, // í† í° ê°±ì‹ ë„ í•˜ì§€ ë§ˆ!
                    detectSessionInUrl: false // ì£¼ì†Œì°½ë„ ë³´ì§€ ë§ˆ!
                },
                global: {
                    headers: { 'Authorization': `Bearer ${key}` } // ê°•ì œë¡œ í—¤ë”ì— í‚¤ë¥¼ ë°•ì•„ë„£ìŒ
                }
            });

            ADMIN_KEY = key;
            
            showLoading(true);

            // 2. í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ (ê°€ì¥ ë‹¨ìˆœí•œ ê²ƒìœ¼ë¡œ)
            const { data, error } = await _supabase
                .from('coop_members')
                .select('id')
                .limit(1);

            showLoading(false);

            if(error) {
                console.error("ì ‘ì† ì—ëŸ¬:", error);
                // ì—¬ì „íˆ ì—ëŸ¬ê°€ ë‚œë‹¤ë©´, ê·¸ê±´ ì§„ì§œ í‚¤ê°€ í‹€ë¦° ê²ë‹ˆë‹¤.
                alert('ğŸš« ì ‘ì† ì‹¤íŒ¨!\n\nì—ëŸ¬: ' + error.message + '\n\n(ì°¸ê³ : Infinite recursionì´ ë˜ ëœ¬ë‹¤ë©´, ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì™„ì „íˆ ë¹„ìš°ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”)');
            } else {
                // ì„±ê³µ
                document.getElementById('login-gate').style.display = 'none';
                document.getElementById('main-system').style.setProperty('display', 'flex', 'important');
                fetchMembers(); 
            }
        } catch(e) {
            showLoading(false);
            alert('ğŸ’¥ ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + e.message);
        }
    }

    function logout() {
        location.reload(); // ìƒˆë¡œê³ ì¹¨í•˜ë©´ í‚¤ê°€ ë‚ ì•„ê°€ì„œ ë¡œê·¸ì•„ì›ƒë¨
    }

    // [2] ë°ì´í„° ë¡œë“œ (ì¡°íšŒ)
    async function fetchMembers() {
        showLoading(true);
        const status = document.getElementById('filter-status').value;
        const payment = document.getElementById('filter-payment').value;
        const type = document.getElementById('filter-type').value;
        const search = document.getElementById('search-keyword').value.trim();

        let query = _supabase.from('coop_members').select('*').order('created_at', { ascending: false });

        if(status !== 'all') query = query.eq('status', status);
        if(payment !== 'all') query = query.eq('payment_status', payment);
        if(type !== 'all') query = query.eq('member_type', type);
        if(search) query = query.or(`name.ilike.%${search}%,phone.ilike.%${search}%`);

        const { data, error } = await query;
        showLoading(false);

        if(error) return alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);

        allMembers = data; 
        renderTable(data);
    }

    function renderTable(data) {
        const tbody = document.getElementById('memberListBody');
        tbody.innerHTML = '';
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return;
        }

        data.forEach((m, idx) => {
            const date = new Date(m.created_at).toLocaleDateString();
            const badgeClass = m.status === 'ì •ìƒ' ? 'bg-success' : (m.status === 'ì‹ ì²­' ? 'bg-warning' : 'bg-secondary');
            const payClass = m.payment_status === 'ì™„ë‚©' ? 'text-success fw-bold' : 'text-danger';
            
            // ì£¼ë¯¼ë²ˆí˜¸ í‘œì‹œ (ê¸°ë³¸ì€ ì•”í˜¸í™”ëœ ìƒíƒœ or ê°€ë¦¼)
            // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ 'ë³´ê¸° ë²„íŠ¼'ì„ ëˆŒëŸ¬ì•¼ ë³´ì´ê²Œ ì²˜ë¦¬
            let rrnDisplay = `<span class="text-muted small">ğŸ”’ ê°€ë ¤ì§</span>`;
            if(m.decrypted_rrn) { // ë³µí˜¸í™”ëœ ë°ì´í„°ê°€ ìˆë‹¤ë©´ í‘œì‹œ
                rrnDisplay = `<span class="text-primary fw-bold">${m.decrypted_rrn}</span>`;
            }

            const row = `
                <tr>
                    <td>${data.length - idx}</td>
                    <td><span class="badge bg-light text-dark border">${m.member_type}</span></td>
                    <td>
                        <div class="fw-bold">${m.name}</div>
                        <div class="small text-muted">${m.member_id || '-'}</div>
                    </td>
                    <td>${m.phone}</td>
                    <td id="rrn-cell-${m.id}">${rrnDisplay}</td>
                    <td>${m.pledge_amount.toLocaleString()}ì›</td>
                    <td class="${payClass}">${m.payment_status}</td>
                    <td><span class="badge ${badgeClass} status-badge">${m.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="alert('ìƒì„¸ë³´ê¸°/ìˆ˜ì • ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€')">ê´€ë¦¬</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // [3] ì£¼ë¯¼ë²ˆí˜¸ ë³µí˜¸í™” (ë¡œê·¸ì¸í•œ í‚¤ ì‚¬ìš©)
    async function revealSecrets() {
        if(!confirm("í™”ë©´ì— ì£¼ë¯¼ë²ˆí˜¸ë¥¼ í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê³µê³µì¥ì†Œ ì£¼ì˜)")) return;
        
        showLoading(true);
        // DB í•¨ìˆ˜ í˜¸ì¶œ (ì•„ê¹Œ ë§Œë“  get_decrypted_member)
        const { data, error } = await _supabase.rpc('get_decrypted_member', { p_secret_key: ADMIN_KEY });
        showLoading(false);

        if(error) return alert('ë³µí˜¸í™” ì‹¤íŒ¨: ' + error.message);

        // ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì— ë³‘í•©í•´ì„œ í™”ë©´ ê°±ì‹ 
        data.forEach(decrypted => {
            const target = allMembers.find(m => m.id === decrypted.id);
            if(target) target.decrypted_rrn = decrypted.rrn_decrypted; // ë©”ëª¨ë¦¬ì—ë§Œ ì ì‹œ ì €ì¥
        });
        
        renderTable(allMembers); // í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    // [4] ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë³µí˜¸í™”ëœ ì •ë³´ í¬í•¨ ì—¬ë¶€ ì„ íƒ)
    async function downloadExcel() {
        let exportData = allMembers;
        
        const includeSecret = confirm("ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ì™€ ê³„ì¢Œë²ˆí˜¸ë¥¼ í¬í•¨í•´ì„œ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n[í™•ì¸] í¬í•¨ (ë³´ì•ˆì£¼ì˜)\n[ì·¨ì†Œ] ë¯¸í¬í•¨ (ê¸°ë³¸ì •ë³´ë§Œ)");
        
        if(includeSecret) {
            const pwd = prompt("ê´€ë¦¬ì í‚¤ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•˜ì„¸ìš” (ë³´ì•ˆ í™•ì¸)");
            if(pwd !== ADMIN_KEY) return alert("í‚¤ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            
            showLoading(true);
            const { data, error } = await _supabase.rpc('get_decrypted_member', { p_secret_key: ADMIN_KEY });
            showLoading(false);
            if(error) return alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
            
            // ë°ì´í„° í•©ì¹˜ê¸°
            exportData = allMembers.map(m => {
                const secret = data.find(d => d.id === m.id);
                return { ...m, ...secret }; // ì •ë³´ ë³‘í•©
            });
        }

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ì¡°í•©ì›ëª…ë¶€");
        XLSX.writeFile(wb, "ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›_ì¡°í•©ì›ëª…ë¶€_" + new Date().toLocaleDateString() + ".xlsx");
    }

    // [5] ì—‘ì…€ ì—…ë¡œë“œ ë° ë§¤ì¹­
    function processDepositFile() {
        const fileInput = document.getElementById('depositFile');
        if(!fileInput.files.length) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            matchDeposits(jsonData);
        };
        reader.readAsArrayBuffer(file);
    }

    function matchDeposits(deposits) {
        const tbody = document.getElementById('depositMatchBody');
        tbody.innerHTML = '';
        let matchCount = 0;

        deposits.forEach(row => {
            // ì€í–‰ ì—‘ì…€ ì¹¼ëŸ¼ëª… ëŒ€ì‘ (ìœ ë™ì )
            const name = row['ì…ê¸ˆìëª…'] || row['ì„±ëª…'] || row['ë³´ë‚¸ë¶„'] || row['ê¸°ì¬ë‚´ìš©']; 
            const amount = row['ì…ê¸ˆì•¡'] || row['ê±°ë˜ê¸ˆì•¡'] || row['ê¸ˆì•¡'] || row['ë§¡ê¸°ì‹ ê¸ˆì•¡']; 
            
            if(!name || !amount) return; 

            // ë§¤ì¹­ ë¡œì§: ì´ë¦„ë§Œ ê°™ìœ¼ë©´ ì¼ë‹¨ ë§¤ì¹­ í›„ë³´
            // (ë™ëª…ì´ì¸ì€ ì¶”í›„ member_idë‚˜ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ë¡œ ì •ë°€í•˜ê²Œ í•„í„°ë§ í•„ìš”)
            const matched = allMembers.find(m => m.name === name); 
            
            let resultHtml = `<span class="text-danger">âŒ ë¶ˆì¼ì¹˜ (ì‹ ê·œ/ë™ëª…ì´ì¸)</span>`;
            let checkbox = '';
            
            if(matched) {
                // ê¸ˆì•¡ê¹Œì§€ ì¼ì¹˜í•˜ë©´ ìë™ ìŠ¹ì¸ ëŒ€ìƒ
                if(matched.pledge_amount == amount) {
                    resultHtml = `<span class="text-success fw-bold">âœ… ì™„ì „ì¼ì¹˜ (${matched.name})</span>`;
                    checkbox = `<input type="checkbox" class="deposit-check" value="${matched.id}" data-amount="${amount}" data-name="${name}" checked>`;
                    matchCount++;
                } else {
                    resultHtml = `<span class="text-warning fw-bold">âš ï¸ ê¸ˆì•¡ìƒì´ (ì•½ì •:${matched.pledge_amount})</span>`;
                    checkbox = `<input type="checkbox" class="deposit-check" value="${matched.id}" data-amount="${amount}" data-name="${name}">`;
                }
            }

            tbody.innerHTML += `
                <tr>
                    <td>${checkbox}</td>
                    <td>${name}</td>
                    <td>${parseInt(amount).toLocaleString()}</td>
                    <td>${resultHtml}</td>
                </tr>
            `;
        });

        if(matchCount > 0) {
            document.getElementById('btnApplyDeposit').style.display = 'block';
            document.getElementById('btnApplyDeposit').innerText = `${matchCount}ê±´ ìŠ¹ì¸ ë° ì €ì¥`;
        } else {
            document.getElementById('btnApplyDeposit').style.display = 'none';
        }
    }

    async function applyDeposits() {
        const checks = document.querySelectorAll('.deposit-check:checked');
        if(checks.length === 0) return alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        if(!confirm(`${checks.length}ê±´ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        showLoading(true);
        let success = 0;

        for(const chk of checks) {
            const uuid = chk.value;
            const amount = chk.getAttribute('data-amount');
            const depositor = chk.getAttribute('data-name');
            
            // 1. ì…ê¸ˆ ì¥ë¶€(coop_payments)ì— ì¶”ê°€
            const { error: err1 } = await _supabase.from('coop_payments').insert([{
                member_uuid: uuid,
                member_id: allMembers.find(m=>m.id === uuid).member_id, // í…ìŠ¤íŠ¸ ë²ˆí˜¸ë„ ê°™ì´ ì €ì¥
                amount: amount,
                depositor_name: depositor,
                deposit_date: new Date(), // ì˜¤ëŠ˜ ë‚ ì§œ
                status: 'ì™„ë£Œ',
                category: 'ê°€ì…ì¶œìê¸ˆ'
            }]);

            // 2. íšŒì› ìƒíƒœ ë³€ê²½ (ë¯¸ë‚© -> ì™„ë‚©)
            if(!err1) {
                const { error: err2 } = await _supabase.from('coop_members').update({ payment_status: 'ì™„ë‚©' }).eq('id', uuid);
                if(!err2) success++;
            }
        }
        showLoading(false);
        alert(`${success}ê±´ ì²˜ë¦¬ ì™„ë£Œ`);
        fetchMembers(); // ëª©ë¡ ê°±ì‹ 
        document.getElementById('tab-members').click(); // íƒ­ ì´ë™
        switchTab('members');
    }

    // UI ìœ í‹¸
    function switchTab(tab) {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        // íƒ­ í™œì„±í™” ì²˜ë¦¬ëŠ” ìƒëµ(ê°„ë‹¨êµ¬í˜„)
        if(tab === 'members') {
            document.getElementById('tab-members').style.display = 'block';
            document.getElementById('tab-deposit').style.display = 'none';
        } else {
            document.getElementById('tab-members').style.display = 'none';
            document.getElementById('tab-deposit').style.display = 'block';
        }
    }
    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
    function toggleAllChecks(src) { document.querySelectorAll('.deposit-check').forEach(c => c.checked = src.checked); }
</script>

</body>
</html>
