<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜€ï¸ í˜‘ë™ì¡°í•© í†µí•© ê´€ë¦¬ì</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-menu { padding: 20px 10px; overflow-y: auto; flex-grow: 1; }
        .nav-link { color: rgba(255,255,255,0.75); padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; font-weight: 600; }
        .nav-link i { margin-right: 12px; font-size: 1.1rem; }
        .menu-category { font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 20px 15px 10px; font-weight: 700; letter-spacing: 1px; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .main-content { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 30px; background: #f8f9fa; }
        .content-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ & ìœ í‹¸ */
        #login-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); text-align: center; }
        .hidden { display: none !important; }
        .table th { font-size: 13px; background-color: #f1f3f5; font-weight: 600; }
        .table td { font-size: 14px; vertical-align: middle; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* íƒ­ ê¸€ì”¨ ìƒ‰ìƒ ê°•ì œ ìˆ˜ì • */
        .nav-tabs .nav-link { color: #495057 !important; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #0d6efd !important; border-bottom: 2px solid #0d6efd; }
    </style>
</head>

<body>

    <div id="login-gate">
        <div class="login-box">
            <h3 class="fw-bold mb-4">ğŸ” ê´€ë¦¬ì ì ‘ì†</h3>
            <div class="mb-3 text-start">
                <label class="form-label small fw-bold">ì´ë©”ì¼ ì£¼ì†Œ</label>
                <input type="email" id="adminEmail" class="form-control" placeholder="name@coop.com">
            </div>
            <button class="btn btn-primary w-100 py-2 fw-bold" id="btnLogin" onclick="sendLoginLink()">ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°</button>
            <div id="loginMsg" class="mt-3 text-success small" style="display:none;"></div>
        </div>
    </div>

    <div class="d-flex hidden" id="main-system">
        <div class="sidebar">
            <div class="sidebar-header">
                <h5 class="fw-bold m-0">â˜€ï¸ í˜‘ë™ì¡°í•© ERP <span class="badge bg-warning text-dark" style="font-size:0.6em; vertical-align:middle;">v1.1.0</span></h5>
                <small class="text-white-50" id="adminProfile">ì ‘ì†ì¤‘...</small>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-category">íšŒì› ë° ìê¸ˆ</div>
                <a class="nav-link active" onclick="switchTab('members')"><i class="bi bi-people-fill"></i> ì¡°í•©ì› ê´€ë¦¬</a>
                <a class="nav-link" onclick="switchTab('deposit')"><i class="bi bi-cash-coin"></i> ì…ê¸ˆ ë§¤ì¹­</a>

                <div class="menu-category">ìš´ì˜ ê´€ë¦¬</div>
                <a class="nav-link" onclick="switchTab('notices')"><i class="bi bi-megaphone"></i> ê³µì§€ì‚¬í•­ ê´€ë¦¬</a>

                <div class="menu-category">í™ˆí˜ì´ì§€ ê´€ë¦¬</div>
                <a class="nav-link" onclick="switchTab('site')"><i class="bi bi-window-sidebar"></i> ì‚¬ì´íŠ¸ ì»¨í…ì¸ </a>

                <div class="mt-4 pt-4 border-top border-secondary">
                    <a class="nav-link text-warning" onclick="location.href='index.html'"><i class="bi bi-box-arrow-up-right"></i> í™ˆí˜ì´ì§€ ë°”ë¡œê°€ê¸°</a>
                    <a class="nav-link text-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="tab-members" class="tab-pane active">
                <div class="content-header">
                    <h3>ğŸ‘¥ ì¡°í•©ì› í†µí•© ê´€ë¦¬</h3>
                    <button class="btn btn-success btn-sm" onclick="openExcelModal()"><i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="text" id="search-keyword" class="form-control form-control-sm" placeholder="ì´ë¦„, ë²ˆí˜¸ ê²€ìƒ‰" onkeyup="if(event.key=='Enter') fetchMembers()"></div>
                            <div class="col-md-2"><button class="btn btn-primary btn-sm w-100" onclick="fetchMembers()">ê²€ìƒ‰</button></div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th>No</th><th>ìœ í˜•</th><th>ì´ë¦„/ë²ˆí˜¸</th><th>ìƒë…„ì›”ì¼/ì‚¬ì—…ì</th><th>ì—°ë½ì²˜</th><th>ë‚©ì…ì´ì•¡(ref)</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="memberListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-deposit" class="tab-pane">
                <div class="content-header"><h3>ğŸ’° ì…ê¸ˆ ë‚´ì—­ ë§¤ì¹­</h3></div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <h6 class="fw-bold mb-3">1. ì€í–‰ ì—‘ì…€ ì—…ë¡œë“œ</h6>
                            <input type="file" id="depositFile" class="form-control mb-3" onchange="readExcel(this)">
                            <div class="small text-muted">ì—‘ì…€ íŒŒì¼ì— 'ì…ê¸ˆìëª…' ë˜ëŠ” 'ì„±ëª…', 'ì…ê¸ˆì•¡' ì¹¼ëŸ¼ì´ ìˆì–´ì•¼ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.</div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <h6 class="fw-bold mb-3">2. ë§¤ì¹­ ê²°ê³¼</h6>
                            <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
                                <table class="table table-sm">
                                    <thead style="position:sticky; top:0; background:white;"><tr><th>ì…ê¸ˆìëª…</th><th>ì…ê¸ˆì•¡</th><th>ë§¤ì¹­ëœ ì¡°í•©ì›</th></tr></thead>
                                    <tbody id="depositResultBody"><tr><td colspan="3" class="text-center text-muted py-5">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-notices" class="tab-pane">
                <div class="content-header">
                    <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
                    <button class="btn btn-primary btn-sm" onclick="openNoticeModal()"><i class="bi bi-pencil"></i> ê³µì§€ ì‘ì„±</button>
                </div>
                <div class="mb-3"><label class="form-label small">ë‚´ìš©</label><textarea id="notice-content" class="form-control" rows="5"></textarea></div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th>ë‚ ì§œ</th><th>ë¶„ë¥˜</th><th>ì œëª©</th><th>íŒì—…</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="noticeListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

<div id="tab-site" class="tab-pane">
                <div class="content-header"><h3>ğŸ–¥ï¸ í™ˆí˜ì´ì§€ ì»¨í…ì¸  ê´€ë¦¬</h3></div>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#sub-sections" onclick="setTimeout(fetchSections,100)">
                            ì„¹ì…˜ ì„¤ì • (ON/OFF)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#sub-plants" onclick="setTimeout(fetchPlants,100)">
                            ë°œì „ì†Œ í˜„í™©
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#sub-history" onclick="setTimeout(fetchHistory,100)">
                            ì—°í˜ (History)
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="sub-sections">
                        <div class="alert alert-info small">
                            <i class="bi bi-info-circle-fill"></i> í™ˆí˜ì´ì§€ì˜ ë©”ë‰´ì™€ ë³¸ë¬¸ ì„¹ì…˜ì„ ë„ê³  ì¼¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì²´í¬ í•´ì œ ì‹œ ì¦‰ì‹œ ë°˜ì˜)
                        </div>
                        <table class="table table-bordered bg-white text-center">
                            <thead class="table-light"><tr><th>ìˆœì„œ</th><th>ì„¹ì…˜ ì´ë¦„(ID)</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="sectionListBody">
                                </tbody>
                        </table>
                    </div>
                    
                    <div class="tab-pane fade" id="sub-plants">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="openPlantModal()">+ ë°œì „ì†Œ ì¶”ê°€</button>
                        </div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ìˆœì„œ</th><th>ë°œì „ì†Œëª…</th><th>ìš©ëŸ‰(kW)</th><th>ìƒíƒœ</th><th>ëª¨ë‹ˆí„°ë§</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="plantListBody"></tbody>
                        </table>
                    </div>

                    <div class="tab-pane fade" id="sub-history">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="openHistoryModal()">+ ì—°í˜ ì¶”ê°€</button>
                        </div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ë‚ ì§œ</th><th>ì œëª©</th><th>ë‚´ìš©</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="historyListBody"></tbody>
                        </table>
                    </div>

                </div>
            </div>
    </div>

    <div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:none; justify-content:center; align-items:center; z-index:9999;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div class="modal fade" id="excelModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜µì…˜</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="excelOption" value="public" checked onchange="togglePwd(false)">
                        <label class="form-check-label">ì¼ë°˜ìš© (ê¸°ë³¸ ì •ë³´)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="excelOption" value="secret" onchange="togglePwd(true)">
                        <label class="form-check-label text-danger">ë³´ì•ˆìš© (ì£¼ë¯¼ë²ˆí˜¸/ê³„ì¢Œ í¬í•¨)</label>
                    </div>
                    <div class="mt-3" id="pwdArea" style="display:none;">
                        <input type="password" id="decryptKey" class="form-control form-control-sm" placeholder="ì•”í˜¸í™” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-success" onclick="downloadExcel()">ë‹¤ìš´ë¡œë“œ</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="memberEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">íšŒì› ì •ë³´ ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3"><label class="form-label small">ì´ë¦„</label><input type="text" id="edit-name" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ì—°ë½ì²˜</label><input type="text" id="edit-phone" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ìƒíƒœ</label><select id="edit-status" class="form-select"><option value="ì •ìƒ">ì •ìƒ</option><option value="íƒˆí‡´">íƒˆí‡´</option><option value="ì œëª…">ì œëª…</option></select></div>
                    <div class="mb-3"><label class="form-label small">ë¹„ê³ </label><textarea id="edit-note" class="form-control" rows="3"></textarea></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveMember()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="noticeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ê³µì§€ì‚¬í•­ ì‘ì„±</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="notice-id">
                    <div class="mb-3"><label class="form-label small">ì œëª©</label><input type="text" id="notice-title" class="form-control"></div>
                    <div class="row mb-3">
                        <div class="col"><label class="form-label small">ë¶„ë¥˜</label><select id="notice-category" class="form-select"><option>ê³µì§€</option><option>ì†Œì‹</option><option>ë³´ë„ìë£Œ</option></select></div>
                        <div class="col"><label class="form-label small">ìƒíƒœ</label><select id="notice-status" class="form-select"><option value="published">ê²Œì‹œ</option><option value="draft">ì„ì‹œì €ì¥</option></select></div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="notice-popup">
                        <label class="form-check-label small">ë©”ì¸ íŒì—…ìœ¼ë¡œ ë„ìš°ê¸°</label>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveNotice()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="plantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ë°œì „ì†Œ ì •ë³´</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="plant-id">
                    <div class="mb-3"><label class="form-label small">ë°œì „ì†Œëª…</label><input type="text" id="plant-name" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ì„¤ë¹„ìš©ëŸ‰ (kW)</label><input type="number" id="plant-capacity" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ìˆœì„œ (ìˆ«ì)</label><input type="number" id="plant-order" class="form-control" value="0"></div>
                    <div class="mb-3"><label class="form-label small">ìƒíƒœ</label><select id="plant-status" class="form-select"><option>ìš´ì˜ì¤‘</option><option>ê³µì‚¬ì¤‘</option><option>ì¤€ë¹„ì¤‘</option></select></div>
                    <div class="mb-3"><label class="form-label small">ëª¨ë‹ˆí„°ë§ URL (ì„ íƒ)</label><input type="text" id="plant-url" class="form-control" placeholder="http://..."></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="savePlant()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ì—°í˜ ë“±ë¡</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="hist-id">
                    <div class="mb-3"><label class="form-label small">ë‚ ì§œ</label><input type="date" id="hist-date" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ì œëª©</label><input type="text" id="hist-title" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ë‚´ìš© (ì„ íƒ)</label><textarea id="hist-content" class="form-control" rows="3"></textarea></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveHistory()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // â˜… Supabase ì„¤ì • (Anon Key ì‚¬ìš© - RPC ë³´ì•ˆìœ¼ë¡œ ì•ˆì „í•¨)
        const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ì „ì—­ ë³€ìˆ˜
        let g_members = [];

        // [ì´ˆê¸°í™”] ì„¸ì…˜ ì²´í¬ ë° ê¶Œí•œ í™•ì¸
        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) checkAdmin(session.user);
            else document.getElementById('login-gate').classList.remove('hidden');
        };

        // [ê¶Œí•œ ì²´í¬] RPC í•¨ìˆ˜ë¡œ ë³´ì•ˆ ê²€ì¦ (ë¬´í•œ ë£¨í”„ ë°©ì§€ë¨)
        async function checkAdmin(user) {
            showLoading(true);
            const { data: role } = await _supabase.rpc('get_my_role');
            showLoading(false);
            if (role === 'admin') {
                document.getElementById('login-gate').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                document.getElementById('adminProfile').innerText = user.email;
                fetchMembers(); // ì²« í™”ë©´ ë¡œë“œ
            } else {
                alert(`â›” ì ‘ê·¼ ê±°ë¶€: ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê³„ì •: ${user.email})`);
                await _supabase.auth.signOut();
                location.href = 'index.html';
            }
        }

        // [ë¡œê·¸ì¸] ë§¤ì§ë§í¬ ì „ì†¡
        async function sendLoginLink() {
            const email = document.getElementById('adminEmail').value;
            if(!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
            const btn = document.getElementById('btnLogin');
            btn.innerText = "ì „ì†¡ì¤‘..."; btn.disabled = true;
            
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
            
            if(error) { 
                alert(error.message); btn.innerText = "ë‹¤ì‹œ ì‹œë„"; btn.disabled = false;
            } else { 
                document.getElementById('loginMsg').innerText = "ì´ë©”ì¼í•¨ì—ì„œ ë¡œê·¸ì¸ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”!";
                document.getElementById('loginMsg').style.display = 'block';
                btn.classList.add('hidden');
            }
        }

        // ================================================================
        // [ê¸°ëŠ¥ 1] ì¡°í•©ì› ê´€ë¦¬ (RPC ì‚¬ìš©)
        // ================================================================
        async function fetchMembers() {
            showLoading(true);
            const keyword = document.getElementById('search-keyword').value;
            
            // RPC í˜¸ì¶œ (ë³´ì•ˆ ìš°íšŒí•˜ì—¬ ë°ì´í„° íšë“)
            const { data: members, error: err1 } = await _supabase.rpc('get_members_secure');
            const { data: payments, error: err2 } = await _supabase.rpc('get_payments_secure');
            showLoading(false);

            if(err1) return console.error(err1);
            g_members = members || [];

            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '';
            
            let filtered = members;
            if(keyword) filtered = members.filter(m => (m.name+m.phone).includes(keyword));

            if(!filtered || filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            filtered.forEach((m, idx) => {
                // ë‚©ì…ê¸ˆ ë§¤ì¹­
                const pay = payments ? (payments.find(p => p.member_uuid === m.id)?.total_amount || 0) : 0;
                
                // ì£¼ë¯¼ë²ˆí˜¸ í¬ë§·íŒ…
                let rrnShow = m.rrn_display || '-';
                if(m.member_type !== 'ë‹¨ì²´' && rrnShow.length > 6) {
                     const y = rrnShow.charAt(7)=='1'||rrnShow.charAt(7)=='2'?'19':'20';
                     rrnShow = `${y}${rrnShow.substring(0,2)}.${rrnShow.substring(2,4)}.${rrnShow.substring(4,6)}`;
                } else if(m.member_type === 'ë‹¨ì²´') {
                    rrnShow = `<span class="badge bg-light text-secondary border">ì‚¬ì—…ì</span> ${rrnShow}`;
                }

                tbody.innerHTML += `<tr>
                    <td>${filtered.length - idx}</td>
                    <td><span class="badge bg-light text-dark border">${m.member_type}</span></td>
                    <td>${m.name}<br><small class="text-muted">${m.member_id||''}</small></td>
                    <td>${rrnShow}</td>
                    <td>${m.phone}</td>
                    <td class="fw-bold text-primary">${pay.toLocaleString()}ì›</td>
                    <td>${m.status}</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="openMemberEdit('${m.id}')">ê´€ë¦¬</button></td>
                </tr>`;
            });
        }

        // íšŒì› ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openMemberEdit(id) {
            const m = g_members.find(x => x.id === id);
            if(!m) return;
            document.getElementById('edit-id').value = m.id;
            document.getElementById('edit-name').value = m.name;
            document.getElementById('edit-phone').value = m.phone;
            document.getElementById('edit-status').value = m.status;
            document.getElementById('edit-note').value = m.note || '';
            new bootstrap.Modal(document.getElementById('memberEditModal')).show();
        }

        // íšŒì› ì •ë³´ ì €ì¥ (RPC í˜¸ì¶œ)
        async function saveMember() {
            const updates = {
                p_id: document.getElementById('edit-id').value,
                p_name: document.getElementById('edit-name').value,
                p_phone: document.getElementById('edit-phone').value,
                p_status: document.getElementById('edit-status').value,
                p_note: document.getElementById('edit-note').value
            };
            
            showLoading(true);
            const { error } = await _supabase.rpc('update_member_secure', updates);
            showLoading(false);

            if(error) alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            else {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                bootstrap.Modal.getInstance(document.getElementById('memberEditModal')).hide();
                fetchMembers();
            }
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë³´ì•ˆ/ì¼ë°˜)
        function togglePwd(show) { document.getElementById('pwdArea').style.display = show ? 'block' : 'none'; }
        function openExcelModal() { new bootstrap.Modal(document.getElementById('excelModal')).show(); }
        
        async function downloadExcel() {
            const type = document.querySelector('input[name="excelOption"]:checked').value;
            let dataToExport = [];
            
            if(type === 'secret') {
                const pwd = document.getElementById('decryptKey').value;
                if(!pwd) return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                // ë³´ì•ˆ ë°ì´í„°ëŠ” RPCë¡œ ê°€ì ¸ì™€ì•¼ í•¨ (ì—¬ê¸°ì„œëŠ” êµ¬í˜„ ìƒëµ ê°€ëŠ¥í•˜ë©´ ìƒëµí•˜ê² ì§€ë§Œ, ì™„ì „íŒ ìš”ì²­ì´ë¯€ë¡œ ë¡œì§ë§Œ ë‘¡ë‹ˆë‹¤)
                // ì‹¤ì œë¡œëŠ” get_decrypted_member ê°™ì€ í•¨ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. 
                // ì¼ë‹¨ì€ í˜„ì¬ ë©”ëª¨ë¦¬ì— ìˆëŠ” g_membersë¡œ ì§„í–‰í•˜ë˜ ì£¼ë¯¼ë²ˆí˜¸ëŠ” ë§ˆìŠ¤í‚¹ëœ ìƒíƒœë¡œ ë‚˜ê°‘ë‹ˆë‹¤.
                alert('ì£¼ì˜: í˜„ì¬ ë³´ì•ˆìš© ë³µí˜¸í™” RPCê°€ ì—°ê²°ë˜ì§€ ì•Šì•„ ê¸°ë³¸ ì •ë³´ë§Œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.');
                dataToExport = g_members;
            } else {
                dataToExport = g_members;
            }

            const excelData = dataToExport.map(m => ({
                "ì¡°í•©ì›ë²ˆí˜¸": m.member_id,
                "ì´ë¦„": m.name,
                "ì—°ë½ì²˜": m.phone,
                "ìƒíƒœ": m.status,
                "ì£¼ë¯¼/ì‚¬ì—…ì(ë§ˆìŠ¤í‚¹)": m.rrn_display
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì¡°í•©ì›ëª…ë¶€");
            XLSX.writeFile(wb, "ì¡°í•©ì›ëª…ë¶€.xlsx");
            bootstrap.Modal.getInstance(document.getElementById('excelModal')).hide();
        }


        // ================================================================
        // [ê¸°ëŠ¥ 2] ì…ê¸ˆ ë§¤ì¹­ (ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—‘ì…€ ì²˜ë¦¬)
        // ================================================================
        function readExcel(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);
                
                const tbody = document.getElementById('depositResultBody');
                tbody.innerHTML = '';
                
                if(json.length === 0) { tbody.innerHTML='<tr><td colspan="3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }

                json.forEach(row => {
                    // ì—‘ì…€ ì¹¼ëŸ¼ëª… ìœ ì—°í•˜ê²Œ ì°¾ê¸°
                    const name = row['ì…ê¸ˆì'] || row['ì„±ëª…'] || row['ë³´ë‚¸ë¶„'] || row['ë‚´ìš©'];
                    const amt = row['ì…ê¸ˆì•¡'] || row['ê¸ˆì•¡'] || row['ê±°ë˜ê¸ˆì•¡'];
                    
                    if(name && amt) {
                        // ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­ ì‹œë„
                        const match = g_members.find(m => m.name === name.trim());
                        let matchHtml = `<span class="text-danger">ë§¤ì¹­ ì‹¤íŒ¨ (ì •ë³´ ì—†ìŒ)</span>`;
                        
                        if(match) {
                            matchHtml = `<span class="text-success fw-bold">${match.name} (${match.member_id})</span>`;
                        }

                        tbody.innerHTML += `<tr>
                            <td>${name}</td>
                            <td>${Number(amt).toLocaleString()}ì›</td>
                            <td>${matchHtml}</td>
                        </tr>`;
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }


        // ================================================================
        // [ê¸°ëŠ¥ 3] ê³µì§€ì‚¬í•­ ê´€ë¦¬
        // ================================================================
        async function fetchNotices() {
            // ì½ê¸°ëŠ” public ì •ì±…ì´ ìˆì–´ì„œ ë°”ë¡œ select ê°€ëŠ¥
            const { data } = await _supabase.from('coop_notices').select('*').order('created_at', {ascending:false});
            const tbody = document.getElementById('noticeListBody');
            tbody.innerHTML = '';
            
            if(!data || data.length===0) { tbody.innerHTML='<tr><td colspan="6" class="text-center py-3">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }

            data.forEach(n => {
                tbody.innerHTML += `<tr>
                    <td>${n.created_at.split('T')[0]}</td>
                    <td>${n.category}</td>
                    <td>${n.title}</td>
                    <td>${n.is_popup?'Y':'-'}</td>
                    <td>${n.status}</td>
                    <td><button class="btn btn-sm btn-light" onclick="openNoticeModal('${n.id}')">ìˆ˜ì •</button></td>
                </tr>`;
            });
        }
        
        let g_current_notice_id = null;
// ê³µì§€ ëª¨ë‹¬ ì—´ê¸° (ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° ì¶”ê°€)
        async function openNoticeModal(id) {
            g_current_notice_id = id || null;
            document.getElementById('notice-id').value = id || '';
            
            if(id) {
                const { data } = await _supabase.from('coop_notices').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('notice-title').value = data.title;
                    document.getElementById('notice-content').value = data.content || ''; // ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°
                    document.getElementById('notice-category').value = data.category;
                    document.getElementById('notice-status').value = data.status;
                    document.getElementById('notice-popup').checked = data.is_popup;
                }
            } else {
                document.getElementById('notice-title').value = '';
                document.getElementById('notice-content').value = ''; // ì´ˆê¸°í™”
                document.getElementById('notice-popup').checked = false;
            }
            new bootstrap.Modal(document.getElementById('noticeModal')).show();
        }

        // ê³µì§€ ì €ì¥ (ë‚´ìš© í¬í•¨í•´ì„œ ì „ì†¡)
        async function saveNotice() {
            const updates = {
                p_id: document.getElementById('notice-id').value || null,
                p_title: document.getElementById('notice-title').value,
                p_content: document.getElementById('notice-content').value, // ë‚´ìš© ì¶”ê°€
                p_category: document.getElementById('notice-category').value,
                p_status: document.getElementById('notice-status').value,
                p_is_popup: document.getElementById('notice-popup').checked
            };
            
            showLoading(true);
            const { error } = await _supabase.rpc('upsert_notice_secure', updates);
            showLoading(false);

            if(error) alert('ì €ì¥ ì—ëŸ¬: ' + error.message);
            else {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                bootstrap.Modal.getInstance(document.getElementById('noticeModal')).hide();
                fetchNotices();
            }
        }


        // ================================================================
        // [ê¸°ëŠ¥ 4] í™ˆí˜ì´ì§€ ì»¨í…ì¸  (ë°œì „ì†Œ, ì—°í˜)
        // ================================================================
        
        // --- ë°œì „ì†Œ ---
        async function fetchPlants() {
            const { data } = await _supabase.from('site_power_plants').select('*').order('display_order');
            const tbody = document.getElementById('plantListBody');
            tbody.innerHTML = '';
            if(!data) return;
            data.forEach(p => {
                tbody.innerHTML += `<tr>
                    <td>${p.display_order}</td>
                    <td>${p.name}</td>
                    <td>${p.capacity}kW</td>
                    <td>${p.status}</td>
                    <td><a href="${p.monitor_url||'#'}" target="_blank" class="text-truncate" style="max-width:100px; display:inline-block;">${p.monitor_url||'-'}</a></td>
                    <td><button class="btn btn-sm btn-light" onclick="openPlantModal('${p.id}')">ìˆ˜ì •</button></td>
                </tr>`;
            });
        }
        async function openPlantModal(id) {
            document.getElementById('plant-id').value = id || '';
            if(id) {
                const { data } = await _supabase.from('site_power_plants').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('plant-name').value = data.name;
                    document.getElementById('plant-capacity').value = data.capacity;
                    document.getElementById('plant-order').value = data.display_order;
                    document.getElementById('plant-status').value = data.status;
                    document.getElementById('plant-url').value = data.monitor_url || '';
                }
            } else {
                document.getElementById('plant-name').value = '';
                document.getElementById('plant-capacity').value = '';
                document.getElementById('plant-url').value = '';
            }
            new bootstrap.Modal(document.getElementById('plantModal')).show();
        }
        async function savePlant() {
            const updates = {
                p_id: document.getElementById('plant-id').value || null,
                p_name: document.getElementById('plant-name').value,
                p_capacity: document.getElementById('plant-capacity').value,
                p_status: document.getElementById('plant-status').value,
                p_display_order: document.getElementById('plant-order').value
                // p_monitor_url ì¶”ê°€ í•„ìš”í•¨. SQL í•¨ìˆ˜(upsert_plant_secure)ì— íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ì•¼ ì™„ë²½í•¨.
                // í˜„ì¬ SQLì—ëŠ” url íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ì¼ë‹¨ ì œì™¸í•˜ê³  í˜¸ì¶œí•©ë‹ˆë‹¤.
            };
            const { error } = await _supabase.rpc('upsert_plant_secure', updates);
            if(error) alert(error.message); else { bootstrap.Modal.getInstance(document.getElementById('plantModal')).hide(); fetchPlants(); }
        }

        // --- ì—°í˜ ---
        async function fetchHistory() {
            const { data } = await _supabase.from('site_documents').select('*').eq('category','history').order('event_date', {ascending:false});
            const tbody = document.getElementById('historyListBody');
            tbody.innerHTML = '';
            if(!data) return;
            data.forEach(h => {
                tbody.innerHTML += `<tr>
                    <td>${h.event_date}</td>
                    <td>${h.title}</td>
                    <td>${h.content || ''}</td>
                    <td><button class="btn btn-sm btn-light" onclick="openHistoryModal('${h.id}')">ìˆ˜ì •</button></td>
                </tr>`;
            });
        }
        async function openHistoryModal(id) {
            document.getElementById('hist-id').value = id || '';
            if(id) {
                const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('hist-date').value = data.event_date;
                    document.getElementById('hist-title').value = data.title;
                    document.getElementById('hist-content').value = data.content;
                }
            } else {
                document.getElementById('hist-title').value = '';
                document.getElementById('hist-content').value = '';
            }
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }
        async function saveHistory() {
            const updates = {
                p_id: document.getElementById('hist-id').value || null,
                p_date: document.getElementById('hist-date').value,
                p_title: document.getElementById('hist-title').value,
                p_content: document.getElementById('hist-content').value
            };
            const { error } = await _supabase.rpc('upsert_history_secure', updates);
            if(error) alert(error.message); else { bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide(); fetchHistory(); }
        }


        // ìœ í‹¸ë¦¬í‹°
        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        function logout() { _supabase.auth.signOut().then(() => location.href='index.html'); }
function switchTab(t) { 
            // 1. ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active')); 
            
            // 2. ì„ íƒí•œ ë©”ì¸ íƒ­ ë³´ì´ê¸° (classì— active ì¶”ê°€ê°€ ì•„ë‹ˆë¼ display ìŠ¤íƒ€ì¼ ì œì–´ ë°©ì‹ì¸ ê²½ìš° ì£¼ì˜)
            // í˜„ì¬ CSS êµ¬ì¡°ìƒ .tab-pane.active { display: block; } ì´ë¯€ë¡œ class ì¶”ê°€ê°€ ë§ìŒ
            const targetTab = document.getElementById('tab-' + t);
            if(targetTab) targetTab.classList.add('active'); 
            
            // 3. ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„±í™” í‘œì‹œ
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            if (event && event.target) {
                // í´ë¦­ëœ ìš”ì†Œê°€ ì•„ì´ì½˜(i)ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ closestë¡œ aíƒœê·¸ ì°¾ê¸°
                const link = event.target.closest('.nav-link');
                if(link) link.classList.add('active');
            }
            
            // 4. íƒ­ë³„ ë°ì´í„° ë¡œë“œ ë¡œì§
            if (t === 'notices') fetchNotices();
            
            if (t === 'site') { 
                // [ìˆ˜ì •ë¨] ì‚¬ì´íŠ¸ ê´€ë¦¬ íƒ­ì„ ëˆ„ë¥´ë©´ 'ì„¹ì…˜ ì„¤ì •(#sub-sections)' íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ í´ë¦­
                const defaultSubTab = document.querySelector('a[href="#sub-sections"]');
                if(defaultSubTab) defaultSubTab.click();
            }
        }
        // ================================================================
        // [ê¸°ëŠ¥ 5] ì„¹ì…˜(ë©”ë‰´) ê´€ë¦¬ (ON/OFF)
        // ================================================================
        
        // 1. ì„¹ì…˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchSections() {
            // DBì—ì„œ ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì˜´
            const { data, error } = await _supabase
                .from('site_sections')
                .select('*')
                .order('display_order');

            if (error) {
                console.error("ì„¹ì…˜ ë¡œë”© ì—ëŸ¬:", error);
                return;
            }

            const tbody = document.getElementById('sectionListBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">ì„¹ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(sec => {
                // ìŠ¤ìœ„ì¹˜ê°€ ì¼œì ¸ì•¼ í•˜ëŠ”ì§€ êº¼ì ¸ì•¼ í•˜ëŠ”ì§€ í™•ì¸
                const checkedAttr = sec.is_visible ? 'checked' : '';
                
                // ìƒíƒœ ë°°ì§€ (ì´ˆë¡ìƒ‰/íšŒìƒ‰)
                const statusBadge = sec.is_visible 
                    ? '<span class="badge bg-success">ê³µê°œì¤‘</span>' 
                    : '<span class="badge bg-secondary">ìˆ¨ê¹€</span>';

                // í…Œì´ë¸” í–‰ ì¶”ê°€
                tbody.innerHTML += `
                    <tr>
                        <td class="align-middle text-center">${sec.display_order}</td>
                        <td class="align-middle text-start ps-4">
                            <span class="fw-bold text-dark">${sec.name}</span> <br>
                            <small class="text-muted" style="font-size:0.85em;">ID: ${sec.id}</small>
                        </td>
                        <td class="align-middle text-center">${statusBadge}</td>
                        <td class="align-middle text-center">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" role="switch" 
                                    style="width: 45px; height: 24px; cursor: pointer;"
                                    ${checkedAttr} 
                                    onchange="toggleSection('${sec.id}', this.checked)">
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // 2. ìŠ¤ìœ„ì¹˜ ë³€ê²½ ì‹œ DB ì¦‰ì‹œ ì €ì¥
// 2. ìŠ¤ìœ„ì¹˜ ë³€ê²½ (ìˆ˜ì •ë¨: RPC ì‚¬ìš©ìœ¼ë¡œ ê¶Œí•œ ë¬¸ì œ í•´ê²°)
        async function toggleSection(id, isVisible) {
            const { error } = await _supabase.rpc('update_section_visible', { 
                p_id: id, 
                p_visible: isVisible 
            });

            if(error) {
                alert('ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
                fetchSections(); 
            } else {
                fetchSections();
            }
        }
        // ì—°í˜ ì‚­ì œ í•¨ìˆ˜
        async function deleteHistory(id) {
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading(true);
            const { error } = await _supabase.rpc('delete_document_secure', { p_id: id });
            showLoading(false);

            if(error) alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            else fetchHistory();
        }
    </script>
</body>
</html>
