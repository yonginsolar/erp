<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜€ï¸ í˜‘ë™ì¡°í•© í†µí•© ê´€ë¦¬ì</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; overflow: hidden; }
        
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-menu { padding: 20px 10px; overflow-y: auto; flex-grow: 1; }
        .nav-link { color: rgba(255,255,255,0.75); padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; font-weight: 600; }
        .nav-link i { margin-right: 12px; font-size: 1.1rem; }
        .menu-category { font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.4); margin: 20px 15px 10px; font-weight: 700; letter-spacing: 1px; }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .main-content { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 30px; background: #f8f9fa; }
        .content-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ & ìœ í‹¸ */
        #login-gate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); text-align: center; }
        .hidden { display: none !important; }
        .table th { font-size: 13px; background-color: #f1f3f5; font-weight: 600; }
        .table td { font-size: 14px; vertical-align: middle; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* íƒ­ ê¸€ì”¨ ìƒ‰ìƒ ê°•ì œ ìˆ˜ì • */
        .nav-tabs .nav-link { color: #495057 !important; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #0d6efd !important; border-bottom: 2px solid #0d6efd; }
    </style>
</head>

<body>

    <div id="login-gate">
        <div class="login-box">
            <h3 class="fw-bold mb-4">ğŸ” ê´€ë¦¬ì ì ‘ì†</h3>
            <div class="mb-3 text-start">
                <label class="form-label small fw-bold">ì´ë©”ì¼ ì£¼ì†Œ</label>
                <input type="email" id="adminEmail" class="form-control" placeholder="name@coop.com">
            </div>
            <button class="btn btn-primary w-100 py-2 fw-bold" id="btnLogin" onclick="sendLoginLink()">ë¡œê·¸ì¸ ë§í¬ ë°›ê¸°</button>
            <div id="loginMsg" class="mt-3 text-success small" style="display:none;"></div>
        </div>
    </div>

    <div class="d-flex hidden" id="main-system">
        <div class="sidebar">
            <div class="sidebar-header">
                <h5 class="fw-bold m-0">â˜€ï¸ í˜‘ë™ì¡°í•© ERP <span class="badge bg-warning text-dark" style="font-size:0.6em; vertical-align:middle;">v1.1.0</span></h5>
                <small class="text-white-50" id="adminProfile">ì ‘ì†ì¤‘...</small>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-category">íšŒì› ë° ìê¸ˆ</div>
                <a class="nav-link active" onclick="switchTab('members')"><i class="bi bi-people-fill"></i> ì¡°í•©ì› ê´€ë¦¬</a>
                <a class="nav-link" onclick="switchTab('deposit')"><i class="bi bi-cash-coin"></i> ì…ê¸ˆ ë§¤ì¹­</a>

                <div class="menu-category">ìš´ì˜ ê´€ë¦¬</div>
                <a class="nav-link" onclick="switchTab('notices')"><i class="bi bi-megaphone"></i> ê³µì§€ì‚¬í•­ ê´€ë¦¬</a>

                <div class="menu-category">í™ˆí˜ì´ì§€ ê´€ë¦¬</div>
                <a class="nav-link" onclick="switchTab('site')"><i class="bi bi-window-sidebar"></i> ì‚¬ì´íŠ¸ ì»¨í…ì¸ </a>

                <div class="mt-4 pt-4 border-top border-secondary">
                    <a class="nav-link text-warning" onclick="location.href='index.html'"><i class="bi bi-box-arrow-up-right"></i> ë©”ë‰´ë¡œ ë°”ë¡œê°€ê¸°</a>
                    <a class="nav-link text-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ</a>
                </div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="tab-members" class="tab-pane active">
                <div class="content-header">
                    <h3>ğŸ‘¥ ì¡°í•©ì› í†µí•© ê´€ë¦¬</h3>
                    <button class="btn btn-success btn-sm" onclick="openExcelModal()"><i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="text" id="search-keyword" class="form-control form-control-sm" placeholder="ì´ë¦„, ë²ˆí˜¸ ê²€ìƒ‰" onkeyup="if(event.key=='Enter') fetchMembers()"></div>
                            <div class="col-md-2"><button class="btn btn-primary btn-sm w-100" onclick="fetchMembers()">ê²€ìƒ‰</button></div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th>No</th><th>ìœ í˜•</th><th>ì´ë¦„/ë²ˆí˜¸</th><th>ìƒë…„ì›”ì¼/ì‚¬ì—…ì</th><th>ì—°ë½ì²˜</th><th>ë‚©ì…ì´ì•¡(ref)</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="memberListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-deposit" class="tab-pane">
                <div class="content-header"><h3>ğŸ’° ì…ê¸ˆ ë‚´ì—­ ë§¤ì¹­</h3></div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <h6 class="fw-bold mb-3">1. ì€í–‰ ì—‘ì…€ ì—…ë¡œë“œ</h6>
                            <input type="file" id="depositFile" class="form-control mb-3" onchange="readExcel(this)">
                            <div class="small text-muted">ì—‘ì…€ íŒŒì¼ì— 'ì…ê¸ˆìëª…' ë˜ëŠ” 'ì„±ëª…', 'ì…ê¸ˆì•¡' ì¹¼ëŸ¼ì´ ìˆì–´ì•¼ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.</div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <h6 class="fw-bold mb-3">2. ë§¤ì¹­ ê²°ê³¼</h6>
                            <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
                                <table class="table table-sm">
                                    <thead style="position:sticky; top:0; background:white;"><tr><th>ì…ê¸ˆìëª…</th><th>ì…ê¸ˆì•¡</th><th>ë§¤ì¹­ëœ ì¡°í•©ì›</th></tr></thead>
                                    <tbody id="depositResultBody"><tr><td colspan="3" class="text-center text-muted py-5">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-notices" class="tab-pane">
                <div class="content-header">
                    <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
                    <button class="btn btn-primary btn-sm" onclick="openNoticeModal()"><i class="bi bi-pencil"></i> ê³µì§€ ì‘ì„±</button>
                </div>
                    <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead><tr><th>ë‚ ì§œ</th><th>ë¶„ë¥˜</th><th>ì œëª©</th><th>íŒì—…</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="noticeListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

<div id="tab-site" class="tab-pane">
                <div class="content-header"><h3>ğŸ–¥ï¸ í™ˆí˜ì´ì§€ ì»¨í…ì¸  ê´€ë¦¬</h3></div>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#sub-sections" onclick="setTimeout(fetchSections,100)">
                            ì„¹ì…˜ ì„¤ì • (ON/OFF)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#sub-about" onclick="fetchAboutSettings()">ì¡°í•© ì†Œê°œ (About)</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#sub-plants" onclick="setTimeout(fetchPlants,100)">
                            ë°œì „ì†Œ í˜„í™©
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#sub-docs" onclick="setTimeout(fetchDocs,100)">
                            ë¬¸ì„œ ê´€ë¦¬ (ì •ê´€/ê·œì•½)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#sub-history" onclick="setTimeout(fetchHistory,100)">
                            ì—°í˜ (History)
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="sub-sections">
                        <div class="alert alert-info small">
                            <i class="bi bi-info-circle-fill"></i> í™ˆí˜ì´ì§€ì˜ ë©”ë‰´ì™€ ë³¸ë¬¸ ì„¹ì…˜ì„ ë„ê³  ì¼¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì²´í¬ í•´ì œ ì‹œ ì¦‰ì‹œ ë°˜ì˜)
                        </div>
                        <table class="table table-bordered bg-white text-center">
                            <thead class="table-light"><tr><th>ìˆœì„œ</th><th>ì„¹ì…˜ ì´ë¦„(ID)</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="sectionListBody">
                                </tbody>
                        </table>
                    </div>

                    
<div class="tab-pane fade" id="sub-about">
                        <div class="card p-0 border-0 shadow-sm">
                            <div class="card-header bg-white border-bottom-0 pt-3 ps-3">
                                <ul class="nav nav-tabs card-header-tabs" id="aboutTab" role="tablist">
                                    <li class="nav-item">
                                        <button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#about-edit-tab" type="button">âœï¸ í¸ì§‘ ëª¨ë“œ</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#about-preview-tab" type="button" onclick="updateTotalPreview()">ğŸ‘€ ì „ì²´ ë¯¸ë¦¬ë³´ê¸°</button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="about-edit-tab">
                                        <div class="alert alert-light small mb-3 border"><i class="bi bi-info-circle"></i> HTML íƒœê·¸ ì‚¬ìš© ê°€ëŠ¥</div>
                                        <div class="mb-3"><label class="form-label fw-bold">1. ë©”ì¸ ì œëª©</label><input type="text" id="admin-about-title" class="form-control"></div>
                                        <div class="mb-3"><label class="form-label fw-bold">2. ë¶€ì œëª©</label><input type="text" id="admin-about-subtitle" class="form-control"></div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3"><label class="form-label fw-bold">3. ì²´í¬ë¦¬ìŠ¤íŠ¸</label><textarea id="admin-about-list" class="form-control" rows="6"></textarea></div>
                                            <div class="col-md-6 mb-3"><label class="form-label fw-bold">4. ë³¸ë¬¸ ë‚´ìš©</label><textarea id="admin-about-content" class="form-control" rows="6"></textarea></div>
                                        </div>
                                        <div class="mb-3"><label class="form-label fw-bold">5. ì‚¬ì§„ URL</label><input type="text" id="admin-about-img" class="form-control"></div>
                                        <div class="text-end mt-3"><button class="btn btn-primary px-4" onclick="saveAboutSettings()">ì €ì¥í•˜ê¸°</button></div>
                                    </div>
                                    <div class="tab-pane fade" id="about-preview-tab">
                                        <div class="border rounded p-4 bg-light">
                                            <div class="row align-items-center bg-white p-3 shadow-sm rounded">
                                                <div class="col-lg-6">
                                                    <h3 id="prev-title" class="fw-bold mb-2"></h3>
                                                    <p id="prev-subtitle" class="fst-italic text-muted mb-3"></p>
                                                    <ul id="prev-list" class="list-unstyled mb-3"></ul>
                                                    <p id="prev-content"></p>
                                                </div>
                                                <div class="col-lg-6 text-center">
                                                    <img id="prev-img" src="" class="img-fluid rounded" style="max-height:300px;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="sub-plants">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="openPlantModal()">+ ë°œì „ì†Œ ì¶”ê°€</button>
                        </div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ìˆœì„œ</th><th>ë°œì „ì†Œëª…</th><th>ìš©ëŸ‰(kW)</th><th>ìƒíƒœ</th><th>ëª¨ë‹ˆí„°ë§</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="plantListBody"></tbody>
                        </table>
                    </div>

                    <div class="tab-pane fade" id="sub-history">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="openHistoryModal()">+ ì—°í˜ ì¶”ê°€</button>
                        </div>
                        <table class="table table-bordered bg-white">
                            <thead><tr><th>ë‚ ì§œ</th><th>ì œëª©</th><th>ë‚´ìš©</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="historyListBody"></tbody>
                        </table>
                    </div>
                    

<div class="tab-pane fade" id="sub-docs">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="openDocModal()">+ ìƒˆ ë¬¸ì„œ ë“±ë¡</button>
                        </div>
    <div class="form-check mb-3 p-3 bg-light rounded border">
    <input class="form-check-input" type="checkbox" id="doc-current">
    <label class="form-check-label fw-bold text-primary" for="doc-current">
        ì´ ë²„ì „ì„ 'í˜„ì¬ ì ìš© ë²„ì „'ìœ¼ë¡œ ì„¤ì • (ë©”ì¸ ë…¸ì¶œ)
    </label>
</div>
                        <table class="table table-bordered bg-white text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>ë‚ ì§œ/ë²„ì „</th>
                                    <th>ì œëª©</th>
                                    <th>ê°œì • ìš”ì•½</th>
                                    <th>íŒŒì¼</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="docListBody"></tbody>
                        </table>
                    </div>

                    
                    

                </div>
            </div>
    </div>

    <div id="loadingOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:none; justify-content:center; align-items:center; z-index:9999;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div class="modal fade" id="excelModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜µì…˜</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="excelOption" value="public" checked onchange="togglePwd(false)">
                        <label class="form-check-label">ì¼ë°˜ìš© (ê¸°ë³¸ ì •ë³´)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="excelOption" value="secret" onchange="togglePwd(true)">
                        <label class="form-check-label text-danger">ë³´ì•ˆìš© (ì£¼ë¯¼ë²ˆí˜¸/ê³„ì¢Œ í¬í•¨)</label>
                    </div>
                    <div class="mt-3" id="pwdArea" style="display:none;">
                        <input type="password" id="decryptKey" class="form-control form-control-sm" placeholder="ì•”í˜¸í™” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-success" onclick="downloadExcel()">ë‹¤ìš´ë¡œë“œ</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="memberEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">íšŒì› ì •ë³´ ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3"><label class="form-label small">ì´ë¦„</label><input type="text" id="edit-name" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ì—°ë½ì²˜</label><input type="text" id="edit-phone" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ìƒíƒœ</label><select id="edit-status" class="form-select"><option value="ì •ìƒ">ì •ìƒ</option><option value="íƒˆí‡´">íƒˆí‡´</option><option value="ì œëª…">ì œëª…</option></select></div>
                    <div class="mb-3"><label class="form-label small">ë¹„ê³ </label><textarea id="edit-note" class="form-control" rows="3"></textarea></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveMember()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="noticeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ê³µì§€ì‚¬í•­ ì‘ì„±</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="notice-id">
                    <div class="mb-3"><label class="form-label small">ì œëª©</label><input type="text" id="notice-title" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ë‚´ìš©</label><textarea id="notice-content" class="form-control" rows="5"></textarea></div>
                    <div class="row mb-3">
                        <div class="col"><label class="form-label small">ë¶„ë¥˜</label><select id="notice-category" class="form-select"><option>ê³µì§€</option><option>ì†Œì‹</option><option>ë³´ë„ìë£Œ</option></select></div>
                        <div class="col"><label class="form-label small">ìƒíƒœ</label><select id="notice-status" class="form-select"><option value="published">ê²Œì‹œ</option><option value="draft">ì„ì‹œì €ì¥</option></select></div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="notice-popup">
                        <label class="form-check-label small">ë©”ì¸ íŒì—…ìœ¼ë¡œ ë„ìš°ê¸°</label>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveNotice()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

<div class="modal fade" id="plantModal" tabindex="-1">
        <div class="modal-dialog modal-lg"> <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">ë°œì „ì†Œ ì •ë³´ ê´€ë¦¬</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="plant-id">
                    
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="text-primary fw-bold mb-3">ğŸ“Œ ê¸°ë³¸ ì •ë³´</h6>
                            <div class="mb-2"><label class="form-label small">ë°œì „ì†Œëª…</label><input type="text" id="plant-name" class="form-control"></div>
                            <div class="row">
                                <div class="col-6 mb-2"><label class="form-label small">ì„¤ë¹„ìš©ëŸ‰ (kW)</label><input type="number" id="plant-capacity" class="form-control" placeholder="0"></div>
                                <div class="col-6 mb-2"><label class="form-label small">ìˆœì„œ</label><input type="number" id="plant-order" class="form-control"></div>
                            </div>
                            <div class="mb-2"><label class="form-label small">ìœ„ì¹˜ (ì£¼ì†Œ)</label><input type="text" id="plant-location" class="form-control" placeholder="ì˜ˆ: ìš©ì¸ì‹œ ì²˜ì¸êµ¬..."></div>
                            <div class="row">
                                <div class="col-6 mb-2"><label class="form-label small">ë©´ì </label><input type="text" id="plant-area" class="form-control" placeholder="ì˜ˆ: 150mÂ²"></div>
                                <div class="col-6 mb-2"><label class="form-label small">ì¤€ê³µì¼(ì˜ˆì •)</label><input type="date" id="plant-date" class="form-control"></div>
                            </div>
                            <div class="mb-3"><label class="form-label small">ìƒíƒœ</label>
                                <select id="plant-status" class="form-select" onchange="toggleProgressSlider()">
                                    <option value="ìš´ì˜ì¤‘">ìš´ì˜ì¤‘ (Portfolio)</option>
                                    <option value="ê³µì‚¬ì¤‘">ê³µì‚¬ì¤‘ (Progress)</option>
                                    <option value="ì¤€ë¹„ì¤‘">ì¤€ë¹„ì¤‘ (Progress)</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div id="plant-progress-area" style="display:none;">
                                <h6 class="text-primary fw-bold mb-3">ğŸš§ ì§„í–‰ ìƒí™©</h6>
                                <div class="p-3 bg-light rounded mb-3">
                                    <label class="d-flex justify-content-between small fw-bold">
                                        <span>ì§„í–‰ë¥ </span> <span class="text-primary" id="plant-progress-label">0%</span>
                                    </label>
                                    <input type="range" id="plant-progress" class="form-range" min="0" max="100" step="1" oninput="updateProgressLabel(this.value)">
                                    <div class="d-flex justify-content-between text-muted mt-1" style="font-size:0.7em;">
                                        <span onclick="setProg(0)" style="cursor:pointer">ì„¤ë¦½</span>
                                        <span onclick="setProg(25)" style="cursor:pointer">ë¶€ì§€</span>
                                        <span onclick="setProg(50)" style="cursor:pointer">ì¸í—ˆê°€</span>
                                        <span onclick="setProg(75)" style="cursor:pointer">ì°©ê³µ</span>
                                        <span onclick="setProg(100)" style="cursor:pointer">ì™„ê³µ</span>
                                    </div>
                                </div>
                            </div>

                            <h6 class="text-primary fw-bold mb-3">ğŸ“· í˜„ì¥ ì‚¬ì§„</h6>
                            <div class="mb-2 d-flex gap-2">
                                <input type="file" id="plant-file" class="form-control form-control-sm" accept="image/*" onchange="previewImage(this)">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearPlantImage()" title="ì‚¬ì§„ ì‚­ì œ"><i class="bi bi-trash"></i></button>
                            </div>
                            
                            <input type="hidden" id="plant-img-original">
                            <input type="hidden" id="plant-img-url">

                            <div class="text-center bg-light border rounded d-flex align-items-center justify-content-center" style="height: 150px; overflow:hidden; position:relative;">
                                <img id="plant-img-preview" src="" style="max-width:100%; max-height:100%; display:none;">
                                <span id="plant-img-placeholder" class="text-muted small">ì‚¬ì§„ ì—†ìŒ</span>
                            </div>
                            
                            <div class="mt-3">
                                <label class="form-label small">ëª¨ë‹ˆí„°ë§ URL</label>
                                <input type="text" id="plant-url" class="form-control form-control-sm" placeholder="http://...">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary px-4" onclick="savePlant()">ì €ì¥í•˜ê¸°</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ì—°í˜ ë“±ë¡</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="hist-id">
                    <div class="mb-3"><label class="form-label small">ë‚ ì§œ</label><input type="date" id="hist-date" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ì œëª©</label><input type="text" id="hist-title" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small">ë‚´ìš© (ì„ íƒ)</label><textarea id="hist-content" class="form-control" rows="3"></textarea></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveHistory()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

        <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold text-danger">âš ï¸ ì‚­ì œ í™•ì¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? <br><small class="text-muted">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small></p>
                    <input type="hidden" id="delete-target-id"> </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-danger" id="btn-real-delete">ì‚­ì œí•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

        <div class="modal fade" id="commonAlertModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content text-center p-3">
                <div class="modal-body">
                    <div class="mb-2">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                    </div>
                    <h6 class="fw-bold mb-0" id="commonAlertText">ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</h6>
                </div>
                <div class="modal-footer justify-content-center border-0 p-0 pb-2">
                    <button type="button" class="btn btn-sm btn-dark px-4" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>

        <div class="modal fade" id="docModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ë¬¸ì„œ(ì •ê´€/ê·œì•½) ë“±ë¡</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="doc-id">
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label small">ë¬¸ì„œ ì œëª©</label>
                            <input type="text" id="doc-title" class="form-control" placeholder="ì˜ˆ: ì •ê´€">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">ë²„ì „ (í‘œì‹œìš©)</label>
                            <input type="text" id="doc-version" class="form-control" placeholder="ì˜ˆ: 2025.12 ê°œì •ì•ˆ">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">ì‹œí–‰ì¼ (ë‚ ì§œ)</label>
                        <input type="date" id="doc-date" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">ê°œì • ìš”ì•½ (ë³€ê²½ì‚¬í•­)</label>
                        <textarea id="doc-content" class="form-control" rows="4" placeholder="ì˜ˆ: ì œ3ì¡° ì¡°í•©ì› ìê²© ìš”ê±´ ì™„í™” ë“±"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small">PDF íŒŒì¼ ì²¨ë¶€</label>
                        <input type="file" id="doc-file" class="form-control" accept=".pdf">
                        <input type="hidden" id="doc-file-url">
                        <div id="doc-file-link" class="mt-1 small text-primary"></div>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveDoc()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // â˜… Supabase ì„¤ì • (Anon Key ì‚¬ìš© - RPC ë³´ì•ˆìœ¼ë¡œ ì•ˆì „í•¨)
        const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ì „ì—­ ë³€ìˆ˜
        let g_members = [];
        // ì „ì—­ ë³€ìˆ˜
        let g_plants = []; // [ì¶”ê°€] ë°œì „ì†Œ ëª©ë¡ ê¸°ì–µìš©

        // [ì´ˆê¸°í™”] ì„¸ì…˜ ì²´í¬ ë° ê¶Œí•œ í™•ì¸
        window.onload = async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) checkAdmin(session.user);
            else document.getElementById('login-gate').classList.remove('hidden');
        };

        // [ê¶Œí•œ ì²´í¬] RPC í•¨ìˆ˜ë¡œ ë³´ì•ˆ ê²€ì¦ (ë¬´í•œ ë£¨í”„ ë°©ì§€ë¨)
        async function checkAdmin(user) {
            showLoading(true);
            const { data: role } = await _supabase.rpc('get_my_role');
            showLoading(false);
            if (role === 'admin') {
                document.getElementById('login-gate').classList.add('hidden');
                document.getElementById('main-system').classList.remove('hidden');
                document.getElementById('adminProfile').innerText = user.email;
                fetchMembers(); // ì²« í™”ë©´ ë¡œë“œ
            } else {
                alert(`â›” ì ‘ê·¼ ê±°ë¶€: ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê³„ì •: ${user.email})`);
                await _supabase.auth.signOut();
                location.href = 'index.html';
            }
        }

        // [ë¡œê·¸ì¸] ë§¤ì§ë§í¬ ì „ì†¡
        async function sendLoginLink() {
            const email = document.getElementById('adminEmail').value;
            if(!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
            const btn = document.getElementById('btnLogin');
            btn.innerText = "ì „ì†¡ì¤‘..."; btn.disabled = true;
            
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
            
            if(error) { 
                alert(error.message); btn.innerText = "ë‹¤ì‹œ ì‹œë„"; btn.disabled = false;
            } else { 
                document.getElementById('loginMsg').innerText = "ì´ë©”ì¼í•¨ì—ì„œ ë¡œê·¸ì¸ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”!";
                document.getElementById('loginMsg').style.display = 'block';
                btn.classList.add('hidden');
            }
        }

        // ================================================================
        // [ê¸°ëŠ¥ 1] ì¡°í•©ì› ê´€ë¦¬ (RPC ì‚¬ìš©)
        // ================================================================
        async function fetchMembers() {
            showLoading(true);
            const keyword = document.getElementById('search-keyword').value;
            
            // RPC í˜¸ì¶œ (ë³´ì•ˆ ìš°íšŒí•˜ì—¬ ë°ì´í„° íšë“)
            const { data: members, error: err1 } = await _supabase.rpc('get_members_secure');
            const { data: payments, error: err2 } = await _supabase.rpc('get_payments_secure');
            showLoading(false);

            if(err1) return console.error(err1);
            g_members = members || [];

            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '';
            
            let filtered = members;
            if(keyword) filtered = members.filter(m => (m.name+m.phone).includes(keyword));

            if(!filtered || filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            filtered.forEach((m, idx) => {
                // ë‚©ì…ê¸ˆ ë§¤ì¹­
                const pay = payments ? (payments.find(p => p.member_uuid === m.id)?.total_amount || 0) : 0;
                
                // ì£¼ë¯¼ë²ˆí˜¸ í¬ë§·íŒ…
                let rrnShow = m.rrn_display || '-';
                if(m.member_type !== 'ë‹¨ì²´' && rrnShow.length > 6) {
                     const y = rrnShow.charAt(7)=='1'||rrnShow.charAt(7)=='2'?'19':'20';
                     rrnShow = `${y}${rrnShow.substring(0,2)}.${rrnShow.substring(2,4)}.${rrnShow.substring(4,6)}`;
                } else if(m.member_type === 'ë‹¨ì²´') {
                    rrnShow = `<span class="badge bg-light text-secondary border">ì‚¬ì—…ì</span> ${rrnShow}`;
                }

                tbody.innerHTML += `<tr>
                    <td>${filtered.length - idx}</td>
                    <td><span class="badge bg-light text-dark border">${m.member_type}</span></td>
                    <td>${m.name}<br><small class="text-muted">${m.member_id||''}</small></td>
                    <td>${rrnShow}</td>
                    <td>${m.phone}</td>
                    <td class="fw-bold text-primary">${pay.toLocaleString()}ì›</td>
                    <td>${m.status}</td>
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="openMemberEdit('${m.id}')">ê´€ë¦¬</button></td>
                </tr>`;
            });
        }

        // íšŒì› ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openMemberEdit(id) {
            const m = g_members.find(x => x.id === id);
            if(!m) return;
            document.getElementById('edit-id').value = m.id;
            document.getElementById('edit-name').value = m.name;
            document.getElementById('edit-phone').value = m.phone;
            document.getElementById('edit-status').value = m.status;
            document.getElementById('edit-note').value = m.note || '';
            new bootstrap.Modal(document.getElementById('memberEditModal')).show();
        }

        // íšŒì› ì •ë³´ ì €ì¥ (RPC í˜¸ì¶œ)
        async function saveMember() {
            const updates = {
                p_id: document.getElementById('edit-id').value,
                p_name: document.getElementById('edit-name').value,
                p_phone: document.getElementById('edit-phone').value,
                p_status: document.getElementById('edit-status').value,
                p_note: document.getElementById('edit-note').value
            };
            
            showLoading(true);
            const { error } = await _supabase.rpc('update_member_secure', updates);
            showLoading(false);

            if(error) alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            else {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                bootstrap.Modal.getInstance(document.getElementById('memberEditModal')).hide();
                fetchMembers();
            }
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë³´ì•ˆ/ì¼ë°˜)
        function togglePwd(show) { document.getElementById('pwdArea').style.display = show ? 'block' : 'none'; }
        function openExcelModal() { new bootstrap.Modal(document.getElementById('excelModal')).show(); }
        
        async function downloadExcel() {
            const type = document.querySelector('input[name="excelOption"]:checked').value;
            let dataToExport = [];
            
            if(type === 'secret') {
                const pwd = document.getElementById('decryptKey').value;
                if(!pwd) return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                // ë³´ì•ˆ ë°ì´í„°ëŠ” RPCë¡œ ê°€ì ¸ì™€ì•¼ í•¨ (ì—¬ê¸°ì„œëŠ” êµ¬í˜„ ìƒëµ ê°€ëŠ¥í•˜ë©´ ìƒëµí•˜ê² ì§€ë§Œ, ì™„ì „íŒ ìš”ì²­ì´ë¯€ë¡œ ë¡œì§ë§Œ ë‘¡ë‹ˆë‹¤)
                // ì‹¤ì œë¡œëŠ” get_decrypted_member ê°™ì€ í•¨ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. 
                // ì¼ë‹¨ì€ í˜„ì¬ ë©”ëª¨ë¦¬ì— ìˆëŠ” g_membersë¡œ ì§„í–‰í•˜ë˜ ì£¼ë¯¼ë²ˆí˜¸ëŠ” ë§ˆìŠ¤í‚¹ëœ ìƒíƒœë¡œ ë‚˜ê°‘ë‹ˆë‹¤.
                alert('ì£¼ì˜: í˜„ì¬ ë³´ì•ˆìš© ë³µí˜¸í™” RPCê°€ ì—°ê²°ë˜ì§€ ì•Šì•„ ê¸°ë³¸ ì •ë³´ë§Œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.');
                dataToExport = g_members;
            } else {
                dataToExport = g_members;
            }

            const excelData = dataToExport.map(m => ({
                "ì¡°í•©ì›ë²ˆí˜¸": m.member_id,
                "ì´ë¦„": m.name,
                "ì—°ë½ì²˜": m.phone,
                "ìƒíƒœ": m.status,
                "ì£¼ë¯¼/ì‚¬ì—…ì(ë§ˆìŠ¤í‚¹)": m.rrn_display
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì¡°í•©ì›ëª…ë¶€");
            XLSX.writeFile(wb, "ì¡°í•©ì›ëª…ë¶€.xlsx");
            bootstrap.Modal.getInstance(document.getElementById('excelModal')).hide();
        }


        // ================================================================
        // [ê¸°ëŠ¥ 2] ì…ê¸ˆ ë§¤ì¹­ (ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—‘ì…€ ì²˜ë¦¬)
        // ================================================================
        function readExcel(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);
                
                const tbody = document.getElementById('depositResultBody');
                tbody.innerHTML = '';
                
                if(json.length === 0) { tbody.innerHTML='<tr><td colspan="3">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }

                json.forEach(row => {
                    // ì—‘ì…€ ì¹¼ëŸ¼ëª… ìœ ì—°í•˜ê²Œ ì°¾ê¸°
                    const name = row['ì…ê¸ˆì'] || row['ì„±ëª…'] || row['ë³´ë‚¸ë¶„'] || row['ë‚´ìš©'];
                    const amt = row['ì…ê¸ˆì•¡'] || row['ê¸ˆì•¡'] || row['ê±°ë˜ê¸ˆì•¡'];
                    
                    if(name && amt) {
                        // ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­ ì‹œë„
                        const match = g_members.find(m => m.name === name.trim());
                        let matchHtml = `<span class="text-danger">ë§¤ì¹­ ì‹¤íŒ¨ (ì •ë³´ ì—†ìŒ)</span>`;
                        
                        if(match) {
                            matchHtml = `<span class="text-success fw-bold">${match.name} (${match.member_id})</span>`;
                        }

                        tbody.innerHTML += `<tr>
                            <td>${name}</td>
                            <td>${Number(amt).toLocaleString()}ì›</td>
                            <td>${matchHtml}</td>
                        </tr>`;
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }


        // ================================================================
        // [ê¸°ëŠ¥ 3] ê³µì§€ì‚¬í•­ ê´€ë¦¬
        // ================================================================
        async function fetchNotices() {
            // ì½ê¸°ëŠ” public ì •ì±…ì´ ìˆì–´ì„œ ë°”ë¡œ select ê°€ëŠ¥
            const { data } = await _supabase.from('coop_notices').select('*').order('created_at', {ascending:false});
            const tbody = document.getElementById('noticeListBody');
            tbody.innerHTML = '';
            
            if(!data || data.length===0) { tbody.innerHTML='<tr><td colspan="6" class="text-center py-3">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }

            data.forEach(n => {
                tbody.innerHTML += `<tr>
                    <td>${n.created_at.split('T')[0]}</td>
                    <td>${n.category}</td>
                    <td>${n.title}</td>
                    <td>${n.is_popup?'Y':'-'}</td>
                    <td>${n.status}</td>
                    <td><button class="btn btn-sm btn-light" onclick="openNoticeModal('${n.id}')">ìˆ˜ì •</button></td>
                </tr>`;
            });
        }
        
        let g_current_notice_id = null;
// ê³µì§€ ëª¨ë‹¬ ì—´ê¸° (ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° ì¶”ê°€)
        async function openNoticeModal(id) {
            g_current_notice_id = id || null;
            document.getElementById('notice-id').value = id || '';
            
            if(id) {
                const { data } = await _supabase.from('coop_notices').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('notice-title').value = data.title;
                    document.getElementById('notice-content').value = data.content || ''; // ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°
                    document.getElementById('notice-category').value = data.category;
                    document.getElementById('notice-status').value = data.status;
                    document.getElementById('notice-popup').checked = data.is_popup;
                }
            } else {
                document.getElementById('notice-title').value = '';
                document.getElementById('notice-content').value = ''; // ì´ˆê¸°í™”
                document.getElementById('notice-popup').checked = false;
            }
            new bootstrap.Modal(document.getElementById('noticeModal')).show();
        }

        // ê³µì§€ ì €ì¥ (ë‚´ìš© í¬í•¨í•´ì„œ ì „ì†¡)
        async function saveNotice() {
            const updates = {
                p_id: document.getElementById('notice-id').value || null,
                p_title: document.getElementById('notice-title').value,
                p_content: document.getElementById('notice-content').value, // ë‚´ìš© ì¶”ê°€
                p_category: document.getElementById('notice-category').value,
                p_status: document.getElementById('notice-status').value,
                p_is_popup: document.getElementById('notice-popup').checked
            };
            
            showLoading(true);
            const { error } = await _supabase.rpc('upsert_notice_secure', updates);
            showLoading(false);

            if(error) alert('ì €ì¥ ì—ëŸ¬: ' + error.message);
            else {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                bootstrap.Modal.getInstance(document.getElementById('noticeModal')).hide();
                fetchNotices();
            }
        }


        // ================================================================
        // [ê¸°ëŠ¥ 4] í™ˆí˜ì´ì§€ ì»¨í…ì¸  (ë°œì „ì†Œ, ì—°í˜)
        // ================================================================
        
        // --- ë°œì „ì†Œ ---
// [ìˆ˜ì •] ë°œì „ì†Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ + ì „ì—­ë³€ìˆ˜ ì €ì¥)
async function fetchPlants() {
            const { data } = await _supabase.from('site_power_plants').select('*').order('display_order');
            const tbody = document.getElementById('plantListBody');
            tbody.innerHTML = '';
            
            if(!data) {
                g_plants = []; // ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
                return;
            }

            g_plants = data; // â˜… í•µì‹¬: ëª©ë¡ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‚˜ì¤‘ì— ìˆœì„œ ê³„ì‚°í•  ë•Œ ì”€)

            data.forEach(p => {
                tbody.innerHTML += `<tr>
                    <td>${p.display_order}</td>
                    <td>${p.name}</td>
                    <td>${p.capacity}kW</td>
                    <td>${p.status}</td>
                    <td><a href="${p.monitor_url||'#'}" target="_blank" class="text-truncate" style="max-width:100px; display:inline-block;">${p.monitor_url||'-'}</a></td>
                    <td>
                        <button class="btn btn-sm btn-light" onclick="openPlantModal('${p.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeletePlant('${p.id}')">ì‚­ì œ</button>
                    </td>
                </tr>`;
            });
        }
// [ìˆ˜ì •] ë°œì „ì†Œ ëª¨ë‹¬ ì—´ê¸° (ìˆœì„œ ìë™ ê³„ì‚°)
// [ìˆ˜ì • 2] ë°œì „ì†Œ ëª¨ë‹¬ ì—´ê¸° (ìˆœì„œ ìë™ ê³„ì‚° + ë¹ˆì¹¸ 0 ì²˜ë¦¬)

// [ìˆ˜ì •] ë°œì „ì†Œ ì €ì¥ (ë¹ˆì¹¸ -> 0 ìë™ ë³€í™˜ ì•ˆì „ì¥ì¹˜ ì¶”ê°€)


        // --- ì—°í˜ ---
// ì—°í˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ë¨)
        async function fetchHistory() {
            const { data } = await _supabase.from('site_documents').select('*').eq('category','history').order('event_date', {ascending:false});
            const tbody = document.getElementById('historyListBody');
            tbody.innerHTML = '';
            if(!data) return;
            data.forEach(h => {
                tbody.innerHTML += `<tr>
                    <td>${h.event_date}</td>
                    <td>${h.title}</td>
                    <td>${h.content || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-light" onclick="openHistoryModal('${h.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteHistory('${h.id}')">ì‚­ì œ</button>
                    </td>
                </tr>`;
            });
        }
// [ìˆ˜ì •] ì—°í˜ ëª¨ë‹¬ ì—´ê¸° (HTML íƒœê·¸ë¥¼ -> í¸ì§‘í•˜ê¸° í¸í•œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜)
        async function openHistoryModal(id) {
            document.getElementById('hist-id').value = id || '';
            
            if(id) {
                const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('hist-date').value = data.event_date;
                    document.getElementById('hist-title').value = data.title;
                    
                    // â˜… [í•µì‹¬] DBì˜ HTML íƒœê·¸ë¥¼ ì‚¬ëŒì´ ë³´ê¸° í¸í•œ í…ìŠ¤íŠ¸ë¡œ ë³µì›
                    let rawText = data.content || '';
                    rawText = rawText.replaceAll('<br>', '\n');      // ì¤„ë°”ê¿ˆ ë³µì›
                    rawText = rawText.replaceAll('<ul>', '');        // ë¦¬ìŠ¤íŠ¸ íƒœê·¸ ì œê±°
                    rawText = rawText.replaceAll('</ul>', '');
                    rawText = rawText.replaceAll('<ul class="my-1">', '');
                    rawText = rawText.replace(/<li>/g, '- ');        // <li>ë¥¼ '- 'ë¡œ ë³€í™˜
                    rawText = rawText.replace(/<\/li>/g, '\n');      // </li>ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ
                    rawText = rawText.replace(/\n\s*\n/g, '\n');     // ì¤‘ë³µ ì¤„ë°”ê¿ˆ ì œê±°
                    
                    document.getElementById('hist-content').value = rawText.trim();
                }
            } else {
                // ì‹ ê·œ ë“±ë¡ ì‹œ ì´ˆê¸°í™”
                document.getElementById('hist-title').value = '';
                document.getElementById('hist-content').value = '';
                // ë‚ ì§œëŠ” ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ ì„¸íŒ…í•´ì£¼ë©´ í¸í•¨
                document.getElementById('hist-date').value = new Date().toISOString().substring(0, 10);
            }
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }

        // [ìˆ˜ì •] ì—°í˜ ì €ì¥ (í…ìŠ¤íŠ¸ë¥¼ -> ì˜ˆìœ HTMLë¡œ ë³€í™˜í•´ì„œ ì €ì¥)
// [ìˆ˜ì •] ì—°í˜ ëª¨ë‹¬ ì—´ê¸° (ìˆëŠ” ê·¸ëŒ€ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°)
        async function openHistoryModal(id) {
            document.getElementById('hist-id').value = id || '';
            
            if(id) {
                const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('hist-date').value = data.event_date;
                    document.getElementById('hist-title').value = data.title;
                    document.getElementById('hist-content').value = data.content || ''; // ë³€í™˜ ì—†ì´ ê·¸ëŒ€ë¡œ ë¡œë“œ
                }
            } else {
                // ì‹ ê·œ
                document.getElementById('hist-title').value = '';
                document.getElementById('hist-content').value = '';
                document.getElementById('hist-date').value = new Date().toISOString().substring(0, 10);
            }
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }

        // [ìˆ˜ì •] ì—°í˜ ì €ì¥ (ìˆëŠ” ê·¸ëŒ€ë¡œ ì €ì¥í•˜ê¸°)
        async function saveHistory() {
            const updates = {
                p_id: document.getElementById('hist-id').value || null,
                p_date: document.getElementById('hist-date').value,
                p_title: document.getElementById('hist-title').value,
                p_content: document.getElementById('hist-content').value // ì…ë ¥í•œ ê·¸ëŒ€ë¡œ DBì— ì €ì¥
            };

            showLoading(true);
            const { error } = await _supabase.rpc('upsert_history_secure', updates);
            showLoading(false);

            if(error) alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message); 
            else { 
                bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide(); 
                fetchHistory(); 
            }
        }


        // ìœ í‹¸ë¦¬í‹°
        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        function logout() { _supabase.auth.signOut().then(() => location.href='index.html'); }
function switchTab(t) { 
            // 1. ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active')); 
            
            // 2. ì„ íƒí•œ ë©”ì¸ íƒ­ ë³´ì´ê¸° (classì— active ì¶”ê°€ê°€ ì•„ë‹ˆë¼ display ìŠ¤íƒ€ì¼ ì œì–´ ë°©ì‹ì¸ ê²½ìš° ì£¼ì˜)
            // í˜„ì¬ CSS êµ¬ì¡°ìƒ .tab-pane.active { display: block; } ì´ë¯€ë¡œ class ì¶”ê°€ê°€ ë§ìŒ
            const targetTab = document.getElementById('tab-' + t);
            if(targetTab) targetTab.classList.add('active'); 
            
            // 3. ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„±í™” í‘œì‹œ
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            if (event && event.target) {
                // í´ë¦­ëœ ìš”ì†Œê°€ ì•„ì´ì½˜(i)ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ closestë¡œ aíƒœê·¸ ì°¾ê¸°
                const link = event.target.closest('.nav-link');
                if(link) link.classList.add('active');
            }
            
            // 4. íƒ­ë³„ ë°ì´í„° ë¡œë“œ ë¡œì§
            if (t === 'notices') fetchNotices();
            
            if (t === 'site') { 
                // [ìˆ˜ì •ë¨] ì‚¬ì´íŠ¸ ê´€ë¦¬ íƒ­ì„ ëˆ„ë¥´ë©´ 'ì„¹ì…˜ ì„¤ì •(#sub-sections)' íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ í´ë¦­
                const defaultSubTab = document.querySelector('a[href="#sub-sections"]');
                if(defaultSubTab) defaultSubTab.click();
            }
        }
        // ================================================================
        // [ê¸°ëŠ¥ 5] ì„¹ì…˜(ë©”ë‰´) ê´€ë¦¬ (ON/OFF)
        // ================================================================
        
        // 1. ì„¹ì…˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchSections() {
            // DBì—ì„œ ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì˜´
            const { data, error } = await _supabase
                .from('site_sections')
                .select('*')
                .order('display_order');

            if (error) {
                console.error("ì„¹ì…˜ ë¡œë”© ì—ëŸ¬:", error);
                return;
            }

            const tbody = document.getElementById('sectionListBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">ì„¹ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(sec => {
                // ìŠ¤ìœ„ì¹˜ê°€ ì¼œì ¸ì•¼ í•˜ëŠ”ì§€ êº¼ì ¸ì•¼ í•˜ëŠ”ì§€ í™•ì¸
                const checkedAttr = sec.is_visible ? 'checked' : '';
                
                // ìƒíƒœ ë°°ì§€ (ì´ˆë¡ìƒ‰/íšŒìƒ‰)
                const statusBadge = sec.is_visible 
                    ? '<span class="badge bg-success">ê³µê°œì¤‘</span>' 
                    : '<span class="badge bg-secondary">ìˆ¨ê¹€</span>';

                // í…Œì´ë¸” í–‰ ì¶”ê°€
                tbody.innerHTML += `
                    <tr>
                        <td class="align-middle text-center">${sec.display_order}</td>
                        <td class="align-middle text-start ps-4">
                            <span class="fw-bold text-dark">${sec.name}</span> <br>
                            <small class="text-muted" style="font-size:0.85em;">ID: ${sec.id}</small>
                        </td>
                        <td class="align-middle text-center">${statusBadge}</td>
                        <td class="align-middle text-center">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" role="switch" 
                                    style="width: 45px; height: 24px; cursor: pointer;"
                                    ${checkedAttr} 
                                    onchange="toggleSection('${sec.id}', this.checked)">
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // 2. ìŠ¤ìœ„ì¹˜ ë³€ê²½ ì‹œ DB ì¦‰ì‹œ ì €ì¥
// 2. ìŠ¤ìœ„ì¹˜ ë³€ê²½ (ìˆ˜ì •ë¨: RPC ì‚¬ìš©ìœ¼ë¡œ ê¶Œí•œ ë¬¸ì œ í•´ê²°)
        async function toggleSection(id, isVisible) {
            const { error } = await _supabase.rpc('update_section_visible', { 
                p_id: id, 
                p_visible: isVisible 
            });

            if(error) {
                alert('ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
                fetchSections(); 
            } else {
                fetchSections();
            }
        }
        // ì—°í˜ ì‚­ì œ í•¨ìˆ˜

        // [ìˆ˜ì • 1] ì‚­ì œ ìš”ì²­ (ëª¨ë‹¬ ë„ìš°ê¸°)
// ì—°í˜ ì‚­ì œ ìš”ì²­
        function askDeleteHistory(id) {
            deleteType = 'history';
            document.getElementById('delete-target-id').value = id;
            // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°
            document.getElementById('btn-real-delete').onclick = confirmDelete;
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        }

        // [ìˆ˜ì • 2] ì‹¤ì œ ì‚­ì œ ì‹¤í–‰ (ëª¨ë‹¬ì—ì„œ 'ì‚­ì œí•˜ê¸°' í´ë¦­ ì‹œ)
        async function confirmDeleteHistory() {
            // 1. ì €ì¥í•´ë‘” ID êº¼ë‚´ê¸°
            const id = document.getElementById('delete-target-id').value;
            if (!id) return;

            // 2. ëª¨ë‹¬ ë‹«ê¸°
            const modalEl = document.getElementById('deleteConfirmModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            modalInstance.hide();

            showLoading(true);
            const { error } = await _supabase.rpc('delete_document_secure', { p_id: id });
            showLoading(false);

            if (error) {
                // ì—ëŸ¬ë„ ëª¨ë‹¬ë¡œ ë„ì›Œì£¼ë©´ ì¢‹ì§€ë§Œ, ì¼ë‹¨ ê°„ë‹¨í•œ ê²½ê³ ëŠ” ìœ ì§€í•˜ê±°ë‚˜ í† ìŠ¤íŠ¸ë¡œ ëŒ€ì²´ ê°€ëŠ¥
                // ìš”ì²­í•˜ì‹ ëŒ€ë¡œ alert ëŒ€ì‹  ì»¤ìŠ¤í…€ ì•Œë¦¼ì„ ì›í•˜ì‹œë©´ ë³„ë„ ëª¨ë‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤.
                // ì¼ë‹¨ì€ ì—ëŸ¬ ìƒí™©ì€ ë“œë¬¼ê¸° ë•Œë¬¸ì— ì½˜ì†”ì— ì°ê³  ë„˜ì–´ê°‘ë‹ˆë‹¤.
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error.message);
            } else {
                fetchHistory(); // ëª©ë¡ ê°±ì‹ 
            }
        }
        // ================================================================
        // [ê¸°ëŠ¥ 6] About(ì†Œê°œ) ê´€ë¦¬
        // ================================================================
        async function fetchAboutSettings() {
            const { data, error } = await _supabase.from('site_about').select('*').single();
            if(error && error.code !== 'PGRST116') { // ë°ì´í„° ì—†ìŒ ì—ëŸ¬ëŠ” ë¬´ì‹œ
                console.error(error); return;
            }
            if(data) {
                document.getElementById('admin-about-title').value = data.title || '';
                document.getElementById('admin-about-subtitle').value = data.subtitle || '';
                document.getElementById('admin-about-content').value = data.content || '';
                document.getElementById('admin-about-list').value = data.list_items || '';
                document.getElementById('admin-about-img').value = data.image_url || '';
            }
        }

        // [ëˆ„ë½ëœ í•¨ìˆ˜ ë³µêµ¬] ì†Œê°œê¸€ ì €ì¥í•˜ê¸°
        async function saveAboutSettings() {
            const updates = {
                p_title: document.getElementById('admin-about-title').value,
                p_subtitle: document.getElementById('admin-about-subtitle').value,
                p_content: document.getElementById('admin-about-content').value,
                p_list_items: document.getElementById('admin-about-list').value,
                p_image_url: document.getElementById('admin-about-img').value
            };

            showLoading(true);
            const { error } = await _supabase.rpc('upsert_about_secure', updates);
            showLoading(false);

            if(error) alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            else {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchAboutSettings(); // ì €ì¥ í›„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            }
        }
        


        // [ë³´ì¡° í•¨ìˆ˜] ì „ì²´ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (íƒ­ ëˆ„ë¥¼ ë•Œ ì‹¤í–‰ë¨)
// [ìˆ˜ì •] ì „ì²´ ë¯¸ë¦¬ë³´ê¸° (ì…ë ¥ ì•ˆ í•œ ê±´ ì•ˆ ë³´ì´ê²Œ ì²˜ë¦¬)
// [ìˆ˜ì •] ì „ì²´ ë¯¸ë¦¬ë³´ê¸° (ì  ì œê±° ë°˜ì˜)
        function updateTotalPreview() {
            const title = document.getElementById('admin-about-title').value;
            const subtitle = document.getElementById('admin-about-subtitle').value;
            const content = document.getElementById('admin-about-content').value;
            const listText = document.getElementById('admin-about-list').value;
            const imgUrl = document.getElementById('admin-about-img').value;

            document.getElementById('prev-title').innerHTML = title;
            document.getElementById('prev-subtitle').innerHTML = subtitle;
            document.getElementById('prev-content').innerHTML = content;
            
            const listEl = document.getElementById('prev-list');
            // â˜… í•µì‹¬: ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ì—ë„ 'list-unstyled' ì ìš© (ì  ì œê±°)
            listEl.className = "list-unstyled mb-3"; 

            if (!listText.trim()) {
                listEl.innerHTML = '';
                listEl.style.display = 'none';
            } else {
                listEl.style.display = 'block';
                if (listText.includes('<li')) {
                    listEl.innerHTML = listText;
                } else {
                    let html = '';
                    listText.split('\n').forEach(item => {
                        // ì•„ì´ì½˜ ì—†ì´ ê¹”ë”í•˜ê²Œ
                        if(item.trim()) html += `<li class="mb-1">${item.trim()}</li>`;
                    });
                    listEl.innerHTML = html;
                }
            }

            const imgEl = document.getElementById('prev-img');
            if(imgUrl) { imgEl.src = imgUrl; imgEl.style.display = 'block'; } 
            else { imgEl.style.display = 'none'; }
        }

        // [ìˆ˜ì •] ì†Œê°œê¸€ ì €ì¥í•˜ê¸° (ëª¨ë‹¬ ì ìš©)
        async function saveAboutSettings() {
            const updates = {
                p_title: document.getElementById('admin-about-title').value,
                p_subtitle: document.getElementById('admin-about-subtitle').value,
                p_content: document.getElementById('admin-about-content').value,
                p_list_items: document.getElementById('admin-about-list').value,
                p_image_url: document.getElementById('admin-about-img').value
            };

            showLoading(true);
            const { error } = await _supabase.rpc('upsert_about_secure', updates);
            showLoading(false);

            if(error) {
                // ì—ëŸ¬ë„ ëª¨ë‹¬ë¡œ ë„ìš°ë©´ ì¢‹ê² ì£ ? (ë‚´ìš© ë°”ê¿”ì„œ ì¬í™œìš©)
                document.getElementById('commonAlertText').innerText = 'ì €ì¥ ì‹¤íŒ¨: ' + error.message;
                new bootstrap.Modal(document.getElementById('commonAlertModal')).show();
            } else {
                // ì„±ê³µ ëª¨ë‹¬ ë„ìš°ê¸°
                document.getElementById('commonAlertText').innerText = 'ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                new bootstrap.Modal(document.getElementById('commonAlertModal')).show();
                
                fetchAboutSettings(); // ì €ì¥ í›„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            }
        }
        // [ë³´ì¡° í•¨ìˆ˜] ìƒíƒœì— ë”°ë¼ ìŠ¬ë¼ì´ë” ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
        function toggleProgressSlider() {
            const status = document.getElementById('plant-status').value;
            const area = document.getElementById('plant-progress-area');
            
            if (status === 'ìš´ì˜ì¤‘') {
                area.style.display = 'none'; // ìš´ì˜ì¤‘ì´ë©´ 100%ë‹ˆê¹Œ ìˆ¨ê¹€
            } else {
                area.style.display = 'block'; // ê³µì‚¬/ì¤€ë¹„ì¤‘ì´ë©´ ë³´ì„
            }
        }

        // [ìˆ˜ì •] ë°œì „ì†Œ ëª¨ë‹¬ ì—´ê¸° (ì§„í–‰ë¥  ë¶ˆëŸ¬ì˜¤ê¸° ì¶”ê°€)


        // [ìˆ˜ì •] ë°œì „ì†Œ ì €ì¥ (ì§„í–‰ë¥  í¬í•¨ ì „ì†¡)

        // [ì¶”ê°€] ë°œì „ì†Œ ì‚­ì œ ìš”ì²­
function askDeletePlant(id) {
            deleteType = 'plant';
            document.getElementById('delete-target-id').value = id;
            // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°
            document.getElementById('btn-real-delete').onclick = confirmDelete;
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        }

async function confirmDelete() {
            const id = document.getElementById('delete-target-id').value;
            const modalEl = document.getElementById('deleteConfirmModal');
            bootstrap.Modal.getInstance(modalEl).hide();

            showLoading(true);
            let rpcName = (deleteType === 'history') ? 'delete_document_secure' : 'delete_plant_secure';
            
            const { error } = await _supabase.rpc(rpcName, { p_id: id });
            showLoading(false);

            if (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            } else {
                if(deleteType === 'history') fetchHistory();
                else fetchPlants();
            }
        }
        // [ì‹ ê·œ] ìŠ¬ë¼ì´ë” ì›€ì§ì¼ ë•Œ ë‹¨ê³„ ì´ë¦„ í‘œì‹œ
        function updateProgressLabel(val) {
            const v = Number(val);
            let step = '';
            if (v < 20) step = 'ì¡°í•©ì„¤ë¦½ ë‹¨ê³„';
            else if (v < 40) step = 'ë¶€ì§€ì„ ì • ë‹¨ê³„';
            else if (v < 60) step = 'ì¸í—ˆê°€ ë‹¨ê³„';
            else if (v < 80) step = 'ì°©ê³µ/ê³µì‚¬ ë‹¨ê³„';
            else step = 'ì™„ê³µ/ìš´ì˜ ë‹¨ê³„';

            document.getElementById('plant-progress-label').innerText = `${v}% (${step})`;
        }
        
        // [ì‹ ê·œ] ê¸€ì”¨ í´ë¦­í•˜ë©´ ìŠ¬ë¼ì´ë” ì´ë™
        function setProg(val) {
            document.getElementById('plant-progress').value = val;
            updateProgressLabel(val);
        }

        

// [ì‹ ê·œ] ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‹¤ì œ íŒŒì¼ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
        async function deleteOldFile(fullUrl) {
            if (!fullUrl) return;
            try {
                // URLì—ì„œ íŒŒì¼ ê²½ë¡œë§Œ ì¶”ì¶œ (ì˜ˆ: .../assets/plants/abc.jpg -> plants/abc.jpg)
                const path = fullUrl.split('/assets/')[1]; 
                if (path) {
                    await _supabase.storage.from('assets').remove([path]);
                    console.log("ì‚­ì œëœ íŒŒì¼:", path);
                }
            } catch (e) {
                console.error("íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", e);
            }
        }

        // [ì‹ ê·œ] ì‚¬ì§„ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ (í™”ë©´ì—ì„œë§Œ ë¨¼ì € ì§€ì›€)
        function clearPlantImage() {
            document.getElementById('plant-file').value = ''; // íŒŒì¼ ì„ íƒ ì·¨ì†Œ
            document.getElementById('plant-img-url').value = ''; // ì €ì¥ë  URL ë¹„ì›€
            
            // í”„ë¦¬ë·° ê°ì¶”ê¸°
            document.getElementById('plant-img-preview').style.display = 'none';
            document.getElementById('plant-img-preview').src = '';
            document.getElementById('plant-img-placeholder').style.display = 'block';
        }

        // [ê¸°ì¡´ ìˆ˜ì •] ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewImage(input) {
            const file = input.files[0];
            const preview = document.getElementById('plant-img-preview');
            const placeholder = document.getElementById('plant-img-placeholder');
            
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        // [ê¸°ì¡´ ìˆ˜ì •] ë°œì „ì†Œ ëª¨ë‹¬ ì—´ê¸° (ê¸°ì¡´ ì´ë¯¸ì§€ URL ê¸°ì–µí•˜ê¸°)
        async function openPlantModal(id) {
            document.getElementById('plant-id').value = id || '';
            document.getElementById('plant-file').value = ''; 
            
            if(id) {
                // ìˆ˜ì • ëª¨ë“œ
                const { data } = await _supabase.from('site_power_plants').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('plant-name').value = data.name;
                    document.getElementById('plant-capacity').value = data.capacity;
                    document.getElementById('plant-order').value = data.display_order;
                    document.getElementById('plant-location').value = data.location || '';
                    document.getElementById('plant-area').value = data.area || '';
                    document.getElementById('plant-date').value = data.completion_date || '';
                    document.getElementById('plant-status').value = data.status;
                    document.getElementById('plant-url').value = data.monitor_url || '';
                    
                    const rate = data.progress_rate || 0;
                    document.getElementById('plant-progress').value = rate;
                    updateProgressLabel(rate);

                    // â˜… ì´ë¯¸ì§€ ì²˜ë¦¬ (ì›ë³¸ ê¸°ì–µ + í˜„ì¬ ìƒíƒœ ì„¤ì •)
                    const imgUrl = data.image_url || '';
                    document.getElementById('plant-img-original').value = imgUrl; // [ì¤‘ìš”] ì›ë³¸ ê¸°ì–µ (ë‚˜ì¤‘ì— ì‚­ì œí•  ë•Œ ì”€)
                    document.getElementById('plant-img-url').value = imgUrl;      // í˜„ì¬ ìƒíƒœ
                    
                    const preview = document.getElementById('plant-img-preview');
                    const placeholder = document.getElementById('plant-img-placeholder');
                    if(imgUrl) {
                        preview.src = imgUrl;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                    } else {
                        preview.style.display = 'none';
                        placeholder.style.display = 'block';
                    }
                }
            } else {
                // ì‹ ê·œ ëª¨ë“œ
                const maxOrder = g_plants.length > 0 ? Math.max(...g_plants.map(p => p.display_order)) : 0;
                ['plant-name','plant-capacity','plant-url','plant-location','plant-area','plant-date','plant-img-url','plant-img-original'].forEach(id => document.getElementById(id).value = '');
                
                document.getElementById('plant-order').value = maxOrder + 1; 
                document.getElementById('plant-status').value = 'ì¤€ë¹„ì¤‘';
                document.getElementById('plant-progress').value = 0;
                updateProgressLabel(0);
                
                document.getElementById('plant-img-preview').style.display = 'none';
                document.getElementById('plant-img-placeholder').style.display = 'block';
            }
            toggleProgressSlider();
            new bootstrap.Modal(document.getElementById('plantModal')).show();
        }

        // [ê¸°ì¡´ ìˆ˜ì •] ë°œì „ì†Œ ì €ì¥ (ìë™ ì‚­ì œ ë¡œì§ í¬í•¨)
        async function savePlant() {
            const name = document.getElementById('plant-name').value;
            if (!name) { alert("ë°œì „ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            showLoading(true);

            const fileInput = document.getElementById('plant-file');
            const originalUrl = document.getElementById('plant-img-original').value; // ì›ë˜ ìˆë˜ ì‚¬ì§„
            let finalImgUrl = document.getElementById('plant-img-url').value;      // ìµœì¢… ì €ì¥ë  ì‚¬ì§„ ì£¼ì†Œ

            // 1. ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œëœ ê²½ìš°
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = `plants/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                
                // (1) ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
                const { data: uploadData, error: uploadError } = await _supabase.storage.from('assets').upload(fileName, file);
                if (uploadError) {
                    showLoading(false);
                    alert('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadError.message);
                    return;
                }
                const { data: publicUrlData } = _supabase.storage.from('assets').getPublicUrl(fileName);
                finalImgUrl = publicUrlData.publicUrl;

                // (2) â˜… ì¤‘ìš”: ì˜›ë‚  ì‚¬ì§„ì´ ìˆì—ˆë‹¤ë©´ ì‚­ì œ! (ì“°ë ˆê¸° íŒŒì¼ ì •ë¦¬)
                if (originalUrl) {
                    await deleteOldFile(originalUrl);
                }
            } 
            // 2. íŒŒì¼ì€ ì•ˆ ì˜¬ë ¸ëŠ”ë°, [ì‚­ì œ ë²„íŠ¼]ì„ ëˆŒëŸ¬ì„œ URLì´ ë¹„ì–´ë²„ë¦° ê²½ìš°
            else if (originalUrl && !finalImgUrl) {
                // â˜… ì¤‘ìš”: ì›ë˜ ì‚¬ì§„ì„ ì‚­ì œí•¨
                await deleteOldFile(originalUrl);
            }

            // 3. DB ì €ì¥ (ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ê³¼ ë™ì¼)
            const capVal = document.getElementById('plant-capacity').value;
            const orderVal = document.getElementById('plant-order').value;
            
            const capacity = (capVal === '' || isNaN(capVal)) ? 0 : Number(capVal);
            const order = (orderVal === '' || isNaN(orderVal)) ? 0 : Number(orderVal);
            const status = document.getElementById('plant-status').value;
            const progress = (status === 'ìš´ì˜ì¤‘') ? 100 : Number(document.getElementById('plant-progress').value);

            const updates = {
                p_id: document.getElementById('plant-id').value || null,
                p_name: name,
                p_capacity: capacity,
                p_status: status,
                p_display_order: order,
                p_progress: progress,
                p_location: document.getElementById('plant-location').value,
                p_area: document.getElementById('plant-area').value,
                p_completion_date: document.getElementById('plant-date').value || null,
                p_image_url: finalImgUrl
            };

            const { error } = await _supabase.rpc('upsert_plant_secure', updates);
            showLoading(false);

            if(error) {
                if(document.getElementById('commonAlertModal')) {
                    document.getElementById('commonAlertText').innerText = 'ì €ì¥ ì‹¤íŒ¨: ' + error.message;
                    new bootstrap.Modal(document.getElementById('commonAlertModal')).show();
                } else alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            } else { 
                bootstrap.Modal.getInstance(document.getElementById('plantModal')).hide(); 
                fetchPlants(); 
            }
        }
// ================================================================
        // [ê¸°ëŠ¥ 8] ë¬¸ì„œ ê´€ë¦¬ (ì •ê´€/ê·œì•½)
        // ================================================================
        
        // 1. ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchDocs() {
            // categoryê°€ 'doc'ì¸ ê²ƒë§Œ ê°€ì ¸ì˜´
            const { data } = await _supabase.from('site_documents').select('*').eq('category', 'doc').order('event_date', {ascending:false});
            const tbody = document.getElementById('docListBody');
            tbody.innerHTML = '';
            
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-muted">ë“±ë¡ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(d => {
                const fileBtn = d.file_url 
                    ? `<a href="${d.file_url}" target="_blank" class="btn btn-xs btn-outline-success"><i class="bi bi-file-pdf"></i> ë³´ê¸°</a>` 
                    : '<span class="text-muted text-xs">ì—†ìŒ</span>';

                tbody.innerHTML += `<tr>
                    <td><div class="fw-bold">${d.version || '-'}</div><small class="text-muted">${d.event_date}</small></td>
                    <td>${d.title}</td>
                    <td class="text-start small text-truncate" style="max-width:200px;">${d.content || '-'}</td>
                    <td>${fileBtn}</td>
                    <td>
                        <button class="btn btn-sm btn-light" onclick="openDocModal('${d.id}')">ìˆ˜ì •</button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="askDeleteDoc('${d.id}')">ì‚­ì œ</button>
                    </td>
                </tr>`;
            });
        }

        // 2. ëª¨ë‹¬ ì—´ê¸°
// [ìˆ˜ì •] ë¬¸ì„œ ëª¨ë‹¬ ì—´ê¸°
        async function openDocModal(id) {
            document.getElementById('doc-id').value = id || '';
            document.getElementById('doc-file').value = ''; 
            
            if(id) {
                const { data } = await _supabase.from('site_documents').select('*').eq('id', id).single();
                if(data) {
                    document.getElementById('doc-title').value = data.title;
                    document.getElementById('doc-version').value = data.version || '';
                    document.getElementById('doc-date').value = data.event_date;
                    document.getElementById('doc-content').value = data.content || '';
                    document.getElementById('doc-file-url').value = data.file_url || '';
                    document.getElementById('doc-current').checked = data.is_current; // ì²´í¬ë°•ìŠ¤ ìƒíƒœ
                    
                    if(data.file_url) {
                        document.getElementById('doc-file-link').innerHTML = `<a href="${data.file_url}" target="_blank">íŒŒì¼ í™•ì¸</a>`;
                    } else {
                        document.getElementById('doc-file-link').innerText = '';
                    }
                }
            } else {
                // ì‹ ê·œ
                document.getElementById('doc-title').value = 'ì •ê´€'; // ê¸°ë³¸ê°’
                document.getElementById('doc-version').value = '';
                document.getElementById('doc-date').value = new Date().toISOString().substring(0, 10);
                document.getElementById('doc-content').value = '';
                document.getElementById('doc-file-url').value = '';
                document.getElementById('doc-file-link').innerText = '';
                document.getElementById('doc-current').checked = true; // ì‹ ê·œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í˜„ì¬ ë²„ì „
            }
            new bootstrap.Modal(document.getElementById('docModal')).show();
        }

        // [ìˆ˜ì •] ë¬¸ì„œ ì €ì¥ (is_current í¬í•¨)
        async function saveDoc() {
            const title = document.getElementById('doc-title').value;
            if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            showLoading(true);

            // íŒŒì¼ ì—…ë¡œë“œ (ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼)
            let finalUrl = document.getElementById('doc-file-url').value;
            const fileInput = document.getElementById('doc-file');
            if (fileInput.files.length > 0) {
               // ... (ê¸°ì¡´ íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ ê·¸ëŒ€ë¡œ ì‚¬ìš©) ...
            }

            const updates = {
                p_id: document.getElementById('doc-id').value || null,
                p_category: 'doc', 
                p_title: title,
                p_date: document.getElementById('doc-date').value,
                p_content: document.getElementById('doc-content').value,
                p_version: document.getElementById('doc-version').value,
                p_file_url: finalUrl,
                p_is_current: document.getElementById('doc-current').checked // ì¶”ê°€ë¨
            };

            const { error } = await _supabase.rpc('upsert_document_secure', updates);
            showLoading(false);

            if(error) alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            else {
                bootstrap.Modal.getInstance(document.getElementById('docModal')).hide();
                fetchDocs();
            }
        }

        // ì‚­ì œ (ê¸°ì¡´ ì‚­ì œ í•¨ìˆ˜ ì¬í™œìš©)
        function askDeleteDoc(id) {
            deleteType = 'history'; // ë¬¸ì„œëŠ” ê¸°ìˆ ì ìœ¼ë¡œ historyì™€ ê°™ì€ í…Œì´ë¸”(site_documents)ì„ ì”€
            document.getElementById('delete-target-id').value = id;
            document.getElementById('btn-real-delete').onclick = confirmDelete; 
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        }
    </script>
</body>
</html>
