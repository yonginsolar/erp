<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë§ˆì´í˜ì´ì§€</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<style>
body{background-color:#f0f2f5;padding:20px;font-family:'Malgun Gothic',sans-serif}
.main-container{max-width:1000px;margin:0 auto;padding-bottom:80px}
.hidden{display:none!important}
.profile-card{background:white;border-radius:15px;padding:30px;margin-bottom:20px;display:flex;align-items:center;box-shadow:0 4px 15px rgba(0,0,0,0.05)}
.profile-icon{width:70px;height:70px;background:#e9ecef;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;margin-right:20px}
.leave-badge{background-color:#fff;border:1px solid #0d6efd;color:#0d6efd;padding:5px 12px;border-radius:20px;font-size:0.9rem;font-weight:bold;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:5px;margin-left:10px;vertical-align:middle}
.leave-badge:hover{background-color:#0d6efd;color:white}
.nav-tabs .nav-link{color:#495057;cursor:pointer;font-weight:500;padding:12px 20px}
.nav-tabs .nav-link.active{font-weight:bold;color:#0d6efd;border-bottom:3px solid #0d6efd;background:transparent}
.tab-content{background:white;border:1px solid #dee2e6;border-top:none;border-radius:0 0 10px 10px;padding:30px;box-shadow:0 4px 15px rgba(0,0,0,0.05)}
.readonly-field{background-color:#f8f9fa;border:1px solid #eee;color:#555;pointer-events:none}
.editable-field{background-color:#fff;border:1px solid #ced4da;color:#000}
.salary-blur{filter:blur(6px);transition:filter 0.3s;cursor:pointer;user-select:none}
.salary-blur:hover{filter:blur(0)}
.amount-text{text-align:right;font-family:'Consolas',monospace;letter-spacing:-0.5px}
#calendar{max-width:100%;margin:0 auto;font-size:0.9rem}
.fc-event{cursor:pointer;border:none}
.fc-day-sun a{color:red;text-decoration:none}
.fc-day-sat a{color:blue;text-decoration:none}
.leave-section{margin-bottom:15px;border:1px solid #eee;border-radius:8px;background:#f8f9fa;padding:15px}
.leave-section h6{font-weight:bold;border-bottom:1px solid #ddd;padding-bottom:8px;margin-bottom:10px;font-size:0.95rem}
.leave-list{list-style:none;padding:0;margin:0;font-size:0.85rem}
.leave-list li{margin-bottom:6px}
.fc-day-other .fc-event { opacity: 0.5; filter: grayscale(100%); }
</style>
</head>
<body>
<div class="main-container">
<div class="d-flex justify-content-between align-items-center mb-4">
<h4 class="fw-bold m-0">ğŸ‘¤ My Page</h4>
<button onclick="location.href='index.html'" class="btn btn-outline-secondary btn-sm">ğŸ  ë©”ë‰´ë¡œ</button>
</div>
<div class="profile-card">
<div class="profile-icon">ğŸ‘¤</div>
<div>
<div class="d-flex align-items-center mb-1">
<h4 class="fw-bold m-0 me-2"><span id="dspName">Loading...</span></h4>
<span class="badge bg-primary rounded-pill fs-6" id="dspRank">-</span>
<div class="leave-badge" onclick="showLeaveDetail()" title="ìƒì„¸ ë‚´ì—­ ë³´ê¸°">
<span>ì”ì—¬ ì—°ì°¨: <span id="lvRemain">0</span>ì¼</span><span>ğŸ”</span>
</div>
</div>
<div class="text-muted small">
<span id="dspDept">-</span> | ì…ì‚¬ì¼: <span id="dspJoin">-</span> (<span id="dspTenure" class="text-primary fw-bold">-</span>)
</div>
</div>
</div>
<ul class="nav nav-tabs" id="myTab" role="tablist">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabInfo">ë‚´ ì •ë³´</button></li>
<li class="nav-item"><button class="nav-link" id="tab-calendar-btn" data-bs-toggle="tab" data-bs-target="#tabCalendar">ğŸ“… ì „ì‚¬ ì¼ì •</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSalary">ğŸ’° ê¸‰ì—¬ ëª…ì„¸ì„œ</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCert">ğŸ“œ ì¦ëª…ì„œ/ê³„ì•½ì„œ</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabNotice">ğŸ“¢ ê³µì§€ì‚¬í•­</button></li>
</ul>
<div class="tab-content">
<div class="tab-pane fade show active" id="tabInfo">
<div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
<h6 class="fw-bold m-0">ğŸ“ ê¸°ë³¸ ì •ë³´ ìˆ˜ì •</h6>
<div>
<button class="btn btn-sm btn-outline-primary" id="btnEditInfo" onclick="toggleEditMode(true)">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
<button class="btn btn-sm btn-secondary hidden" id="btnCancelInfo" onclick="toggleEditMode(false)">ì·¨ì†Œ</button>
<button class="btn btn-sm btn-primary hidden" id="btnSaveInfo" onclick="updateInfo()">ğŸ’¾ ì €ì¥ ì™„ë£Œ</button>
</div>
</div>
<div class="row g-3">
<div class="col-md-6"><label class="small text-muted">ì´ë¦„</label><input type="text" id="myName" class="form-control bg-light" readonly></div>
<div class="col-md-6"><label class="small text-muted">ë¶€ì–‘ê°€ì¡± (ì „ìê²°ì¬)</label><input type="number" id="myDependents" class="form-control bg-light" readonly placeholder="0"></div>
<div class="col-md-6"><label class="small text-muted">ì „í™”ë²ˆí˜¸</label><input type="text" id="myPhone" class="form-control readonly-field" maxlength="13" oninput="autoHyphen(this)"></div>
<div class="col-md-6"><label class="small text-muted">ì´ë©”ì¼</label><input type="email" id="myEmail" class="form-control readonly-field"></div>
<div class="col-12"><label class="small text-muted">ì£¼ì†Œ</label><div class="input-group"><input type="text" id="myAddress" class="form-control readonly-field" placeholder="ì£¼ì†Œ" readonly><button class="btn btn-outline-secondary hidden" id="btnAddrSearch" type="button" onclick="openAddressSearch()">ğŸ” ê²€ìƒ‰</button></div></div>
<div class="col-md-6"><label class="small text-muted">ê¸‰ì—¬ ì€í–‰</label><input type="text" id="myBank" class="form-control readonly-field"></div>
<div class="col-md-6"><label class="small text-muted">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="myAccount" class="form-control readonly-field"></div>
</div>
<div class="mt-5 pt-3 border-top">
<div class="d-flex justify-content-between align-items-center mb-3">
<h6 class="fw-bold m-0">ğŸš¨ ë¹„ìƒ ì—°ë½ë§</h6>
<button class="btn btn-sm btn-outline-dark hidden" id="btnAddEm" onclick="addEmergencyUI()">+ ì¶”ê°€</button>
</div>
<div class="table-responsive">
<table class="table table-hover align-middle">
<thead class="table-light"><tr><th>ì´ë¦„</th><th>ê´€ê³„</th><th>ì—°ë½ì²˜</th><th style="width:60px;"></th></tr></thead>
<tbody id="emergencyListBody"></tbody>
</table>
</div>
</div>
</div>
<div class="tab-pane fade" id="tabCalendar"><div id="calendar"></div></div>
<div class="tab-pane fade" id="tabSalary">
<div class="d-flex justify-content-between align-items-center mb-3">
<div class="input-group" style="max-width: 250px;">
<input type="month" class="form-control" id="salaryMonth">
<button class="btn btn-primary" onclick="searchSalary()">ì¡°íšŒ</button>
</div>
<button class="btn btn-sm btn-dark hidden" id="btnPrintSalary" onclick="printSalaryPopup()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
</div>
<div id="salaryResult" class="hidden mt-4">
<div class="card p-4 shadow-sm border-0">
<h5 class="fw-bold text-center mb-4"><span id="sl_ym_display"></span> ê¸‰ì—¬ ë‚´ì—­</h5>
<div class="row">
<div class="col-6"><table class="table table-bordered"><thead class="table-light"><tr><th colspan="2" class="text-primary text-center">ì§€ê¸‰</th></tr></thead><tbody id="tbl_pay_body"></tbody></table></div>
<div class="col-6"><table class="table table-bordered"><thead class="table-light"><tr><th colspan="2" class="text-danger text-center">ê³µì œ</th></tr></thead><tbody id="tbl_ded_body"></tbody></table></div>
</div>
<div class="p-3 bg-primary bg-opacity-10 rounded text-center border border-primary mt-3">
<span class="text-primary me-2 fw-bold">ì‹¤ ìˆ˜ë ¹ì•¡</span>
<h3 class="fw-bold m-0 d-inline-block"><span class="salary-blur" id="v_net">0</span> ì›</h3>
</div>
</div>
</div>
</div>
<div class="tab-pane fade" id="tabCert">
<div class="card p-3 border mb-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="fw-bold mb-1">ğŸ“„ ì¬ì§ì¦ëª…ì„œ</h6><small class="text-muted">ì€í–‰/ê´€ê³µì„œ ì œì¶œìš©</small></div><button class="btn btn-outline-primary" id="btnCert" onclick="openCertModal()">ë°œê¸‰ ì‹ ì²­</button></div></div>
<div class="card p-3 border"><div class="d-flex justify-content-between align-items-center"><div><h6 class="fw-bold mb-1">ğŸ¤ ê·¼ë¡œê³„ì•½ì„œ</h6><small class="text-muted">ì„œëª… ì™„ë£Œëœ ê³„ì•½ì„œ</small></div><button class="btn btn-secondary" id="btnContract" onclick="viewContract()" disabled>ë“±ë¡ëœ ê³„ì•½ì„œ ì—†ìŒ</button></div></div>
</div>
<div class="tab-pane fade" id="tabNotice"><div class="list-group" id="noticeList"><div class="text-center p-3 text-muted">ë¡œë”© ì¤‘...</div></div></div>
</div>
</div>
<div class="modal fade" id="certPurposeModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold">ë°œê¸‰ ìš©ë„</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select class="form-select mb-2" id="certPurposeSelect" onchange="toggleEtcInput()"><option value="ê´€ê³µì„œ ì œì¶œìš©">ê´€ê³µì„œ ì œì¶œìš©</option><option value="ê¸ˆìœµê¸°ê´€ ì œì¶œìš©">ê¸ˆìœµê¸°ê´€ ì œì¶œìš©</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select><input type="text" id="certPurposeEtc" class="form-control hidden" placeholder="ìš©ë„ ì…ë ¥"></div><div class="modal-footer"><button class="btn btn-primary btn-sm" onclick="runCertIssue()">ì¸ì‡„í•˜ê¸°</button></div></div></div></div>
<div class="modal fade" id="leaveDetailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-light"><h6 class="modal-title fw-bold">ì—°ì°¨ ìƒì„¸ ë¦¬í¬íŠ¸</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-3"></div><div class="modal-footer justify-content-center p-1 border-0"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button></div></div></div></div>
<div class="modal fade" id="noticeDetailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold" id="noticeModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="text-muted small mb-3"><span id="noticeModalDate"></span> | <span id="noticeModalWriter"></span></div><div id="noticeModalContent" style="white-space: pre-wrap;"></div><div id="noticeFileArea" class="mt-3 pt-2 border-top hidden"><a href="#" id="noticeFileLink" target="_blank">ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a></div></div></div></div></div>
<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body text-center fw-bold py-4" id="alertBody"></div><div class="modal-footer justify-content-center p-1 border-0"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="eventModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">ğŸ“… ì¼ì • ê´€ë¦¬</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
<input type="hidden" id="evtId">
<div class="mb-2"><label class="small text-muted mb-1">ì¼ì •ëª…</label><input type="text" id="evtTitle" class="form-control" placeholder="ì¼ì • ì œëª©"></div>
<div class="mb-2"><label class="small text-muted mb-1">ê³µê°œ ë²”ìœ„</label><select id="evtVisibility" class="form-select"><option value="company">ğŸ¢ ì „ì²´ ê³µê°œ (ì „ì§ì›)</option><option value="admin">ğŸ”’ ê´€ë¦¬ì ì „ìš© (ì„¸ë¬´/í–‰ì •)</option><option value="private">ğŸ‘¤ ë‚˜ë§Œ ë³´ê¸° (ê°œì¸ ì¼ì •)</option></select></div>
<div class="mb-2"><label class="small text-muted mb-1">ì¼ì‹œ</label><div class="d-flex gap-2"><input type="date" id="evtDate" class="form-control"><input type="time" id="evtTime" class="form-control"></div></div>
<div class="mb-2"><label class="small text-muted mb-1">ë°˜ë³µ ì„¤ì •</label><select id="evtRecure" class="form-select"><option value="none">ë°˜ë³µ ì—†ìŒ</option><option value="yearly">ë§¤ë…„ ë°˜ë³µ</option><option value="monthly">ë§¤ì›” ë°˜ë³µ</option></select></div>
<div class="mb-3"><label class="small text-muted mb-1">ë©”ëª¨</label><textarea id="evtMemo" class="form-control" rows="4" placeholder="ìƒì„¸ ë‚´ìš© ì…ë ¥..."></textarea></div>
<div class="form-check"><input class="form-check-input" type="checkbox" id="evtIsHoliday"><label class="form-check-label small" for="evtIsHoliday">ê³µíœ´ì¼ (ë¹¨ê°„ë‚  í‘œì‹œ)</label></div>
</div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-danger btn-sm hidden" id="btnDelEvent" onclick="deleteEvent()">ì‚­ì œ</button><div><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button><button type="button" class="btn btn-primary btn-sm" id="btnSaveEvent" onclick="saveEvent()">ì €ì¥</button></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://ifdqlwxgqgsvnawmhlfc.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let myInfo={},companyInfo={},currentSalaryData=null,tempEmergencyList=[],noticesData=[];
let purposeModal,leaveDetailModal,noticeDetailModal,alertModal,eventModal;
window.onload=async function(){
purposeModal=new bootstrap.Modal(document.getElementById('certPurposeModal'));
leaveDetailModal=new bootstrap.Modal(document.getElementById('leaveDetailModal'));
noticeDetailModal=new bootstrap.Modal(document.getElementById('noticeDetailModal'));
alertModal=new bootstrap.Modal(document.getElementById('alertModal'));
eventModal=new bootstrap.Modal(document.getElementById('eventModal'));
const stored=localStorage.getItem('erp_user');
if(!stored){showAlert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");location.href='index.html';return}
myInfo=JSON.parse(stored);
document.getElementById("salaryMonth").value=new Date().toISOString().slice(0,7);
document.getElementById('tab-calendar-btn').addEventListener('shown.bs.tab',function(e){renderCalendar()});
await loadCompanyInfo();
await Promise.all([loadProfile(),loadEmergencyList(),loadNotices(),calculateLeave()]);
};
function showAlert(m){document.getElementById("alertBody").innerHTML=m;alertModal.show()}
function autoHyphen(t){t.value=t.value.replace(/[^0-9]/g,'').replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g,"$1-$2-$3").replace(/(\-{1,2})$/g,"")}
function openAddressSearch(){new daum.Postcode({oncomplete:function(d){let a=d.userSelectedType==='R'?d.roadAddress:d.jibunAddress;if(d.buildingName)a+=' ('+d.buildingName+')';document.getElementById("myAddress").value=a}}).open()}
async function loadCompanyInfo(){const{data}=await _supabase.from('ref_company_info').select('*');if(data)data.forEach(i=>companyInfo[i.key]=i.value);companyInfo.chairman=companyInfo.ceoName||"ì´ì‚¬ì¥";if(companyInfo.logo_horizontal_url&&!companyInfo.logo_horizontal_url.startsWith('http')){const{data:d}=_supabase.storage.from('assets').getPublicUrl(companyInfo.logo_horizontal_url);companyInfo.logo_horizontal_url=d.publicUrl}if(companyInfo.seal_url){let p=companyInfo.seal_url.startsWith('http')?companyInfo.seal_url.split('/').pop():companyInfo.seal_url;const{data:d}=await _supabase.storage.from('attachments').createSignedUrl(p,3600);if(d)companyInfo.seal_url=d.signedUrl}}
async function loadProfile(){const{data}=await _supabase.from('ref_employees').select('*').eq('emp_id',myInfo.emp_id).single();if(data){myInfo=data;localStorage.setItem('erp_user',JSON.stringify(data))}document.getElementById("dspName").innerText=myInfo.emp_name;document.getElementById("dspRank").innerText=myInfo.position;document.getElementById("dspDept").innerText=myInfo.department;document.getElementById("dspJoin").innerText=myInfo.hire_date||'-';document.getElementById("myName").value=myInfo.emp_name;document.getElementById("myDependents").value=myInfo.dependents||0;document.getElementById("myPhone").value=myInfo.phone||"";document.getElementById("myEmail").value=myInfo.email||"";document.getElementById("myAddress").value=myInfo.address||"";document.getElementById("myBank").value=myInfo.bank_name||"";document.getElementById("myAccount").value=myInfo.account_number||"";const btn=document.getElementById("btnContract");if(myInfo.contract_url){let u=myInfo.contract_url.startsWith('http')?myInfo.contract_url:null;if(!u){const{data:d}=await _supabase.storage.from('contracts').createSignedUrl(myInfo.contract_url,3600);if(d)u=d.signedUrl}if(u){btn.disabled=false;btn.className="btn btn-outline-primary fw-bold";btn.innerText="ğŸ“„ ê³„ì•½ì„œ ë³´ê¸°";btn.onclick=()=>window.open(u)}}}
function toggleEditMode(e){const f=document.querySelectorAll('.readonly-field');f.forEach(x=>{if(e){x.classList.remove('readonly-field');x.classList.add('editable-field');x.readOnly=false}else{x.classList.add('readonly-field');x.classList.remove('editable-field');x.readOnly=true}});document.getElementById("btnEditInfo").classList.toggle('hidden',e);document.getElementById("btnCancelInfo").classList.toggle('hidden',!e);document.getElementById("btnSaveInfo").classList.toggle('hidden',!e);document.getElementById("btnAddrSearch").classList.toggle('hidden',!e);document.getElementById("btnAddEm").classList.toggle('hidden',!e);if(!e){loadProfile();loadEmergencyList()}}
async function updateInfo(){if(!confirm("ì •ë³´ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;const u={phone:document.getElementById("myPhone").value,email:document.getElementById("myEmail").value,address:document.getElementById("myAddress").value,bank_name:document.getElementById("myBank").value,account_number:document.getElementById("myAccount").value};const{error}=await _supabase.from('ref_employees').update(u).eq('emp_id',myInfo.emp_id);if(error){showAlert("ì €ì¥ ì‹¤íŒ¨: "+error.message);return}await _supabase.from('ref_emergency_contacts').delete().eq('emp_id',myInfo.emp_id);if(tempEmergencyList.length>0){const i=tempEmergencyList.map(x=>({emp_id:myInfo.emp_id,contact_name:x.contact_name,relation:x.relation,phone:x.phone}));await _supabase.from('ref_emergency_contacts').insert(i)}showAlert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");toggleEditMode(false)}
async function loadEmergencyList(){const{data}=await _supabase.from('ref_emergency_contacts').select('*').eq('emp_id',myInfo.emp_id).order('id');tempEmergencyList=data||[];renderEmergencyTable()}
function renderEmergencyTable(){const b=document.getElementById("emergencyListBody");b.innerHTML="";const e=!document.getElementById("btnSaveInfo").classList.contains('hidden');tempEmergencyList.forEach((r,i)=>{b.innerHTML+=`<tr><td>${r.contact_name}</td><td>${r.relation}</td><td>${r.phone}</td><td>${e?`<button class="btn btn-sm btn-outline-danger py-0" onclick="removeTempEm(${i})">Ã—</button>`:''}</td></tr>`})}
function addEmergencyUI(){const b=document.getElementById("emergencyListBody"),t=document.createElement('tr');t.innerHTML=`<td><input type="text" class="form-control form-control-sm" id="newEmName" placeholder="ì´ë¦„"></td><td><input type="text" class="form-control form-control-sm" id="newEmRel" placeholder="ê´€ê³„"></td><td><input type="text" class="form-control form-control-sm" id="newEmPhone" placeholder="ì—°ë½ì²˜" oninput="autoHyphen(this)"></td><td><button class="btn btn-sm btn-primary py-0" onclick="confirmAddEm(this)">V</button></td>`;b.appendChild(t)}
function confirmAddEm(b){const t=b.closest('tr'),n=t.querySelector('#newEmName').value,r=t.querySelector('#newEmRel').value,p=t.querySelector('#newEmPhone').value;if(!n||!r)return;tempEmergencyList.push({contact_name:n,relation:r,phone:p});renderEmergencyTable()}
function removeTempEm(i){tempEmergencyList.splice(i,1);renderEmergencyTable()}
async function renderCalendar(){const{data:l}=await _supabase.from('ref_approval').select('*').eq('doc_type','íœ´ê°€').eq('status','ì™„ë£Œ');const{data:e}=await _supabase.from('view_employees_calendar').select('*');const{data:c}=await _supabase.from('ref_calendar').select('*');let evts=[];const bY=new Date().getFullYear();const yrs=[bY-2,bY-1,bY,bY+1,bY+2];if(l)l.forEach(x=>evts.push({title:`${x.drafter_name}(${x.drafter_dept||''}) íœ´ê°€`,start:x.start_date,end:x.end_date,color:(x.drafter_id===myInfo.emp_id?'#0d6efd':'#198754'),allDay:true,extendedProps:{origin:{title:`${x.drafter_name} íœ´ê°€`,start_date:x.start_date,type:'leave',visibility:'company',cal_memo:`ê²°ì¬ ì™„ë£Œëœ íœ´ê°€ì…ë‹ˆë‹¤.\nê¸°ì•ˆì: ${x.drafter_name}`}}}));if(e)e.forEach(p=>{const dn=p.department?`(${p.department})`:'';if(p.birth_date)yrs.forEach(y=>evts.push({title:`${p.emp_name}${dn} ğŸ‚`,start:`${y}-${p.birth_date}`,color:'#ffc107',textColor:'#000',allDay:true,extendedProps:{origin:{title:`${p.emp_name} ìƒì¼ ğŸ‚`,start_date:`${y}-${p.birth_date}`,type:'event',visibility:'company',cal_memo:`${p.emp_name}ë‹˜ì˜ ìƒì¼ì…ë‹ˆë‹¤.\në¶€ì„œ: ${p.department||'-'}`}}}));if(p.hire_date){const hY=parseInt(p.hire_date.substring(0,4));yrs.forEach(y=>{const diff=y-hY;if(diff>0)evts.push({title:`${p.emp_name}${dn} ì…ì‚¬ ${diff}ì£¼ë…„ ğŸ‰`,start:`${y}-${p.hire_date.slice(5,10)}`,color:'#0dcaf0',textColor:'#000',allDay:true,extendedProps:{origin:{title:`${p.emp_name} ì…ì‚¬ ${diff}ì£¼ë…„ ğŸ‰`,start_date:`${y}-${p.hire_date.slice(5,10)}`,type:'event',visibility:'company',cal_memo:`${p.emp_name}ë‹˜ì˜ ì…ì‚¬ ${diff}ì£¼ë…„ì…ë‹ˆë‹¤.\nì…ì‚¬ì¼: ${p.hire_date}`}}})})}});if(c)c.forEach(x=>{if(x.visibility==='admin'&&myInfo.role!=='admin')return;if(x.visibility==='private'&&x.created_by!==myInfo.emp_id)return;const bg=x.visibility==='admin'?'#6610f2':(x.visibility==='private'?'#198754':(x.type==='holiday'?'#dc3545':'#0d6efd'));if(x.recurrence==='yearly'){yrs.forEach(y=>{evts.push({id:x.id,title:x.title,start:`${y}-${x.start_date.slice(5,10)}${x.start_date.length>10?'T'+x.start_date.slice(11,16):''}`,color:bg,extendedProps:{origin:x}})});}else if(x.recurrence==='monthly'){yrs.forEach(y=>{for(let m=1;m<=12;m++){const mm=String(m).padStart(2,'0'),dd=x.start_date.slice(8,10);if(new Date(`${y}-${mm}-${dd}`).getDate()==dd){evts.push({id:x.id,title:x.title,start:`${y}-${mm}-${dd}${x.start_date.length>10?'T'+x.start_date.slice(11,16):''}`,color:bg,extendedProps:{origin:x}})}}});}else{evts.push({id:x.id,title:x.title,start:x.start_date,end:x.end_date,color:bg,extendedProps:{origin:x}})}});if(companyInfo.estDate){const tY=new Date().getFullYear();for(let y=tY-50;y<=tY+50;y++){evts.push({title:"ğŸ‰ ì°½ë¦½ê¸°ë…ì¼",start:`${y}-${companyInfo.estDate.slice(5,10)}`,color:'#ff4081',allDay:true,extendedProps:{origin:{title:"ğŸ‰ ì°½ë¦½ê¸°ë…ì¼",start_date:`${y}-${companyInfo.estDate.slice(5,10)}`,type:'event',visibility:'company',cal_memo:`ìš°ë¦¬ íšŒì‚¬ì˜ ì°½ë¦½ê¸°ë…ì¼ì…ë‹ˆë‹¤.\nì„¤ë¦½ì¼: ${companyInfo.estDate}`}}}})}const el=document.getElementById('calendar');const cal=new FullCalendar.Calendar(el,{initialView:'dayGridMonth',locale:'ko',height:600,headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,listMonth'},dayMaxEvents:true,events:evts,selectable:true,dateClick:function(i){openEventModal(null,i.dateStr)},eventClick:function(i){if(i.event.extendedProps.origin){openEventModal(i.event.extendedProps.origin,null)}}});cal.render()}
async function calculateLeave(){const{data:r,error}=await _supabase.rpc('calculate_leave_days',{p_emp_id:myInfo.emp_id});if(error){console.error(error);return}const v=r!==null?r:0;document.getElementById("lvRemain").innerText=v;const b=document.querySelector('.leave-badge');if(v<=0){b.style.borderColor='#dc3545';b.style.color='#dc3545'}else{b.style.borderColor='#0d6efd';b.style.color='#0d6efd'}}
async function showLeaveDetail(){
const el=document.getElementById('leaveDetailModal'),bd=el.querySelector('.modal-body');if(!el)return;
bd.innerHTML='<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';leaveDetailModal.show();
const{data:em}=await _supabase.from('ref_employees').select('hire_date').eq('emp_id',myInfo.emp_id).single();
const{data:al}=await _supabase.from('hr_leave_adj').select('*').eq('emp_id',myInfo.emp_id).order('created_at',{ascending:false});
const{data:ul}=await _supabase.from('ref_approval').select('created_at,doc_type,amount,status').eq('drafter_id',myInfo.emp_id).in('status',['ì™„ë£Œ','ê°€ìŠ¹ì¸','ì¦ë¹™í™•ì¸ì¤‘']).or('doc_type.ilike.%(ì—°ì°¨)%,doc_type.ilike.%(ë°˜ì°¨)%').order('created_at',{ascending:false});
let h='<div class="d-flex flex-column gap-3">';
let gh='<ul class="leave-list">';
if(em&&em.hire_date){const hd=new Date(em.hire_date),n=new Date(),oy=new Date(hd);oy.setFullYear(oy.getFullYear()+1);if(n<oy){let m=(n.getFullYear()-hd.getFullYear())*12+(n.getMonth()-hd.getMonth());if(n.getDate()<hd.getDate())m--;gh+=`<li class="text-primary">ğŸŸ¢ 1ë…„ ë¯¸ë§Œ: ${Math.min(11,Math.max(0,m))}ê°œ</li>`}else{gh+=`<li class="text-muted">âšª 1ë…„ ë¯¸ë§Œ: 0ê°œ</li>`}if(n.getFullYear()>hd.getFullYear())gh+=`<li class="text-primary">ğŸ”µ íšŒê³„ì—°ë„(${n.getFullYear()}): 15ê°œ</li>`;else gh+=`<li class="text-muted">âšª íšŒê³„ì—°ë„: 0ê°œ</li>`}gh+='</ul>';h+=`<div class="leave-section"><h6>ğŸ ë°œìƒ ë‚´ì—­</h6>${gh}</div>`;
let ah='<ul class="leave-list">';if(al&&al.length>0)al.forEach(i=>{const c=(i.adj_type==='ì§€ê¸‰'||i.adj_type==='í¬ìƒ')?'text-success':'text-danger',s=(i.adj_type==='ì§€ê¸‰'||i.adj_type==='í¬ìƒ')?'+':'-';ah+=`<li><span class="${c} fw-bold">[${i.adj_type}]</span> ${i.reason||''} (${s}${i.days}ì¼)</li>`});else ah+='<li class="text-muted">- ì—†ìŒ -</li>';ah+='</ul>';h+=`<div class="leave-section"><h6>âš–ï¸ ì¡°ì • ë‚´ì—­</h6>${ah}</div>`;
let uh='<ul class="leave-list">';if(ul&&ul.length>0)ul.forEach(i=>{const d=i.created_at.slice(0,10);let b='';if(i.status==='ê°€ìŠ¹ì¸')b='<span class="badge bg-warning text-dark ms-1" style="font-size:0.7em">ê°€ìŠ¹ì¸</span>';if(i.status==='ì¦ë¹™í™•ì¸ì¤‘')b='<span class="badge bg-info text-dark ms-1" style="font-size:0.7em">ì¦ë¹™ì¤‘</span>';uh+=`<li class="border-bottom pb-1 mb-1"><div class="d-flex justify-content-between"><span>${i.doc_type} ${b}</span><span class="fw-bold text-danger">-${i.amount}ì¼</span></div><div class="text-muted" style="font-size:0.75rem;">${d}</div></li>`});else uh+='<li class="text-muted">- ì—†ìŒ -</li>';uh+='</ul>';h+=`<div class="leave-section"><h6>ğŸ« ì‚¬ìš© ë‚´ì—­</h6>${uh}</div>`;
h+='</div>';bd.innerHTML=h;
}
function openEventModal(e,d){
const b=document.getElementById("btnDelEvent"),s=document.getElementById("btnSaveEvent");
const inputs=eventModal._element.querySelectorAll('input, select, textarea');
const canEdit= !e || (myInfo.role==='admin' || e.created_by===myInfo.emp_id);
inputs.forEach(el=>{el.disabled=!canEdit});
if(canEdit){s.classList.remove('hidden');if(e)b.classList.remove("hidden");else b.classList.add("hidden")}else{s.classList.add('hidden');b.classList.add("hidden")}
if(e){document.getElementById("evtId").value=e.id;document.getElementById("evtTitle").value=e.title;document.getElementById("evtVisibility").value=e.visibility||'company';const dt=e.start_date.split('T');document.getElementById("evtDate").value=dt[0];document.getElementById("evtTime").value=dt[1]?dt[1].slice(0,5):"";document.getElementById("evtRecure").value=e.recurrence||'none';document.getElementById("evtIsHoliday").checked=(e.type==='holiday');document.getElementById("evtMemo").value=e.cal_memo||""}else{document.getElementById("evtId").value="";document.getElementById("evtTitle").value="";document.getElementById("evtVisibility").value='private';document.getElementById("evtDate").value=d;document.getElementById("evtTime").value="";document.getElementById("evtRecure").value="none";document.getElementById("evtIsHoliday").checked=false;document.getElementById("evtMemo").value=""}
eventModal.show();
}
async function saveEvent(){
const i=document.getElementById("evtId").value,t=document.getElementById("evtTitle").value,v=document.getElementById("evtVisibility").value,d=document.getElementById("evtDate").value,tm=document.getElementById("evtTime").value,r=document.getElementById("evtRecure").value,tp=document.getElementById("evtIsHoliday").checked?'holiday':'company',mm=document.getElementById("evtMemo").value;
if(!t||!d){showAlert("ì…ë ¥ í™•ì¸");return}const fd=tm?`${d}T${tm}:00`:d,p={title:t,start_date:fd,type:tp,recurrence:r,visibility:v,created_by:myInfo.emp_id,cal_memo:mm};
const{error}=i?await _supabase.from('ref_calendar').update(p).eq('id',i):await _supabase.from('ref_calendar').insert(p);
if(error)showAlert("ì €ì¥ ì‹¤íŒ¨: "+error.message);else{showAlert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");eventModal.hide();renderCalendar()}
}
async function deleteEvent(){const i=document.getElementById("evtId").value;if(!i||!confirm("ì‚­ì œí•©ë‹ˆê¹Œ?"))return;await _supabase.from('ref_calendar').delete().eq('id',i);eventModal.hide();renderCalendar()}
async function searchSalary(){const ym=document.getElementById("salaryMonth").value;const{data}=await _supabase.from('hr_salary').select('*').eq('emp_id',myInfo.emp_id).eq('year_month',ym).single();if(!data){showAlert("ë‚´ì—­ ì—†ìŒ");return}currentSalaryData=data;currentSalaryData.year_month=ym;document.getElementById("salaryResult").classList.remove("hidden");document.getElementById("btnPrintSalary").classList.remove("hidden");const[y,m]=ym.split('-');document.getElementById("sl_ym_display").innerText=`${y}ë…„ ${Number(m)}ì›”`;const f=n=>Number(n).toLocaleString(),p=[['pay_basic','ê¸°ë³¸ê¸‰'],['pay_meal','ì‹ëŒ€'],['pay_car','ì°¨ëŸ‰ìœ ì§€ë¹„'],['pay_position','ì§ì±…ìˆ˜ë‹¹'],['pay_service','ê·¼ì†ìˆ˜ë‹¹'],['pay_overtime','ì—°ì¥ìˆ˜ë‹¹'],['pay_child','ìœ¡ì•„ìˆ˜ë‹¹'],['pay_bonus','ìƒì—¬ê¸ˆ']],d=[['ded_pension','êµ­ë¯¼ì—°ê¸ˆ'],['ded_health','ê±´ê°•ë³´í—˜'],['ded_care','ì¥ê¸°ìš”ì–‘'],['ded_employ','ê³ ìš©ë³´í—˜'],['ded_income','ì†Œë“ì„¸'],['ded_local','ì§€ë°©ì†Œë“ì„¸'],['ded_advance','ê°€ë¶ˆê¸ˆ'],['ded_capital','ì¶œìê¸ˆ']];let ph="";p.forEach(i=>ph+=`<tr><td>${i[1]}</td><td class="amount-text"><span class="salary-blur">${f(data[i[0]]||0)}</span></td></tr>`);ph+=`<tr><td class="bg-light fw-bold">ì§€ê¸‰ê³„</td><td class="amount-text text-primary fw-bold"><span class="salary-blur">${f(data.pay_total)}</span></td></tr>`;document.getElementById("tbl_pay_body").innerHTML=ph;let dh="";d.forEach(i=>dh+=`<tr><td>${i[1]}</td><td class="amount-text"><span class="salary-blur">${f(data[i[0]]||0)}</span></td></tr>`);dh+=`<tr><td class="bg-light fw-bold">ê³µì œê³„</td><td class="amount-text text-danger fw-bold"><span class="salary-blur">${f(data.ded_total)}</span></td></tr>`;document.getElementById("tbl_ded_body").innerHTML=dh;document.getElementById("v_net").innerText=f(data.net_pay)}
function printSalaryPopup(){if(!currentSalaryData)return showAlert("ì¡°íšŒ í•„ìš”");printDocument(currentSalaryData)}
function printDocument(d){const w=window.open('','','width=900,height=1100'),[y,m]=d.year_month.split('-'),[yy,mm]=d.year_month.split('-').map(Number);let sd=1,ld=new Date(yy,mm,0).getDate();if(myInfo.hire_date){const h=new Date(myInfo.hire_date);if(h.getFullYear()===yy&&h.getMonth()+1===mm)sd=h.getDate()}const ad=`${y}ë…„ ${Number(m)}ì›”<br><span style="font-size:11px;color:#555;">(${y}.${m}.${String(sd).padStart(2,'0')} ~ ${y}.${m}.${ld})</span>`,pd=new Date(y,Number(m),10),pds=`${pd.getFullYear()}ë…„ ${pd.getMonth()+1}ì›” ${pd.getDate()}ì¼`,f=n=>n?Number(n).toLocaleString():'0',c=`<div style="font-family:'Malgun Gothic',serif;color:#333;padding-top:20px;"><h1 style="text-align:center;font-size:32px;margin:0 0 30px;">${y}ë…„ ${Number(m)}ì›” ê¸‰ì—¬ëª…ì„¸ì„œ</h1><table style="width:100%;border-collapse:collapse;margin-bottom:30px;font-size:13px;"><tr><td style="background:#e0e0e0;width:15%;padding:8px;border:1px solid #000;">ê·€ì†ì—°ì›”</td><td style="width:35%;padding:8px;border:1px solid #000;">${ad}</td><td style="background:#e0e0e0;width:15%;padding:8px;border:1px solid #000;">ì‚¬ì›</td><td style="width:35%;padding:8px;border:1px solid #000;">${myInfo.emp_id} / ${myInfo.emp_name}</td></tr><tr><td style="background:#e0e0e0;padding:8px;border:1px solid #000;">ì§€ê¸‰ì¼ì</td><td style="padding:8px;border:1px solid #000;">${pds}</td><td style="background:#e0e0e0;padding:8px;border:1px solid #000;">ì†Œì†</td><td style="padding:8px;border:1px solid #000;">${myInfo.department}/${myInfo.position}</td></tr></table><div style="display:flex;gap:30px;margin-bottom:40px;border-top:2px solid #aaa;"><div style="flex:1;"><div style="text-align:center;color:#1e88e5;font-weight:bold;padding:8px;border-bottom:2px solid #1e88e5;">ì§€ê¸‰ë‚´ì—­</div><table style="width:100%;font-size:13px;line-height:2.0;"><tr><td>ê¸°ë³¸ê¸‰</td><td style="text-align:right;">${f(d.pay_basic)}</td></tr><tr><td>ì‹ëŒ€</td><td style="text-align:right;">${f(d.pay_meal)}</td></tr><tr><td>ì°¨ëŸ‰</td><td style="text-align:right;">${f(d.pay_car)}</td></tr><tr><td>ì§ì±…</td><td style="text-align:right;">${f(d.pay_position)}</td></tr><tr><td>ê·¼ì†</td><td style="text-align:right;">${f(d.pay_service)}</td></tr><tr><td>ì—°ì¥</td><td style="text-align:right;">${f(d.pay_overtime)}</td></tr><tr><td>ìœ¡ì•„</td><td style="text-align:right;">${f(d.pay_child)}</td></tr><tr><td>ìƒì—¬</td><td style="text-align:right;">${f(d.pay_bonus)}</td></tr></table></div><div style="flex:1;"><div style="text-align:center;color:#e53935;font-weight:bold;padding:8px;border-bottom:2px solid #e53935;">ê³µì œë‚´ì—­</div><table style="width:100%;font-size:13px;line-height:2.0;"><tr><td>êµ­ë¯¼ì—°ê¸ˆ</td><td style="text-align:right;">${f(d.ded_pension)}</td></tr><tr><td>ê±´ê°•ë³´í—˜</td><td style="text-align:right;">${f(d.ded_health)}</td></tr><tr><td>ì¥ê¸°ìš”ì–‘</td><td style="text-align:right;">${f(d.ded_care)}</td></tr><tr><td>ê³ ìš©ë³´í—˜</td><td style="text-align:right;">${f(d.ded_employ)}</td></tr><tr><td>ì†Œë“ì„¸</td><td style="text-align:right;">${f(d.ded_income)}</td></tr><tr><td>ì§€ë°©ì†Œë“ì„¸</td><td style="text-align:right;">${f(d.ded_local)}</td></tr><tr><td>ê°€ë¶ˆê¸ˆ</td><td style="text-align:right;">${f(d.ded_advance)}</td></tr><tr><td>ì¶œìê¸ˆ</td><td style="text-align:right;">${f(d.ded_capital)}</td></tr></table></div></div><div style="border-top:1px solid #999;margin-bottom:20px;"></div><div style="height:120px;position:relative;"><div style="position:absolute;top:30px;left:20px;color:#666;">ë…¸ê³ ì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.</div><table style="position:absolute;right:0;top:0;width:350px;font-size:13px;background:#fff;border-collapse:collapse;"><tr><td style="border:1px solid #000;padding:6px;background:#f5f5f5;">ì§€ê¸‰í•©ê³„</td><td style="border:1px solid #000;padding:6px;text-align:right;">${f(d.pay_total)}</td></tr><tr><td style="border:1px solid #000;padding:6px;background:#f5f5f5;">ê³µì œí•©ê³„</td><td style="border:1px solid #000;padding:6px;text-align:right;">${f(d.ded_total)}</td></tr><tr><td style="border:1px solid #000;padding:6px;background:#f5f5f5;">ì‹¤ì§€ê¸‰ì•¡</td><td style="border:1px solid #000;padding:6px;text-align:right;font-weight:bold;">${f(d.net_pay)}</td></tr></table></div><div style="text-align:center;margin-top:40px;"><span style="font-size:20px;font-weight:600;">${companyInfo.company_name||"ì¡°í•©"} ì´ì‚¬ì¥ ${companyInfo.chairman}</span>${companyInfo.seal_url?`<img src="${companyInfo.seal_url}" style="position:absolute;width:60px;margin-left:-30px;top:-15px;opacity:0.8;">`:''}</div></div>`;w.document.write(`<html><head><title>ê¸‰ì—¬ëª…ì„¸ì„œ</title><style>@page{size:A4;margin:0}body{margin:0;background:#555}.page-wrap{width:210mm;height:297mm;padding:20mm;background:#fff;margin:0 auto;box-sizing:border-box}.no-print{position:fixed;bottom:30px;right:30px;background:#fff;padding:10px;border-radius:50px;cursor:pointer}@media print{body{background:#fff}.no-print{display:none}}</style></head><body><div class="page-wrap">${c}</div><div class="no-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</div></body></html>`);w.document.close()}
function toggleEtcInput(){const v=document.getElementById("certPurposeSelect").value,e=document.getElementById("certPurposeEtc");if(v==='ê¸°íƒ€'){e.classList.remove('hidden');e.focus()}else{e.classList.add('hidden')}}
function openCertModal(){purposeModal.show()}
async function loadNotices(){const{data}=await _supabase.from('ref_notice').select('*').order('created_at',{ascending:false}).limit(5);document.getElementById("noticeList").innerHTML=data&&data.length?data.map((n,i)=>`<div class="list-group-item" onclick="viewNotice(${i})" style="cursor:pointer"><h6 class="fw-bold mb-1">${n.title}</h6><small class="text-muted">${n.created_at.slice(0,10)}</small></div>`).join(""):'<div class="text-center p-3 text-muted">ê³µì§€ì‚¬í•­ ì—†ìŒ</div>';noticesData=data}
function viewNotice(i){const n=noticesData[i];document.getElementById("noticeModalTitle").innerText=n.title;document.getElementById("noticeModalDate").innerText=n.created_at.slice(0,10);document.getElementById("noticeModalWriter").innerText=n.writer||"ê´€ë¦¬ì";document.getElementById("noticeModalContent").innerText=n.content;const l=document.getElementById("noticeFileLink"),a=document.getElementById("noticeFileArea");if(n.file_url){a.classList.remove("hidden");l.href=n.file_url}else a.classList.add("hidden");noticeDetailModal.show()}
function runCertIssue(){/*ì¦ëª…ì„œë°œê¸‰ë¡œì§*/}
</script>
</body>
</html>
