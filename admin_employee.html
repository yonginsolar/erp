<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì„ì§ì› ê´€ë¦¬ v2.7 (ìµœì¢…)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="print_service.js"></script>
  
  <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; padding: 20px; }
    .main-card { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .btn-rounded { border-radius: 50px; }
    .table-hover tbody tr { cursor: pointer; transition: background 0.2s; }
    .table-hover tbody tr:hover { background-color: #f8f9fa; transform: scale(1.002); }
    .nav-tabs .nav-link { color: #666; cursor: pointer; border:none; padding: 12px 20px; font-weight: 600; }
    .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
    .modal-content { border-radius: 16px; border: none; box-shadow: 0 15px 50px rgba(0,0,0,0.1); }
    .form-control, .form-select { border-radius: 8px; padding: 10px; font-size: 0.95rem; }
    .d-none { display: none !important; }
    .section-title { font-size: 0.95rem; font-weight: bold; color: #495057; margin-bottom: 12px; border-left: 4px solid #0d6efd; padding-left: 10px; }
    .info-card { background: #f8f9fa; padding: 20px; border-radius: 12px; height: 100%; position: relative; }
    .view-mode { display: block; } .edit-mode { display: none; }
    .is-editing .view-mode { display: none; } .is-editing .edit-mode { display: block; }
    .adv-table { font-size: 0.85rem; } .adv-table input { border: none; background: #fff; padding: 2px 5px; width: 100%; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>

<div class="main-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div><h4 class="fw-bold m-0">ğŸ‘¥ ì„ì§ì› ê´€ë¦¬</h4><small class="text-muted">ì§ì› ì •ë³´ ë° ê¸‰ì—¬/ê·¼íƒœ í†µí•© ê´€ë¦¬</small></div>
    <div>
      <button class="btn btn-light btn-sm btn-rounded me-1" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
      <button class="btn btn-outline-secondary btn-sm btn-rounded me-1" onclick="openSettings()">âš™ï¸ ì„¤ì • ê´€ë¦¬</button>
      <button class="btn btn-outline-dark btn-sm btn-rounded me-1" onclick="openLedgerModal()">ğŸ“Š ê¸‰ì—¬ëŒ€ì¥</button>
      <button class="btn btn-outline-primary btn-sm btn-rounded me-1" onclick="openStatsDashboard()">ğŸ“ˆ í†µê³„ ëŒ€ì‹œë³´ë“œ</button>
      <button class="btn btn-primary btn-sm btn-rounded shadow-sm" onclick="openInviteModal()">âœ¨ ì‹ ê·œ ë“±ë¡</button>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle" style="font-size: 0.95rem;">
      <thead class="table-light text-secondary small"><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„ / ë¶€ì„œ</th><th>ì§ê¸‰</th><th>ìƒíƒœ</th><th>ì‹œìŠ¤í…œ ê¶Œí•œ</th></tr></thead>
      <tbody id="empListBody"><tr><td colspan="5" class="text-center p-4 text-muted">ë¡œë”© ì¤‘... â³</td></tr></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">âš™ï¸ ì‹œìŠ¤í…œ í†µí•© ì„¤ì •</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div><div class="modal-body">
        <div class="d-flex justify-content-end align-items-center mb-3 bg-light p-2 rounded">
    <label class="small fw-bold me-2">ì„¤ì • ê¸°ì¤€ ì—°ë„:</label>
    <select id="settingTargetYear" class="form-select form-select-sm w-auto fw-bold text-primary" onchange="loadSettings()">
        </select>
</div>
        <ul class="nav nav-tabs mb-3" id="settingTab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#setTax">ğŸ“Š ì£¼ìš” ìš”ìœ¨/ë¹„ê³¼ì„¸</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#setCompany">ğŸ¢ íšŒì‚¬ ì •ë³´</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#setAdvanced" onclick="loadAdvancedSettings()">âš™ï¸ ê³ ê¸‰ ì„¤ì • (ì „ì²´)</a></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="setTax"><h6 class="fw-bold text-primary small border-bottom pb-1 mb-2">4ëŒ€ë³´í—˜ ì´ ìš”ìœ¨ (ìë™ 50:50 ë¶„í• )</h6><div class="row g-2 mb-3"><div class="col-6"><label class="small text-muted">êµ­ë¯¼ì—°ê¸ˆ ì´í•© (%)</label><input type="number" id="set_pension_total" class="form-control form-control-sm" step="0.01" oninput="calcHalf('pension')"><div class="x-small text-secondary mt-1">ì¸ë‹¹: <span id="half_pension">0</span>%</div></div><div class="col-6"><label class="small text-muted">ê±´ê°•ë³´í—˜ ì´í•© (%)</label><input type="number" id="set_health_total" class="form-control form-control-sm" step="0.01" oninput="calcHalf('health')"><div class="x-small text-secondary mt-1">ì¸ë‹¹: <span id="half_health">0</span>%</div></div></div><h6 class="fw-bold text-success small border-bottom pb-1 mb-2">ë¹„ê³¼ì„¸ í•œë„ ì„¤ì •</h6><div class="row g-2 mb-3"><div class="col-4"><label class="small text-muted">ì‹ëŒ€ë¹„ê³¼ì„¸</label><input type="number" id="set_meal" class="form-control form-control-sm"></div><div class="col-4"><label class="small text-muted">ì°¨ëŸ‰ë¹„ê³¼ì„¸</label><input type="number" id="set_car" class="form-control form-control-sm"></div><div class="col-4"><label class="small text-muted">ìœ¡ì•„ë¹„ê³¼ì„¸</label><input type="number" id="set_child" class="form-control form-control-sm"></div></div></div><div class="tab-pane fade" id="setCompany"><div class="row g-2"><div class="col-12"><label class="small text-muted">ë²•ì¸ëª…(ì¡°í•©ëª…)</label><input type="text" id="set_orgName" class="form-control form-control-sm"></div><div class="col-12"><label class="small text-muted">ì´ì‚¬ì¥ëª…(ì´ì‚¬ì¥)</label><input type="text" id="set_ceoName" class="form-control form-control-sm"></div><div class="col-12"><label class="small text-muted">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><input type="text" id="set_bizNum" class="form-control form-control-sm"></div><div class="col-12"><label class="small text-muted">íšŒì‚¬ ì£¼ì†Œ</label><input type="text" id="set_address" class="form-control form-control-sm"></div></div></div><div class="tab-pane fade" id="setAdvanced"><div class="table-responsive" style="max-height: 300px;"><table class="table table-sm adv-table align-middle"><thead class="table-light"><tr><th>í•­ëª© í‚¤</th><th style="width: 120px;">ê°’</th><th>ì„¤ëª…</th></tr></thead><tbody id="advSettingsBody"></tbody></table></div></div></div></div><div class="modal-footer p-2 border-0"><button class="btn btn-primary w-100 btn-rounded" onclick="saveSettings()">ì„¤ì • í†µí•© ì €ì¥</button></div></div></div></div>
<div class="modal fade" id="inviteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold">âœ¨ ì§ì› ì‹ ê·œ ë“±ë¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-light border text-center small mb-3">ğŸ†” ì‚¬ì›ë²ˆí˜¸ëŠ” ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div><label class="small text-muted ms-1">ì´ë¦„</label><input type="text" id="newName" class="form-control mb-2" placeholder="í™ê¸¸ë™"><label class="small text-muted ms-1">ì´ë©”ì¼</label><input type="email" id="newEmail" class="form-control mb-2" placeholder="user@gmail.com"><div class="row g-2 mb-2"><div class="col"><label class="small text-muted ms-1">ì§ê¸‰</label><select id="newRank" class="form-select"><option>ì‚¬ì›</option><option>ëŒ€ë¦¬</option><option>ê³¼ì¥</option><option>ì°¨ì¥</option><option>ë¶€ì¥</option><option>ì´ì‚¬</option><option>êµ­ì¥</option><option>ì´ì‚¬ì¥</option></select></div><div class="col"><label class="small text-muted ms-1">ê¶Œí•œ</label><select id="newRole" class="form-select"><option value="staff">ì¼ë°˜ (Staff)</option><option value="admin">ê´€ë¦¬ì (Admin)</option></select></div></div><div class="mb-3"><label class="small text-muted ms-1">ë¶€ì„œ</label><input type="text" id="newDept" class="form-control" placeholder="ê¸°íšíŒ€"></div><button class="btn btn-primary w-100 btn-rounded py-2" onclick="runInvite()">ë“±ë¡í•˜ê¸°</button></div></div></div></div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-start">
        <div><h5 class="modal-title fw-bold" id="detailName"></h5><span class="text-muted small" id="detailId"></span></div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"> 
        <div class="px-2 pt-2">
          <ul class="nav nav-tabs mb-3" id="empTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabInfo">ğŸ“ ì •ë³´ & ê³„ì•½</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabSalary">ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabLog">ğŸ“… ê·¼íƒœ/í¬ìƒ</a></li>
          </ul>
        </div>
        <div class="tab-content pt-2">
        <div class="tab-pane fade show active" id="tabInfo">
  <div id="infoContainer">
    <div class="d-flex justify-content-end mb-2">
      <button class="btn btn-sm btn-outline-primary view-mode" onclick="toggleEditMode(true)">âœï¸ ì •ë³´ ìˆ˜ì •</button>
      <button class="btn btn-sm btn-secondary edit-mode me-2" onclick="toggleEditMode(false)">ì·¨ì†Œ</button>
      <button class="btn btn-sm btn-primary edit-mode" onclick="saveBasicInfo()">ì €ì¥ ì™„ë£Œ</button>
    </div>
    <div class="row g-3">
      <div class="col-12">
        <div class="info-card">
          <div class="section-title">ğŸ‘¤ ê¸°ë³¸ ì¸ì ì‚¬í•­</div>
          <div class="row g-3">
            <div class="col-md-3"><label class="small text-muted">ì´ë¦„</label><div class="view-mode fw-bold" id="viewName">-</div><input type="text" id="editName" class="form-control edit-mode"></div>
<div class="col-md-3">
    <label class="small text-muted fw-bold text-primary">ì¡°í•©ì› ë²ˆí˜¸</label>
    <div class="view-mode" id="viewMemberId">-</div>
    <input type="text" id="editMemberId" class="form-control edit-mode" placeholder="2025-00-0000" oninput="autoHyphenMemberId(this)">
</div>
            <div class="col-md-3"><label class="small text-muted">ì „í™”ë²ˆí˜¸</label><div class="view-mode fw-bold" id="viewPhone">-</div><input type="text" id="editPhone" class="form-control edit-mode" placeholder="010-0000-0000" maxlength="13" oninput="autoHyphen(this)"></div>
            <div class="col-md-3"><label class="small text-muted">ì´ë©”ì¼</label><div class="view-mode fw-bold" id="viewEmail">-</div><input type="email" id="editEmail" class="form-control edit-mode"></div>
            <div class="col-12"><label class="small text-muted">ì£¼ì†Œ</label><div class="view-mode fw-bold" id="viewAddress">-</div>
              <div class="edit-mode"><div class="input-group mb-1"><input type="text" id="editAddress" class="form-control" placeholder="ê¸°ë³¸ ì£¼ì†Œ (ê²€ìƒ‰)" onclick="openAddressSearch()" readonly><button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()">ğŸ” ì£¼ì†Œ ê²€ìƒ‰</button></div><input type="text" id="editAddressDetail" class="form-control" placeholder="ìƒì„¸ì£¼ì†Œ"></div>
            </div>
            <div class="col-md-6"><label class="small text-muted">ì…ì‚¬ì¼</label><div class="view-mode fw-bold" id="viewHireDate">-</div><input type="date" id="editHireDate" class="form-control edit-mode"></div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="info-card" style="background:#fff3cd;">
           <div class="section-title text-dark">ğŸš¨ ë¹„ìƒ ì—°ë½ë§</div>
           <div id="viewEmergency" class="small text-dark ps-2">-</div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="info-card">
          <div class="section-title">ğŸ‚ ìƒë…„ì›”ì¼</div>
          <div class="view-mode"><div class="d-flex align-items-center gap-2"><span class="fs-4 fw-bold text-dark" id="viewBirth">ë¯¸ë“±ë¡</span></div><div class="small text-muted mt-2">* ì£¼ë¯¼ë²ˆí˜¸ ë’·ìë¦¬ ìˆ¨ê¹€</div></div>
          <div class="edit-mode"><label class="small text-muted mb-1">ì£¼ë¯¼ë²ˆí˜¸ (ì „ì²´ ì…ë ¥)</label><div class="d-flex align-items-center gap-2 mb-2"><input type="text" id="rrnFront" class="form-control text-center" maxlength="6" placeholder="ìƒë…„ì›”ì¼"><span class="fw-bold text-muted">-</span><input type="password" id="rrnBack" class="form-control text-center" maxlength="7" placeholder="ë’¤ 7ìë¦¬"></div><button class="btn btn-outline-dark btn-sm w-100" onclick="saveRRN()">ğŸ”’ ì•”í˜¸í™” ì €ì¥</button></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-card">
          <div class="section-title">ğŸ’° ì—°ë´‰ ê³„ì•½</div>
          <div class="view-mode"><label class="small text-muted">í˜„ì¬ ì—°ë´‰</label><div class="d-flex align-items-center gap-2"><span class="fs-5 fw-bold" id="viewSalary">******</span><i class="bi bi-eye text-primary cursor-pointer" onclick="toggleSalaryVisibility()"></i></div><div class="mt-2"><label class="small text-muted">ì ìš© ì‹œì‘ì¼: </label><span class="fw-bold" id="viewSalaryDate">-</span></div></div>
          <div class="edit-mode"><div class="mb-2"><label class="small text-muted">ì—°ë´‰ ì´ì•¡ (ì›)</label><input type="number" id="editSalary" class="form-control fw-bold"></div><div class="mb-2"><label class="small text-muted">ì ìš© ì‹œì‘ì¼</label><input type="date" id="salaryApplyDate" class="form-control"></div></div>
        </div>
      </div>

      <div class="col-12">
        <div class="row g-2">
          <div class="col-md-6">
            <div class="info-card" style="background: white; border: 1px solid #dee2e6;">
              <div class="section-title mb-2">ğŸ“„ ê·¼ë¡œê³„ì•½ì„œ</div>
              <div id="contractView" class="mb-2"></div>
              <input type="hidden" id="hiddenContractUrl" value="">
              <div class="edit-mode border-top pt-2">
                <label class="small text-muted">íŒŒì¼ ì—…ë°ì´íŠ¸</label>
                <div class="d-flex gap-2">
                  <input type="file" id="contractFile" class="form-control form-control-sm" accept=".pdf,.jpg,.png,.jpeg">
                  <button class="btn btn-dark btn-sm text-nowrap" style="min-width: 80px;" onclick="uploadContract()">ì—…ë¡œë“œ</button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-card" style="background: white; border: 1px solid #dee2e6;">
              <div class="section-title mb-2">ğŸ–¨ï¸ ë¬¸ì„œ ë°œê¸‰</div>
              <div class="d-flex flex-column gap-2">
                <button class="btn btn-outline-dark w-100" onclick="openAdminCertModal()">ğŸ“„ ì¬ì§ì¦ëª…ì„œ ë°œê¸‰</button>
                <div class="small text-muted text-center">* í‡´ì‚¬ìëŠ” ê²½ë ¥ì¦ëª…ì„œë¡œ ì¶œë ¥ë¨</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 mt-2 pt-2 border-top d-flex justify-content-end gap-2" id="btnResignArea"></div>
    </div>
  </div>
</div> 
       <div class="tab-pane fade" id="tabSalary">
  <div id="salaryAlertBox" class="mb-3 hidden"></div>

  <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
    <span class="small">ğŸ“¢ ì—°ë´‰ ê¸°ì¤€ <strong>ìë™ ê³„ì‚°</strong> (ê·€ì†ì›” ê¸°ì¤€)</span>
    <span class="badge bg-secondary" id="salaryStatusBadge">ì¡°íšŒ ì¤‘...</span>
  </div>

  <div class="d-flex align-items-center mb-3">
    <label class="me-2 fw-bold small">ê·€ì†ì›”</label>
    <input type="month" id="salaryMonth" class="form-control form-control-sm w-auto me-2" onchange="loadSalaryData()">
    <button class="btn btn-sm btn-outline-dark" onclick="printSalaryAdmin()">ğŸ–¨ï¸ ëª…ì„¸ì„œ ì¸ì‡„</button>
  </div>

  <div class="info-card border mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-12">
        <label class="small fw-bold text-primary">ğŸ’° ì›” ì§€ê¸‰ ì´ì•¡ (ì—°ë´‰ Ã· 12)</label>
        <input type="number" id="payTotalFixed" class="form-control fw-bold fs-5 bg-white" oninput="recalcSalaryComponents()">
        <div class="form-text x-small">ì´ ê¸ˆì•¡ì„ ê¸°ì¤€ìœ¼ë¡œ ê¸°ë³¸ê¸‰ê³¼ ìˆ˜ë‹¹ì„ ë‚˜ëˆ•ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <div class="row g-2">
    <div class="col-4">
      <label class="small text-muted">ì‹ëŒ€ (ë¹„ê³¼ì„¸)</label>
      <input type="number" id="payMeal" class="form-control" value="0" oninput="recalcSalaryComponents()">
    </div>
    <div class="col-4">
      <label class="small text-muted">ì°¨ëŸ‰ìœ ì§€ë¹„</label>
      <input type="number" id="payCar" class="form-control" value="0" oninput="recalcSalaryComponents()">
    </div>
    <div class="col-4">
      <label class="small text-muted">ìœ¡ì•„ìˆ˜ë‹¹</label>
      <input type="number" id="payChild" class="form-control" value="0" oninput="recalcSalaryComponents()">
    </div>
    <div class="col-6">
      <label class="small text-muted">ê¸°ë³¸ê¸‰ (ìë™ê³„ì‚°)</label>
      <input type="number" id="payBasic" class="form-control bg-light" readonly>
    </div>
    <div class="col-6">
      <label class="small text-muted">ìƒì—¬/ì„±ê³¼ê¸‰ (ë³„ë„)</label>
      <input type="number" id="payBonus" class="form-control" value="0" oninput="recalcSalaryComponents()">
    </div>
  </div>
<div class="d-flex gap-2 mt-3">
  <button id="btnDeleteSalary" class="btn btn-danger w-25 btn-rounded d-none" onclick="deleteSalary()">ğŸ—‘ï¸ ì‚­ì œ</button>
  <button id="btnSaveSalary" class="btn btn-success flex-grow-1 btn-rounded" onclick="saveSalary()">ğŸ’¾ ê¸‰ì—¬ í™•ì • ë° ì €ì¥</button>
</div>
</div>
          <div class="tab-pane fade" id="tabLog">
            <div class="card bg-light border-0 p-3 mb-3 text-center"><small class="text-muted">í˜„ì¬ ì”ì—¬ ì—°ì°¨</small><h3 class="fw-bold text-primary m-0" id="displayLeaveRemain">0ì¼</h3></div>
            <div class="mb-2"><label class="small text-muted">êµ¬ë¶„</label><select id="logType" class="form-select"><option value="ì§€ê¸‰">ğŸ ì§€ê¸‰ (í¬ìƒ ë“±)</option><option value="ì°¨ê°">âš ï¸ ì°¨ê° (ì§•ê³„ ë“±)</option></select></div>
            <div class="mb-2"><label class="small text-muted">ì¼ìˆ˜</label><input type="number" id="logValue" class="form-control" placeholder="ì˜ˆ: 1"></div>
            <div class="mb-3"><label class="small text-muted">ì‚¬ìœ </label><input type="text" id="logReason" class="form-control" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div>
            <button class="btn btn-primary w-100 btn-rounded" onclick="saveLog()">âœ… ë°˜ì˜í•˜ê¸°</button>
          </div>
        </div> 
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body text-center py-4"><p class="mb-0 fw-bold" id="alertBody"></p></div><div class="modal-footer justify-content-center p-1 border-0"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">í™•ì¸</h6></div><div class="modal-body text-center py-3" id="confirmBody"></div><div class="modal-footer justify-content-center border-0 pt-0"><button type="button" class="btn btn-secondary btn-sm me-2" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="button" class="btn btn-danger btn-sm" id="btnConfirmYes">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content text-center p-4"><div class="spinner-border text-primary mb-3"></div><h6 class="mb-0">ì²˜ë¦¬ ì¤‘...</h6></div></div></div>
<div class="modal fade" id="resignModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">â›” í‡´ì‚¬ ì²˜ë¦¬</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">í‡´ì‚¬ì¼ì (ë§ˆì§€ë§‰ ê·¼ë¬´ì¼)</label><input type="date" id="inputResignDate" class="form-control"></div><div class="modal-footer p-1 border-0 justify-content-center"><button class="btn btn-danger btn-sm w-100" onclick="confirmResign()">í‡´ì‚¬ í™•ì •</button></div></div></div></div>
<div class="modal fade" id="adminCertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">ğŸ“„ ì¬ì§ì¦ëª…ì„œ ë°œê¸‰</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">ë°œê¸‰ ìš©ë„</label><select id="adminCertPurpose" class="form-select form-select-sm" onchange="toggleAdminEtc()"><option value="ê´€ê³µì„œ ì œì¶œìš©">ê´€ê³µì„œ ì œì¶œìš©</option><option value="ê¸ˆìœµê¸°ê´€ ì œì¶œìš©">ê¸ˆìœµê¸°ê´€ ì œì¶œìš©</option><option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option></select><input type="text" id="adminCertEtc" class="form-control form-control-sm mt-2" placeholder="ì§ì ‘ ì…ë ¥" style="display:none;"></div><div class="modal-footer p-1 border-0 justify-content-center"><button class="btn btn-primary btn-sm w-100" onclick="reqIssueCert()">ë°œê¸‰ ë° ì¸ì‡„</button></div></div></div></div>
<div class="modal fade" id="ledgerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">ğŸ“Š ê¸‰ì—¬ëŒ€ì¥ ì¶œë ¥</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">ëŒ€ìƒ ì—°ì›”</label><input type="month" id="ledgerMonth" class="form-control"></div><div class="modal-footer p-1 border-0 justify-content-center"><button class="btn btn-primary btn-sm w-100" onclick="printLedger()">ëŒ€ì¥ ì¶œë ¥ (A4 ê°€ë¡œ)</button></div></div></div></div>
<div class="modal fade" id="statsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">ğŸ“ˆ ê²½ì˜ ì§€ì› ëŒ€ì‹œë³´ë“œ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <ul class="nav nav-pills nav-fill mb-3 bg-white p-2 rounded border" id="statsTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#statEff">â±ï¸ ê²°ì¬ íš¨ìœ¨ì„±</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#statReject">ğŸ›¡ï¸ ë°˜ë ¤/ê±´ì „ì„±</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#statFin">ğŸ’° ìê¸ˆ íë¦„</button></li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="statEff">
                        <div class="row g-3">
                            <div class="col-lg-8">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <h6 class="fw-bold text-secondary mb-3">ì›”ë³„ í‰ê·  ê²°ì¬ ì†Œìš”ì‹œê°„ (ë‹¨ìœ„: ì‹œê°„)</h6>
                                        <div style="height: 300px;"><canvas id="chartTime"></canvas></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card border-0 shadow-sm h-100 bg-primary text-white">
                                    <div class="card-body d-flex flex-column justify-content-center text-center">
                                        <h6 class="opacity-75">ì´ë²ˆ ë‹¬ í‰ê·  ì†Œìš”</h6>
                                        <h1 class="fw-bold display-4 mb-0" id="valAvgTime">-</h1>
                                        <small class="opacity-75 mt-2">ê¸°ì•ˆ ~ ìµœì¢…ìŠ¹ì¸ê¹Œì§€</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white fw-bold">ğŸ“‹ ë³‘ëª© êµ¬ê°„ ë¶„ì„ (ê²°ì¬ê°€ ëŠ¦ì€ ìˆœìœ„)</div>
                                    <div class="card-body p-0 table-responsive">
                                        <table class="table table-hover mb-0 text-center small">
                                            <thead class="table-light"><tr><th>ìˆœìœ„</th><th>ê²°ì¬ì</th><th>í‰ê·  ë°˜ì‘ì‹œê°„</th><th>ì²˜ë¦¬ ê±´ìˆ˜</th></tr></thead>
                                            <tbody id="tblSlowApprover"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="statReject">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <h6 class="fw-bold text-secondary mb-3">ë°˜ë ¤ ì‚¬ìœ  í‚¤ì›Œë“œ (Top 5)</h6>
                                        <div style="height: 250px;"><canvas id="chartRejectReason"></canvas></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <h6 class="fw-bold text-secondary mb-3">ìµœë‹¤ ë°˜ë ¤ì (ì—„ê²©í•œ ê´€ë¦¬ì)</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-borderless align-middle">
                                                <thead class="text-muted border-bottom"><tr><th>ì´ë¦„</th><th>ë°˜ë ¤ íšŸìˆ˜</th><th>ë¹„ìœ¨</th></tr></thead>
                                                <tbody id="tblRejectKing"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="statFin">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="fw-bold text-secondary mb-3">ì›”ë³„ ì§€ì¶œ ì¶”ì´ (ì¸ê±´ë¹„ vs ì¼ë°˜ì§€ì¶œ)</h6>
                                        <div style="height: 300px;"><canvas id="chartFinance"></canvas></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-white fw-bold">ğŸ“Š ìƒì„¸ ì§€ì¶œ ë‚´ì—­ (ë°±ë°ì´í„°)</div>
                                    <div class="card-body p-0 table-responsive">
                                        <table class="table table-sm table-hover mb-0 text-center small">
                                            <thead class="table-light"><tr><th>ê·€ì†ì›”</th><th>ì¸ê±´ë¹„ í•©ê³„</th><th>ì¼ë°˜ì§€ì¶œ í•©ê³„</th><th>ì´ ì§€ì¶œ</th><th>ë¹„ì¤‘(ì¸ê±´ë¹„)</th></tr></thead>
                                            <tbody id="tblFinanceBack"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div> <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary btn-rounded" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>
<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let settings = {}; let companyInfo = {}; let advancedSettingsRaw = [];
let currentEmpId = null, currentEmpName = null, currentAnnualSalary = 0; 
let currentEmpHireDate = null, currentEmpResignDate = null; 
let confirmCallback = null; let currentSalaryDataForPrint = null; 
let alertModal, confirmModal, settingsModal, inviteModal, detailModal, adminCertModal, loadingModal, ledgerModal, resignModal;
let hasCheckedExpired = false;

window.onload = async function() {
    alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));
    detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    adminCertModal = new bootstrap.Modal(document.getElementById('adminCertModal'));
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    ledgerModal = new bootstrap.Modal(document.getElementById('ledgerModal'));
    resignModal = new bootstrap.Modal(document.getElementById('resignModal'));

    document.getElementById("btnConfirmYes").onclick = function() { if(confirmCallback) confirmCallback(); confirmModal.hide(); };
    document.getElementById("salaryMonth").value = new Date().toISOString().slice(0, 7);
    document.getElementById("ledgerMonth").value = new Date().toISOString().slice(0, 7);

    await loadList(); await loadSettings(); await loadCompanyInfo();
};

function showAlert(msg) { document.getElementById("alertBody").innerHTML = msg; alertModal.show(); }
// [ìˆ˜ì •] ì¸ìê°€ 2ê°œ(ë©”ì‹œì§€, ì½œë°±)ì¼ ë•Œì™€ 3ê°œ(ì œëª©, ë©”ì‹œì§€, ì½œë°±)ì¼ ë•Œë¥¼ ëª¨ë‘ ì²˜ë¦¬
function showConfirm(arg1, arg2, arg3) {
    let title = "í™•ì¸";
    let msg = "";
    let cb = null;

    // ì¸ìê°€ 3ê°œ ë“¤ì–´ì™”ì„ ë•Œ (ì œëª©, ë‚´ìš©, í•¨ìˆ˜)
    if (typeof arg3 === 'function') {
        title = arg1;
        msg = arg2;
        cb = arg3;
    } 
    // ì¸ìê°€ 2ê°œ ë“¤ì–´ì™”ì„ ë•Œ (ë‚´ìš©, í•¨ìˆ˜)
    else {
        msg = arg1;
        cb = arg2;
    }

    // ëª¨ë‹¬ ì œëª© ë³€ê²½ (ì œëª© íƒœê·¸ì— IDê°€ ì—†ìœ¼ë¯€ë¡œ í´ë˜ìŠ¤ë¡œ ì°¾ìŒ)
    const titleEl = document.querySelector("#confirmModal .modal-title");
    if(titleEl) titleEl.innerText = title;

    document.getElementById("confirmBody").innerHTML = msg;
    confirmCallback = cb;
    confirmModal.show();
}
  
function showLoading() { loadingModal.show(); }
function hideLoading() { loadingModal.hide(); }
function autoHyphen(target) { target.value = target.value.replace(/[^0-9]/g, '').replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g, "$1-$2-$3").replace(/(\-{1,2})$/g, ""); }
function openAddressSearch() { new daum.Postcode({ oncomplete: function(data) { let addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress; if(data.buildingName) addr += ' (' + data.buildingName + ')'; document.getElementById("editAddress").value = addr; document.getElementById("editAddressDetail").focus(); } }).open(); }

async function loadList() { const tbody = document.getElementById("empListBody"); tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">ë¡œë”© ì¤‘...</td></tr>'; const { data: list, error } = await _supabase.from('ref_employees').select('*').order('emp_id'); if(error || !list) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } tbody.innerHTML = ""; const threeYearsAgo = new Date(); threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3); let expiredCount = 0; list.forEach(u => { let isResigned = !!u.resign_date; let isExpired = false; if (isResigned && new Date(u.resign_date) <= threeYearsAgo) { isExpired = true; expiredCount++; } let statusBadge = isResigned ? (isExpired ? `<span class="badge bg-danger">3ë…„ ê²½ê³¼</span>` : `<span class="badge bg-secondary">í‡´ì‚¬</span>`) : `<span class="badge bg-success">ì¬ì§</span>`; let roleBadge = u.role === 'admin' ? '<span class="badge bg-danger">ê´€ë¦¬ì</span>' : '<span class="badge bg-light text-dark">ì¼ë°˜</span>'; const tr = document.createElement("tr"); if(isResigned) tr.style.opacity = "0.7"; if(isExpired) tr.style.backgroundColor = "#fff5f5"; tr.onclick = () => openDetail(u); tr.innerHTML = `<td class="fw-bold text-secondary">${u.emp_id}</td><td><div class="fw-bold">${u.emp_name}</div><div class="small text-muted">${u.department || '-'}</div></td><td>${u.position}</td><td>${statusBadge}</td><td>${roleBadge}</td>`; tbody.appendChild(tr); }); if (expiredCount > 0 && !hasCheckedExpired) { showConfirm(`âš ï¸ <strong>ê°œì¸ì •ë³´ íŒŒê¸° ì•Œë¦¼</strong><br>í‡´ì‚¬ í›„ 3ë…„ ê²½ê³¼ì ${expiredCount}ëª… ë°œê²¬. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => showAlert("ëª©ë¡ì—ì„œ ë¶‰ì€ìƒ‰ ì§ì›ì„ ì‚­ì œí•˜ì„¸ìš”.")); hasCheckedExpired = true; } }

async function loadCompanyInfo() { const { data } = await _supabase.from('ref_company_info').select('*'); if(data) data.forEach(r => { companyInfo[r.key] = r.value; }); companyInfo.chairman_name = companyInfo.ceoName || "ì´ì‚¬ì¥"; if (companyInfo.logo_horizontal_url && !companyInfo.logo_horizontal_url.startsWith('http')) { const { data: logoData } = _supabase.storage.from('assets').getPublicUrl(companyInfo.logo_horizontal_url); companyInfo.logo_horizontal_url = logoData.publicUrl; } if (companyInfo.seal_url) { let sealPath = companyInfo.seal_url.startsWith('http') ? companyInfo.seal_url.split('/').pop() : companyInfo.seal_url; const { data: sealData } = await _supabase.storage.from('attachments').createSignedUrl(sealPath, 3600); if (sealData) companyInfo.seal_url = sealData.signedUrl; } }
async function loadAdvancedSettings() { const tbody = document.getElementById("advSettingsBody"); tbody.innerHTML = '<tr><td colspan="3">ë¡œë”©...</td></tr>'; const { data } = await _supabase.from('ref_settings').select('*').order('category'); if(data) { advancedSettingsRaw = data; tbody.innerHTML = data.map((r, i) => `<tr><td><small class="text-muted">${r.item_key}</small></td><td><input type="number" step="0.00001" value="${r.item_value}" id="adv_val_${i}"></td><td><small>${r.description||'-'}</small></td></tr>`).join(""); } }

function calcHalf(type) { document.getElementById(`half_${type}`).innerText = (Number(document.getElementById(`set_${type}_total`).value)/2).toFixed(3); }

function openInviteModal() { inviteModal.show(); }
async function runInvite() { const name = document.getElementById("newName").value; const email = document.getElementById("newEmail").value; if(!name || !email) return showAlert("ì´ë¦„/ì´ë©”ì¼ ì…ë ¥ í•„ìš”"); const year = new Date().getFullYear(); const { count } = await _supabase.from('ref_employees').select('*', {count:'exact', head:true}).like('emp_id', `${year}%`); const empId = `${year}${String((count||0)+1).padStart(3,'0')}`; const { error } = await _supabase.from('ref_employees').insert({ emp_id: empId, emp_name: name, email: email, position: document.getElementById("newRank").value, role: document.getElementById("newRole").value, department: document.getElementById("newDept").value, hire_date: new Date().toISOString().slice(0,10) }); if(error) showAlert("ì˜¤ë¥˜: "+error.message); else { showAlert(`ë“±ë¡ë¨: ${empId}`); inviteModal.hide(); loadList(); } }
// 1. ì„¤ì • ëª¨ë‹¬ ì—´ê¸° (ì—°ë„ ì´ˆê¸°í™” ë¡œì§ ì¶”ê°€)
function openSettings() {
    // 1. ì—°ë„ Select ë°•ìŠ¤ ì´ˆê¸°í™” (ì˜¬í•´ ~ 2ë…„ ì „ê¹Œì§€)
    const yearSel = document.getElementById("settingTargetYear");
    yearSel.innerHTML = "";
    const currentYear = new Date().getFullYear();
    
    // ì˜¬í•´, ì‘ë…„, ì¬ì‘ë…„ ì˜µì…˜ ìƒì„±
    for (let y = currentYear; y >= currentYear - 2; y--) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.text = y + "ë…„ ê¸°ì¤€";
        if (y === currentYear) opt.selected = true; // ê¸°ë³¸ê°’: ì˜¬í•´
        yearSel.add(opt);
    }

    // 2. ë°ì´í„° ë¡œë“œ íŠ¸ë¦¬ê±°
    settingsModal.show();
    loadSettings(); 
}

// 2. ì„¤ì • ê°’ ë¶ˆëŸ¬ì˜¤ê¸° (í…Œì´ë¸” ì´ì›í™” ì ìš©)
async function loadSettings() {
    const selYear = Number(document.getElementById("settingTargetYear").value);
    const currentYear = new Date().getFullYear();
    
    // UI ì´ˆê¸°í™”
    document.getElementById("advSettingsBody").innerHTML = '<tr><td colspan="3" class="text-center">ë¡œë”© ì¤‘...</td></tr>';

    let data, error;

    // [í•µì‹¬] ì—°ë„ì— ë”°ë¼ ì¡°íšŒ í…Œì´ë¸” ë¶„ê¸°
    if (selYear < currentYear) {
        // ê³¼ê±° ë°ì´í„° (History í…Œì´ë¸”)
        console.log(`[ì„¤ì •] ${selYear}ë…„ë„(ê³¼ê±°) ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.`);
        const res = await _supabase
            .from('ref_settings_history')
            .select('*')
            .eq('target_year', selYear);
        data = res.data;
        error = res.error;
    } else {
        // í˜„ì¬/ë¯¸ë˜ ë°ì´í„° (ì›ë³¸ í…Œì´ë¸”)
        console.log(`[ì„¤ì •] ${selYear}ë…„ë„(í˜„ì¬) ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.`);
        const res = await _supabase.from('ref_settings').select('*');
        data = res.data;
        error = res.error;
    }

    if (error) return showAlert("ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: " + error.message);

    // ë°ì´í„° ë§¤í•‘
    settings = {};
    if (data) {
        data.forEach(r => { settings[r.item_key] = r.item_value; });
        advancedSettingsRaw = data; // ê³ ê¸‰ ì„¤ì •ìš© ì›ë³¸ ë°ì´í„° ì €ì¥
    }

    // UI ë°”ì¸ë”© (ê°’ì´ ì—†ìœ¼ë©´ 0 ì²˜ë¦¬)
    // 4ëŒ€ë³´í—˜ ìš”ìœ¨ì€ í¼ì„¼íŠ¸(%) ë‹¨ìœ„ ë³€í™˜ì„ ìœ„í•´ * 200 (emp+biz í•©ê³„)
    document.getElementById("set_pension_total").value = ((settings['pension_rate_emp'] || 0) * 200).toFixed(2);
    document.getElementById("set_health_total").value = ((settings['health_rate_emp'] || 0) * 200).toFixed(2);
    calcHalf('pension'); 
    calcHalf('health');

    document.getElementById("set_meal").value = settings['limit_meal'] || 0;
    document.getElementById("set_car").value = settings['limit_car'] || 0;
    document.getElementById("set_child").value = settings['limit_child'] || 0;

    // ê³ ê¸‰ ì„¤ì • íƒ­ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    const tbody = document.getElementById("advSettingsBody");
    if (data && data.length > 0) {
        tbody.innerHTML = data.map((r, i) => `
            <tr>
                <td><small class="text-muted">${r.item_key}</small></td>
                <td><input type="number" step="0.00001" value="${r.item_value}" id="adv_val_${i}" class="form-control form-control-sm"></td>
                <td><small>${r.description || '-'}</small></td>
            </tr>
        `).join("");
    } else {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">${selYear}ë…„ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</td></tr>`;
    }

    // íšŒì‚¬ ì •ë³´ëŠ” ì—°ë„ì™€ ë¬´ê´€í•˜ê²Œ ê³µí†µ ê´€ë¦¬ (ì›ë³¸ ê·¸ëŒ€ë¡œ ë¡œë“œ)
    // *íšŒì‚¬ ì •ë³´ëŠ” ë³´í†µ ë§¤ë…„ ë°”ë€Œì§€ ì•Šìœ¼ë¯€ë¡œ ref_company_info í•˜ë‚˜ë§Œ ì”ë‹ˆë‹¤.
    document.getElementById("set_orgName").value = companyInfo['orgName'] || "";
    document.getElementById("set_ceoName").value = companyInfo['ceoName'] || "";
    document.getElementById("set_bizNum").value = companyInfo['bizNum'] || "";
    document.getElementById("set_address").value = companyInfo['company_address'] || "";
}

// 3. ì„¤ì • ê°’ ì €ì¥í•˜ê¸° (í…Œì´ë¸” ì´ì›í™” ì ìš©)
async function saveSettings() {
    try {
        const selYear = Number(document.getElementById("settingTargetYear").value);
        const currentYear = new Date().getFullYear();
        const updates = [];

        // UI ê°’ ì½ê¸°
        const isAdvanced = document.getElementById("setAdvanced").classList.contains("active");

        if (isAdvanced && advancedSettingsRaw.length > 0) {
            // ê³ ê¸‰ ì„¤ì • íƒ­ì¸ ê²½ìš°
            advancedSettingsRaw.forEach((r, i) => {
                const val = document.getElementById(`adv_val_${i}`).value;
                updates.push({ item_key: r.item_key, item_value: Number(val) });
            });
        } else {
            // ì¼ë°˜ ì„¤ì • íƒ­ì¸ ê²½ìš° (ìš”ìœ¨ ê³„ì‚°)
            const pen = Number(document.getElementById("set_pension_total").value) / 200;
            const hlt = Number(document.getElementById("set_health_total").value) / 200;
            
            // í•„ìˆ˜ í•­ëª©ë“¤ íŒ¨í‚¤ì§•
            updates.push(
                { item_key: 'pension_rate_emp', item_value: pen },
                { item_key: 'pension_rate_biz', item_value: pen },
                { item_key: 'health_rate_emp', item_value: hlt },
                { item_key: 'health_rate_biz', item_value: hlt },
                { item_key: 'limit_meal', item_value: Number(document.getElementById("set_meal").value) },
                { item_key: 'limit_car', item_value: Number(document.getElementById("set_car").value) },
                { item_key: 'limit_child', item_value: Number(document.getElementById("set_child").value) }
            );
        }

        // [í•µì‹¬] ì €ì¥í•  í…Œì´ë¸” ë¶„ê¸° ì²˜ë¦¬
        if (selYear < currentYear) {
            // 1. ê³¼ê±° ë°ì´í„° ì €ì¥ (History í…Œì´ë¸”)
            console.log(`[ì €ì¥] ${selYear}ë…„ë„(ê³¼ê±°) - ref_settings_historyì— ì €ì¥í•©ë‹ˆë‹¤.`);
            
            // History í…Œì´ë¸”ì€ 'target_year' ì¹¼ëŸ¼ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.
            const historyUpdates = updates.map(u => ({
                ...u,
                target_year: selYear, // ì—°ë„ ëª…ì‹œ
                updated_at: new Date()
            }));

            // unique ì œì•½ì¡°ê±´(target_year + item_key)ì— ë”°ë¼ Upsert
            const { error } = await _supabase
                .from('ref_settings_history')
                .upsert(historyUpdates, { onConflict: 'target_year, item_key' });
            
            if (error) throw error;

        } else {
            // 2. í˜„ì¬ ë°ì´í„° ì €ì¥ (Original í…Œì´ë¸”)
            console.log(`[ì €ì¥] ${selYear}ë…„ë„(í˜„ì¬) - ref_settingsì— ì €ì¥í•©ë‹ˆë‹¤.`);
            
            // Original í…Œì´ë¸”ì€ item_keyë§Œ ìˆìœ¼ë©´ ë¨
            const { error } = await _supabase
                .from('ref_settings')
                .upsert(updates, { onConflict: 'item_key' });
                
            if (error) throw error;
        }

        // 3. íšŒì‚¬ ì •ë³´ ì €ì¥ (ê³µí†µ)
        const org = document.getElementById("set_orgName").value;
        const ceo = document.getElementById("set_ceoName").value;
        const cUpdates = [
            { key: 'orgName', value: org },
            { key: 'company_name', value: org },
            { key: 'ceoName', value: ceo },
            { key: 'chairman_name', value: ceo },
            { key: 'bizNum', value: document.getElementById("set_bizNum").value },
            { key: 'company_address', value: document.getElementById("set_address").value }
        ];
        await _supabase.from('ref_company_info').upsert(cUpdates, { onConflict: 'key' });

        // ë§ˆë¬´ë¦¬
        await loadSettings(); // í™”ë©´ ê°±ì‹ 
        await loadCompanyInfo();
        settingsModal.hide();
        showAlert(`${selYear}ë…„ë„ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

    } catch (e) {
        showAlert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
    }
}
async function openDetail(u) {
    currentEmpId = u.emp_id; currentEmpName = u.emp_name; 
    currentAnnualSalary = u.base_salary || 0;
    currentEmpHireDate = u.hire_date;
    currentEmpResignDate = u.resign_date;

    document.getElementById("detailName").innerText = u.emp_name; document.getElementById("viewMemberId").innerText = u.member_id || "-";
    document.getElementById("editMemberId").value = u.member_id || "";document.getElementById("detailId").innerText = u.emp_id;
    document.getElementById("viewName").innerText = u.emp_name; document.getElementById("viewPhone").innerText = u.phone || "-"; document.getElementById("viewEmail").innerText = u.email || "-"; document.getElementById("viewAddress").innerText = u.address || "-"; document.getElementById("viewHireDate").innerText = u.hire_date || "-";
    document.getElementById("editName").value = u.emp_name; document.getElementById("editPhone").value = u.phone || ""; document.getElementById("editEmail").value = u.email || ""; 
    document.getElementById("editAddress").value = u.address || ""; document.getElementById("editAddressDetail").value = ""; 
    document.getElementById("editHireDate").value = u.hire_date || "";
    document.getElementById("viewSalary").innerText = "******"; document.getElementById("viewSalary").dataset.real = (u.base_salary||0).toLocaleString() + " ì›";
    document.getElementById("viewSalaryDate").innerText = u.salary_apply_date || "-"; document.getElementById("editSalary").value = u.base_salary || 0; document.getElementById("salaryApplyDate").value = u.salary_apply_date || "";

    const { data: birthDate } = await _supabase.rpc('get_emp_birthdate', { p_emp_id: u.emp_id });
    document.getElementById("viewBirth").innerText = birthDate || "ë¯¸ë“±ë¡";
    
    // [ì¶”ê°€ëœ ë¶€ë¶„] ë¹„ìƒ ì—°ë½ë§ ì¡°íšŒ ë° í‘œì‹œ
    const { data: emList } = await _supabase.from('ref_emergency_contacts').select('*').eq('emp_id', u.emp_id);
    const emDiv = document.getElementById("viewEmergency");
    if(emList && emList.length > 0) {
        emDiv.innerHTML = emList.map(e => `<div><span class="fw-bold">${e.relation}:</span> ${e.contact_name} (${e.phone})</div>`).join("");
    } else {
        emDiv.innerHTML = '<span class="text-muted small">- ë“±ë¡ëœ ì—°ë½ë§ ì—†ìŒ -</span>';
    }

    toggleEditMode(false);
    document.getElementById("rrnFront").value = ""; document.getElementById("rrnBack").value = "";
    
    const viewDiv = document.getElementById("contractView"); viewDiv.innerHTML = 'ë¡œë”©...'; document.getElementById("hiddenContractUrl").value = u.contract_url || "";
    if(u.contract_url) { try { const { data } = await _supabase.storage.from('contracts').createSignedUrl(u.contract_url, 3600); viewDiv.innerHTML = data ? `<a href="${data.signedUrl}" target="_blank" class="btn btn-sm btn-info w-100 text-white fw-bold">ğŸ“„ ê³„ì•½ì„œ ë³´ê¸°</a>` : `<span class="text-danger small">ì‹¤íŒ¨</span>`; } catch(e) { viewDiv.innerHTML = "-"; } } else viewDiv.innerHTML = `<span class="text-muted small">ë¯¸ë“±ë¡</span>`;

    const area = document.getElementById("btnResignArea");
    if(u.resign_date) area.innerHTML = `<button class="btn btn-sm btn-warning" onclick="cancelResign()">â†©ï¸ í‡´ì‚¬ ì·¨ì†Œ</button><button class="btn btn-sm btn-danger ms-2" onclick="reqDeletePermanent()">ğŸ—‘ï¸ ì‚­ì œ</button>`;
    else { area.innerHTML = `<button class="btn btn-sm btn-outline-danger" onclick="doResign()">â›” í‡´ì‚¬ ì²˜ë¦¬</button>`; loadSalaryData(); loadLeave(); }
    detailModal.show();
}

function toggleEditMode(isEdit) { const c = document.getElementById("infoContainer"); if(isEdit) c.classList.add("is-editing"); else c.classList.remove("is-editing"); }
function toggleSalaryVisibility() { const el = document.getElementById("viewSalary"); el.innerText = el.innerText === "******" ? el.dataset.real : "******"; }

async function saveBasicInfo() { 
    // 1. ê°’ ê°€ì ¸ì˜¤ê¸°
    const name = document.getElementById("editName").value; 
    const memberId = document.getElementById("editMemberId").value; // [ì¶”ê°€ë¨]
    const phone = document.getElementById("editPhone").value; 
    const email = document.getElementById("editEmail").value; 
    
    let fullAddress = document.getElementById("editAddress").value; 
    const detail = document.getElementById("editAddressDetail").value; 
    if(detail) fullAddress += " " + detail;

    const hireDate = document.getElementById("editHireDate").value; 
    const sal = Number(document.getElementById("editSalary").value); 
    const date = document.getElementById("salaryApplyDate").value; 

    // 2. ì—…ë°ì´íŠ¸ ê°ì²´ ìƒì„± (ë¹ˆ ê°’ì´ë©´ null ì²˜ë¦¬)
    const updates = { 
        emp_name: name, 
        member_id: memberId ? Number(memberId) : null, // [ì¶”ê°€ë¨] ìˆ«ì ë³€í™˜
        phone: phone, 
        email: email, 
        address: fullAddress, 
        hire_date: hireDate, 
        base_salary: sal, 
        salary_apply_date: date 
    }; 

    // 3. DB ì—…ë°ì´íŠ¸ ì‹œë„
    const { error } = await _supabase.from('ref_employees').update(updates).eq('emp_id', currentEmpId); 
    
    // [ì¤‘ìš”] ì—ëŸ¬ ë°œìƒ ì‹œ ì—¬ê¸°ì„œ ì¤‘ë‹¨ (í™”ë©´ ì—…ë°ì´íŠ¸ ì•ˆ í•¨)
    if(error) return showAlert("ì €ì¥ ì‹¤íŒ¨: " + error.message); 

    // 4. ì—°ë´‰ ì´ë ¥ ê´€ë¦¬ (ë³€ê²½ ì‹œì—ë§Œ)
    if (sal !== currentAnnualSalary) { 
        await _supabase.from('hr_salary_contracts').insert({ emp_id: currentEmpId, amount: sal, apply_date: date }); 
    } 

    // 5. ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    currentAnnualSalary = sal; 
    currentEmpHireDate = hireDate;

    // 6. [UI ì—…ë°ì´íŠ¸] DB ì €ì¥ì´ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì´ì œ í™”ë©´ì„ ê°±ì‹ í•¨
    document.getElementById("viewName").innerText = name; 
    document.getElementById("viewMemberId").innerText = memberId || "-"; // [ìœ„ì¹˜ ì´ë™ë¨] ì•ˆì „í•˜ê²Œ ì—¬ê¸°ì„œ ë³€ê²½
    document.getElementById("viewPhone").innerText = phone; 
    document.getElementById("viewEmail").innerText = email; 
    document.getElementById("viewAddress").innerText = fullAddress; 
    document.getElementById("viewHireDate").innerText = hireDate; 
    document.getElementById("viewSalary").dataset.real = sal.toLocaleString() + " ì›"; 
    document.getElementById("viewSalaryDate").innerText = date; 

    toggleEditMode(false); 
    showAlert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
}

async function saveRRN() { const f = document.getElementById("rrnFront").value; const b = document.getElementById("rrnBack").value; if((f+b).length !== 13) return showAlert("13ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); const { error } = await _supabase.rpc('update_employee_rrn', { p_emp_id: currentEmpId, p_rrn: f+"-"+b }); if(error) showAlert("ì‹¤íŒ¨: "+error.message); else { showAlert("ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); const { data: bd } = await _supabase.rpc('get_emp_birthdate', { p_emp_id: currentEmpId }); document.getElementById("viewBirth").innerText = bd || f; document.getElementById("rrnFront").value=""; document.getElementById("rrnBack").value=""; toggleEditMode(false); } }
async function uploadContract() { const fileInput = document.getElementById("contractFile"); if (fileInput.files.length === 0) return showAlert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); const file = fileInput.files[0]; const fileName = `${currentEmpId}_contract_${Date.now()}.${file.name.split('.').pop()}`; showLoading(); try { const { data: emp } = await _supabase.from('ref_employees').select('contract_url').eq('emp_id', currentEmpId).single(); if (emp?.contract_url && !emp.contract_url.startsWith('http')) await _supabase.storage.from('contracts').remove([emp.contract_url]); const { data, error } = await _supabase.storage.from('contracts').upload(fileName, file, { upsert: true }); if (error) throw error; await _supabase.from('ref_employees').update({ contract_url: data.path }).eq('emp_id', currentEmpId); hideLoading(); setTimeout(async () => { showAlert("ê³„ì•½ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); const { data: signed } = await _supabase.storage.from('contracts').createSignedUrl(data.path, 3600); document.getElementById("contractView").innerHTML = `<a href="${signed.signedUrl}" target="_blank" class="btn btn-sm btn-info w-100 text-white fw-bold">ğŸ“„ ê³„ì•½ì„œ ë³´ê¸°</a>`; document.getElementById("hiddenContractUrl").value = data.path; fileInput.value = ""; }, 500); } catch (err) { hideLoading(); setTimeout(() => showAlert("ì˜¤ë¥˜ ë°œìƒ: " + err.message), 500); } }

async function reqDeletePermanent() { showConfirm("âš ï¸ ì˜êµ¬ ì‚­ì œ ê²½ê³ ", `<strong>${currentEmpName}</strong> ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async function() { detailModal.hide(); const filePath = document.getElementById("hiddenContractUrl").value; if (filePath && !filePath.startsWith('http')) await _supabase.storage.from('contracts').remove([filePath]); await _supabase.from('hr_salary').delete().eq('emp_id', currentEmpId); await _supabase.from('hr_leave_adj').delete().eq('emp_id', currentEmpId); await _supabase.from('hr_salary_contracts').delete().eq('emp_id', currentEmpId); await _supabase.from('log_cert').delete().eq('emp_id', currentEmpId); await _supabase.from('ref_employees').delete().eq('emp_id', currentEmpId); showAlert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadList(); }); }
function doResign() { document.getElementById("inputResignDate").value = new Date().toISOString().slice(0, 10); resignModal.show(); }
async function confirmResign() { const rDate = document.getElementById("inputResignDate").value; if(!rDate) return showAlert("í‡´ì‚¬ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); resignModal.hide(); await _supabase.from('ref_employees').update({ resign_date: rDate }).eq('emp_id', currentEmpId); detailModal.hide(); loadList(); showAlert("í‡´ì‚¬ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }
async function cancelResign() { showConfirm("í‡´ì‚¬ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => { await _supabase.from('ref_employees').update({ resign_date: null }).eq('emp_id', currentEmpId); detailModal.hide(); loadList(); }); }

// [ìˆ˜ì •] ê¸‰ì—¬ ë°ì´í„° ë¡œë“œ (ì‚­ì œ ë²„íŠ¼ ì œì–´ ë¡œì§ ì¶”ê°€)
async function loadSalaryData() {
    const month = document.getElementById("salaryMonth").value;
    const badge = document.getElementById("salaryStatusBadge");
    const alertBox = document.getElementById("salaryAlertBox");
    
    // ë²„íŠ¼ DOM ê°€ì ¸ì˜¤ê¸°
    const btnSave = document.getElementById("btnSaveSalary");
    const btnDelete = document.getElementById("btnDeleteSalary");
    
    // 1. UI ì´ˆê¸°í™”
    badge.innerText = "ì¡°íšŒ ì¤‘...";
    badge.className = "badge bg-secondary";
    alertBox.classList.add("hidden");
    alertBox.innerHTML = "";
    
    // ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ (ì‚­ì œ ìˆ¨ê¹€)
    btnDelete.classList.add("d-none");
    btnSave.innerText = "ğŸ’¾ ê¸‰ì—¬ í™•ì • ë° ì €ì¥";
    btnSave.classList.remove("btn-warning");
    btnSave.classList.add("btn-success");
    
    if (!month || !currentEmpId) return;

    // --- (ê¸°ì¡´ ë¡œì§: ë¬´ê¸‰íœ´ê°€ ê°ì§€ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ---
    const startDate = `${month}-01`;
    const endDate = `${month}-31`;
    const { data: unpaidDocs } = await _supabase.from('ref_approval')
        .select('amount, doc_type, status')
        .eq('drafter_id', currentEmpId)
        .in('status', ['ì™„ë£Œ', 'ê°€ìŠ¹ì¸']) 
        .or('doc_type.ilike.%ë¬´ê¸‰%,doc_type.ilike.%ìƒë¦¬%,doc_type.ilike.%ê²°ê·¼%') 
        .gte('created_at', startDate)
        .lte('created_at', endDate);

    if (unpaidDocs && unpaidDocs.length > 0) {
        let totalUnpaidDays = 0;
        unpaidDocs.forEach(d => totalUnpaidDays += Number(d.amount));
        alertBox.innerHTML = `
            <div class="alert alert-danger d-flex align-items-center mb-0" role="alert">
                <div class="me-3 fs-2">âš ï¸</div>
                <div class="w-100">
                    <h6 class="alert-heading fw-bold mb-1">ê³µì œ ëŒ€ìƒ ê°ì§€ (${totalUnpaidDays}ì¼)</h6>
                    <div class="small text-danger">ë¬´ê¸‰/ê²°ê·¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸‰ì—¬ë¥¼ ì¡°ì •í•˜ì„¸ìš”.</div>
                </div>
            </div>`;
        alertBox.classList.remove("hidden");
    }
    // -----------------------------------------------------

    // [ë¡œì§] ê¸°ì¡´ ì €ì¥ëœ ê¸‰ì—¬ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
    const { data: saved } = await _supabase.from('hr_salary')
        .select('*')
        .eq('emp_id', currentEmpId)
        .eq('year_month', month)
        .single();

    if (saved) {
        // [ë°ì´í„° ìˆìŒ] -> ìˆ˜ì •/ì‚­ì œ ëª¨ë“œ
        document.getElementById("payTotalFixed").value = saved.pay_total || 0;
        document.getElementById("payMeal").value = saved.pay_meal;
        document.getElementById("payCar").value = saved.pay_car;
        document.getElementById("payChild").value = saved.pay_child;
        document.getElementById("payBonus").value = saved.pay_bonus;
        
        badge.innerText = "í™•ì •ë¨(ì €ì¥ì™„ë£Œ)";
        badge.className = "badge bg-primary"; // ìƒ‰ìƒ ë³€ê²½
        
        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        btnDelete.classList.remove("d-none"); // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        btnSave.innerText = "ğŸ’¾ ìˆ˜ì •ì‚¬í•­ ì €ì¥"; // ë¬¸êµ¬ ë³€ê²½
        btnSave.classList.remove("btn-success");
        btnSave.classList.add("btn-warning"); // ìƒ‰ìƒ ë³€ê²½ (ìˆ˜ì • ëŠë‚Œ)
        
        currentSalaryDataForPrint = saved;
        currentSalaryDataForPrint.year_month = month;
    } else {
        // [ë°ì´í„° ì—†ìŒ] -> ì‹ ê·œ ë“±ë¡ ëª¨ë“œ
        const monthlyTotal = Math.floor(currentAnnualSalary / 12); 
        document.getElementById("payTotalFixed").value = monthlyTotal; 
        document.getElementById("payMeal").value = 0;
        document.getElementById("payCar").value = 0;
        document.getElementById("payChild").value = 0;
        document.getElementById("payBonus").value = 0;
        
        badge.innerText = "ë¯¸ì €ì¥ (ìë™ê³„ì‚°)";
        badge.className = "badge bg-secondary";
        
        currentSalaryDataForPrint = null;
    }

    // ê³„ì‚°ì‹ ì ìš©
    recalcSalaryComponents();
}

// [ì‹ ê·œ] ê¸‰ì—¬ ì‚­ì œ í•¨ìˆ˜
async function deleteSalary() {
    const month = document.getElementById("salaryMonth").value;
    if (!month || !currentEmpId) return;

    // ì•ˆì „ì¥ì¹˜: ëª¨ë‹¬ë¡œ í™•ì¸
    showConfirm(
        "ğŸ—‘ï¸ ê¸‰ì—¬ ë‚´ì—­ ì‚­ì œ", 
        `<strong>${month}</strong>ì›” ê¸‰ì—¬ ë°ì´í„°ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span class="text-danger small">ì‚­ì œ í›„ì—ëŠ” ìë™ ê³„ì‚° ìƒíƒœë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.</span>`, 
        async function() {
            showLoading();
            const { error } = await _supabase.from('hr_salary')
                .delete()
                .eq('emp_id', currentEmpId)
                .eq('year_month', month);
            
            hideLoading();
            
            if (error) {
                showAlert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
            } else {
                showAlert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadSalaryData(); // í™”ë©´ ê°±ì‹  (ì´ˆê¸°í™”)
            }
        }
    );
}

function recalcSalaryComponents() {
    const total = Number(document.getElementById("payTotalFixed").value) || 0;
    const meal = Number(document.getElementById("payMeal").value) || 0; const car = Number(document.getElementById("payCar").value) || 0; const child = Number(document.getElementById("payChild").value) || 0;
    const basic = total - (meal + car + child);
    document.getElementById("payBasic").value = basic > 0 ? basic : 0;
}

// [ìˆ˜ì •] ê¸‰ì—¬ í™•ì • ë° ì €ì¥ (ì—°ë„ë³„ ìš”ìœ¨ ì ìš©)
async function saveSalary() {
    const month = document.getElementById("salaryMonth").value; 
    if (!month) return showAlert("ê·€ì†ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    // [í•µì‹¬ ë³€ê²½] ê·€ì†ì›”ì—ì„œ ì—°ë„ ì¶”ì¶œ -> í•´ë‹¹ ì—°ë„ ìš”ìœ¨ ê°€ì ¸ì˜¤ê¸°
    const targetYear = month.split('-')[0]; // "2025" ì¶”ì¶œ
    const rates = await getTaxRates(targetYear); // DBì—ì„œ ì¡°íšŒ

    // ratesê°€ ì—†ìœ¼ë©´(null) ê¸°ì¡´ ì „ì—­ë³€ìˆ˜ settings(í˜„ì¬ê°’)ë¥¼ ë°±ì—…ìœ¼ë¡œ ì‚¬ìš© (ì•ˆì „ì¥ì¹˜)
    const rule = rates || settings; 

    // 1. ì§€ê¸‰ì•¡ ê°€ì ¸ì˜¤ê¸°
    const p_basic = Number(document.getElementById("payBasic").value); 
    const p_meal = Number(document.getElementById("payMeal").value); 
    const p_car = Number(document.getElementById("payCar").value); 
    const p_child = Number(document.getElementById("payChild").value); 
    const p_bonus = Number(document.getElementById("payBonus").value);
    
    const p_total = p_basic + p_meal + p_car + p_child + p_bonus;

    // 2. ë¹„ê³¼ì„¸ í•œë„ ì ìš© (DBê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ í•˜ë“œì½”ë”© ê°’)
    const limit_meal = rule['limit_meal'] || 200000;
    const limit_car = rule['limit_car'] || 200000;
    const limit_child = rule['limit_child'] || 200000;

    const tf_meal = Math.min(p_meal, limit_meal); 
    const tf_car = Math.min(p_car, limit_car); 
    const tf_child = Math.min(p_child, limit_child);
    
    // ê³¼ì„¸ í‘œì¤€ì•¡
    const tax_base = p_total - (tf_meal + tf_car + tf_child);

    // 3. 4ëŒ€ë³´í—˜ ê³„ì‚° (DB ìš”ìœ¨ ì ìš©)
    // rule['key'] || 0.045 -> DBì— ê°’ì´ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
    const pen = Math.floor(tax_base * (rule['pension_rate_emp'] || 0.045)); 
    const hlt = Math.floor((tax_base * (rule['health_rate_emp'] || 0.03545))/10)*10; 
    const care = Math.floor((hlt * (rule['care_rate_ratio'] || 0.1295))/10)*10; 
    const emp = Math.floor(tax_base * (rule['employ_rate_emp'] || 0.009));

    // 4. ì†Œë“ì„¸ ê³„ì‚° (ë³„ë„ í•¨ìˆ˜ ì‚¬ìš©)
    let inc = calculateIncomeTax(tax_base);
    let loc = Math.floor((inc * 0.1) / 10) * 10; // ì§€ë°©ì„¸ 10%

    // 5. DB ì €ì¥ Payload ìƒì„±
    const payload = { 
        emp_id: currentEmpId, 
        emp_name: currentEmpName, 
        year_month: month, 
        pay_basic: p_basic, pay_meal: p_meal, pay_car: p_car, pay_child: p_child, pay_bonus: p_bonus, pay_total: p_total, 
        ded_pension: pen, ded_health: hlt, ded_care: care, ded_employ: emp, 
        ded_income: inc, ded_local: loc, 
        ded_total: pen+hlt+care+emp+inc+loc, 
        net_pay: p_total-(pen+hlt+care+emp+inc+loc) 
    };

    // [6] Insert or Update ì‹¤í–‰
    const { data: existing } = await _supabase.from('hr_salary').select('id').eq('emp_id', currentEmpId).eq('year_month', month).single();
    
    // ì§ì› ë¶€ë‹´ê¸ˆ(JSê³„ì‚°) ì €ì¥
    const { error } = existing 
        ? await _supabase.from('hr_salary').update(payload).eq('id', existing.id) 
        : await _supabase.from('hr_salary').insert(payload);

    if (error) {
        showAlert("ì‹¤íŒ¨: " + error.message);
    } else {
        // [í•µì‹¬ ë³€ê²½] ì €ì¥ ì„±ê³µ í›„, SQL í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ íšŒì‚¬ ë¶€ë‹´ê¸ˆ ì¼ê´„ ê³„ì‚°
        // ì¸ì: '2025-01' ê°™ì€ í˜•íƒœ (month ë³€ìˆ˜)
        const { error: rpcError } = await _supabase.rpc('calc_company_share', { target_ym: month });

        if(rpcError) {
            showAlert("ê¸‰ì—¬ëŠ” ì €ì¥ëìœ¼ë‚˜, íšŒì‚¬ë¶€ë‹´ê¸ˆ ê³„ì‚° ì‹¤íŒ¨: " + rpcError.message);
        } else {
            showAlert(`${month} ê¸‰ì—¬ í™•ì • ë° íšŒì‚¬ë¶€ë‹´ê¸ˆ ê³„ì‚° ì™„ë£Œ.`);
            loadSalaryData(); // í™”ë©´ ê°±ì‹ 
        }
    }
}

// [ìˆ˜ì •] ê´€ë¦¬ììš© ì—°ì°¨ ì¡°íšŒ (íŠ¹ì • ì§ì›)
async function loadLeave() { 
    // ì „ì—­ë³€ìˆ˜ currentEmpId ì‚¬ìš©
    const { data: remainDays, error } = await _supabase.rpc('calculate_leave_days', { p_emp_id: currentEmpId });
    
    if (error) {
        alert("ì—°ì°¨ ì¡°íšŒ ì‹¤íŒ¨: " + error.message);
        return;
    }
    
    document.getElementById("displayLeaveRemain").innerText = remainDays + "ì¼"; 
}
async function saveLog() { const type = document.getElementById("logType").value; const val = Number(document.getElementById("logValue").value); const reason = document.getElementById("logReason").value; if(!val || !reason) return showAlert("ì…ë ¥ í•„ìš”"); await _supabase.from('hr_leave_adj').insert({ emp_id: currentEmpId, adj_type: type, days: val, reason: reason }); showAlert("ë°˜ì˜ë¨"); document.getElementById("logValue").value = ""; document.getElementById("logReason").value = ""; loadLeave(); }

function openAdminCertModal() { document.getElementById("adminCertPurpose").value = "ê´€ê³µì„œ ì œì¶œìš©"; toggleAdminEtc(); adminCertModal.show(); }
function toggleAdminEtc() { const v = document.getElementById("adminCertPurpose").value; const e = document.getElementById("adminCertEtc"); if(v==='ê¸°íƒ€') { e.style.display='block'; e.focus(); } else e.style.display='none'; }

// [ìµœì¢… ìˆ˜ì •] ê´€ë¦¬ììš© ì¬ì§ì¦ëª…ì„œ ë°œê¸‰ (DB í•¨ìˆ˜ ì‚¬ìš©ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€ ë° ë¡œì§ í†µì¼)
async function reqIssueCert() {
    // 1. ìš©ë„ í™•ì¸
    let purpose = document.getElementById("adminCertPurpose").value;
    if(purpose === 'ê¸°íƒ€') purpose = document.getElementById("adminCertEtc").value;
    if(!purpose) return showAlert("ìš©ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    adminCertModal.hide();

    // 2. ìƒë…„ì›”ì¼ ì¡°íšŒ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const { data: birthDate } = await _supabase.rpc('get_emp_birthdate', { p_emp_id: currentEmpId });
    const birthStr = birthDate || "ë¯¸ë“±ë¡";

    // [í•µì‹¬ ë³€ê²½] í´ë¼ì´ì–¸íŠ¸ ì¹´ìš´íŒ… ì‚­ì œ -> DB RPC í•¨ìˆ˜ í˜¸ì¶œë¡œ ëŒ€ì²´
    // ê´€ë¦¬ìê°€ ë°œê¸‰í•˜ë”ë¼ë„ DBê°€ ìˆœë²ˆì„ ë§¤ê²¨ì•¼ ì•ˆì „í•©ë‹ˆë‹¤.
    const { data: newCert, error } = await _supabase.rpc('issue_certificate', {
        p_emp_id: currentEmpId,
        p_emp_name: currentEmpName,
        p_purpose: purpose,
        p_type: 'ì¬ì§ì¦ëª…ì„œ'
    });

    if (error) {
        console.error(error);
        return showAlert("ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
    }

    // 3. ì¬ì§ ê¸°ê°„ ê³„ì‚° (UI ë¡œì§)
    const hireDate = document.getElementById("viewHireDate").innerText;
    let tenureStr = "-";
    if(hireDate && hireDate !== '-') {
        const join = new Date(hireDate); 
        const now = new Date(); 
        const diff = now - join; 
        const y = Math.floor(diff / (1000*60*60*24*365)); 
        const m = Math.floor((diff % (1000*60*60*24*365)) / (1000*60*60*24*30)); 
        tenureStr = `${hireDate}~í˜„ì¬ (${y}ë…„ ${m}ê°œì›”)`;
    }
    
    // 4. íšŒì‚¬ ì •ë³´ ì¤€ë¹„
    const compName = companyInfo.company_name || companyInfo.orgName || "ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©";
    const ceoName = companyInfo.chairman_name || companyInfo.ceoName || "ì´ì‚¬ì¥";
    let cleanAddr = (companyInfo.company_address || "").replace(/ìš©ì¸ëª¨ë‘ì˜\s?í–‡ë¹›í˜‘ë™ì¡°í•©/g, '').trim();
    
    // ë¶€ì„œ/ì§ê¸‰ ì •ë³´ í™•ì¸
    let dept="", pos=""; 
    const { data: empData } = await _supabase.from('ref_employees').select('department, position').eq('emp_id', currentEmpId).single(); 
    if(empData) { dept = empData.department; pos = empData.position; }

    // 5. ì¸ì‡„ ë°ì´í„° íŒ¨í‚¤ì§• (DBì—ì„œ ë°›ì€ ì•ˆì „í•œ cert_num ì‚¬ìš©)
    const certData = { 
        docNum: newCert.cert_num, // DBê°€ ìƒì„±í•œ ë²ˆí˜¸
        logo: companyInfo.logo_horizontal_url || "", 
        name: currentEmpName, 
        birth: birthStr, 
        dept: dept, 
        pos: pos, 
        address: document.getElementById("viewAddress").innerText, 
        tenure: tenureStr, 
        purpose: purpose, 
        today: new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }), 
        chairman: ceoName, 
        compName: compName, 
        compAddr: cleanAddr, 
        contact: companyInfo.company_contact, 
        seal: companyInfo.seal_url 
    };
    
    // 6. ì¸ì‡„ ì„œë¹„ìŠ¤ í˜¸ì¶œ
    PrintService.printCert(certData);
}

function printSalaryAdmin() {
    if(!currentSalaryDataForPrint) return showAlert("ì €ì¥ëœ ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
    const d = currentSalaryDataForPrint;
    const [y, m] = d.year_month.split('-');
    
    // ìŠ¤ë§ˆíŠ¸ ê¸°ê°„ ì‚°ì •
    const getSmartAttribution = (ymStr) => {
        const [yy, mm] = ymStr.split('-').map(Number);
        let startDay = 1;
        let lastDay = new Date(yy, mm, 0).getDate();
        if(currentEmpHireDate) {
            const hDate = new Date(currentEmpHireDate);
            if(hDate.getFullYear() === yy && (hDate.getMonth()+1) === mm) startDay = hDate.getDate();
        }
        if(currentEmpResignDate) {
            const rDate = new Date(currentEmpResignDate);
            if(rDate.getFullYear() === yy && (rDate.getMonth()+1) === mm) lastDay = rDate.getDate();
        }
        return `${yy}ë…„ ${mm}ì›”<br>(${yy}.${String(mm).padStart(2,'0')}.${String(startDay).padStart(2,'0')} ~ ${yy}.${String(mm).padStart(2,'0')}.${lastDay})`;
    };

    const payDateObj = new Date(y, Number(m), 10); 
    const payDateStr = `${payDateObj.getFullYear()}ë…„ ${payDateObj.getMonth()+1}ì›” ${payDateObj.getDate()}ì¼`;
    const fmt = (n) => Number(n || 0).toLocaleString(); 
    
    // íšŒì‚¬ ì •ë³´ ì•ˆì „í•˜ê²Œ ì°¸ì¡°
    const compName = companyInfo.company_name || companyInfo.orgName || "ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©";
    const ceoName = companyInfo.chairman_name || companyInfo.ceoName || "ì´ì‚¬ì¥";

    // ë°ì´í„° íŒ¨í‚¤ì§•
    const salaryData = { 
        titleDate: `${y}ë…„ ${Number(m)}ì›”`, 
        attrDate: getSmartAttribution(d.year_month), 
        payDate: payDateStr, 
        empInfo: `${currentEmpId} / ${currentEmpName}`, 
        dept: "", pos: "", 
        p_basic: fmt(d.pay_basic), p_meal: fmt(d.pay_meal), p_car: fmt(d.pay_car), 
        p_pos: fmt(d.pay_position), p_svc: fmt(d.pay_service), p_ot: fmt(d.pay_overtime), 
        p_child: fmt(d.pay_child), p_bonus: fmt(d.pay_bonus), p_total: fmt(d.pay_total), 
        d_pen: fmt(d.ded_pension), d_hlt: fmt(d.ded_health), d_care: fmt(d.ded_care), 
        d_emp: fmt(d.ded_employ), d_inc: fmt(d.ded_income), d_loc: fmt(d.ded_local), 
        d_adv: fmt(d.ded_advance), d_cap: fmt(d.ded_capital), d_total: fmt(d.ded_total), 
        net: fmt(d.net_pay), 
        logo: companyInfo.logo_horizontal_url || "", 
        seal: companyInfo.seal_url, 
        chairman: ceoName, 
        compName: compName 
    };

    // ë¶€ì„œ/ì§ê¸‰ ì¡°íšŒ í›„ ì¸ì‡„ ëª¨ë“ˆ í˜¸ì¶œ
    _supabase.from('ref_employees').select('department, position').eq('emp_id', currentEmpId).single().then(({data}) => { 
        if(data) { salaryData.dept = data.department; salaryData.pos = data.position; } 
        // [ë³€ê²½] ì™¸ë¶€ ëª¨ë“ˆ í˜¸ì¶œ
        PrintService.printSalary(salaryData);
    });
}

function openLedgerModal() { ledgerModal.show(); }
async function printLedger() {
    const ym = document.getElementById("ledgerMonth").value; 
    if(!ym) return showAlert("ì—°ì›”ì„ ì„ íƒí•˜ì„¸ìš”."); 
    ledgerModal.hide();

    // 1. ë°ì´í„° ì¡°íšŒ
    const { data: list, error } = await _supabase.from('hr_salary').select('*').eq('year_month', ym).order('emp_name');
    if(error || !list || list.length === 0) return showAlert("í•´ë‹¹ ì›”ì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    
    // 2. ì§‘ê³„ ë° í…Œì´ë¸” HTML ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    let t = { basic:0, meal:0, car:0, child:0, pos:0, svc:0, ot:0, bonus:0, p_total:0, pen:0, hlt:0, care:0, emp:0, inc:0, loc:0, adv:0, cap:0, d_total:0, net:0 };
    
    const rowsHtml = list.map((d, i) => {
        // í•©ê³„ ëˆ„ì 
        t.basic+=d.pay_basic; t.meal+=d.pay_meal; t.car+=d.pay_car; t.child+=d.pay_child; 
        t.pos+=(d.pay_position||0); t.svc+=(d.pay_service||0); t.ot+=(d.pay_overtime||0); t.bonus+=(d.pay_bonus||0); t.p_total+=d.pay_total;
        t.pen+=d.ded_pension; t.hlt+=d.ded_health; t.care+=d.ded_care; t.emp+=d.ded_employ; 
        t.inc+=d.ded_income; t.loc+=d.ded_local; t.adv+=(d.ded_advance||0); t.cap+=(d.ded_capital||0); t.d_total+=d.ded_total; t.net+=d.net_pay;
        
        // í–‰ HTML ìƒì„±
        return `<tr style="height:30px;"><td class="text-center">${i+1}</td><td class="text-center fw-bold">${d.emp_name}</td><td class="text-end">${Number(d.pay_basic).toLocaleString()}</td><td class="text-end">${Number(d.pay_meal).toLocaleString()}</td><td class="text-end">${Number(d.pay_car).toLocaleString()}</td><td class="text-end">${Number(d.pay_child+(d.pay_position||0)+(d.pay_service||0)+(d.pay_overtime||0)).toLocaleString()}</td><td class="text-end">${Number(d.pay_bonus||0).toLocaleString()}</td><td class="text-end bg-light fw-bold">${Number(d.pay_total).toLocaleString()}</td><td class="text-end">${Number(d.ded_pension).toLocaleString()}</td><td class="text-end">${Number(d.ded_health).toLocaleString()}</td><td class="text-end">${Number(d.ded_care).toLocaleString()}</td><td class="text-end">${Number(d.ded_employ).toLocaleString()}</td><td class="text-end">${Number(d.ded_income).toLocaleString()}</td><td class="text-end">${Number(d.ded_local).toLocaleString()}</td><td class="text-end">${Number((d.ded_advance||0)+(d.ded_capital||0)).toLocaleString()}</td><td class="text-end bg-light fw-bold" style="color:#c62828;">${Number(d.ded_total).toLocaleString()}</td><td class="text-end fw-bold" style="background:#e3f2fd;">${Number(d.net_pay).toLocaleString()}</td></tr>`;
    }).join("");

    const totalHtml = `<tr style="background:#eee; font-weight:bold; height:35px;"><td colspan="2" class="text-center">í•© ê³„</td><td class="text-end">${t.basic.toLocaleString()}</td><td class="text-end">${t.meal.toLocaleString()}</td><td class="text-end">${t.car.toLocaleString()}</td><td class="text-end">${(t.child+t.pos+t.svc+t.ot).toLocaleString()}</td><td class="text-end">${t.bonus.toLocaleString()}</td><td class="text-end">${t.p_total.toLocaleString()}</td><td class="text-end">${t.pen.toLocaleString()}</td><td class="text-end">${t.hlt.toLocaleString()}</td><td class="text-end">${t.care.toLocaleString()}</td><td class="text-end">${t.emp.toLocaleString()}</td><td class="text-end">${t.inc.toLocaleString()}</td><td class="text-end">${t.loc.toLocaleString()}</td><td class="text-end">${(t.adv+t.cap).toLocaleString()}</td><td class="text-end" style="color:#c62828;">${t.d_total.toLocaleString()}</td><td class="text-end" style="background:#bbdefb;">${t.net.toLocaleString()}</td></tr>`;

    // 3. ì¸ì‡„ ëª¨ë“ˆ í˜¸ì¶œ (ì´ ë¶€ë¶„ë§Œ ë³€ê²½ë¨)
    const [y, m] = ym.split('-');
    const ceoName = companyInfo.chairman_name || companyInfo.ceoName || "ì´ì‚¬ì¥";
    
    const ledgerData = { 
        title: `${y}ë…„ ${Number(m)}ì›” ê¸‰ì—¬ëŒ€ì¥`, 
        tableBody: rowsHtml + totalHtml, 
        logo: companyInfo.logo_horizontal_url || "", 
        chairman: ceoName 
    };
    
    // ì™¸ë¶€ íŒŒì¼(print_service.js)ì˜ í•¨ìˆ˜ í˜¸ì¶œ
    PrintService.printLedger(ledgerData);
}


  // =========================================================
// [í†µê³„ ëŒ€ì‹œë³´ë“œ ë¡œì§] - 10ë…„ì°¨ ì‹œë‹ˆì–´ ê°œë°œì ì‘ì„±
// =========================================================

let statsModalInstance;
let charts = {}; // ì°¨íŠ¸ ê°ì²´ë“¤ì„ ë‹´ì•„ë‘˜ ë³€ìˆ˜ (ì¤‘ë³µ ìƒì„± ë°©ì§€ìš©)

// 1. ëŒ€ì‹œë³´ë“œ ì—´ê¸° ë° ë°ì´í„° ë¡œë“œ ë©”ì¸ í•¨ìˆ˜
async function openStatsDashboard() {
    if(!statsModalInstance) statsModalInstance = new bootstrap.Modal(document.getElementById('statsModal'));
    statsModalInstance.show();

    // ë¡œë”© í‘œì‹œ (ê°„ëµíˆ)
    document.getElementById("valAvgTime").innerText = "ê³„ì‚° ì¤‘...";

    // [ë°ì´í„° í™•ë³´] ì „ìê²°ì¬(ì§€ì¶œ í¬í•¨) & ê¸‰ì—¬ëŒ€ì¥ ë™ì‹œì— ì¡°íšŒ (ë³‘ë ¬ ì²˜ë¦¬)
    // ìµœê·¼ 1ë…„ì¹˜ ë°ì´í„°ë§Œ ì¡°íšŒí•˜ì—¬ ì„±ëŠ¥ ìµœì í™”
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    const dateStr = oneYearAgo.toISOString();

    const [approvalRes, salaryRes] = await Promise.all([
        _supabase.from('ref_approval').select('*').gte('created_at', dateStr).order('created_at', {ascending: true}),
        _supabase.from('hr_salary').select('*').gte('created_at', dateStr).order('year_month', {ascending: true})
    ]);

    if(approvalRes.error || salaryRes.error) return showAlert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");

    const appList = approvalRes.data || [];
    const salaryList = salaryRes.data || [];

    // 2. ê° ì„¹ì…˜ë³„ ë¶„ì„ ë° ë Œë”ë§ ì‹¤í–‰
    renderEfficiencyStats(appList);
    renderRejectionStats(appList);
    renderFinanceStats(appList, salaryList);
}

// ---------------------------------------------------------
// [ë¶„ì„ 1] ê²°ì¬ íš¨ìœ¨ì„± (ì†Œìš”ì‹œê°„)
// ---------------------------------------------------------
function renderEfficiencyStats(list) {
    // 1) ë°ì´í„° ê°€ê³µ
    let monthlyData = {}; // ì›”ë³„ {ì´ì‹œê°„, ê±´ìˆ˜}
    let approverStats = {}; // ê²°ì¬ìë³„ {ì´ì‹œê°„, ê±´ìˆ˜}

    list.forEach(doc => {
        if(doc.status !== 'ì™„ë£Œ') return; // ì™„ë£Œëœ ê±´ë§Œ ë¶„ì„
        
        // JSON íŒŒì‹±: approval_line í™•ì¸
        if(!doc.approval_line || !Array.isArray(doc.approval_line)) return;

        // ìµœì¢… ìŠ¹ì¸ì ì°¾ê¸° (statusê°€ 'ìŠ¹ì¸'ì¸ ë§ˆì§€ë§‰ ì‚¬ëŒ)
        // filterë¥¼ ì“°ëŠ” ì´ìœ : ì¤‘ê°„ì— 'ì°¸ì¡°'ë‚˜ 'ëŒ€ê¸°'ê°€ ì„ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì‹¤í•œ ìŠ¹ì¸ìë§Œ ì¶”ì¶œ
        const approvers = doc.approval_line.filter(l => l.status === 'ìŠ¹ì¸' && l.processed_at);
        if(approvers.length === 0) return;

        const lastApprover = approvers[approvers.length - 1];
        
        const start = new Date(doc.created_at);
        const end = new Date(lastApprover.processed_at);
        const diffHours = (end - start) / (1000 * 60 * 60); // ì‹œê°„ ë‹¨ìœ„ ë³€í™˜

        // ì›”ë³„ ì§‘ê³„
        const monthKey = doc.created_at.slice(0, 7); // YYYY-MM
        if(!monthlyData[monthKey]) monthlyData[monthKey] = { sum: 0, count: 0 };
        monthlyData[monthKey].sum += diffHours;
        monthlyData[monthKey].count++;

        // ê²°ì¬ìë³„ ì§‘ê³„ (ê°œì¸ë³„ í‰ê·  ì‹œê°„)
        approvers.forEach(who => {
            if(!who.processed_at) return;
            // ê²°ì¬ìê°€ ë°›ì€ ì‹œì ë¶€í„° ì²˜ë¦¬í•œ ì‹œì ê¹Œì§€ ì•Œê¸°ëŠ” ì–´ë ¤ìš°ë¯€ë¡œ(ë„ì°©ì‹œê°„ ë°ì´í„° ë¶€ì¬),
            // ì—¬ê¸°ì„œëŠ” 'ì „ì²´ ë¦¬ë“œíƒ€ì„'ì— ëŒ€í•œ ê¸°ì—¬ë„ë¡œ ë‹¨ìˆœí™”í•˜ì§€ ì•Šê³ 
            // "ìµœì¢… ìŠ¹ì¸ì" ê¸°ì¤€ì´ ì•„ë‹Œ, ëª¨ë“  ìŠ¹ì¸ìì˜ ì´ë ¥ì„ ì¹´ìš´íŠ¸í•©ë‹ˆë‹¤.
            // *ì •í™•ë„ í–¥ìƒ: ë³¸ì¸ì´ ìŠ¹ì¸í•œ ê±´ìˆ˜ ì¹´ìš´íŠ¸
            if(!approverStats[who.name]) approverStats[who.name] = { sum: 0, count: 0 };
            // ì—¬ê¸°ì„  ë‹¨ìˆœíˆ ë³¸ì¸ì´ í¬í•¨ëœ ë¬¸ì„œì˜ ì „ì²´ ë¦¬ë“œíƒ€ì„ì„ ë„£ê¸°ë³´ë‹¤, ì²˜ë¦¬ ê±´ìˆ˜ ìœ„ì£¼ë¡œ ë´…ë‹ˆë‹¤.
            // í•˜ì§€ë§Œ 'ë³‘ëª©'ì„ ì°¾ìœ¼ë ¤ë©´ processed_atì´ ì¤‘ìš”í•˜ë¯€ë¡œ, 
            // ì—¬ê¸°ì„œëŠ” ì‹¬í”Œí•˜ê²Œ 'ë‚´ê°€ ê²°ì¬í•œ ë¬¸ì„œë“¤ì˜ ì²˜ë¦¬ì‹œê°„'ì„ ì¼ë‹¨ ëˆ„ì í•©ë‹ˆë‹¤.
            // (ë” ì •ë°€í•œ ë¶„ì„ì€ 'ë„ì°©ì¼ì‹œ' ì¹¼ëŸ¼ì´ í•„ìš”í•¨)
            approverStats[who.name].sum += diffHours; 
            approverStats[who.name].count++;
        });
    });

    // 2) ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
    const labels = Object.keys(monthlyData).sort();
    const values = labels.map(m => (monthlyData[m].sum / monthlyData[m].count).toFixed(1));

    // ì´ë²ˆ ë‹¬ í‰ê·  í‘œì‹œ
    const thisMonth = new Date().toISOString().slice(0, 7);
    const currData = monthlyData[thisMonth];
    document.getElementById("valAvgTime").innerText = currData ? (currData.sum / currData.count).toFixed(1) + "ì‹œê°„" : "-";

    // 3) ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    drawChart('chartTime', 'line', {
        labels: labels,
        datasets: [{
            label: 'í‰ê·  ì†Œìš”ì‹œê°„ (ì‹œê°„)',
            data: values,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.3,
            fill: true
        }]
    });

    // 4) ë°±ë°ì´í„° í…Œì´ë¸” (ê²°ì¬ê°€ ëŠ¦ì€ ìˆœìœ„ - í‰ê· ê°’ì´ ë†’ì€ ìˆœ)
    // *ì •í™•í•œ ë³‘ëª© ë¶„ì„ì„ ìœ„í•´ì„  'ë„ì°©->ìŠ¹ì¸' ê°­ì´ í•„ìš”í•˜ì§€ë§Œ, í˜„ì¬ ë°ì´í„°ë¡œëŠ” 'ì „ì²´ ë¦¬ë“œíƒ€ì„' í‰ê· ìœ¼ë¡œ ëŒ€ì²´
    const rank = Object.keys(approverStats).map(name => ({
        name: name,
        avg: (approverStats[name].sum / approverStats[name].count).toFixed(1),
        count: approverStats[name].count
    })).sort((a, b) => b.avg - a.avg).slice(0, 5); // Top 5

    document.getElementById("tblSlowApprover").innerHTML = rank.map((r, i) => 
        `<tr><td>${i+1}</td><td class="fw-bold">${r.name}</td><td>${r.avg}ì‹œê°„</td><td>${r.count}ê±´</td></tr>`
    ).join("");
}

// ---------------------------------------------------------
// [ë¶„ì„ 2] ë°˜ë ¤ í˜„í™© (ì‚¬ìœ  ë¶„ì„)
// ---------------------------------------------------------
function renderRejectionStats(list) {
    let rejectReasons = {};
    let rejectors = {};

    list.forEach(doc => {
        if(doc.status !== 'ë°˜ë ¤') return;

        // JSON íŒŒì‹±
        if(!doc.approval_line || !Array.isArray(doc.approval_line)) return;
        
        // ëˆ„ê°€ ë°˜ë ¤í–ˆëŠ”ì§€ ì°¾ê¸°
        const rejecterObj = doc.approval_line.find(l => l.status === 'ë°˜ë ¤');
        if(rejecterObj) {
            // ë°˜ë ¤ì ì¹´ìš´íŠ¸
            rejectors[rejecterObj.name] = (rejectors[rejecterObj.name] || 0) + 1;

            // ì‚¬ìœ  í‚¤ì›Œë“œ ì¶”ì¶œ (ê°„ë‹¨í•œ ê³µë°± ë¶„ë¦¬)
            const comment = rejecterObj.comment || "ì‚¬ìœ ì—†ìŒ";
            // ê°„ë‹¨í•˜ê²Œ ì „ì²´ ë¬¸ì¥ì„ ì¹´ìš´íŠ¸í•˜ê±°ë‚˜, í•µì‹¬ ë‹¨ì–´ë§Œ ì¶”ì¶œ
            // ì—¬ê¸°ì„œëŠ” 'ì‚¬ìœ  ë‚´ìš©' ìì²´ë¥¼ ê·¸ë£¹í™”í•©ë‹ˆë‹¤. (ë„ˆë¬´ ê¸¸ë©´ ì• 10ê¸€ìë§Œ)
            const key = comment.length > 10 ? comment.slice(0, 10) + "..." : comment;
            rejectReasons[key] = (rejectReasons[key] || 0) + 1;
        }
    });

    // 1) ë°˜ë ¤ ì‚¬ìœ  ì°¨íŠ¸ (ë„ë„›)
    const reasonLabels = Object.keys(rejectReasons).sort((a, b) => rejectReasons[b] - rejectReasons[a]).slice(0, 5);
    const reasonValues = reasonLabels.map(k => rejectReasons[k]);

    drawChart('chartRejectReason', 'doughnut', {
        labels: reasonLabels,
        datasets: [{
            data: reasonValues,
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff']
        }]
    });

    // 2) ë°˜ë ¤ì ë­í‚¹ í…Œì´ë¸”
    const sortedRejectors = Object.keys(rejectors).map(name => ({ name, count: rejectors[name] }))
        .sort((a, b) => b.count - a.count).slice(0, 5);

    document.getElementById("tblRejectKing").innerHTML = sortedRejectors.map(r => 
        `<tr><td class="fw-bold">${r.name}</td><td>${r.count}ê±´</td><td><div class="progress" style="height: 6px;"><div class="progress-bar bg-danger" style="width: ${Math.min(r.count*10, 100)}%"></div></div></td></tr>`
    ).join("");
}

// ---------------------------------------------------------
// [ë¶„ì„ 3] ìê¸ˆ íë¦„ (ì¸ê±´ë¹„ vs ì§€ì¶œê²°ì˜)
// ---------------------------------------------------------
function renderFinanceStats(appList, salaryList) {
    let financeData = {}; // Key: YYYY-MM, Value: { labor: 0, expense: 0 }

    // 1) ì¸ê±´ë¹„ ì§‘ê³„ (hr_salary)
    salaryList.forEach(s => {
        const ym = s.year_month; // YYYY-MM
        if(!financeData[ym]) financeData[ym] = { labor: 0, expense: 0 };
        financeData[ym].labor += Number(s.pay_total); // ì§€ê¸‰ ì´ì•¡ ê¸°ì¤€
    });

    // 2) ì¼ë°˜ì§€ì¶œ ì§‘ê³„ (ref_approval)
    appList.forEach(doc => {
        if(doc.status !== 'ì™„ë£Œ') return;
        // doc_typeì— 'ì§€ì¶œ'ì´ í¬í•¨ëœ ê²ƒë§Œ (íœ´ê°€ ë“± ì œì™¸)
        if(doc.doc_type && doc.doc_type.includes('ì§€ì¶œ')) {
            const ym = doc.created_at.slice(0, 7);
            if(!financeData[ym]) financeData[ym] = { labor: 0, expense: 0 };
            financeData[ym].expense += Number(doc.amount);
        }
    });

    // ì •ë ¬ (ìµœê·¼ 6ê°œì›”)
    const keys = Object.keys(financeData).sort().slice(-6); 
    const laborArr = keys.map(k => financeData[k].labor);
    const expArr = keys.map(k => financeData[k].expense);

    // 3) ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ìŠ¤íƒ ë§‰ëŒ€)
    drawChart('chartFinance', 'bar', {
        labels: keys,
        datasets: [
            { label: 'ì¸ê±´ë¹„', data: laborArr, backgroundColor: '#4bc0c0', stack: 'Stack 0' },
            { label: 'ì¼ë°˜ì§€ì¶œ', data: expArr, backgroundColor: '#ff9f40', stack: 'Stack 0' }
        ]
    });

    // 4) ë°±ë°ì´í„° í…Œì´ë¸”
    document.getElementById("tblFinanceBack").innerHTML = keys.map(k => {
        const l = financeData[k].labor;
        const e = financeData[k].expense;
        const total = l + e;
        const ratio = total > 0 ? ((l / total) * 100).toFixed(1) : 0;
        return `<tr><td>${k}</td><td>${l.toLocaleString()}</td><td>${e.toLocaleString()}</td><td class="fw-bold">${total.toLocaleString()}</td><td class="text-primary">${ratio}%</td></tr>`;
    }).join("");
}

// [ê³µí†µ] ì°¨íŠ¸ ê·¸ë¦¬ê¸° í—¬í¼ í•¨ìˆ˜
function drawChart(canvasId, type, dataConfig) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ (ì¤‘ë³µ ê²¹ì¹¨ ë°©ì§€)
    if(charts[canvasId]) {
        charts[canvasId].destroy();
    }

    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: dataConfig,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: type === 'bar' || type === 'line' ? {
                y: { beginAtZero: true }
            } : {}
        }
    });
}
  // [ê³µí†µ] ì¡°í•©ì› ë²ˆí˜¸ ì…ë ¥ ì‹œ ìë™ í•˜ì´í”ˆ (2025-24-0002)
function autoHyphenMemberId(target) {
    let val = target.value.replace(/[^0-9]/g, ''); // ìˆ«ì ì™¸ ì œê±°
    if (val.length > 10) val = val.substring(0, 10); // ìµœëŒ€ 10ìë¦¬ ì œí•œ

    if (val.length > 6) {
        val = val.replace(/(\d{4})(\d{2})(\d{1,4})/, '$1-$2-$3');
    } else if (val.length > 4) {
        val = val.replace(/(\d{4})(\d{1,2})/, '$1-$2');
    }
    target.value = val;
}
  // [ì‹ ê·œ] 2024/2025 êµ­ì„¸ì²­ ê·¼ë¡œì†Œë“ ê°„ì´ì„¸ì•¡í‘œ ì•½ì‹ ë¡œì§ (1ì¸ ê°€êµ¬ ê¸°ì¤€)
// ì •í™•ë„: ì˜¤ì°¨ë²”ìœ„ 10~100ì› ë‚´ì™¸ (ì‹¤ë¬´ ì‚¬ìš© ê°€ëŠ¥)
function calculateIncomeTax(monthlyIncome) {
    // 1. ë¹„ê³¼ì„¸ ì œì™¸í•œ ì›” ê¸‰ì—¬ (ë‹¨ìœ„: ì›)
    const income = monthlyIncome; 
    
    // 2. ê·¼ë¡œì†Œë“ ê°„ì´ì„¸ì•¡í‘œ ì‚°ì¶œ ë¡œì§ (2024 ê°œì • ê¸°ì¤€ ê·¼ì‚¬ì¹˜)
    // 106ë§Œì› ë¯¸ë§Œì€ ë©´ì„¸
    if (income < 1060000) return 0;

    let tax = 0;

    // êµ¬ê°„ë³„ ê³„ì‚° (êµ­ì„¸ì²­ ì‚°ì¶œì‹ ì—­ì‚° ë¡œì§)
    if (income <= 3000000) {
        // 300ë§Œì› ì´í•˜ êµ¬ê°„: (ê¸‰ì—¬ - ê³µì œ) * ì•½ 3~4% ë‚´ì™¸
        // *ì°¸ê³ : ì •í™•í•œ í‘œëŠ” ìˆ˜ë°± ì¤„ì´ë¯€ë¡œ, í†µìƒì ìœ¼ë¡œ ì“°ì´ëŠ” ê·¼ì‚¬ ê³µì‹ì„ ì ìš©í•©ë‹ˆë‹¤.
        // 1ì¸ ê°€êµ¬ ê¸°ì¤€ ê³µì œ ì²´ê° ë°˜ì˜
        if(income < 1500000) {
             tax = (income - 1060000) * 0.027; // ì €ì†Œë“ êµ¬ê°„ ì´ˆì €ì„¸ìœ¨
        } else if (income < 2000000) {
             tax = 8500 + (income - 1500000) * 0.045;
        } else {
             tax = 31000 + (income - 2000000) * 0.05; // 200~300êµ¬ê°„
        }
    } 
    else if (income <= 4000000) {
         tax = 84850 + (income - 3000000) * 0.09; // 300ì´ˆê³¼ ëˆ„ì§„
    }
    else {
         // 400 ì´ˆê³¼ ê³ ì†Œë“ êµ¬ê°„ (ì•½ì‹)
         tax = 174850 + (income - 4000000) * 0.15;
    }

    // 10ì› ë‹¨ìœ„ ì ˆì‚¬ (ì†Œë“ì„¸ë²• ì›ì¹™)
    return Math.floor(tax / 10) * 10;
}

  // [ì‹ ê·œ] ì—°ë„ë³„ ìš”ìœ¨ ì¡°íšŒ í•¨ìˆ˜ (í…Œì´ë¸” ì´ì›í™” ëŒ€ì‘)
async function getTaxRates(year) {
    const currentYear = new Date().getFullYear();
    const targetYear = Number(year) || currentYear;
    
    let data, error;

    // 1. ê³¼ê±° ë°ì´í„°ì¸ì§€ í™•ì¸ (ì˜¬í•´ë³´ë‹¤ ì‘ìœ¼ë©´ íˆìŠ¤í† ë¦¬ í…Œì´ë¸” ì¡°íšŒ)
    if (targetYear < currentYear) {
        console.log(`[ì‹œìŠ¤í…œ] ${targetYear}ë…„ë„(ê³¼ê±°) ìš”ìœ¨ì„ íˆìŠ¤í† ë¦¬ í…Œì´ë¸”ì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤.`);
        const response = await _supabase
            .from('ref_settings_history')
            .select('item_key, item_value')
            .eq('target_year', targetYear);
        data = response.data;
        error = response.error;
    } 
    // 2. í˜„ì¬ ë˜ëŠ” ë¯¸ë˜ ë°ì´í„°ë¼ë©´ (ì›ë³¸ í…Œì´ë¸” ì¡°íšŒ)
    else {
        console.log(`[ì‹œìŠ¤í…œ] ${targetYear}ë…„ë„(í˜„ì¬) ìš”ìœ¨ì„ ì›ë³¸ í…Œì´ë¸”ì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤.`);
        const response = await _supabase
            .from('ref_settings')
            .select('item_key, item_value');
        data = response.data;
        error = response.error;
    }

    if (error) {
        console.error("DB ì¡°íšŒ ì˜¤ë¥˜:", error);
        return null;
    }

    if (!data || data.length === 0) {
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì•Œë¦¼ì„ ë„ìš°ì§€ ì•Šê³  null ë°˜í™˜ (ê¸°ë³¸ê°’ ì‚¬ìš© ìœ ë„)
        console.warn(`[ì£¼ì˜] ${targetYear}ë…„ë„ ìš”ìœ¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        return null;
    }

    // ê°ì²´ë¡œ ë³€í™˜ { pension_rate_emp: 0.045, ... }
    const rates = {};
    data.forEach(row => {
        rates[row.item_key] = row.item_value;
    });

    return rates;
}
</script>
</body>
</html>
