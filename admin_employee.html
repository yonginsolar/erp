<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì„ì§ì› ê´€ë¦¬ v2.7 (ìµœì¢…)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; padding: 20px; }
    .main-card { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .btn-rounded { border-radius: 50px; }
    .table-hover tbody tr { cursor: pointer; transition: background 0.2s; }
    .table-hover tbody tr:hover { background-color: #f8f9fa; transform: scale(1.002); }
    .nav-tabs .nav-link { color: #666; cursor: pointer; border:none; padding: 12px 20px; font-weight: 600; }
    .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
    .modal-content { border-radius: 16px; border: none; box-shadow: 0 15px 50px rgba(0,0,0,0.1); }
    .form-control, .form-select { border-radius: 8px; padding: 10px; font-size: 0.95rem; }
    .d-none { display: none !important; }
    .section-title { font-size: 0.95rem; font-weight: bold; color: #495057; margin-bottom: 12px; border-left: 4px solid #0d6efd; padding-left: 10px; }
    .info-card { background: #f8f9fa; padding: 20px; border-radius: 12px; height: 100%; position: relative; }
    .view-mode { display: block; } .edit-mode { display: none; }
    .is-editing .view-mode { display: none; } .is-editing .edit-mode { display: block; }
    .adv-table { font-size: 0.85rem; } .adv-table input { border: none; background: #fff; padding: 2px 5px; width: 100%; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>

<div class="main-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div><h4 class="fw-bold m-0">ğŸ‘¥ ì„ì§ì› ê´€ë¦¬</h4><small class="text-muted">ì§ì› ì •ë³´ ë° ê¸‰ì—¬/ê·¼íƒœ í†µí•© ê´€ë¦¬</small></div>
    <div>
      <button class="btn btn-light btn-sm btn-rounded me-1" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
      <button class="btn btn-outline-secondary btn-sm btn-rounded me-1" onclick="openSettings()">âš™ï¸ ì„¤ì • ê´€ë¦¬</button>
      <button class="btn btn-outline-dark btn-sm btn-rounded me-1" onclick="openLedgerModal()">ğŸ“Š ê¸‰ì—¬ëŒ€ì¥</button>
      <button class="btn btn-primary btn-sm btn-rounded shadow-sm" onclick="openInviteModal()">âœ¨ ì‹ ê·œ ë“±ë¡</button>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle" style="font-size: 0.95rem;">
      <thead class="table-light text-secondary small"><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„ / ë¶€ì„œ</th><th>ì§ê¸‰</th><th>ìƒíƒœ</th><th>ì‹œìŠ¤í…œ ê¶Œí•œ</th></tr></thead>
      <tbody id="empListBody"><tr><td colspan="5" class="text-center p-4 text-muted">ë¡œë”© ì¤‘... â³</td></tr></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">âš™ï¸ ì‹œìŠ¤í…œ í†µí•© ì„¤ì •</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-tabs mb-3" id="settingTab" role="tablist"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#setTax">ğŸ“Š ì£¼ìš” ìš”ìœ¨/ë¹„ê³¼ì„¸</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#setCompany">ğŸ¢ íšŒì‚¬ ì •ë³´</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#setAdvanced" onclick="loadAdvancedSettings()">âš™ï¸ ê³ ê¸‰ ì„¤ì • (ì „ì²´)</a></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="setTax"><h6 class="fw-bold text-primary small border-bottom pb-1 mb-2">4ëŒ€ë³´í—˜ ì´ ìš”ìœ¨ (ìë™ 50:50 ë¶„í• )</h6><div class="row g-2 mb-3"><div class="col-6"><label class="small text-muted">êµ­ë¯¼ì—°ê¸ˆ ì´í•© (%)</label><input type="number" id="set_pension_total" class="form-control form-control-sm" step="0.01" oninput="calcHalf('pension')"><div class="x-small text-secondary mt-1">ì¸ë‹¹: <span id="half_pension">0</span>%</div></div><div class="col-6"><label class="small text-muted">ê±´ê°•ë³´í—˜ ì´í•© (%)</label><input type="number" id="set_health_total" class="form-control form-control-sm" step="0.01" oninput="calcHalf('health')"><div class="x-small text-secondary mt-1">ì¸ë‹¹: <span id="half_health">0</span>%</div></div></div><h6 class="fw-bold text-success small border-bottom pb-1 mb-2">ë¹„ê³¼ì„¸ í•œë„ ì„¤ì •</h6><div class="row g-2 mb-3"><div class="col-4"><label class="small text-muted">ì‹ëŒ€ë¹„ê³¼ì„¸</label><input type="number" id="set_meal" class="form-control form-control-sm"></div><div class="col-4"><label class="small text-muted">ì°¨ëŸ‰ë¹„ê³¼ì„¸</label><input type="number" id="set_car" class="form-control form-control-sm"></div><div class="col-4"><label class="small text-muted">ìœ¡ì•„ë¹„ê³¼ì„¸</label><input type="number" id="set_child" class="form-control form-control-sm"></div></div></div><div class="tab-pane fade" id="setCompany"><div class="row g-2"><div class="col-12"><label class="small text-muted">ë²•ì¸ëª…(ì¡°í•©ëª…)</label><input type="text" id="set_orgName" class="form-control form-control-sm"></div><div class="col-12"><label class="small text-muted">ì´ì‚¬ì¥ëª…(ì´ì‚¬ì¥)</label><input type="text" id="set_ceoName" class="form-control form-control-sm"></div><div class="col-12"><label class="small text-muted">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><input type="text" id="set_bizNum" class="form-control form-control-sm"></div><div class="col-12"><label class="small text-muted">íšŒì‚¬ ì£¼ì†Œ</label><input type="text" id="set_address" class="form-control form-control-sm"></div></div></div><div class="tab-pane fade" id="setAdvanced"><div class="table-responsive" style="max-height: 300px;"><table class="table table-sm adv-table align-middle"><thead class="table-light"><tr><th>í•­ëª© í‚¤</th><th style="width: 120px;">ê°’</th><th>ì„¤ëª…</th></tr></thead><tbody id="advSettingsBody"></tbody></table></div></div></div></div><div class="modal-footer p-2 border-0"><button class="btn btn-primary w-100 btn-rounded" onclick="saveSettings()">ì„¤ì • í†µí•© ì €ì¥</button></div></div></div></div>
<div class="modal fade" id="inviteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold">âœ¨ ì§ì› ì‹ ê·œ ë“±ë¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-light border text-center small mb-3">ğŸ†” ì‚¬ì›ë²ˆí˜¸ëŠ” ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div><label class="small text-muted ms-1">ì´ë¦„</label><input type="text" id="newName" class="form-control mb-2" placeholder="í™ê¸¸ë™"><label class="small text-muted ms-1">ì´ë©”ì¼</label><input type="email" id="newEmail" class="form-control mb-2" placeholder="user@gmail.com"><div class="row g-2 mb-2"><div class="col"><label class="small text-muted ms-1">ì§ê¸‰</label><select id="newRank" class="form-select"><option>ì‚¬ì›</option><option>ëŒ€ë¦¬</option><option>ê³¼ì¥</option><option>ì°¨ì¥</option><option>ë¶€ì¥</option><option>ì´ì‚¬</option><option>êµ­ì¥</option><option>ì´ì‚¬ì¥</option></select></div><div class="col"><label class="small text-muted ms-1">ê¶Œí•œ</label><select id="newRole" class="form-select"><option value="staff">ì¼ë°˜ (Staff)</option><option value="admin">ê´€ë¦¬ì (Admin)</option></select></div></div><div class="mb-3"><label class="small text-muted ms-1">ë¶€ì„œ</label><input type="text" id="newDept" class="form-control" placeholder="ê¸°íšíŒ€"></div><button class="btn btn-primary w-100 btn-rounded py-2" onclick="runInvite()">ë“±ë¡í•˜ê¸°</button></div></div></div></div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-start">
        <div><h5 class="modal-title fw-bold" id="detailName"></h5><span class="text-muted small" id="detailId"></span></div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"> 
        <div class="px-2 pt-2">
          <ul class="nav nav-tabs mb-3" id="empTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabInfo">ğŸ“ ì •ë³´ & ê³„ì•½</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabSalary">ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabLog">ğŸ“… ê·¼íƒœ/í¬ìƒ</a></li>
          </ul>
        </div>
        <div class="tab-content pt-2">
          <div class="tab-pane fade show active" id="tabInfo">
            <div id="infoContainer">
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-primary view-mode" onclick="toggleEditMode(true)">âœï¸ ì •ë³´ ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-secondary edit-mode me-2" onclick="toggleEditMode(false)">ì·¨ì†Œ</button>
                    <button class="btn btn-sm btn-primary edit-mode" onclick="saveBasicInfo()">ì €ì¥ ì™„ë£Œ</button>
                </div>
                <div class="row g-3">
                    <div class="col-12"><div class="info-card"><div class="section-title">ğŸ‘¤ ê¸°ë³¸ ì¸ì ì‚¬í•­</div><div class="row g-3">
                        <div class="col-md-4"><label class="small text-muted">ì´ë¦„</label><div class="view-mode fw-bold" id="viewName">-</div><input type="text" id="editName" class="form-control edit-mode"></div>
                        <div class="col-md-4"><label class="small text-muted">ì „í™”ë²ˆí˜¸</label><div class="view-mode fw-bold" id="viewPhone">-</div><input type="text" id="editPhone" class="form-control edit-mode" placeholder="010-0000-0000" maxlength="13" oninput="autoHyphen(this)"></div>
                        <div class="col-md-4"><label class="small text-muted">ì´ë©”ì¼</label><div class="view-mode fw-bold" id="viewEmail">-</div><input type="email" id="editEmail" class="form-control edit-mode"></div>
                        <div class="col-12"><label class="small text-muted">ì£¼ì†Œ</label><div class="view-mode fw-bold" id="viewAddress">-</div>
                            <div class="edit-mode"><div class="input-group mb-1"><input type="text" id="editAddress" class="form-control" placeholder="ê¸°ë³¸ ì£¼ì†Œ (ê²€ìƒ‰)" onclick="openAddressSearch()" readonly><button class="btn btn-outline-secondary" type="button" onclick="openAddressSearch()">ğŸ” ì£¼ì†Œ ê²€ìƒ‰</button></div><input type="text" id="editAddressDetail" class="form-control" placeholder="ìƒì„¸ì£¼ì†Œ"></div>
                        </div>
                        <div class="col-md-6"><label class="small text-muted">ì…ì‚¬ì¼</label><div class="view-mode fw-bold" id="viewHireDate">-</div><input type="date" id="editHireDate" class="form-control edit-mode"></div>
                    </div></div></div>
                    <div class="col-md-6"><div class="info-card"><div class="section-title">ğŸ‚ ìƒë…„ì›”ì¼</div>
                        <div class="view-mode"><div class="d-flex align-items-center gap-2"><span class="fs-4 fw-bold text-dark" id="viewBirth">ë¯¸ë“±ë¡</span></div><div class="small text-muted mt-2">* ì£¼ë¯¼ë²ˆí˜¸ ë’·ìë¦¬ ìˆ¨ê¹€</div></div>
                        <div class="edit-mode"><label class="small text-muted mb-1">ì£¼ë¯¼ë²ˆí˜¸ (ì „ì²´ ì…ë ¥)</label><div class="d-flex align-items-center gap-2 mb-2"><input type="text" id="rrnFront" class="form-control text-center" maxlength="6" placeholder="ìƒë…„ì›”ì¼"><span class="fw-bold text-muted">-</span><input type="password" id="rrnBack" class="form-control text-center" maxlength="7" placeholder="ë’¤ 7ìë¦¬"></div><button class="btn btn-outline-dark btn-sm w-100" onclick="saveRRN()">ğŸ”’ ì•”í˜¸í™” ì €ì¥</button></div>
                    </div></div>
                    <div class="col-md-6"><div class="info-card"><div class="section-title">ğŸ’° ì—°ë´‰ ê³„ì•½</div>
                        <div class="view-mode"><label class="small text-muted">í˜„ì¬ ì—°ë´‰</label><div class="d-flex align-items-center gap-2"><span class="fs-5 fw-bold" id="viewSalary">******</span><i class="bi bi-eye text-primary cursor-pointer" onclick="toggleSalaryVisibility()"></i></div><div class="mt-2"><label class="small text-muted">ì ìš© ì‹œì‘ì¼: </label><span class="fw-bold" id="viewSalaryDate">-</span></div></div>
                        <div class="edit-mode"><div class="mb-2"><label class="small text-muted">ì—°ë´‰ ì´ì•¡ (ì›)</label><input type="number" id="editSalary" class="form-control fw-bold"></div><div class="mb-2"><label class="small text-muted">ì ìš© ì‹œì‘ì¼</label><input type="date" id="salaryApplyDate" class="form-control"></div></div>
                    </div></div>
                    <div class="col-12"><div class="row g-2">
                        <div class="col-md-6"><div class="info-card" style="background: white; border: 1px solid #dee2e6;"><div class="section-title mb-2">ğŸ“„ ê·¼ë¡œê³„ì•½ì„œ</div><div id="contractView" class="mb-2"></div>
                          <input type="hidden" id="hiddenContractUrl" value="">
                          <div class="edit-mode border-top pt-2"><label class="small text-muted">íŒŒì¼ ì—…ë°ì´íŠ¸</label><div class="d-flex gap-2"><input type="file" id="contractFile" class="form-control form-control-sm" accept=".pdf,.jpg,.png,.jpeg"><button class="btn btn-dark btn-sm text-nowrap" style="min-width: 80px;" onclick="uploadContract()">ì—…ë¡œë“œ</button></div></div></div></div>
                        <div class="col-md-6"><div class="info-card" style="background: white; border: 1px solid #dee2e6;"><div class="section-title mb-2">ğŸ–¨ï¸ ë¬¸ì„œ ë°œê¸‰</div><div class="d-flex flex-column gap-2"><button class="btn btn-outline-dark w-100" onclick="openAdminCertModal()">ğŸ“„ ì¬ì§ì¦ëª…ì„œ ë°œê¸‰</button><div class="small text-muted text-center">* í‡´ì‚¬ìëŠ” ê²½ë ¥ì¦ëª…ì„œë¡œ ì¶œë ¥ë¨</div></div></div></div>
                    </div></div>
                    <div class="col-12 mt-2 pt-2 border-top d-flex justify-content-end gap-2" id="btnResignArea"></div>
                </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tabSalary">
            <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3"><span class="small">ğŸ“¢ ì—°ë´‰ ê¸°ì¤€ <strong>ìë™ ê³„ì‚°</strong> (ê·€ì†ì›” ê¸°ì¤€)</span><span class="badge bg-secondary" id="salaryStatusBadge">ì¡°íšŒ ì¤‘...</span></div>
            <div class="d-flex align-items-center mb-3">
                <label class="me-2 fw-bold small">ê·€ì†ì›”</label>
                <input type="month" id="salaryMonth" class="form-control form-control-sm w-auto me-2" onchange="loadSalaryData()">
                <button class="btn btn-sm btn-outline-dark" onclick="printSalaryAdmin()">ğŸ–¨ï¸ ëª…ì„¸ì„œ ì¸ì‡„</button>
            </div>
            <div class="info-card border mb-3"><div class="row g-2 align-items-end"><div class="col-12"><label class="small fw-bold text-primary">ğŸ’° ì›” ì§€ê¸‰ ì´ì•¡ (ì—°ë´‰ Ã· 12)</label><input type="number" id="payTotalFixed" class="form-control fw-bold fs-5 bg-white" oninput="recalcSalaryComponents()"><div class="form-text x-small">ì´ ê¸ˆì•¡ì„ ê¸°ì¤€ìœ¼ë¡œ ê¸°ë³¸ê¸‰ê³¼ ìˆ˜ë‹¹ì„ ë‚˜ëˆ•ë‹ˆë‹¤.</div></div></div></div>
            <div class="row g-2">
                <div class="col-4"><label class="small text-muted">ì‹ëŒ€ (ë¹„ê³¼ì„¸)</label><input type="number" id="payMeal" class="form-control" value="0" oninput="recalcSalaryComponents()"></div>
                <div class="col-4"><label class="small text-muted">ì°¨ëŸ‰ìœ ì§€ë¹„</label><input type="number" id="payCar" class="form-control" value="0" oninput="recalcSalaryComponents()"></div>
                <div class="col-4"><label class="small text-muted">ìœ¡ì•„ìˆ˜ë‹¹</label><input type="number" id="payChild" class="form-control" value="0" oninput="recalcSalaryComponents()"></div>
                <div class="col-6"><label class="small text-muted">ê¸°ë³¸ê¸‰ (ìë™ê³„ì‚°)</label><input type="number" id="payBasic" class="form-control bg-light" readonly></div>
                <div class="col-6"><label class="small text-muted">ìƒì—¬/ì„±ê³¼ê¸‰ (ë³„ë„)</label><input type="number" id="payBonus" class="form-control" value="0"></div>
            </div>
            <button id="btnSaveSalary" class="btn btn-success w-100 mt-3 btn-rounded" onclick="saveSalary()">ğŸ’¾ ê¸‰ì—¬ í™•ì • ë° ì €ì¥</button>
          </div>
          <div class="tab-pane fade" id="tabLog">
            <div class="card bg-light border-0 p-3 mb-3 text-center"><small class="text-muted">í˜„ì¬ ì”ì—¬ ì—°ì°¨</small><h3 class="fw-bold text-primary m-0" id="displayLeaveRemain">0ì¼</h3></div>
            <div class="mb-2"><label class="small text-muted">êµ¬ë¶„</label><select id="logType" class="form-select"><option value="ì§€ê¸‰">ğŸ ì§€ê¸‰ (í¬ìƒ ë“±)</option><option value="ì°¨ê°">âš ï¸ ì°¨ê° (ì§•ê³„ ë“±)</option></select></div>
            <div class="mb-2"><label class="small text-muted">ì¼ìˆ˜</label><input type="number" id="logValue" class="form-control" placeholder="ì˜ˆ: 1"></div>
            <div class="mb-3"><label class="small text-muted">ì‚¬ìœ </label><input type="text" id="logReason" class="form-control" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div>
            <button class="btn btn-primary w-100 btn-rounded" onclick="saveLog()">âœ… ë°˜ì˜í•˜ê¸°</button>
          </div>
        </div> 
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body text-center py-4"><p class="mb-0 fw-bold" id="alertBody"></p></div><div class="modal-footer justify-content-center p-1 border-0"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">í™•ì¸</h6></div><div class="modal-body text-center py-3" id="confirmBody"></div><div class="modal-footer justify-content-center border-0 pt-0"><button type="button" class="btn btn-secondary btn-sm me-2" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="button" class="btn btn-danger btn-sm" id="btnConfirmYes">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content text-center p-4"><div class="spinner-border text-primary mb-3"></div><h6 class="mb-0">ì²˜ë¦¬ ì¤‘...</h6></div></div></div>
<div class="modal fade" id="resignModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">â›” í‡´ì‚¬ ì²˜ë¦¬</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">í‡´ì‚¬ì¼ì (ë§ˆì§€ë§‰ ê·¼ë¬´ì¼)</label><input type="date" id="inputResignDate" class="form-control"></div><div class="modal-footer p-1 border-0 justify-content-center"><button class="btn btn-danger btn-sm w-100" onclick="confirmResign()">í‡´ì‚¬ í™•ì •</button></div></div></div></div>
<div class="modal fade" id="adminCertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">ğŸ“„ ì¬ì§ì¦ëª…ì„œ ë°œê¸‰</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">ë°œê¸‰ ìš©ë„</label><select id="adminCertPurpose" class="form-select form-select-sm" onchange="toggleAdminEtc()"><option value="ê´€ê³µì„œ ì œì¶œìš©">ê´€ê³µì„œ ì œì¶œìš©</option><option value="ê¸ˆìœµê¸°ê´€ ì œì¶œìš©">ê¸ˆìœµê¸°ê´€ ì œì¶œìš©</option><option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option></select><input type="text" id="adminCertEtc" class="form-control form-control-sm mt-2" placeholder="ì§ì ‘ ì…ë ¥" style="display:none;"></div><div class="modal-footer p-1 border-0 justify-content-center"><button class="btn btn-primary btn-sm w-100" onclick="reqIssueCert()">ë°œê¸‰ ë° ì¸ì‡„</button></div></div></div></div>
<div class="modal fade" id="ledgerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">ğŸ“Š ê¸‰ì—¬ëŒ€ì¥ ì¶œë ¥</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">ëŒ€ìƒ ì—°ì›”</label><input type="month" id="ledgerMonth" class="form-control"></div><div class="modal-footer p-1 border-0 justify-content-center"><button class="btn btn-primary btn-sm w-100" onclick="printLedger()">ëŒ€ì¥ ì¶œë ¥ (A4 ê°€ë¡œ)</button></div></div></div></div>

<script>
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let settings = {}; let companyInfo = {}; let advancedSettingsRaw = [];
let currentEmpId = null, currentEmpName = null, currentAnnualSalary = 0; 
let currentEmpHireDate = null, currentEmpResignDate = null; 
let confirmCallback = null; let currentSalaryDataForPrint = null; 
let alertModal, confirmModal, settingsModal, inviteModal, detailModal, adminCertModal, loadingModal, ledgerModal, resignModal;
let hasCheckedExpired = false;

window.onload = async function() {
    alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));
    detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    adminCertModal = new bootstrap.Modal(document.getElementById('adminCertModal'));
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    ledgerModal = new bootstrap.Modal(document.getElementById('ledgerModal'));
    resignModal = new bootstrap.Modal(document.getElementById('resignModal'));

    document.getElementById("btnConfirmYes").onclick = function() { if(confirmCallback) confirmCallback(); confirmModal.hide(); };
    document.getElementById("salaryMonth").value = new Date().toISOString().slice(0, 7);
    document.getElementById("ledgerMonth").value = new Date().toISOString().slice(0, 7);

    await loadList(); await loadSettings(); await loadCompanyInfo();
};

function showAlert(msg) { document.getElementById("alertBody").innerHTML = msg; alertModal.show(); }
// [ìˆ˜ì •] ì¸ìê°€ 2ê°œ(ë©”ì‹œì§€, ì½œë°±)ì¼ ë•Œì™€ 3ê°œ(ì œëª©, ë©”ì‹œì§€, ì½œë°±)ì¼ ë•Œë¥¼ ëª¨ë‘ ì²˜ë¦¬
function showConfirm(arg1, arg2, arg3) {
    let title = "í™•ì¸";
    let msg = "";
    let cb = null;

    // ì¸ìê°€ 3ê°œ ë“¤ì–´ì™”ì„ ë•Œ (ì œëª©, ë‚´ìš©, í•¨ìˆ˜)
    if (typeof arg3 === 'function') {
        title = arg1;
        msg = arg2;
        cb = arg3;
    } 
    // ì¸ìê°€ 2ê°œ ë“¤ì–´ì™”ì„ ë•Œ (ë‚´ìš©, í•¨ìˆ˜)
    else {
        msg = arg1;
        cb = arg2;
    }

    // ëª¨ë‹¬ ì œëª© ë³€ê²½ (ì œëª© íƒœê·¸ì— IDê°€ ì—†ìœ¼ë¯€ë¡œ í´ë˜ìŠ¤ë¡œ ì°¾ìŒ)
    const titleEl = document.querySelector("#confirmModal .modal-title");
    if(titleEl) titleEl.innerText = title;

    document.getElementById("confirmBody").innerHTML = msg;
    confirmCallback = cb;
    confirmModal.show();
}
  
function showLoading() { loadingModal.show(); }
function hideLoading() { loadingModal.hide(); }
function autoHyphen(target) { target.value = target.value.replace(/[^0-9]/g, '').replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g, "$1-$2-$3").replace(/(\-{1,2})$/g, ""); }
function openAddressSearch() { new daum.Postcode({ oncomplete: function(data) { let addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress; if(data.buildingName) addr += ' (' + data.buildingName + ')'; document.getElementById("editAddress").value = addr; document.getElementById("editAddressDetail").focus(); } }).open(); }

async function loadList() { const tbody = document.getElementById("empListBody"); tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">ë¡œë”© ì¤‘...</td></tr>'; const { data: list, error } = await _supabase.from('ref_employees').select('*').order('emp_id'); if(error || !list) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>'; return; } tbody.innerHTML = ""; const threeYearsAgo = new Date(); threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3); let expiredCount = 0; list.forEach(u => { let isResigned = !!u.resign_date; let isExpired = false; if (isResigned && new Date(u.resign_date) <= threeYearsAgo) { isExpired = true; expiredCount++; } let statusBadge = isResigned ? (isExpired ? `<span class="badge bg-danger">3ë…„ ê²½ê³¼</span>` : `<span class="badge bg-secondary">í‡´ì‚¬</span>`) : `<span class="badge bg-success">ì¬ì§</span>`; let roleBadge = u.role === 'admin' ? '<span class="badge bg-danger">ê´€ë¦¬ì</span>' : '<span class="badge bg-light text-dark">ì¼ë°˜</span>'; const tr = document.createElement("tr"); if(isResigned) tr.style.opacity = "0.7"; if(isExpired) tr.style.backgroundColor = "#fff5f5"; tr.onclick = () => openDetail(u); tr.innerHTML = `<td class="fw-bold text-secondary">${u.emp_id}</td><td><div class="fw-bold">${u.emp_name}</div><div class="small text-muted">${u.department || '-'}</div></td><td>${u.position}</td><td>${statusBadge}</td><td>${roleBadge}</td>`; tbody.appendChild(tr); }); if (expiredCount > 0 && !hasCheckedExpired) { showConfirm(`âš ï¸ <strong>ê°œì¸ì •ë³´ íŒŒê¸° ì•Œë¦¼</strong><br>í‡´ì‚¬ í›„ 3ë…„ ê²½ê³¼ì ${expiredCount}ëª… ë°œê²¬. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => showAlert("ëª©ë¡ì—ì„œ ë¶‰ì€ìƒ‰ ì§ì›ì„ ì‚­ì œí•˜ì„¸ìš”.")); hasCheckedExpired = true; } }
async function loadSettings() { const { data } = await _supabase.from('ref_settings').select('item_key, item_value'); if(data) { settings = {}; data.forEach(r => { settings[r.item_key] = r.item_value; }); } document.getElementById("set_pension_total").value = ((settings['pension_rate_emp']||0.045)*200).toFixed(2); document.getElementById("set_health_total").value = ((settings['health_rate_emp']||0.03545)*200).toFixed(2); calcHalf('pension'); calcHalf('health'); }
async function loadCompanyInfo() { const { data } = await _supabase.from('ref_company_info').select('*'); if(data) data.forEach(r => { companyInfo[r.key] = r.value; }); companyInfo.chairman_name = companyInfo.ceoName || "ì´ì‚¬ì¥"; if (companyInfo.logo_horizontal_url && !companyInfo.logo_horizontal_url.startsWith('http')) { const { data: logoData } = _supabase.storage.from('assets').getPublicUrl(companyInfo.logo_horizontal_url); companyInfo.logo_horizontal_url = logoData.publicUrl; } if (companyInfo.seal_url) { let sealPath = companyInfo.seal_url.startsWith('http') ? companyInfo.seal_url.split('/').pop() : companyInfo.seal_url; const { data: sealData } = await _supabase.storage.from('attachments').createSignedUrl(sealPath, 3600); if (sealData) companyInfo.seal_url = sealData.signedUrl; } }
async function loadAdvancedSettings() { const tbody = document.getElementById("advSettingsBody"); tbody.innerHTML = '<tr><td colspan="3">ë¡œë”©...</td></tr>'; const { data } = await _supabase.from('ref_settings').select('*').order('category'); if(data) { advancedSettingsRaw = data; tbody.innerHTML = data.map((r, i) => `<tr><td><small class="text-muted">${r.item_key}</small></td><td><input type="number" step="0.00001" value="${r.item_value}" id="adv_val_${i}"></td><td><small>${r.description||'-'}</small></td></tr>`).join(""); } }
function openSettings() { document.getElementById("set_pension_total").value = ((settings['pension_rate_emp']||0.045)*200).toFixed(2); document.getElementById("set_health_total").value = ((settings['health_rate_emp']||0.03545)*200).toFixed(2); calcHalf('pension'); calcHalf('health'); document.getElementById("set_meal").value = settings['limit_meal']||200000; document.getElementById("set_car").value = settings['limit_car']||200000; document.getElementById("set_child").value = settings['limit_child']||200000; document.getElementById("set_orgName").value = companyInfo['orgName']||""; document.getElementById("set_ceoName").value = companyInfo['ceoName']||""; document.getElementById("set_bizNum").value = companyInfo['bizNum']||""; document.getElementById("set_address").value = companyInfo['company_address']||""; settingsModal.show(); }
function calcHalf(type) { document.getElementById(`half_${type}`).innerText = (Number(document.getElementById(`set_${type}_total`).value)/2).toFixed(3); }
async function saveSettings() { try { const updates = []; const isAdvanced = document.getElementById("setAdvanced").classList.contains("active"); if(isAdvanced) advancedSettingsRaw.forEach((r, i) => updates.push({ item_key: r.item_key, item_value: Number(document.getElementById(`adv_val_${i}`).value) })); else { const pen = Number(document.getElementById("set_pension_total").value)/200; const hlt = Number(document.getElementById("set_health_total").value)/200; updates.push({ item_key:'pension_rate_emp', item_value: pen }, { item_key:'pension_rate_biz', item_value: pen }, { item_key:'health_rate_emp', item_value: hlt }, { item_key:'health_rate_biz', item_value: hlt }, { item_key:'limit_meal', item_value: Number(document.getElementById("set_meal").value) }, { item_key:'limit_car', item_value: Number(document.getElementById("set_car").value) }, { item_key:'limit_child', item_value: Number(document.getElementById("set_child").value) }); } for(const item of updates) await _supabase.from('ref_settings').upsert(item, { onConflict: 'item_key' }); const org = document.getElementById("set_orgName").value; const ceo = document.getElementById("set_ceoName").value; const cUpdates = [{key:'orgName',value:org}, {key:'company_name',value:org}, {key:'ceoName',value:ceo}, {key:'chairman_name',value:ceo}, {key:'bizNum',value:document.getElementById("set_bizNum").value}, {key:'company_address',value:document.getElementById("set_address").value}]; for(const item of cUpdates) await _supabase.from('ref_company_info').upsert(item, { onConflict: 'key' }); await loadSettings(); await loadCompanyInfo(); settingsModal.hide(); showAlert("ì €ì¥ ì™„ë£Œ"); } catch(e) { showAlert("ì˜¤ë¥˜: "+e.message); } }
function openInviteModal() { inviteModal.show(); }
async function runInvite() { const name = document.getElementById("newName").value; const email = document.getElementById("newEmail").value; if(!name || !email) return showAlert("ì´ë¦„/ì´ë©”ì¼ ì…ë ¥ í•„ìš”"); const year = new Date().getFullYear(); const { count } = await _supabase.from('ref_employees').select('*', {count:'exact', head:true}).like('emp_id', `${year}%`); const empId = `${year}${String((count||0)+1).padStart(3,'0')}`; const { error } = await _supabase.from('ref_employees').insert({ emp_id: empId, emp_name: name, email: email, position: document.getElementById("newRank").value, role: document.getElementById("newRole").value, department: document.getElementById("newDept").value, hire_date: new Date().toISOString().slice(0,10) }); if(error) showAlert("ì˜¤ë¥˜: "+error.message); else { showAlert(`ë“±ë¡ë¨: ${empId}`); inviteModal.hide(); loadList(); } }

async function openDetail(u) {
    currentEmpId = u.emp_id; currentEmpName = u.emp_name; 
    currentAnnualSalary = u.base_salary || 0;
    currentEmpHireDate = u.hire_date;
    currentEmpResignDate = u.resign_date;

    document.getElementById("detailName").innerText = u.emp_name; document.getElementById("detailId").innerText = u.emp_id;
    document.getElementById("viewName").innerText = u.emp_name; document.getElementById("viewPhone").innerText = u.phone || "-"; document.getElementById("viewEmail").innerText = u.email || "-"; document.getElementById("viewAddress").innerText = u.address || "-"; document.getElementById("viewHireDate").innerText = u.hire_date || "-";
    document.getElementById("editName").value = u.emp_name; document.getElementById("editPhone").value = u.phone || ""; document.getElementById("editEmail").value = u.email || ""; 
    document.getElementById("editAddress").value = u.address || ""; document.getElementById("editAddressDetail").value = ""; 
    document.getElementById("editHireDate").value = u.hire_date || "";
    document.getElementById("viewSalary").innerText = "******"; document.getElementById("viewSalary").dataset.real = (u.base_salary||0).toLocaleString() + " ì›";
    document.getElementById("viewSalaryDate").innerText = u.salary_apply_date || "-"; document.getElementById("editSalary").value = u.base_salary || 0; document.getElementById("salaryApplyDate").value = u.salary_apply_date || "";

    const { data: birthDate } = await _supabase.rpc('get_emp_birthdate', { p_emp_id: u.emp_id });
    document.getElementById("viewBirth").innerText = birthDate || "ë¯¸ë“±ë¡";
    
    toggleEditMode(false);
    document.getElementById("rrnFront").value = ""; document.getElementById("rrnBack").value = "";
    
    const viewDiv = document.getElementById("contractView"); viewDiv.innerHTML = 'ë¡œë”©...'; document.getElementById("hiddenContractUrl").value = u.contract_url || "";
    if(u.contract_url) { try { const { data } = await _supabase.storage.from('contracts').createSignedUrl(u.contract_url, 3600); viewDiv.innerHTML = data ? `<a href="${data.signedUrl}" target="_blank" class="btn btn-sm btn-info w-100 text-white fw-bold">ğŸ“„ ê³„ì•½ì„œ ë³´ê¸°</a>` : `<span class="text-danger small">ì‹¤íŒ¨</span>`; } catch(e) { viewDiv.innerHTML = "-"; } } else viewDiv.innerHTML = `<span class="text-muted small">ë¯¸ë“±ë¡</span>`;

    const area = document.getElementById("btnResignArea");
    if(u.resign_date) area.innerHTML = `<button class="btn btn-sm btn-warning" onclick="cancelResign()">â†©ï¸ í‡´ì‚¬ ì·¨ì†Œ</button><button class="btn btn-sm btn-danger ms-2" onclick="reqDeletePermanent()">ğŸ—‘ï¸ ì‚­ì œ</button>`;
    else { area.innerHTML = `<button class="btn btn-sm btn-outline-danger" onclick="doResign()">â›” í‡´ì‚¬ ì²˜ë¦¬</button>`; loadSalaryData(); loadLeave(); }
    detailModal.show();
}

function toggleEditMode(isEdit) { const c = document.getElementById("infoContainer"); if(isEdit) c.classList.add("is-editing"); else c.classList.remove("is-editing"); }
function toggleSalaryVisibility() { const el = document.getElementById("viewSalary"); el.innerText = el.innerText === "******" ? el.dataset.real : "******"; }

async function saveBasicInfo() { 
    const name = document.getElementById("editName").value; const phone = document.getElementById("editPhone").value; const email = document.getElementById("editEmail").value; 
    let fullAddress = document.getElementById("editAddress").value; const detail = document.getElementById("editAddressDetail").value; if(detail) fullAddress += " " + detail;
    const hireDate = document.getElementById("editHireDate").value; const sal = Number(document.getElementById("editSalary").value); const date = document.getElementById("salaryApplyDate").value; 
    const updates = { emp_name: name, phone: phone, email: email, address: fullAddress, hire_date: hireDate, base_salary: sal, salary_apply_date: date }; 
    const { error } = await _supabase.from('ref_employees').update(updates).eq('emp_id', currentEmpId); 
    if(error) return showAlert("ì €ì¥ ì‹¤íŒ¨: " + error.message); 
    if (sal !== currentAnnualSalary) { await _supabase.from('hr_salary_contracts').insert({ emp_id: currentEmpId, amount: sal, apply_date: date }); } 
    currentAnnualSalary = sal; currentEmpHireDate = hireDate;
    document.getElementById("viewName").innerText = name; document.getElementById("viewPhone").innerText = phone; document.getElementById("viewEmail").innerText = email; document.getElementById("viewAddress").innerText = fullAddress; document.getElementById("viewHireDate").innerText = hireDate; document.getElementById("viewSalary").dataset.real = sal.toLocaleString() + " ì›"; document.getElementById("viewSalaryDate").innerText = date; 
    toggleEditMode(false); showAlert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
}

async function saveRRN() { const f = document.getElementById("rrnFront").value; const b = document.getElementById("rrnBack").value; if((f+b).length !== 13) return showAlert("13ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); const { error } = await _supabase.rpc('update_employee_rrn', { p_emp_id: currentEmpId, p_rrn: f+"-"+b }); if(error) showAlert("ì‹¤íŒ¨: "+error.message); else { showAlert("ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); const { data: bd } = await _supabase.rpc('get_emp_birthdate', { p_emp_id: currentEmpId }); document.getElementById("viewBirth").innerText = bd || f; document.getElementById("rrnFront").value=""; document.getElementById("rrnBack").value=""; toggleEditMode(false); } }
async function uploadContract() { const fileInput = document.getElementById("contractFile"); if (fileInput.files.length === 0) return showAlert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); const file = fileInput.files[0]; const fileName = `${currentEmpId}_contract_${Date.now()}.${file.name.split('.').pop()}`; showLoading(); try { const { data: emp } = await _supabase.from('ref_employees').select('contract_url').eq('emp_id', currentEmpId).single(); if (emp?.contract_url && !emp.contract_url.startsWith('http')) await _supabase.storage.from('contracts').remove([emp.contract_url]); const { data, error } = await _supabase.storage.from('contracts').upload(fileName, file, { upsert: true }); if (error) throw error; await _supabase.from('ref_employees').update({ contract_url: data.path }).eq('emp_id', currentEmpId); hideLoading(); setTimeout(async () => { showAlert("ê³„ì•½ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); const { data: signed } = await _supabase.storage.from('contracts').createSignedUrl(data.path, 3600); document.getElementById("contractView").innerHTML = `<a href="${signed.signedUrl}" target="_blank" class="btn btn-sm btn-info w-100 text-white fw-bold">ğŸ“„ ê³„ì•½ì„œ ë³´ê¸°</a>`; document.getElementById("hiddenContractUrl").value = data.path; fileInput.value = ""; }, 500); } catch (err) { hideLoading(); setTimeout(() => showAlert("ì˜¤ë¥˜ ë°œìƒ: " + err.message), 500); } }

async function reqDeletePermanent() { showConfirm("âš ï¸ ì˜êµ¬ ì‚­ì œ ê²½ê³ ", `<strong>${currentEmpName}</strong> ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async function() { detailModal.hide(); const filePath = document.getElementById("hiddenContractUrl").value; if (filePath && !filePath.startsWith('http')) await _supabase.storage.from('contracts').remove([filePath]); await _supabase.from('hr_salary').delete().eq('emp_id', currentEmpId); await _supabase.from('hr_leave_adj').delete().eq('emp_id', currentEmpId); await _supabase.from('hr_salary_contracts').delete().eq('emp_id', currentEmpId); await _supabase.from('log_cert').delete().eq('emp_id', currentEmpId); await _supabase.from('ref_employees').delete().eq('emp_id', currentEmpId); showAlert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadList(); }); }
function doResign() { document.getElementById("inputResignDate").value = new Date().toISOString().slice(0, 10); resignModal.show(); }
async function confirmResign() { const rDate = document.getElementById("inputResignDate").value; if(!rDate) return showAlert("í‡´ì‚¬ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); resignModal.hide(); await _supabase.from('ref_employees').update({ resign_date: rDate }).eq('emp_id', currentEmpId); detailModal.hide(); loadList(); showAlert("í‡´ì‚¬ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }
async function cancelResign() { showConfirm("í‡´ì‚¬ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => { await _supabase.from('ref_employees').update({ resign_date: null }).eq('emp_id', currentEmpId); detailModal.hide(); loadList(); }); }

async function loadSalaryData() {
    const month = document.getElementById("salaryMonth").value; const badge = document.getElementById("salaryStatusBadge"); badge.innerText = "ì¡°íšŒ ì¤‘...";
    const { data: saved } = await _supabase.from('hr_salary').select('*').eq('emp_id', currentEmpId).eq('year_month', month).single();
    if(saved) {
        document.getElementById("payTotalFixed").value = saved.pay_total || 0;
        document.getElementById("payMeal").value = saved.pay_meal; document.getElementById("payCar").value = saved.pay_car; document.getElementById("payChild").value = saved.pay_child; document.getElementById("payBonus").value = saved.pay_bonus;
        badge.innerText = "ì €ì¥ëœ ë°ì´í„°"; badge.className = "badge bg-success";
        currentSalaryDataForPrint = saved; currentSalaryDataForPrint.year_month = month;
    } else {
        const monthlyTotal = Math.floor(currentAnnualSalary / 12); 
        document.getElementById("payTotalFixed").value = monthlyTotal; 
        document.getElementById("payMeal").value = 0; document.getElementById("payCar").value = 0; document.getElementById("payChild").value = 0; document.getElementById("payBonus").value = 0;
        badge.innerText = "ìë™ ê³„ì‚° (ë¯¸ì €ì¥)"; badge.className = "badge bg-secondary";
        currentSalaryDataForPrint = null;
    }
    recalcSalaryComponents();
}

function recalcSalaryComponents() {
    const total = Number(document.getElementById("payTotalFixed").value) || 0;
    const meal = Number(document.getElementById("payMeal").value) || 0; const car = Number(document.getElementById("payCar").value) || 0; const child = Number(document.getElementById("payChild").value) || 0;
    const basic = total - (meal + car + child);
    document.getElementById("payBasic").value = basic > 0 ? basic : 0;
}

async function saveSalary() {
    const month = document.getElementById("salaryMonth").value; if (!month) return showAlert("ê·€ì†ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    const p_basic = Number(document.getElementById("payBasic").value); const p_meal = Number(document.getElementById("payMeal").value); const p_car = Number(document.getElementById("payCar").value); const p_child = Number(document.getElementById("payChild").value); const p_bonus = Number(document.getElementById("payBonus").value);
    const p_total = p_basic + p_meal + p_car + p_child + p_bonus;
    const tf_meal = Math.min(p_meal, settings['limit_meal']||200000); const tf_car = Math.min(p_car, settings['limit_car']||200000); const tf_child = Math.min(p_child, settings['limit_child']||200000);
    const tax_base = p_total - (tf_meal + tf_car + tf_child);
    const pen = Math.floor(tax_base * (settings['pension_rate_emp']||0.045)); const hlt = Math.floor((tax_base * (settings['health_rate_emp']||0.03545))/10)*10; const care = Math.floor((hlt * (settings['care_rate_ratio']||0.1295))/10)*10; const emp = Math.floor(tax_base * (settings['employ_rate_emp']||0.009));
    let inc = 0, loc = 0; if (tax_base >= 1060000) { inc = Math.floor((tax_base * (settings['income_tax_rate_simple']||0.03))/10)*10; loc = Math.floor((inc * (settings['local_tax_rate_ratio']||0.1))/10)*10; }
    const payload = { emp_id: currentEmpId, emp_name: currentEmpName, year_month: month, pay_basic: p_basic, pay_meal: p_meal, pay_car: p_car, pay_child: p_child, pay_bonus: p_bonus, pay_total: p_total, ded_pension: pen, ded_health: hlt, ded_care: care, ded_employ: emp, ded_income: inc, ded_local: loc, ded_total: pen+hlt+care+emp+inc+loc, net_pay: p_total-(pen+hlt+care+emp+inc+loc) };
    const { data: existing } = await _supabase.from('hr_salary').select('id').eq('emp_id', currentEmpId).eq('year_month', month).single();
    const { error } = existing ? await _supabase.from('hr_salary').update(payload).eq('id', existing.id) : await _supabase.from('hr_salary').insert(payload);
    if (error) showAlert("ì‹¤íŒ¨: "+error.message); else { showAlert("ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); loadSalaryData(); }
}

async function loadLeave() { let generated = 0; const { data: emp } = await _supabase.from('ref_employees').select('hire_date').eq('emp_id', currentEmpId).single(); if(emp?.hire_date) { const join = new Date(emp.hire_date); const now = new Date(); const diffY = now.getFullYear() - join.getFullYear(); generated = diffY < 1 ? (now.getMonth() - join.getMonth()) : 15; } let adjusted = 0; const { data: adjs } = await _supabase.from('hr_leave_adj').select('*').eq('emp_id', currentEmpId); if(adjs) adjs.forEach(a => { if(a.adj_type==='ì§€ê¸‰') adjusted+=Number(a.days); else adjusted-=Number(a.days); }); let used = 0; const { data: apps } = await _supabase.from('ref_approval').select('amount').eq('drafter_id', currentEmpId).eq('doc_type', 'íœ´ê°€').eq('status', 'ì™„ë£Œ'); if(apps) apps.forEach(a => used+=Number(a.amount)); document.getElementById("displayLeaveRemain").innerText = (Math.max(0, generated + adjusted - used)) + "ì¼"; }
async function saveLog() { const type = document.getElementById("logType").value; const val = Number(document.getElementById("logValue").value); const reason = document.getElementById("logReason").value; if(!val || !reason) return showAlert("ì…ë ¥ í•„ìš”"); await _supabase.from('hr_leave_adj').insert({ emp_id: currentEmpId, adj_type: type, days: val, reason: reason }); showAlert("ë°˜ì˜ë¨"); document.getElementById("logValue").value = ""; document.getElementById("logReason").value = ""; loadLeave(); }

function openAdminCertModal() { document.getElementById("adminCertPurpose").value = "ê´€ê³µì„œ ì œì¶œìš©"; toggleAdminEtc(); adminCertModal.show(); }
function toggleAdminEtc() { const v = document.getElementById("adminCertPurpose").value; const e = document.getElementById("adminCertEtc"); if(v==='ê¸°íƒ€') { e.style.display='block'; e.focus(); } else e.style.display='none'; }

async function reqIssueCert() {
    let purpose = document.getElementById("adminCertPurpose").value;
    if(purpose === 'ê¸°íƒ€') purpose = document.getElementById("adminCertEtc").value;
    if(!purpose) return showAlert("ìš©ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    adminCertModal.hide();

    const { data: birthDate } = await _supabase.rpc('get_emp_birthdate', { p_emp_id: currentEmpId });
    const birthStr = birthDate || "ë¯¸ë“±ë¡";
    const thisYear = new Date().getFullYear();
    const { count } = await _supabase.from('log_cert').select('*', { count: 'exact', head: true }).gte('issued_at', `${thisYear}-01-01T00:00:00`);
    const docNum = `ì¸ì‚¬-${thisYear}-${String((count||0) + 1).padStart(3, '0')}`; 
    await _supabase.from('log_cert').insert({ emp_id: currentEmpId, emp_name: currentEmpName, cert_type: 'ì¬ì§ì¦ëª…ì„œ', purpose: purpose, cert_num: docNum });

    const hireDate = document.getElementById("viewHireDate").innerText;
    let tenureStr = "-";
    if(hireDate && hireDate !== '-') {
        const join = new Date(hireDate); const now = new Date(); const diff = now - join; const y = Math.floor(diff / (1000*60*60*24*365)); const m = Math.floor((diff % (1000*60*60*24*365)) / (1000*60*60*24*30)); tenureStr = `${hireDate}~í˜„ì¬ (${y}ë…„ ${m}ê°œì›”)`;
    }
    let cleanAddr = (companyInfo.company_address || "").replace(/ìš©ì¸ëª¨ë‘ì˜\s?í–‡ë¹›í˜‘ë™ì¡°í•©/g, '').trim();
    let dept="", pos=""; const { data: empData } = await _supabase.from('ref_employees').select('department, position').eq('emp_id', currentEmpId).single(); if(empData) { dept = empData.department; pos = empData.position; }

    const compName = companyInfo.company_name || companyInfo.orgName || "ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©";
    const ceoName = companyInfo.chairman_name || companyInfo.ceoName || "ì´ì‚¬ì¥";

    const certData = { type: 'cert', docNum: docNum, logo: companyInfo.logo_horizontal_url || "", name: currentEmpName, birth: birthStr, dept: dept, pos: pos, address: document.getElementById("viewAddress").innerText, tenure: tenureStr, purpose: purpose, today: new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }), chairman: ceoName, compName: compName, compAddr: cleanAddr, contact: companyInfo.company_contact, seal: companyInfo.seal_url };
    printDocument(certData);
}

function printSalaryAdmin() {
    if(!currentSalaryDataForPrint) return showAlert("ì €ì¥ëœ ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
    const d = currentSalaryDataForPrint;
    const [y, m] = d.year_month.split('-');
    
    // ìŠ¤ë§ˆíŠ¸ ê¸°ê°„ ì‚°ì • (ê·€ì†ì›” ê¸°ì¤€, ì…/í‡´ì‚¬ì¼ ê³ ë ¤)
    const getSmartAttribution = (ymStr) => {
        const [yy, mm] = ymStr.split('-').map(Number);
        let startDay = 1;
        let lastDay = new Date(yy, mm, 0).getDate();

        if(currentEmpHireDate) {
            const hDate = new Date(currentEmpHireDate);
            if(hDate.getFullYear() === yy && (hDate.getMonth()+1) === mm) startDay = hDate.getDate();
        }
        if(currentEmpResignDate) {
            const rDate = new Date(currentEmpResignDate);
            if(rDate.getFullYear() === yy && (rDate.getMonth()+1) === mm) lastDay = rDate.getDate();
        }
        return `${yy}ë…„ ${mm}ì›”<br>(${yy}.${String(mm).padStart(2,'0')}.${String(startDay).padStart(2,'0')} ~ ${yy}.${String(mm).padStart(2,'0')}.${lastDay})`;
    };

    // ì§€ê¸‰ì¼: ê·€ì†ì›”ì˜ ë‹¤ìŒ ë‹¬ 10ì¼
    const payDateObj = new Date(y, Number(m), 10); 
    const payDateStr = `${payDateObj.getFullYear()}ë…„ ${payDateObj.getMonth()+1}ì›” ${payDateObj.getDate()}ì¼`;

    const fmt = (n) => (!n || Number(n)===0) ? "" : Number(n).toLocaleString();
    const fmtFix = (n) => Number(n).toLocaleString();
    
    // [ì¤‘ìš”] íšŒì‚¬ëª…/ì´ì‚¬ì¥ undefined ë°©ì§€
    const compName = companyInfo.company_name || companyInfo.orgName || "ìš©ì¸ëª¨ë‘ì˜í–‡ë¹›í˜‘ë™ì¡°í•©";
    const ceoName = companyInfo.chairman_name || companyInfo.ceoName || "ì´ì‚¬ì¥";

    const salaryData = { 
        type: 'salary', 
        titleDate: `${y}ë…„ ${Number(m)}ì›”`, 
        attrDate: getSmartAttribution(d.year_month), 
        payDate: payDateStr, 
        empInfo: `${currentEmpId} / ${currentEmpName}`, 
        dept: "", pos: "", 
        p_basic: fmtFix(d.pay_basic), p_meal: fmtFix(d.pay_meal), p_car: fmtFix(d.pay_car), p_pos: fmt(d.pay_position), p_svc: fmt(d.pay_service), p_ot: fmt(d.pay_overtime), p_child: fmt(d.pay_child), p_bonus: fmt(d.pay_bonus), p_total: fmtFix(d.pay_total), 
        d_pen: fmt(d.ded_pension), d_hlt: fmt(d.ded_health), d_care: fmt(d.ded_care), d_emp: fmt(d.ded_employ), d_inc: fmt(d.ded_income), d_loc: fmt(d.ded_local), d_adv: fmt(d.ded_advance), d_cap: fmt(d.ded_capital), d_total: fmtFix(d.ded_total), 
        net: fmtFix(d.net_pay), 
        logo: companyInfo.logo_horizontal_url || "", 
        seal: companyInfo.seal_url, 
        chairman: ceoName, compName: compName // ë³€ìˆ˜ ì „ë‹¬
    };
    _supabase.from('ref_employees').select('department, position').eq('emp_id', currentEmpId).single().then(({data}) => { if(data) { salaryData.dept = data.department; salaryData.pos = data.position; } printDocument(salaryData); });
}

function openLedgerModal() { ledgerModal.show(); }
async function printLedger() {
    const ym = document.getElementById("ledgerMonth").value; if(!ym) return showAlert("ì—°ì›”ì„ ì„ íƒí•˜ì„¸ìš”."); ledgerModal.hide();
    const { data: list, error } = await _supabase.from('hr_salary').select('*').eq('year_month', ym).order('emp_name');
    if(error || !list || list.length === 0) return showAlert("í•´ë‹¹ ì›”ì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    
    let t = { basic:0, meal:0, car:0, child:0, pos:0, svc:0, ot:0, bonus:0, p_total:0, pen:0, hlt:0, care:0, emp:0, inc:0, loc:0, adv:0, cap:0, d_total:0, net:0 };
    const rowsHtml = list.map((d, i) => {
        t.basic+=d.pay_basic; t.meal+=d.pay_meal; t.car+=d.pay_car; t.child+=d.pay_child; t.pos+=(d.pay_position||0); t.svc+=(d.pay_service||0); t.ot+=(d.pay_overtime||0); t.bonus+=(d.pay_bonus||0); t.p_total+=d.pay_total;
        t.pen+=d.ded_pension; t.hlt+=d.ded_health; t.care+=d.ded_care; t.emp+=d.ded_employ; t.inc+=d.ded_income; t.loc+=d.ded_local; t.adv+=(d.ded_advance||0); t.cap+=(d.ded_capital||0); t.d_total+=d.ded_total; t.net+=d.net_pay;
        // [ìˆ˜ì •] ê³µì œê³„ ì¶”ê°€, ì‹¤ìˆ˜ë ¹ì•¡->ì°¨ì¸ì§€ê¸‰ì•¡
        return `<tr style="height:30px;"><td class="text-center">${i+1}</td><td class="text-center fw-bold">${d.emp_name}</td><td class="text-end">${Number(d.pay_basic).toLocaleString()}</td><td class="text-end">${Number(d.pay_meal).toLocaleString()}</td><td class="text-end">${Number(d.pay_car).toLocaleString()}</td><td class="text-end">${Number(d.pay_child+(d.pay_position||0)+(d.pay_service||0)+(d.pay_overtime||0)).toLocaleString()}</td><td class="text-end">${Number(d.pay_bonus||0).toLocaleString()}</td><td class="text-end bg-light fw-bold">${Number(d.pay_total).toLocaleString()}</td><td class="text-end">${Number(d.ded_pension).toLocaleString()}</td><td class="text-end">${Number(d.ded_health).toLocaleString()}</td><td class="text-end">${Number(d.ded_care).toLocaleString()}</td><td class="text-end">${Number(d.ded_employ).toLocaleString()}</td><td class="text-end">${Number(d.ded_income).toLocaleString()}</td><td class="text-end">${Number(d.ded_local).toLocaleString()}</td><td class="text-end">${Number((d.ded_advance||0)+(d.ded_capital||0)).toLocaleString()}</td><td class="text-end bg-light fw-bold" style="color:#c62828;">${Number(d.ded_total).toLocaleString()}</td><td class="text-end fw-bold" style="background:#e3f2fd;">${Number(d.net_pay).toLocaleString()}</td></tr>`;
    }).join("");
    const totalHtml = `<tr style="background:#eee; font-weight:bold; height:35px;"><td colspan="2" class="text-center">í•© ê³„</td><td class="text-end">${t.basic.toLocaleString()}</td><td class="text-end">${t.meal.toLocaleString()}</td><td class="text-end">${t.car.toLocaleString()}</td><td class="text-end">${(t.child+t.pos+t.svc+t.ot).toLocaleString()}</td><td class="text-end">${t.bonus.toLocaleString()}</td><td class="text-end">${t.p_total.toLocaleString()}</td><td class="text-end">${t.pen.toLocaleString()}</td><td class="text-end">${t.hlt.toLocaleString()}</td><td class="text-end">${t.care.toLocaleString()}</td><td class="text-end">${t.emp.toLocaleString()}</td><td class="text-end">${t.inc.toLocaleString()}</td><td class="text-end">${t.loc.toLocaleString()}</td><td class="text-end">${(t.adv+t.cap).toLocaleString()}</td><td class="text-end" style="color:#c62828;">${t.d_total.toLocaleString()}</td><td class="text-end" style="background:#bbdefb;">${t.net.toLocaleString()}</td></tr>`;

    const [y, m] = ym.split('-');
    const ceoName = companyInfo.chairman_name || companyInfo.ceoName || "ì´ì‚¬ì¥";
    
    const ledgerData = { type: 'ledger', title: `${y}ë…„ ${Number(m)}ì›” ê¸‰ì—¬ëŒ€ì¥`, tableBody: rowsHtml + totalHtml, logo: companyInfo.logo_horizontal_url || "", chairman: ceoName };
    printDocument(ledgerData);
}

function printDocument(data) {
    const win = window.open('', '', 'width=1100,height=900');
    let contentHtml = "";
    
    const commonCss = `
        * { box-sizing: border-box; } 
        body { font-family: "Malgun Gothic", serif; margin: 0; padding: 0; background: #555; }
        .print-fab { position: fixed; bottom: 30px; right: 30px; background: #fff; padding: 10px 15px; border-radius: 30px; z-index: 9999; display: flex; gap: 10px; border:1px solid #ccc; }
        @media print { .no-print { display: none !important; } html, body { margin: 0; background: #fff; } }
    `;

    // 1. [ê°€ë¡œ] ê¸‰ì—¬ëŒ€ì¥ ìŠ¤íƒ€ì¼
    const landscapeCss = `
        @page { size: A4 landscape; margin: 10mm; } 
        .page-wrap { width: 297mm; min-height: 210mm; padding: 15mm; background: white; margin: 20px auto; } 
        table { width: 100%; border-collapse: collapse; font-size: 11px; } 
        th, td { border: 1px solid #999; padding: 4px 6px; } 
        th { background-color: #f5f5f5; text-align: center; font-weight: bold; white-space: nowrap; } 
        .text-center { text-align: center; } .text-end { text-align: right; } .fw-bold { font-weight: bold; } .bg-light { background-color: #f9f9f9; }
    `;

    // 2. [ì„¸ë¡œ] 1ì¥ì§œë¦¬ ëª…ì„¸ì„œ ìŠ¤íƒ€ì¼ (overflow:hidden)
    const portraitCss = `
        @page { size: A4 portrait; margin: 0; }
        .page-wrap { width: 210mm; height: 297mm; min-height: 0; margin: 0 auto; padding: 15mm; background: white; overflow: hidden !important; border: none; box-shadow: none; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #000 !important; }
        img { max-width: 100%; height: auto; }
        .print-salary .print-content { zoom: 0.86; width: 100%; }
        .print-cert .print-content { zoom: 0.98; width: 100%; }
        .text-end { text-align: right; } .fw-bold { font-weight: bold; }
    `;

    if (data.type === 'ledger') {
        contentHtml = `
        <div style="padding: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 20px;">
                ${data.logo ? `<img src="${data.logo}" style="height:40px;">` : '<div></div>'}
                <div style="text-align:center;">
                    <h1 style="margin:0; font-size: 24px; text-decoration: underline;">${data.title}</h1>
                </div>
                <table style="width: 200px; border-collapse: collapse; text-align: center; float: right; margin-bottom: 10px;">
                  <tr><td style="border: 1px solid #000; background: #f0f0f0; font-size: 11px; padding: 2px; width:33%;">ë‹´ë‹¹</td><td style="border: 1px solid #000; background: #f0f0f0; font-size: 11px; padding: 2px; width:33%;">ì‚¬ë¬´êµ­ì¥</td><td style="border: 1px solid #000; background: #f0f0f0; font-size: 11px; padding: 2px; width:33%;">ì´ì‚¬ì¥</td></tr>
                  <tr><td style="border: 1px solid #000; height: 50px;"></td><td style="border: 1px solid #000; height: 50px;"></td><td style="border: 1px solid #000; height: 50px;"></td></tr>
                </table>
            </div>
            <div style="clear:both;"></div>
            <table><thead><tr style="background:#e0e0e0;"><th rowspan="2" style="width:30px;">No</th><th rowspan="2" style="width:70px;">ì„±ëª…</th><th colspan="6">ì§€ ê¸‰ ë‚´ ì—­</th><th colspan="7">ê³µ ì œ ë‚´ ì—­</th><th rowspan="2">ê³µì œê³„</th></tr><tr style="background:#f0f0f0;"><th>ê¸°ë³¸ê¸‰</th><th>ì‹ëŒ€</th><th>ì°¨ëŸ‰</th><th>ê¸°íƒ€ìˆ˜ë‹¹</th><th>ìƒì—¬</th><th style="background:#fff3e0;">ì§€ê¸‰ê³„</th><th>êµ­ë¯¼ì—°ê¸ˆ</th><th>ê±´ê°•ë³´í—˜</th><th>ì¥ê¸°ìš”ì–‘</th><th>ê³ ìš©ë³´í—˜</th><th>ì†Œë“ì„¸</th><th>ì§€ë°©ì„¸</th><th>ê¸°íƒ€ê³µì œ</th><th>ì°¨ì¸ì§€ê¸‰ì•¡</th></tr></thead><tbody>${data.tableBody}</tbody></table>
        </div>`;
    } 
    else if(data.type === 'salary') {
        contentHtml = `
        <div class="print-salary" style="padding: 10px; height: 100%;">
            ${data.logo ? `<img src="${data.logo}" style="position:absolute; left:0px; top:-10px; height:45px;">` : ''}
            <h1 style="text-align:center; margin-bottom: 30px; font-size: 28px; margin-top: 50px;">${data.titleDate} ê¸‰ì—¬ëª…ì„¸ì„œ</h1>
            <table style="width:100%; margin-bottom:20px;">
                <tr><th style="background:#f5f5f5; padding:8px; width:18%;">ê·€ì†ì—°ì›”</th><td style="padding:8px; width:32%;">${data.attrDate}</td><th style="background:#f5f5f5; padding:8px; width:18%;">ì‚¬ì›ë²ˆí˜¸/ëª…</th><td style="padding:8px;">${data.empInfo}</td></tr>
                <tr><th style="background:#f5f5f5; padding:8px;">ì§€ê¸‰ì¼ì</th><td style="padding:8px;">${data.payDate}</td><th style="background:#f5f5f5; padding:8px;">ì†Œì†/ì§ê¸‰</th><td style="padding:8px;">${data.dept} / ${data.pos}</td></tr>
            </table>
            <div style="display:flex; gap:20px; border-top:2px solid #888; padding-top:10px;">
                <div style="flex:1;">
                    <div style="text-align:center; font-weight:bold; padding:5px; border-bottom:2px solid #0d47a1; color:#0d47a1; margin-bottom:5px;">ì§€ê¸‰ë‚´ì—­</div>
                    <table style="width:100%;">
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ê¸°ë³¸ê¸‰</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_basic}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì‹ ëŒ€</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_meal}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì°¨ëŸ‰ìœ ì§€ë¹„</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_car}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì§ì±…ìˆ˜ë‹¹</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_pos}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ê·¼ì†ìˆ˜ë‹¹</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_svc}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì—°ì¥ìˆ˜ë‹¹</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_ot}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ìœ¡ì•„ìˆ˜ë‹¹</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_child}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ìƒì—¬ê¸ˆ</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.p_bonus}</td></tr>
                    </table>
                </div>
                <div style="flex:1;">
                    <div style="text-align:center; font-weight:bold; padding:5px; border-bottom:2px solid #b71c1c; color:#b71c1c; margin-bottom:5px;">ê³µì œë‚´ì—­</div>
                    <table style="width:100%;">
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">êµ­ë¯¼ì—°ê¸ˆ</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_pen}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ê±´ê°•ë³´í—˜</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_hlt}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì¥ê¸°ìš”ì–‘</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_care}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ê³ ìš©ë³´í—˜</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_emp}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì†Œë“ì„¸</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_inc}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì§€ë°©ì†Œë“ì„¸</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_loc}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ê°€ë¶ˆê¸ˆ</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_adv}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee; border:none !important;">ì¶œìê¸ˆ</td><td class="text-end" style="padding:5px; border-bottom:1px solid #eee; border:none !important;">${data.d_cap}</td></tr>
                    </table>
                </div>
            </div>
            <div style="display:flex; margin-top:40px; border-top:2px solid #888; padding-top:20px; align-items:center;">
                <div style="flex:1; font-size:14px; color:#555; padding-left:20px;">ê·€í•˜ì˜ ë…¸ê³ ì— ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.</div>
                <div style="width:300px;">
                    <table style="width:100%;">
                        <tr><th style="background:#f9f9f9; padding:8px;">ì§€ê¸‰í•©ê³„</th><td class="text-end" style="padding:8px; font-weight:bold;">${data.p_total}</td></tr>
                        <tr><th style="background:#f9f9f9; padding:8px;">ê³µì œí•©ê³„</th><td class="text-end" style="padding:8px; font-weight:bold;">${data.d_total}</td></tr>
                        <tr><th style="background:#f0f0f0; padding:8px; border-bottom:2px solid #555;">ì‹¤ì§€ê¸‰ì•¡</th><td class="text-end" style="padding:8px; border-bottom:2px solid #555; font-weight:bold; background:#fff;">${data.net}</td></tr>
                    </table>
                </div>
            </div>
            <div style="margin-top:50px; text-align:center; position:relative;">
                <span style="font-size:18px; font-weight:bold; position:relative; z-index:1;">${data.compName} ì´ì‚¬ì¥ ${data.chairman}</span>
                ${data.seal ? `<img src="${data.seal}" style="position:absolute; margin-left:-50px; top:-20px; width:80px; opacity:0.8; z-index:2;">` : ''}
            </div>
        </div>`;
    } 
    else if(data.type === 'cert') {
        contentHtml = `
        <div class="print-cert" style="padding: 20px; height: 100%; box-sizing: border-box;">
            ${data.logo ? `<img src="${data.logo}" style="position:absolute; left:20px; top:20px; height:45px;">` : ''}
            <div style="text-align:right; font-size:12px; margin-top:20px; margin-bottom:5px;">www.yonginsolar.kr</div>
            <h2 style="text-align:center; font-size: 32px; text-decoration: underline; margin: 50px 0 40px 0; font-weight: bold;">ì¬ ì§ ì¦ ëª… ì„œ</h2>
            <div style="text-align:right; font-size: 13px; margin-bottom: 20px;">ë¬¸ì„œë²ˆí˜¸: ${data.docNum}</div>
            <div style="text-align:left; font-weight: bold; font-size: 16px; margin-top: 10px; margin-bottom: 5px;">1. ì¸ì ì‚¬í•­</div>
            <table style="width:100%;">
                <tr><th style="background:#f9f9f9; width:100px; padding:6px 10px;">ì„± ëª…</th><td style="padding:6px 10px;">${data.name}</td><th style="background:#f9f9f9; width:100px; padding:6px 10px;">ìƒë…„ì›”ì¼</th><td style="padding:6px 10px;">${data.birth}</td></tr>
                <tr><th style="background:#f9f9f9; padding:6px 10px;">ì†Œ ì†</th><td style="padding:6px 10px;">${data.dept}</td><th style="background:#f9f9f9; padding:6px 10px;">ì§ ìœ„</th><td style="padding:6px 10px;">${data.pos}</td></tr>
                <tr><th style="background:#f9f9f9; padding:6px 10px;">ì£¼ ì†Œ</th><td colspan="3" style="padding:6px 10px;">${data.address}</td></tr>
            </table>
            <div style="text-align:left; font-weight: bold; font-size: 16px; margin-top: 20px; margin-bottom: 5px;">2. ì¬ì§ì‚¬í•­</div>
            <table style="width:100%;">
                <tr><th style="background:#f9f9f9; width:100px; padding:6px 10px;">ì¬ì§ê¸°ê°„</th><td colspan="3" style="padding:6px 10px;">${data.tenure}</td></tr>
                <tr><th style="background:#f9f9f9; padding:6px 10px;">ìš© ë„</th><td colspan="3" style="padding:6px 10px;">${data.purpose}</td></tr>
            </table>
            <div style="text-align:center; margin-top: 60px; font-size: 18px;">ìœ„ì™€ ê°™ì´ ì¬ì§í•˜ê³  ìˆìŒì„ ì¦ëª…í•©ë‹ˆë‹¤.</div>
            <div style="text-align:center; margin-top: 30px; font-size: 18px;">${data.today}</div>
            <div style="text-align:center; margin-top:60px; position:relative;">
                <span style="font-size:24px; font-weight:bold; position:relative; z-index:1;">${data.compName} ì´ì‚¬ì¥ ${data.chairman}</span>
                ${data.seal ? `<img src="${data.seal}" style="position:absolute; margin-left:-50px; top:-20px; width:80px; opacity:0.8; z-index:2;">` : ''}
            </div>
            <div style="text-align:center; margin-top: 70px; font-size: 12px; color: #555;">${data.compAddr} ${data.compName}<br>ë¬¸ì˜: ${data.contact}</div>
        </div>`;
    }

    const finalCss = data.type === 'ledger' ? landscapeCss : portraitCss;
    const pageClass = data.type === 'ledger' ? 'print-ledger' : (data.type === 'salary' ? 'print-salary' : 'print-cert');

    const html = `<html><head><title>ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><style>${commonCss} ${finalCss}</style></head><body><div class="print-fab no-print"><span class="small fw-bold">ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°</span><button class="btn btn-primary btn-sm rounded-pill" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button><button class="btn btn-secondary btn-sm rounded-pill" onclick="window.close()">ë‹«ê¸°</button></div><div class="page-wrap ${pageClass}"><div class="print-content">${contentHtml}</div></div>
   
    </body></html>`;
    win.document.write(html);
    win.document.close();
}
</script>
</body>
</html>
