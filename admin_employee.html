<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ì„ì§ì› ê´€ë¦¬ v1.8.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; padding: 20px; }
    .main-card { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .btn-rounded { border-radius: 50px; }
    .table-hover tbody tr { cursor: pointer; transition: background 0.2s; }
    .table-hover tbody tr:hover { background-color: #f8f9fa; transform: scale(1.002); }
    
    .nav-tabs .nav-link { color: #666; cursor: pointer; border:none; padding: 12px 20px; font-weight: 600; }
    .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
    
    .modal-content { border-radius: 16px; border: none; box-shadow: 0 15px 50px rgba(0,0,0,0.1); }
    .form-control, .form-select { border-radius: 8px; padding: 10px; }
    .d-none { display: none !important; }

    /* ìƒì„¸ì •ë³´ ë””ìì¸ ê°œì„  */
    .section-title { font-size: 0.95rem; font-weight: bold; color: #495057; margin-bottom: 12px; border-left: 4px solid #0d6efd; padding-left: 10px; }
    .info-card { background: #f8f9fa; padding: 20px; border-radius: 12px; height: 100%; position: relative; }
    
    /* ë³´ì•ˆ í…ìŠ¤íŠ¸ ë¸”ëŸ¬ ì²˜ë¦¬ */
    .blur-text { filter: blur(4px); cursor: pointer; transition: filter 0.3s; }
    .blur-text:hover, .blur-text.active { filter: none; }

    /* ë³´ê¸° ëª¨ë“œ / ìˆ˜ì • ëª¨ë“œ ì „í™˜ */
    .view-mode { display: block; }
    .edit-mode { display: none; }
    .is-editing .view-mode { display: none; }
    .is-editing .edit-mode { display: block; }
    
    .adv-table { font-size: 0.85rem; }
    .adv-table input { border: none; background: #fff; padding: 2px 5px; width: 100%; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>

<div class="main-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold m-0">ğŸ‘¥ ì„ì§ì› ê´€ë¦¬</h4>
      <small class="text-muted">ì§ì› ì •ë³´ ë° ê¸‰ì—¬/ê·¼íƒœ í†µí•© ê´€ë¦¬</small>
    </div>
    <div>
      <button class="btn btn-light btn-sm btn-rounded me-1" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
      <button class="btn btn-outline-secondary btn-sm btn-rounded me-1" onclick="openSettings()">âš™ï¸ ì„¤ì • ê´€ë¦¬</button>
      <button class="btn btn-primary btn-sm btn-rounded shadow-sm" onclick="openInviteModal()">âœ¨ ì‹ ê·œ ë“±ë¡</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle" style="font-size: 0.95rem;">
      <thead class="table-light text-secondary small">
        <tr>
          <th>ì‚¬ë²ˆ</th><th>ì´ë¦„ / ë¶€ì„œ</th><th>ì§ê¸‰</th><th>ìƒíƒœ</th><th>ì‹œìŠ¤í…œ ê¶Œí•œ</th>
        </tr>
      </thead>
      <tbody id="empListBody">
        <tr><td colspan="5" class="text-center p-4 text-muted">ë¡œë”© ì¤‘... â³</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">âš™ï¸ ì‹œìŠ¤í…œ í†µí•© ì„¤ì •</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" id="settingTab" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#setTax">ğŸ“Š ì£¼ìš” ìš”ìœ¨/ë¹„ê³¼ì„¸</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#setCompany">ğŸ¢ íšŒì‚¬ ì •ë³´</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#setAdvanced" onclick="loadAdvancedSettings()">âš™ï¸ ê³ ê¸‰ ì„¤ì • (ì „ì²´)</a></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="setTax">
            <h6 class="fw-bold text-primary small border-bottom pb-1 mb-2">4ëŒ€ë³´í—˜ ì´ ìš”ìœ¨ (ìë™ 50:50 ë¶„í• )</h6>
            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="small text-muted">êµ­ë¯¼ì—°ê¸ˆ ì´í•© (%)</label>
                <input type="number" id="set_pension_total" class="form-control form-control-sm" step="0.01" oninput="calcHalf('pension')">
                <div class="x-small text-secondary mt-1">ì¸ë‹¹: <span id="half_pension">0</span>%</div>
              </div>
              <div class="col-6">
                <label class="small text-muted">ê±´ê°•ë³´í—˜ ì´í•© (%)</label>
                <input type="number" id="set_health_total" class="form-control form-control-sm" step="0.01" oninput="calcHalf('health')">
                <div class="x-small text-secondary mt-1">ì¸ë‹¹: <span id="half_health">0</span>%</div>
              </div>
            </div>
            <h6 class="fw-bold text-success small border-bottom pb-1 mb-2">ë¹„ê³¼ì„¸ í•œë„ ì„¤ì •</h6>
            <div class="row g-2 mb-3">
              <div class="col-4"><label class="small text-muted">ì‹ëŒ€ë¹„ê³¼ì„¸</label><input type="number" id="set_meal" class="form-control form-control-sm"></div>
              <div class="col-4"><label class="small text-muted">ì°¨ëŸ‰ë¹„ê³¼ì„¸</label><input type="number" id="set_car" class="form-control form-control-sm"></div>
              <div class="col-4"><label class="small text-muted">ìœ¡ì•„ë¹„ê³¼ì„¸</label><input type="number" id="set_child" class="form-control form-control-sm"></div>
            </div>
            <div class="alert alert-light border-0 small text-muted py-2" style="font-size: 0.75rem;">
                * ê³ ìš©ë³´í—˜, ì‚°ì¬ë³´í—˜, ë²•ì¸ì„¸ìœ¨ ë“±ì€ ì˜¤ì°¨ ë°©ì§€ë¥¼ ìœ„í•´ <strong>[ê³ ê¸‰ ì„¤ì •]</strong> íƒ­ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
            </div>
          </div>
          <div class="tab-pane fade" id="setCompany">
            <div class="row g-2">
              <div class="col-12"><label class="small text-muted">ë²•ì¸ëª…(ì¡°í•©ëª…)</label><input type="text" id="set_orgName" class="form-control form-control-sm"></div>
              <div class="col-12"><label class="small text-muted">ëŒ€í‘œìëª…(ì´ì‚¬ì¥)</label><input type="text" id="set_ceoName" class="form-control form-control-sm"></div>
              <div class="col-12"><label class="small text-muted">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><input type="text" id="set_bizNum" class="form-control form-control-sm"></div>
              <div class="col-12"><label class="small text-muted">íšŒì‚¬ ì£¼ì†Œ</label><input type="text" id="set_address" class="form-control form-control-sm"></div>
            </div>
          </div>
          <div class="tab-pane fade" id="setAdvanced">
            <div class="table-responsive" style="max-height: 300px;">
              <table class="table table-sm adv-table align-middle">
                <thead class="table-light"><tr><th>í•­ëª© í‚¤</th><th style="width: 120px;">ê°’</th><th>ì„¤ëª…</th></tr></thead>
                <tbody id="advSettingsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer p-2 border-0"><button class="btn btn-primary w-100 btn-rounded" onclick="saveSettings()">ì„¤ì • í†µí•© ì €ì¥</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="inviteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold">âœ¨ ì§ì› ì‹ ê·œ ë“±ë¡</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-light border text-center small mb-3">ğŸ†” ì‚¬ì›ë²ˆí˜¸ëŠ” ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div><label class="small text-muted ms-1">ì´ë¦„</label><input type="text" id="newName" class="form-control mb-2" placeholder="í™ê¸¸ë™"><label class="small text-muted ms-1">ì´ë©”ì¼</label><input type="email" id="newEmail" class="form-control mb-2" placeholder="user@gmail.com"><div class="row g-2 mb-2"><div class="col"><label class="small text-muted ms-1">ì§ê¸‰</label><select id="newRank" class="form-select"><option>ì‚¬ì›</option><option>ëŒ€ë¦¬</option><option>ê³¼ì¥</option><option>ì°¨ì¥</option><option>ë¶€ì¥</option><option>ì´ì‚¬</option><option>êµ­ì¥</option><option>ì´ì‚¬ì¥</option></select></div><div class="col"><label class="small text-muted ms-1">ê¶Œí•œ</label><select id="newRole" class="form-select"><option value="staff">ì¼ë°˜ (Staff)</option><option value="admin">ê´€ë¦¬ì (Admin)</option></select></div></div><div class="mb-3"><label class="small text-muted ms-1">ë¶€ì„œ</label><input type="text" id="newDept" class="form-control" placeholder="ê¸°íšíŒ€"></div><button class="btn btn-primary w-100 btn-rounded py-2" onclick="runInvite()">ë“±ë¡í•˜ê¸°</button></div></div></div></div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <div><h5 class="modal-title fw-bold" id="detailName"></h5><span class="text-muted small" id="detailId"></span></div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"> 
        <div class="px-2 pt-2">
          <ul class="nav nav-tabs mb-3" id="empTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabInfo">ğŸ“ ì •ë³´ & ê³„ì•½</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabSalary">ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabLog">ğŸ“… ê·¼íƒœ/í¬ìƒ</a></li>
          </ul>
        </div>
        
        <div class="tab-content pt-2">
          
          <div class="tab-pane fade show active" id="tabInfo">
            <div id="infoContainer">
                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-primary view-mode" onclick="toggleEditMode(true)">âœï¸ ì •ë³´ ìˆ˜ì •</button>
                    <button class="btn btn-sm btn-secondary edit-mode me-2" onclick="toggleEditMode(false)">ì·¨ì†Œ</button>
                    <button class="btn btn-sm btn-primary edit-mode" onclick="saveBasicInfo()">ì €ì¥ ì™„ë£Œ</button>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="info-card">
                            <div class="section-title">ğŸ’° ì—°ë´‰ ê³„ì•½</div>
                            <div class="view-mode">
                                <label class="small text-muted d-block">í˜„ì¬ ì—°ë´‰</label>
                                <div class="fs-5 fw-bold d-flex align-items-center">
                                    <span class="blur-text me-2" id="viewSalary">******</span> 
                                    <i class="bi bi-eye text-muted cursor-pointer" style="font-size:0.8em;" onclick="toggleBlur('viewSalary')"></i>
                                </div>
                                <label class="small text-muted d-block mt-2">ì ìš© ì‹œì‘ì¼</label>
                                <div class="fs-6" id="viewSalaryDate">-</div>
                            </div>
                            <div class="edit-mode">
                                <div class="mb-2"><label class="small text-muted">ì—°ë´‰ ì´ì•¡ (ì›)</label><input type="number" id="editSalary" class="form-control fw-bold"></div>
                                <div class="mb-2"><label class="small text-muted">ì ìš© ì‹œì‘ì¼</label><input type="date" id="salaryApplyDate" class="form-control"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="info-card">
                            <div class="section-title">ğŸ”’ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (ë³´ì•ˆ)</div>
                            <div class="view-mode">
                                <label class="small text-muted d-block">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label>
                                <div class="fs-5 fw-bold d-flex align-items-center">
                                    <span class="blur-text me-2" id="viewRRN">******-*******</span>
                                    <i class="bi bi-eye text-muted cursor-pointer" style="font-size:0.8em;" onclick="alert('ë³´ì•ˆìƒ ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.')"></i>
                                </div>
                                <div class="text-success x-small mt-2"><i class="bi bi-shield-lock-fill"></i> ì•”í˜¸í™” ì €ì¥ë¨</div>
                            </div>
                            <div class="edit-mode">
                                <label class="small text-muted mb-1">ë³€ê²½í•  ë•Œë§Œ ì…ë ¥í•˜ì„¸ìš”</label>
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <input type="text" id="rrnFront" class="form-control text-center" maxlength="6" placeholder="ìƒë…„ì›”ì¼" style="width: 45%;">
                                    <span class="fw-bold text-muted">-</span>
                                    <input type="password" id="rrnBack" class="form-control text-center" maxlength="7" placeholder="ë’¤ 7ìë¦¬" style="width: 50%;">
                                </div>
                                <button class="btn btn-outline-dark btn-sm w-100" onclick="saveRRN()">ğŸ”’ ì£¼ë¯¼ë²ˆí˜¸ ë³€ê²½ ì €ì¥</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="info-card" style="background: white; border: 1px solid #dee2e6;">
                            <div class="section-title mb-2">ğŸ“„ ê·¼ë¡œê³„ì•½ì„œ</div>
                            <div id="contractView" class="mb-2"></div>
                            <div class="edit-mode border-top pt-2">
                                <label class="small text-muted">íŒŒì¼ ì—…ë°ì´íŠ¸</label>
                                <div class="d-flex gap-2">
                                    <input type="file" id="contractFile" class="form-control form-control-sm" accept=".pdf,.jpg,.png,.jpeg">
                                    <button class="btn btn-dark btn-sm" onclick="uploadContract()">ì—…ë¡œë“œ</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-2 pt-2 border-top d-flex justify-content-end gap-2" id="btnResignArea"></div>
                </div>
            </div>
          </div>

          <div class="tab-pane fade" id="tabSalary">
            <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
                <span class="small">ğŸ“¢ ì—°ë´‰ ê¸°ì¤€ <strong>ìë™ ê³„ì‚°</strong> (ì‹ëŒ€ ì…ë ¥ ì‹œ ì„¸ê¸ˆ ê°ì†Œ)</span>
                <span class="badge bg-secondary" id="salaryStatusBadge">ì¡°íšŒ ì¤‘...</span>
            </div>
            
            <div class="d-flex align-items-center mb-3">
                <label class="me-2 fw-bold small">ê·€ì†ì›”</label>
                <input type="month" id="salaryMonth" class="form-control form-control-sm w-auto" onchange="loadSalaryData()">
            </div>

            <div class="info-card border mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-12">
                        <label class="small fw-bold text-primary">ğŸ’° ì›” ì§€ê¸‰ ì´ì•¡ (ì—°ë´‰ Ã· 12)</label>
                        <input type="number" id="payTotalFixed" class="form-control fw-bold fs-5 bg-white" oninput="recalcSalaryComponents()">
                        <div class="form-text x-small">ì´ ê¸ˆì•¡ì„ ê¸°ì¤€ìœ¼ë¡œ ê¸°ë³¸ê¸‰ê³¼ ìˆ˜ë‹¹ì„ ë‚˜ëˆ•ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-4">
                    <label class="small text-muted">ì‹ëŒ€ (ë¹„ê³¼ì„¸)</label>
                    <input type="number" id="payMeal" class="form-control" value="0" oninput="recalcSalaryComponents()">
                </div>
                <div class="col-4">
                    <label class="small text-muted">ì°¨ëŸ‰ìœ ì§€ë¹„</label>
                    <input type="number" id="payCar" class="form-control" value="0" oninput="recalcSalaryComponents()">
                </div>
                <div class="col-4">
                    <label class="small text-muted">ìœ¡ì•„ìˆ˜ë‹¹</label>
                    <input type="number" id="payChild" class="form-control" value="0" oninput="recalcSalaryComponents()">
                </div>
                
                <div class="col-6">
                    <label class="small text-muted">ê¸°ë³¸ê¸‰ (ìë™ê³„ì‚°)</label>
                    <input type="number" id="payBasic" class="form-control bg-light" readonly>
                </div>
                <div class="col-6">
                    <label class="small text-muted">ìƒì—¬/ì„±ê³¼ê¸‰ (ë³„ë„)</label>
                    <input type="number" id="payBonus" class="form-control" value="0">
                </div>
            </div>

            <button id="btnSaveSalary" class="btn btn-success w-100 mt-3 btn-rounded" onclick="saveSalary()">ğŸ’¾ ê¸‰ì—¬ í™•ì • ë° ì €ì¥</button>
          </div>

          <div class="tab-pane fade" id="tabLog">
            <div class="card bg-light border-0 p-3 mb-3 text-center"><small class="text-muted">í˜„ì¬ ì”ì—¬ ì—°ì°¨</small><h3 class="fw-bold text-primary m-0" id="displayLeaveRemain">0ì¼</h3></div>
            <div class="mb-2"><label class="small text-muted">êµ¬ë¶„</label><select id="logType" class="form-select"><option value="ì§€ê¸‰">ğŸ ì§€ê¸‰ (í¬ìƒ ë“±)</option><option value="ì°¨ê°">âš ï¸ ì°¨ê° (ì§•ê³„ ë“±)</option></select></div>
            <div class="mb-2"><label class="small text-muted">ì¼ìˆ˜</label><input type="number" id="logValue" class="form-control" placeholder="ì˜ˆ: 1"></div>
            <div class="mb-3"><label class="small text-muted">ì‚¬ìœ </label><input type="text" id="logReason" class="form-control" placeholder="ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div>
            <button class="btn btn-primary w-100 btn-rounded" onclick="saveLog()">âœ… ë°˜ì˜í•˜ê¸°</button>
          </div>
        </div> 
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body text-center py-4"><p class="mb-0 fw-bold" id="alertBody"></p></div><div class="modal-footer justify-content-center p-1 border-0"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">í™•ì¸</h6></div><div class="modal-body text-center py-3" id="confirmBody"></div><div class="modal-footer justify-content-center border-0 pt-0"><button type="button" class="btn btn-secondary btn-sm me-2" data-bs-dismiss="modal">ì·¨ì†Œ</button><button type="button" class="btn btn-danger btn-sm" id="btnConfirmYes">í™•ì¸</button></div></div></div></div>
<div class="modal fade" id="adminCertModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title fw-bold">ğŸ“„ ì¦ëª…ì„œ ë°œê¸‰</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="small text-muted mb-1">ë°œê¸‰ ìš©ë„</label><input type="text" id="adminCertPurpose" class="form-control form-control-sm" placeholder="ì˜ˆ: ê¸ˆìœµê¸°ê´€ ì œì¶œìš©"></div><div class="modal-footer p-1 border-0 justify-content-center"><button class="btn btn-primary btn-sm w-100" onclick="reqIssueCert()">ë°œê¸‰ (PDF)</button></div></div></div></div>
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content text-center p-4"><div class="spinner-border text-primary mb-3"></div><h6 class="mb-0">ì²˜ë¦¬ ì¤‘...</h6></div></div></div>

<script>
// Supabase ì„¤ì •
const SUPABASE_URL = 'https://ifdqlwxgqgsvnawmhlfc.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHFsd3hncWdzdm5hd21obGZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxODQ3NDIsImV4cCI6MjA4Mjc2MDc0Mn0.UKUvMOl58KuDH24seC3oSgla7mK5lr-vXjqtpalnl6k';
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let settings = {};
let companyInfo = {};
let advancedSettingsRaw = [];
let currentEmpId = null, currentEmpName = null;
let currentAnnualSalary = 0; // í˜„ì¬ ì—°ë´‰ ì €ì¥ìš©
let confirmCallback = null;
let alertModal, confirmModal, settingsModal, inviteModal, detailModal, adminCertModal, loadingModal;
let hasCheckedExpired = false;

window.onload = async function() {
    alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));
    detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    adminCertModal = new bootstrap.Modal(document.getElementById('adminCertModal'));
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    document.getElementById("btnConfirmYes").onclick = function() { if(confirmCallback) confirmCallback(); confirmModal.hide(); };
    document.getElementById("salaryMonth").value = new Date().toISOString().slice(0, 7);

    await loadList();
    await loadSettings();
    await loadCompanyInfo();
};

function showAlert(msg) { document.getElementById("alertBody").innerHTML = msg; alertModal.show(); }
function showConfirm(msg, cb) { document.getElementById("confirmBody").innerHTML = msg; confirmCallback = cb; confirmModal.show(); }
function showLoading() { loadingModal.show(); }
function hideLoading() { loadingModal.hide(); }

// 1. ì§ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadList() {
    const tbody = document.getElementById("empListBody");
    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">ë¡œë”© ì¤‘...</td></tr>';
    const { data: list, error } = await _supabase.from('ref_employees').select('*').order('emp_id');
    if(error || !list) { tbody.innerHTML = '<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = "";
    const threeYearsAgo = new Date();
    threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);
    let expiredCount = 0;

    list.forEach(u => {
        let isResigned = !!u.resign_date;
        let isExpired = false;
        if (isResigned) {
            const rDate = new Date(u.resign_date);
            if (rDate <= threeYearsAgo) { isExpired = true; expiredCount++; }
        }
        let statusBadge = isResigned ? (isExpired ? `<span class="badge bg-danger">3ë…„ ê²½ê³¼ (íŒŒê¸°ëŒ€ìƒ)</span>` : `<span class="badge bg-secondary">í‡´ì‚¬</span>`) : `<span class="badge bg-success">ì¬ì§</span>`;
        let roleBadge = u.role === 'admin' ? '<span class="badge bg-danger">ê´€ë¦¬ì</span>' : '<span class="badge bg-light text-dark">ì¼ë°˜</span>';
        const tr = document.createElement("tr");
        if(isResigned) tr.style.opacity = "0.7"; 
        if(isExpired) tr.style.backgroundColor = "#fff5f5";
        tr.onclick = () => openDetail(u);
        tr.innerHTML = `<td class="fw-bold text-secondary">${u.emp_id}</td><td><div class="fw-bold">${u.emp_name}</div><div class="small text-muted">${u.department || '-'}</div></td><td>${u.position}</td><td>${statusBadge}</td><td>${roleBadge}</td>`;
        tbody.appendChild(tr);
    });
    if (expiredCount > 0 && !hasCheckedExpired) {
        showConfirm(`âš ï¸ <strong>ê°œì¸ì •ë³´ íŒŒê¸° ì•Œë¦¼</strong><br>í‡´ì‚¬ í›„ 3ë…„ì´ ì§€ë‚œ ì§ì›ì´ <strong>${expiredCount}ëª…</strong> ìˆìŠµë‹ˆë‹¤.<br>ë²•ì  ì˜ë¬´ì— ë”°ë¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => { showAlert("ëª©ë¡ì—ì„œ ë¶‰ì€ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ ì§ì›ì„ í´ë¦­í•˜ì—¬ [ì™„ì „ ì‚­ì œ]ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”."); });
        hasCheckedExpired = true;
    }
}

// 2. ì„¤ì • ë¡œë“œ
async function loadSettings() {
    const { data } = await _supabase.from('ref_settings').select('item_key, item_value');
    if(data) {
        settings = {};
        data.forEach(r => { settings[r.item_key] = r.item_value; });
    }
    const penTotal = (settings['pension_rate_emp'] || 0.045) * 100 * 2;
    document.getElementById("set_pension_total").value = parseFloat(penTotal.toPrecision(12));
    const hltTotal = (settings['health_rate_emp'] || 0.03545) * 100 * 2;
    document.getElementById("set_health_total").value = parseFloat(hltTotal.toPrecision(12));
    calcHalf('pension'); calcHalf('health');
}

async function loadCompanyInfo() {
    const { data } = await _supabase.from('ref_company_info').select('*');
    if(data) { companyInfo = {}; data.forEach(r => { companyInfo[r.key] = r.value; }); }
}
async function loadAdvancedSettings() {
    const tbody = document.getElementById("advSettingsBody");
    tbody.innerHTML = '<tr><td colspan="3" class="text-center">ë°ì´í„° ë¡œë“œ ì¤‘...</td></tr>';
    const { data } = await _supabase.from('ref_settings').select('*').order('category');
    if(data) {
        advancedSettingsRaw = data;
        tbody.innerHTML = data.map((r, idx) => `<tr><td><small class="text-muted">${r.item_key}</small></td><td><input type="number" step="0.00001" value="${r.item_value}" id="adv_val_${idx}"></td><td><small>${r.description || '-'}</small></td></tr>`).join("");
    }
}
function openSettings() {
    document.getElementById("set_pension_total").value = ((settings['pension_rate_emp'] || 0.045) * 100 * 2).toFixed(2);
    document.getElementById("set_health_total").value = ((settings['health_rate_emp'] || 0.03545) * 100 * 2).toFixed(2);
    calcHalf('pension'); calcHalf('health');
    document.getElementById("set_meal").value = settings['limit_meal'] || 200000;
    document.getElementById("set_car").value = settings['limit_car'] || 200000;
    document.getElementById("set_child").value = settings['limit_child'] || 200000;
    document.getElementById("set_orgName").value = companyInfo['orgName'] || "";
    document.getElementById("set_ceoName").value = companyInfo['ceoName'] || "";
    document.getElementById("set_bizNum").value = companyInfo['bizNum'] || "";
    document.getElementById("set_address").value = companyInfo['company_address'] || "";
    settingsModal.show();
}
function calcHalf(type) { document.getElementById(`half_${type}`).innerText = (Number(document.getElementById(`set_${type}_total`).value) / 2).toFixed(3); }

async function saveSettings() {
    showLoading();
    try {
        const updates = [];
        const isAdvancedTab = document.getElementById("setAdvanced").classList.contains("active");
        if(isAdvancedTab) {
            advancedSettingsRaw.forEach((r, idx) => { updates.push({ item_key: r.item_key, item_value: Number(document.getElementById(`adv_val_${idx}`).value) }); });
        } else {
            const penHalf = Number(document.getElementById("set_pension_total").value) / 200;
            const hltHalf = Number(document.getElementById("set_health_total").value) / 200;
            updates.push(
                { item_key: 'pension_rate_emp', item_value: penHalf }, { item_key: 'pension_rate_biz', item_value: penHalf },
                { item_key: 'health_rate_emp', item_value: hltHalf }, { item_key: 'health_rate_biz', item_value: hltHalf },
                { item_key: 'limit_meal', item_value: Number(document.getElementById("set_meal").value) },
                { item_key: 'limit_car', item_value: Number(document.getElementById("set_car").value) },
                { item_key: 'limit_child', item_value: Number(document.getElementById("set_child").value) }
            );
        }
        for(const item of updates) { await _supabase.from('ref_settings').upsert(item, { onConflict: 'item_key' }); }
        const org = document.getElementById("set_orgName").value; const ceo = document.getElementById("set_ceoName").value;
        const compUpdates = [ { key: 'orgName', value: org }, { key: 'company_name', value: org }, { key: 'ceoName', value: ceo }, { key: 'chairman_name', value: ceo }, { key: 'bizNum', value: document.getElementById("set_bizNum").value }, { key: 'company_address', value: document.getElementById("set_address").value } ];
        for(const item of compUpdates) { await _supabase.from('ref_company_info').upsert(item, { onConflict: 'key' }); }
        await loadSettings(); await loadCompanyInfo();
        hideLoading(); settingsModal.hide(); showAlert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (e) { hideLoading(); showAlert("ì˜¤ë¥˜: " + e.message); }
}

// 3. ì§ì› ë“±ë¡
function openInviteModal() { inviteModal.show(); }
async function runInvite() {
    const name = document.getElementById("newName").value; const email = document.getElementById("newEmail").value;
    if(!name || !email) return showAlert("ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
    const year = new Date().getFullYear();
    const { count } = await _supabase.from('ref_employees').select('*', { count: 'exact', head: true }).like('emp_id', `${year}%`);
    const seq = (count || 0) + 1; const empId = `${year}${String(seq).padStart(3, '0')}`;
    const { error } = await _supabase.from('ref_employees').insert({ emp_id: empId, emp_name: name, email: email, position: document.getElementById("newRank").value, role: document.getElementById("newRole").value, department: document.getElementById("newDept").value, hire_date: new Date().toISOString().slice(0, 10) });
    if(error) showAlert("ì˜¤ë¥˜: " + error.message); else { showAlert(`ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ë²ˆ: ${empId}`); inviteModal.hide(); loadList(); }
}

// 4. ì§ì› ìƒì„¸ (UI ê°œí¸ ì ìš©)
async function openDetail(u) {
    currentEmpId = u.emp_id; currentEmpName = u.emp_name;
    currentAnnualSalary = u.base_salary || 0; // ì „ì—­ë³€ìˆ˜ì— ì €ì¥
    
    document.getElementById("detailName").innerText = u.emp_name;
    document.getElementById("detailId").innerText = u.emp_id;
    
    // [íƒ­ 1] ë³´ê¸° ëª¨ë“œ ê°’ ì„¸íŒ…
    document.getElementById("viewSalary").innerText = "*******";
    document.getElementById("viewSalary").classList.add("blur-text");
    document.getElementById("viewSalary").dataset.real = (u.base_salary || 0).toLocaleString() + " ì›";
    document.getElementById("viewSalaryDate").innerText = u.salary_apply_date || "-";
    
    // ìˆ˜ì • ëª¨ë“œ ê°’ ì„¸íŒ…
    document.getElementById("editSalary").value = u.base_salary || 0;
    document.getElementById("salaryApplyDate").value = u.salary_apply_date || "";
    
    // ì£¼ë¯¼ë²ˆí˜¸ ì´ˆê¸°í™”
    document.getElementById("rrnFront").value = "";
    document.getElementById("rrnBack").value = "";
    
    // ëª¨ë“œ ì´ˆê¸°í™” (ì¡°íšŒ ëª¨ë“œ)
    toggleEditMode(false);
    
    // ê³„ì•½ì„œ ë³´ê¸°
    const viewDiv = document.getElementById("contractView");
    viewDiv.innerHTML = '<span class="spinner-border spinner-border-sm text-secondary"></span> ë¡œë”© ì¤‘...';
    document.getElementById("hiddenContractUrl").value = u.contract_url || ""; 
    if (u.contract_url) {
        try {
            const { data } = await _supabase.storage.from('contracts').createSignedUrl(u.contract_url, 3600);
            viewDiv.innerHTML = data ? `<a href="${data.signedUrl}" target="_blank" class="btn btn-sm btn-info w-100 text-white fw-bold">ğŸ“„ ê³„ì•½ì„œ ë³´ê¸°</a>` : `<span class="text-danger small">íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨</span>`;
        } catch (e) { viewDiv.innerHTML = "-"; }
    } else { viewDiv.innerHTML = `<span class="text-muted small">ë¯¸ë“±ë¡</span>`; }

    // í‡´ì‚¬ ë²„íŠ¼ ì²˜ë¦¬
    const area = document.getElementById("btnResignArea");
    if (u.resign_date) {
        area.innerHTML = `<button class="btn btn-sm btn-outline-primary" onclick="openAdminCertModal()">ğŸ“„ ì¦ëª…ì„œ ë°œê¸‰</button><button class="btn btn-sm btn-warning" onclick="cancelResign()">â†©ï¸ í‡´ì‚¬ ì·¨ì†Œ</button><button class="btn btn-sm btn-danger ms-2" onclick="reqDeletePermanent()">ğŸ—‘ï¸ ì™„ì „ ì‚­ì œ</button>`;
    } else {
        area.innerHTML = `<button class="btn btn-sm btn-outline-danger" onclick="doResign()">â›” í‡´ì‚¬ ì²˜ë¦¬</button>`;
        loadSalaryData(); loadLeave(); 
    }
    detailModal.show();
}

// UI í—¬í¼: ìˆ˜ì • ëª¨ë“œ í† ê¸€
function toggleEditMode(isEdit) {
    const container = document.getElementById("infoContainer");
    if(isEdit) container.classList.add("is-editing");
    else container.classList.remove("is-editing");
}

// UI í—¬í¼: ë¸”ëŸ¬ í† ê¸€
function toggleBlur(id) {
    const el = document.getElementById(id);
    if(el.classList.contains("blur-text")) {
        el.innerText = el.dataset.real;
        el.classList.remove("blur-text");
    } else {
        el.innerText = "*******";
        el.classList.add("blur-text");
    }
}

// [ê¸‰ì—¬ ê´€ë¦¬] ë°ì´í„° ë¡œë“œ (ìë™ ì—­ì‚° ì ìš©)
async function loadSalaryData() {
    const month = document.getElementById("salaryMonth").value;
    const badge = document.getElementById("salaryStatusBadge");
    badge.innerText = "ì¡°íšŒ ì¤‘...";
    
    const { data: saved } = await _supabase.from('hr_salary').select('*').eq('emp_id', currentEmpId).eq('year_month', month).single();
    
    if(saved) {
        // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜´
        document.getElementById("payTotalFixed").value = saved.pay_total || 0; // ì €ì¥ëœ ì´ì•¡
        document.getElementById("payMeal").value = saved.pay_meal;
        document.getElementById("payCar").value = saved.pay_car;
        document.getElementById("payChild").value = saved.pay_child;
        document.getElementById("payBonus").value = saved.pay_bonus;
        badge.innerText = "ì €ì¥ëœ ë°ì´í„°"; badge.className = "badge bg-success";
    } else {
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 'ì—°ë´‰ ê¸°ì¤€' ìë™ ì±„ìš°ê¸°
        const monthlyTotal = Math.floor(currentAnnualSalary / 12); // ì—°ë´‰/12
        document.getElementById("payTotalFixed").value = monthlyTotal; 
        
        // ë¹„ê³¼ì„¸ í•­ëª©ì€ 0ìœ¼ë¡œ ì´ˆê¸°í™” (êµ­ì¥ë‹˜ ìš”ì²­)
        document.getElementById("payMeal").value = 0;
        document.getElementById("payCar").value = 0;
        document.getElementById("payChild").value = 0;
        document.getElementById("payBonus").value = 0;
        
        badge.innerText = "ìë™ ê³„ì‚° (ë¯¸ì €ì¥)"; badge.className = "badge bg-secondary";
    }
    // ê¸°ë³¸ê¸‰ ìë™ ê³„ì‚° ì‹¤í–‰
    recalcSalaryComponents();
}

// [ê¸‰ì—¬ ê´€ë¦¬] ì‹¤ì‹œê°„ ê³„ì‚° ë¡œì§ (í¬ê´„ì‚°ì •)
function recalcSalaryComponents() {
    const total = Number(document.getElementById("payTotalFixed").value) || 0;
    const meal = Number(document.getElementById("payMeal").value) || 0;
    const car = Number(document.getElementById("payCar").value) || 0;
    const child = Number(document.getElementById("payChild").value) || 0;
    
    // ê¸°ë³¸ê¸‰ = ì´ì•¡ - ë¹„ê³¼ì„¸ ìˆ˜ë‹¹ë“¤
    const basic = total - (meal + car + child);
    document.getElementById("payBasic").value = basic > 0 ? basic : 0;
}

// [ê¸‰ì—¬ ê´€ë¦¬] ì €ì¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë˜ ê°’ ë§¤í•‘ ìˆ˜ì •)
async function saveSalary() {
    const month = document.getElementById("salaryMonth").value; if (!month) return showAlert("ê·€ì†ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    
    // í™”ë©´ì— ìˆëŠ” ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
    const p_basic = Number(document.getElementById("payBasic").value);
    const p_meal = Number(document.getElementById("payMeal").value);
    const p_car = Number(document.getElementById("payCar").value);
    const p_child = Number(document.getElementById("payChild").value);
    const p_bonus = Number(document.getElementById("payBonus").value);
    
    // DB ì €ì¥ìš© Total = ê¸°ë³¸ê¸‰ + ìˆ˜ë‹¹ë“¤ + ë³´ë„ˆìŠ¤ (ê²°êµ­ í™”ë©´ì˜ TotalFixed + Bonus)
    // *ì£¼ì˜: ì—¬ê¸°ì„œ p_totalì€ 'ê³¼ì„¸+ë¹„ê³¼ì„¸' í•©ê³„ì´ë¯€ë¡œ, ì„¸ê¸ˆ ê³„ì‚°ì˜ ê¸°ì¤€ì´ ë¨
    const p_total = p_basic + p_meal + p_car + p_child + p_bonus;

    // ì„¸ê¸ˆ ê³„ì‚° (ë¹„ê³¼ì„¸ ì œì™¸)
    const tf_meal = Math.min(p_meal, settings['limit_meal'] || 200000);
    const tf_car = Math.min(p_car, settings['limit_car'] || 200000);
    const tf_child = Math.min(p_child, settings['limit_child'] || 200000);
    const tax_base = p_total - (tf_meal + tf_car + tf_child); 
    
    const pen = Math.floor(tax_base * (settings['pension_rate_emp'] || 0.045));
    const hlt = Math.floor((tax_base * (settings['health_rate_emp'] || 0.03545)) / 10) * 10;
    const care = Math.floor((hlt * (settings['care_rate_ratio'] || 0.1295)) / 10) * 10; 
    const emp = Math.floor(tax_base * (settings['employ_rate_emp'] || 0.009));

    let inc = 0, loc = 0;
    if (tax_base >= 1060000) {
        inc = Math.floor((tax_base * (settings['income_tax_rate_simple'] || 0.03)) / 10) * 10;
        loc = Math.floor((inc * (settings['local_tax_rate_ratio'] || 0.1)) / 10) * 10;
    }

    const payload = { emp_id: currentEmpId, emp_name: currentEmpName, year_month: month, pay_basic: p_basic, pay_meal: p_meal, pay_car: p_car, pay_child: p_child, pay_bonus: p_bonus, pay_total: p_total, ded_pension: pen, ded_health: hlt, ded_care: care, ded_employ: emp, ded_income: inc, ded_local: loc, ded_total: pen + hlt + care + emp + inc + loc, net_pay: p_total - (pen + hlt + care + emp + inc + loc) };
    
    showLoading();
    const { data: existing } = await _supabase.from('hr_salary').select('id').eq('emp_id', currentEmpId).eq('year_month', month).single();
    const { error } = existing ? await _supabase.from('hr_salary').update(payload).eq('id', existing.id) : await _supabase.from('hr_salary').insert(payload);
    hideLoading();
    if (error) showAlert("ì €ì¥ ì‹¤íŒ¨: " + error.message); else { showAlert("ê¸‰ì—¬ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); loadSalaryData(); }
}

async function saveBasicInfo() {
    const sal = Number(document.getElementById("editSalary").value); 
    const date = document.getElementById("salaryApplyDate").value;
    
    // DB ì—…ë°ì´íŠ¸
    await _supabase.from('ref_employees').update({ base_salary: sal, salary_apply_date: date }).eq('emp_id', currentEmpId);
    
    // ì—°ë´‰ íˆìŠ¤í† ë¦¬ ì €ì¥
    await _supabase.from('hr_salary_contracts').insert({ emp_id: currentEmpId, amount: sal, apply_date: date });
    
    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    currentAnnualSalary = sal;
    
    // UI ê°±ì‹  (ë³´ê¸° ëª¨ë“œë¡œ ë³µê·€)
    document.getElementById("viewSalary").dataset.real = sal.toLocaleString() + " ì›";
    document.getElementById("viewSalaryDate").innerText = date;
    toggleEditMode(false);
    showAlert("ì—°ë´‰ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

async function saveRRN() {
    const f = document.getElementById("rrnFront").value; const b = document.getElementById("rrnBack").value; const full = f + b;
    if (full.length !== 13) return showAlert("ì£¼ë¯¼ë²ˆí˜¸ 13ìë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    let sum = 0; const multipliers = [2,3,4,5,6,7,8,9,2,3,4,5];
    for(let i=0; i<12; i++) sum += Number(full[i]) * multipliers[i];
    const checkDigit = (11 - (sum % 11)) % 10;
    if (Number(full[12]) !== checkDigit) return showAlert("ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ì…ë‹ˆë‹¤.<br>ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
    const { error } = await _supabase.rpc('update_employee_rrn', { p_emp_id: currentEmpId, p_rrn: f + "-" + b });
    if(error) showAlert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
    else { showAlert("ì£¼ë¯¼ë²ˆí˜¸ê°€ ì•ˆì „í•˜ê²Œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById("rrnFront").value = ""; document.getElementById("rrnBack").value = ""; toggleEditMode(false); }
}

async function uploadContract() {
    const fileInput = document.getElementById("contractFile");
    if (fileInput.files.length === 0) return showAlert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    const file = fileInput.files[0]; const fileName = `${currentEmpId}_contract_${Date.now()}.${file.name.split('.').pop()}`;
    showLoading(); 
    try {
        const { data: emp } = await _supabase.from('ref_employees').select('contract_url').eq('emp_id', currentEmpId).single();
        if (emp?.contract_url && !emp.contract_url.startsWith('http')) await _supabase.storage.from('contracts').remove([emp.contract_url]);
        const { data, error } = await _supabase.storage.from('contracts').upload(fileName, file, { upsert: true });
        if (error) throw error;
        await _supabase.from('ref_employees').update({ contract_url: data.path }).eq('emp_id', currentEmpId);
        hideLoading();
        setTimeout(async () => {
            showAlert("ê³„ì•½ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); 
            const { data: signed } = await _supabase.storage.from('contracts').createSignedUrl(data.path, 3600);
            document.getElementById("contractView").innerHTML = `<a href="${signed.signedUrl}" target="_blank" class="btn btn-sm btn-info w-100 text-white fw-bold">ğŸ“„ ê³„ì•½ì„œ ë³´ê¸° (ë³´ì•ˆ)</a>`;
            document.getElementById("hiddenContractUrl").value = data.path; fileInput.value = ""; 
        }, 500);
    } catch (err) { hideLoading(); setTimeout(() => showAlert("ì˜¤ë¥˜ ë°œìƒ: " + err.message), 500); }
}

async function reqDeletePermanent() { showConfirm("âš ï¸ ì˜êµ¬ ì‚­ì œ ê²½ê³ ", `<strong>${currentEmpName}</strong> ë‹˜ì˜ ë°ì´í„°ì™€ ê³„ì•½ì„œ íŒŒì¼ì„<br>ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)`, async function() { showLoading(); detailModal.hide(); const filePath = document.getElementById("hiddenContractUrl").value; if (filePath && !filePath.startsWith('http')) await _supabase.storage.from('contracts').remove([filePath]); await _supabase.from('hr_salary').delete().eq('emp_id', currentEmpId); await _supabase.from('hr_leave_adj').delete().eq('emp_id', currentEmpId); await _supabase.from('hr_salary_contracts').delete().eq('emp_id', currentEmpId); await _supabase.from('log_cert').delete().eq('emp_id', currentEmpId); await _supabase.from('ref_employees').delete().eq('emp_id', currentEmpId); hideLoading(); showAlert("ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadList(); }); }
async function doResign() { showConfirm(`${currentEmpName}ë‹˜ì„ í‡´ì‚¬ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => { await _supabase.from('ref_employees').update({ resign_date: new Date().toISOString().slice(0, 10) }).eq('emp_id', currentEmpId); detailModal.hide(); loadList(); }); }
async function cancelResign() { showConfirm(`í‡´ì‚¬ ì²˜ë¦¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => { await _supabase.from('ref_employees').update({ resign_date: null }).eq('emp_id', currentEmpId); detailModal.hide(); loadList(); }); }
async function loadLeave() { let generated = 0; const { data: emp } = await _supabase.from('ref_employees').select('hire_date').eq('emp_id', currentEmpId).single(); if(emp?.hire_date) { const join = new Date(emp.hire_date); const now = new Date(); const diffY = now.getFullYear() - join.getFullYear(); generated = diffY < 1 ? (now.getMonth() - join.getMonth()) : 15; } let adjusted = 0; const { data: adjs } = await _supabase.from('hr_leave_adj').select('*').eq('emp_id', currentEmpId); if(adjs) adjs.forEach(a => { if(a.adj_type==='ì§€ê¸‰') adjusted+=Number(a.days); else adjusted-=Number(a.days); }); let used = 0; const { data: apps } = await _supabase.from('ref_approval').select('amount').eq('drafter_id', currentEmpId).eq('doc_type', 'íœ´ê°€').eq('status', 'ì™„ë£Œ'); if(apps) apps.forEach(a => used+=Number(a.amount)); document.getElementById("displayLeaveRemain").innerText = (Math.max(0, generated + adjusted - used)) + "ì¼"; }
async function saveLog() { const type = document.getElementById("logType").value; const val = Number(document.getElementById("logValue").value); const reason = document.getElementById("logReason").value; if(!val || !reason) return showAlert("ì¼ìˆ˜ì™€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); await _supabase.from('hr_leave_adj').insert({ emp_id: currentEmpId, adj_type: type, days: val, reason: reason }); showAlert("ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById("logValue").value = ""; document.getElementById("logReason").value = ""; loadLeave(); }
function openAdminCertModal() { document.getElementById("adminCertPurpose").value = ""; adminCertModal.show(); }
async function reqIssueCert() { showAlert("í˜„ì¬ ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. (ë§ˆì´í˜ì´ì§€ ê¸°ëŠ¥ì„ í™œìš©í•˜ì„¸ìš”)"); adminCertModal.hide(); }
</script>
<input type="hidden" id="hiddenContractUrl">
</body>
</html>
